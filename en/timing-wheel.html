
<!DOCTYPE HTML>
<html lang="en" >
    <head>
        <meta charset="UTF-8">
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <title>TimingWheel Â· go-zero document</title>
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta name="description" content="">
        <meta name="generator" content="GitBook 3.2.3">
        <meta name="author" content="anqiansong">
        
        
    
    <link rel="stylesheet" href="../gitbook/style.css">

    
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-back-to-top-button/plugin.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-chapter-fold/chapter-fold.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-code/plugin.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-search-pro/search.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-splitter/splitter.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-tbfed-pagefooter/footer.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-flexible-alerts/style.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-page-toc-button/plugin.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-pageview-count/plugin.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-prism/prism-tomorrow.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-fontsettings/website.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-theme-comscore/test.css">
                
            
        

    

    
        
    
        
    
        
    
        
    
        
    
        
    

        
    
    
    <meta name="HandheldFriendly" content="true"/>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <link rel="apple-touch-icon-precomposed" sizes="152x152" href="../gitbook/images/apple-touch-icon-precomposed-152.png">
    <link rel="shortcut icon" href="../gitbook/images/favicon.ico" type="image/x-icon">

    
    <link rel="next" href="eco.html" />
    
    
    <link rel="prev" href="tokenlimit.html" />
    

    </head>
    <body>
        
<div class="book">
    <div class="book-summary">
        
            
<div id="book-search-input" role="search">
    <input type="text" placeholder="Type to search" />
</div>

            
                <nav role="navigation">
                


<ul class="summary">
    
    

    

    
        
        
    
        <li class="chapter " data-level="1.1" data-path="./">
            
                <a href="./">
            
                    
                    Introduction
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2" data-path="about-us.html">
            
                <a href="about-us.html">
            
                    
                    About Us
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3" data-path="join-us.html">
            
                <a href="join-us.html">
            
                    
                    Join Us
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4" data-path="concept-introduction.html">
            
                <a href="concept-introduction.html">
            
                    
                    Concepts
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5" data-path="quick-start.html">
            
                <a href="quick-start.html">
            
                    
                    Quick Start
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.5.1" data-path="monolithic-service.html">
            
                <a href="monolithic-service.html">
            
                    
                    Monolithic Service
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.2" data-path="micro-service.html">
            
                <a href="micro-service.html">
            
                    
                    Micro Service
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.6" data-path="framework-design.html">
            
                <a href="framework-design.html">
            
                    
                    Framework Design
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.6.1" data-path="go-zero-design.html">
            
                <a href="go-zero-design.html">
            
                    
                    Go-Zero Design
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.2" data-path="go-zero-features.html">
            
                <a href="go-zero-features.html">
            
                    
                    Go-Zero Features
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.3" data-path="api-grammar.html">
            
                <a href="api-grammar.html">
            
                    
                    API IDL
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.4" data-path="api-dir.html">
            
                <a href="api-dir.html">
            
                    
                    API Directory Structure
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.5" data-path="rpc-dir.html">
            
                <a href="rpc-dir.html">
            
                    
                    RPC Directory Structure
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.7" data-path="project-dev.html">
            
                <a href="project-dev.html">
            
                    
                    Project Development
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.7.1" data-path="prepare.html">
            
                <a href="prepare.html">
            
                    
                    Prepare
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.7.1.1" data-path="golang-install.html">
            
                <a href="golang-install.html">
            
                    
                    Golang Installation
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.7.1.2" data-path="gomod-config.html">
            
                <a href="gomod-config.html">
            
                    
                    Go Module Configuration
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.7.1.3" data-path="goctl-install.html">
            
                <a href="goctl-install.html">
            
                    
                    Goctl Installation
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.7.1.4" data-path="protoc-install.html">
            
                <a href="protoc-install.html">
            
                    
                    protoc & protoc-gen-go Installation
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.7.1.5" data-path="prepare-other.html">
            
                <a href="prepare-other.html">
            
                    
                    More
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.7.2" data-path="dev-specification.html">
            
                <a href="dev-specification.html">
            
                    
                    Development Rules
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.7.2.1" data-path="naming-spec.html">
            
                <a href="naming-spec.html">
            
                    
                    Naming Rules
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.7.2.2" data-path="route-naming-spec.html">
            
                <a href="route-naming-spec.html">
            
                    
                    Route Rules
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.7.2.3" data-path="coding-spec.html">
            
                <a href="coding-spec.html">
            
                    
                    Coding Rules
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.7.3" data-path="dev-flow.html">
            
                <a href="dev-flow.html">
            
                    
                    Development Flow
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.7.4" data-path="config-introduction.html">
            
                <a href="config-introduction.html">
            
                    
                    Configuration Introduction
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.7.4.1" data-path="api-config.html">
            
                <a href="api-config.html">
            
                    
                    API Configuration
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.7.4.2" data-path="rpc-config.html">
            
                <a href="rpc-config.html">
            
                    
                    RPC Configuration
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.7.5" data-path="business-dev.html">
            
                <a href="business-dev.html">
            
                    
                    Business Development
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.7.5.1" data-path="service-design.html">
            
                <a href="service-design.html">
            
                    
                    Directory Structure
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.7.5.2" data-path="model-gen.html">
            
                <a href="model-gen.html">
            
                    
                    Model Generation
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.7.5.3" data-path="api-coding.html">
            
                <a href="api-coding.html">
            
                    
                    API Coding
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.7.5.4" data-path="business-coding.html">
            
                <a href="business-coding.html">
            
                    
                    Business Coding
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.7.5.5" data-path="jwt.html">
            
                <a href="jwt.html">
            
                    
                    JWT
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.7.5.6" data-path="middleware.html">
            
                <a href="middleware.html">
            
                    
                    Middleware
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.7.5.7" data-path="rpc-call.html">
            
                <a href="rpc-call.html">
            
                    
                    RPC Implement & Call
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.7.5.8" data-path="error-handle.html">
            
                <a href="error-handle.html">
            
                    
                    Error Handling
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.7.6" data-path="ci-cd.html">
            
                <a href="ci-cd.html">
            
                    
                    CI/CD
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.7.7" data-path="service-deployment.html">
            
                <a href="service-deployment.html">
            
                    
                    Service Deployment
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.7.8" data-path="log-collection.html">
            
                <a href="log-collection.html">
            
                    
                    Log Collection
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.7.9" data-path="trace.html">
            
                <a href="trace.html">
            
                    
                    Trace
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.7.10" data-path="service-monitor.html">
            
                <a href="service-monitor.html">
            
                    
                    Monitor
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.8" data-path="goctl.html">
            
                <a href="goctl.html">
            
                    
                    Goctl
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.8.1" data-path="goctl-completion.html">
            
                <a href="goctl-completion.html">
            
                    
                    Auto Completion
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.8.2" data-path="goctl-commands.html">
            
                <a href="goctl-commands.html">
            
                    
                    Commands & Flags
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.8.3" data-path="goctl-api.html">
            
                <a href="goctl-api.html">
            
                    
                    API Commands
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.8.4" data-path="goctl-rpc.html">
            
                <a href="goctl-rpc.html">
            
                    
                    RPC Commands
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.8.5" data-path="goctl-model.html">
            
                <a href="goctl-model.html">
            
                    
                    Model Commands
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.8.6" data-path="goctl-plugin.html">
            
                <a href="goctl-plugin.html">
            
                    
                    Plugin Commands
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.8.7" data-path="goctl-other.html">
            
                <a href="goctl-other.html">
            
                    
                    More Commands
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.9" data-path="template-manage.html">
            
                <a href="template-manage.html">
            
                    
                    Template
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.9.1" data-path="template-cmd.html">
            
                <a href="template-cmd.html">
            
                    
                    Command
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.9.2" data-path="template.html">
            
                <a href="template.html">
            
                    
                    Custom
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.10" data-path="extended-reading.html">
            
                <a href="extended-reading.html">
            
                    
                    Extended
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.10.1" data-path="logx.html">
            
                <a href="logx.html">
            
                    
                    logx
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.10.2" data-path="bloom.html">
            
                <a href="bloom.html">
            
                    
                    bloom
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.10.3" data-path="executors.html">
            
                <a href="executors.html">
            
                    
                    executors
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.10.4" data-path="fx.html">
            
                <a href="fx.html">
            
                    
                    fx
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.10.5" data-path="mysql.html">
            
                <a href="mysql.html">
            
                    
                    mysql
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.10.6" data-path="redis-lock.html">
            
                <a href="redis-lock.html">
            
                    
                    redis-lock
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.10.7" data-path="periodlimit.html">
            
                <a href="periodlimit.html">
            
                    
                    periodlimit
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.10.8" data-path="tokenlimit.html">
            
                <a href="tokenlimit.html">
            
                    
                    tokenlimit
            
                </a>
            

            
        </li>
    
        <li class="chapter active" data-level="1.10.9" data-path="timing-wheel.html">
            
                <a href="timing-wheel.html">
            
                    
                    TimingWheel
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.11" data-path="eco.html">
            
                <a href="eco.html">
            
                    
                    Around
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.11.1" data-path="tool-center.html">
            
                <a href="tool-center.html">
            
                    
                    Tools
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.11.1.1" data-path="intellij.html">
            
                <a href="intellij.html">
            
                    
                    Intellij Plugin
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.11.1.2" data-path="vscode.html">
            
                <a href="vscode.html">
            
                    
                    VSCode Plugin
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.11.2" data-path="distributed-transaction.html">
            
                <a href="distributed-transaction.html">
            
                    
                    Distributed Transaction
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.11.3" data-path="plugin-center.html">
            
                <a href="plugin-center.html">
            
                    
                    Plugins
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.12" data-path="learning-resource.html">
            
                <a href="learning-resource.html">
            
                    
                    Learning Resources
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.12.1" data-path="wechat.html">
            
                <a href="wechat.html">
            
                    
                    Wechat
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.12.2" data-path="goreading.html">
            
                <a href="goreading.html">
            
                    
                    Night
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.12.3" data-path="gotalk.html">
            
                <a href="gotalk.html">
            
                    
                    OpenTalk
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.13" data-path="practise.html">
            
                <a href="practise.html">
            
                    
                    User Practise
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.13.1" data-path="redis-cache.html">
            
                <a href="redis-cache.html">
            
                    
                    Persistent layer cache
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.13.2" data-path="buiness-cache.html">
            
                <a href="buiness-cache.html">
            
                    
                    Business layer cache
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.13.3" data-path="go-queue.html">
            
                <a href="go-queue.html">
            
                    
                    Queue
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.13.4" data-path="datacenter.html">
            
                <a href="datacenter.html">
            
                    
                    Middle Ground System
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.13.5" data-path="stream.html">
            
                <a href="stream.html">
            
                    
                    Stream Handler
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.13.6" data-path="online-exchange.html">
            
                <a href="online-exchange.html">
            
                    
                    Online Exchange
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.14" data-path="contributor.html">
            
                <a href="contributor.html">
            
                    
                    Contributor
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.15" data-path="doc-contibute.html">
            
                <a href="doc-contibute.html">
            
                    
                    Document Contribute
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.16" data-path="error.html">
            
                <a href="error.html">
            
                    
                    Error
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.17" data-path="source.html">
            
                <a href="source.html">
            
                    
                    Source Code
            
                </a>
            

            
        </li>
    

    

    <li class="divider"></li>

    <li>
        <a href="https://www.gitbook.com" target="blank" class="gitbook-link">
            Published with GitBook
        </a>
    </li>
</ul>


                </nav>
            
        
    </div>

    <div class="book-body">
        
            <div class="body-inner">
                
                    

<div class="book-header" role="navigation">
    

    <!-- Title -->
    <h1>
        <i class="fa fa-circle-o-notch fa-spin"></i>
        <a href="." >TimingWheel</a>
    </h1>
</div>




                    <div class="page-wrapper" tabindex="-1" role="main">
                        <div class="page-inner">
                            
<div id="book-search-results">
    <div class="search-noresults">
    
                                <section class="normal markdown-section">
                                
                                <h1 id="timingwheel">TimingWheel</h1>
<blockquote>
<p>[!TIP]
This document is machine-translated by Google. If you find grammatical and semantic errors, and the document description is not clear, please <a href="doc-contibute.html">PR</a></p>
</blockquote>
<p>This article introduces the <strong>delayed operation</strong> in <code>go-zero</code>. <strong>Delayed operation</strong>, two options can be used:</p>
<ol>
<li><code>Timer</code>: The timer maintains a priority queue, executes it at the time, and then stores the tasks that need to be executed in the map</li>
<li>The <code>timingWheel</code> in <code>collection</code> maintains an array for storing task groups, and each slot maintains a doubly linked list of tasks. When the execution starts, the timer executes the tasks in a slot every specified time.</li>
</ol>
<p>Scheme 2 reduces the maintenance task from the <code>priority queue O(nlog(n))</code> to the <code>doubly linked list O(1)</code>, and the execution of the task only needs to poll the tasks <code>O(N)</code> at a time point. Priority queue, put and delete elements <code>O(nlog(n))</code>.</p>
<h2 id="timingwheel-in-cache">timingWheel in cache</h2>
<p>First, let&apos;s first talk about the use of TimingWheel in the cache of collection:</p>
<pre class="language-"><code class="lang-go">timingWheel<span class="token punctuation">,</span> err <span class="token operator">:=</span> <span class="token function">NewTimingWheel</span><span class="token punctuation">(</span>time<span class="token punctuation">.</span>Second<span class="token punctuation">,</span> slots<span class="token punctuation">,</span> <span class="token keyword">func</span><span class="token punctuation">(</span>k<span class="token punctuation">,</span> v <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  key<span class="token punctuation">,</span> ok <span class="token operator">:=</span> k<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token builtin">string</span><span class="token punctuation">)</span>
  <span class="token keyword">if</span> <span class="token operator">!</span>ok <span class="token punctuation">{</span>
    <span class="token keyword">return</span>
  <span class="token punctuation">}</span>
  cache<span class="token punctuation">.</span><span class="token function">Del</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err
<span class="token punctuation">}</span>

cache<span class="token punctuation">.</span>timingWheel <span class="token operator">=</span> timingWheel
</code></pre>
<p>This is the initialization of <code>cache</code> and the initialization of <code>timingWheel</code> at the same time for key expiration processing. The parameters in turn represent:</p>
<ul>
<li><code>interval</code>: Time division scale</li>
<li><code>numSlots</code>: time slots</li>
<li><code>execute</code>: execute a function at a point in time</li>
</ul>
<p>The function executed in the <code>cache</code> is to <strong>delete the expired key</strong>, and this expiration is controlled by the <code>timingWheel</code> to advance the time.</p>
<p><strong>Next, let&apos;s learn about it through the use of timingWheel by cache. </strong></p>
<h3 id="initialization">Initialization</h3>
<pre class="language-"><code class="lang-go"><span class="token keyword">func</span> <span class="token function">newTimingWheelWithClock</span><span class="token punctuation">(</span>interval time<span class="token punctuation">.</span>Duration<span class="token punctuation">,</span> numSlots <span class="token builtin">int</span><span class="token punctuation">,</span> execute Execute<span class="token punctuation">,</span> ticker timex<span class="token punctuation">.</span>Ticker<span class="token punctuation">)</span> <span class="token punctuation">(</span>
    <span class="token operator">*</span>TimingWheel<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    tw <span class="token operator">:=</span> <span class="token operator">&amp;</span>TimingWheel<span class="token punctuation">{</span>
        interval<span class="token punctuation">:</span>      interval<span class="token punctuation">,</span>                     <span class="token comment">// Single time grid time interval</span>
        ticker<span class="token punctuation">:</span>        ticker<span class="token punctuation">,</span>                       <span class="token comment">// Timer, do time push, advance by interval</span>
        slots<span class="token punctuation">:</span>         <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>list<span class="token punctuation">.</span>List<span class="token punctuation">,</span> numSlots<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// Time wheel</span>
        timers<span class="token punctuation">:</span>        <span class="token function">NewSafeMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>                 <span class="token comment">// Store the map of task{key, value} [parameters needed to execute execute]</span>
        tickedPos<span class="token punctuation">:</span>     numSlots <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">,</span>                 <span class="token comment">// at previous virtual circle</span>
        execute<span class="token punctuation">:</span>       execute<span class="token punctuation">,</span>                      <span class="token comment">// Execution function</span>
        numSlots<span class="token punctuation">:</span>      numSlots<span class="token punctuation">,</span>                     <span class="token comment">// Initialize slots num</span>
        setChannel<span class="token punctuation">:</span>    <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> timingEntry<span class="token punctuation">)</span><span class="token punctuation">,</span>       <span class="token comment">// The following channels are used for task delivery</span>
        moveChannel<span class="token punctuation">:</span>   <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> baseEntry<span class="token punctuation">)</span><span class="token punctuation">,</span>
        removeChannel<span class="token punctuation">:</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        drainChannel<span class="token punctuation">:</span>  <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token keyword">func</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> value <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        stopChannel<span class="token punctuation">:</span>   <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> lang<span class="token punctuation">.</span>PlaceholderType<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// Prepare all the lists stored in the slot</span>
    tw<span class="token punctuation">.</span><span class="token function">initSlots</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment">// Open asynchronous coroutine, use channel for task communication and delivery</span>
    <span class="token keyword">go</span> tw<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword">return</span> tw<span class="token punctuation">,</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>
</code></pre>
<p><img src="resource/76108cc071154e2faa66eada81857fb0_tplv-k3u1fbpfcp-zoom-1.image.png" alt="76108cc071154e2faa66eada81857fb0~tplv-k3u1fbpfcp-zoom-1.image.png"></p>
<p>The above is a more intuitive display of the <strong>&quot;time wheel&quot;</strong> of the <code>timingWheel</code>, and the details of the advancement will be explained later around this picture.</p>
<p><code>go tw.run()</code> opens a coroutine for time promotion:</p>
<pre class="language-"><code class="lang-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>tw <span class="token operator">*</span>TimingWheel<span class="token punctuation">)</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">for</span> <span class="token punctuation">{</span>
        <span class="token keyword">select</span> <span class="token punctuation">{</span>
      <span class="token comment">// Timer do time push -&gt; scanAndRunTasks()</span>
        <span class="token keyword">case</span> <span class="token operator">&lt;-</span>tw<span class="token punctuation">.</span>ticker<span class="token punctuation">.</span><span class="token function">Chan</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            tw<span class="token punctuation">.</span><span class="token function">onTick</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token comment">// add task will enter task into setChannel</span>
        <span class="token keyword">case</span> task <span class="token operator">:=</span> <span class="token operator">&lt;-</span>tw<span class="token punctuation">.</span>setChannel<span class="token punctuation">:</span>
            tw<span class="token punctuation">.</span><span class="token function">setTask</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>task<span class="token punctuation">)</span>
        <span class="token operator">...</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<p>It can be seen that the <code>timer</code> execution is started at the time of initialization, and it is rotated in the <code>internal</code> time period, and then the bottom layer keeps getting the tasks from the <code>list</code> in the <code>slot</code> and handing them over to the <code>execute</code> for execution.</p>
<p><img src="resource/3bbddc1ebb79455da91dfcf3da6bc72f_tplv-k3u1fbpfcp-zoom-1.image.png" alt="3bbddc1ebb79455da91dfcf3da6bc72f~tplv-k3u1fbpfcp-zoom-1.image.png"></p>
<h3 id="task-operation">Task Operation</h3>
<p>The next step is to set the <code>cache key</code>:</p>
<pre class="language-"><code class="lang-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>c <span class="token operator">*</span>Cache<span class="token punctuation">)</span> <span class="token function">Set</span><span class="token punctuation">(</span>key <span class="token builtin">string</span><span class="token punctuation">,</span> value <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    c<span class="token punctuation">.</span>lock<span class="token punctuation">.</span><span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token boolean">_</span><span class="token punctuation">,</span> ok <span class="token operator">:=</span> c<span class="token punctuation">.</span>data<span class="token punctuation">[</span>key<span class="token punctuation">]</span>
    c<span class="token punctuation">.</span>data<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> value
    c<span class="token punctuation">.</span>lruCache<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span>
    c<span class="token punctuation">.</span>lock<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    expiry <span class="token operator">:=</span> c<span class="token punctuation">.</span>unstableExpiry<span class="token punctuation">.</span><span class="token function">AroundDuration</span><span class="token punctuation">(</span>c<span class="token punctuation">.</span>expire<span class="token punctuation">)</span>
    <span class="token keyword">if</span> ok <span class="token punctuation">{</span>
        c<span class="token punctuation">.</span>timingWheel<span class="token punctuation">.</span><span class="token function">MoveTimer</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> expiry<span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        c<span class="token punctuation">.</span>timingWheel<span class="token punctuation">.</span><span class="token function">SetTimer</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> value<span class="token punctuation">,</span> expiry<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<ol>
<li>First look at whether this key exists in the <code>data map</code></li>
<li>If it exists, update <code>expire</code> -&gt; <code>MoveTimer()</code></li>
<li>Set the key for the first time -&gt; <code>SetTimer()</code></li>
</ol>
<p>So the use of <code>timingWheel</code> is clear. Developers can <code>add</code> or <code>update</code> according to their needs.</p>
<p>At the same time, when we follow the source code, we will find that: <code>SetTimer() MoveTimer()</code> all transports tasks to channel, and the coroutine opened in <code>run()</code> continuously takes out the task operations of <code>channel</code>.</p>
<blockquote>
<p><code>SetTimer() -&gt; setTask()</code>&#xFF1A;</p>
<ul>
<li>not exist task&#xFF1A;<code>getPostion -&gt; pushBack to list -&gt; setPosition</code></li>
<li>exist task&#xFF1A;<code>get from timers -&gt; moveTask()</code></li>
</ul>
<p><code>MoveTimer() -&gt; moveTask()</code></p>
</blockquote>
<p>From the above call chain, there is a function that will be called: <code>moveTask()</code></p>
<pre class="language-"><code class="lang-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>tw <span class="token operator">*</span>TimingWheel<span class="token punctuation">)</span> <span class="token function">moveTask</span><span class="token punctuation">(</span>task baseEntry<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// timers: Map =&gt; Get [positionEntry&#x300C;pos, task&#x300D;] by key</span>
    val<span class="token punctuation">,</span> ok <span class="token operator">:=</span> tw<span class="token punctuation">.</span>timers<span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span>task<span class="token punctuation">.</span>key<span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token operator">!</span>ok <span class="token punctuation">{</span>
        <span class="token keyword">return</span>
    <span class="token punctuation">}</span>

    timer <span class="token operator">:=</span> val<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token operator">*</span>positionEntry<span class="token punctuation">)</span>
  <span class="token comment">// {delay &lt;interval} =&gt; The delay time is less than a time grid interval, and there is no smaller scale, indicating that the task should be executed immediately</span>
    <span class="token keyword">if</span> task<span class="token punctuation">.</span>delay <span class="token operator">&lt;</span> tw<span class="token punctuation">.</span>interval <span class="token punctuation">{</span>
        threading<span class="token punctuation">.</span><span class="token function">GoSafe</span><span class="token punctuation">(</span><span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            tw<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span>timer<span class="token punctuation">.</span>item<span class="token punctuation">.</span>key<span class="token punctuation">,</span> timer<span class="token punctuation">.</span>item<span class="token punctuation">.</span>value<span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// If&gt; interval, the new pos, circle in the time wheel is calculated by the delay time delay</span>
    pos<span class="token punctuation">,</span> circle <span class="token operator">:=</span> tw<span class="token punctuation">.</span><span class="token function">getPositionAndCircle</span><span class="token punctuation">(</span>task<span class="token punctuation">.</span>delay<span class="token punctuation">)</span>
    <span class="token keyword">if</span> pos <span class="token operator">&gt;=</span> timer<span class="token punctuation">.</span>pos <span class="token punctuation">{</span>
        timer<span class="token punctuation">.</span>item<span class="token punctuation">.</span>circle <span class="token operator">=</span> circle
    <span class="token comment">// Move offset before and after recording. To re-enter the team for later process</span>
        timer<span class="token punctuation">.</span>item<span class="token punctuation">.</span>diff <span class="token operator">=</span> pos <span class="token operator">-</span> timer<span class="token punctuation">.</span>pos
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> circle <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token punctuation">{</span>
        <span class="token comment">// Move to the next layer and convert circle to part of diff</span>
        circle<span class="token operator">--</span>
        timer<span class="token punctuation">.</span>item<span class="token punctuation">.</span>circle <span class="token operator">=</span> circle
        <span class="token comment">// Because it is an array, add numSlots [that is equivalent to going to the next level]</span>
        timer<span class="token punctuation">.</span>item<span class="token punctuation">.</span>diff <span class="token operator">=</span> tw<span class="token punctuation">.</span>numSlots <span class="token operator">+</span> pos <span class="token operator">-</span> timer<span class="token punctuation">.</span>pos
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment">// If the offset is advanced, the task is still in the first layer at this time</span>
        <span class="token comment">// Mark to delete the old task, and re-enter the team, waiting to be executed</span>
        timer<span class="token punctuation">.</span>item<span class="token punctuation">.</span>removed <span class="token operator">=</span> <span class="token boolean">true</span>
        newItem <span class="token operator">:=</span> <span class="token operator">&amp;</span>timingEntry<span class="token punctuation">{</span>
            baseEntry<span class="token punctuation">:</span> task<span class="token punctuation">,</span>
            value<span class="token punctuation">:</span>     timer<span class="token punctuation">.</span>item<span class="token punctuation">.</span>value<span class="token punctuation">,</span>
        <span class="token punctuation">}</span>
        tw<span class="token punctuation">.</span>slots<span class="token punctuation">[</span>pos<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">PushBack</span><span class="token punctuation">(</span>newItem<span class="token punctuation">)</span>
        tw<span class="token punctuation">.</span><span class="token function">setTimerPosition</span><span class="token punctuation">(</span>pos<span class="token punctuation">,</span> newItem<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<p>The above process has the following situations:</p>
<ul>
<li><code>delay &lt;internal</code>: Because &lt;single time precision, it means that this task has expired and needs to be executed immediately</li>
<li>For changed <code>delay</code>:<ul>
<li><code>new &gt;= old</code>&#xFF1A;<code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>newPos,</span> <span class="token attr-name">newCircle,</span> <span class="token attr-name">diff</span><span class="token punctuation">&gt;</span></span></code></li>
<li><code>newCircle&gt; 0</code>: Calculate diff and convert circle to the next layer, so diff + numslots</li>
<li>If only the delay time is shortened, delete the old task mark, re-add it to the list, and wait for the next loop to be executed</li>
</ul>
</li>
</ul>
<h3 id="execute">Execute</h3>
<p>In the previous initialization, the timer in <code>run()</code> kept advancing, and the process of advancing was mainly to pass the tasks in the list to the executed <code>execute func</code>. Let&apos;s start with the execution of the timer:</p>
<pre class="language-"><code class="lang-go"><span class="token comment">// Timer &quot;It will be executed every internal&quot;</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>tw <span class="token operator">*</span>TimingWheel<span class="token punctuation">)</span> <span class="token function">onTick</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// Update the current execution tick position every time it is executed</span>
    tw<span class="token punctuation">.</span>tickedPos <span class="token operator">=</span> <span class="token punctuation">(</span>tw<span class="token punctuation">.</span>tickedPos <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">%</span> tw<span class="token punctuation">.</span>numSlots
  <span class="token comment">// Get the doubly linked list of stored tasks in the tick position at this time</span>
    l <span class="token operator">:=</span> tw<span class="token punctuation">.</span>slots<span class="token punctuation">[</span>tw<span class="token punctuation">.</span>tickedPos<span class="token punctuation">]</span>
    tw<span class="token punctuation">.</span><span class="token function">scanAndRunTasks</span><span class="token punctuation">(</span>l<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre>
<p>Next is how to execute <code>execute</code>:</p>
<pre class="language-"><code class="lang-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>tw <span class="token operator">*</span>TimingWheel<span class="token punctuation">)</span> <span class="token function">scanAndRunTasks</span><span class="token punctuation">(</span>l <span class="token operator">*</span>list<span class="token punctuation">.</span>List<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Store the task{key, value} that needs to be executed at present [parameters required by execute, which are passed to execute in turn]</span>
    <span class="token keyword">var</span> tasks <span class="token punctuation">[</span><span class="token punctuation">]</span>timingTask

    <span class="token keyword">for</span> e <span class="token operator">:=</span> l<span class="token punctuation">.</span><span class="token function">Front</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> e <span class="token operator">!=</span> <span class="token boolean">nil</span><span class="token punctuation">;</span> <span class="token punctuation">{</span>
        task <span class="token operator">:=</span> e<span class="token punctuation">.</span>Value<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token operator">*</span>timingEntry<span class="token punctuation">)</span>
    <span class="token comment">// Mark the deletion, do the real deletion in scan &quot;Delete the map data&quot;</span>
        <span class="token keyword">if</span> task<span class="token punctuation">.</span>removed <span class="token punctuation">{</span>
            next <span class="token operator">:=</span> e<span class="token punctuation">.</span><span class="token function">Next</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            l<span class="token punctuation">.</span><span class="token function">Remove</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span>
            tw<span class="token punctuation">.</span>timers<span class="token punctuation">.</span><span class="token function">Del</span><span class="token punctuation">(</span>task<span class="token punctuation">.</span>key<span class="token punctuation">)</span>
            e <span class="token operator">=</span> next
            <span class="token keyword">continue</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> task<span class="token punctuation">.</span>circle <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token punctuation">{</span>
            <span class="token comment">// The current execution point has expired, but it is not at the first level at the same time, so now that the current level has been completed, it will drop to the next level</span>
            <span class="token comment">// But did not modify pos</span>
            task<span class="token punctuation">.</span>circle<span class="token operator">--</span>
            e <span class="token operator">=</span> e<span class="token punctuation">.</span><span class="token function">Next</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token keyword">continue</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> task<span class="token punctuation">.</span>diff <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token punctuation">{</span>
            <span class="token comment">// Because the diff has been marked before, you need to enter the queue again</span>
            next <span class="token operator">:=</span> e<span class="token punctuation">.</span><span class="token function">Next</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            l<span class="token punctuation">.</span><span class="token function">Remove</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span>
            pos <span class="token operator">:=</span> <span class="token punctuation">(</span>tw<span class="token punctuation">.</span>tickedPos <span class="token operator">+</span> task<span class="token punctuation">.</span>diff<span class="token punctuation">)</span> <span class="token operator">%</span> tw<span class="token punctuation">.</span>numSlots
            tw<span class="token punctuation">.</span>slots<span class="token punctuation">[</span>pos<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">PushBack</span><span class="token punctuation">(</span>task<span class="token punctuation">)</span>
            tw<span class="token punctuation">.</span><span class="token function">setTimerPosition</span><span class="token punctuation">(</span>pos<span class="token punctuation">,</span> task<span class="token punctuation">)</span>
            task<span class="token punctuation">.</span>diff <span class="token operator">=</span> <span class="token number">0</span>
            e <span class="token operator">=</span> next
            <span class="token keyword">continue</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// The above cases are all cases that cannot be executed, and those that can be executed will be added to tasks</span>
        tasks <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>tasks<span class="token punctuation">,</span> timingTask<span class="token punctuation">{</span>
            key<span class="token punctuation">:</span>   task<span class="token punctuation">.</span>key<span class="token punctuation">,</span>
            value<span class="token punctuation">:</span> task<span class="token punctuation">.</span>value<span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
        next <span class="token operator">:=</span> e<span class="token punctuation">.</span><span class="token function">Next</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        l<span class="token punctuation">.</span><span class="token function">Remove</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span>
        tw<span class="token punctuation">.</span>timers<span class="token punctuation">.</span><span class="token function">Del</span><span class="token punctuation">(</span>task<span class="token punctuation">.</span>key<span class="token punctuation">)</span>
        e <span class="token operator">=</span> next
    <span class="token punctuation">}</span>
    <span class="token comment">// for range tasks, and then execute each task-&gt;execute</span>
    tw<span class="token punctuation">.</span><span class="token function">runTasks</span><span class="token punctuation">(</span>tasks<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre>
<p>The specific branching situation is explained in the comments. When you look at it, it can be combined with the previous <code>moveTask()</code>, where the <code>circle</code> drops, and the calculation of <code>diff</code> is the key to linking the two functions.</p>
<p>As for the calculation of <code>diff</code>, the calculation of <code>pos, circle</code> is involved:</p>
<pre class="language-"><code class="lang-go"><span class="token comment">// interval: 4min, d: 60min, numSlots: 16, tickedPos = 15</span>
<span class="token comment">// step = 15, pos = 14, circle = 0</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>tw <span class="token operator">*</span>TimingWheel<span class="token punctuation">)</span> <span class="token function">getPositionAndCircle</span><span class="token punctuation">(</span>d time<span class="token punctuation">.</span>Duration<span class="token punctuation">)</span> <span class="token punctuation">(</span>pos <span class="token builtin">int</span><span class="token punctuation">,</span> circle <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    steps <span class="token operator">:=</span> <span class="token function">int</span><span class="token punctuation">(</span>d <span class="token operator">/</span> tw<span class="token punctuation">.</span>interval<span class="token punctuation">)</span>
    pos <span class="token operator">=</span> <span class="token punctuation">(</span>tw<span class="token punctuation">.</span>tickedPos <span class="token operator">+</span> steps<span class="token punctuation">)</span> <span class="token operator">%</span> tw<span class="token punctuation">.</span>numSlots
    circle <span class="token operator">=</span> <span class="token punctuation">(</span>steps <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">/</span> tw<span class="token punctuation">.</span>numSlots
    <span class="token keyword">return</span>
<span class="token punctuation">}</span>
</code></pre>
<p>The above process can be simplified to the following:</p>
<pre class="language-"><code class="lang-go">steps <span class="token operator">=</span> d <span class="token operator">/</span> interval
pos <span class="token operator">=</span> step <span class="token operator">%</span> numSlots <span class="token operator">-</span> <span class="token number">1</span>
circle <span class="token operator">=</span> <span class="token punctuation">(</span>step <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">/</span> numSlots
</code></pre>
<h2 id="summary">Summary</h2>
<p>The <code>timingWheel</code> is driven by the timer. As the time advances, the tasks of the <code>list</code> &quot;doubly linked list&quot; in the <strong>current time grid</strong> will be taken out and passed to the <code>execute</code> for execution.</p>
<p>In terms of time separation, the time wheel has <code>circle</code> layers, so that the original <code>numSlots</code> can be reused continuously, because the timer is constantly <code>loop</code>, and execution can drop the upper layer <code>slot</code> to the lower layer. You can execute the task up to the upper level continuously in the <code>loop</code>.</p>
<p>There are many useful component tools in <code>go-zero</code>. Good use of tools is of great help to improve service performance and development efficiency. I hope this article can bring you some gains.</p>
<footer class="page-footer"><span class="copyright">Copyright &#xA9; 2019-2021 go-zero all right reserved&#xFF0C;powered by Gitbook</span><span class="footer-modification">Last UpdateTime&#xFF1A;
2024-12-08 16:44:10
</span></footer>
<script>console.log("plugin-popup....");document.onclick = function(e){ e.target.tagName === "IMG" && window.open(e.target.src,e.target.src)}</script><style>img{cursor:pointer}</style>
                                
                                </section>
                            
    </div>
    <div class="search-results">
        <div class="has-results">
            
            <h1 class="search-results-title"><span class='search-results-count'></span> results matching "<span class='search-query'></span>"</h1>
            <ul class="search-results-list"></ul>
            
        </div>
        <div class="no-results">
            
            <h1 class="search-results-title">No results matching "<span class='search-query'></span>"</h1>
            
        </div>
    </div>
</div>

                        </div>
                    </div>
                
            </div>

            
                
                <a href="tokenlimit.html" class="navigation navigation-prev " aria-label="Previous page: tokenlimit">
                    <i class="fa fa-angle-left"></i>
                </a>
                
                
                <a href="eco.html" class="navigation navigation-next " aria-label="Next page: Around">
                    <i class="fa fa-angle-right"></i>
                </a>
                
            
        
    </div>

    <script>
        var gitbook = gitbook || [];
        gitbook.push(function() {
            gitbook.page.hasChanged({"page":{"title":"TimingWheel","level":"1.10.9","depth":2,"next":{"title":"Around","level":"1.11","depth":1,"path":"eco.md","ref":"eco.md","articles":[{"title":"Tools","level":"1.11.1","depth":2,"path":"tool-center.md","ref":"tool-center.md","articles":[{"title":"Intellij Plugin","level":"1.11.1.1","depth":3,"path":"intellij.md","ref":"intellij.md","articles":[]},{"title":"VSCode Plugin","level":"1.11.1.2","depth":3,"path":"vscode.md","ref":"vscode.md","articles":[]}]},{"title":"Distributed Transaction","level":"1.11.2","depth":2,"path":"distributed-transaction.md","ref":"distributed-transaction.md","articles":[]},{"title":"Plugins","level":"1.11.3","depth":2,"path":"plugin-center.md","ref":"plugin-center.md","articles":[]}]},"previous":{"title":"tokenlimit","level":"1.10.8","depth":2,"path":"tokenlimit.md","ref":"tokenlimit.md","articles":[]},"dir":"ltr"},"config":{"plugins":["back-to-top-button","chapter-fold","code","-lunr","-search","search-pro","github","splitter","-sharing","sharing-plus","tbfed-pagefooter","flexible-alerts","page-toc-button","pageview-count","popup","hide-element","edit-link","-highlight","prism","theme-comscore"],"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"},"pluginsConfig":{"tbfed-pagefooter":{"copyright":"Copyright Â© 2019-2021 go-zero","modify_label":"Last UpdateTimeï¼","modify_format":"YYYY-MM-DD HH:mm:ss"},"chapter-fold":{},"prism":{"lang":{"shell":"bash"},"css":["prismjs/themes/prism-tomorrow.css"]},"github":{"url":"https://github.com/zeromicro/go-zero"},"splitter":{},"search-pro":{},"sharing-plus":{"qq":false,"all":["facebook","google","twitter","instapaper","linkedin","pocket","stumbleupon"],"douban":false,"facebook":true,"weibo":false,"instapaper":false,"whatsapp":false,"hatenaBookmark":false,"twitter":true,"messenger":false,"line":false,"vk":false,"pocket":true,"google":false,"viber":false,"stumbleupon":false,"qzone":false,"linkedin":false},"popup":{},"code":{"copyButtons":true},"hide-element":{"elements":[".gitbook-link"]},"fontsettings":{"theme":"white","family":"sans","size":2},"theme-comscore":{},"page-toc-button":{"maxTocDepth":2,"minTocSize":2},"back-to-top-button":{},"pageview-count":{},"flexible-alerts":{"danger":{"className":"danger","icon":"fa fa-ban","label":"Attention"},"note":{"className":"info","icon":"fa fa-info-circle","label":"Note"},"style":"callout","tip":{"className":"tip","icon":"fa fa-lightbulb-o","label":"Tip"},"warning":{"className":"warning","icon":"fa fa-exclamation-triangle","label":"Warning"}},"sharing":{"qq":false,"all":["douban","facebook","google","linkedin","twitter","weibo","qq","qzone","weibo"],"douban":false,"facebook":false,"weibo":true,"instapaper":false,"whatsapp":false,"hatenaBookmark":false,"twitter":false,"messenger":false,"line":true,"vk":false,"pocket":false,"google":true,"viber":false,"stumbleupon":false,"qzone":true,"linkedin":true},"edit-link":{"label":"EDIT THIS PAGE","base":"https://github.com/zeromicro/zero-doc/tree/main/go-zero.dev"},"theme-default":{"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"},"showLevel":false}},"theme":"default","author":"anqiansong","pdf":{"pageNumbers":true,"fontSize":12,"fontFamily":"Arial","paperSize":"a4","chapterMark":"pagebreak","pageBreaksBefore":"/","margin":{"right":62,"left":62,"top":56,"bottom":56}},"structure":{"langs":"LANGS.md","readme":"README.md","glossary":"GLOSSARY.md","summary":"SUMMARY.md"},"variables":{},"title":"go-zero document","language":"en","gitbook":"*","description":"Golang å¾®æå¡æ¡æ¶ | éæåç§å·¥ç¨å®è·µç WEB å RPC æ¡æ¶ | ä¸é®çæ Go, iOS, Android, Kotlin, Dart, TypeScript, JavaScript ä»£ç "},"file":{"path":"timing-wheel.md","mtime":"2024-12-08T16:44:10.749Z","type":"markdown"},"gitbook":{"version":"3.2.3","time":"2024-12-08T16:44:57.783Z"},"basePath":".","book":{"language":"en"}});
        });
    </script>
</div>

        
    <script src="../gitbook/gitbook.js"></script>
    <script src="../gitbook/theme.js"></script>
    
        
        <script src="../gitbook/gitbook-plugin-back-to-top-button/plugin.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-chapter-fold/chapter-fold.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-code/plugin.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-search-pro/jquery.mark.min.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-search-pro/search.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-github/plugin.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-splitter/splitter.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-sharing-plus/buttons.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-flexible-alerts/plugin.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-page-toc-button/plugin.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-pageview-count/plugin.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-hide-element/plugin.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-edit-link/plugin.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-fontsettings/fontsettings.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-theme-comscore/test.js"></script>
        
    

    </body>
</html>

