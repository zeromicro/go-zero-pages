{"./":{"url":"./","title":"ç®€ä»‹","keywords":"","body":" go-zero ç¼©çŸ­ä»éœ€æ±‚åˆ°ä¸Šçº¿çš„è·ç¦» go-zero æ˜¯ä¸€ä¸ªé›†æˆäº†å„ç§å·¥ç¨‹å®è·µçš„ web å’Œ rpc æ¡†æ¶ã€‚é€šè¿‡å¼¹æ€§è®¾è®¡ä¿éšœäº†å¤§å¹¶å‘æœåŠ¡ç«¯çš„ç¨³å®šæ€§ï¼Œç»å—äº†å……åˆ†çš„å®æˆ˜æ£€éªŒã€‚ go-zero åŒ…å«æç®€çš„ API å®šä¹‰å’Œç”Ÿæˆå·¥å…· goctlï¼Œå¯ä»¥æ ¹æ®å®šä¹‰çš„ api æ–‡ä»¶ä¸€é”®ç”Ÿæˆ Go, iOS, Android, Kotlin, Dart, TypeScript, JavaScript ä»£ç ï¼Œå¹¶å¯ç›´æ¥è¿è¡Œã€‚ ä½¿ç”¨ go-zero çš„å¥½å¤„ï¼š è½»æ¾è·å¾—æ”¯æ’‘åƒä¸‡æ—¥æ´»æœåŠ¡çš„ç¨³å®šæ€§ å†…å»ºçº§è”è¶…æ—¶æ§åˆ¶ã€é™æµã€è‡ªé€‚åº”ç†”æ–­ã€è‡ªé€‚åº”é™è½½ç­‰å¾®æœåŠ¡æ²»ç†èƒ½åŠ›ï¼Œæ— éœ€é…ç½®å’Œé¢å¤–ä»£ç  å¾®æœåŠ¡æ²»ç†ä¸­é—´ä»¶å¯æ— ç¼é›†æˆåˆ°å…¶å®ƒç°æœ‰æ¡†æ¶ä½¿ç”¨ æç®€çš„ API æè¿°ï¼Œä¸€é”®ç”Ÿæˆå„ç«¯ä»£ç  è‡ªåŠ¨æ ¡éªŒå®¢æˆ·ç«¯è¯·æ±‚å‚æ•°åˆæ³•æ€§ å¤§é‡å¾®æœåŠ¡æ²»ç†å’Œå¹¶å‘å·¥å…·åŒ… 1. go-zero æ¡†æ¶èƒŒæ™¯ 18 å¹´åˆï¼Œæˆ‘ä»¬å†³å®šä» Java+MongoDB çš„å•ä½“æ¶æ„è¿ç§»åˆ°å¾®æœåŠ¡æ¶æ„ï¼Œç»è¿‡ä»”ç»†æ€è€ƒå’Œå¯¹æ¯”ï¼Œæˆ‘ä»¬å†³å®šï¼š åŸºäº Go è¯­è¨€ é«˜æ•ˆçš„æ€§èƒ½ ç®€æ´çš„è¯­æ³• å¹¿æ³›éªŒè¯çš„å·¥ç¨‹æ•ˆç‡ æè‡´çš„éƒ¨ç½²ä½“éªŒ æä½çš„æœåŠ¡ç«¯èµ„æºæˆæœ¬ è‡ªç ”å¾®æœåŠ¡æ¡†æ¶ æœ‰è¿‡å¾ˆå¤šå¾®æœåŠ¡æ¡†æ¶è‡ªç ”ç»éªŒ éœ€è¦æœ‰æ›´å¿«é€Ÿçš„é—®é¢˜å®šä½èƒ½åŠ› æ›´ä¾¿æ·çš„å¢åŠ æ–°ç‰¹æ€§ 2. go-zero æ¡†æ¶è®¾è®¡æ€è€ƒ å¯¹äºå¾®æœåŠ¡æ¡†æ¶çš„è®¾è®¡ï¼Œæˆ‘ä»¬æœŸæœ›ä¿éšœå¾®æœåŠ¡ç¨³å®šæ€§çš„åŒæ—¶ï¼Œä¹Ÿè¦ç‰¹åˆ«æ³¨é‡ç ”å‘æ•ˆç‡ã€‚æ‰€ä»¥è®¾è®¡ä¹‹åˆï¼Œæˆ‘ä»¬å°±æœ‰å¦‚ä¸‹ä¸€äº›å‡†åˆ™ï¼š ä¿æŒç®€å•ï¼Œç¬¬ä¸€åŸåˆ™ å¼¹æ€§è®¾è®¡ï¼Œé¢å‘æ•…éšœç¼–ç¨‹ å·¥å…·å¤§äºçº¦å®šå’Œæ–‡æ¡£ é«˜å¯ç”¨ é«˜å¹¶å‘ æ˜“æ‰©å±• å¯¹ä¸šåŠ¡å¼€å‘å‹å¥½ï¼Œå°è£…å¤æ‚åº¦ çº¦æŸåšä¸€ä»¶äº‹åªæœ‰ä¸€ç§æ–¹å¼ æˆ‘ä»¬ç»å†ä¸åˆ°åŠå¹´æ—¶é—´ï¼Œå½»åº•å®Œæˆäº†ä» Java+MongoDB åˆ° Golang+MySQL ä¸ºä¸»çš„å¾®æœåŠ¡ä½“ç³»è¿ç§»ï¼Œå¹¶äº 18 å¹´ 8 æœˆåº•å®Œå…¨ä¸Šçº¿ï¼Œç¨³å®šä¿éšœäº†ä¸šåŠ¡åç»­è¿…é€Ÿå¢é•¿ï¼Œç¡®ä¿äº†æ•´ä¸ªæœåŠ¡çš„é«˜å¯ç”¨ã€‚ 3. go-zero é¡¹ç›®å®ç°å’Œç‰¹ç‚¹ go-zero æ˜¯ä¸€ä¸ªé›†æˆäº†å„ç§å·¥ç¨‹å®è·µçš„åŒ…å« web å’Œ rpc æ¡†æ¶ï¼Œæœ‰å¦‚ä¸‹ä¸»è¦ç‰¹ç‚¹ï¼š å¼ºå¤§çš„å·¥å…·æ”¯æŒï¼Œå°½å¯èƒ½å°‘çš„ä»£ç ç¼–å†™ æç®€çš„æ¥å£ å®Œå…¨å…¼å®¹ net/http æ”¯æŒä¸­é—´ä»¶ï¼Œæ–¹ä¾¿æ‰©å±• é«˜æ€§èƒ½ é¢å‘æ•…éšœç¼–ç¨‹ï¼Œå¼¹æ€§è®¾è®¡ å†…å»ºæœåŠ¡å‘ç°ã€è´Ÿè½½å‡è¡¡ å†…å»ºé™æµã€ç†”æ–­ã€é™è½½ï¼Œä¸”è‡ªåŠ¨è§¦å‘ï¼Œè‡ªåŠ¨æ¢å¤ API å‚æ•°è‡ªåŠ¨æ ¡éªŒ è¶…æ—¶çº§è”æ§åˆ¶ è‡ªåŠ¨ç¼“å­˜æ§åˆ¶ é“¾è·¯è·Ÿè¸ªã€ç»Ÿè®¡æŠ¥è­¦ç­‰ é«˜å¹¶å‘æ”¯æ’‘ï¼Œç¨³å®šä¿éšœäº†ç–«æƒ…æœŸé—´æ¯å¤©çš„æµé‡æ´ªå³° å¦‚ä¸‹å›¾ï¼Œæˆ‘ä»¬ä»å¤šä¸ªå±‚é¢ä¿éšœäº†æ•´ä½“æœåŠ¡çš„é«˜å¯ç”¨ï¼š è§‰å¾—ä¸é”™çš„è¯ï¼Œåˆ«å¿˜ star ğŸ‘ 4. Installation åœ¨é¡¹ç›®ç›®å½•ä¸‹é€šè¿‡å¦‚ä¸‹å‘½ä»¤å®‰è£…ï¼š GO111MODULE=on GOPROXY=https://goproxy.cn/,direct go get -u github.com/zeromicro/go-zero 5. Quick Start å®Œæ•´ç¤ºä¾‹è¯·æŸ¥çœ‹ å¿«é€Ÿæ„å»ºé«˜å¹¶å‘å¾®æœåŠ¡ å¿«é€Ÿæ„å»ºé«˜å¹¶å‘å¾®æœåŠ¡ - å¤š RPC ç‰ˆ å®‰è£… goctl å·¥å…· goctl è¯»ä½œ go controlï¼Œä¸è¦è¯»æˆ go C-T-Lã€‚goctl çš„æ„æ€æ˜¯ä¸è¦è¢«ä»£ç æ§åˆ¶ï¼Œè€Œæ˜¯è¦å»æ§åˆ¶å®ƒã€‚å…¶ä¸­çš„ go ä¸æ˜¯æŒ‡ golangã€‚åœ¨è®¾è®¡ goctl ä¹‹åˆï¼Œæˆ‘å°±å¸Œæœ›é€šè¿‡ å¥¹ æ¥è§£æ”¾æˆ‘ä»¬çš„åŒæ‰‹ğŸ‘ˆ GO111MODULE=on GOPROXY=https://goproxy.cn/,direct go get -u github.com/zeromicro/go-zero/tools/goctl å¦‚æœä½¿ç”¨ go1.16 ç‰ˆæœ¬, å¯ä»¥ä½¿ç”¨ go install å‘½ä»¤å®‰è£… GOPROXY=https://goproxy.cn/,direct go install github.com/zeromicro/go-zero/tools/goctl@latest ç¡®ä¿ goctl å¯æ‰§è¡Œ å¿«é€Ÿç”Ÿæˆ api æœåŠ¡ goctl api new greet cd greet go mod init go mod tidy go run greet.go -f etc/greet-api.yaml é»˜è®¤ä¾¦å¬åœ¨ 8888 ç«¯å£ï¼ˆå¯ä»¥åœ¨é…ç½®æ–‡ä»¶é‡Œä¿®æ”¹ï¼‰ï¼Œå¯ä»¥é€šè¿‡ curl è¯·æ±‚ï¼š curl -i http://localhost:8888/from/you è¿”å›å¦‚ä¸‹ï¼š HTTP/1.1 200 OK Content-Type: application/json Date: Thu, 22 Oct 2020 14:03:18 GMT Content-Length: 14 {\"message\":\"\"} ç¼–å†™ä¸šåŠ¡ä»£ç ï¼š api æ–‡ä»¶å®šä¹‰äº†æœåŠ¡å¯¹å¤–æš´éœ²çš„è·¯ç”±ï¼Œå¯å‚è€ƒ api è§„èŒƒ å¯ä»¥åœ¨ servicecontext.go é‡Œé¢ä¼ é€’ä¾èµ–ç»™ logicï¼Œæ¯”å¦‚ mysql, redis ç­‰ åœ¨ api å®šä¹‰çš„ get/post/put/delete ç­‰è¯·æ±‚å¯¹åº”çš„ logic é‡Œå¢åŠ ä¸šåŠ¡å¤„ç†é€»è¾‘ å¯ä»¥æ ¹æ® api æ–‡ä»¶ç”Ÿæˆå‰ç«¯éœ€è¦çš„ Java, TypeScript, Dart, JavaScript ä»£ç  goctl api java -api greet.api -dir greet goctl api dart -api greet.api -dir greet ... 6. Benchmark æµ‹è¯•ä»£ç è§è¿™é‡Œ 7. æ–‡æ¡£ API æ–‡æ¡£ goctl ä½¿ç”¨å¸®åŠ© awesome ç³»åˆ—ï¼ˆæ›´å¤šæ–‡ç« è§ã€å¾®æœåŠ¡å®è·µã€å…¬ä¼—å·ï¼‰ å¿«é€Ÿæ„å»ºé«˜å¹¶å‘å¾®æœåŠ¡ å¿«é€Ÿæ„å»ºé«˜å¹¶å‘å¾®æœåŠ¡ - å¤š RPC ç‰ˆ ç²¾é€‰ goctl æ’ä»¶ æ’ä»¶ ç”¨é€” goctl-swagger ä¸€é”®ç”Ÿæˆ api çš„ swagger æ–‡æ¡£ goctl-android ç”Ÿæˆ java (android) ç«¯ http client è¯·æ±‚ä»£ç  goctl-go-compact åˆå¹¶ api é‡ŒåŒä¸€ä¸ª group é‡Œçš„ handler åˆ°ä¸€ä¸ª go æ–‡ä»¶ 8. å¾®ä¿¡å…¬ä¼—å· go-zero ç›¸å…³æ–‡ç« éƒ½ä¼šåœ¨ å¾®æœåŠ¡å®è·µ å…¬ä¼—å·æ•´ç†å‘ˆç°ï¼Œæ¬¢è¿æ‰«ç å…³æ³¨ï¼Œä¹Ÿå¯ä»¥é€šè¿‡å…¬ä¼—å·ç§ä¿¡æˆ‘ ğŸ‘ 9. å¾®ä¿¡äº¤æµç¾¤ å¦‚æœæ–‡æ¡£ä¸­æœªèƒ½è¦†ç›–çš„ä»»ä½•ç–‘é—®ï¼Œæ¬¢è¿æ‚¨åœ¨ç¾¤é‡Œæå‡ºï¼Œæˆ‘ä»¬ä¼šå°½å¿«ç­”å¤ã€‚ æ‚¨å¯ä»¥åœ¨ç¾¤å†…æå‡ºä½¿ç”¨ä¸­éœ€è¦æ”¹è¿›çš„åœ°æ–¹ï¼Œæˆ‘ä»¬ä¼šè€ƒè™‘åˆç†æ€§å¹¶å°½å¿«ä¿®æ”¹ã€‚ å¦‚æœæ‚¨å‘ç° bug è¯·åŠæ—¶æ issueï¼Œæˆ‘ä»¬ä¼šå°½å¿«ç¡®è®¤å¹¶ä¿®æ”¹ã€‚ ä¸ºäº†é˜²æ­¢å¹¿å‘Šç”¨æˆ·ã€è¯†åˆ«æŠ€æœ¯åŒè¡Œï¼Œè¯· star ååŠ æˆ‘æ—¶æ³¨æ˜ github å½“å‰ star æ•°ï¼Œæˆ‘å†æ‹‰è¿› go-zero ç¾¤ï¼Œæ„Ÿè°¢ï¼ åŠ æˆ‘ä¹‹å‰æœ‰åŠ³ç‚¹ä¸€ä¸‹ starï¼Œä¸€ä¸ªå°å°çš„ star æ˜¯ä½œè€…ä»¬å›ç­”æµ·é‡é—®é¢˜çš„åŠ¨åŠ›ğŸ¤ Copyright Â© 2019-2021 go-zero all right reservedï¼Œpowered by GitbookLast UpdateTimeï¼š 2025-05-05 05:44:52 "},"about-us.html":{"url":"about-us.html","title":"å…³äºæˆ‘ä»¬","keywords":"","body":"å…³äºæˆ‘ä»¬ go-zero go-zero æ˜¯ä¸€ä¸ªé›†æˆäº†å„ç§å·¥ç¨‹å®è·µçš„ web å’Œ rpc æ¡†æ¶ã€‚é€šè¿‡å¼¹æ€§è®¾è®¡ä¿éšœäº†å¤§å¹¶å‘æœåŠ¡ç«¯çš„ç¨³å®šæ€§ï¼Œç»å—äº†å……åˆ†çš„å®æˆ˜æ£€éªŒã€‚ go-zero åŒ…å«æç®€çš„ API å®šä¹‰å’Œç”Ÿæˆå·¥å…· goctlï¼Œå¯ä»¥æ ¹æ®å®šä¹‰çš„ api æ–‡ä»¶ä¸€é”®ç”Ÿæˆ Go, iOS, Android, Kotlin, Dart, TypeScript, JavaScript ä»£ç ï¼Œå¹¶å¯ç›´æ¥è¿è¡Œã€‚ go-zeroä½œè€… ä¸‡ä¿Šå³°ï¼Œä¸ƒç‰›äº‘æŠ€æœ¯å‰¯æ€»è£ï¼Œæ‹¥æœ‰14å¹´ç ”å‘å›¢é˜Ÿç®¡ç†ç»éªŒï¼Œ16å¹´æ¶æ„è®¾è®¡ç»éªŒï¼Œ20å¹´å·¥ç¨‹å®æˆ˜ç»éªŒï¼Œè´Ÿè´£è¿‡å¤šä¸ªå¤§å‹é¡¹ç›®çš„æ¶æ„è®¾è®¡ï¼Œæ›¾å¤šæ¬¡åˆä¼™åˆ›ä¸šï¼ˆè¢«æ”¶è´­ï¼‰ï¼Œé˜¿é‡Œäº‘MVPï¼ŒArchSummitå…¨çƒæ¶æ„å¸ˆå³°ä¼šæ˜æ˜Ÿè®²å¸ˆï¼ŒGopherChinaå¤§ä¼šä¸»æŒäºº & é‡‘ç‰Œè®²å¸ˆï¼ŒQCon+ Goè¯­è¨€å‡ºå“äººå…¼è®²å¸ˆï¼Œè…¾è®¯äº‘å¼€å‘è€…å¤§ä¼šè®²å¸ˆã€‚ go-zeroç¤¾åŒº æˆ‘ä»¬ç›®å‰æ‹¥æœ‰7000å¤šäººçš„ç¤¾åŒºæˆå‘˜ï¼Œåœ¨è¿™é‡Œï¼Œä½ å¯ä»¥å’Œå¤§å®¶è®¨è®ºä»»ä½•å…³äºgo-zeroçš„æŠ€æœ¯ï¼Œé—®é¢˜åé¦ˆï¼Œè·å–æœ€æ–°çš„go-zeroä¿¡æ¯ï¼Œä»¥åŠå„ä½å¤§ä½¬æ¯å¤©åˆ†äº«çš„æŠ€æœ¯å¿ƒå¾—ã€‚ go-zeroç¤¾åŒºç¾¤ Copyright Â© 2019-2021 go-zero all right reservedï¼Œpowered by GitbookLast UpdateTimeï¼š 2025-05-05 05:44:52 "},"join-us.html":{"url":"join-us.html","title":"åŠ å…¥æˆ‘ä»¬","keywords":"","body":"åŠ å…¥æˆ‘ä»¬ æ¦‚è¦ go-zero æ˜¯ä¸€ä¸ªåŸºäºMIT License çš„å¼€æºé¡¹ç›®ï¼Œå¤§å®¶åœ¨ä½¿ç”¨ä¸­å‘ç°bugï¼Œæœ‰æ–°çš„ç‰¹æ€§ç­‰ï¼Œå‡å¯ä»¥å‚ä¸åˆ°go-zeroçš„è´¡çŒ®ä¸­æ¥ï¼Œæˆ‘ä»¬éå¸¸æ¬¢è¿å¤§å®¶çš„ç§¯æå‚ä¸ï¼Œä¹Ÿä¼šæœ€å¿«å“åº”å¤§å®¶æå‡ºçš„å„ç§é—®é¢˜ï¼Œprç­‰ã€‚ è´¡çŒ®å½¢å¼ Pull Request Issue è´¡çŒ®é¡»çŸ¥ go-zero çš„Pull requestä¸­çš„ä»£ç éœ€è¦æ»¡è¶³ä¸€å®šè§„èŒƒ å‘½åè§„èŒƒï¼Œè¯·é˜…è¯»å‘½åè§„èŒƒ ä»¥è‹±æ–‡æ³¨é‡Šä¸ºä¸» præ—¶å¤‡æ³¨å¥½åŠŸèƒ½ç‰¹æ€§ï¼Œæè¿°éœ€è¦æ¸…æ™°ï¼Œç®€æ´ å¢åŠ å•å…ƒæµ‹è¯•è¦†ç›–ç‡è¾¾80%+ è´¡çŒ®ä»£ç ï¼ˆprï¼‰ è¿›å…¥go-zero é¡¹ç›®ï¼Œforkä¸€ä»½go-zero é¡¹ç›®åˆ°è‡ªå·±çš„githubä»“åº“ä¸­ã€‚ å›åˆ°è‡ªå·±çš„githubä¸»é¡µï¼Œæ‰¾åˆ°xx/go-zeroé¡¹ç›®ï¼Œå…¶ä¸­xxä¸ºä½ çš„ç”¨æˆ·åï¼Œå¦‚anqiansong/go-zero å…‹éš†ä»£ç åˆ°æœ¬åœ° å¼€å‘ä»£ç ï¼Œpushåˆ°è‡ªå·±çš„githubä»“åº“ è¿›å…¥è‡ªå·±çš„githubä¸­go-zeroé¡¹ç›®ï¼Œç‚¹å‡»æµ®å±‚ä¸Šçš„çš„ã€Pull requestsã€‘è¿›å…¥Compareé¡µé¢ã€‚ base repositoryé€‰æ‹©zeromicro/go-zero base:master,head repositoryé€‰æ‹©xx/go-zero compare:$branch ï¼Œ$branchä¸ºä½ å¼€å‘çš„åˆ†æ”¯ï¼Œå¦‚å›¾ï¼š ç‚¹å‡»ã€Create pull requestã€‘å³å¯å®ç°prç”³è¯· ç¡®è®¤præ˜¯å¦æäº¤æˆåŠŸï¼Œè¿›å…¥go-zero çš„Pull requests æŸ¥çœ‹ï¼Œåº”è¯¥æœ‰è‡ªå·±æäº¤çš„è®°å½•ï¼Œåç§°ä¸ºä½ çš„å¼€å‘æ—¶çš„åˆ†æ”¯åç§° Issue åœ¨æˆ‘ä»¬çš„ç¤¾åŒºä¸­ï¼Œæœ‰å¾ˆå¤šä¼™ä¼´ä¼šç§¯æçš„åé¦ˆä¸€äº›go-zeroä½¿ç”¨è¿‡ç¨‹ä¸­é‡åˆ°çš„é—®é¢˜ï¼Œç”±äºç¤¾åŒºäººæ•°è¾ƒå¤šï¼Œæˆ‘ä»¬è™½ç„¶ä¼šå®æ—¶çš„å…³æ³¨ç¤¾åŒºåŠ¨æ€ï¼Œä½†å¤§å®¶é—®é¢˜åé¦ˆè¿‡æ¥éƒ½æ˜¯éšæœºçš„ï¼Œå½“æˆ‘ä»¬å›¢é˜Ÿè¿˜åœ¨è§£å†³æŸä¸€ä¸ªä¼™ä¼´æå‡ºçš„é—®é¢˜æ—¶ï¼Œå¦å¤–çš„é—®é¢˜ä¹Ÿåé¦ˆä¸Šæ¥ï¼Œå¯èƒ½ä¼šå¯¼è‡´å›¢é˜Ÿä¼šå¾ˆå®¹æ˜“å¿½ç•¥æ‰ï¼Œä¸ºäº†èƒ½å¤Ÿä¸€ä¸€çš„è§£å†³å¤§å®¶çš„é—®é¢˜ï¼Œæˆ‘ä»¬å¼ºçƒˆå»ºè®®å¤§å®¶é€šè¿‡issueçš„æ–¹å¼æ¥åé¦ˆé—®é¢˜ï¼ŒåŒ…æ‹¬ä½†ä¸é™äºbugï¼ŒæœŸæœ›çš„æ–°åŠŸèƒ½ç‰¹æ€§ç­‰ï¼Œæˆ‘ä»¬åœ¨å®ç°æŸä¸€ä¸ªæ–°ç‰¹æ€§æ—¶ä¹Ÿä¼šåœ¨issueä¸­ä½“ç°ï¼Œå¤§å®¶åœ¨è¿™é‡Œä¹Ÿèƒ½å¤Ÿåœ¨è¿™é‡Œè·å–åˆ°go-zeroçš„æœ€æ–°åŠ¨å‘ï¼Œä¹Ÿæ¬¢è¿å¤§å®¶æ¥ç§¯æçš„å‚ä¸è®¨è®ºã€‚ æ€ä¹ˆæIssue ç‚¹å‡»è¿™é‡Œ è¿›å…¥go-zeroçš„Issueé¡µé¢æˆ–è€…ç›´æ¥è®¿é—®https://github.com/zeromicro/go-zero/issues åœ°å€ ç‚¹å‡»å³ä¸Šè§’çš„ã€New issueã€‘æ–°å»ºissue å¡«å†™issueæ ‡é¢˜å’Œå†…å®¹ ç‚¹å‡»ã€Submit new issueã€‘æäº¤issue å‚è€ƒæ–‡æ¡£ Github Pull request Copyright Â© 2019-2021 go-zero all right reservedï¼Œpowered by GitbookLast UpdateTimeï¼š 2025-05-05 05:44:52 "},"concept-introduction.html":{"url":"concept-introduction.html","title":"æ¦‚å¿µä»‹ç»","keywords":"","body":"æ¦‚å¿µä»‹ç» go-zero æ™“é»‘æ¿golangå¼€æºé¡¹ç›®ï¼Œé›†å„ç§å·¥ç¨‹å®è·µäºä¸€èº«çš„webå’Œrpcæ¡†æ¶ã€‚ goctl ä¸€ä¸ªæ—¨åœ¨ä¸ºå¼€å‘äººå‘˜æé«˜å·¥ç¨‹æ•ˆç‡ã€é™ä½å‡ºé”™ç‡çš„è¾…åŠ©å·¥å…·ã€‚ goctlæ’ä»¶ æŒ‡ä»¥goctlä¸ºä¸­å¿ƒçš„å‘¨è¾¹äºŒè¿›åˆ¶èµ„æºï¼Œèƒ½å¤Ÿæ»¡è¶³ä¸€äº›ä¸ªæ€§åŒ–çš„ä»£ç ç”Ÿæˆéœ€æ±‚ï¼Œå¦‚è·¯ç”±åˆå¹¶æ’ä»¶goctl-go-compactæ’ä»¶ï¼Œ ç”Ÿæˆswaggeræ–‡æ¡£çš„goctl-swaggeræ’ä»¶ï¼Œç”Ÿæˆphpè°ƒç”¨ç«¯çš„goctl-phpæ’ä»¶ç­‰ã€‚ intellij/vscodeæ’ä»¶ åœ¨intellijç³»åˆ—äº§å“ä¸Šé…åˆgoctlå¼€å‘çš„æ’ä»¶ï¼Œå…¶å°†goctlå‘½ä»¤è¡Œæ“ä½œä½¿ç”¨UIè¿›è¡Œæ›¿ä»£ã€‚ apiæ–‡ä»¶ apiæ–‡ä»¶æ˜¯æŒ‡ç”¨äºå®šä¹‰å’Œæè¿°apiæœåŠ¡çš„æ–‡æœ¬æ–‡ä»¶ï¼Œå…¶ä»¥.apiåç¼€ç»“å°¾ï¼ŒåŒ…å«apiè¯­æ³•æè¿°å†…å®¹ã€‚ goctlç¯å¢ƒ goctlç¯å¢ƒæ˜¯ä½¿ç”¨goctlå‰çš„å‡†å¤‡ç¯å¢ƒï¼ŒåŒ…å« golangç¯å¢ƒ protoc protoc-gen-goæ’ä»¶ go module | gopath go-zero-demo go-zero-demoé‡Œé¢åŒ…å«äº†æ–‡æ¡£ä¸­æ‰€æœ‰æºç çš„ä¸€ä¸ªå¤§ä»“åº“ï¼Œåç»­æˆ‘ä»¬åœ¨ç¼–å†™æ¼”ç¤ºdemoæ—¶ï¼Œæˆ‘ä»¬å‡åœ¨æ­¤é¡¹ç›®ä¸‹åˆ›å»ºå­é¡¹ç›®ï¼Œ å› æ­¤æˆ‘ä»¬éœ€è¦æå‰åˆ›å»ºä¸€ä¸ªå¤§ä»“åº“go-zero-demoï¼Œæˆ‘è¿™é‡ŒæŠŠè¿™ä¸ªä»“åº“æ”¾åœ¨homeç›®å½•ä¸‹ã€‚ $ cd ~ $ mkdir go-zero-demo&&cd go-zero-demo $ go mod init go-zero-demo å‚è€ƒæ–‡æ¡£ go-zero Goctl æ’ä»¶ä¸­å¿ƒ å·¥å…·ä¸­å¿ƒ apiè¯­æ³• Copyright Â© 2019-2021 go-zero all right reservedï¼Œpowered by GitbookLast UpdateTimeï¼š 2025-05-05 05:44:52 "},"quick-start.html":{"url":"quick-start.html","title":"å¿«é€Ÿå¼€å‘","keywords":"","body":"å¿«é€Ÿå¼€å‘ æœ¬èŠ‚ä¸»è¦é€šè¿‡å¯¹ api/rpc ç­‰æœåŠ¡å¿«é€Ÿå¼€å§‹æ¥è®©å¤§å®¶å¯¹ä½¿ç”¨ go-zero å¼€å‘çš„å·¥ç¨‹æœ‰ä¸€ä¸ªå®è§‚æ¦‚å¿µï¼Œæ›´åŠ è¯¦ç»†çš„ä»‹ç»æˆ‘ä»¬å°†åœ¨åç»­ä¸€ä¸€å±•å¼€ã€‚å¦‚æœæ‚¨å·²ç»å‚è€ƒ å‡†å¤‡å·¥ä½œ åšå¥½ç¯å¢ƒåŠå·¥å…·çš„å‡†å¤‡ï¼Œè¯·è·Ÿéšä»¥ä¸‹å°èŠ‚å¼€å§‹ä½“éªŒï¼š å•ä½“æœåŠ¡ å¾®æœåŠ¡ Copyright Â© 2019-2021 go-zero all right reservedï¼Œpowered by GitbookLast UpdateTimeï¼š 2025-05-05 05:44:52 "},"monolithic-service.html":{"url":"monolithic-service.html","title":"å•ä½“æœåŠ¡","keywords":"","body":"å•ä½“æœåŠ¡ å‰è¨€ ç”±äºgo-zeroé›†æˆäº†web/rpcäºä¸€ä½“ï¼Œç¤¾åŒºæœ‰éƒ¨åˆ†å°ä¼™ä¼´ä¼šé—®æˆ‘ï¼Œgo-zeroçš„å®šä½æ˜¯å¦æ˜¯ä¸€æ¬¾å¾®æœåŠ¡æ¡†æ¶ï¼Œç­”æ¡ˆæ˜¯ä¸æ­¢äºæ­¤ï¼Œ go-zeroè™½ç„¶é›†ä¼—å¤šåŠŸèƒ½äºä¸€èº«ï¼Œä½†ä½ å¯ä»¥å°†å…¶ä¸­ä»»ä½•ä¸€ä¸ªåŠŸèƒ½ç‹¬ç«‹å‡ºæ¥å»å•ç‹¬ä½¿ç”¨ï¼Œä¹Ÿå¯ä»¥å¼€å‘å•ä½“æœåŠ¡ï¼Œ ä¸æ˜¯è¯´æ¯ä¸ªæœåŠ¡ä¸Šæ¥å°±ä¸€å®šè¦é‡‡ç”¨å¾®æœåŠ¡çš„æ¶æ„çš„è®¾è®¡ï¼Œè¿™ç‚¹å¤§å®¶å¯ä»¥çœ‹çœ‹ä½œè€…(kevin)çš„ç¬¬å››æœŸå¼€æºè¯´ ï¼Œå…¶ä¸­å¯¹æ­¤æœ‰è¯¦ç»†çš„è®²è§£ã€‚ åˆ›å»ºgreetæœåŠ¡ $ mkdir go-zero-demo $ cd go-zero-demo $ go mod init go-zero-demo $ goctl api new greet $ go mod tidy Done. è¯´æ˜ï¼šå¦‚æ—  cd æ”¹å˜ç›®å½•çš„æ“ä½œï¼Œæ‰€æœ‰æ“ä½œå‡åœ¨ go-zero-demo ç›®å½•æ‰§è¡Œ æŸ¥çœ‹ä¸€ä¸‹greetæœåŠ¡çš„ç›®å½•ç»“æ„ $ tree greet greet â”œâ”€â”€ etc â”‚ â””â”€â”€ greet-api.yaml â”œâ”€â”€ greet.api â”œâ”€â”€ greet.go â””â”€â”€ internal â”œâ”€â”€ config â”‚ â””â”€â”€ config.go â”œâ”€â”€ handler â”‚ â”œâ”€â”€ greethandler.go â”‚ â””â”€â”€ routes.go â”œâ”€â”€ logic â”‚ â””â”€â”€ greetlogic.go â”œâ”€â”€ svc â”‚ â””â”€â”€ servicecontext.go â””â”€â”€ types â””â”€â”€ types.go ç”±ä»¥ä¸Šç›®å½•ç»“æ„å¯ä»¥è§‚å¯Ÿåˆ°ï¼ŒgreetæœåŠ¡è™½å°ï¼Œä½†\"äº”è„ä¿±å…¨\"ã€‚æ¥ä¸‹æ¥æˆ‘ä»¬å°±å¯ä»¥åœ¨greetlogic.goä¸­ç¼–å†™ä¸šåŠ¡ä»£ç äº†ã€‚ ç¼–å†™é€»è¾‘ $ vim greet/internal/logic/greetlogic.go func (l *GreetLogic) Greet(req *types.Request) (*types.Response, error) { return &types.Response{ Message: \"Hello go-zero\", }, nil } å¯åŠ¨å¹¶è®¿é—®æœåŠ¡ å¯åŠ¨æœåŠ¡ $ cd greet $ go run greet.go -f etc/greet-api.yaml è¾“å‡ºå¦‚ä¸‹ï¼ŒæœåŠ¡å¯åŠ¨å¹¶ä¾¦å¬åœ¨8888ç«¯å£ï¼š Starting server at 0.0.0.0:8888... è®¿é—®æœåŠ¡ $ curl -i -X GET http://localhost:8888/from/you è¿”å›å¦‚ä¸‹ï¼š HTTP/1.1 200 OK Content-Type: application/json Date: Sun, 07 Feb 2021 04:31:25 GMT Content-Length: 27 {\"message\":\"Hello go-zero\"} æºç  greetæºç  çŒœä½ æƒ³çœ‹ goctlä½¿ç”¨è¯´æ˜ apiç›®å½•ç»“æ„ä»‹ç» apiè¯­æ³• apié…ç½®æ–‡ä»¶ä»‹ç» apiä¸­é—´ä»¶ä½¿ç”¨ Copyright Â© 2019-2021 go-zero all right reservedï¼Œpowered by GitbookLast UpdateTimeï¼š 2025-05-05 05:44:52 "},"micro-service.html":{"url":"micro-service.html","title":"å¾®æœåŠ¡","keywords":"","body":"å¾®æœåŠ¡ åœ¨ä¸Šä¸€ç¯‡æˆ‘ä»¬å·²ç»æ¼”ç¤ºäº†æ€æ ·å¿«é€Ÿåˆ›å»ºä¸€ä¸ªå•ä½“æœåŠ¡ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬æ¥æ¼”ç¤ºä¸€ä¸‹å¦‚ä½•å¿«é€Ÿåˆ›å»ºå¾®æœåŠ¡ï¼Œ åœ¨æœ¬å°èŠ‚ä¸­ï¼Œapiéƒ¨åˆ†å…¶å®å’Œå•ä½“æœåŠ¡çš„åˆ›å»ºé€»è¾‘æ˜¯ä¸€æ ·çš„ï¼Œåªæ˜¯åœ¨å•ä½“æœåŠ¡ä¸­æ²¡æœ‰æœåŠ¡é—´çš„é€šè®¯è€Œå·²ï¼Œ ä¸”å¾®æœåŠ¡ä¸­apiæœåŠ¡ä¼šå¤šä¸€äº›rpcè°ƒç”¨çš„é…ç½®ã€‚ å‰è¨€ æœ¬å°èŠ‚å°†ä»¥ä¸€ä¸ªè®¢å•æœåŠ¡è°ƒç”¨ç”¨æˆ·æœåŠ¡æ¥ç®€å•æ¼”ç¤ºä¸€ä¸‹ï¼Œæ¼”ç¤ºä»£ç ä»…ä¼ é€’æ€è·¯ï¼Œå…¶ä¸­æœ‰äº›ç¯èŠ‚ä¸ä¼šä¸€ä¸€åˆ—ä¸¾ã€‚ æƒ…æ™¯æè¦ å‡è®¾æˆ‘ä»¬åœ¨å¼€å‘ä¸€ä¸ªå•†åŸé¡¹ç›®ï¼Œè€Œå¼€å‘è€…å°æ˜è´Ÿè´£ç”¨æˆ·æ¨¡å—(user)å’Œè®¢å•æ¨¡å—(order)çš„å¼€å‘ï¼Œæˆ‘ä»¬å§‘ä¸”å°†è¿™ä¸¤ä¸ªæ¨¡å—æ‹†åˆ†æˆä¸¤ä¸ªå¾®æœåŠ¡â‘  [æ³¨æ„] â‘ ï¼šå¾®æœåŠ¡çš„æ‹†åˆ†ä¹Ÿæ˜¯ä¸€é—¨å­¦é—®ï¼Œè¿™é‡Œæˆ‘ä»¬å°±ä¸è®¨è®ºæ€ä¹ˆå»æ‹†åˆ†å¾®æœåŠ¡çš„ç»†èŠ‚äº†ã€‚ æ¼”ç¤ºåŠŸèƒ½ç›®æ ‡ è®¢å•æœåŠ¡(order)æä¾›ä¸€ä¸ªæŸ¥è¯¢æ¥å£ ç”¨æˆ·æœåŠ¡(user)æä¾›ä¸€ä¸ªæ–¹æ³•ä¾›è®¢å•æœåŠ¡è·å–ç”¨æˆ·ä¿¡æ¯ æœåŠ¡è®¾è®¡åˆ†æ æ ¹æ®æƒ…æ™¯æè¦æˆ‘ä»¬å¯ä»¥å¾—çŸ¥ï¼Œè®¢å•æ˜¯ç›´æ¥é¢å‘ç”¨æˆ·ï¼Œé€šè¿‡httpåè®®è®¿é—®æ•°æ®ï¼Œè€Œè®¢å•å†…éƒ¨éœ€è¦è·å–ç”¨æˆ·çš„ä¸€äº›åŸºç¡€æ•°æ®ï¼Œæ—¢ç„¶æˆ‘ä»¬çš„æœåŠ¡æ˜¯é‡‡ç”¨å¾®æœåŠ¡çš„æ¶æ„è®¾è®¡ï¼Œ é‚£ä¹ˆä¸¤ä¸ªæœåŠ¡ï¼ˆuser, orderï¼‰å°±å¿…é¡»è¦è¿›è¡Œæ•°æ®äº¤æ¢ï¼ŒæœåŠ¡é—´çš„æ•°æ®äº¤æ¢å³æœåŠ¡é—´çš„é€šè®¯ï¼Œåˆ°äº†è¿™é‡Œï¼Œé‡‡ç”¨åˆç†çš„é€šè®¯åè®®ä¹Ÿæ˜¯ä¸€ä¸ªå¼€å‘äººå‘˜éœ€è¦ è€ƒè™‘çš„äº‹æƒ…ï¼Œå¯ä»¥é€šè¿‡httpï¼Œrpcç­‰æ–¹å¼æ¥è¿›è¡Œé€šè®¯ï¼Œè¿™é‡Œæˆ‘ä»¬é€‰æ‹©rpcæ¥å®ç°æœåŠ¡é—´çš„é€šè®¯ï¼Œç›¸ä¿¡è¿™é‡Œæˆ‘å·²ç»å¯¹\"rpcæœåŠ¡å­˜åœ¨æœ‰ä»€ä¹ˆä½œç”¨ï¼Ÿ\"å·²ç»ä½œäº†ä¸€ä¸ªæ¯”è¾ƒå¥½çš„åœºæ™¯æè¿°ã€‚ å½“ç„¶ï¼Œä¸€ä¸ªæœåŠ¡å¼€å‘å‰è¿œä¸æ­¢è¿™ç‚¹è®¾è®¡åˆ†æï¼Œæˆ‘ä»¬è¿™é‡Œå°±ä¸è¯¦ç»†æè¿°äº†ã€‚ä»ä¸Šæ–‡å¾—çŸ¥ï¼Œæˆ‘ä»¬éœ€è¦ä¸€ä¸ª user rpc order api ä¸¤ä¸ªæœåŠ¡æ¥åˆæ­¥å®ç°è¿™ä¸ªå°demoã€‚ åˆ›å»ºmallå·¥ç¨‹ å¦‚æœä½ è·‘äº†å•ä½“çš„ç¤ºä¾‹ï¼Œé‡Œé¢ä¹Ÿå« go-zero-demoï¼Œä½ å¯èƒ½éœ€è¦æ¢ä¸€ä¸ªçˆ¶ç›®å½•ã€‚ $ mkdir go-zero-demo $ cd go-zero-demo $ go mod init go-zero-demo è¯´æ˜ï¼šå¦‚æ—  cd æ”¹å˜ç›®å½•çš„æ“ä½œï¼Œæ‰€æœ‰æ“ä½œå‡åœ¨ go-zero-demo ç›®å½•æ‰§è¡Œ åˆ›å»ºuser rpcæœåŠ¡ åˆ›å»ºuser rpcæœåŠ¡ $ mkdir -p mall/user/rpc æ·»åŠ user.protoæ–‡ä»¶ï¼Œå¢åŠ getUseræ–¹æ³• $ vim mall/user/rpc/user.proto å¢åŠ å¦‚ä¸‹ä»£ç ï¼š syntax = \"proto3\"; package user; // protoc-gen-go ç‰ˆæœ¬å¤§äº1.4.0, protoæ–‡ä»¶éœ€è¦åŠ ä¸Šgo_package,å¦åˆ™æ— æ³•ç”Ÿæˆ option go_package = \"./user\"; message IdRequest { string id = 1; } message UserResponse { // ç”¨æˆ·id string id = 1; // ç”¨æˆ·åç§° string name = 2; // ç”¨æˆ·æ€§åˆ« string gender = 3; } service User { rpc getUser(IdRequest) returns(UserResponse); } ç”Ÿæˆä»£ç  å¦‚æœªå®‰è£… protoc,protoc-gen-go,protoc-gen-grpc-go ä½ å¯ä»¥é€šè¿‡å¦‚ä¸‹æŒ‡ä»¤ä¸€é”®å®‰è£…: $ goctl env check -i -f æ³¨æ„ï¼š 1ã€æ¯ä¸€ä¸ª *.protoæ–‡ä»¶åªå…è®¸æœ‰ä¸€ä¸ªservice error: only one service expected $ cd mall/user/rpc $ goctl rpc protoc user.proto --go_out=./types --go-grpc_out=./types --zrpc_out=. Done. å¡«å……ä¸šåŠ¡é€»è¾‘ $ vim internal/logic/getuserlogic.go package logic import ( \"context\" \"go-zero-demo/mall/user/rpc/internal/svc\" \"go-zero-demo/mall/user/rpc/types/user\" \"github.com/zeromicro/go-zero/core/logx\" ) type GetUserLogic struct { ctx context.Context svcCtx *svc.ServiceContext logx.Logger } func NewGetUserLogic(ctx context.Context, svcCtx *svc.ServiceContext) *GetUserLogic { return &GetUserLogic{ ctx: ctx, svcCtx: svcCtx, Logger: logx.WithContext(ctx), } } func (l *GetUserLogic) GetUser(in *user.IdRequest) (*user.UserResponse, error) { return &user.UserResponse{ Id: \"1\", Name: \"test\", }, nil } åˆ›å»ºorder apiæœåŠ¡ åˆ›å»º order apiæœåŠ¡ # å›åˆ° go-zero-demo/mall ç›®å½• $ mkdir -p order/api && cd order/api æ·»åŠ apiæ–‡ä»¶ $ vim order.api type( OrderReq { Id string `path:\"id\"` } OrderReply { Id string `json:\"id\"` Name string `json:\"name\"` } ) service order { @handler getOrder get /api/order/get/:id (OrderReq) returns (OrderReply) } ç”ŸæˆorderæœåŠ¡ $ goctl api go -api order.api -dir . Done. æ·»åŠ user rpcé…ç½® $ vim internal/config/config.go package config import ( \"github.com/zeromicro/go-zero/zrpc\" \"github.com/zeromicro/go-zero/rest\" ) type Config struct { rest.RestConf UserRpc zrpc.RpcClientConf } æ·»åŠ yamlé…ç½® $ vim etc/order.yaml Name: order Host: 0.0.0.0 Port: 8888 UserRpc: Etcd: Hosts: - 127.0.0.1:2379 Key: user.rpc å®Œå–„æœåŠ¡ä¾èµ– $ vim internal/svc/servicecontext.go package svc import ( \"go-zero-demo/mall/order/api/internal/config\" \"go-zero-demo/mall/user/rpc/user\" \"github.com/zeromicro/go-zero/zrpc\" ) type ServiceContext struct { Config config.Config UserRpc user.User } func NewServiceContext(c config.Config) *ServiceContext { return &ServiceContext{ Config: c, UserRpc: user.NewUser(zrpc.MustNewClient(c.UserRpc)), } } æ·»åŠ orderæ¼”ç¤ºé€»è¾‘ ç»™ getorderlogic æ·»åŠ ä¸šåŠ¡é€»è¾‘ $ vim internal/logic/getorderlogic.go package logic import ( \"context\" \"errors\" \"go-zero-demo/mall/order/api/internal/svc\" \"go-zero-demo/mall/order/api/internal/types\" \"go-zero-demo/mall/user/rpc/types/user\" \"github.com/zeromicro/go-zero/core/logx\" ) type GetOrderLogic struct { logx.Logger ctx context.Context svcCtx *svc.ServiceContext } func NewGetOrderLogic(ctx context.Context, svcCtx *svc.ServiceContext) GetOrderLogic { return GetOrderLogic{ Logger: logx.WithContext(ctx), ctx: ctx, svcCtx: svcCtx, } } func (l *GetOrderLogic) GetOrder(req *types.OrderReq) (*types.OrderReply, error) { user, err := l.svcCtx.UserRpc.GetUser(l.ctx, &user.IdRequest{ Id: \"1\", }) if err != nil { return nil, err } if user.Name != \"test\" { return nil, errors.New(\"ç”¨æˆ·ä¸å­˜åœ¨\") } return &types.OrderReply{ Id: req.Id, Name: \"test order\", }, nil } å¯åŠ¨æœåŠ¡å¹¶éªŒè¯ å¯åŠ¨etcd$ etcd ä¸‹è½½ä¾èµ–# åœ¨ go-zero-demo ç›®å½•ä¸‹ $ go mod tidy å¯åŠ¨user rpc # åœ¨ mall/user/rpc ç›®å½• $ go run user.go -f etc/user.yaml Starting rpc server at 127.0.0.1:8080... å¯åŠ¨order api # åœ¨ mall/order/api ç›®å½• $ go run order.go -f etc/order.yaml Starting server at 0.0.0.0:8888... è®¿é—®order api $ curl -i -X GET http://localhost:8888/api/order/get/1 HTTP/1.1 200 OK Content-Type: application/json Date: Sun, 07 Feb 2021 03:45:05 GMT Content-Length: 30 {\"id\":\"1\",\"name\":\"test order\"} æ³¨æ„ï¼šåœ¨æ¼”ç¤ºä¸­çš„æåŠçš„apiè¯­æ³•ï¼Œrpcç”Ÿæˆï¼Œgoctlï¼Œgoctlç¯å¢ƒç­‰æ€ä¹ˆä½¿ç”¨å’Œå®‰è£…ï¼Œå¿«é€Ÿå…¥é—¨ä¸­ä¸ä½œè¯¦ç»†æ¦‚è¿°ï¼Œæˆ‘ä»¬åç»­éƒ½ä¼šæœ‰è¯¦ç»†çš„æ–‡æ¡£è¿›è¡Œæè¿°ï¼Œä½ ä¹Ÿå¯ä»¥ç‚¹å‡»ä¸‹æ–‡çš„ã€çŒœä½ æƒ³çœ‹ã€‘å¿«é€Ÿè·³è½¬çš„å¯¹åº”æ–‡æ¡£æŸ¥çœ‹ã€‚ æºç  mallæºç  çŒœä½ æƒ³çœ‹ goctlä½¿ç”¨è¯´æ˜ apiç›®å½•ç»“æ„ä»‹ç» apiè¯­æ³• apié…ç½®æ–‡ä»¶ä»‹ç» apiä¸­é—´ä»¶ä½¿ç”¨ rpcç›®å½• rpcé…ç½® rpcè°ƒç”¨æ–¹è¯´æ˜ Copyright Â© 2019-2021 go-zero all right reservedï¼Œpowered by GitbookLast UpdateTimeï¼š 2025-05-05 05:44:52 "},"framework-design.html":{"url":"framework-design.html","title":"æ¡†æ¶è®¾è®¡","keywords":"","body":"æ¡†æ¶è®¾è®¡ æœ¬èŠ‚å°†ä» go-zero çš„è®¾è®¡ç†å¿µï¼Œgo-zero æœåŠ¡çš„æœ€ä½³å®è·µç›®å½•æ¥è¯´æ˜ go-zero æ¡†æ¶çš„è®¾è®¡ï¼Œæœ¬èŠ‚å°†åŒ…å«ä»¥ä¸‹å°èŠ‚ï¼š go-zeroè®¾è®¡ç†å¿µ go-zeroç‰¹ç‚¹ apiè¯­æ³•ä»‹ç» apiç›®å½•ç»“æ„ rpcç›®å½•ç»“æ„ Copyright Â© 2019-2021 go-zero all right reservedï¼Œpowered by GitbookLast UpdateTimeï¼š 2025-05-05 05:44:52 "},"go-zero-design.html":{"url":"go-zero-design.html","title":"go-zeroè®¾è®¡ç†å¿µ","keywords":"","body":"go-zeroè®¾è®¡ç†å¿µ å¯¹äºå¾®æœåŠ¡æ¡†æ¶çš„è®¾è®¡ï¼Œæˆ‘ä»¬æœŸæœ›ä¿éšœå¾®æœåŠ¡ç¨³å®šæ€§çš„åŒæ—¶ï¼Œä¹Ÿè¦ç‰¹åˆ«æ³¨é‡ç ”å‘æ•ˆç‡ã€‚æ‰€ä»¥è®¾è®¡ä¹‹åˆï¼Œæˆ‘ä»¬å°±æœ‰å¦‚ä¸‹ä¸€äº›å‡†åˆ™ï¼š ä¿æŒç®€å•ï¼Œç¬¬ä¸€åŸåˆ™ å¼¹æ€§è®¾è®¡ï¼Œé¢å‘æ•…éšœç¼–ç¨‹ å·¥å…·å¤§äºçº¦å®šå’Œæ–‡æ¡£ é«˜å¯ç”¨ é«˜å¹¶å‘ æ˜“æ‰©å±• å¯¹ä¸šåŠ¡å¼€å‘å‹å¥½ï¼Œå°è£…å¤æ‚åº¦ çº¦æŸåšä¸€ä»¶äº‹åªæœ‰ä¸€ç§æ–¹å¼ Copyright Â© 2019-2021 go-zero all right reservedï¼Œpowered by GitbookLast UpdateTimeï¼š 2025-05-05 05:44:52 "},"go-zero-features.html":{"url":"go-zero-features.html","title":"go-zeroç‰¹ç‚¹","keywords":"","body":"go-zeroç‰¹æ€§ go-zero æ˜¯ä¸€ä¸ªé›†æˆäº†å„ç§å·¥ç¨‹å®è·µçš„åŒ…å« web å’Œ rpc æ¡†æ¶ï¼Œæœ‰å¦‚ä¸‹ä¸»è¦ç‰¹ç‚¹ï¼š å¼ºå¤§çš„å·¥å…·æ”¯æŒï¼Œå°½å¯èƒ½å°‘çš„ä»£ç ç¼–å†™ æç®€çš„æ¥å£ å®Œå…¨å…¼å®¹ net/http æ”¯æŒä¸­é—´ä»¶ï¼Œæ–¹ä¾¿æ‰©å±• é«˜æ€§èƒ½ é¢å‘æ•…éšœç¼–ç¨‹ï¼Œå¼¹æ€§è®¾è®¡ å†…å»ºæœåŠ¡å‘ç°ã€è´Ÿè½½å‡è¡¡ å†…å»ºé™æµã€ç†”æ–­ã€é™è½½ï¼Œä¸”è‡ªåŠ¨è§¦å‘ï¼Œè‡ªåŠ¨æ¢å¤ API å‚æ•°è‡ªåŠ¨æ ¡éªŒ è¶…æ—¶çº§è”æ§åˆ¶ è‡ªåŠ¨ç¼“å­˜æ§åˆ¶ é“¾è·¯è·Ÿè¸ªã€ç»Ÿè®¡æŠ¥è­¦ç­‰ é«˜å¹¶å‘æ”¯æ’‘ï¼Œç¨³å®šä¿éšœäº†ç–«æƒ…æœŸé—´æ¯å¤©çš„æµé‡æ´ªå³° å¦‚ä¸‹å›¾ï¼Œæˆ‘ä»¬ä»å¤šä¸ªå±‚é¢ä¿éšœäº†æ•´ä½“æœåŠ¡çš„é«˜å¯ç”¨ï¼š Copyright Â© 2019-2021 go-zero all right reservedï¼Œpowered by GitbookLast UpdateTimeï¼š 2025-05-05 05:44:52 "},"api-grammar.html":{"url":"api-grammar.html","title":"apiè¯­æ³•ä»‹ç»","keywords":"","body":"apiè¯­æ³•ä»‹ç» apiç¤ºä¾‹ /** * apiè¯­æ³•ç¤ºä¾‹åŠè¯­æ³•è¯´æ˜ */ // apiè¯­æ³•ç‰ˆæœ¬ syntax = \"v1\" // import literal import \"foo.api\" // import group import ( \"bar.api\" \"foo/bar.api\" ) info( author: \"songmeizi\" date: \"2020-01-08\" desc: \"apiè¯­æ³•ç¤ºä¾‹åŠè¯­æ³•è¯´æ˜\" ) // type literal type Foo{ Foo int `json:\"foo\"` } // type group type( Bar{ Bar int `json:\"bar\"` } ) // service block @server( jwt: Auth group: foo ) service foo-api{ @doc \"foo\" @handler foo post /foo (Foo) returns (Bar) } apiè¯­æ³•ç»“æ„ syntaxè¯­æ³•å£°æ˜ importè¯­æ³•å— infoè¯­æ³•å— typeè¯­æ³•å— serviceè¯­æ³•å— éšè—é€šé“ [!TIP] åœ¨ä»¥ä¸Šè¯­æ³•ç»“æ„ä¸­ï¼Œå„ä¸ªè¯­æ³•å—ä»è¯­æ³•ä¸Šæ¥è¯´ï¼ŒæŒ‰ç…§è¯­æ³•å—ä¸ºå•ä½ï¼Œå¯ä»¥åœ¨.apiæ–‡ä»¶ä¸­ä»»æ„ä½ç½®å£°æ˜ï¼Œ ä½†æ˜¯ä¸ºäº†æé«˜é˜…è¯»æ•ˆç‡ï¼Œæˆ‘ä»¬å»ºè®®æŒ‰ç…§ä»¥ä¸Šé¡ºåºè¿›è¡Œå£°æ˜ï¼Œå› ä¸ºåœ¨å°†æ¥å¯èƒ½ä¼šé€šè¿‡ä¸¥æ ¼æ¨¡å¼æ¥æ§åˆ¶è¯­æ³•å—çš„é¡ºåºã€‚ syntaxè¯­æ³•å£°æ˜ syntaxæ˜¯æ–°åŠ å…¥çš„è¯­æ³•ç»“æ„ï¼Œè¯¥è¯­æ³•çš„å¼•å…¥å¯ä»¥è§£å†³ï¼š å¿«é€Ÿé’ˆå¯¹apiç‰ˆæœ¬å®šä½å­˜åœ¨é—®é¢˜çš„è¯­æ³•ç»“æ„ é’ˆå¯¹ç‰ˆæœ¬åšè¯­æ³•è§£æ é˜²æ­¢apiè¯­æ³•å¤§ç‰ˆæœ¬å‡çº§å¯¼è‡´å‰åä¸èƒ½å‘å‰å…¼å®¹ **[!WARNING] è¢«importçš„apiå¿…é¡»è¦å’Œmain apiçš„syntaxç‰ˆæœ¬ä¸€è‡´ã€‚ è¯­æ³•å®šä¹‰ 'syntax'={checkVersion(p)}STRING è¯­æ³•è¯´æ˜ syntaxï¼šå›ºå®štokenï¼Œæ ‡å¿—ä¸€ä¸ªsyntaxè¯­æ³•ç»“æ„çš„å¼€å§‹ checkVersionï¼šè‡ªå®šä¹‰goæ–¹æ³•ï¼Œæ£€æµ‹STRINGæ˜¯å¦ä¸ºä¸€ä¸ªåˆæ³•çš„ç‰ˆæœ¬å·ï¼Œç›®å‰æ£€æµ‹é€»è¾‘ä¸ºï¼ŒSTRINGå¿…é¡»æ˜¯æ»¡è¶³(?m)\"v[1-9][0-9]*\"æ­£åˆ™ã€‚ STRINGï¼šä¸€ä¸²è‹±æ–‡åŒå¼•å·åŒ…è£¹çš„å­—ç¬¦ä¸²ï¼Œå¦‚\"v1\" ä¸€ä¸ªapiè¯­æ³•æ–‡ä»¶åªèƒ½æœ‰0æˆ–è€…1ä¸ªsyntaxè¯­æ³•å£°æ˜ï¼Œå¦‚æœæ²¡æœ‰syntaxï¼Œåˆ™é»˜è®¤ä¸ºv1ç‰ˆæœ¬ æ­£ç¡®è¯­æ³•ç¤ºä¾‹ âœ… eg1ï¼šä¸è§„èŒƒå†™æ³• syntax=\"v1\" eg2ï¼šè§„èŒƒå†™æ³•(æ¨è) syntax = \"v2\" é”™è¯¯è¯­æ³•ç¤ºä¾‹ âŒ eg1ï¼š syntax = \"v0\" eg2ï¼š syntax = v1 eg3ï¼š syntax = \"V1\" importè¯­æ³•å— éšç€ä¸šåŠ¡è§„æ¨¡å¢å¤§ï¼Œapiä¸­å®šä¹‰çš„ç»“æ„ä½“å’ŒæœåŠ¡è¶Šæ¥è¶Šå¤šï¼Œæ‰€æœ‰çš„è¯­æ³•æè¿°å‡ä¸ºä¸€ä¸ªapiæ–‡ä»¶ï¼Œè¿™æ˜¯å¤šä¹ˆç³Ÿç³•çš„ä¸€ä¸ªé—®é¢˜ï¼Œ å…¶ä¼šå¤§å¤§å¢åŠ äº†é˜…è¯»éš¾åº¦å’Œç»´æŠ¤éš¾åº¦ï¼Œimportè¯­æ³•å—å¯ä»¥å¸®åŠ©æˆ‘ä»¬è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œé€šè¿‡æ‹†åˆ†apiæ–‡ä»¶ï¼Œ ä¸åŒçš„apiæ–‡ä»¶æŒ‰ç…§ä¸€å®šè§„åˆ™å£°æ˜ï¼Œå¯ä»¥é™ä½é˜…è¯»éš¾åº¦å’Œç»´æŠ¤éš¾åº¦ã€‚ **[!WARNING] è¿™é‡Œimportä¸åƒgolangé‚£æ ·åŒ…å«packageå£°æ˜ï¼Œä»…ä»…æ˜¯ä¸€ä¸ªæ–‡ä»¶è·¯å¾„çš„å¼•å…¥ï¼Œæœ€ç»ˆè§£æåä¼šæŠŠæ‰€æœ‰çš„å£°æ˜éƒ½æ±‡èšåˆ°ä¸€ä¸ªspec.Specä¸­ã€‚ ä¸èƒ½importå¤šä¸ªç›¸åŒè·¯å¾„ï¼Œå¦åˆ™ä¼šè§£æé”™è¯¯ã€‚ è¯­æ³•å®šä¹‰ 'import' {checkImportValue(p)}STRING |'import' '(' ({checkImportValue(p)}STRING)+ ')' è¯­æ³•è¯´æ˜ importï¼šå›ºå®štokenï¼Œæ ‡å¿—ä¸€ä¸ªimportè¯­æ³•çš„å¼€å§‹ checkImportValueï¼šè‡ªå®šä¹‰goæ–¹æ³•ï¼Œæ£€æµ‹STRINGæ˜¯å¦ä¸ºä¸€ä¸ªåˆæ³•çš„æ–‡ä»¶è·¯å¾„ï¼Œç›®å‰æ£€æµ‹é€»è¾‘ä¸ºï¼ŒSTRINGå¿…é¡»æ˜¯æ»¡è¶³(?m)\"(/?[a-zA-Z0-9_#-])+\\.api\"æ­£åˆ™ã€‚ STRINGï¼šä¸€ä¸²è‹±æ–‡åŒå¼•å·åŒ…è£¹çš„å­—ç¬¦ä¸²ï¼Œå¦‚\"foo.api\" æ­£ç¡®è¯­æ³•ç¤ºä¾‹ âœ… egï¼š import \"foo.api\" import \"foo/bar.api\" import( \"bar.api\" \"foo/bar/foo.api\" ) é”™è¯¯è¯­æ³•ç¤ºä¾‹ âŒ egï¼š import foo.api import \"foo.txt\" import ( bar.api bar.api ) infoè¯­æ³•å— infoè¯­æ³•å—æ˜¯ä¸€ä¸ªåŒ…å«äº†å¤šä¸ªé”®å€¼å¯¹çš„è¯­æ³•ä½“ï¼Œå…¶ä½œç”¨ç›¸å½“äºä¸€ä¸ªapiæœåŠ¡çš„æè¿°ï¼Œè§£æå™¨ä¼šå°†å…¶æ˜ å°„åˆ°spec.Specä¸­ï¼Œ ä»¥å¤‡ç”¨äºç¿»è¯‘æˆå…¶ä»–è¯­è¨€(golangã€javaç­‰) æ—¶éœ€è¦æºå¸¦çš„metaå…ƒç´ ã€‚å¦‚æœä»…ä»…æ˜¯å¯¹å½“å‰apiçš„ä¸€ä¸ªè¯´æ˜ï¼Œè€Œä¸è€ƒè™‘å…¶ç¿»è¯‘ æ—¶ä¼ é€’åˆ°å…¶ä»–è¯­è¨€ï¼Œåˆ™ä½¿ç”¨ç®€å•çš„å¤šè¡Œæ³¨é‡Šæˆ–è€…javaé£æ ¼çš„æ–‡æ¡£æ³¨é‡Šå³å¯ï¼Œå…³äºæ³¨é‡Šè¯´æ˜è¯·å‚è€ƒä¸‹æ–‡çš„ éšè—é€šé“ã€‚ **[!WARNING] ä¸èƒ½ä½¿ç”¨é‡å¤çš„keyï¼Œæ¯ä¸ªapiæ–‡ä»¶åªèƒ½æœ‰0æˆ–è€…1ä¸ªinfoè¯­æ³•å— è¯­æ³•å®šä¹‰ 'info' '(' (ID {checkKeyValue(p)}VALUE)+ ')' è¯­æ³•è¯´æ˜ infoï¼šå›ºå®štokenï¼Œæ ‡å¿—ä¸€ä¸ªinfoè¯­æ³•å—çš„å¼€å§‹ checkKeyValueï¼šè‡ªå®šä¹‰goæ–¹æ³•ï¼Œæ£€æµ‹VALUEæ˜¯å¦ä¸ºä¸€ä¸ªåˆæ³•å€¼ã€‚ VALUEï¼škeyå¯¹åº”çš„å€¼ï¼Œå¯ä»¥ä¸ºå•è¡Œçš„é™¤'\\r','\\n','/'åçš„ä»»æ„å­—ç¬¦ï¼Œå¤šè¡Œè¯·ä»¥\"\"åŒ…è£¹ï¼Œä¸è¿‡å¼ºçƒˆå»ºè®®æ‰€æœ‰éƒ½ä»¥\"\"åŒ…è£¹ æ­£ç¡®è¯­æ³•ç¤ºä¾‹ âœ… eg1ï¼šä¸è§„èŒƒå†™æ³• info( foo: foo value bar:\"bar value\" desc:\"long long long long long long text\" ) eg2ï¼šè§„èŒƒå†™æ³•(æ¨è) info( foo: \"foo value\" bar: \"bar value\" desc: \"long long long long long long text\" ) é”™è¯¯è¯­æ³•ç¤ºä¾‹ âŒ eg1ï¼šæ²¡æœ‰key-valueå†…å®¹ info() eg2ï¼šä¸åŒ…å«å†’å· info( foo value ) eg3ï¼škey-valueæ²¡æœ‰æ¢è¡Œ info(foo:\"value\") eg4ï¼šæ²¡æœ‰key info( : \"value\" ) eg5ï¼šéæ³•çš„key info( 12: \"value\" ) eg6ï¼šç§»é™¤æ—§ç‰ˆæœ¬å¤šè¡Œè¯­æ³• info( foo: > some text typeè¯­æ³•å— åœ¨apiæœåŠ¡ä¸­ï¼Œæˆ‘ä»¬éœ€è¦ç”¨åˆ°ä¸€ä¸ªç»“æ„ä½“(ç±»)æ¥ä½œä¸ºè¯·æ±‚ä½“ï¼Œå“åº”ä½“çš„è½½ä½“ï¼Œå› æ­¤æˆ‘ä»¬éœ€è¦å£°æ˜ä¸€äº›ç»“æ„ä½“æ¥å®Œæˆè¿™ä»¶äº‹æƒ…ï¼Œ typeè¯­æ³•å—ç”±golangçš„typeæ¼”å˜è€Œæ¥ï¼Œå½“ç„¶ä¹Ÿä¿ç•™ç€ä¸€äº›golang typeçš„ç‰¹æ€§ï¼Œæ²¿ç”¨golangç‰¹æ€§æœ‰ï¼š ä¿ç•™äº†golangå†…ç½®æ•°æ®ç±»å‹bool,int,int8,int16,int32,int64,uint,uint8,uint16,uint32,uint64,uintptr ,float32,float64,complex64,complex128,string,byte,rune, å…¼å®¹golang structé£æ ¼å£°æ˜ ä¿ç•™golangå…³é”®å­— **[!WARNING]ï¸ ä¸æ”¯æŒalias ä¸æ”¯æŒtime.Timeæ•°æ®ç±»å‹ï¼Œç”¨int64è¡¨ç¤ºï¼Œå› ä¸ºapiæ”¯æŒå®¢æˆ·ç«¯ä»£ç ç”Ÿæˆï¼Œå¹¶éæ‰€æœ‰å®¢æˆ·ç«¯è¯­è¨€éƒ½æœ‰time.Timeå¯¹åº”çš„ç±»å‹ ç»“æ„ä½“åç§°ã€å­—æ®µåç§°ã€ä¸èƒ½ä¸ºgolangå…³é”®å­— è¯­æ³•å®šä¹‰ ç”±äºå…¶å’Œgolangç›¸ä¼¼ï¼Œå› æ­¤ä¸åšè¯¦ç»†è¯´æ˜ï¼Œå…·ä½“è¯­æ³•å®šä¹‰è¯·åœ¨ ApiParser.g4 ä¸­æŸ¥çœ‹typeSpecå®šä¹‰ã€‚ è¯­æ³•è¯´æ˜ å‚è€ƒgolangå†™æ³• æ­£ç¡®è¯­æ³•ç¤ºä¾‹ âœ… eg1ï¼šä¸è§„èŒƒå†™æ³• type Foo struct{ Id int `path:\"id\"` // â‘  Foo int `json:\"foo\"` } type Bar struct{ // éå¯¼å‡ºå‹å­—æ®µ bar int `form:\"bar\"` } type( // éå¯¼å‡ºå‹ç»“æ„ä½“ fooBar struct{ FooBar int `json:\"fooBar\"` } ) eg2ï¼šè§„èŒƒå†™æ³•ï¼ˆæ¨èï¼‰ type Foo{ Id int `path:\"id\"` Foo int `json:\"foo\"` } type Bar{ Bar int `form:\"bar\"` } type( FooBar{ FooBar int `json:\"fooBar\"` } ) é”™è¯¯è¯­æ³•ç¤ºä¾‹ âŒ eg type Gender int // ä¸æ”¯æŒ // éstruct token type Foo structure{ CreateTime time.Time // ä¸æ”¯æŒtime.Timeï¼Œä¸”æ²¡æœ‰å£°æ˜ tag } // golangå…³é”®å­— var type var{} type Foo{ // golangå…³é”®å­— interface Foo interface // æ²¡æœ‰å£°æ˜ tag } type Foo{ foo int // map keyå¿…é¡»è¦golangå†…ç½®æ•°æ®ç±»å‹ï¼Œä¸”æ²¡æœ‰å£°æ˜ tag m map[Bar]string } [!NOTE] â‘  tagå®šä¹‰å’Œgolangä¸­json tagè¯­æ³•ä¸€æ ·ï¼Œé™¤äº†json tagå¤–ï¼Œgo-zeroè¿˜æä¾›äº†å¦å¤–ä¸€äº›tagæ¥å®ç°å¯¹å­—æ®µçš„æè¿°ï¼Œ è¯¦æƒ…è§ä¸‹è¡¨ã€‚ tagè¡¨ ç»‘å®šå‚æ•°æ—¶ï¼Œä»¥ä¸‹å››ä¸ªtagåªèƒ½é€‰æ‹©å…¶ä¸­ä¸€ä¸ª tag key æè¿° æä¾›æ–¹æœ‰æ•ˆèŒƒå›´ ç¤ºä¾‹ json jsonåºåˆ—åŒ–tag golang requestã€response json:\"fooo\" path è·¯ç”±pathï¼Œå¦‚/foo/:id go-zero request path:\"id\" form æ ‡å¿—è¯·æ±‚ä½“æ˜¯ä¸€ä¸ªformï¼ˆPOSTæ–¹æ³•æ—¶ï¼‰æˆ–è€…ä¸€ä¸ªquery(GETæ–¹æ³•æ—¶/search?name=keyword) go-zero request form:\"name\" header HTTP headerï¼Œå¦‚ Name: value go-zero request header:\"name\" tagä¿®é¥°ç¬¦ å¸¸è§å‚æ•°æ ¡éªŒæè¿° tag key æè¿° æä¾›æ–¹ æœ‰æ•ˆèŒƒå›´ ç¤ºä¾‹ optional å®šä¹‰å½“å‰å­—æ®µä¸ºå¯é€‰å‚æ•° go-zero request json:\"name,optional\" options å®šä¹‰å½“å‰å­—æ®µçš„æšä¸¾å€¼,å¤šä¸ªä»¥ç«–çº¿|éš”å¼€ go-zero request json:\"gender,options=male\" default å®šä¹‰å½“å‰å­—æ®µé»˜è®¤å€¼ go-zero request json:\"gender,default=male\" range å®šä¹‰å½“å‰å­—æ®µæ•°å€¼èŒƒå›´ go-zero request json:\"age,range=[0:120]\" [!TIP] tagä¿®é¥°ç¬¦éœ€è¦åœ¨tag valueåä»¥è‹±æ–‡é€—å·,éš”å¼€ serviceè¯­æ³•å— serviceè¯­æ³•å—ç”¨äºå®šä¹‰apiæœåŠ¡ï¼ŒåŒ…å«æœåŠ¡åç§°ï¼ŒæœåŠ¡metadataï¼Œä¸­é—´ä»¶å£°æ˜ï¼Œè·¯ç”±ï¼Œhandlerç­‰ã€‚ **[!WARNING]ï¸ main apiå’Œè¢«importçš„apiæœåŠ¡åç§°å¿…é¡»ä¸€è‡´ï¼Œä¸èƒ½å‡ºç°æœåŠ¡åç§°æ­§ä¹‰ã€‚ handleråç§°ä¸èƒ½é‡å¤ è·¯ç”±ï¼ˆè¯·æ±‚æ–¹æ³•+è¯·æ±‚pathï¼‰åç§°ä¸èƒ½é‡å¤ è¯·æ±‚ä½“å¿…é¡»å£°æ˜ä¸ºæ™®é€šï¼ˆéæŒ‡é’ˆï¼‰structï¼Œå“åº”ä½“åšäº†ä¸€äº›å‘å‰å…¼å®¹å¤„ç†ï¼Œè¯¦è¯·è§ä¸‹æ–‡è¯´æ˜ è¯­æ³•å®šä¹‰ serviceSpec: atServer? serviceApi; atServer: '@server' lp='(' kvLit+ rp=')'; serviceApi: {match(p,\"service\")}serviceToken=ID serviceName lbrace='{' serviceRoute* rbrace='}'; serviceRoute: atDoc? (atServer|atHandler) route; atDoc: '@doc' lp='('? ((kvLit+)|STRING) rp=')'?; atHandler: '@handler' ID; route: {checkHttpMethod(p)}httpMethod=ID path request=body? returnToken=ID? response=replybody?; body: lp='(' (ID)? rp=')'; replybody: lp='(' dataType? rp=')'; // kv kvLit: key=ID {checkKeyValue(p)}value=LINE_VALUE; serviceName: (ID '-'?)+; path: (('/' (ID ('-' ID)*))|('/:' (ID ('-' ID)?)))+; è¯­æ³•è¯´æ˜ serviceSpecï¼šåŒ…å«äº†ä¸€ä¸ªå¯é€‰è¯­æ³•å—atServerå’ŒserviceApiè¯­æ³•å—ï¼Œå…¶éµå¾ªåºåˆ—æ¨¡å¼ï¼ˆç¼–å†™serviceå¿…é¡»è¦æŒ‰ç…§é¡ºåºï¼Œå¦åˆ™ä¼šè§£æå‡ºé”™ï¼‰ atServerï¼š å¯é€‰è¯­æ³•å—ï¼Œå®šä¹‰key-valueç»“æ„çš„server metadataï¼Œ'@server' è¡¨ç¤ºè¿™ä¸€ä¸ªserverè¯­æ³•å—çš„å¼€å§‹ï¼Œå…¶å¯ä»¥ç”¨äºæè¿°serviceApiæˆ–è€…routeè¯­æ³•å—ï¼Œå…¶ç”¨äºæè¿°ä¸åŒè¯­æ³•å—æ—¶æœ‰ä¸€äº›ç‰¹æ®Šå…³é”®key éœ€è¦å€¼å¾—æ³¨æ„ï¼Œè§ atServerå…³é”®keyæè¿°è¯´æ˜ã€‚ serviceApiï¼šåŒ…å«äº†1åˆ°å¤šä¸ªserviceRouteè¯­æ³•å— serviceRouteï¼šæŒ‰ç…§åºåˆ—æ¨¡å¼åŒ…å«äº†atDoc,handlerå’Œroute atDocï¼šå¯é€‰è¯­æ³•å—ï¼Œä¸€ä¸ªè·¯ç”±çš„key-valueæè¿°ï¼Œå…¶åœ¨è§£æåä¼šä¼ é€’åˆ°spec.Specç»“æ„ä½“ï¼Œå¦‚æœä¸å…³å¿ƒä¼ é€’åˆ°spec.Spec, æ¨èç”¨å•è¡Œæ³¨é‡Šæ›¿ä»£ã€‚ handlerï¼šæ˜¯å¯¹è·¯ç”±çš„handlerå±‚æè¿°ï¼Œå¯ä»¥é€šè¿‡atServeræŒ‡å®šhandler keyæ¥æŒ‡å®šhandleråç§°ï¼Œ ä¹Ÿå¯ä»¥ç›´æ¥ç”¨atHandlerè¯­æ³•å—æ¥å®šä¹‰handleråç§° atHandlerï¼š'@handler' å›ºå®štokenï¼Œåæ¥ä¸€ä¸ªéµå¾ªæ­£åˆ™[_a-zA-Z][a-zA-Z_-]*)çš„å€¼ï¼Œç”¨äºå£°æ˜ä¸€ä¸ªhandleråç§° routeï¼šè·¯ç”±ï¼Œæœ‰httpMethodã€pathã€å¯é€‰requestã€å¯é€‰responseç»„æˆï¼ŒhttpMethodæ˜¯å¿…é¡»æ˜¯å°å†™ã€‚ bodyï¼šapiè¯·æ±‚ä½“è¯­æ³•å®šä¹‰ï¼Œå¿…é¡»è¦ç”±()åŒ…è£¹çš„å¯é€‰çš„IDå€¼ replyBodyï¼šapiå“åº”ä½“è¯­æ³•å®šä¹‰ï¼Œå¿…é¡»ç”±()åŒ…è£¹çš„structã€array(å‘å‰å…¼å®¹å¤„ç†ï¼Œåç»­å¯èƒ½ä¼šåºŸå¼ƒï¼Œå¼ºçƒˆæ¨èä»¥structåŒ…è£¹ï¼Œä¸è¦ç›´æ¥ç”¨arrayä½œä¸ºå“åº”ä½“) kvLitï¼š åŒinfo key-value serviceName: å¯ä»¥æœ‰å¤šä¸ª'-'joinçš„IDå€¼ pathï¼šapiè¯·æ±‚è·¯å¾„ï¼Œå¿…é¡»ä»¥'/'æˆ–è€…'/:'å¼€å¤´ï¼Œåˆ‡ä¸èƒ½ä»¥'/'ç»“å°¾ï¼Œä¸­é—´å¯åŒ…å«IDæˆ–è€…å¤šä¸ªä»¥'-'joinçš„IDå­—ç¬¦ä¸² atServerå…³é”®keyæè¿°è¯´æ˜ ä¿®é¥°serviceæ—¶ keyæè¿°ç¤ºä¾‹ jwtå£°æ˜å½“å‰serviceä¸‹æ‰€æœ‰è·¯ç”±éœ€è¦jwté‰´æƒï¼Œä¸”ä¼šè‡ªåŠ¨ç”ŸæˆåŒ…å«jwté€»è¾‘çš„ä»£ç jwt: Auth groupå£°æ˜å½“å‰serviceæˆ–è€…è·¯ç”±æ–‡ä»¶åˆ†ç»„group: login middlewareå£°æ˜å½“å‰serviceéœ€è¦å¼€å¯ä¸­é—´ä»¶middleware: AuthMiddleware prefixæ·»åŠ è·¯ç”±åˆ†ç»„prefix: api ä¿®é¥°routeæ—¶ keyæè¿°ç¤ºä¾‹ handlerå£°æ˜ä¸€ä¸ªhandler- æ­£ç¡®è¯­æ³•ç¤ºä¾‹ âœ… eg1ï¼šä¸è§„èŒƒå†™æ³• @server( jwt: Auth group: foo middleware: AuthMiddleware prefix api ) service foo-api{ @doc( summary: foo ) @server( handler: foo ) // éå¯¼å‡ºå‹body post /foo/:id (foo) returns (bar) @doc \"bar\" @handler bar post /bar returns ([]int)// ä¸æ¨èæ•°ç»„ä½œä¸ºå“åº”ä½“ @handler fooBar post /foo/bar (Foo) returns // å¯ä»¥çœç•¥'returns' } eg2ï¼šè§„èŒƒå†™æ³•ï¼ˆæ¨èï¼‰ @server( jwt: Auth group: foo middleware: AuthMiddleware prefix: api ) service foo-api{ @doc \"foo\" @handler foo post /foo/:id (Foo) returns (Bar) } service foo-api{ @handler ping get /ping @doc \"foo\" @handler bar post /bar/:id (Foo) } é”™è¯¯è¯­æ³•ç¤ºä¾‹ âŒ // ä¸æ”¯æŒç©ºçš„serverè¯­æ³•å— @server( ) // ä¸æ”¯æŒç©ºçš„serviceè¯­æ³•å— service foo-api{ } service foo-api{ @doc kkkk // ç®€ç‰ˆdocå¿…é¡»ç”¨è‹±æ–‡åŒå¼•å·å¼•èµ·æ¥ @handler foo post /foo @handler foo // é‡å¤çš„handler post /bar @handler fooBar post /bar // é‡å¤çš„è·¯ç”± // @handlerå’Œ@docé¡ºåºé”™è¯¯ @handler someHandler @doc \"some doc\" post /some/path // handlerç¼ºå¤± post /some/path/:id @handler reqTest post /foo/req (*Foo) // ä¸æ”¯æŒé™¤æ™®é€šç»“æ„ä½“å¤–çš„å…¶ä»–æ•°æ®ç±»å‹ä½œä¸ºè¯·æ±‚ä½“ @handler replyTest post /foo/reply returns (*Foo) // ä¸æ”¯æŒé™¤æ™®é€šç»“æ„ä½“ã€æ•°ç»„(å‘å‰å…¼å®¹ï¼Œåç»­è€ƒè™‘åºŸå¼ƒ)å¤–çš„å…¶ä»–æ•°æ®ç±»å‹ä½œä¸ºå“åº”ä½“ } éšè—é€šé“ éšè—é€šé“ç›®å‰ä¸»è¦ä¸ºç©ºç™½ç¬¦å·ã€æ¢è¡Œç¬¦å·ä»¥åŠæ³¨é‡Šï¼Œè¿™é‡Œæˆ‘ä»¬åªè¯´æ³¨é‡Šï¼Œå› ä¸ºç©ºç™½ç¬¦å·å’Œæ¢è¡Œç¬¦å·æˆ‘ä»¬ç›®å‰æ‹¿æ¥ä¹Ÿæ— ç”¨ã€‚ å•è¡Œæ³¨é‡Š è¯­æ³•å®šä¹‰ '//' ~[\\r\\n]* è¯­æ³•è¯´æ˜ ç”±è¯­æ³•å®šä¹‰å¯çŸ¥é“ï¼Œå•è¡Œæ³¨é‡Šå¿…é¡»è¦ä»¥//å¼€å¤´ï¼Œå†…å®¹ä¸ºä¸èƒ½åŒ…å«æ¢è¡Œç¬¦ æ­£ç¡®è¯­æ³•ç¤ºä¾‹ âœ… // doc // comment é”™è¯¯è¯­æ³•ç¤ºä¾‹ âŒ // break line comments javaé£æ ¼æ–‡æ¡£æ³¨é‡Š è¯­æ³•å®šä¹‰ '/*' .*? '*/' è¯­æ³•è¯´æ˜ ç”±è¯­æ³•å®šä¹‰å¯çŸ¥é“ï¼Œå•è¡Œæ³¨é‡Šå¿…é¡»è¦ä»¥/*å¼€å¤´ï¼Œ*/ç»“å°¾çš„ä»»æ„å­—ç¬¦ã€‚ æ­£ç¡®è¯­æ³•ç¤ºä¾‹ âœ… /** * java-style doc */ é”™è¯¯è¯­æ³•ç¤ºä¾‹ âŒ /* * java-style doc */ */ Doc&Comment å¦‚æœæƒ³è·å–æŸä¸€ä¸ªå…ƒç´ çš„docæˆ–è€…commentå¼€å‘äººå‘˜éœ€è¦æ€ä¹ˆå®šä¹‰ï¼Ÿ Doc æˆ‘ä»¬è§„å®šä¸Šä¸€ä¸ªè¯­æ³•å—ï¼ˆééšè—é€šé“å†…å®¹ï¼‰çš„è¡Œæ•°line+1åˆ°å½“å‰è¯­æ³•å—ç¬¬ä¸€ä¸ªå…ƒç´ å‰çš„æ‰€æœ‰æ³¨é‡Š(å•è¡Œï¼Œæˆ–è€…å¤šè¡Œ)å‡ä¸ºdocï¼Œ ä¸”ä¿ç•™äº†//ã€/*ã€*/åŸå§‹æ ‡è®°ã€‚ Comment æˆ‘ä»¬è§„å®šå½“å‰è¯­æ³•å—æœ€åä¸€ä¸ªå…ƒç´ æ‰€åœ¨è¡Œå¼€å§‹çš„ä¸€ä¸ªæ³¨é‡Šå—(å½“è¡Œï¼Œæˆ–è€…å¤šè¡Œ)ä¸ºcomment ä¸”ä¿ç•™äº†//ã€/*ã€*/åŸå§‹æ ‡è®°ã€‚ è¯­æ³•å—Docå’ŒCommentçš„æ”¯æŒæƒ…å†µ è¯­æ³•å—parentè¯­æ³•å—DocComment syntaxLitapiâœ…âœ… kvLitinfoSpecâœ…âœ… importLitimportSpecâœ…âœ… typeLitapiâœ…âŒ typeLittypeBlockâœ…âŒ fieldtypeLitâœ…âœ… key-valueatServerâœ…âœ… atHandlerserviceRouteâœ…âœ… routeserviceRouteâœ…âœ… ä»¥ä¸‹ä¸ºå¯¹åº”è¯­æ³•å—è§£æåç»†å¸¦docå’Œcommentçš„å†™æ³• // syntaxLit doc syntax = \"v1\" // syntaxLit commnet info( // kvLit doc author: songmeizi // kvLit comment ) // typeLit doc type Foo {} type( // typeLit doc Bar{} FooBar{ // filed doc Name int // filed comment } ) @server( /** * kvLit doc * å¼€å¯jwté‰´æƒ */ jwt: Auth /**kvLit comment*/ ) service foo-api{ // atHandler doc @handler foo //atHandler comment /* * route doc * postè¯·æ±‚ * pathä¸º /foo * è¯·æ±‚ä½“ï¼šFoo * å“åº”ä½“ï¼šFoo */ post /foo (Foo) returns (Foo) // route comment } Copyright Â© 2019-2021 go-zero all right reservedï¼Œpowered by GitbookLast UpdateTimeï¼š 2025-05-05 05:44:52 "},"api-dir.html":{"url":"api-dir.html","title":"apiç›®å½•ç»“æ„","keywords":"","body":"apiç›®å½•ä»‹ç» . â”œâ”€â”€ etc â”‚ â””â”€â”€ greet-api.yaml // é…ç½®æ–‡ä»¶ â”œâ”€â”€ go.mod // modæ–‡ä»¶ â”œâ”€â”€ greet.api // apiæè¿°æ–‡ä»¶ â”œâ”€â”€ greet.go // mainå‡½æ•°å…¥å£ â””â”€â”€ internal â”œâ”€â”€ config â”‚ â””â”€â”€ config.go // é…ç½®å£°æ˜type â”œâ”€â”€ handler // è·¯ç”±åŠhandlerè½¬å‘ â”‚ â”œâ”€â”€ greethandler.go â”‚ â””â”€â”€ routes.go â”œâ”€â”€ logic // ä¸šåŠ¡é€»è¾‘ â”‚ â””â”€â”€ greetlogic.go â”œâ”€â”€ middleware // ä¸­é—´ä»¶æ–‡ä»¶ â”‚ â””â”€â”€ greetmiddleware.go â”œâ”€â”€ svc // logicæ‰€ä¾èµ–çš„èµ„æºæ±  â”‚ â””â”€â”€ servicecontext.go â””â”€â”€ types // requestã€responseçš„structï¼Œæ ¹æ®apiè‡ªåŠ¨ç”Ÿæˆï¼Œä¸å»ºè®®ç¼–è¾‘ â””â”€â”€ types.go Copyright Â© 2019-2021 go-zero all right reservedï¼Œpowered by GitbookLast UpdateTimeï¼š 2025-05-05 05:44:52 "},"rpc-dir.html":{"url":"rpc-dir.html","title":"rpcç›®å½•ç»“æ„","keywords":"","body":"rpcæœåŠ¡ç›®å½• proto æ–‡ä»¶ greet.proto syntax = \"proto3\"; package stream; option go_package = \"./greet\"; message StreamReq { string name = 1; } message StreamResp { string greet = 1; } service StreamGreeter { rpc greet(StreamReq) returns (StreamResp); } goctl rpc proto $ goctl rpc protoc greet.proto --go_out=. --go-grpc_out=. --zrpc_out=. [goctl-env]: preparing to check env [goctl-env]: looking up \"protoc\" [goctl-env]: \"protoc\" is installed [goctl-env]: looking up \"protoc-gen-go\" [goctl-env]: \"protoc-gen-go\" is installed [goctl-env]: looking up \"protoc-gen-go-grpc\" [goctl-env]: \"protoc-gen-go-grpc\" is installed [goctl-env]: congratulations! your goctl environment is ready! [command]: protoc greet.proto --go_out=. --go-grpc_out=. Done. ç”Ÿæˆçš„ç›®å½•ç»“æ„ . â”œâ”€â”€ etc â”‚ â””â”€â”€ greet.yaml â”œâ”€â”€ go.mod â”œâ”€â”€ go.sum â”œâ”€â”€ greet // [1] â”‚ â”œâ”€â”€ greet.pb.go â”‚ â””â”€â”€ greet_grpc.pb.go â”œâ”€â”€ greet.go â”œâ”€â”€ greet.proto â”œâ”€â”€ internal â”‚ â”œâ”€â”€ config â”‚ â”‚ â””â”€â”€ config.go â”‚ â”œâ”€â”€ logic â”‚ â”‚ â””â”€â”€ greetlogic.go â”‚ â”œâ”€â”€ server â”‚ â”‚ â””â”€â”€ streamgreeterserver.go â”‚ â””â”€â”€ svc â”‚ â””â”€â”€ servicecontext.go â””â”€â”€ streamgreeter â””â”€â”€ streamgreeter.go [1] pb.go & _grpc.pb.go æ–‡ä»¶æ‰€åœ¨ç›®å½•å¹¶éå›ºå®šï¼Œè¯¥ç›®å½•æœ‰ go_opt & go-grpc_opt ä¸ protoæ–‡ä»¶ä¸­çš„ go_package å€¼å…±åŒå†³å®šï¼Œæƒ³è¦äº†è§£grpcä»£ç ç”Ÿæˆç›®å½•é€»è¾‘è¯·é˜…è¯» Go Generated Code Copyright Â© 2019-2021 go-zero all right reservedï¼Œpowered by GitbookLast UpdateTimeï¼š 2025-05-05 05:44:52 "},"project-dev.html":{"url":"project-dev.html","title":"é¡¹ç›®å¼€å‘","keywords":"","body":"é¡¹ç›®å¼€å‘ åœ¨å‰é¢çš„ç« èŠ‚æˆ‘ä»¬å·²ç»ä»ä¸€äº›æ¦‚å¿µã€èƒŒæ™¯ã€å¿«é€Ÿå…¥é—¨ç­‰ç»´åº¦ä»‹ç»äº†ä¸€ä¸‹go-zeroï¼Œçœ‹åˆ°è¿™é‡Œï¼Œç›¸ä¿¡ä½ å¯¹go-zeroå·²ç»æœ‰äº†ä¸€äº›äº†è§£ï¼Œ ä»è¿™é‡Œå¼€å§‹ï¼Œæˆ‘ä»¬å°†ä¼šä»ç¯å¢ƒå‡†å¤‡åˆ°æœåŠ¡éƒ¨ç½²æ•´ä¸ªæµç¨‹å¼€å§‹è¿›è¡Œè®²è§£ï¼Œä¸ºäº†ä¿è¯å¤§å®¶èƒ½å¤Ÿå½»åº•å¼„æ‡‚go-zeroçš„å¼€å‘æµç¨‹ï¼Œé‚£å°±å‡†å¤‡ä½ çš„è€å¿ƒæ¥æ¥ç€å¾€ä¸‹èµ°å§ã€‚ åœ¨ç« èŠ‚ä¸­ï¼Œå°†åŒ…å«ä»¥ä¸‹å°èŠ‚ï¼š å‡†å¤‡å·¥ä½œ golangå®‰è£… go modudleé…ç½® goctlå®‰è£… protoc & protoc-gen-goå®‰è£… å…¶ä»– å¼€å‘è§„èŒƒ å‘½åè§„èŒƒ è·¯ç”±è§„èŒƒ ç¼–ç è§„èŒƒ å¼€å‘æµç¨‹ é…ç½®ä»‹ç» apié…ç½® rpcé…ç½® ä¸šåŠ¡å¼€å‘ ç›®å½•æ‹†åˆ† modelç”Ÿæˆ apiæ–‡ä»¶ç¼–å†™ ä¸šåŠ¡ç¼–ç  jwté‰´æƒ ä¸­é—´ä»¶ä½¿ç”¨ rpcæœåŠ¡ç¼–å†™ä¸è°ƒç”¨ é”™è¯¯å¤„ç† CI/CD æœåŠ¡éƒ¨ç½² æ—¥å¿—æ”¶é›† é“¾è·¯è¿½è¸ª æœåŠ¡ç›‘æ§ Copyright Â© 2019-2021 go-zero all right reservedï¼Œpowered by GitbookLast UpdateTimeï¼š 2025-05-05 05:44:52 "},"prepare.html":{"url":"prepare.html","title":"å‡†å¤‡å·¥ä½œ","keywords":"","body":"å‡†å¤‡å·¥ä½œ åœ¨æ­£å¼è¿›å…¥å®é™…å¼€å‘ä¹‹å‰ï¼Œæˆ‘ä»¬éœ€è¦åšä¸€äº›å‡†å¤‡å·¥ä½œï¼Œæ¯”å¦‚ï¼šGoç¯å¢ƒçš„å®‰è£…ï¼Œgrpcä»£ç ç”Ÿæˆä½¿ç”¨çš„å·¥å…·å®‰è£…ï¼Œ å¿…å¤‡å·¥å…·Goctlçš„å®‰è£…ï¼ŒGolangç¯å¢ƒé…ç½®ç­‰ï¼Œæœ¬èŠ‚å°†åŒ…å«ä»¥ä¸‹å°èŠ‚ï¼š golangå®‰è£… go modudleé…ç½® goctlå®‰è£… protoc & protoc-gen-goå®‰è£… å…¶ä»– Copyright Â© 2019-2021 go-zero all right reservedï¼Œpowered by GitbookLast UpdateTimeï¼š 2025-05-05 05:44:52 "},"golang-install.html":{"url":"golang-install.html","title":"golangå®‰è£…","keywords":"","body":"Golangç¯å¢ƒå®‰è£… å‰è¨€ å¼€å‘golangç¨‹åºï¼Œå¿…ç„¶å°‘ä¸äº†å¯¹å…¶ç¯å¢ƒçš„å®‰è£…ï¼Œæˆ‘ä»¬è¿™é‡Œé€‰æ‹©ä»¥1.15.1ä¸ºä¾‹ã€‚ å®˜æ–¹æ–‡æ¡£ https://golang.google.cn/doc/install mac OSå®‰è£…Go ä¸‹è½½å¹¶å®‰è£…Go for Mac éªŒè¯å®‰è£…ç»“æœ $ go version go version go1.15.1 darwin/amd64 linux å®‰è£…Go ä¸‹è½½Go for Linux è§£å‹å‹ç¼©åŒ…è‡³/usr/local $ tar -C /usr/local -xzf go1.15.8.linux-amd64.tar.gz æ·»åŠ /usr/local/go/binåˆ°ç¯å¢ƒå˜é‡ $ $HOME/.profile export PATH=$PATH:/usr/local/go/bin $ source $HOME/.profile éªŒè¯å®‰è£…ç»“æœ $ go version go version go1.15.1 linux/amd64 Windowså®‰è£…Go ä¸‹è½½å¹¶å®‰è£…Go for Windows éªŒè¯å®‰è£…ç»“æœ $ go version go version go1.15.1 windows/amd64 å…¶ä»– æ›´å¤šæ“ä½œç³»ç»Ÿå®‰è£…è§https://golang.org/dl/ Copyright Â© 2019-2021 go-zero all right reservedï¼Œpowered by GitbookLast UpdateTimeï¼š 2025-05-05 05:44:52 "},"gomod-config.html":{"url":"gomod-config.html","title":"go moduleé…ç½®","keywords":"","body":"Go Moduleè®¾ç½® Go Moduleä»‹ç» Modules are how Go manages dependencies.[1] å³Go Moduleæ˜¯Golangç®¡ç†ä¾èµ–æ€§çš„æ–¹å¼ï¼ŒåƒJavaä¸­çš„Mavenï¼ŒAndroidä¸­çš„Gradleç±»ä¼¼ã€‚ MODULEé…ç½® æŸ¥çœ‹GO111MODULEå¼€å¯æƒ…å†µ $ go env GO111MODULE on å¼€å¯GO111MODULEï¼Œå¦‚æœå·²å¼€å¯ï¼ˆå³æ‰§è¡Œgo env GO111MODULEç»“æœä¸ºonï¼‰è¯·è·³è¿‡ã€‚ $ go env -w GO111MODULE=\"on\" è®¾ç½®GOPROXY $ go env -w GOPROXY=https://goproxy.cn è®¾ç½®GOMODCACHE æŸ¥çœ‹GOMODCACHE $ go env GOMODCACHE å¦‚æœç›®å½•ä¸ä¸ºç©ºæˆ–è€…/dev/nullï¼Œè¯·è·³è¿‡ã€‚ go env -w GOMODCACHE=$GOPATH/pkg/mod å‚è€ƒæ–‡æ¡£ [1] Go Modules Reference Copyright Â© 2019-2021 go-zero all right reservedï¼Œpowered by GitbookLast UpdateTimeï¼š 2025-05-05 05:44:52 "},"goctl-install.html":{"url":"goctl-install.html","title":"goctlå®‰è£…","keywords":"","body":"Goctlå®‰è£… å‰è¨€ Goctlåœ¨go-zeroé¡¹ç›®å¼€å‘ç€æœ‰ç€å¾ˆå¤§çš„ä½œç”¨ï¼Œå…¶å¯ä»¥æœ‰æ•ˆçš„å¸®åŠ©å¼€å‘è€…å¤§å¤§æé«˜å¼€å‘æ•ˆç‡ï¼Œå‡å°‘ä»£ç çš„å‡ºé”™ç‡ï¼Œç¼©çŸ­ä¸šåŠ¡å¼€å‘çš„å·¥ä½œé‡ï¼Œæ›´å¤šçš„Goctlçš„ä»‹ç»è¯·é˜…è¯»Goctlä»‹ç», åœ¨è¿™é‡Œæˆ‘ä»¬å¼ºçƒˆæ¨èå¤§å®¶å®‰è£…ï¼Œå› ä¸ºåç»­æ¼”ç¤ºä¾‹å­ä¸­æˆ‘ä»¬å¤§éƒ¨åˆ†éƒ½ä¼šä»¥goctlè¿›è¡Œæ¼”ç¤ºã€‚ å®‰è£…(mac&linux) download&install # Go 1.15 åŠä¹‹å‰ç‰ˆæœ¬ GO111MODULE=on GOPROXY=https://goproxy.cn/,direct go get -u github.com/zeromicro/go-zero/tools/goctl@latest # Go 1.16 åŠä»¥åç‰ˆæœ¬ GOPROXY=https://goproxy.cn/,direct go install github.com/zeromicro/go-zero/tools/goctl@latest ç¯å¢ƒå˜é‡æ£€æµ‹ go getä¸‹è½½ç¼–è¯‘åçš„äºŒè¿›åˆ¶æ–‡ä»¶ä½äº$GOPATH/binç›®å½•ä¸‹ï¼Œè¦ç¡®ä¿$GOPATH/binå·²ç»æ·»åŠ åˆ°ç¯å¢ƒå˜é‡ã€‚ $ sudo vim /etc/paths åœ¨æœ€åä¸€è¡Œæ·»åŠ å¦‚ä¸‹å†…å®¹ $GOPATH/bin [!TIP] $GOPATHä¸ºä½ æœ¬æœºä¸Šçš„æ–‡ä»¶åœ°å€ å®‰è£…ç»“æœéªŒè¯ $ goctl -v goctl version 1.1.4 darwin/amd64 [!TIP] windowsç”¨æˆ·æ·»åŠ ç¯å¢ƒå˜é‡è¯·è‡ªè¡Œgoogle Copyright Â© 2019-2021 go-zero all right reservedï¼Œpowered by GitbookLast UpdateTimeï¼š 2025-05-05 05:44:52 "},"protoc-install.html":{"url":"protoc-install.html","title":"protoc & protoc-gen-goå®‰è£…","keywords":"","body":"protoc & protoc-gen-goå®‰è£… å‰è¨€ protocæ˜¯ä¸€æ¬¾ç”¨C++ç¼–å†™çš„å·¥å…·ï¼Œå…¶å¯ä»¥å°†protoæ–‡ä»¶ç¿»è¯‘ä¸ºæŒ‡å®šè¯­è¨€çš„ä»£ç ã€‚åœ¨go-zeroçš„å¾®æœåŠ¡ä¸­ï¼Œæˆ‘ä»¬é‡‡ç”¨grpcè¿›è¡ŒæœåŠ¡é—´çš„é€šä¿¡ï¼Œè€Œgrpcçš„ç¼–å†™å°±éœ€è¦ç”¨åˆ°protocå’Œç¿»è¯‘æˆgoè¯­è¨€rpc stubä»£ç çš„æ’ä»¶protoc-gen-goã€‚ mac OSæ–¹å¼ä¸€ï¼šgoctlä¸€é”®å®‰è£… $ goctl env check -i -f --verbose [goctl-env]: preparing to check env [goctl-env]: looking up \"protoc\" [goctl-env]: \"protoc\" is not found in PATH [goctl-env]: preparing to install \"protoc\" \"protoc\" installed from cache [goctl-env]: \"protoc\" is already installed in \"/Users/keson/go/bin/protoc\" [goctl-env]: looking up \"protoc-gen-go\" [goctl-env]: \"protoc-gen-go\" is not found in PATH [goctl-env]: preparing to install \"protoc-gen-go\" \"protoc-gen-go\" installed from cache [goctl-env]: \"protoc-gen-go\" is already installed in \"/Users/keson/go/bin/protoc-gen-go\" [goctl-env]: looking up \"protoc-gen-go-grpc\" [goctl-env]: \"protoc-gen-go-grpc\" is not found in PATH [goctl-env]: preparing to install \"protoc-gen-go-grpc\" \"protoc-gen-go-grpc\" installed from cache [goctl-env]: \"protoc-gen-go-grpc\" is already installed in \"/Users/keson/go/bin/protoc-gen-go-grpc\" [goctl-env]: congratulations! your goctl environment is ready! æ–¹å¼äºŒï¼š æºæ–‡ä»¶å®‰è£… protocå®‰è£… è¿›å…¥protobuf release é¡µé¢ï¼Œé€‰æ‹©é€‚åˆè‡ªå·±æ“ä½œç³»ç»Ÿçš„å‹ç¼©åŒ…æ–‡ä»¶ è§£å‹protoc-x.x.x-osx-x86_64.zipå¹¶è¿›å…¥protoc-x.x.x-osx-x86_64 $ cd protoc-x.x.x-osx-x86_64/bin å°†å¯åŠ¨çš„protocäºŒè¿›åˆ¶æ–‡ä»¶ç§»åŠ¨åˆ°è¢«æ·»åŠ åˆ°ç¯å¢ƒå˜é‡çš„ä»»æ„pathä¸‹ï¼Œå¦‚$GOPATH/binï¼Œè¿™é‡Œä¸å»ºè®®ç›´æ¥å°†å…¶å’Œç³»ç»Ÿçš„ä»¥ä¸‹pathæ”¾åœ¨ä¸€èµ·ã€‚ $ mv protoc $GOPATH/bin [!TIP] $GOPATHä¸ºä½ æœ¬æœºçš„å®é™…æ–‡ä»¶å¤¹åœ°å€ éªŒè¯å®‰è£…ç»“æœ $ protoc --version libprotoc x.x.x protoc-gen-go/protoc-gen-go-grpc å®‰è£… ä¸‹è½½å®‰è£…protoc-gen-go $ go install google.golang.org/protobuf/cmd/protoc-gen-go@latest $ go install google.golang.org/grpc/cmd/protoc-gen-go-grpc@latest [!WARNING] protoc-gen-goå®‰è£…å¤±è´¥è¯·é˜…è¯»å¸¸è§é”™è¯¯å¤„ç† Copyright Â© 2019-2021 go-zero all right reservedï¼Œpowered by GitbookLast UpdateTimeï¼š 2025-05-05 05:44:52 "},"prepare-other.html":{"url":"prepare-other.html","title":"å…¶ä»–","keywords":"","body":"å…¶ä»– åœ¨ä¹‹å‰æˆ‘ä»¬å·²ç»å¯¹Goç¯å¢ƒã€Go Moduleé…ç½®ã€Goctlã€protoc & protoc-gen-goå®‰è£…å‡†å¤‡å°±ç»ªï¼Œè¿™äº›æ˜¯å¼€å‘äººå‘˜åœ¨å¼€å‘é˜¶æ®µå¿…é¡»è¦å‡†å¤‡çš„ç¯å¢ƒï¼Œè€Œæ¥ä¸‹æ¥çš„ç¯å¢ƒä½ å¯ä»¥é€‰æ‹©æ€§çš„å®‰è£…ï¼Œ å› ä¸ºè¿™äº›ç¯å¢ƒä¸€èˆ¬å­˜åœ¨äºæœåŠ¡å™¨ï¼ˆå®‰è£…å·¥ä½œè¿ç»´ä¼šæ›¿ä½ å®Œæˆï¼‰ï¼Œä½†æ˜¯ä¸ºäº†åç»­æ¼”ç¤ºæµç¨‹èƒ½å¤Ÿå®Œæ•´èµ°ä¸‹å»ï¼Œæˆ‘å»ºè®®å¤§å®¶åœ¨æœ¬åœ°ä¹Ÿå®‰è£…ä¸€ä¸‹ï¼Œå› ä¸ºæˆ‘ä»¬çš„æ¼”ç¤ºç¯å¢ƒå¤§éƒ¨åˆ†ä¼šä»¥æœ¬åœ°ä¸ºä¸»ã€‚ ä»¥ä¸‹ä»…ç»™å‡ºäº†éœ€è¦çš„å‡†å¤‡å·¥ä½œï¼Œä¸ä»¥æ–‡æ¡£ç¯‡å¹…ä½œè¯¦ç»†ä»‹ç»äº†ã€‚ å…¶ä»–ç¯å¢ƒ etcd redis mysql Copyright Â© 2019-2021 go-zero all right reservedï¼Œpowered by GitbookLast UpdateTimeï¼š 2025-05-05 05:44:52 "},"dev-specification.html":{"url":"dev-specification.html","title":"å¼€å‘è§„èŒƒ","keywords":"","body":"å¼€å‘è§„èŒƒ åœ¨å®é™…ä¸šåŠ¡å¼€å‘ä¸­ï¼Œé™¤äº†è¦æé«˜ä¸šåŠ¡å¼€å‘æ•ˆç‡ï¼Œç¼©çŸ­ä¸šåŠ¡å¼€å‘å‘¨æœŸï¼Œä¿è¯çº¿ä¸Šä¸šåŠ¡é«˜æ€§èƒ½ï¼Œé«˜å¯ç”¨çš„æŒ‡æ ‡å¤–ï¼Œå¥½çš„ç¼–ç¨‹ä¹ æƒ¯ä¹Ÿæ˜¯ä¸€ä¸ªå¼€å‘äººå‘˜åŸºæœ¬ç´ å…»ä¹‹ä¸€ï¼Œåœ¨æœ¬ç« èŠ‚ï¼Œ æˆ‘ä»¬å°†ä»‹ç»ä¸€ä¸‹go-zeroä¸­çš„ç¼–ç è§„èŒƒï¼Œæœ¬ç« èŠ‚ä¸ºå¯é€‰ç« èŠ‚ï¼Œå†…å®¹ä»…ä¾›äº¤æµä¸å‚è€ƒï¼Œæœ¬ç« èŠ‚å°†ä»ä»¥ä¸‹å°èŠ‚è¿›è¡Œè¯´æ˜ï¼š å‘½åè§„èŒƒ è·¯ç”±è§„èŒƒ ç¼–ç è§„èŒƒ å¼€å‘ä¸‰åŸåˆ™ Clarityï¼ˆæ¸…æ™°ï¼‰ ä½œè€…å¼•ç”¨äº†Hal Abelson and Gerald Sussmançš„ä¸€å¥è¯ï¼š Programs must be written for people to read, and only incidentally for machines to execute ç¨‹åºæ˜¯ä»€ä¹ˆï¼Œç¨‹åºå¿…é¡»æ˜¯ä¸ºäº†å¼€å‘äººå‘˜é˜…è¯»è€Œç¼–å†™çš„ï¼Œåªæ˜¯å¶å°”ç»™æœºå™¨å»æ‰§è¡Œï¼Œ99%çš„æ—¶é—´ç¨‹åºä»£ç é¢å‘çš„æ˜¯å¼€å‘äººå‘˜ï¼Œè€Œåªæœ‰1%çš„æ—¶é—´å¯èƒ½æ˜¯æœºå™¨åœ¨æ‰§è¡Œï¼Œè¿™é‡Œæ¯”ä¾‹ä¸æ˜¯é‡ç‚¹ï¼Œä»ä¸­æˆ‘ä»¬å¯ä»¥çœ‹å‡ºï¼Œæ¸…æ™°çš„ä»£ç æ˜¯å¤šä¹ˆçš„é‡è¦ï¼Œå› ä¸ºæ‰€æœ‰ç¨‹åºï¼Œä¸ä»…æ˜¯Goè¯­è¨€ï¼Œéƒ½æ˜¯ç”±å¼€å‘äººå‘˜ç¼–å†™ï¼Œä¾›å…¶ä»–äººé˜…è¯»å’Œç»´æŠ¤ã€‚ Simplicityï¼ˆç®€å•ï¼‰ Simplicity is prerequisite for reliability Edsger W. Dijkstraè®¤ä¸ºï¼šå¯é çš„å‰ææ¡ä»¶å°±æ˜¯ç®€å•ï¼Œæˆ‘ä»¬åœ¨å®é™…å¼€å‘ä¸­éƒ½é‡åˆ°è¿‡ï¼Œè¿™æ®µä»£ç åœ¨å†™ä»€ä¹ˆï¼Œæƒ³è¦å®Œæˆä»€ä¹ˆäº‹æƒ…ï¼Œå¼€å‘äººå‘˜ä¸ç†è§£è¿™æ®µä»£ç ï¼Œå› æ­¤ä¹Ÿä¸çŸ¥é“å¦‚ä½•å»ç»´æŠ¤ï¼Œè¿™å°±å¸¦æ¥äº†å¤æ‚æ€§ï¼Œç¨‹åºè¶Šæ˜¯å¤æ‚å°±è¶Šéš¾ç»´æŠ¤ï¼Œè¶Šéš¾ç»´æŠ¤å°±ä¼šæ˜¯ç¨‹åºå˜å¾—è¶Šæ¥è¶Šå¤æ‚ï¼Œå› æ­¤ï¼Œé‡åˆ°ç¨‹åºå˜å¤æ‚æ—¶é¦–å…ˆåº”è¯¥æƒ³åˆ°çš„æ˜¯â€”â€”é‡æ„ï¼Œé‡æ„ä¼šé‡æ–°è®¾è®¡ç¨‹åºï¼Œè®©ç¨‹åºå˜å¾—ç®€å•ã€‚ Productivityï¼ˆç”Ÿäº§åŠ›ï¼‰ åœ¨go-zeroå›¢é˜Ÿä¸­ï¼Œä¸€ç›´åœ¨å¼ºè°ƒè¿™ä¸ªè¯é¢˜ï¼Œå¼€å‘äººå‘˜æˆäº§åŠ›çš„å¤šå°‘ï¼Œå¹¶ä¸æ˜¯ä½ å†™äº†å¤šå°‘è¡Œä»£ç ï¼Œå®Œæˆäº†å¤šå°‘ä¸ªæ¨¡å—å¼€å‘ï¼Œè€Œæ˜¯æˆ‘ä»¬éœ€è¦åˆ©ç”¨å„ç§æœ‰æ•ˆçš„é€”å¾„æ¥åˆ©ç”¨æœ‰é™çš„æ—¶é—´å®Œæˆå¼€å‘æ•ˆç‡æœ€å¤§åŒ–ï¼Œè€ŒGoctlçš„è¯ç”Ÿæ­£æ˜¯ä¸ºäº†æé«˜ç”Ÿäº§åŠ›ï¼Œ å› æ­¤è¿™ä¸ªå¼€å‘åŸåˆ™æˆ‘æ˜¯éå¸¸è®¤åŒçš„ã€‚ Copyright Â© 2019-2021 go-zero all right reservedï¼Œpowered by GitbookLast UpdateTimeï¼š 2025-05-05 05:44:52 "},"naming-spec.html":{"url":"naming-spec.html","title":"å‘½åè§„èŒƒ","keywords":"","body":"å‘½åè§„èŒƒ åœ¨ä»»ä½•è¯­è¨€å¼€å‘ä¸­ï¼Œéƒ½æœ‰å…¶è¯­è¨€é¢†åŸŸçš„ä¸€äº›å‘½åè§„èŒƒï¼Œå¥½çš„å‘½åå¯ä»¥ï¼š é™ä½ä»£ç é˜…è¯»æˆæœ¬ é™ä½ç»´æŠ¤éš¾åº¦ é™ä½ä»£ç å¤æ‚åº¦ è§„èŒƒå»ºè®® åœ¨æˆ‘ä»¬å®é™…å¼€å‘ä¸­ï¼Œæœ‰å¾ˆå¤šå¼€å‘äººå¯èƒ½æ˜¯ç”±æŸä¸€è¯­è¨€è½¬åˆ°å¦å¤–ä¸€ä¸ªè¯­è¨€é¢†åŸŸï¼Œåœ¨è½¬åˆ°å¦å¤–ä¸€é—¨è¯­è¨€åï¼Œ æˆ‘ä»¬éƒ½ä¼šä¿ç•™ç€å¯¹æ—§è¯­è¨€çš„ç¼–ç¨‹ä¹ æƒ¯ï¼Œåœ¨è¿™é‡Œï¼Œæˆ‘å»ºè®®çš„æ˜¯ï¼Œè™½ç„¶ä¸åŒè¯­è¨€ä¹‹å‰çš„æŸäº›è§„èŒƒå¯èƒ½æ˜¯ç›¸é€šçš„ï¼Œ ä½†æ˜¯æˆ‘ä»¬æœ€å¥½èƒ½å¤ŸæŒ‰ç…§å®˜æ–¹çš„ä¸€äº›demoæ¥ç†Ÿæ‚‰æ˜¯æ¸æ¸é€‚åº”å½“å‰è¯­è¨€çš„ç¼–ç¨‹è§„èŒƒï¼Œè€Œä¸æ˜¯ç›´æ¥å°†åŸæ¥è¯­è¨€çš„ç¼–ç¨‹è§„èŒƒä¹Ÿéšä¹‹è¿ç§»è¿‡æ¥ã€‚ å‘½åå‡†åˆ™ å½“å˜é‡åç§°åœ¨å®šä¹‰å’Œæœ€åä¸€æ¬¡ä½¿ç”¨ä¹‹é—´çš„è·ç¦»å¾ˆçŸ­æ—¶ï¼Œç®€çŸ­çš„åç§°çœ‹èµ·æ¥ä¼šæ›´å¥½ã€‚ å˜é‡å‘½ååº”å°½é‡æè¿°å…¶å†…å®¹ï¼Œè€Œä¸æ˜¯ç±»å‹ å¸¸é‡å‘½ååº”å°½é‡æè¿°å…¶å€¼ï¼Œè€Œä¸æ˜¯å¦‚ä½•ä½¿ç”¨è¿™ä¸ªå€¼ åœ¨é‡åˆ°forï¼Œifç­‰å¾ªç¯æˆ–åˆ†æ”¯æ—¶ï¼Œæ¨èå•ä¸ªå­—æ¯å‘½åæ¥æ ‡è¯†å‚æ•°å’Œè¿”å›å€¼ methodã€interfaceã€typeã€packageæ¨èä½¿ç”¨å•è¯å‘½å packageåç§°ä¹Ÿæ˜¯å‘½åçš„ä¸€éƒ¨åˆ†ï¼Œè¯·å°½é‡å°†å…¶åˆ©ç”¨èµ·æ¥ ä½¿ç”¨ä¸€è‡´çš„å‘½åé£æ ¼ æ–‡ä»¶å‘½åè§„èŒƒ å…¨éƒ¨å°å†™ é™¤unit testå¤–é¿å…ä¸‹åˆ’çº¿(_) æ–‡ä»¶åç§°ä¸å®œè¿‡é•¿ å˜é‡å‘½åè§„èŒƒå‚è€ƒ é¦–å­—æ¯å°å†™ é©¼å³°å‘½å è§åçŸ¥ä¹‰ï¼Œé¿å…æ‹¼éŸ³æ›¿ä»£è‹±æ–‡ ä¸å»ºè®®åŒ…å«ä¸‹åˆ’çº¿(_) ä¸å»ºè®®åŒ…å«æ•°å­— é€‚ç”¨èŒƒå›´ å±€éƒ¨å˜é‡ å‡½æ•°å‡ºå‚ã€å…¥å‚ å‡½æ•°ã€å¸¸é‡å‘½åè§„èŒƒ é©¼å³°å¼å‘½å å¯exportedçš„å¿…é¡»é¦–å­—æ¯å¤§å†™ ä¸å¯exportedçš„å¿…é¡»é¦–å­—æ¯å°å†™ é¿å…å…¨éƒ¨å¤§å†™ä¸ä¸‹åˆ’çº¿(_)ç»„åˆ [!TIP] å¦‚æœæ˜¯go-zeroä»£ç è´¡çŒ®ï¼Œåˆ™å¿…é¡»ä¸¥æ ¼éµå¾ªæ­¤å‘½åè§„èŒƒ å‚è€ƒæ–‡æ¡£ Practical Go: Real world advice for writing maintainable Go programs Copyright Â© 2019-2021 go-zero all right reservedï¼Œpowered by GitbookLast UpdateTimeï¼š 2025-05-05 05:44:52 "},"route-naming-spec.html":{"url":"route-naming-spec.html","title":"è·¯ç”±è§„èŒƒ","keywords":"","body":"è·¯ç”±è§„èŒƒ æ¨èè„ŠæŸ±å¼å‘½å å°å†™å•è¯ã€æ¨ªæ (-)ç»„åˆ è§åçŸ¥ä¹‰ /user/get-info /user/get/info /user/password/change/:id Copyright Â© 2019-2021 go-zero all right reservedï¼Œpowered by GitbookLast UpdateTimeï¼š 2025-05-05 05:44:52 "},"coding-spec.html":{"url":"coding-spec.html","title":"ç¼–ç è§„èŒƒ","keywords":"","body":"ç¼–ç è§„èŒƒ import å•è¡Œimportä¸å»ºè®®ç”¨åœ†æ‹¬å·åŒ…è£¹ æŒ‰ç…§å®˜æ–¹åŒ…ï¼ŒNEW LINEï¼Œå½“å‰å·¥ç¨‹åŒ…ï¼ŒNEW LINEï¼Œç¬¬ä¸‰æ–¹ä¾èµ–åŒ…é¡ºåºå¼•å…¥ import ( \"context\" \"string\" \"greet/user/internal/config\" \"google.golang.org/grpc\" ) å‡½æ•°è¿”å› å¯¹è±¡é¿å…éæŒ‡é’ˆè¿”å› éµå¾ªæœ‰æ­£å¸¸å€¼è¿”å›åˆ™ä¸€å®šæ— errorï¼Œæœ‰erroråˆ™ä¸€å®šæ— æ­£å¸¸å€¼è¿”å›çš„åŸåˆ™ é”™è¯¯å¤„ç† æœ‰errorå¿…é¡»å¤„ç†ï¼Œå¦‚æœä¸èƒ½å¤„ç†å°±å¿…é¡»æŠ›å‡ºã€‚ é¿å…ä¸‹åˆ’çº¿(_)æ¥æ”¶error å‡½æ•°ä½“ç¼–ç  å»ºè®®ä¸€ä¸ªblockç»“æŸç©ºä¸€è¡Œï¼Œå¦‚ifã€forç­‰ func main (){ if x==1{ // do something } fmt.println(\"xxx\") } returnå‰ç©ºä¸€è¡Œ func getUser(id string)(string,error){ .... return \"xx\",nil } Copyright Â© 2019-2021 go-zero all right reservedï¼Œpowered by GitbookLast UpdateTimeï¼š 2025-05-05 05:44:52 "},"dev-flow.html":{"url":"dev-flow.html","title":"å¼€å‘æµç¨‹","keywords":"","body":"å¼€å‘æµç¨‹ è¿™é‡Œçš„å¼€å‘æµç¨‹å’Œæˆ‘ä»¬å®é™…ä¸šåŠ¡å¼€å‘æµç¨‹ä¸æ˜¯ä¸€ä¸ªæ¦‚å¿µï¼Œè¿™é‡Œçš„å®šä¹‰å±€é™äºgo-zeroçš„ä½¿ç”¨ï¼Œå³ä»£ç å±‚é¢çš„å¼€å‘ç»†èŠ‚ã€‚ å¼€å‘æµç¨‹ goctlç¯å¢ƒå‡†å¤‡[1] æ•°æ®åº“è®¾è®¡ ä¸šåŠ¡å¼€å‘ æ–°å»ºå·¥ç¨‹ åˆ›å»ºæœåŠ¡ç›®å½• åˆ›å»ºæœåŠ¡ç±»å‹ï¼ˆapi/rpc/rmq/job/scriptï¼‰ ç¼–å†™apiã€protoæ–‡ä»¶ ä»£ç ç”Ÿæˆ ç”Ÿæˆæ•°æ®åº“è®¿é—®å±‚ä»£ç model é…ç½®configï¼Œyamlå˜æ›´ èµ„æºä¾èµ–å¡«å……ï¼ˆServiceContextï¼‰ æ·»åŠ ä¸­é—´ä»¶ ä¸šåŠ¡ä»£ç å¡«å…… é”™è¯¯å¤„ç† [!TIP] [1] goctlç¯å¢ƒ å¼€å‘å·¥å…· Visual Studio Code Goland(æ¨è) Copyright Â© 2019-2021 go-zero all right reservedï¼Œpowered by GitbookLast UpdateTimeï¼š 2025-05-05 05:44:52 "},"config-introduction.html":{"url":"config-introduction.html","title":"é…ç½®ä»‹ç»","keywords":"","body":"é…ç½®ä»‹ç» åœ¨æ­£å¼ä½¿ç”¨go-zeroä¹‹å‰ï¼Œè®©æˆ‘ä»¬å…ˆæ¥äº†è§£ä¸€ä¸‹go-zeroä¸­ä¸åŒæœåŠ¡ç±»å‹çš„é…ç½®å®šä¹‰ï¼Œçœ‹çœ‹é…ç½®ä¸­æ¯ä¸ªå­—æ®µåˆ†åˆ«æœ‰ä»€ä¹ˆä½œç”¨ï¼Œæœ¬èŠ‚å°†åŒ…å«ä»¥ä¸‹å°èŠ‚ï¼š apié…ç½® rpcé…ç½® Copyright Â© 2019-2021 go-zero all right reservedï¼Œpowered by GitbookLast UpdateTimeï¼š 2025-05-05 05:44:52 "},"api-config.html":{"url":"api-config.html","title":"apié…ç½®","keywords":"","body":"apié…ç½® apié…ç½®æ§åˆ¶ç€apiæœåŠ¡ä¸­çš„å„ç§åŠŸèƒ½ï¼ŒåŒ…å«ä½†ä¸é™äºæœåŠ¡ç›‘å¬åœ°å€ï¼Œç«¯å£ï¼Œç¯å¢ƒé…ç½®ï¼Œæ—¥å¿—é…ç½®ç­‰ï¼Œä¸‹é¢æˆ‘ä»¬ä»ä¸€ä¸ªç®€å•çš„é…ç½®æ¥çœ‹ä¸€ä¸‹apiä¸­å¸¸ç”¨é…ç½®åˆ†åˆ«æœ‰ä»€ä¹ˆä½œç”¨ã€‚ é…ç½®è¯´æ˜ é€šè¿‡yamlé…ç½®æˆ‘ä»¬ä¼šå‘ç°ï¼Œæœ‰å¾ˆå¤šå‚æ•°æˆ‘ä»¬å¹¶æ²¡æœ‰ä¸configå¯¹é½ï¼Œè¿™æ˜¯å› ä¸ºconfigå®šä¹‰ä¸­ï¼Œæœ‰å¾ˆå¤šéƒ½æ˜¯å¸¦optionalæˆ–è€…default æ ‡ç­¾çš„ï¼Œå¯¹äºoptionalå¯é€‰é¡¹ï¼Œä½ å¯ä»¥æ ¹æ®è‡ªå·±éœ€æ±‚åˆ¤æ–­æ˜¯å¦éœ€è¦è®¾ç½®ï¼Œå¯¹äºdefaultæ ‡ç­¾ï¼Œå¦‚æœä½ è§‰å¾—é»˜è®¤å€¼å°±å·²ç»å¤Ÿäº†ï¼Œå¯ä»¥ä¸ç”¨è®¾ç½®ï¼Œ ä¸€èˆ¬defaultä¸­çš„å€¼åŸºæœ¬ä¸ç”¨ä¿®æ”¹ï¼Œå¯ä»¥è®¤ä¸ºæ˜¯æœ€ä½³å®è·µå€¼ã€‚ Config type Config struct{ rest.RestConf // rest apié…ç½® Auth struct { // jwté‰´æƒé…ç½® AccessSecret string // jwtå¯†é’¥ AccessExpire int64 // æœ‰æ•ˆæœŸï¼Œå•ä½ï¼šç§’ } Mysql struct { // æ•°æ®åº“é…ç½®ï¼Œé™¤mysqlå¤–ï¼Œå¯èƒ½è¿˜æœ‰mongoç­‰å…¶ä»–æ•°æ®åº“ DataSource string // mysqlé“¾æ¥åœ°å€ï¼Œæ»¡è¶³ $user:$password@tcp($ip:$port)/$db?$queries æ ¼å¼å³å¯ } CacheRedis cache.CacheConf // redisç¼“å­˜ UserRpc zrpc.RpcClientConf // rpc clienté…ç½® } rest.RestConf apiæœåŠ¡åŸºç¡€é…ç½®ï¼ŒåŒ…å«ç›‘å¬åœ°å€ï¼Œç›‘å¬ç«¯å£ï¼Œè¯ä¹¦é…ç½®ï¼Œé™æµï¼Œç†”æ–­å‚æ•°ï¼Œè¶…æ—¶å‚æ•°ç­‰æ§åˆ¶ï¼Œå¯¹å…¶å±•å¼€æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼š service.ServiceConf // serviceé…ç½® Host string `json:\",default=0.0.0.0\"` // httpç›‘å¬ipï¼Œé»˜è®¤0.0.0.0 Port int // httpç›‘å¬ç«¯å£,å¿…å¡« CertFile string `json:\",optional\"` // httpsè¯ä¹¦æ–‡ä»¶ï¼Œå¯é€‰ KeyFile string `json:\",optional\"` // httpsç§é’¥æ–‡ä»¶ï¼Œå¯é€‰ Verbose bool `json:\",optional\"` // æ˜¯å¦æ‰“å°è¯¦ç»†httpè¯·æ±‚æ—¥å¿— MaxConns int `json:\",default=10000\"` // httpåŒæ—¶å¯æ¥å—æœ€å¤§è¯·æ±‚æ•°ï¼ˆé™æµæ•°ï¼‰ï¼Œé»˜è®¤10000 MaxBytes int64 `json:\",default=1048576,range=[0:8388608]\"` // httpå¯æ¥å—è¯·æ±‚çš„æœ€å¤§ContentLengthï¼Œé»˜è®¤1048576ï¼Œè¢«è®¾ç½®å€¼å¿…é¡»åœ¨0åˆ°8388608ä¹‹é—´ // milliseconds Timeout int64 `json:\",default=3000\"` // è¶…æ—¶æ—¶é•¿æ§åˆ¶ï¼Œå•ä½ï¼šæ¯«ç§’ï¼Œé»˜è®¤3000 CpuThreshold int64 `json:\",default=900,range=[0:1000]\"` // cpué™è½½é˜ˆå€¼ï¼Œé»˜è®¤900ï¼Œå¯å…è®¸è®¾ç½®èŒƒå›´0åˆ°1000 Signature SignatureConf `json:\",optional\"` // ç­¾åé…ç½® service.ServiceConf type ServiceConf struct { Name string // æœåŠ¡åç§° Log logx.LogConf // æ—¥å¿—é…ç½® Mode string `json:\",default=pro,options=dev|test|pre|pro\"` // æœåŠ¡ç¯å¢ƒï¼Œdev-å¼€å‘ç¯å¢ƒï¼Œtest-æµ‹è¯•ç¯å¢ƒï¼Œpre-é¢„å‘ç¯å¢ƒï¼Œpro-æ­£å¼ç¯å¢ƒ MetricsUrl string `json:\",optional\"` // æŒ‡æ ‡ä¸ŠæŠ¥æ¥å£åœ°å€ï¼Œè¯¥åœ°å€éœ€è¦æ”¯æŒpost jsonå³å¯ Prometheus prometheus.Config `json:\",optional\"` // prometheusé…ç½® } logx.LogConf type LogConf struct { ServiceName string `json:\",optional\"` // æœåŠ¡åç§° Mode string `json:\",default=console,options=console|file|volume\"` // æ—¥å¿—æ¨¡å¼ï¼Œconsole-è¾“å‡ºåˆ°consoleï¼Œfile-è¾“å‡ºåˆ°å½“å‰æœåŠ¡å™¨ï¼ˆå®¹å™¨ï¼‰æ–‡ä»¶ï¼Œï¼Œvolume-è¾“å‡ºdockeræŒ‚è½½æ–‡ä»¶å†… Path string `json:\",default=logs\"` // æ—¥å¿—å­˜å‚¨è·¯å¾„ Level string `json:\",default=info,options=info|error|severe\"` // æ—¥å¿—çº§åˆ« Compress bool `json:\",optional\"` // æ˜¯å¦å¼€å¯gzipå‹ç¼© KeepDays int `json:\",optional\"` // æ—¥å¿—ä¿ç•™å¤©æ•° StackCooldownMillis int `json:\",default=100\"` // æ—¥å¿—writeé—´éš” } prometheus.Config type Config struct { Host string `json:\",optional\"` // prometheus ç›‘å¬host Port int `json:\",default=9101\"` // prometheus ç›‘å¬ç«¯å£ Path string `json:\",default=/metrics\"` // ä¸ŠæŠ¥åœ°å€ } SignatureConf SignatureConf struct { Strict bool `json:\",default=false\"` // æ˜¯å¦Strictæ¨¡å¼ï¼Œå¦‚æœæ˜¯åˆ™PrivateKeyså¿…å¡« Expiry time.Duration `json:\",default=1h\"` // æœ‰æ•ˆæœŸï¼Œé»˜è®¤1å°æ—¶ PrivateKeys []PrivateKeyConf // ç­¾åå¯†é’¥ç›¸å…³é…ç½® } PrivateKeyConf PrivateKeyConf struct { Fingerprint string // æŒ‡çº¹é…ç½® KeyFile string // å¯†é’¥é…ç½® } cache.CacheConf ClusterConf []NodeConf NodeConf struct { redis.RedisConf Weight int `json:\",default=100\"` // æƒé‡ } redis.RedisConf RedisConf struct { Host string // redisåœ°å€ Type string `json:\",default=node,options=node|cluster\"` // redisç±»å‹ Pass string `json:\",optional\"` // rediså¯†ç  } Copyright Â© 2019-2021 go-zero all right reservedï¼Œpowered by GitbookLast UpdateTimeï¼š 2025-05-05 05:44:52 "},"rpc-config.html":{"url":"rpc-config.html","title":"rpcé…ç½®","keywords":"","body":"rpcé…ç½® rpcé…ç½®æ§åˆ¶ç€ä¸€ä¸ªrpcæœåŠ¡çš„å„ç§åŠŸèƒ½ï¼ŒåŒ…å«ä½†ä¸é™äºç›‘å¬åœ°å€ï¼Œetcdé…ç½®ï¼Œè¶…æ—¶ï¼Œç†”æ–­é…ç½®ç­‰ï¼Œä¸‹é¢æˆ‘ä»¬ä»¥ä¸€ä¸ªå¸¸è§çš„rpcæœåŠ¡é…ç½®æ¥è¿›è¡Œè¯´æ˜ã€‚ é…ç½®è¯´æ˜ Config struct { zrpc.RpcServerConf CacheRedis cache.CacheConf // redisç¼“å­˜é…ç½®ï¼Œè¯¦æƒ…è§apié…ç½®è¯´æ˜ï¼Œè¿™é‡Œä¸èµ˜è¿° Mysql struct { // mysqlæ•°æ®åº“è®¿é—®é…ç½®ï¼Œè¯¦æƒ…è§apié…ç½®è¯´æ˜ï¼Œè¿™é‡Œä¸èµ˜è¿° DataSource string } } zrpc.RpcServerConf RpcServerConf struct { service.ServiceConf // æœåŠ¡é…ç½®ï¼Œè¯¦æƒ…è§apié…ç½®è¯´æ˜ï¼Œè¿™é‡Œä¸èµ˜è¿° ListenOn string // rpcç›‘å¬åœ°å€å’Œç«¯å£ï¼Œå¦‚ï¼š127.0.0.1:8888 Etcd discov.EtcdConf `json:\",optional\"` // etcdç›¸å…³é…ç½® Auth bool `json:\",optional\"` // æ˜¯å¦å¼€å¯Authï¼Œå¦‚æœæ˜¯åˆ™Redisä¸ºå¿…å¡« Redis redis.RedisKeyConf `json:\",optional\"` // AuthéªŒè¯ StrictControl bool `json:\",optional\"` // æ˜¯å¦Strictæ¨¡å¼ï¼Œå¦‚æœæ˜¯åˆ™é‡åˆ°é”™è¯¯æ˜¯Authå¤±è´¥ï¼Œå¦åˆ™å¯ä»¥è®¤ä¸ºæˆåŠŸ // pending forever is not allowed // never set it to 0, if zero, the underlying will set to 2s automatically Timeout int64 `json:\",default=2000\"` // è¶…æ—¶æ§åˆ¶ï¼Œå•ä½ï¼šæ¯«ç§’ CpuThreshold int64 `json:\",default=900,range=[0:1000]\"` cpué™è½½é˜ˆå€¼ï¼Œé»˜è®¤900ï¼Œå¯å…è®¸è®¾ç½®èŒƒå›´0åˆ°1000 } discov.EtcdConf type EtcdConf struct { Hosts []string // etcd hostæ•°ç»„ Key string // rpcæ³¨å†Œkey } redis.RedisKeyConf RedisConf struct { Host string // redis ä¸»æœº Type string `json:\",default=node,options=node|cluster\"` // redisç±»å‹ Pass string `json:\",optional\"` // rediså¯†ç  } RedisKeyConf struct { RedisConf Key string `json:\",optional\"` // éªŒè¯key } Copyright Â© 2019-2021 go-zero all right reservedï¼Œpowered by GitbookLast UpdateTimeï¼š 2025-05-05 05:44:52 "},"business-dev.html":{"url":"business-dev.html","title":"ä¸šåŠ¡å¼€å‘","keywords":"","body":"ä¸šåŠ¡å¼€å‘ æœ¬ç« èŠ‚æˆ‘ä»¬ç”¨ä¸€ä¸ªç®€å•çš„ç¤ºä¾‹å»æ¼”ç¤ºä¸€ä¸‹go-zeroä¸­çš„ä¸€äº›åŸºæœ¬åŠŸèƒ½ã€‚æœ¬èŠ‚å°†åŒ…å«ä»¥ä¸‹å°èŠ‚ï¼š ç›®å½•æ‹†åˆ† modelç”Ÿæˆ apiæ–‡ä»¶ç¼–å†™ ä¸šåŠ¡ç¼–ç  jwté‰´æƒ ä¸­é—´ä»¶ä½¿ç”¨ rpcæœåŠ¡ç¼–å†™ä¸è°ƒç”¨ é”™è¯¯å¤„ç† æ¼”ç¤ºå·¥ç¨‹ä¸‹è½½ åœ¨æ­£å¼è¿›å…¥åç»­æ–‡æ¡£å™è¿°å‰ï¼Œå¯ä»¥å…ˆç•™æ„ä¸€ä¸‹è¿™é‡Œçš„æºç ï¼Œåç»­æˆ‘ä»¬ä¼šåŸºäºè¿™ä»½æºç è¿›è¡ŒåŠŸèƒ½çš„é€’è¿›å¼æ¼”ç¤ºï¼Œ è€Œä¸æ˜¯å®Œå…¨ä»0å¼€å§‹ï¼Œå¦‚æœä½ ä»å¿«é€Ÿå…¥é—¨ç« èŠ‚è¿‡æ¥ï¼Œè¿™ä»½æºç ç»“æ„å¯¹ä½ æ¥è¯´ä¸æ˜¯é—®é¢˜ã€‚ ç‚¹å‡»è¿™é‡Œä¸‹è½½æ¼”ç¤ºå·¥ç¨‹åŸºç¡€æºç  æ¼”ç¤ºå·¥ç¨‹è¯´æ˜ åœºæ™¯ ç¨‹åºå‘˜å°æ˜éœ€è¦å€Ÿé˜…ä¸€æœ¬ã€Šè¥¿æ¸¸è®°ã€‹ï¼Œåœ¨æ²¡æœ‰çº¿ä¸Šå›¾ä¹¦ç®¡ç†ç³»ç»Ÿçš„æ—¶å€™ï¼Œä»–æ¯å¤©éƒ½è¦å»å›¾ä¹¦é¦†å‰å°å’¨è¯¢å›¾ä¹¦é¦†ç®¡ç†å‘˜ï¼Œ å°æ˜ï¼šä½ å¥½ï¼Œè¯·é—®ä»Šå¤©ã€Šè¥¿æ¸¸è®°ã€‹çš„å›¾ä¹¦è¿˜æœ‰å—ï¼Ÿ ç®¡ç†å‘˜ï¼šæ²¡æœ‰äº†ï¼Œæ˜å¤©å†æ¥çœ‹çœ‹å§ã€‚ è¿‡äº†ä¸€å¤©ï¼Œå°æ˜åˆæ¥åˆ°å›¾ä¹¦é¦†ï¼Œé—®ï¼š å°æ˜ï¼šä½ å¥½ï¼Œè¯·é—®ä»Šå¤©ã€Šè¥¿æ¸¸è®°ã€‹çš„å›¾ä¹¦è¿˜æœ‰å—ï¼Ÿ ç®¡ç†å‘˜ï¼šæ²¡æœ‰äº†ï¼Œä½ è¿‡ä¸¤å¤©å†æ¥çœ‹çœ‹å§ã€‚ å°±è¿™æ ·ç»è¿‡å¤šæ¬¡åå¤ï¼Œå°æ˜ä¹Ÿæ˜¯å¾’åŠ³æ— åŠŸï¼Œæµªè´¹å¤§é‡æ—¶é—´åœ¨æ¥å›çš„è·¯ä¸Šï¼Œäºæ˜¯ç»ˆäºå¿å—ä¸äº†è½åçš„å›¾ä¹¦ç®¡ç†ç³»ç»Ÿï¼Œ ä»–å†³å®šè‡ªå·±äº²æ‰‹åšä¸€ä¸ªå›¾ä¹¦æŸ¥é˜…ç³»ç»Ÿã€‚ é¢„æœŸå®ç°ç›®æ ‡ ç”¨æˆ·ç™»å½• ä¾é ç°æœ‰å­¦ç”Ÿç³»ç»Ÿæ•°æ®è¿›è¡Œç™»å½• å›¾ä¹¦æ£€ç´¢ æ ¹æ®å›¾ä¹¦å…³é”®å­—æœç´¢å›¾ä¹¦ï¼ŒæŸ¥è¯¢å›¾ä¹¦å‰©ä½™æ•°é‡ã€‚ ç³»ç»Ÿåˆ†æ æœåŠ¡æ‹†åˆ† user api æä¾›ç”¨æˆ·ç™»å½•åè®® rpc ä¾›searchæœåŠ¡è®¿é—®ç”¨æˆ·æ•°æ® search api æä¾›å›¾ä¹¦æŸ¥è¯¢åè®® [!TIP] è¿™ä¸ªå¾®å°çš„å›¾ä¹¦å€Ÿé˜…æŸ¥è¯¢ç³»ç»Ÿè™½ç„¶å°ï¼Œä»å®é™…æ¥è®²ä¸å¤ªç¬¦åˆä¸šåŠ¡åœºæ™¯ï¼Œä½†æ˜¯ä»…ä¸Šé¢ä¸¤ä¸ªåŠŸèƒ½ï¼Œå·²ç»æ»¡è¶³æˆ‘ä»¬å¯¹go-zero api/rpcçš„åœºæ™¯æ¼”ç¤ºäº†ï¼Œ åç»­ä¸ºäº†æ»¡è¶³æ›´ä¸°å¯Œçš„go-zeroåŠŸèƒ½æ¼”ç¤ºï¼Œä¼šåœ¨æ–‡æ¡£ä¸­è¿›è¡Œä¸šåŠ¡æ’å…¥å³ç›¸å…³åŠŸèƒ½æè¿°ã€‚è¿™é‡Œä»…ç”¨ä¸€ä¸ªåœºæ™¯è¿›è¡Œå¼•å…¥ã€‚ æ³¨æ„ï¼šuserä¸­çš„sqlè¯­å¥è¯·è‡ªè¡Œåˆ›å»ºåˆ°dbä¸­å»ï¼Œæ›´å¤šå‡†å¤‡å·¥ä½œè§å‡†å¤‡å·¥ä½œ æ·»åŠ ä¸€äº›é¢„è®¾çš„ç”¨æˆ·æ•°æ®åˆ°æ•°æ®åº“ï¼Œä¾¿äºåé¢ä½¿ç”¨ï¼Œä¸ºäº†ç¯‡å¹…ï¼Œæ¼”ç¤ºå·¥ç¨‹ä¸å¯¹æ’å…¥æ•°æ®è¿™ç§æ“ä½œåšè¯¦ç»†æ¼”ç¤ºã€‚ å‚è€ƒé¢„è®¾æ•°æ® INSERT INTO `user` (number,name,password,gender)values ('666','å°æ˜','123456','ç”·'); Copyright Â© 2019-2021 go-zero all right reservedï¼Œpowered by GitbookLast UpdateTimeï¼š 2025-05-05 05:44:52 "},"service-design.html":{"url":"service-design.html","title":"ç›®å½•æ‹†åˆ†","keywords":"","body":"ç›®å½•æ‹†åˆ† ç›®å½•æ‹†åˆ†æ˜¯æŒ‡é…åˆgo-zeroçš„æœ€ä½³å®è·µçš„ç›®å½•æ‹†åˆ†ï¼Œè¿™å’Œå¾®æœåŠ¡æ‹†åˆ†æœ‰ç€å…³è”ï¼Œåœ¨å›¢é˜Ÿå†…éƒ¨æœ€ä½³å®è·µä¸­ï¼Œ æˆ‘ä»¬æŒ‰ç…§ä¸šåŠ¡æ¨ªå‘æ‹†åˆ†ï¼Œå°†ä¸€ä¸ªç³»ç»Ÿæ‹†åˆ†æˆå¤šä¸ªå­ç³»ç»Ÿï¼Œæ¯ä¸ªå­ç³»ç»Ÿåº”æ‹¥æœ‰ç‹¬ç«‹çš„æŒä¹…åŒ–å­˜å‚¨ï¼Œç¼“å­˜ç³»ç»Ÿã€‚ å¦‚ä¸€ä¸ªå•†åŸç³»ç»Ÿéœ€è¦æœ‰ç”¨æˆ·ç³»ç»Ÿ(user)ï¼Œå•†å“ç®¡ç†ç³»ç»Ÿ(product)ï¼Œè®¢å•ç³»ç»Ÿ(order)ï¼Œè´­ç‰©è½¦ç³»ç»Ÿ(cart)ï¼Œç»“ç®—ä¸­å¿ƒç³»ç»Ÿ(pay)ï¼Œå”®åç³»ç»Ÿ(afterSale)ç­‰ç»„æˆã€‚ ç³»ç»Ÿç»“æ„åˆ†æ åœ¨ä¸Šæ–‡æåˆ°çš„å•†åŸç³»ç»Ÿä¸­ï¼Œæ¯ä¸ªç³»ç»Ÿåœ¨å¯¹å¤–ï¼ˆhttpï¼‰æä¾›æœåŠ¡çš„åŒæ—¶ï¼Œä¹Ÿä¼šæä¾›æ•°æ®ç»™å…¶ä»–å­ç³»ç»Ÿè¿›è¡Œæ•°æ®è®¿é—®çš„æ¥å£ï¼ˆrpcï¼‰ï¼Œå› æ­¤æ¯ä¸ªå­ç³»ç»Ÿå¯ä»¥æ‹†åˆ†æˆä¸€ä¸ªæœåŠ¡ï¼Œè€Œä¸”å¯¹å¤–æä¾›äº†ä¸¤ç§è®¿é—®è¯¥ç³»ç»Ÿçš„æ–¹å¼apiå’Œrpcï¼Œå› æ­¤ï¼Œ ä»¥ä¸Šç³»ç»ŸæŒ‰ç…§ç›®å½•ç»“æ„æ¥æ‹†åˆ†æœ‰å¦‚ä¸‹ç»“æ„: . â”œâ”€â”€ afterSale â”‚ â”œâ”€â”€ api â”‚ â””â”€â”€ rpc â”œâ”€â”€ cart â”‚ â”œâ”€â”€ api â”‚ â””â”€â”€ rpc â”œâ”€â”€ order â”‚ â”œâ”€â”€ api â”‚ â””â”€â”€ rpc â”œâ”€â”€ pay â”‚ â”œâ”€â”€ api â”‚ â””â”€â”€ rpc â”œâ”€â”€ product â”‚ â”œâ”€â”€ api â”‚ â””â”€â”€ rpc â””â”€â”€ user â”œâ”€â”€ api â””â”€â”€ rpc rpcè°ƒç”¨é“¾å»ºè®® åœ¨è®¾è®¡ç³»ç»Ÿæ—¶ï¼Œå°½é‡åšåˆ°æœåŠ¡ä¹‹é—´è°ƒç”¨é“¾æ˜¯å•å‘çš„ï¼Œè€Œéå¾ªç¯è°ƒç”¨ï¼Œä¾‹å¦‚ï¼šorderæœåŠ¡è°ƒç”¨äº†useræœåŠ¡ï¼Œè€ŒuseræœåŠ¡åè¿‡æ¥ä¹Ÿä¼šè°ƒç”¨orderçš„æœåŠ¡ï¼Œ å½“å…¶ä¸­ä¸€ä¸ªæœåŠ¡å¯åŠ¨æ•…éšœï¼Œå°±ä¼šç›¸äº’å½±å“ï¼Œè¿›å…¥æ­»å¾ªç¯ï¼Œä½ orderè®¤ä¸ºæ˜¯useræœåŠ¡æ•…éšœå¯¼è‡´çš„ï¼Œè€Œuserè®¤ä¸ºæ˜¯orderæœåŠ¡å¯¼è‡´çš„ï¼Œå¦‚æœæœ‰å¤§é‡æœåŠ¡å­˜åœ¨ç›¸äº’è°ƒç”¨é“¾ï¼Œ åˆ™éœ€è¦è€ƒè™‘æœåŠ¡æ‹†åˆ†æ˜¯å¦åˆç†ã€‚ å¸¸è§æœåŠ¡ç±»å‹çš„ç›®å½•ç»“æ„ åœ¨ä¸Šè¿°æœåŠ¡ä¸­ï¼Œä»…åˆ—ä¸¾äº†api/rpcæœåŠ¡ï¼Œé™¤æ­¤ä¹‹å¤–ï¼Œä¸€ä¸ªæœåŠ¡ä¸‹è¿˜å¯èƒ½æœ‰å…¶ä»–æ›´å¤šæœåŠ¡ç±»å‹ï¼Œå¦‚rmqï¼ˆæ¶ˆæ¯å¤„ç†ç³»ç»Ÿï¼‰ï¼Œcronï¼ˆå®šæ—¶ä»»åŠ¡ç³»ç»Ÿï¼‰ï¼Œscriptï¼ˆè„šæœ¬ï¼‰ç­‰ï¼Œ å› æ­¤ä¸€ä¸ªæœåŠ¡ä¸‹å¯èƒ½åŒ…å«ä»¥ä¸‹ç›®å½•ç»“æ„ï¼š user â”œâ”€â”€ api // httpè®¿é—®æœåŠ¡ï¼Œä¸šåŠ¡éœ€æ±‚å®ç° â”œâ”€â”€ cronjob // å®šæ—¶ä»»åŠ¡ï¼Œå®šæ—¶æ•°æ®æ›´æ–°ä¸šåŠ¡ â”œâ”€â”€ rmq // æ¶ˆæ¯å¤„ç†ç³»ç»Ÿï¼šmqå’Œdqï¼Œå¤„ç†ä¸€äº›é«˜å¹¶å‘å’Œå»¶æ—¶æ¶ˆæ¯ä¸šåŠ¡ â”œâ”€â”€ rpc // rpcæœåŠ¡ï¼Œç»™å…¶ä»–å­ç³»ç»Ÿæä¾›åŸºç¡€æ•°æ®è®¿é—® â””â”€â”€ script // è„šæœ¬ï¼Œå¤„ç†ä¸€äº›ä¸´æ—¶è¿è¥éœ€æ±‚ï¼Œä¸´æ—¶æ•°æ®ä¿®å¤ å®Œæ•´å·¥ç¨‹ç›®å½•ç»“æ„ç¤ºä¾‹ mall // å·¥ç¨‹åç§° â”œâ”€â”€ common // é€šç”¨åº“ â”‚ â”œâ”€â”€ randx â”‚ â””â”€â”€ stringx â”œâ”€â”€ go.mod â”œâ”€â”€ go.sum â””â”€â”€ service // æœåŠ¡å­˜æ”¾ç›®å½• â”œâ”€â”€ afterSale â”‚ â”œâ”€â”€ api â”‚ â””â”€â”€ model â”‚ â””â”€â”€ rpc â”œâ”€â”€ cart â”‚ â”œâ”€â”€ api â”‚ â””â”€â”€ model â”‚ â””â”€â”€ rpc â”œâ”€â”€ order â”‚ â”œâ”€â”€ api â”‚ â””â”€â”€ model â”‚ â””â”€â”€ rpc â”œâ”€â”€ pay â”‚ â”œâ”€â”€ api â”‚ â””â”€â”€ model â”‚ â””â”€â”€ rpc â”œâ”€â”€ product â”‚ â”œâ”€â”€ api â”‚ â””â”€â”€ model â”‚ â””â”€â”€ rpc â””â”€â”€ user â”œâ”€â”€ api â”œâ”€â”€ cronjob â”œâ”€â”€ model â”œâ”€â”€ rmq â”œâ”€â”€ rpc â””â”€â”€ script çŒœä½ æƒ³çœ‹ apiç›®å½•ç»“æ„ä»‹ç» Copyright Â© 2019-2021 go-zero all right reservedï¼Œpowered by GitbookLast UpdateTimeï¼š 2025-05-05 05:44:52 "},"model-gen.html":{"url":"model-gen.html","title":"modelç”Ÿæˆ","keywords":"","body":"modelç”Ÿæˆ é¦–å…ˆï¼Œä¸‹è½½å¥½æ¼”ç¤ºå·¥ç¨‹ åï¼Œæˆ‘ä»¬ä»¥userçš„modelæ¥è¿›è¡Œä»£ç ç”Ÿæˆæ¼”ç¤ºã€‚ å‰è¨€ modelæ˜¯æœåŠ¡è®¿é—®æŒä¹…åŒ–æ•°æ®å±‚çš„æ¡¥æ¢ï¼Œä¸šåŠ¡çš„æŒä¹…åŒ–æ•°æ®å¸¸å­˜åœ¨äºmysqlï¼Œmongoç­‰æ•°æ®åº“ä¸­ï¼Œæˆ‘ä»¬éƒ½çŸ¥é“ï¼Œå¯¹äºä¸€ä¸ªæ•°æ®åº“çš„æ“ä½œè«è¿‡äºCURDï¼Œ è€Œè¿™äº›å·¥ä½œä¹Ÿä¼šå ç”¨ä¸€éƒ¨åˆ†æ—¶é—´æ¥è¿›è¡Œå¼€å‘ï¼Œæˆ‘æ›¾ç»åœ¨ç¼–å†™ä¸€ä¸ªä¸šåŠ¡æ—¶å†™äº†40ä¸ªmodelæ–‡ä»¶ï¼Œæ ¹æ®ä¸åŒä¸šåŠ¡éœ€æ±‚çš„å¤æ‚æ€§ï¼Œå¹³å‡æ¯ä¸ªmodelæ–‡ä»¶å·®ä¸å¤šéœ€è¦ 10åˆ†é’Ÿï¼Œå¯¹äº40ä¸ªæ–‡ä»¶æ¥è¯´ï¼Œ400åˆ†é’Ÿçš„å·¥ä½œæ—¶é—´ï¼Œå·®ä¸å¤šä¸€å¤©çš„å·¥ä½œé‡ï¼Œè€Œgoctlå·¥å…·å¯ä»¥åœ¨10ç§’é’Ÿæ¥å®Œæˆè¿™400åˆ†é’Ÿçš„å·¥ä½œã€‚ å‡†å¤‡å·¥ä½œ è¿›å…¥æ¼”ç¤ºå·¥ç¨‹bookï¼Œæ‰¾åˆ°user/modelä¸‹çš„user.sqlæ–‡ä»¶ï¼Œå°†å…¶åœ¨ä½ è‡ªå·±çš„æ•°æ®åº“ä¸­æ‰§è¡Œå»ºè¡¨ã€‚ ä»£ç ç”Ÿæˆ(å¸¦ç¼“å­˜) æ–¹å¼ä¸€(ddl) è¿›å…¥service/user/modelç›®å½•ï¼Œæ‰§è¡Œå‘½ä»¤ $ cd service/user/model $ goctl model mysql ddl -src user.sql -dir . -c Done. æ–¹å¼äºŒ(datasource) $ goctl model mysql datasource -url=\"$datasource\" -table=\"user\" -c -dir . Done. [!TIP] $datasourceä¸ºæ•°æ®åº“è¿æ¥åœ°å€ æ–¹å¼ä¸‰(intellij æ’ä»¶) åœ¨Golandä¸­ï¼Œå³é”®user.sqlï¼Œä¾æ¬¡è¿›å…¥å¹¶ç‚¹å‡»New->Go Zero->Model Codeå³å¯ç”Ÿæˆï¼Œæˆ–è€…æ‰“å¼€user.sqlæ–‡ä»¶ï¼Œ è¿›å…¥ç¼–è¾‘åŒºï¼Œä½¿ç”¨å¿«æ·é”®Command+Nï¼ˆfor mac OSï¼‰æˆ–è€… alt+insertï¼ˆfor windowsï¼‰ï¼Œé€‰æ‹©Mode Codeå³å¯ [!TIP] intellijæ’ä»¶ç”Ÿæˆéœ€è¦å®‰è£…goctlæ’ä»¶ï¼Œè¯¦æƒ…è§intellijæ’ä»¶ éªŒè¯ç”Ÿæˆçš„modelæ–‡ä»¶ æŸ¥çœ‹tree $ tree . â”œâ”€â”€ user.sql â”œâ”€â”€ usermodel.go â”œâ”€â”€ usermodel_gen.go â””â”€â”€ vars.go æ›´å¤š å¯¹äºæŒä¹…åŒ–æ•°æ®ï¼Œå¦‚æœéœ€è¦æ›´çµæ´»çš„æ•°æ®åº“èƒ½åŠ›ï¼ŒåŒ…æ‹¬äº‹åŠ¡èƒ½åŠ›ï¼Œå¯ä»¥å‚è€ƒ Mysql å¦‚æœéœ€è¦åˆ†å¸ƒå¼äº‹åŠ¡çš„èƒ½åŠ›ï¼Œå¯ä»¥å‚è€ƒ åˆ†å¸ƒå¼äº‹åŠ¡æ”¯æŒ çŒœä½ æƒ³çœ‹ modelå‘½ä»¤åŠå…¶åŸç† Copyright Â© 2019-2021 go-zero all right reservedï¼Œpowered by GitbookLast UpdateTimeï¼š 2025-05-05 05:44:52 "},"api-coding.html":{"url":"api-coding.html","title":"apiæ–‡ä»¶ç¼–å†™","keywords":"","body":"apiæ–‡ä»¶ç¼–å†™ ç¼–å†™user.apiæ–‡ä»¶ $ vim service/user/api/user.api type ( LoginReq { Username string `json:\"username\"` Password string `json:\"password\"` } LoginReply { Id int64 `json:\"id\"` Name string `json:\"name\"` Gender string `json:\"gender\"` AccessToken string `json:\"accessToken\"` AccessExpire int64 `json:\"accessExpire\"` RefreshAfter int64 `json:\"refreshAfter\"` } ) service user-api { @handler login post /user/login (LoginReq) returns (LoginReply) } ç”ŸæˆapiæœåŠ¡ æ–¹å¼ä¸€ $ cd book/service/user/api $ goctl api go -api user.api -dir . Done. æ–¹å¼äºŒ åœ¨ user.api æ–‡ä»¶å³é”®ï¼Œä¾æ¬¡ç‚¹å‡»è¿›å…¥ New->Go Zero->Api Code ï¼Œè¿›å…¥ç›®æ ‡ç›®å½•é€‰æ‹©ï¼Œå³apiæºç çš„ç›®æ ‡å­˜æ”¾ç›®å½•ï¼Œé»˜è®¤ä¸ºuser.apiæ‰€åœ¨ç›®å½•ï¼Œé€‰æ‹©å¥½ç›®å½•åç‚¹å‡»OKå³å¯ã€‚ æ–¹å¼ä¸‰ æ‰“å¼€user.apiï¼Œè¿›å…¥ç¼–è¾‘åŒº,ä½¿ç”¨å¿«æ·é”®Command+Nï¼ˆfor mac OSï¼‰æˆ–è€… alt+insertï¼ˆfor windowsï¼‰ï¼Œé€‰æ‹©Api Codeï¼ŒåŒæ ·è¿›å…¥ç›®å½•é€‰æ‹©å¼¹çª—ï¼Œé€‰æ‹©å¥½ç›®å½•åç‚¹å‡»OKå³å¯ã€‚ çŒœä½ æƒ³çœ‹ apiè¯­æ³• goctl apiå‘½ä»¤ apiç›®å½•ç»“æ„ä»‹ç» Copyright Â© 2019-2021 go-zero all right reservedï¼Œpowered by GitbookLast UpdateTimeï¼š 2025-05-05 05:44:52 "},"business-coding.html":{"url":"business-coding.html","title":"ä¸šåŠ¡ç¼–ç ","keywords":"","body":"ä¸šåŠ¡ç¼–ç  å‰é¢ä¸€èŠ‚ï¼Œæˆ‘ä»¬å·²ç»æ ¹æ®åˆæ­¥éœ€æ±‚ç¼–å†™äº†user.apiæ¥æè¿°useræœåŠ¡å¯¹å¤–æä¾›å“ªäº›æœåŠ¡è®¿é—®ï¼Œåœ¨æœ¬èŠ‚æˆ‘ä»¬æ¥ç€å‰é¢çš„æ­¥ä¼ï¼Œ é€šè¿‡ä¸šåŠ¡ç¼–ç æ¥è®²è¿°go-zeroæ€ä¹ˆåœ¨å®é™…ä¸šåŠ¡ä¸­ä½¿ç”¨ã€‚ æ·»åŠ Mysqlé…ç½® $ vim service/user/api/internal/config/config.go package config import ( \"github.com/zeromicro/go-zero/rest\" \"github.com/zeromicro/go-zero/core/stores/cache\" ) type Config struct { rest.RestConf Mysql struct{ DataSource string } CacheRedis cache.CacheConf } å®Œå–„yamlé…ç½® $ vim service/user/api/etc/user-api.yaml Name: user-api Host: 0.0.0.0 Port: 8888 Mysql: DataSource: $user:$password@tcp($url)/$db?charset=utf8mb4&parseTime=true&loc=Asia%2FShanghai CacheRedis: - Host: $host Pass: $pass Type: node [!TIP] $user: mysqlæ•°æ®åº“user $password: mysqlæ•°æ®åº“å¯†ç  $url: mysqlæ•°æ®åº“è¿æ¥åœ°å€ $db: mysqlæ•°æ®åº“dbåç§°ï¼Œå³userè¡¨æ‰€åœ¨database $host: redisè¿æ¥åœ°å€ æ ¼å¼ï¼šip:portï¼Œå¦‚:127.0.0.1:6379 $pass: rediså¯†ç  æ›´å¤šé…ç½®ä¿¡æ¯ï¼Œè¯·å‚è€ƒapié…ç½®ä»‹ç» å®Œå–„æœåŠ¡ä¾èµ– $ vim service/user/api/internal/svc/servicecontext.go type ServiceContext struct { Config config.Config UserModel model.UserModel } func NewServiceContext(c config.Config) *ServiceContext { conn:=sqlx.NewMysql(c.Mysql.DataSource) return &ServiceContext{ Config: c, UserModel: model.NewUserModel(conn,c.CacheRedis), } } å¡«å……ç™»å½•é€»è¾‘ $ vim service/user/api/internal/logic/loginlogic.go func (l *LoginLogic) Login(req types.LoginReq) (*types.LoginReply, error) { if len(strings.TrimSpace(req.Username)) == 0 || len(strings.TrimSpace(req.Password)) == 0 { return nil, errors.New(\"å‚æ•°é”™è¯¯\") } userInfo, err := l.svcCtx.UserModel.FindOneByNumber(req.Username) switch err { case nil: case model.ErrNotFound: return nil, errors.New(\"ç”¨æˆ·åä¸å­˜åœ¨\") default: return nil, err } if userInfo.Password != req.Password { return nil, errors.New(\"ç”¨æˆ·å¯†ç ä¸æ­£ç¡®\") } // ---start--- now := time.Now().Unix() accessExpire := l.svcCtx.Config.Auth.AccessExpire jwtToken, err := l.getJwtToken(l.svcCtx.Config.Auth.AccessSecret, now, l.svcCtx.Config.Auth.AccessExpire, userInfo.Id) if err != nil { return nil, err } // ---end--- return &types.LoginReply{ Id: userInfo.Id, Name: userInfo.Name, Gender: userInfo.Gender, AccessToken: jwtToken, AccessExpire: now + accessExpire, RefreshAfter: now + accessExpire/2, }, nil } [!TIP] ä¸Šè¿°ä»£ç ä¸­ [start]-[end]çš„ä»£ç å®ç°è§jwté‰´æƒç« èŠ‚ çŒœä½ æƒ³çœ‹ apiè¯­æ³• goctl apiå‘½ä»¤ apiç›®å½•ç»“æ„ä»‹ç» jwté‰´æƒ apié…ç½®ä»‹ç» Copyright Â© 2019-2021 go-zero all right reservedï¼Œpowered by GitbookLast UpdateTimeï¼š 2025-05-05 05:44:52 "},"jwt.html":{"url":"jwt.html","title":"jwté‰´æƒ","keywords":"","body":"jwté‰´æƒ æ¦‚è¿° JSON Webä»¤ç‰Œï¼ˆJWTï¼‰æ˜¯ä¸€ä¸ªå¼€æ”¾æ ‡å‡†ï¼ˆRFC 7519ï¼‰ï¼Œå®ƒå®šä¹‰äº†ä¸€ç§ç´§å‡‘è€Œç‹¬ç«‹çš„æ–¹æ³•ï¼Œç”¨äºåœ¨å„æ–¹ä¹‹é—´å®‰å…¨åœ°å°†ä¿¡æ¯ä½œä¸ºJSONå¯¹è±¡ä¼ è¾“ã€‚ç”±äºæ­¤ä¿¡æ¯æ˜¯ç»è¿‡æ•°å­—ç­¾åçš„ï¼Œå› æ­¤å¯ä»¥è¢«éªŒè¯å’Œä¿¡ä»»ã€‚å¯ä»¥ä½¿ç”¨ç§˜å¯†ï¼ˆä½¿ç”¨HMACç®—æ³•ï¼‰æˆ–ä½¿ç”¨RSAæˆ–ECDSAçš„å…¬é’¥/ç§é’¥å¯¹å¯¹JWTè¿›è¡Œç­¾åã€‚ ä»€ä¹ˆæ—¶å€™åº”è¯¥ä½¿ç”¨JWT æˆæƒï¼šè¿™æ˜¯ä½¿ç”¨JWTçš„æœ€å¸¸è§æ–¹æ¡ˆã€‚ä¸€æ—¦ç”¨æˆ·ç™»å½•ï¼Œæ¯ä¸ªåç»­è¯·æ±‚å°†åŒ…æ‹¬JWTï¼Œä»è€Œå…è®¸ç”¨æˆ·è®¿é—®è¯¥ä»¤ç‰Œå…è®¸çš„è·¯ç”±ï¼ŒæœåŠ¡å’Œèµ„æºã€‚å•ä¸€ç™»å½•æ˜¯å½“ä»Šå¹¿æ³›ä½¿ç”¨JWTçš„ä¸€é¡¹åŠŸèƒ½ï¼Œå› ä¸ºå®ƒçš„å¼€é”€å¾ˆå°å¹¶ä¸”å¯ä»¥åœ¨ä¸åŒçš„åŸŸä¸­è½»æ¾ä½¿ç”¨ã€‚ ä¿¡æ¯äº¤æ¢ï¼šJSON Webä»¤ç‰Œæ˜¯åœ¨å„æ–¹ä¹‹é—´å®‰å…¨åœ°ä¼ è¾“ä¿¡æ¯çš„ä¸€ç§å¥½æ–¹æ³•ã€‚å› ä¸ºå¯ä»¥å¯¹JWTè¿›è¡Œç­¾åï¼ˆä¾‹å¦‚ï¼Œä½¿ç”¨å…¬é’¥/ç§é’¥å¯¹ï¼‰ï¼Œæ‰€ä»¥æ‚¨å¯ä»¥ç¡®ä¿å‘ä»¶äººæ˜¯ä»–ä»¬æ‰€è¯´çš„äººã€‚æ­¤å¤–ï¼Œç”±äºç­¾åæ˜¯ä½¿ç”¨æ ‡å¤´å’Œæœ‰æ•ˆè´Ÿè½½è®¡ç®—çš„ï¼Œå› æ­¤æ‚¨è¿˜å¯ä»¥éªŒè¯å†…å®¹æ˜¯å¦æœªè¢«ç¯¡æ”¹ã€‚ ä¸ºä»€ä¹ˆè¦ä½¿ç”¨JSON Webä»¤ç‰Œ ç”±äºJSONä¸å¦‚XMLå†—é•¿ï¼Œå› æ­¤åœ¨ç¼–ç æ—¶JSONçš„å¤§å°ä¹Ÿè¾ƒå°ï¼Œä»è€Œä½¿JWTæ¯”SAMLæ›´ä¸ºç´§å‡‘ã€‚è¿™ä½¿å¾—JWTæ˜¯åœ¨HTMLå’ŒHTTPç¯å¢ƒä¸­ä¼ é€’çš„ä¸é”™çš„é€‰æ‹©ã€‚ åœ¨å®‰å…¨æ–¹é¢ï¼Œåªèƒ½ä½¿ç”¨HMACç®—æ³•ç”±å…±äº«æœºå¯†å¯¹SWTè¿›è¡Œå¯¹ç§°ç­¾åã€‚ä½†æ˜¯ï¼ŒJWTå’ŒSAMLä»¤ç‰Œå¯ä»¥ä½¿ç”¨X.509è¯ä¹¦å½¢å¼çš„å…¬ç”¨/ä¸“ç”¨å¯†é’¥å¯¹è¿›è¡Œç­¾åã€‚ä¸ç­¾ç½²JSONçš„ç®€å•æ€§ç›¸æ¯”ï¼Œä½¿ç”¨XML Digital Signatureç­¾ç½²XMLè€Œä¸å¼•å…¥æ¨¡ç³Šçš„å®‰å…¨æ¼æ´æ˜¯éå¸¸å›°éš¾çš„ã€‚ JSONè§£æå™¨åœ¨å¤§å¤šæ•°ç¼–ç¨‹è¯­è¨€ä¸­éƒ½å¾ˆå¸¸è§ï¼Œå› ä¸ºå®ƒä»¬ç›´æ¥æ˜ å°„åˆ°å¯¹è±¡ã€‚ç›¸åï¼ŒXMLæ²¡æœ‰è‡ªç„¶çš„æ–‡æ¡£åˆ°å¯¹è±¡çš„æ˜ å°„ã€‚ä¸SAMLæ–­è¨€ç›¸æ¯”ï¼Œè¿™ä½¿ä½¿ç”¨JWTæ›´åŠ å®¹æ˜“ã€‚ å…³äºç”¨æ³•ï¼ŒJWTæ˜¯åœ¨Internetè§„æ¨¡ä¸Šä½¿ç”¨çš„ã€‚è¿™çªæ˜¾äº†åœ¨å¤šä¸ªå¹³å°ï¼ˆå°¤å…¶æ˜¯ç§»åŠ¨å¹³å°ï¼‰ä¸Šå¯¹JSON Webä»¤ç‰Œè¿›è¡Œå®¢æˆ·ç«¯å¤„ç†çš„ç®€ä¾¿æ€§ã€‚ [!TIP] ä»¥ä¸Šå†…å®¹å…¨éƒ¨æ¥è‡ªjwtå®˜ç½‘ä»‹ç» go-zeroä¸­æ€ä¹ˆä½¿ç”¨jwt jwté‰´æƒä¸€èˆ¬åœ¨apiå±‚ä½¿ç”¨ï¼Œæˆ‘ä»¬è¿™æ¬¡æ¼”ç¤ºå·¥ç¨‹ä¸­åˆ†åˆ«åœ¨user apiç™»å½•æ—¶ç”Ÿæˆjwt tokenï¼Œåœ¨search apiæŸ¥è¯¢å›¾ä¹¦æ—¶éªŒè¯ç”¨æˆ·jwt tokenä¸¤æ­¥æ¥å®ç°ã€‚ user apiç”Ÿæˆjwt token æ¥ç€ä¸šåŠ¡ç¼–ç ç« èŠ‚çš„å†…å®¹ï¼Œæˆ‘ä»¬å®Œå–„ä¸Šä¸€èŠ‚é—ç•™çš„getJwtTokenæ–¹æ³•ï¼Œå³ç”Ÿæˆjwt tokené€»è¾‘ æ·»åŠ é…ç½®å®šä¹‰å’Œyamlé…ç½®é¡¹ $ vim service/user/api/internal/config/config.go type Config struct { rest.RestConf Mysql struct{ DataSource string } CacheRedis cache.CacheConf Auth struct { AccessSecret string AccessExpire int64 } } $ vim service/user/api/etc/user-api.yaml Name: user-api Host: 0.0.0.0 Port: 8888 Mysql: DataSource: $user:$password@tcp($url)/$db?charset=utf8mb4&parseTime=true&loc=Asia%2FShanghai CacheRedis: - Host: $host Pass: $pass Type: node Auth: AccessSecret: $AccessSecret AccessExpire: $AccessExpire [!TIP] $AccessSecretï¼šç”Ÿæˆjwt tokençš„å¯†é’¥ï¼Œæœ€ç®€å•çš„æ–¹å¼å¯ä»¥ä½¿ç”¨ä¸€ä¸ªuuidå€¼ã€‚ $AccessExpireï¼šjwt tokenæœ‰æ•ˆæœŸï¼Œå•ä½ï¼šç§’ æ›´å¤šé…ç½®ä¿¡æ¯ï¼Œè¯·å‚è€ƒapié…ç½®ä»‹ç» $ vim service/user/api/internal/logic/loginlogic.go func (l *LoginLogic) getJwtToken(secretKey string, iat, seconds, userId int64) (string, error) { claims := make(jwt.MapClaims) claims[\"exp\"] = iat + seconds claims[\"iat\"] = iat claims[\"userId\"] = userId token := jwt.New(jwt.SigningMethodHS256) token.Claims = claims return token.SignedString([]byte(secretKey)) } search apiä½¿ç”¨jwt tokené‰´æƒ ç¼–å†™search.apiæ–‡ä»¶ $ vim service/search/api/search.api type ( SearchReq { // å›¾ä¹¦åç§° Name string `form:\"name\"` } SearchReply { Name string `json:\"name\"` Count int `json:\"count\"` } ) @server( jwt: Auth ) service search-api { @handler search get /search/do (SearchReq) returns (SearchReply) } service search-api { @handler ping get /search/ping } [!TIP] jwt: Authï¼šå¼€å¯jwté‰´æƒ å¦‚æœè·¯ç”±éœ€è¦jwté‰´æƒï¼Œåˆ™éœ€è¦åœ¨serviceä¸Šæ–¹å£°æ˜æ­¤è¯­æ³•æ ‡å¿—ï¼Œå¦‚ä¸Šæ–‡ä¸­çš„/search/do ä¸éœ€è¦jwté‰´æƒçš„è·¯ç”±å°±æ— éœ€å£°æ˜ï¼Œå¦‚ä¸Šæ–‡ä¸­/search/ping æ›´å¤šè¯­æ³•è¯·é˜…è¯»apiè¯­æ³•ä»‹ç» ç”Ÿæˆä»£ç  å‰é¢å·²ç»æè¿°è¿‡æœ‰ä¸‰ç§æ–¹å¼å»ç”Ÿæˆä»£ç ï¼Œè¿™é‡Œå°±ä¸èµ˜è¿°äº†ã€‚ æ·»åŠ yamlé…ç½®é¡¹ $ vim service/search/api/etc/search-api.yaml Name: search-api Host: 0.0.0.0 Port: 8889 Auth: AccessSecret: $AccessSecret AccessExpire: $AccessExpire [!TIP] $AccessSecretï¼šè¿™ä¸ªå€¼å¿…é¡»è¦å’Œuser apiä¸­å£°æ˜çš„ä¸€è‡´ã€‚ $AccessExpire: æœ‰æ•ˆæœŸ è¿™é‡Œä¿®æ”¹ä¸€ä¸‹ç«¯å£ï¼Œé¿å…å’Œuser apiç«¯å£8888å†²çª éªŒè¯ jwt token å¯åŠ¨user apiæœåŠ¡ï¼Œç™»å½• $ cd service/user/api $ go run user.go -f etc/user-api.yaml Starting server at 0.0.0.0:8888... $ curl -i -X POST \\ http://127.0.0.1:8888/user/login \\ -H 'Content-Type: application/json' \\ -d '{ \"username\":\"666\", \"password\":\"123456\" }' å¦‚æœæ˜¯åœ¨Windowsçš„CMDé‡Œè¿è¡Œï¼Œå‘½ä»¤æ ¼å¼å¦‚ä¸‹ï¼š curl -i -X POST http://127.0.0.1:8888/user/login -H \"Content-Type: application/json\" -d \"{ \\\"username\\\":\\\"666\\\", \\\"password\\\":\\\"123456\\\" }\" è®¿é—®ç»“æœï¼š HTTP/1.1 200 OK Content-Type: application/json Date: Mon, 08 Feb 2021 10:37:54 GMT Content-Length: 251 {\"id\":1,\"name\":\"å°æ˜\",\"gender\":\"ç”·\",\"accessToken\":\"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJleHAiOjE2MTI4NjcwNzQsImlhdCI6MTYxMjc4MDY3NCwidXNlcklkIjoxfQ.JKa83g9BlEW84IiCXFGwP2aSd0xF3tMnxrOzVebbt80\",\"accessExpire\":1612867074,\"refreshAfter\":1612823874} å¯åŠ¨search apiæœåŠ¡ï¼Œè°ƒç”¨/search/doéªŒè¯jwté‰´æƒæ˜¯å¦é€šè¿‡ $ go run search.go -f etc/search-api.yaml Starting server at 0.0.0.0:8889... æˆ‘ä»¬å…ˆä¸ä¼ jwt tokenï¼Œçœ‹çœ‹ç»“æœ $ curl -i -X GET \\ 'http://127.0.0.1:8889/search/do?name=%E8%A5%BF%E6%B8%B8%E8%AE%B0' HTTP/1.1 401 Unauthorized Date: Mon, 08 Feb 2021 10:41:57 GMT Content-Length: 0 å¾ˆæ˜æ˜¾ï¼Œjwté‰´æƒå¤±è´¥äº†ï¼Œè¿”å›401çš„statusCodeï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬å¸¦ä¸€ä¸‹jwt tokenï¼ˆå³ç”¨æˆ·ç™»å½•è¿”å›çš„accessTokenï¼‰ $ curl -i -X GET \\ 'http://127.0.0.1:8889/search/do?name=%E8%A5%BF%E6%B8%B8%E8%AE%B0' \\ -H 'Authorization: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJleHAiOjE2MTI4NjcwNzQsImlhdCI6MTYxMjc4MDY3NCwidXNlcklkIjoxfQ.JKa83g9BlEW84IiCXFGwP2aSd0xF3tMnxrOzVebbt80' HTTP/1.1 200 OK Content-Type: application/json Date: Mon, 08 Feb 2021 10:44:45 GMT Content-Length: 21 {\"name\":\"\",\"count\":0} [!TIP] æœåŠ¡å¯åŠ¨é”™è¯¯ï¼Œè¯·æŸ¥çœ‹å¸¸è§é”™è¯¯å¤„ç† è‡³æ­¤ï¼Œjwtä»ç”Ÿæˆåˆ°ä½¿ç”¨å°±æ¼”ç¤ºå®Œæˆäº†ï¼Œjwt tokençš„é‰´æƒæ˜¯go-zeroå†…éƒ¨å·²ç»å°è£…äº†ï¼Œä½ åªéœ€åœ¨apiæ–‡ä»¶ä¸­å®šä¹‰æœåŠ¡æ—¶ç®€å•çš„å£°æ˜ä¸€ä¸‹å³å¯ã€‚ è·å–jwt tokenä¸­æºå¸¦çš„ä¿¡æ¯ go-zeroä»jwt tokenè§£æåä¼šå°†ç”¨æˆ·ç”Ÿæˆtokenæ—¶ä¼ å…¥çš„kvåŸå°ä¸åŠ¨çš„æ”¾åœ¨http.Requestçš„Contextä¸­ï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥é€šè¿‡Contextå°±å¯ä»¥æ‹¿åˆ°ä½ æƒ³è¦çš„å€¼ $ vim /service/search/api/internal/logic/searchlogic.go æ·»åŠ ä¸€ä¸ªlogæ¥è¾“å‡ºä»jwtè§£æå‡ºæ¥çš„userIdã€‚ func (l *SearchLogic) Search(req types.SearchReq) (*types.SearchReply, error) { logx.Infof(\"userId: %v\",l.ctx.Value(\"userId\"))// è¿™é‡Œçš„keyå’Œç”Ÿæˆjwt tokenæ—¶ä¼ å…¥çš„keyä¸€è‡´ return &types.SearchReply{}, nil } è¿è¡Œç»“æœ {\"@timestamp\":\"2021-02-09T10:29:09.399+08\",\"level\":\"info\",\"content\":\"userId: 1\"} çŒœä½ æƒ³çœ‹ jwtä»‹ç» apié…ç½®ä»‹ç» apiè¯­æ³• Copyright Â© 2019-2021 go-zero all right reservedï¼Œpowered by GitbookLast UpdateTimeï¼š 2025-05-05 05:44:52 "},"middleware.html":{"url":"middleware.html","title":"ä¸­é—´ä»¶ä½¿ç”¨","keywords":"","body":"ä¸­é—´ä»¶ä½¿ç”¨ åœ¨ä¸Šä¸€èŠ‚ï¼Œæˆ‘ä»¬æ¼”ç¤ºäº†æ€ä¹ˆä½¿ç”¨jwté‰´æƒï¼Œç›¸ä¿¡ä½ å·²ç»æŒæ¡äº†å¯¹jwtçš„åŸºæœ¬ä½¿ç”¨ï¼Œæœ¬èŠ‚æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹apiæœåŠ¡ä¸­é—´ä»¶æ€ä¹ˆä½¿ç”¨ã€‚ ä¸­é—´ä»¶åˆ†ç±» åœ¨go-zeroä¸­ï¼Œä¸­é—´ä»¶å¯ä»¥åˆ†ä¸ºè·¯ç”±ä¸­é—´ä»¶å’Œå…¨å±€ä¸­é—´ä»¶ï¼Œè·¯ç”±ä¸­é—´ä»¶æ˜¯æŒ‡æŸä¸€äº›ç‰¹å®šè·¯ç”±éœ€è¦å®ç°ä¸­é—´ä»¶é€»è¾‘ï¼Œå…¶å’Œjwtç±»ä¼¼ï¼Œæ²¡æœ‰æ”¾åœ¨jwt:xxxä¸‹çš„è·¯ç”±ä¸ä¼šä½¿ç”¨ä¸­é—´ä»¶åŠŸèƒ½ï¼Œ è€Œå…¨å±€ä¸­é—´ä»¶çš„æœåŠ¡èŒƒå›´åˆ™æ˜¯æ•´ä¸ªæœåŠ¡ã€‚ ä¸­é—´ä»¶ä½¿ç”¨ è¿™é‡Œä»¥searchæœåŠ¡ä¸ºä¾‹æ¥æ¼”ç¤ºä¸­é—´ä»¶çš„ä½¿ç”¨ è·¯ç”±ä¸­é—´ä»¶ é‡æ–°ç¼–å†™search.apiæ–‡ä»¶ï¼Œæ·»åŠ middlewareå£°æ˜ $ cd service/search/api $ vim search.api type SearchReq struct {} type SearchReply struct {} @server( jwt: Auth middleware: Example // è·¯ç”±ä¸­é—´ä»¶å£°æ˜ ) service search-api { @handler search get /search/do (SearchReq) returns (SearchReply) } é‡æ–°ç”Ÿæˆapiä»£ç  $ goctl api go -api search.api -dir . etc/search-api.yaml exists, ignored generation internal/config/config.go exists, ignored generation search.go exists, ignored generation internal/svc/servicecontext.go exists, ignored generation internal/handler/searchhandler.go exists, ignored generation internal/handler/pinghandler.go exists, ignored generation internal/logic/searchlogic.go exists, ignored generation internal/logic/pinglogic.go exists, ignored generation Done. ç”Ÿæˆå®Œåä¼šåœ¨internalç›®å½•ä¸‹å¤šä¸€ä¸ªmiddlewareçš„ç›®å½•ï¼Œè¿™é‡Œå³ä¸­é—´ä»¶æ–‡ä»¶ï¼Œåç»­ä¸­é—´ä»¶çš„å®ç°é€»è¾‘ä¹Ÿåœ¨è¿™é‡Œç¼–å†™ã€‚ å®Œå–„èµ„æºä¾èµ–ServiceContext $ vim service/search/api/internal/svc/servicecontext.go type ServiceContext struct { Config config.Config Example rest.Middleware } func NewServiceContext(c config.Config) *ServiceContext { return &ServiceContext{ Config: c, Example: middleware.NewExampleMiddleware().Handle, } } ç¼–å†™ä¸­é—´ä»¶é€»è¾‘ è¿™é‡Œä»…æ·»åŠ ä¸€è¡Œæ—¥å¿—ï¼Œå†…å®¹example middleï¼Œå¦‚æœæœåŠ¡è¿è¡Œè¾“å‡ºexample middleåˆ™ä»£è¡¨ä¸­é—´ä»¶ä½¿ç”¨èµ·æ¥äº†ã€‚ $ vim service/search/api/internal/middleware/examplemiddleware.go package middleware import \"net/http\" type ExampleMiddleware struct { } func NewExampleMiddleware() *ExampleMiddleware { return &ExampleMiddleware{} } func (m *ExampleMiddleware) Handle(next http.HandlerFunc) http.HandlerFunc { return func(w http.ResponseWriter, r *http.Request) { // TODO generate middleware implement function, delete after code implementation // Passthrough to next handler if need next(w, r) } } å¯åŠ¨æœåŠ¡éªŒè¯ {\"@timestamp\":\"2021-02-09T11:32:57.931+08\",\"level\":\"info\",\"content\":\"example middle\"} å…¨å±€ä¸­é—´ä»¶ é€šè¿‡rest.Serveræä¾›çš„Useæ–¹æ³•å³å¯ func main() { flag.Parse() var c config.Config conf.MustLoad(*configFile, &c) ctx := svc.NewServiceContext(c) server := rest.MustNewServer(c.RestConf) defer server.Stop() // å…¨å±€ä¸­é—´ä»¶ server.Use(func(next http.HandlerFunc) http.HandlerFunc { return func(w http.ResponseWriter, r *http.Request) { logx.Info(\"global middleware\") next(w, r) } }) handler.RegisterHandlers(server, ctx) fmt.Printf(\"Starting server at %s:%d...\\n\", c.Host, c.Port) server.Start() } {\"@timestamp\":\"2021-02-09T11:50:15.388+08\",\"level\":\"info\",\"content\":\"global middleware\"} åœ¨ä¸­é—´ä»¶é‡Œè°ƒç”¨å…¶å®ƒæœåŠ¡ é€šè¿‡é—­åŒ…çš„æ–¹å¼æŠŠå…¶å®ƒæœåŠ¡ä¼ é€’ç»™ä¸­é—´ä»¶ï¼Œç¤ºä¾‹å¦‚ä¸‹ï¼š // æ¨¡æ‹Ÿçš„å…¶å®ƒæœåŠ¡ type AnotherService struct{} func (s *AnotherService) GetToken() string { return stringx.Rand() } // å¸¸è§„ä¸­é—´ä»¶ func middleware(next http.HandlerFunc) http.HandlerFunc { return func(w http.ResponseWriter, r *http.Request) { w.Header().Add(\"X-Middleware\", \"static-middleware\") next(w, r) } } // è°ƒç”¨å…¶å®ƒæœåŠ¡çš„ä¸­é—´ä»¶ func middlewareWithAnotherService(s *AnotherService) rest.Middleware { return func(next http.HandlerFunc) http.HandlerFunc { return func(w http.ResponseWriter, r *http.Request) { w.Header().Add(\"X-Middleware\", s.GetToken()) next(w, r) } } } å®Œæ•´ä»£ç å‚è€ƒï¼šhttps://github.com/zeromicro/zero-examples/tree/main/http/middleware Copyright Â© 2019-2021 go-zero all right reservedï¼Œpowered by GitbookLast UpdateTimeï¼š 2025-05-05 05:44:52 "},"rpc-call.html":{"url":"rpc-call.html","title":"rpcæœåŠ¡ç¼–å†™ä¸è°ƒç”¨","keywords":"","body":"rpcç¼–å†™ä¸è°ƒç”¨ åœ¨ä¸€ä¸ªå¤§çš„ç³»ç»Ÿä¸­ï¼Œå¤šä¸ªå­ç³»ç»Ÿï¼ˆæœåŠ¡ï¼‰é—´å¿…ç„¶å­˜åœ¨æ•°æ®ä¼ é€’ï¼Œæœ‰æ•°æ®ä¼ é€’å°±éœ€è¦é€šä¿¡æ–¹å¼ï¼Œä½ å¯ä»¥é€‰æ‹©æœ€ç®€å•çš„httpè¿›è¡Œé€šä¿¡ï¼Œä¹Ÿå¯ä»¥é€‰æ‹©rpcæœåŠ¡è¿›è¡Œé€šä¿¡ï¼Œ åœ¨go-zeroï¼Œæˆ‘ä»¬ä½¿ç”¨zrpcæ¥è¿›è¡ŒæœåŠ¡é—´çš„é€šä¿¡ï¼Œzrpcæ˜¯åŸºäºgrpcã€‚ åœºæ™¯ åœ¨å‰é¢æˆ‘ä»¬å®Œå–„äº†å¯¹ç”¨æˆ·è¿›è¡Œç™»å½•ï¼Œç”¨æˆ·æŸ¥è¯¢å›¾ä¹¦ç­‰æ¥å£åè®®ï¼Œä½†æ˜¯ç”¨æˆ·åœ¨æŸ¥è¯¢å›¾ä¹¦æ—¶æ²¡æœ‰åšä»»ä½•ç”¨æˆ·æ ¡éªŒï¼Œå¦‚æœå½“å‰ç”¨æˆ·æ˜¯ä¸€ä¸ªä¸å­˜åœ¨çš„ç”¨æˆ·åˆ™æˆ‘ä»¬ä¸å…è®¸å…¶æŸ¥é˜…å›¾ä¹¦ä¿¡æ¯ï¼Œ ä»ä¸Šæ–‡ä¿¡æ¯æˆ‘ä»¬å¯ä»¥å¾—çŸ¥ï¼Œéœ€è¦useræœåŠ¡æä¾›ä¸€ä¸ªæ–¹æ³•æ¥è·å–ç”¨æˆ·ä¿¡æ¯ä¾›searchæœåŠ¡ä½¿ç”¨ï¼Œå› æ­¤æˆ‘ä»¬å°±éœ€è¦åˆ›å»ºä¸€ä¸ªuser rpcæœåŠ¡ï¼Œå¹¶æä¾›ä¸€ä¸ªgetUseræ–¹æ³•ã€‚ rpcæœåŠ¡ç¼–å†™ ç¼–è¯‘protoæ–‡ä»¶ $ vim service/user/rpc/user.proto syntax = \"proto3\"; package user; option go_package = \"./user\"; message IdReq{ int64 id = 1; } message UserInfoReply{ int64 id = 1; string name = 2; string number = 3; string gender = 4; } service user { rpc getUser(IdReq) returns(UserInfoReply); } ç”ŸæˆrpcæœåŠ¡ä»£ç $ cd service/user/rpc $ goctl rpc protoc user.proto --go_out=./types --go-grpc_out=./types --zrpc_out=. [!TIPS] å¦‚æœå®‰è£…çš„ protoc-gen-go ç‰ˆå¤§äº1.4.0, protoæ–‡ä»¶å»ºè®®åŠ ä¸Šgo_package æ·»åŠ é…ç½®åŠå®Œå–„yamlé…ç½®é¡¹ $ vim service/user/rpc/internal/config/config.go type Config struct { zrpc.RpcServerConf Mysql struct { DataSource string } CacheRedis cache.CacheConf } $ vim /service/user/rpc/etc/user.yaml Name: user.rpc ListenOn: 127.0.0.1:8080 Etcd: Hosts: - $etcdHost Key: user.rpc Mysql: DataSource: $user:$password@tcp($url)/$db?charset=utf8mb4&parseTime=true&loc=Asia%2FShanghai CacheRedis: - Host: $host Pass: $pass Type: node [!TIP] $user: mysqlæ•°æ®åº“user $password: mysqlæ•°æ®åº“å¯†ç  $url: mysqlæ•°æ®åº“è¿æ¥åœ°å€ $db: mysqlæ•°æ®åº“dbåç§°ï¼Œå³userè¡¨æ‰€åœ¨database $host: redisè¿æ¥åœ°å€ æ ¼å¼ï¼šip:portï¼Œå¦‚:127.0.0.1:6379 $pass: rediså¯†ç  $etcdHost: etcdè¿æ¥åœ°å€ï¼Œæ ¼å¼ï¼šip:portï¼Œå¦‚ï¼š 127.0.0.1:2379 æ›´å¤šé…ç½®ä¿¡æ¯ï¼Œè¯·å‚è€ƒrpcé…ç½®ä»‹ç» æ·»åŠ èµ„æºä¾èµ– $ vim service/user/rpc/internal/svc/servicecontext.go type ServiceContext struct { Config config.Config UserModel model.UserModel } func NewServiceContext(c config.Config) *ServiceContext { conn := sqlx.NewMysql(c.Mysql.DataSource) return &ServiceContext{ Config: c, UserModel: model.NewUserModel(conn, c.CacheRedis), } } æ·»åŠ rpcé€»è¾‘ $ service/user/rpc/internal/logic/getuserlogic.go func (l *GetUserLogic) GetUser(in *user.IdReq) (*user.UserInfoReply, error) { one, err := l.svcCtx.UserModel.FindOne(in.Id) if err != nil { return nil, err } return &user.UserInfoReply{ Id: one.Id, Name: one.Name, Number: one.Number, Gender: one.Gender, }, nil } ä½¿ç”¨rpc æ¥ä¸‹æ¥æˆ‘ä»¬åœ¨searchæœåŠ¡ä¸­è°ƒç”¨user rpc æ·»åŠ UserRpcé…ç½®åŠyamlé…ç½®é¡¹ $ vim service/search/api/internal/config/config.go type Config struct { rest.RestConf Auth struct { AccessSecret string AccessExpire int64 } UserRpc zrpc.RpcClientConf } $ vim service/search/api/etc/search-api.yaml Name: search-api Host: 0.0.0.0 Port: 8889 Auth: AccessSecret: $AccessSecret AccessExpire: $AccessExpire UserRpc: Etcd: Hosts: - $etcdHost Key: user.rpc [!TIP] $AccessSecretï¼šè¿™ä¸ªå€¼å¿…é¡»è¦å’Œuser apiä¸­å£°æ˜çš„ä¸€è‡´ã€‚ $AccessExpire: æœ‰æ•ˆæœŸ $etcdHostï¼š etcdè¿æ¥åœ°å€ etcdä¸­çš„Keyå¿…é¡»è¦å’Œuser rpcæœåŠ¡é…ç½®ä¸­Keyä¸€è‡´ æ·»åŠ ä¾èµ– $ vim service/search/api/internal/svc/servicecontext.go type ServiceContext struct { Config config.Config Example rest.Middleware UserRpc user.User } func NewServiceContext(c config.Config) *ServiceContext { return &ServiceContext{ Config: c, Example: middleware.NewExampleMiddleware().Handle, UserRpc: user.NewUser(zrpc.MustNewClient(c.UserRpc)), } } è¡¥å……é€»è¾‘ $ vim /service/search/api/internal/logic/searchlogic.go func (l *SearchLogic) Search(req types.SearchReq) (*types.SearchReply, error) { userIdNumber := json.Number(fmt.Sprintf(\"%v\", l.ctx.Value(\"userId\"))) logx.Infof(\"userId: %s\", userIdNumber) userId, err := userIdNumber.Int64() if err != nil { return nil, err } // ä½¿ç”¨user rpc _, err = l.svcCtx.UserRpc.GetUser(l.ctx, &user.IdReq{ Id: userId, }) if err != nil { return nil, err } return &types.SearchReply{ Name: req.Name, Count: 100, }, nil } å¯åŠ¨å¹¶éªŒè¯æœåŠ¡ å¯åŠ¨etcdã€redisã€mysql å¯åŠ¨user rpc $ cd service/user/rpc $ go run user.go -f etc/user.yaml Starting rpc server at 127.0.0.1:8080... å¯åŠ¨search api $ cd service/search/api $ go run search.go -f etc/search-api.yaml éªŒè¯æœåŠ¡ $ curl -i -X GET \\ 'http://127.0.0.1:8889/search/do?name=%E8%A5%BF%E6%B8%B8%E8%AE%B0' \\ -H 'authorization: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJleHAiOjE2MTI4NjcwNzQsImlhdCI6MTYxMjc4MDY3NCwidXNlcklkIjoxfQ.JKa83g9BlEW84IiCXFGwP2aSd0xF3tMnxrOzVebbt80' HTTP/1.1 200 OK Content -Type: application/json Date: Tue, 09 Feb 2021 06:05:52 GMT Content-Length: 32 {\"name\":\"è¥¿æ¸¸è®°\",\"count\":100} çŒœä½ æƒ³çœ‹ rpcé…ç½® rpcæœåŠ¡ç›®å½• goctl rpcå‘½ä»¤ Copyright Â© 2019-2021 go-zero all right reservedï¼Œpowered by GitbookLast UpdateTimeï¼š 2025-05-05 05:44:52 "},"error-handle.html":{"url":"error-handle.html","title":"é”™è¯¯å¤„ç†","keywords":"","body":"é”™è¯¯å¤„ç† é”™è¯¯çš„å¤„ç†æ˜¯ä¸€ä¸ªæœåŠ¡å¿…ä¸å¯ç¼ºçš„ç¯èŠ‚ã€‚åœ¨å¹³æ—¶çš„ä¸šåŠ¡å¼€å‘ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥è®¤ä¸ºhttpçŠ¶æ€ç ä¸ä¸º2xxç³»åˆ—çš„ï¼Œéƒ½å¯ä»¥è®¤ä¸ºæ˜¯httpè¯·æ±‚é”™è¯¯ï¼Œ å¹¶ä¼´éšå“åº”çš„é”™è¯¯ä¿¡æ¯ï¼Œä½†è¿™äº›é”™è¯¯ä¿¡æ¯éƒ½æ˜¯ä»¥plain textå½¢å¼è¿”å›çš„ã€‚é™¤æ­¤ä¹‹å¤–ï¼Œæˆ‘åœ¨ä¸šåŠ¡ä¸­è¿˜ä¼šå®šä¹‰ä¸€äº›ä¸šåŠ¡æ€§é”™è¯¯ï¼Œå¸¸ç”¨åšæ³•éƒ½æ˜¯é€šè¿‡ codeã€msg ä¸¤ä¸ªå­—æ®µæ¥è¿›è¡Œä¸šåŠ¡å¤„ç†ç»“æœæè¿°ï¼Œå¹¶ä¸”å¸Œæœ›èƒ½å¤Ÿä»¥jsonå“åº”ä½“æ¥è¿›è¡Œå“åº”ã€‚ ä¸šåŠ¡é”™è¯¯å“åº”æ ¼å¼ ä¸šåŠ¡å¤„ç†æ­£å¸¸ { \"code\": 0, \"msg\": \"successful\", \"data\": { .... } } ä¸šåŠ¡å¤„ç†å¼‚å¸¸ { \"code\": 10001, \"msg\": \"å‚æ•°é”™è¯¯\" } user apiä¹‹login åœ¨ä¹‹å‰ï¼Œæˆ‘ä»¬åœ¨ç™»å½•é€»è¾‘ä¸­å¤„ç†ç”¨æˆ·åä¸å­˜åœ¨æ—¶ï¼Œç›´æ¥è¿”å›æ¥ä¸€ä¸ªerrorã€‚æˆ‘ä»¬æ¥ç™»å½•å¹¶ä¼ é€’ä¸€ä¸ªä¸å­˜åœ¨çš„ç”¨æˆ·åçœ‹çœ‹æ•ˆæœã€‚ curl -X POST \\ http://127.0.0.1:8888/user/login \\ -H 'content-type: application/json' \\ -d '{ \"username\":\"1\", \"password\":\"123456\" }' HTTP/1.1 400 Bad Request Content-Type: text/plain; charset=utf-8 X-Content-Type-Options: nosniff Date: Tue, 09 Feb 2021 06:38:42 GMT Content-Length: 19 ç”¨æˆ·åä¸å­˜åœ¨ æ¥ä¸‹æ¥æˆ‘ä»¬å°†å…¶ä»¥jsonæ ¼å¼è¿›è¡Œè¿”å› è‡ªå®šä¹‰é”™è¯¯ é¦–å…ˆåœ¨commonä¸­æ·»åŠ ä¸€ä¸ªbaseerror.goæ–‡ä»¶ï¼Œå¹¶å¡«å…¥ä»£ç  $ cd common $ mkdir errorx&&cd errorx $ vim baseerror.go package errorx const defaultCode = 1001 type CodeError struct { Code int `json:\"code\"` Msg string `json:\"msg\"` } type CodeErrorResponse struct { Code int `json:\"code\"` Msg string `json:\"msg\"` } func NewCodeError(code int, msg string) error { return &CodeError{Code: code, Msg: msg} } func NewDefaultError(msg string) error { return NewCodeError(defaultCode, msg) } func (e *CodeError) Error() string { return e.Msg } func (e *CodeError) Data() *CodeErrorResponse { return &CodeErrorResponse{ Code: e.Code, Msg: e.Msg, } } å°†ç™»å½•é€»è¾‘ä¸­é”™è¯¯ç”¨CodeErrorè‡ªå®šä¹‰é”™è¯¯æ›¿æ¢ if len(strings.TrimSpace(req.Username)) == 0 || len(strings.TrimSpace(req.Password)) == 0 { return nil, errorx.NewDefaultError(\"å‚æ•°é”™è¯¯\") } userInfo, err := l.svcCtx.UserModel.FindOneByNumber(req.Username) switch err { case nil: case model.ErrNotFound: return nil, errorx.NewDefaultError(\"ç”¨æˆ·åä¸å­˜åœ¨\") default: return nil, err } if userInfo.Password != req.Password { return nil, errorx.NewDefaultError(\"ç”¨æˆ·å¯†ç ä¸æ­£ç¡®\") } now := time.Now().Unix() accessExpire := l.svcCtx.Config.Auth.AccessExpire jwtToken, err := l.getJwtToken(l.svcCtx.Config.Auth.AccessSecret, now, l.svcCtx.Config.Auth.AccessExpire, userInfo.Id) if err != nil { return nil, err } return &types.LoginReply{ Id: userInfo.Id, Name: userInfo.Name, Gender: userInfo.Gender, AccessToken: jwtToken, AccessExpire: now + accessExpire, RefreshAfter: now + accessExpire/2, }, nil å¼€å¯è‡ªå®šä¹‰é”™è¯¯ $ vim service/user/api/user.go func main() { flag.Parse() var c config.Config conf.MustLoad(*configFile, &c) ctx := svc.NewServiceContext(c) server := rest.MustNewServer(c.RestConf) defer server.Stop() handler.RegisterHandlers(server, ctx) // è‡ªå®šä¹‰é”™è¯¯ httpx.SetErrorHandler(func(err error) (int, interface{}) { switch e := err.(type) { case *errorx.CodeError: return http.StatusOK, e.Data() default: return http.StatusInternalServerError, nil } }) fmt.Printf(\"Starting server at %s:%d...\\n\", c.Host, c.Port) server.Start() } é‡å¯æœåŠ¡éªŒè¯ $ curl -i -X POST \\ http://127.0.0.1:8888/user/login \\ -H 'content-type: application/json' \\ -d '{ \"username\":\"1\", \"password\":\"123456\" }' HTTP/1.1 200 OK Content-Type: application/json Date: Tue, 09 Feb 2021 06:47:29 GMT Content-Length: 40 {\"code\":1001,\"msg\":\"ç”¨æˆ·åä¸å­˜åœ¨\"} Copyright Â© 2019-2021 go-zero all right reservedï¼Œpowered by GitbookLast UpdateTimeï¼š 2025-05-05 05:44:52 "},"ci-cd.html":{"url":"ci-cd.html","title":"CI/CD","keywords":"","body":"CI/CD åœ¨è½¯ä»¶å·¥ç¨‹ä¸­ï¼ŒCI/CDæˆ–CICDé€šå¸¸æŒ‡çš„æ˜¯æŒç»­é›†æˆå’ŒæŒç»­äº¤ä»˜æˆ–æŒç»­éƒ¨ç½²çš„ç»„åˆå®è·µã€‚ â€”â€”å¼•è‡ªç»´åŸºç™¾ç§‘ CIå¯ä»¥åšä»€ä¹ˆï¼Ÿ ç°ä»£åº”ç”¨å¼€å‘çš„ç›®æ ‡æ˜¯è®©å¤šä½å¼€å‘äººå‘˜åŒæ—¶å¤„ç†åŒä¸€åº”ç”¨çš„ä¸åŒåŠŸèƒ½ã€‚ä½†æ˜¯ï¼Œå¦‚æœä¼ä¸šå®‰æ’åœ¨ä¸€å¤©å†…å°†æ‰€æœ‰åˆ†æ”¯æºä»£ç åˆå¹¶åœ¨ä¸€èµ·ï¼ˆç§°ä¸ºâ€œåˆå¹¶æ—¥â€ï¼‰ï¼Œæœ€ç»ˆå¯èƒ½é€ æˆå·¥ä½œç¹çã€è€—æ—¶ï¼Œè€Œä¸”éœ€è¦æ‰‹åŠ¨å®Œæˆã€‚è¿™æ˜¯å› ä¸ºå½“ä¸€ä½ç‹¬ç«‹å·¥ä½œçš„å¼€å‘äººå‘˜å¯¹åº”ç”¨è¿›è¡Œæ›´æ”¹æ—¶ï¼Œæœ‰å¯èƒ½ä¼šä¸å…¶ä»–å¼€å‘äººå‘˜åŒæ—¶è¿›è¡Œçš„æ›´æ”¹å‘ç”Ÿå†²çªã€‚å¦‚æœæ¯ä¸ªå¼€å‘äººå‘˜éƒ½è‡ªå®šä¹‰è‡ªå·±çš„æœ¬åœ°é›†æˆå¼€å‘ç¯å¢ƒï¼ˆIDEï¼‰ï¼Œè€Œä¸æ˜¯è®©å›¢é˜Ÿå°±ä¸€ä¸ªåŸºäºäº‘çš„ IDE è¾¾æˆä¸€è‡´ï¼Œé‚£ä¹ˆå°±ä¼šè®©é—®é¢˜æ›´åŠ é›ªä¸ŠåŠ éœœã€‚ æŒç»­é›†æˆï¼ˆCIï¼‰å¯ä»¥å¸®åŠ©å¼€å‘äººå‘˜æ›´åŠ é¢‘ç¹åœ°ï¼ˆæœ‰æ—¶ç”šè‡³æ¯å¤©ï¼‰å°†ä»£ç æ›´æ”¹åˆå¹¶åˆ°å…±äº«åˆ†æ”¯æˆ–â€œä¸»å¹²â€ä¸­ã€‚ä¸€æ—¦å¼€å‘äººå‘˜å¯¹åº”ç”¨æ‰€åšçš„æ›´æ”¹è¢«åˆå¹¶ï¼Œç³»ç»Ÿå°±ä¼šé€šè¿‡è‡ªåŠ¨æ„å»ºåº”ç”¨å¹¶è¿è¡Œä¸åŒçº§åˆ«çš„è‡ªåŠ¨åŒ–æµ‹è¯•ï¼ˆé€šå¸¸æ˜¯å•å…ƒæµ‹è¯•å’Œé›†æˆæµ‹è¯•ï¼‰æ¥éªŒè¯è¿™äº›æ›´æ”¹ï¼Œç¡®ä¿è¿™äº›æ›´æ”¹æ²¡æœ‰å¯¹åº”ç”¨é€ æˆç ´åã€‚è¿™æ„å‘³ç€æµ‹è¯•å†…å®¹æ¶µç›–äº†ä»ç±»å’Œå‡½æ•°åˆ°æ„æˆæ•´ä¸ªåº”ç”¨çš„ä¸åŒæ¨¡å—ã€‚å¦‚æœè‡ªåŠ¨åŒ–æµ‹è¯•å‘ç°æ–°ä»£ç å’Œç°æœ‰ä»£ç ä¹‹é—´å­˜åœ¨å†²çªï¼ŒCI å¯ä»¥æ›´åŠ è½»æ¾åœ°å¿«é€Ÿä¿®å¤è¿™äº›é”™è¯¯ã€‚ â€”â€”å¼•è‡ªã€ŠCI/CDæ˜¯ä»€ä¹ˆï¼Ÿå¦‚ä½•ç†è§£æŒç»­é›†æˆã€æŒç»­äº¤ä»˜å’ŒæŒç»­éƒ¨ç½²ã€‹ ä»æ¦‚å¿µä¸Šæ¥çœ‹ï¼ŒCI/CDåŒ…å«éƒ¨ç½²è¿‡ç¨‹ï¼Œæˆ‘ä»¬è¿™é‡Œå°†éƒ¨ç½²(CD)å•ç‹¬æ”¾åœ¨ä¸€èŠ‚æœåŠ¡éƒ¨ç½²ï¼Œ æœ¬èŠ‚å°±ä»¥gitlabæ¥åšç®€å•çš„CIï¼ˆRun Unit Testï¼‰æ¼”ç¤ºã€‚ gitlab CI Gitlab CI/CDæ˜¯Gitlabå†…ç½®çš„è½¯ä»¶å¼€å‘å·¥å…·ï¼Œæä¾› æŒç»­é›†æˆ(CI) æŒç»­äº¤ä»˜(CD) æŒç»­éƒ¨ç½²(CD) å‡†å¤‡å·¥ä½œ gitlabå®‰è£… gitå®‰è£… gitlab runnerå®‰è£… å¼€å¯gitlab CI ä¸Šä¼ ä»£ç  åœ¨gitlabæ–°å»ºä¸€ä¸ªä»“åº“go-zero-demo å°†æœ¬åœ°ä»£ç ä¸Šä¼ åˆ°go-zero-demoä»“åº“ åœ¨é¡¹ç›®æ ¹ç›®å½•ä¸‹åˆ›å»º.gitlab-ci.yamlæ–‡ä»¶ï¼Œé€šè¿‡æ­¤æ–‡ä»¶å¯ä»¥åˆ›å»ºä¸€ä¸ªpipelineï¼Œå…¶ä¼šåœ¨ä»£ç ä»“åº“ä¸­æœ‰å†…å®¹å˜æ›´æ—¶è¿è¡Œï¼Œpipelineç”±ä¸€ä¸ªæˆ–å¤šä¸ªæŒ‰ç…§é¡ºåºè¿è¡Œï¼Œ æ¯ä¸ªé˜¶æ®µå¯ä»¥åŒ…å«ä¸€ä¸ªæˆ–è€…å¤šä¸ªå¹¶è¡Œè¿è¡Œçš„jobã€‚ æ·»åŠ CIå†…å®¹(ä»…ä¾›å‚è€ƒ) stages: - analysis analysis: stage: analysis image: golang script: - go version && go env - go test -short $(go list ./...) | grep -v \"no test\" [!TIP] ä»¥ä¸ŠCIä¸ºç®€å•çš„æ¼”ç¤ºï¼Œè¯¦ç»†çš„gitlab CIè¯·å‚è€ƒgitlabå®˜æ–¹æ–‡æ¡£è¿›è¡Œæ›´ä¸°å¯Œçš„CIé›†æˆã€‚ å‚è€ƒæ–‡æ¡£ CI/CD ç»´åŸºç™¾ç§‘ CI/CDæ˜¯ä»€ä¹ˆï¼Ÿå¦‚ä½•ç†è§£æŒç»­é›†æˆã€æŒç»­äº¤ä»˜å’ŒæŒç»­éƒ¨ç½² Gitlab CI Copyright Â© 2019-2021 go-zero all right reservedï¼Œpowered by GitbookLast UpdateTimeï¼š 2025-05-05 05:44:52 "},"service-deployment.html":{"url":"service-deployment.html","title":"æœåŠ¡éƒ¨ç½²","keywords":"","body":"æœåŠ¡éƒ¨ç½² æœ¬èŠ‚é€šè¿‡jenkinsæ¥è¿›è¡Œç®€å•çš„æœåŠ¡éƒ¨ç½²åˆ°k8sæ¼”ç¤ºã€‚ å‡†å¤‡å·¥ä½œ k8sé›†ç¾¤å®‰è£… gitlabç¯å¢ƒå®‰è£… jenkinsç¯å¢ƒå®‰è£… redis&mysql&nginx&etcdå®‰è£… goctlå®‰è£… [!TIP] goctlç¡®ä¿k8sæ¯ä¸ªnodeèŠ‚ç‚¹ä¸Šéƒ½æœ‰ ä»¥ä¸Šç¯å¢ƒå®‰è£…è¯·è‡ªè¡Œgoogleï¼Œè¿™é‡Œä¸åšç¯‡å¹…ä»‹ç»ã€‚ æœåŠ¡éƒ¨ç½² 1ã€gitlabä»£ç ä»“åº“ç›¸å…³å‡†å¤‡ 1.1ã€æ·»åŠ SSH Key è¿›å…¥gitlabï¼Œç‚¹å‡»ç”¨æˆ·ä¸­å¿ƒï¼Œæ‰¾åˆ°Settingsï¼Œåœ¨å·¦ä¾§æ‰¾åˆ°SSH Keystab 1ã€åœ¨jenkinsæ‰€åœ¨æœºå™¨ä¸ŠæŸ¥çœ‹å…¬é’¥ $ cat ~/.ssh/id_rsa.pub 2ã€å¦‚æœæ²¡æœ‰ï¼Œåˆ™éœ€è¦ç”Ÿæˆï¼Œå¦‚æœå­˜åœ¨ï¼Œè¯·è·³è½¬åˆ°ç¬¬3æ­¥ $ ssh-keygen -t rsa -b 2048 -C \"email@example.com\" \"email@example.com\" å¯ä»¥æ›¿æ¢ä¸ºè‡ªå·±çš„é‚®ç®± å®Œæˆç”Ÿæˆåï¼Œé‡å¤ç¬¬ä¸€æ­¥æ“ä½œ 3ã€å°†å…¬é’¥æ·»åŠ åˆ°gitlabä¸­ 1.2ã€ä¸Šä¼ ä»£ç åˆ°gitlabä»“åº“ æ–°å»ºå·¥ç¨‹go-zero-demoå¹¶ä¸Šä¼ ä»£ç ï¼Œè¿™é‡Œä¸åšç»†èŠ‚æè¿°ã€‚ 2ã€jenkins 2.1ã€æ·»åŠ å‡­æ® æŸ¥çœ‹jenkinsæ‰€åœ¨æœºå™¨çš„ç§é’¥ï¼Œä¸å‰é¢gitlabå…¬é’¥å¯¹åº” $ cat id_rsa è¿›å…¥jenkinsï¼Œä¾æ¬¡ç‚¹å‡»Manage Jenkins-> Manage Credentials è¿›å…¥å…¨å±€å‡­æ®é¡µé¢ï¼Œæ·»åŠ å‡­æ®ï¼ŒUsernameæ˜¯ä¸€ä¸ªæ ‡è¯†ï¼Œåé¢æ·»åŠ pipelineä½ çŸ¥é“è¿™ä¸ªæ ‡è¯†æ˜¯ä»£è¡¨gitlabçš„å‡­æ®å°±è¡Œï¼ŒPrivate Key`å³ä¸Šé¢è·å–çš„ç§é’¥ 2.2ã€ æ·»åŠ å…¨å±€å˜é‡ è¿›å…¥Manage Jenkins->Configure Systemï¼Œæ»‘åŠ¨åˆ°å…¨å±€å±æ€§æ¡ç›®ï¼Œæ·»åŠ dockerç§æœ‰ä»“åº“ç›¸å…³ä¿¡æ¯ï¼Œå¦‚å›¾ä¸ºdockerç”¨æˆ·åã€dockerç”¨æˆ·å¯†ç ã€dockerç§æœ‰ä»“åº“åœ°å€ [!TIP] docker_user ä¿®æ”¹ä¸ºä½ çš„dockerç”¨æˆ·å docker_pass ä¿®æ”¹ä¸ºä½ çš„dockerç”¨æˆ·å¯†ç  docker_server ä¿®æ”¹ä¸ºä½ çš„dockeræœåŠ¡å™¨åœ°å€ è¿™é‡Œæˆ‘ä½¿ç”¨çš„ç§æœ‰ä»“åº“ï¼Œå¦‚æœæ²¡æœ‰äº‘å‚å•†æä¾›çš„ç§æœ‰ä»“åº“ä½¿ç”¨ï¼Œå¯ä»¥è‡ªè¡Œæ­å»ºä¸€ä¸ªç§æœ‰ä»“åº“ï¼Œè¿™é‡Œå°±ä¸èµ˜è¿°äº†ï¼Œå¤§å®¶è‡ªè¡Œgoogleã€‚ 2.3ã€é…ç½®git è¿›å…¥Manage Jenkins->Global Tool Configureationï¼Œæ‰¾åˆ°Gitæ¡ç›®ï¼Œå¡«å†™jenkinsæ‰€åœ¨æœºå™¨gitå¯æ‰§è¡Œæ–‡ä»¶æ‰€åœ¨pathï¼Œå¦‚æœæ²¡æœ‰çš„è¯ï¼Œéœ€è¦åœ¨jenkinsæ’ä»¶ç®¡ç†ä¸­ä¸‹è½½Gitæ’ä»¶ã€‚ 2.4ã€ æ·»åŠ ä¸€ä¸ªPipeline pipelineç”¨äºæ„å»ºé¡¹ç›®ï¼Œä»gitlabæ‹‰å–ä»£ç ->ç”ŸæˆDockerfile->éƒ¨ç½²åˆ°k8så‡åœ¨è¿™ä¸ªæ­¥éª¤å»åšï¼Œè¿™é‡Œæ˜¯æ¼”ç¤ºç¯å¢ƒï¼Œä¸ºäº†ä¿è¯éƒ¨ç½²æµç¨‹é¡ºåˆ©ï¼Œ éœ€è¦å°†jenkinså®‰è£…åœ¨å’Œk8sé›†ç¾¤çš„å…¶ä¸­è¿‡ä¸€ä¸ªèŠ‚ç‚¹æ‰€åœ¨æœºå™¨ä¸Šï¼Œæˆ‘è¿™é‡Œå®‰è£…åœ¨masterä¸Šçš„ã€‚ è·å–å‡­æ®id è¿›å…¥å‡­æ®é¡µé¢ï¼Œæ‰¾åˆ°Usernameä¸ºgitlabçš„å‡­æ®id è¿›å…¥jenkinsé¦–é¡µï¼Œç‚¹å‡»æ–°å»ºItemï¼Œåç§°ä¸ºuser æŸ¥çœ‹é¡¹ç›®gitåœ°å€ æ·»åŠ æœåŠ¡ç±»å‹Choice Parameter,åœ¨Generalä¸­å‹¾é€‰This project is parameterized,ç‚¹å‡»æ·»åŠ å‚æ•°é€‰æ‹©Choice Parameterï¼ŒæŒ‰ç…§å›¾ä¸­æ·»åŠ é€‰æ‹©çš„å€¼å¸¸é‡(apiã€rpc)åŠæ¥æ”¶å€¼çš„å˜é‡(type)ï¼Œåç»­åœ¨Pipeline scriptä¸­ä¼šç”¨åˆ°ã€‚ é…ç½®userï¼Œåœ¨useré…ç½®é¡µé¢ï¼Œå‘ä¸‹æ»‘åŠ¨æ‰¾åˆ°Pipeline script,å¡«å†™è„šæœ¬å†…å®¹ pipeline { agent any parameters { gitParameter name: 'branch', type: 'PT_BRANCH', branchFilter: 'origin/(.*)', defaultValue: 'master', selectedValue: 'DEFAULT', sortMode: 'ASCENDING_SMART', description: 'é€‰æ‹©éœ€è¦æ„å»ºçš„åˆ†æ”¯' } stages { stage('æœåŠ¡ä¿¡æ¯') { steps { sh 'echo åˆ†æ”¯ï¼š$branch' sh 'echo æ„å»ºæœåŠ¡ç±»å‹ï¼š${JOB_NAME}-$type' } } stage('check out') { steps { checkout([$class: 'GitSCM', branches: [[name: '$branch']], doGenerateSubmoduleConfigurations: false, extensions: [], submoduleCfg: [], userRemoteConfigs: [[credentialsId: '${credentialsId}', url: '${gitUrl}']]]) } } stage('è·å–commit_id') { steps { echo 'è·å–commit_id' git credentialsId: '${credentialsId}', url: '${gitUrl}' script { env.commit_id = sh(returnStdout: true, script: 'git rev-parse --short HEAD').trim() } } } stage('goctlç‰ˆæœ¬æ£€æµ‹') { steps{ sh '/usr/local/bin/goctl -v' } } stage('Dockerfile Build') { steps{ sh '/usr/local/bin/goctl docker -go service/${JOB_NAME}/${type}/${JOB_NAME}.go' script{ env.image = sh(returnStdout: true, script: 'echo ${JOB_NAME}-${type}:${commit_id}').trim() } sh 'echo é•œåƒåç§°ï¼š${image}' sh 'docker build -t ${image} .' } } stage('ä¸Šä¼ åˆ°é•œåƒä»“åº“') { steps{ sh '/root/dockerlogin.sh' sh 'docker tag ${image} ${dockerServer}/${image}' sh 'docker push ${dockerServer}/${image}' } } stage('éƒ¨ç½²åˆ°k8s') { steps{ script{ env.deployYaml = sh(returnStdout: true, script: 'echo ${JOB_NAME}-${type}-deploy.yaml').trim() env.port=sh(returnStdout: true, script: '/root/port.sh ${JOB_NAME}-${type}').trim() } sh 'echo ${port}' sh 'rm -f ${deployYaml}' sh '/usr/local/bin/goctl kube deploy -secret dockersecret -replicas 2 -nodePort 3${port} -requestCpu 200 -requestMem 50 -limitCpu 300 -limitMem 100 -name ${JOB_NAME}-${type} -namespace hey-go-zero -image ${dockerServer}/${image} -o ${deployYaml} -port ${port}' sh '/usr/bin/kubectl apply -f ${deployYaml}' } } stage('Clean') { steps{ sh 'docker rmi -f ${image}' sh 'docker rmi -f ${dockerServer}/${image}' cleanWs notFailBuild: true } } } } [!TIP] ${credentialsId}è¦æ›¿æ¢ä¸ºä½ çš„å…·ä½“å‡­æ®å€¼ï¼Œå³ã€æ·»åŠ å‡­æ®ã€‘æ¨¡å—ä¸­çš„ä¸€ä¸²å­—ç¬¦ä¸²ï¼Œ${gitUrl}éœ€è¦æ›¿æ¢ä¸ºä½ ä»£ç çš„gitä»“åº“åœ°å€ï¼Œå…¶ä»–çš„${xxx}å½¢å¼çš„å˜é‡æ— éœ€ä¿®æ”¹ï¼Œä¿æŒåŸæ ·å³å¯ã€‚ port.shå‚è€ƒå†…å®¹å¦‚ä¸‹ case $1 in \"user-api\") echo 1000 ;; \"user-rpc\") echo 1001 ;; \"course-api\") echo 1002 ;; \"course-rpc\") echo 1003 ;; \"selection-api\") echo 1004 esac å…¶ä¸­dockerlogin.shå†…å®¹ #!/bin/bash docker login --username=$docker-user --password=$docker-pass $docker-server $docker-user: dockerç™»å½•ç”¨æˆ·å $docker-pass: dockerç™»å½•ç”¨æˆ·å¯†ç  $docker-server: dockerç§æœ‰åœ°å€ æŸ¥çœ‹pipeline æŸ¥çœ‹k8sæœåŠ¡ çŒœä½ æƒ³çœ‹ goctlå®‰è£… k8sä»‹ç» dockerä»‹ç» jenkinså®‰è£… jenkins pipeline nginxæ–‡æ¡£ä»‹ç» etcdæ–‡æ¡£è¯´æ˜ Copyright Â© 2019-2021 go-zero all right reservedï¼Œpowered by GitbookLast UpdateTimeï¼š 2025-05-05 05:44:52 "},"log-collection.html":{"url":"log-collection.html","title":"æ—¥å¿—æ”¶é›†","keywords":"","body":"æ—¥å¿—æ”¶é›† ä¸ºäº†ä¿è¯ä¸šåŠ¡ç¨³å®šè¿è¡Œï¼Œé¢„æµ‹æœåŠ¡ä¸å¥åº·é£é™©ï¼Œæ—¥å¿—çš„æ”¶é›†å¯ä»¥å¸®åŠ©æˆ‘ä»¬å¾ˆå¥½çš„è§‚å¯Ÿå½“å‰æœåŠ¡çš„å¥åº·çŠ¶å†µï¼Œ åœ¨ä¼ ç»Ÿä¸šåŠ¡å¼€å‘ä¸­ï¼Œæœºå™¨éƒ¨ç½²è¿˜ä¸æ˜¯å¾ˆå¤šæ—¶ï¼Œæˆ‘ä»¬ä¸€èˆ¬éƒ½æ˜¯ç›´æ¥ç™»å½•æœåŠ¡å™¨è¿›è¡Œæ—¥å¿—æŸ¥çœ‹ã€è°ƒè¯•ï¼Œä½†éšç€ä¸šåŠ¡çš„å¢å¤§ï¼ŒæœåŠ¡çš„ä¸æ–­æ‹†åˆ†ï¼Œ æœåŠ¡çš„ç»´æŠ¤æˆæœ¬ä¹Ÿä¼šéšä¹‹å˜å¾—è¶Šæ¥è¶Šå¤æ‚ï¼Œåœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­ï¼ŒæœåŠ¡å™¨æœºå­å¢å¤šï¼ŒæœåŠ¡åˆ†å¸ƒåœ¨ä¸åŒçš„æœåŠ¡å™¨ä¸Šï¼Œå½“é‡åˆ°é—®é¢˜æ—¶ï¼Œ æˆ‘ä»¬ä¸èƒ½ä½¿ç”¨ä¼ ç»Ÿåšæ³•ï¼Œç™»å½•åˆ°æœåŠ¡å™¨è¿›è¡Œæ—¥å¿—æ’æŸ¥å’Œè°ƒè¯•ï¼Œè¿™ä¸ªå¤æ‚åº¦å¯æƒ³è€ŒçŸ¥ã€‚ [!TIP] å¦‚æœæ˜¯ä¸€ä¸ªç®€å•çš„å•ä½“æœåŠ¡ç³»ç»Ÿæˆ–è€…æœåŠ¡è¿‡äºå°ä¸å»ºè®®ç›´æ¥ä½¿ç”¨ï¼Œå¦åˆ™ä¼šé€‚å¾—å…¶åã€‚ å‡†å¤‡å·¥ä½œ kafka elasticsearch kibana filebeatã€Log-Pilotï¼ˆk8sï¼‰ go-stash filebeaté…ç½® $ vim xx/filebeat.yaml filebeat.inputs: - type: log enabled: true # å¼€å¯jsonè§£æ json.keys_under_root: true json.add_error_key: true # æ—¥å¿—æ–‡ä»¶è·¯å¾„ paths: - /var/log/order/*.log setup.template.settings: index.number_of_shards: 1 # å®šä¹‰kafka topic field fields: log_topic: log-collection # è¾“å‡ºåˆ°kafka output.kafka: hosts: [\"127.0.0.1:9092\"] topic: '%{[fields.log_topic]}' partition.round_robin: reachable_only: false required_acks: 1 keep_alive: 10s # ================================= Processors ================================= processors: - decode_json_fields: fields: ['@timestamp','level','content','trace','span','duration'] target: \"\" [!TIP] xxä¸ºfilebeat.yamlæ‰€åœ¨è·¯å¾„ go-stashé…ç½® æ–°å»ºconfig.yamlæ–‡ä»¶ æ·»åŠ é…ç½®å†…å®¹ $ vim config.yaml Clusters: - Input: Kafka: Name: go-stash Log: Mode: file Brokers: - \"127.0.0.1:9092\" Topics: - log-collection Group: stash Conns: 3 Consumers: 10 Processors: 60 MinBytes: 1048576 MaxBytes: 10485760 Offset: first Filters: - Action: drop Conditions: - Key: status Value: \"503\" Type: contains - Key: type Value: \"app\" Type: match Op: and - Action: remove_field Fields: - source - _score - \"@metadata\" - agent - ecs - input - log - fields Output: ElasticSearch: Hosts: - \"http://127.0.0.1:9200\" Index: \"go-stash-{{yyyy.MM.dd}}\" MaxChunkBytes: 5242880 GracePeriod: 10s Compress: false TimeZone: UTC å¯åŠ¨æœåŠ¡(æŒ‰é¡ºåºå¯åŠ¨) å¯åŠ¨kafka å¯åŠ¨elasticsearch å¯åŠ¨kibana å¯åŠ¨go-stash å¯åŠ¨filebeat å¯åŠ¨order-apiæœåŠ¡åŠå…¶ä¾èµ–æœåŠ¡ï¼ˆgo-zero-demoå·¥ç¨‹ä¸­çš„order-apiæœåŠ¡ï¼‰ è®¿é—®kibana è¿›å…¥127.0.0.1:5601 [!TIP] è¿™é‡Œä»…æ¼”ç¤ºæ”¶é›†æœåŠ¡ä¸­é€šè¿‡logxäº§ç”Ÿçš„æ—¥å¿—ï¼Œnginxä¸­æ—¥å¿—æ”¶é›†åŒç†ã€‚ å‚è€ƒæ–‡æ¡£ kafka elasticsearch kibana filebeat go-stash filebeaté…ç½® Copyright Â© 2019-2021 go-zero all right reservedï¼Œpowered by GitbookLast UpdateTimeï¼š 2025-05-05 05:44:52 "},"trace.html":{"url":"trace.html","title":"é“¾è·¯è¿½è¸ª","keywords":"","body":"go-zeroé“¾è·¯è¿½è¸ª åºè¨€ å¾®æœåŠ¡æ¶æ„ä¸­ï¼Œè°ƒç”¨é“¾å¯èƒ½å¾ˆæ¼«é•¿ï¼Œä» http åˆ° rpc ï¼Œåˆä» rpc åˆ° http ã€‚è€Œå¼€å‘è€…æƒ³äº†è§£æ¯ä¸ªç¯èŠ‚çš„è°ƒç”¨æƒ…å†µåŠæ€§èƒ½ï¼Œæœ€ä½³æ–¹æ¡ˆå°±æ˜¯ å…¨é“¾è·¯è·Ÿè¸ªã€‚ è¿½è¸ªçš„æ–¹æ³•å°±æ˜¯åœ¨ä¸€ä¸ªè¯·æ±‚å¼€å§‹æ—¶ç”Ÿæˆä¸€ä¸ªè‡ªå·±çš„ spanID ï¼Œéšç€æ•´ä¸ªè¯·æ±‚é“¾è·¯ä¼ ä¸‹å»ã€‚æˆ‘ä»¬åˆ™é€šè¿‡è¿™ä¸ª spanID æŸ¥çœ‹æ•´ä¸ªé“¾è·¯çš„æƒ…å†µå’Œæ€§èƒ½é—®é¢˜ã€‚ ä¸‹é¢æ¥çœ‹çœ‹ go-zero çš„é“¾è·¯å®ç°ã€‚ ä»£ç ç»“æ„ spancontext ï¼šä¿å­˜é“¾è·¯çš„ä¸Šä¸‹æ–‡ä¿¡æ¯ã€Œtraceidï¼Œspanidï¼Œæˆ–è€…æ˜¯å…¶ä»–æƒ³è¦ä¼ é€’çš„å†…å®¹ã€ span ï¼šé“¾è·¯ä¸­çš„ä¸€ä¸ªæ“ä½œï¼Œå­˜å‚¨æ—¶é—´å’ŒæŸäº›ä¿¡æ¯ propagator ï¼š trace ä¼ æ’­ä¸‹æ¸¸çš„æ“ä½œã€ŒæŠ½å–ï¼Œæ³¨å…¥ã€ noop ï¼šå®ç°äº†ç©ºçš„ tracer å®ç° æ¦‚å¿µ SpanContext åœ¨ä»‹ç» span ä¹‹å‰ï¼Œå…ˆå¼•å…¥ context ã€‚SpanContext ä¿å­˜äº†åˆ†å¸ƒå¼è¿½è¸ªçš„ä¸Šä¸‹æ–‡ä¿¡æ¯ï¼ŒåŒ…æ‹¬ Trace idï¼ŒSpan id ä»¥åŠå…¶å®ƒéœ€è¦ä¼ é€’åˆ°ä¸‹æ¸¸çš„å†…å®¹ã€‚OpenTracing çš„å®ç°éœ€è¦å°† SpanContext é€šè¿‡æŸç§åè®® è¿›è¡Œä¼ é€’ï¼Œä»¥å°†ä¸åŒè¿›ç¨‹ä¸­çš„ Span å…³è”åˆ°åŒä¸€ä¸ª Trace ä¸Šã€‚å¯¹äº HTTP è¯·æ±‚æ¥è¯´ï¼ŒSpanContext ä¸€èˆ¬æ˜¯é‡‡ç”¨ HTTP header è¿›è¡Œä¼ é€’çš„ã€‚ ä¸‹é¢æ˜¯ go-zero é»˜è®¤å®ç°çš„ spanContext type spanContext struct { traceId string // TraceID è¡¨ç¤ºtracerçš„å…¨å±€å”¯ä¸€ID spanId string // SpanId æ ‡ç¤ºå•ä¸ªtraceä¸­æŸä¸€ä¸ªspançš„å”¯ä¸€IDï¼Œåœ¨traceä¸­å”¯ä¸€ } åŒæ—¶å¼€å‘è€…ä¹Ÿå¯ä»¥å®ç° SpanContext æä¾›çš„æ¥å£æ–¹æ³•ï¼Œå®ç°è‡ªå·±çš„ä¸Šä¸‹æ–‡ä¿¡æ¯ä¼ é€’ï¼š type SpanContext interface { TraceId() string // get TraceId SpanId() string // get SpanId Visit(fn func(key, val string) bool) // è‡ªå®šä¹‰æ“ä½œTraceIdï¼ŒSpanId } Span ä¸€ä¸ª REST è°ƒç”¨æˆ–è€…æ•°æ®åº“æ“ä½œç­‰ï¼Œéƒ½å¯ä»¥ä½œä¸ºä¸€ä¸ª span ã€‚ span æ˜¯åˆ†å¸ƒå¼è¿½è¸ªçš„æœ€å°è·Ÿè¸ªå•ä½ï¼Œä¸€ä¸ª Trace ç”±å¤šæ®µ Span ç»„æˆã€‚è¿½è¸ªä¿¡æ¯åŒ…å«å¦‚ä¸‹ä¿¡æ¯ï¼š type Span struct { ctx spanContext // ä¼ é€’çš„ä¸Šä¸‹æ–‡ serviceName string // æœåŠ¡å operationName string // æ“ä½œ startTime time.Time // å¼€å§‹æ—¶é—´æˆ³ flag string // æ ‡è®°å¼€å¯traceæ˜¯ server è¿˜æ˜¯ client children int // æœ¬ span forkå‡ºæ¥çš„ childsnums } ä» span çš„å®šä¹‰ç»“æ„æ¥çœ‹ï¼šåœ¨å¾®æœåŠ¡ä¸­ï¼Œ è¿™å°±æ˜¯ä¸€ä¸ªå®Œæ•´çš„å­è°ƒç”¨è¿‡ç¨‹ï¼Œæœ‰è°ƒç”¨å¼€å§‹ startTime ï¼Œæœ‰æ ‡è®°è‡ªå·±å”¯ä¸€å±æ€§çš„ä¸Šä¸‹æ–‡ç»“æ„ spanContext ä»¥åŠ fork çš„å­èŠ‚ç‚¹æ•°ã€‚ å®ä¾‹åº”ç”¨ åœ¨ go-zero ä¸­httpï¼Œrpcä¸­å·²ç»ä½œä¸ºå†…ç½®ä¸­é—´ä»¶é›†æˆã€‚æˆ‘ä»¬ä»¥ http ï¼Œrpc ä¸­ï¼Œçœ‹çœ‹ tracing æ˜¯æ€ä¹ˆä½¿ç”¨çš„ï¼š HTTP func TracingHandler(next http.Handler) http.Handler { return http.HandlerFunc(func(w http.ResponseWriter, r *http.Request) { // **1** carrier, err := trace.Extract(trace.HttpFormat, r.Header) // ErrInvalidCarrier means no trace id was set in http header if err != nil && err != trace.ErrInvalidCarrier { logx.Error(err) } // **2** ctx, span := trace.StartServerSpan(r.Context(), carrier, sysx.Hostname(), r.RequestURI) defer span.Finish() // **5** r = r.WithContext(ctx) next.ServeHTTP(w, r) }) } func StartServerSpan(ctx context.Context, carrier Carrier, serviceName, operationName string) ( context.Context, tracespec.Trace) { span := newServerSpan(carrier, serviceName, operationName) // **4** return context.WithValue(ctx, tracespec.TracingKey, span), span } func newServerSpan(carrier Carrier, serviceName, operationName string) tracespec.Trace { // **3** traceId := stringx.TakeWithPriority(func() string { if carrier != nil { return carrier.Get(traceIdKey) } return \"\" }, func() string { return stringx.RandId() }) spanId := stringx.TakeWithPriority(func() string { if carrier != nil { return carrier.Get(spanIdKey) } return \"\" }, func() string { return initSpanId }) return &Span{ ctx: spanContext{ traceId: traceId, spanId: spanId, }, serviceName: serviceName, operationName: operationName, startTime: timex.Time(), // æ ‡è®°ä¸ºserver flag: serverFlag, } } å°† header -> carrierï¼Œè·å– header ä¸­çš„traceIdç­‰ä¿¡æ¯ å¼€å¯ä¸€ä¸ªæ–°çš„ spanï¼Œå¹¶æŠŠã€ŒtraceIdï¼ŒspanIdã€å°è£…åœ¨contextä¸­ ä»ä¸Šè¿°çš„ carrierã€Œä¹Ÿå°±æ˜¯headerã€è·å–traceIdï¼ŒspanId çœ‹headerä¸­æ˜¯å¦è®¾ç½® å¦‚æœæ²¡æœ‰è®¾ç½®ï¼Œåˆ™éšæœºç”Ÿæˆè¿”å› ä» request ä¸­äº§ç”Ÿæ–°çš„ctxï¼Œå¹¶å°†ç›¸åº”çš„ä¿¡æ¯å°è£…åœ¨ ctx ä¸­ï¼Œè¿”å› ä»ä¸Šè¿°çš„ contextï¼Œæ‹·è´ä¸€ä»½åˆ°å½“å‰çš„ request è¿™æ ·å°±å®ç°äº† span çš„ä¿¡æ¯éšç€ request ä¼ é€’åˆ°ä¸‹æ¸¸æœåŠ¡ã€‚ RPC åœ¨ rpc ä¸­å­˜åœ¨ client, server ï¼Œæ‰€ä»¥ä» tracing ä¸Šä¹Ÿæœ‰ clientTracing, serverTracing ã€‚ serveTracing çš„é€»è¾‘åŸºæœ¬ä¸ http çš„ä¸€è‡´ï¼Œæ¥çœ‹çœ‹ clientTracing æ˜¯æ€ä¹ˆä½¿ç”¨çš„ï¼Ÿ func TracingInterceptor(ctx context.Context, method string, req, reply interface{}, cc *grpc.ClientConn, invoker grpc.UnaryInvoker, opts ...grpc.CallOption) error { // open clientSpan ctx, span := trace.StartClientSpan(ctx, cc.Target(), method) defer span.Finish() var pairs []string span.Visit(func(key, val string) bool { pairs = append(pairs, key, val) return true }) // **3** å°† pair ä¸­çš„dataä»¥mapçš„å½¢å¼åŠ å…¥ ctx ctx = metadata.AppendToOutgoingContext(ctx, pairs...) return invoker(ctx, method, req, reply, cc, opts...) } func StartClientSpan(ctx context.Context, serviceName, operationName string) (context.Context, tracespec.Trace) { // **1** if span, ok := ctx.Value(tracespec.TracingKey).(*Span); ok { // **2** return span.Fork(ctx, serviceName, operationName) } return ctx, emptyNoopSpan } è·å–ä¸Šæ¸¸å¸¦ä¸‹æ¥çš„ span ä¸Šä¸‹æ–‡ä¿¡æ¯ ä»è·å–çš„ span ä¸­åˆ›å»ºæ–°çš„ ctxï¼Œspanã€Œç»§æ‰¿çˆ¶spançš„traceIdã€ å°†ç”Ÿæˆ span çš„dataåŠ å…¥ctxï¼Œä¼ é€’åˆ°ä¸‹ä¸€ä¸ªä¸­é—´ä»¶ï¼Œæµè‡³ä¸‹æ¸¸ æ€»ç»“ go-zero é€šè¿‡æ‹¦æˆªè¯·æ±‚è·å–é“¾è·¯traceIDï¼Œç„¶ååœ¨ä¸­é—´ä»¶å‡½æ•°å…¥å£ä¼šåˆ†é…ä¸€ä¸ªæ ¹Spanï¼Œç„¶ååœ¨åç»­æ“ä½œä¸­ä¼šåˆ†è£‚å‡ºå­Spanï¼Œæ¯ä¸ªspanéƒ½æœ‰è‡ªå·±çš„å…·ä½“çš„æ ‡è¯†ï¼ŒFinshä¹‹åå°±ä¼šæ±‡é›†åœ¨é“¾è·¯è¿½è¸ªç³»ç»Ÿä¸­ã€‚å¼€å‘è€…å¯ä»¥é€šè¿‡ ELK å·¥å…·è¿½è¸ª traceID ï¼Œçœ‹åˆ°æ•´ä¸ªè°ƒç”¨é“¾ã€‚ åŒæ—¶ go-zero å¹¶æ²¡æœ‰æä¾›æ•´å¥— trace é“¾è·¯æ–¹æ¡ˆï¼Œå¼€å‘è€…å¯ä»¥å°è£… go-zero å·²æœ‰çš„ span ç»“æ„ï¼Œåšè‡ªå·±çš„ä¸ŠæŠ¥ç³»ç»Ÿï¼Œæ¥å…¥ jaeger, zipkin ç­‰é“¾è·¯è¿½è¸ªå·¥å…·ã€‚ å‚è€ƒ go-zero trace Copyright Â© 2019-2021 go-zero all right reservedï¼Œpowered by GitbookLast UpdateTimeï¼š 2025-05-05 05:44:52 "},"service-monitor.html":{"url":"service-monitor.html","title":"æœåŠ¡ç›‘æ§","keywords":"","body":"æœåŠ¡ç›‘æ§ åœ¨å¾®æœåŠ¡æ²»ç†ä¸­ï¼ŒæœåŠ¡ç›‘æ§ä¹Ÿæ˜¯éå¸¸é‡è¦çš„ä¸€ä¸ªç¯èŠ‚ï¼Œç›‘æ§ä¸€ä¸ªæœåŠ¡æ˜¯å¦æ­£å¸¸å·¥ä½œï¼Œéœ€è¦ä»å¤šç»´åº¦è¿›è¡Œï¼Œå¦‚ï¼š mysqlæŒ‡æ ‡ mongoæŒ‡æ ‡ redisæŒ‡æ ‡ è¯·æ±‚æ—¥å¿— æœåŠ¡æŒ‡æ ‡ç»Ÿè®¡ æœåŠ¡å¥åº·æ£€æµ‹ ... ç›‘æ§çš„å·¥ä½œéå¸¸å¤§ï¼Œæœ¬èŠ‚ä»…ä»¥å…¶ä¸­çš„æœåŠ¡æŒ‡æ ‡ç›‘æ§ä½œä¸ºä¾‹å­è¿›è¡Œè¯´æ˜ã€‚ åŸºäºprometheusçš„å¾®æœåŠ¡æŒ‡æ ‡ç›‘æ§ æœåŠ¡ä¸Šçº¿åæˆ‘ä»¬å¾€å¾€éœ€è¦å¯¹æœåŠ¡è¿›è¡Œç›‘æ§ï¼Œä»¥ä¾¿èƒ½åŠæ—©å‘ç°é—®é¢˜å¹¶åšé’ˆå¯¹æ€§çš„ä¼˜åŒ–ï¼Œç›‘æ§åˆå¯åˆ†ä¸ºå¤šç§å½¢å¼ï¼Œæ¯”å¦‚æ—¥å¿—ç›‘æ§ï¼Œè°ƒç”¨é“¾ç›‘æ§ï¼ŒæŒ‡æ ‡ç›‘æ§ç­‰ç­‰ã€‚è€Œé€šè¿‡æŒ‡æ ‡ç›‘æ§èƒ½æ¸…æ™°çš„è§‚å¯Ÿå‡ºæœåŠ¡æŒ‡æ ‡çš„å˜åŒ–è¶‹åŠ¿ï¼Œäº†è§£æœåŠ¡çš„è¿è¡ŒçŠ¶æ€ï¼Œå¯¹äºä¿è¯æœåŠ¡ç¨³å®šèµ·ç€éå¸¸é‡è¦çš„ä½œç”¨ prometheusæ˜¯ä¸€ä¸ªå¼€æºçš„ç³»ç»Ÿç›‘æ§å’Œå‘Šè­¦å·¥å…·ï¼Œæ”¯æŒå¼ºå¤§çš„æŸ¥è¯¢è¯­è¨€PromQLå…è®¸ç”¨æˆ·å®æ—¶é€‰æ‹©å’Œæ±‡èšæ—¶é—´åºåˆ—æ•°æ®ï¼Œæ—¶é—´åºåˆ—æ•°æ®æ˜¯æœåŠ¡ç«¯é€šè¿‡HTTPåè®®ä¸»åŠ¨æ‹‰å–è·å¾—ï¼Œä¹Ÿå¯ä»¥é€šè¿‡ä¸­é—´ç½‘å…³æ¥æ¨é€æ—¶é—´åºåˆ—æ•°æ®ï¼Œå¯ä»¥é€šè¿‡é™æ€é…ç½®æ–‡ä»¶æˆ–æœåŠ¡å‘ç°æ¥è·å–ç›‘æ§ç›®æ ‡ Prometheus çš„æ¶æ„ Prometheus çš„æ•´ä½“æ¶æ„ä»¥åŠç”Ÿæ€ç³»ç»Ÿç»„ä»¶å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š Prometheus Serverç›´æ¥ä»ç›‘æ§ç›®æ ‡ä¸­æˆ–è€…é—´æ¥é€šè¿‡æ¨é€ç½‘å…³æ¥æ‹‰å–ç›‘æ§æŒ‡æ ‡ï¼Œå®ƒåœ¨æœ¬åœ°å­˜å‚¨æ‰€æœ‰æŠ“å–åˆ°æ ·æœ¬æ•°æ®ï¼Œå¹¶å¯¹æ­¤æ•°æ®æ‰§è¡Œä¸€ç³»åˆ—è§„åˆ™ï¼Œä»¥æ±‡æ€»å’Œè®°å½•ç°æœ‰æ•°æ®çš„æ–°æ—¶é—´åºåˆ—æˆ–ç”Ÿæˆå‘Šè­¦ã€‚å¯ä»¥é€šè¿‡ Grafana æˆ–è€…å…¶ä»–å·¥å…·æ¥å®ç°ç›‘æ§æ•°æ®çš„å¯è§†åŒ– go-zeroåŸºäºprometheusçš„æœåŠ¡æŒ‡æ ‡ç›‘æ§ go-zero æ¡†æ¶ä¸­é›†æˆäº†åŸºäºprometheusçš„æœåŠ¡æŒ‡æ ‡ç›‘æ§ï¼Œä¸‹é¢æˆ‘ä»¬é€šè¿‡go-zeroå®˜æ–¹çš„ç¤ºä¾‹shorturlæ¥æ¼”ç¤ºæ˜¯å¦‚ä½•å¯¹æœåŠ¡æŒ‡æ ‡è¿›è¡Œæ”¶é›†ç›‘æ§çš„ï¼š ç¬¬ä¸€æ­¥éœ€è¦å…ˆå®‰è£…Prometheusï¼Œå®‰è£…æ­¥éª¤è¯·å‚è€ƒå®˜æ–¹æ–‡æ¡£ go-zeroé»˜è®¤ä¸å¼€å¯prometheusç›‘æ§ï¼Œå¼€å¯æ–¹å¼å¾ˆç®€å•ï¼Œåªéœ€è¦åœ¨shorturl-api.yamlæ–‡ä»¶ä¸­å¢åŠ é…ç½®å¦‚ä¸‹ï¼Œå…¶ä¸­Hostä¸ºPrometheus Serveråœ°å€ä¸ºå¿…å¡«é…ç½®ï¼ŒPortç«¯å£ä¸å¡«é»˜è®¤9091ï¼ŒPathä¸ºç”¨æ¥æ‹‰å–æŒ‡æ ‡çš„è·¯å¾„é»˜è®¤ä¸º/metrics Prometheus: Host: 127.0.0.1 Port: 9091 Path: /metrics ç¼–è¾‘prometheusçš„é…ç½®æ–‡ä»¶prometheus.ymlï¼Œæ·»åŠ å¦‚ä¸‹é…ç½®ï¼Œå¹¶åˆ›å»ºtargets.json - job_name: 'file_ds' file_sd_configs: - files: - targets.json ç¼–è¾‘targets.jsonæ–‡ä»¶ï¼Œå…¶ä¸­targetsä¸ºshorturlé…ç½®çš„ç›®æ ‡åœ°å€ï¼Œå¹¶æ·»åŠ äº†å‡ ä¸ªé»˜è®¤çš„æ ‡ç­¾ [ { \"targets\": [\"127.0.0.1:9091\"], \"labels\": { \"job\": \"shorturl-api\", \"app\": \"shorturl-api\", \"env\": \"test\", \"instance\": \"127.0.0.1:8888\" } } ] å¯åŠ¨prometheusæœåŠ¡ï¼Œé»˜è®¤ä¾¦å¬åœ¨9090ç«¯å£ $ prometheus --config.file=prometheus.yml åœ¨æµè§ˆå™¨è¾“å…¥http://127.0.0.1:9090/ï¼Œç„¶åç‚¹å‡»Status -> Targetså³å¯çœ‹åˆ°çŠ¶æ€ä¸ºUpçš„Jobï¼Œå¹¶ä¸”Lablesæ å¯ä»¥çœ‹åˆ°æˆ‘ä»¬é…ç½®çš„é»˜è®¤çš„æ ‡ç­¾ é€šè¿‡ä»¥ä¸Šå‡ ä¸ªæ­¥éª¤æˆ‘ä»¬å®Œæˆäº†prometheuså¯¹shorturlæœåŠ¡çš„æŒ‡æ ‡ç›‘æ§æ”¶é›†çš„é…ç½®å·¥ä½œï¼Œä¸ºäº†æ¼”ç¤ºç®€å•æˆ‘ä»¬è¿›è¡Œäº†æ‰‹åŠ¨çš„é…ç½®ï¼Œåœ¨å®é™…çš„ç”Ÿäº§ç¯å¢ƒä¸­ä¸€èˆ¬é‡‡ç”¨å®šæ—¶æ›´æ–°é…ç½®æ–‡ä»¶æˆ–è€…æœåŠ¡å‘ç°çš„æ–¹å¼æ¥é…ç½®ç›‘æ§ç›®æ ‡ï¼Œç¯‡å¹…æœ‰é™è¿™é‡Œä¸å±•å¼€è®²è§£ï¼Œæ„Ÿå…´è¶£çš„åŒå­¦è¯·è‡ªè¡ŒæŸ¥çœ‹ç›¸å…³æ–‡æ¡£ go-zeroç›‘æ§çš„æŒ‡æ ‡ç±»å‹ go-zeroç›®å‰åœ¨httpçš„ä¸­é—´ä»¶å’Œrpcçš„æ‹¦æˆªå™¨ä¸­æ·»åŠ äº†å¯¹è¯·æ±‚æŒ‡æ ‡çš„ç›‘æ§ã€‚ ä¸»è¦ä»è¯·æ±‚è€—æ—¶å’Œè¯·æ±‚é”™è¯¯ä¸¤ä¸ªç»´åº¦ï¼Œè¯·æ±‚è€—æ—¶é‡‡ç”¨äº†HistogramæŒ‡æ ‡ç±»å‹å®šä¹‰äº†å¤šä¸ªBucketsæ–¹ä¾¿è¿›è¡Œåˆ†ä½ç»Ÿè®¡ï¼Œè¯·æ±‚é”™è¯¯é‡‡ç”¨äº†Counterç±»å‹ï¼Œå¹¶åœ¨http metricä¸­æ·»åŠ äº†pathæ ‡ç­¾rpc metricä¸­æ·»åŠ äº†methodæ ‡ç­¾ä»¥ä¾¿è¿›è¡Œç»†åˆ†ç›‘æ§ã€‚ æ¥ä¸‹æ¥æ¼”ç¤ºå¦‚ä½•æŸ¥çœ‹ç›‘æ§æŒ‡æ ‡ï¼š é¦–å…ˆåœ¨å‘½ä»¤è¡Œå¤šæ¬¡æ‰§è¡Œå¦‚ä¸‹å‘½ä»¤ $ curl -i \"http://localhost:8888/shorten?url=http://www.xiaoheiban.cn\" æ‰“å¼€Prometheusåˆ‡æ¢åˆ°Graphç•Œé¢ï¼Œåœ¨è¾“å…¥æ¡†ä¸­è¾“å…¥{path=\"/shorten\"}æŒ‡ä»¤ï¼Œå³å¯æŸ¥çœ‹ç›‘æ§æŒ‡æ ‡ï¼Œå¦‚ä¸‹å›¾ æˆ‘ä»¬é€šè¿‡PromQLè¯­æ³•æŸ¥è¯¢è¿‡æ»¤pathä¸º/shortençš„æŒ‡æ ‡ï¼Œç»“æœä¸­æ˜¾ç¤ºäº†æŒ‡æ ‡åä»¥åŠæŒ‡æ ‡æ•°å€¼ï¼Œå…¶ä¸­http_server_requests_code_totalæŒ‡æ ‡ä¸­codeå€¼ä¸ºhttpçš„çŠ¶æ€ç ï¼Œ200è¡¨æ˜è¯·æ±‚æˆåŠŸï¼Œhttp_server_requests_duration_ms_bucketä¸­å¯¹ä¸åŒbucketç»“æœåˆ†åˆ«è¿›è¡Œäº†ç»Ÿè®¡ï¼Œè¿˜å¯ä»¥çœ‹åˆ°æ‰€æœ‰çš„æŒ‡æ ‡ä¸­éƒ½æ·»åŠ äº†æˆ‘ä»¬é…ç½®çš„é»˜è®¤æŒ‡æ ‡ Consoleç•Œé¢ä¸»è¦å±•ç¤ºäº†æŸ¥è¯¢çš„æŒ‡æ ‡ç»“æœï¼ŒGraphç•Œé¢ä¸ºæˆ‘ä»¬æä¾›äº†ç®€å•çš„å›¾å½¢åŒ–çš„å±•ç¤ºç•Œé¢ï¼Œåœ¨å®é™…çš„ç”Ÿäº§ç¯å¢ƒä¸­æˆ‘ä»¬ä¸€èˆ¬ä½¿ç”¨Grafanaåšå›¾å½¢åŒ–çš„å±•ç¤º grafanaå¯è§†åŒ–ç•Œé¢ grafanaæ˜¯ä¸€æ¬¾å¯è§†åŒ–å·¥å…·ï¼ŒåŠŸèƒ½å¼ºå¤§ï¼Œæ”¯æŒå¤šç§æ•°æ®æ¥æºPrometheusã€Elasticsearchã€Graphiteç­‰ï¼Œå®‰è£…æ¯”è¾ƒç®€å•è¯·å‚è€ƒå®˜æ–¹æ–‡æ¡£ï¼Œgrafanaé»˜è®¤ç«¯å£3000ï¼Œå®‰è£…å¥½åå†æµè§ˆå™¨è¾“å…¥http://localhost:3000/ï¼Œé»˜è®¤è´¦å·å’Œå¯†ç éƒ½ä¸ºadmin ä¸‹é¢æ¼”ç¤ºå¦‚ä½•åŸºäºä»¥ä¸ŠæŒ‡æ ‡è¿›è¡Œå¯è§†åŒ–ç•Œé¢çš„ç»˜åˆ¶ï¼š ç‚¹å‡»å·¦ä¾§è¾¹æ Configuration->Data Source->Add data sourceè¿›è¡Œæ•°æ®æºæ·»åŠ ï¼Œå…¶ä¸­HTTPçš„URLä¸ºæ•°æ®æºçš„åœ°å€ ç‚¹å‡»å·¦ä¾§è¾¹æ æ·»åŠ dashboardï¼Œç„¶åæ·»åŠ Variablesæ–¹ä¾¿é’ˆå¯¹ä¸åŒçš„æ ‡ç­¾è¿›è¡Œè¿‡æ»¤ç­›é€‰æ¯”å¦‚æ·»åŠ appå˜é‡ç”¨æ¥è¿‡æ»¤ä¸åŒçš„æœåŠ¡ è¿›å…¥dashboardç‚¹å‡»å³ä¸Šè§’Add panelæ·»åŠ é¢æ¿ï¼Œä»¥pathç»´åº¦ç»Ÿè®¡æ¥å£çš„qps æœ€ç»ˆçš„æ•ˆæœå¦‚ä¸‹æ‰€ç¤ºï¼Œå¯ä»¥é€šè¿‡æœåŠ¡åç§°è¿‡æ»¤ä¸åŒçš„æœåŠ¡ï¼Œé¢æ¿å±•ç¤ºäº†pathä¸º/shortençš„qpså˜åŒ–è¶‹åŠ¿ æ€»ç»“ ä»¥ä¸Šæ¼”ç¤ºäº†go-zeroä¸­åŸºäºprometheus+grafanaæœåŠ¡æŒ‡æ ‡ç›‘æ§çš„ç®€å•æµç¨‹ï¼Œç”Ÿäº§ç¯å¢ƒä¸­å¯ä»¥æ ¹æ®å®é™…çš„åœºæ™¯åšä¸åŒç»´åº¦çš„ç›‘æ§åˆ†æã€‚ç°åœ¨go-zeroçš„ç›‘æ§æŒ‡æ ‡ä¸»è¦è¿˜æ˜¯é’ˆå¯¹httpå’Œrpcï¼Œè¿™å¯¹äºæœåŠ¡çš„æ•´ä½“ç›‘æ§æ˜¾ç„¶è¿˜æ˜¯ä¸è¶³çš„ï¼Œæ¯”å¦‚å®¹å™¨èµ„æºçš„ç›‘æ§ï¼Œä¾èµ–çš„mysqlã€redisç­‰èµ„æºçš„ç›‘æ§ï¼Œä»¥åŠè‡ªå®šä¹‰çš„æŒ‡æ ‡ç›‘æ§ç­‰ç­‰ï¼Œgo-zeroåœ¨è¿™æ–¹é¢åç»­è¿˜ä¼šæŒç»­ä¼˜åŒ–ã€‚å¸Œæœ›è¿™ç¯‡æ–‡ç« èƒ½å¤Ÿç»™æ‚¨å¸¦æ¥å¸®åŠ© Copyright Â© 2019-2021 go-zero all right reservedï¼Œpowered by GitbookLast UpdateTimeï¼š 2025-05-05 05:44:52 "},"goctl.html":{"url":"goctl.html","title":"Goctl","keywords":"","body":"Goctl goctlæ˜¯go-zeroå¾®æœåŠ¡æ¡†æ¶ä¸‹çš„ä»£ç ç”Ÿæˆå·¥å…·ã€‚ä½¿ç”¨ goctl å¯æ˜¾è‘—æå‡å¼€å‘æ•ˆç‡ï¼Œè®©å¼€å‘äººå‘˜å°†æ—¶é—´é‡ç‚¹æ”¾åœ¨ä¸šåŠ¡å¼€å‘ä¸Šï¼Œå…¶åŠŸèƒ½æœ‰ï¼š apiæœåŠ¡ç”Ÿæˆ rpcæœåŠ¡ç”Ÿæˆ modelä»£ç ç”Ÿæˆ æ¨¡æ¿ç®¡ç† æœ¬èŠ‚å°†åŒ…å«ä»¥ä¸‹å†…å®¹ï¼š è‡ªåŠ¨è¡¥å…¨è®¾ç½® å‘½ä»¤å¤§å…¨ apiå‘½ä»¤ rpcå‘½ä»¤ modelå‘½ä»¤ pluginå‘½ä»¤ å…¶ä»–å‘½ä»¤ goctl è¯»éŸ³ å¾ˆå¤šäººä¼šæŠŠ goctl è¯»ä½œ go-C-T-Lï¼Œè¿™ç§æ˜¯é”™è¯¯çš„å¿µæ³•ï¼Œåº”å‚ç…§ go control è¯»åš É¡Å kÉ™nËˆtrÅlã€‚ æŸ¥çœ‹ç‰ˆæœ¬ä¿¡æ¯ $ goctl -v å¦‚æœå®‰è£…äº†goctlåˆ™ä¼šè¾“å‡ºä»¥ä¸‹æ ¼å¼çš„æ–‡æœ¬ä¿¡æ¯ï¼š goctl version ${version} ${os}/${arch} ä¾‹å¦‚è¾“å‡ºï¼š goctl version 1.1.5 darwin/amd64 ç‰ˆæœ¬å·è¯´æ˜ versionï¼šgoctl ç‰ˆæœ¬å· osï¼šå½“å‰æ“ä½œç³»ç»Ÿåç§° archï¼š å½“å‰ç³»ç»Ÿæ¶æ„åç§° å®‰è£… goctl æ–¹å¼ä¸€ï¼ˆgo getï¼‰ # Go 1.15 åŠä¹‹å‰ç‰ˆæœ¬ GO111MODULE=on GOPROXY=https://goproxy.cn/,direct go get -u github.com/zeromicro/go-zero/tools/goctl@latest # Go 1.16 åŠä»¥åç‰ˆæœ¬ GOPROXY=https://goproxy.cn/,direct go install github.com/zeromicro/go-zero/tools/goctl@latest é€šè¿‡æ­¤å‘½ä»¤å¯ä»¥å°†goctlå·¥å…·å®‰è£…åˆ° $GOPATH/bin ç›®å½•ä¸‹ æ–¹å¼äºŒ ï¼ˆfork and buildï¼‰ ä» go-zeroä»£ç ä»“åº“ git@github.com:zeromicro/go-zero.git æ‹‰å–ä¸€ä»½æºç ï¼Œè¿›å…¥ tools/goctl/ç›®å½•ä¸‹ç¼–è¯‘ä¸€ä¸‹ goctl æ–‡ä»¶ï¼Œç„¶åå°†å…¶æ·»åŠ åˆ°ç¯å¢ƒå˜é‡ä¸­ã€‚ å®‰è£…å®Œæˆåæ‰§è¡Œgoctl -vï¼Œå¦‚æœè¾“å‡ºç‰ˆæœ¬ä¿¡æ¯åˆ™ä»£è¡¨å®‰è£…æˆåŠŸï¼Œä¾‹å¦‚ï¼š $ goctl -v goctl version 1.1.4 darwin/amd64 å¸¸è§é—®é¢˜ command not found: goctl è¯·ç¡®ä¿goctlå·²ç»å®‰è£…ï¼Œæˆ–è€…goctlæ˜¯å¦å·²ç»æ­£ç¡®æ·»åŠ åˆ°å½“å‰shellçš„ç¯å¢ƒå˜é‡ä¸­ã€‚ Copyright Â© 2019-2021 go-zero all right reservedï¼Œpowered by GitbookLast UpdateTimeï¼š 2025-05-05 05:44:52 "},"goctl-completion.html":{"url":"goctl-completion.html","title":"è‡ªåŠ¨è¡¥å…¨è®¾ç½®","keywords":"","body":"goctlè‡ªåŠ¨è¡¥å…¨ goctl è‡ªåŠ¨è¡¥å…¨ä»…æ”¯æŒ unix-like æ“ä½œç³»ç»Ÿ ç”¨æ³• $ goctl completion -h NAME: goctl completion - generation completion script, it only works for unix-like OS USAGE: goctl completion [command options] [arguments...] OPTIONS: --name value, -n value the filename of auto complete script, default is [goctl_autocomplete] ç”Ÿæˆè‡ªåŠ¨è¡¥å…¨æ–‡ä»¶ $ goctl completion generation auto completion success! executes the following script to setting shell: echo PROG=goctl source /Users/keson/.goctl/.auto_complete/zsh/goctl_autocomplete >> ~/.zshrc && source ~/.zshrc or echo PROG=goctl source /Users/keson/.goctl/.auto_complete/bash/goctl_autocomplete >> ~/.bashrc && source ~/.bashrc shell é…ç½® zsh$ echo PROG=goctl source /Users/keson/.goctl/.auto_complete/zsh/goctl_autocomplete >> ~/.zshrc && source ~/.zshrc bash$ echo PROG=goctl source /Users/keson/.goctl/.auto_complete/bash/goctl_autocomplete >> ~/.bashrc && source ~/.bashrc æ¼”ç¤ºæ•ˆæœ ä½¿ç”¨ tab é”®å‡ºç°è‡ªåŠ¨è¡¥å…¨æç¤º $ goctl api -- generate api related files bug -- report a bug completion -- generation completion script, it only works for unix-like OS docker -- generate Dockerfile help h -- Shows a list of commands or help for one command kube -- generate kubernetes files migrate -- migrate from tal-tech to zeromicro model -- generate model code rpc -- generate rpc code template -- template operation upgrade -- upgrade goctl to latest version Copyright Â© 2019-2021 go-zero all right reservedï¼Œpowered by GitbookLast UpdateTimeï¼š 2025-05-05 05:44:52 "},"goctl-commands.html":{"url":"goctl-commands.html","title":"å‘½ä»¤å¤§å…¨","keywords":"","body":"goctlå‘½ä»¤å¤§å…¨ goctl bug ï¼ˆæŠ¥å‘Šä¸€ä¸ªé”™è¯¯ï¼‰ upgrade ï¼ˆå°†goctlå‡çº§åˆ°æœ€æ–°ç‰ˆæœ¬ï¼‰ env ï¼ˆæ£€æŸ¥æˆ–ç¼–è¾‘goctlç¯å¢ƒï¼‰ --write, -w: ç¼–è¾‘goctlç¯å¢ƒ check ï¼ˆæ£€æµ‹goctlç¯å¢ƒå’Œä¾èµ–æ€§å·¥å…·ï¼‰ --force, -f: é»˜è®¸å®‰è£…ä¸å­˜åœ¨çš„ä¾èµ–é¡¹ --install, -i: å¦‚æœæ²¡æœ‰æ‰¾åˆ°ï¼Œå°±å®‰è£…ä¾èµ–å·¥å…· migrate ï¼ˆä»tal-techè¿ç§»åˆ°zeromicroï¼‰ --verbose, -v: verboseå¯ä»¥å®ç°é¢å¤–çš„æ—¥å¿—è®°å½• --version: è¦è¿ç§»çš„github.com/zeromicro/go-zeroçš„ç›®æ ‡ç‰ˆæœ¬ã€‚ api ï¼ˆç”Ÿæˆapiç›¸å…³æ–‡ä»¶ï¼‰ --branchï¼šè¿œç¨‹ç‰ˆæœ¬åº“çš„åˆ†æ”¯ï¼Œå®ƒä¸--remoteä¸€èµ·å·¥ä½œã€‚ --homeï¼šæ¨¡æ¿çš„goctlé¦–é¡µè·¯å¾„ï¼Œ--homeå’Œ--remoteä¸èƒ½åŒæ—¶è®¾ç½®ï¼Œå¦‚æœå®ƒä»¬åŒæ—¶è®¾ç½®ï¼Œ--remoteçš„ä¼˜å…ˆçº§æ›´é«˜ --remoteï¼šæ¨¡æ¿çš„è¿œç¨‹git repoï¼Œ--homeå’Œ--remoteä¸èƒ½åŒæ—¶è®¾ç½®ï¼Œå¦‚æœåŒæ—¶è®¾ç½®ï¼Œ--remoteçš„ä¼˜å…ˆçº§æ›´é«˜ git repoç›®å½•å¿…é¡»ä¸https://github.com/zeromicro/go-zero-template ç›®å½•ç»“æ„ä¸€è‡´ -oï¼šè¾“å‡ºapiæ–‡ä»¶ new ï¼ˆå¿«é€Ÿåˆ›å»ºapiæœåŠ¡ï¼‰ --branchï¼šè¿œç¨‹repoçš„åˆ†æ”¯ï¼Œå®ƒä¸--remoteä¸€èµ·å·¥ä½œã€‚ --home: æ¨¡æ¿çš„goctlé¦–é¡µè·¯å¾„ï¼Œ--homeå’Œ--remoteä¸èƒ½åŒæ—¶è®¾ç½®ï¼Œå¦‚æœè®¾ç½®äº†ï¼Œ--remoteçš„ä¼˜å…ˆçº§æ›´é«˜ --remoteï¼šæ¨¡æ¿çš„è¿œç¨‹git repoï¼Œ--homeå’Œ--remoteä¸èƒ½åŒæ—¶è®¾ç½®ï¼Œå¦‚æœåŒæ—¶è®¾ç½®ï¼Œ--remoteçš„ä¼˜å…ˆçº§æ›´é«˜ git repoç›®å½•å¿…é¡»ä¸https://github.com/zeromicro/go-zero-template ç›®å½•ç»“æ„ä¸€è‡´ --styleï¼šæ–‡ä»¶çš„å‘½åæ ¼å¼ï¼Œè§[https://github.com/zeromicro/go-zero/blob/master/tools/goctl/config/readme.md] format ï¼ˆæ ¼å¼åŒ–apiæ–‡ä»¶ï¼‰ --declareï¼šç”¨äºè·³è¿‡æ£€æŸ¥å·²ç»å£°æ˜çš„apiç±»å‹ --dir: æ ¼å¼ç›®æ ‡ç›®å½• --iu: å¿½ç•¥æ›´æ–° --stdinï¼šä½¿ç”¨stdinè¾“å…¥apiæ–‡ä»¶å†…å®¹ï¼ŒæŒ‰ \"ctrl + d \"å‘é€EOFã€‚ validate ï¼ˆéªŒè¯apiæ–‡ä»¶ï¼‰ --api: éªŒè¯ç›®æ ‡apiæ–‡ä»¶ doc ï¼ˆç”Ÿæˆæ–‡æ¡£æ–‡ä»¶ï¼‰ --dir: ç›®æ ‡ç›®å½• --o: è¾“å‡ºmarkdownç›®å½• go ï¼ˆæä¾›çš„apiç”Ÿæˆgoæ–‡ä»¶ï¼‰ --api: apiæ–‡ä»¶ --branch: è¿œç¨‹ repo çš„åˆ†æ”¯ï¼Œå®ƒä¸ --remote ä¸€èµ·å·¥ä½œã€‚ --dir: ç›®æ ‡ç›®å½• --home: æ¨¡æ¿çš„goctlé¦–é¡µè·¯å¾„ï¼Œ--homeå’Œ--remoteä¸èƒ½åŒæ—¶è®¾ç½®ï¼Œå¦‚æœå®ƒä»¬åŒæ—¶è®¾ç½®ï¼Œ--remoteçš„ä¼˜å…ˆçº§æ›´é«˜ --remoteï¼šæ¨¡æ¿çš„è¿œç¨‹git repoï¼Œ--homeå’Œ--remoteä¸èƒ½åŒæ—¶è®¾ç½®ï¼Œå¦‚æœåŒæ—¶è®¾ç½®ï¼Œ--remoteçš„ä¼˜å…ˆçº§æ›´é«˜ git repoç›®å½•å¿…é¡»ä¸https://github.com/zeromicro/go-zero-template ç›®å½•ç»“æ„ä¸€è‡´ --styleï¼šæ–‡ä»¶çš„å‘½åæ ¼å¼ï¼Œè§[https://github.com/zeromicro/go-zero/tree/master/tools/goctl/config/readme.md] java ï¼ˆä¸ºapiæ–‡ä»¶ä¸­æä¾›çš„apiç”Ÿæˆjavaæ–‡ä»¶ï¼‰ --api: apiæ–‡ä»¶ --dir: ç›®æ ‡ç›®å½• ts ï¼ˆä¸ºapiæ–‡ä»¶ä¸­æä¾›çš„apiç”Ÿæˆtsæ–‡ä»¶ï¼‰ --api: apiæ–‡ä»¶ --caller: ç½‘ç»œapiè°ƒç”¨è€… --dir: ç›®æ ‡ç›®å½• --unwrap: è§£é™¤webapiè°ƒç”¨å™¨çš„åŒ…è£…ï¼Œä»¥ä¾¿å¯¼å…¥ --webapi: web apiæ–‡ä»¶çš„è·¯å¾„ dart ï¼ˆä¸ºapiæ–‡ä»¶ä¸­æä¾›çš„apiç”Ÿæˆdartæ–‡ä»¶ï¼‰ --api: apiæ–‡ä»¶ --dir: ç›®æ ‡ç›®å½• --hostname: æœåŠ¡å™¨çš„ä¸»æœºå --legacy: ç”¨äºflutter v1çš„ä¼ ç»Ÿç”Ÿæˆå™¨ kt ï¼ˆä¸ºæä¾›çš„apiæ–‡ä»¶ç”Ÿæˆkotlinä»£ç ï¼‰ --api: apiæ–‡ä»¶ --dir: ç›®æ ‡ç›®å½• --pkg: å®šä¹‰kotlinæ–‡ä»¶çš„åŒ…å plugin ï¼ˆè‡ªå®šä¹‰æ–‡ä»¶ç”Ÿæˆå™¨ï¼‰ --api: apiæ–‡ä»¶ --dir: ç›®æ ‡ç›®å½• --plugin, -p: æ’ä»¶æ–‡ä»¶ --style: æ–‡ä»¶çš„å‘½åæ ¼å¼ï¼Œè§[https://github.com/zeromicro/go-zero/tree/master/tools/goctl/config/readme.md] docker ï¼ˆç”ŸæˆDockeræ–‡ä»¶ï¼‰ --branchï¼šè¿œç¨‹ç‰ˆæœ¬åº“çš„åˆ†æ”¯ï¼Œå®ƒä¸--remoteä¸€èµ·å·¥ä½œã€‚ --goï¼šåŒ…å«ä¸»å‡½æ•°çš„æ–‡ä»¶ --homeï¼šæ¨¡æ¿çš„goctlé¦–é¡µè·¯å¾„ï¼Œ--homeå’Œ--remoteä¸èƒ½åŒæ—¶è®¾ç½®ï¼Œå¦‚æœå®ƒä»¬åŒæ—¶è®¾ç½®ï¼Œ--remoteçš„ä¼˜å…ˆçº§æ›´é«˜ --portï¼šè¦å…¬å¼€çš„ç«¯å£ï¼Œé»˜è®¤ä¸ºæ— ï¼ˆé»˜è®¤ï¼š0ï¼‰ã€‚ --remoteï¼šæ¨¡æ¿çš„è¿œç¨‹git repoï¼Œ--homeå’Œ--remoteä¸èƒ½åŒæ—¶è®¾ç½®ï¼Œå¦‚æœå®ƒä»¬åŒæ—¶è®¾ç½®ï¼Œ--remoteçš„ä¼˜å…ˆçº§æ›´é«˜ã€‚ git repoç›®å½•å¿…é¡»ä¸https://github.com/zeromicro/go-zero-template ç›®å½•ç»“æ„ä¸€è‡´ --scratchï¼šä½¿ç”¨scratchä½œä¸ºåŸºç¡€dockeré•œåƒ --tzï¼šå®¹å™¨çš„æ—¶åŒºï¼ˆé»˜è®¤ï¼šäºšæ´²/ä¸Šæµ·ï¼‰ --versionï¼šgoctl builder golangé•œåƒçš„ç‰ˆæœ¬ã€‚ kube ï¼ˆç”Ÿæˆkubernetesæ–‡ä»¶ï¼‰ deploy ï¼ˆç”Ÿæˆéƒ¨ç½²yamlæ–‡ä»¶ï¼‰ --branchï¼šè¿œç¨‹repoçš„åˆ†æ”¯ï¼Œå®ƒä¸--remoteä¸€èµ·å·¥ä½œã€‚ --homeï¼šæ¨¡æ¿çš„goctlé¦–é¡µè·¯å¾„ï¼Œ--homeå’Œ--remoteä¸èƒ½åŒæ—¶è®¾ç½®ï¼Œå¦‚æœè®¾ç½®äº†ï¼Œ--remoteçš„ä¼˜å…ˆçº§æ›´é«˜ --imageï¼šéƒ¨ç½²çš„dockeré•œåƒ --limitCpuï¼šéƒ¨ç½²çš„cpuä¸Šé™ï¼ˆé»˜è®¤ä¸º1000ï¼‰ã€‚ --limitMem: éƒ¨ç½²çš„å†…å­˜ä¸Šé™ï¼ˆé»˜è®¤ä¸º1024ï¼‰ã€‚ --maxReplicas: éƒ¨ç½²çš„æœ€å¤§å¤åˆ¶æ•°ï¼ˆé»˜è®¤ä¸º10ï¼‰ã€‚ --minReplicas: éƒ¨ç½²çš„æœ€å°å¤åˆ¶é‡ï¼ˆé»˜è®¤ä¸º3ï¼‰ã€‚ --nameï¼šéƒ¨ç½²çš„åç§° --namespaceï¼šéƒ¨ç½²çš„å‘½åç©ºé—´ --nodePort: è¦å…¬å¼€çš„éƒ¨ç½²çš„nodePortï¼ˆé»˜è®¤ä¸º0ï¼‰ã€‚ --port: è¦åœ¨podä¸Šç›‘å¬çš„éƒ¨ç½²çš„ç«¯å£ï¼ˆé»˜è®¤å€¼ï¼š0ï¼‰ --remoteï¼šæ¨¡æ¿çš„è¿œç¨‹git repoï¼Œ--homeå’Œ--remoteä¸èƒ½åŒæ—¶è®¾ç½®ï¼Œå¦‚æœå®ƒä»¬åŒæ—¶è®¾ç½®ï¼Œ--remoteæœ‰æ›´é«˜çš„ä¼˜å…ˆçº§ã€‚ git repoç›®å½•å¿…é¡»ä¸https://github.com/zeromicro/go-zero-template ç›®å½•ç»“æ„ä¸€è‡´ --replicasï¼šè¦éƒ¨ç½²çš„å‰¯æœ¬æ•°é‡ï¼ˆé»˜è®¤ï¼š3ä¸ªï¼‰ã€‚ --requestCpuï¼šè¦éƒ¨ç½²çš„è¯·æ±‚cpuï¼ˆé»˜è®¤ä¸º500ï¼‰ã€‚ --requestMem: è¦éƒ¨ç½²çš„è¯·æ±‚å†…å­˜ï¼ˆé»˜è®¤ä¸º512ï¼‰ã€‚ --revisions: é™åˆ¶ä¿®è®¢å†å²çš„æ•°é‡ï¼ˆé»˜è®¤ä¸º5ï¼‰ã€‚ --secret: ä»æ³¨å†Œè¡¨ä¸­æå–é•œåƒçš„ç§˜å¯†ã€‚ --serviceAccountï¼šéƒ¨ç½²çš„ServiceAccountã€‚ -o: è¾“å‡ºçš„yamlæ–‡ä»¶ rpc ï¼ˆç”Ÿæˆrpcä»£ç ï¼‰ new ï¼ˆç”Ÿæˆrpcæ¼”ç¤ºæœåŠ¡ï¼‰ --branch: è¿œç¨‹ç‰ˆæœ¬åº“çš„åˆ†æ”¯ï¼Œå®ƒä¸--remoteä¸€èµ·å·¥ä½œã€‚ --homeï¼šæ¨¡æ¿çš„goctlé¦–é¡µè·¯å¾„ï¼Œ--homeå’Œ--remoteä¸èƒ½åŒæ—¶è®¾ç½®ï¼Œå¦‚æœåŒæ—¶è®¾ç½®ï¼Œ--remoteçš„ä¼˜å…ˆçº§æ›´é«˜ --ideaï¼šå‘½ä»¤æ‰§è¡Œç¯å¢ƒæ˜¯å¦æ¥è‡ªideaæ’ä»¶ã€‚[å¯é€‰] --remoteï¼šæ¨¡æ¿çš„è¿œç¨‹git repoï¼Œ--homeå’Œ--remoteä¸èƒ½åŒæ—¶è®¾ç½®ï¼Œå¦‚æœåŒæ—¶è®¾ç½®ï¼Œ--remoteçš„ä¼˜å…ˆçº§æ›´é«˜ git repoç›®å½•å¿…é¡»ä¸https://github.com/zeromicro/go-zero-template ç›®å½•ç»“æ„ä¸€è‡´ --styleï¼šæ–‡ä»¶çš„å‘½åæ ¼å¼ï¼Œè§[https://github.com/zeromicro/go-zero/tree/master/tools/goctl/config/readme.md] template ï¼ˆç”Ÿæˆprotoæ¨¡æ¿ï¼‰ --branchï¼šè¿œç¨‹repoçš„åˆ†æ”¯ï¼Œå®ƒä¸--remoteä¸€èµ·å·¥ä½œã€‚ --homeï¼šæ¨¡æ¿çš„goctlä¸»è·¯å¾„ï¼Œ--homeå’Œ--remoteä¸èƒ½åŒæ—¶è®¾ç½®ï¼Œå¦‚æœè®¾ç½®äº†ï¼Œ--remoteçš„ä¼˜å…ˆçº§æ›´é«˜ --out, -o: protoçš„ç›®æ ‡è·¯å¾„ --remoteï¼šæ¨¡æ¿çš„è¿œç¨‹git repoï¼Œ--homeå’Œ--remoteä¸èƒ½åŒæ—¶è®¾ç½®ï¼Œå¦‚æœæœ‰çš„è¯ï¼Œ--remoteçš„ä¼˜å…ˆçº§æ›´é«˜ git repoç›®å½•å¿…é¡»ä¸https://github.com/zeromicro/go-zero-template ç›®å½•ç»“æ„ä¸€è‡´ protoc ï¼ˆç”Ÿæˆgrpcä»£ç ï¼‰ --branchï¼šè¿œç¨‹repoçš„åˆ†æ”¯ï¼Œå®ƒä¸--remoteä¸€èµ·å·¥ä½œã€‚ --home: æ¨¡æ¿çš„goctlä¸»è·¯å¾„ --remote: æ¨¡æ¿çš„è¿œç¨‹git repoï¼Œ--homeå’Œ--remoteä¸èƒ½åŒæ—¶è®¾ç½®ï¼Œå¦‚æœå®ƒä»¬åŒæ—¶è®¾ç½®ï¼Œ--remoteçš„ä¼˜å…ˆçº§æ›´é«˜ã€‚ git repoç›®å½•å¿…é¡»ä¸https://github.com/zeromicro/go-zero-template ç›®å½•ç»“æ„ä¸€è‡´ --styleï¼šæ–‡ä»¶çš„å‘½åæ ¼å¼ï¼Œè§[https://github.com/zeromicro/go-zero/tree/master/tools/goctl/config/readme.md] --zrpc_outï¼šzrpcçš„è¾“å‡ºç›®å½• model ï¼ˆç”Ÿæˆmodelä»£ç ï¼‰ mysql ï¼ˆç”Ÿæˆmysqlæ¨¡å‹ï¼‰ ddl ï¼ˆä»ddlç”Ÿæˆmysqlæ¨¡å‹ï¼‰ - --branchï¼šè¿œç¨‹ repo çš„åˆ†æ”¯ï¼Œå®ƒä¸ --remote ä¸€èµ·å·¥ä½œã€‚ - --cache, -cï¼šç”Ÿæˆå¸¦æœ‰ç¼“å­˜çš„ä»£ç [å¯é€‰] ã€‚ - --database, --dbï¼šæ•°æ®åº“çš„åç§° [å¯é€‰] - --dir, -d: ç›®æ ‡ç›®å½• - --homeï¼šæ¨¡æ¿çš„goctlé¦–é¡µè·¯å¾„ï¼Œ--homeå’Œ--remoteä¸èƒ½åŒæ—¶è®¾ç½®ï¼Œå¦‚æœè®¾ç½®äº†ï¼Œ--remoteçš„ä¼˜å…ˆçº§æ›´é«˜ - --ideaï¼šç”¨äºç†å¿µæ’ä»¶[å¯é€‰] - --remoteï¼šæ¨¡æ¿çš„è¿œç¨‹git repoï¼Œ--homeå’Œ--remoteä¸èƒ½åŒæ—¶è®¾ç½®ï¼Œå¦‚æœåŒæ—¶è®¾ç½®ï¼Œ--remoteçš„ä¼˜å…ˆçº§æ›´é«˜ git repoç›®å½•å¿…é¡»ä¸https://github.com/zeromicro/go-zero-template ç›®å½•ç»“æ„ä¸€è‡´ --src, -sï¼šddlçš„è·¯å¾„æˆ–è·¯å¾„globbingæ¨¡å¼ --styleï¼šæ–‡ä»¶çš„å‘½åæ ¼å¼ï¼Œè§[https://github.com/zeromicro/go-zero/tree/master/tools/goctl/config/readme.md] datasource ï¼ˆä»æ•°æ®æºç”Ÿæˆæ¨¡å‹ï¼‰ - --branchï¼šè¿œç¨‹ repo çš„åˆ†æ”¯ï¼Œå®ƒä¸ --remote ä¸€èµ·å·¥ä½œã€‚ - --cache, -c: ä½¿ç”¨ç¼“å­˜ç”Ÿæˆä»£ç  [å¯é€‰] - --dir, -dï¼šç›®æ ‡ç›®å½• - --homeï¼šæ¨¡æ¿çš„goctlé¦–é¡µè·¯å¾„ï¼Œ--homeå’Œ--remoteä¸èƒ½åŒæ—¶è®¾ç½®ï¼Œå¦‚æœå®ƒä»¬åŒæ—¶è®¾ç½®ï¼Œ--remoteçš„ä¼˜å…ˆçº§æ›´é«˜ - --ideaï¼šç”¨äºç†å¿µæ’ä»¶[å¯é€‰] - --remoteï¼šæ¨¡æ¿çš„è¿œç¨‹git repoï¼Œ--homeå’Œ--remoteä¸èƒ½åŒæ—¶è®¾ç½®ï¼Œå¦‚æœåŒæ—¶è®¾ç½®ï¼Œ--remoteçš„ä¼˜å…ˆçº§æ›´é«˜ git repoç›®å½•å¿…é¡»ä¸https://github.com/zeromicro/go-zero-template ç›®å½•ç»“æ„ä¸€è‡´ --styleï¼šæ–‡ä»¶çš„å‘½åæ ¼å¼ï¼Œè§[https://github.com/zeromicro/go-zero/tree/master/tools/goctl/config/readme.md] --table, -tï¼šæ•°æ®åº“ä¸­çš„è¡¨æˆ–è¡¨çƒåŒ–æ¨¡å¼ --urlï¼šæ•°æ®åº“çš„æ•°æ®æºï¼Œå¦‚ \"root:password@tcp(127.0.0.1:3306)/database\" pg ï¼ˆç”Ÿæˆpostgresqlæ¨¡å‹ï¼‰ datasource ï¼ˆä»æ•°æ®æºç”Ÿæˆæ¨¡å‹ï¼‰ - --branchï¼šè¿œç¨‹ repo çš„åˆ†æ”¯ï¼Œå®ƒä¸ --remote ä¸€èµ·å·¥ä½œã€‚ - --cache, -cï¼šç”Ÿæˆå¸¦æœ‰ç¼“å­˜çš„ä»£ç [å¯é€‰] ã€‚ - --dir, -dï¼šç›®æ ‡ç›®å½• - --homeï¼šæ¨¡æ¿çš„goctlé¦–é¡µè·¯å¾„ï¼Œ--homeå’Œ--remoteä¸èƒ½åŒæ—¶è®¾ç½®ï¼Œå¦‚æœå®ƒä»¬åŒæ—¶è®¾ç½®ï¼Œ--remoteçš„ä¼˜å…ˆçº§æ›´é«˜ - --ideaï¼šç”¨äºç†å¿µæ’ä»¶[å¯é€‰] - --remoteï¼šæ¨¡æ¿çš„è¿œç¨‹git repoï¼Œ--homeå’Œ--remoteä¸èƒ½åŒæ—¶è®¾ç½®ï¼Œå¦‚æœåŒæ—¶è®¾ç½®ï¼Œ--remoteçš„ä¼˜å…ˆçº§æ›´é«˜ git repoç›®å½•å¿…é¡»ä¸https://github.com/zeromicro/go-zero-template ç›®å½•ç»“æ„ä¸€è‡´ --schema, -sï¼šè¡¨çš„æ¨¡å¼ï¼Œé»˜è®¤ä¸º[public] --styleï¼šæ–‡ä»¶çš„å‘½åæ ¼å¼ï¼Œè§[https://github.com/zeromicro/go-zero/tree/master/tools/goctl/config/readme.md] --table, -t: æ•°æ®åº“ä¸­çš„è¡¨æˆ–è¡¨çƒåŒ–æ¨¡å¼ --urlï¼šæ•°æ®åº“çš„æ•°æ®æºï¼Œå¦‚ \"postgres://root:password@127.0.0.1:5432/database?sslmode=disable\" mongo ï¼ˆç”Ÿæˆmongoæ¨¡å‹ï¼‰ --branchï¼šè¿œç¨‹repoçš„åˆ†æ”¯ï¼Œå®ƒä¸--remoteä¸€èµ·å·¥ä½œã€‚ --cache, -c: ä½¿ç”¨ç¼“å­˜ç”Ÿæˆä»£ç  [å¯é€‰] --dir, -dï¼šç›®æ ‡ç›®å½• --homeï¼šæ¨¡æ¿çš„goctlé¦–é¡µè·¯å¾„ï¼Œ--homeå’Œ--remoteä¸èƒ½åŒæ—¶è®¾ç½®ï¼Œå¦‚æœå®ƒä»¬åŒæ—¶è®¾ç½®ï¼Œ--remoteçš„ä¼˜å…ˆçº§æ›´é«˜ --remoteï¼šæ¨¡æ¿çš„è¿œç¨‹git repoï¼Œ--homeå’Œ--remoteä¸èƒ½åŒæ—¶è®¾ç½®ï¼Œå¦‚æœåŒæ—¶è®¾ç½®ï¼Œ--remoteçš„ä¼˜å…ˆçº§æ›´é«˜ git repoç›®å½•å¿…é¡»ä¸https://github.com/zeromicro/go-zero-template ç›®å½•ç»“æ„ä¸€è‡´ --styleï¼šæ–‡ä»¶çš„å‘½åæ ¼å¼ï¼Œè§[https://github.com/zeromicro/go-zero/tree/master/tools/goctl/config/readme.md] --type, -tï¼šæŒ‡å®šçš„æ¨¡å‹ç±»å‹åç§° template ï¼ˆæ¨¡æ¿æ“ä½œï¼‰ init ï¼ˆåˆå§‹åŒ–æ‰€æœ‰æ¨¡æ¿(å¼ºåˆ¶æ›´æ–°)ï¼‰ --home: æ¨¡æ¿çš„goctlä¸»è·¯å¾„ clean ï¼ˆæ¸…ç†æ‰€æœ‰ç¼“å­˜çš„æ¨¡æ¿ï¼‰ --home: æ¨¡æ¿çš„goctlä¸»è·¯å¾„ update ï¼ˆå°†ç›®æ ‡ç±»åˆ«çš„æ¨¡æ¿æ›´æ–°ä¸ºæœ€æ–°çš„ï¼‰ --category, -c: æ¨¡æ¿çš„ç±»åˆ«ï¼Œæšä¸¾[api,rpc,model,docker,kube] --home: æ¨¡æ¿çš„goctlä¸»é¡µè·¯å¾„ revert ï¼ˆå°†ç›®æ ‡æ¨¡æ¿æ¢å¤åˆ°æœ€æ–°ç‰ˆæœ¬ï¼‰ --category, -c: æ¨¡æ¿çš„ç±»åˆ«ï¼Œæšä¸¾[api,rpc,model,docker,kube] ã€‚ --homeï¼šæ¨¡æ¿çš„goctlä¸»è·¯å¾„ --name, -n: æ¨¡æ¿çš„ç›®æ ‡æ–‡ä»¶å completion ï¼ˆç”Ÿæˆè‡ªåŠ¨è¡¥å…¨è„šæœ¬ï¼Œå®ƒåªé€‚ç”¨äºç±»unixæ“ä½œç³»ç»Ÿï¼‰ --name, -nï¼šè‡ªåŠ¨å®Œæˆè„šæœ¬çš„æ–‡ä»¶åï¼Œé»˜è®¤ä¸º[goctl_autocomplete] Copyright Â© 2019-2021 go-zero all right reservedï¼Œpowered by GitbookLast UpdateTimeï¼š 2025-05-05 05:44:52 "},"goctl-api.html":{"url":"goctl-api.html","title":"apiå‘½ä»¤","keywords":"","body":"apiå‘½ä»¤ goctl apiæ˜¯goctlä¸­çš„æ ¸å¿ƒæ¨¡å—ä¹‹ä¸€ï¼Œå…¶å¯ä»¥é€šè¿‡.apiæ–‡ä»¶ä¸€é”®å¿«é€Ÿç”Ÿæˆä¸€ä¸ªapiæœåŠ¡ï¼Œå¦‚æœä»…ä»…æ˜¯å¯åŠ¨ä¸€ä¸ªgo-zeroçš„apiæ¼”ç¤ºé¡¹ç›®ï¼Œ ä½ ç”šè‡³éƒ½ä¸ç”¨ç¼–ç ï¼Œå°±å¯ä»¥å®Œæˆä¸€ä¸ªapiæœåŠ¡å¼€å‘åŠæ­£å¸¸è¿è¡Œã€‚åœ¨ä¼ ç»Ÿçš„apié¡¹ç›®ä¸­ï¼Œæˆ‘ä»¬è¦åˆ›å»ºå„çº§ç›®å½•ï¼Œç¼–å†™ç»“æ„ä½“ï¼Œ å®šä¹‰è·¯ç”±ï¼Œæ·»åŠ logicæ–‡ä»¶ï¼Œè¿™ä¸€ç³»åˆ—æ“ä½œï¼Œå¦‚æœæŒ‰ç…§ä¸€æ¡åè®®çš„ä¸šåŠ¡éœ€æ±‚è®¡ç®—ï¼Œæ•´ä¸ªç¼–ç ä¸‹æ¥å¤§æ¦‚éœ€è¦5ï½6åˆ†é’Ÿæ‰èƒ½çœŸæ­£è¿›å…¥ä¸šåŠ¡é€»è¾‘çš„ç¼–å†™ï¼Œ è¿™è¿˜ä¸è€ƒè™‘ç¼–å†™è¿‡ç¨‹ä¸­å¯èƒ½äº§ç”Ÿçš„å„ç§é”™è¯¯ï¼Œè€Œéšç€æœåŠ¡çš„å¢å¤šï¼Œéšç€åè®®çš„å¢å¤šï¼Œè¿™éƒ¨åˆ†å‡†å¤‡å·¥ä½œçš„æ—¶é—´å°†æˆæ­£æ¯”ä¸Šå‡ï¼Œ è€Œgoctl apiåˆ™å¯ä»¥å®Œå…¨æ›¿ä»£ä½ å»åšè¿™ä¸€éƒ¨åˆ†å·¥ä½œï¼Œä¸ç®¡ä½ çš„åè®®è¦å®šå¤šå°‘ä¸ªï¼Œæœ€ç»ˆæ¥è¯´ï¼Œåªéœ€è¦èŠ±è´¹10ç§’ä¸åˆ°å³å¯å®Œæˆã€‚ [!TIP] å…¶ä¸­çš„ç»“æ„ä½“ç¼–å†™ï¼Œè·¯ç”±å®šä¹‰ç”¨apiè¿›è¡Œæ›¿ä»£ï¼Œå› æ­¤æ€»çš„æ¥è¯´ï¼Œçœå»çš„æ˜¯ä½ åˆ›å»ºæ–‡ä»¶å¤¹ã€æ·»åŠ å„ç§æ–‡ä»¶åŠèµ„æºä¾èµ–çš„è¿‡ç¨‹çš„æ—¶é—´ã€‚ apiå‘½ä»¤è¯´æ˜ $ goctl api -h NAME: goctl api - generate api related files USAGE: goctl api command [command options] [arguments...] COMMANDS: new fast create api service format format api files validate validate api file doc generate doc files go generate go files for provided api in yaml file java generate java files for provided api in api file ts generate ts files for provided api in api file dart generate dart files for provided api in api file kt generate kotlin code for provided api file plugin custom file generator OPTIONS: -o value the output api file --help, -h show help ä»ä¸Šæ–‡ä¸­å¯ä»¥çœ‹åˆ°ï¼Œæ ¹æ®åŠŸèƒ½çš„ä¸åŒï¼ŒapiåŒ…å«äº†å¾ˆå¤šçš„è‡ªå‘½ä»¤å’Œflagï¼Œæˆ‘ä»¬è¿™é‡Œé‡ç‚¹è¯´æ˜ä¸€ä¸‹ goå­å‘½ä»¤ï¼Œå…¶åŠŸèƒ½æ˜¯ç”Ÿæˆgolang apiæœåŠ¡ï¼Œæˆ‘ä»¬é€šè¿‡goctl api go -hçœ‹ä¸€ä¸‹ä½¿ç”¨å¸®åŠ©ï¼š $ goctl api go -h NAME: goctl api go - generate go files for provided api in yaml file USAGE: goctl api go [command options] [arguments...] OPTIONS: --dir value the target dir --api value the api file --style value the file naming format, see [https://github.com/zeromicro/go-zero/tree/master/tools/goctl/config/readme.md] --dir ä»£ç è¾“å‡ºç›®å½• --api æŒ‡å®šapiæºæ–‡ä»¶ --style æŒ‡å®šç”Ÿæˆä»£ç æ–‡ä»¶çš„æ–‡ä»¶åç§°é£æ ¼ï¼Œè¯¦æƒ…è§æ–‡ä»¶åç§°å‘½åstyleè¯´æ˜ ä½¿ç”¨ç¤ºä¾‹ $ goctl api go -api user.api -dir . -style gozero çŒœä½ æƒ³çœ‹ apiè¯­æ³• apiç›®å½• Copyright Â© 2019-2021 go-zero all right reservedï¼Œpowered by GitbookLast UpdateTimeï¼š 2025-05-05 05:44:52 "},"goctl-rpc.html":{"url":"goctl-rpc.html","title":"rpcå‘½ä»¤","keywords":"","body":"rpcå‘½ä»¤ Goctl Rpcæ˜¯goctlè„šæ‰‹æ¶ä¸‹çš„ä¸€ä¸ªrpcæœåŠ¡ä»£ç ç”Ÿæˆæ¨¡å—ï¼Œæ”¯æŒprotoæ¨¡æ¿ç”Ÿæˆå’ŒrpcæœåŠ¡ä»£ç ç”Ÿæˆï¼Œé€šè¿‡æ­¤å·¥å…·ç”Ÿæˆä»£ç ä½ åªéœ€è¦å…³æ³¨ä¸šåŠ¡é€»è¾‘ç¼–å†™è€Œä¸ç”¨å»ç¼–å†™ä¸€äº›é‡å¤æ€§çš„ä»£ç ã€‚è¿™ä½¿å¾—æˆ‘ä»¬æŠŠç²¾åŠ›é‡å¿ƒæ”¾åœ¨ä¸šåŠ¡ä¸Šï¼Œä»è€ŒåŠ å¿«äº†å¼€å‘æ•ˆç‡ä¸”é™ä½äº†ä»£ç å‡ºé”™ç‡ã€‚ ç‰¹æ€§ ç®€å•æ˜“ç”¨ å¿«é€Ÿæå‡å¼€å‘æ•ˆç‡ å‡ºé”™ç‡ä½ è´´è¿‘protoc å¿«é€Ÿå¼€å§‹ æ–¹å¼ä¸€ï¼šå¿«é€Ÿç”ŸæˆgreetæœåŠ¡ é€šè¿‡å‘½ä»¤ goctl rpc new ${servieName}ç”Ÿæˆ å¦‚ç”Ÿæˆgreet rpcæœåŠ¡ï¼š goctl rpc new greet æ‰§è¡Œåä»£ç ç»“æ„å¦‚ä¸‹: . â”œâ”€â”€ etc â”‚ â””â”€â”€ greet.yaml â”œâ”€â”€ go.mod â”œâ”€â”€ go.sum â”œâ”€â”€ greet â”‚ â”œâ”€â”€ greet.go â”‚ â”œâ”€â”€ greet.pb.go â”‚ â””â”€â”€ greet_grpc.pb.go â”œâ”€â”€ greet.go â”œâ”€â”€ greet.proto â””â”€â”€ internal â”œâ”€â”€ config â”‚ â””â”€â”€ config.go â”œâ”€â”€ logic â”‚ â””â”€â”€ pinglogic.go â”œâ”€â”€ server â”‚ â””â”€â”€ greetserver.go â””â”€â”€ svc â””â”€â”€ servicecontext.go [!TIP] æ–°ç‰ˆæœ¬ç›®å½•è¯¦è§ rpcç›®å½• æ–¹å¼äºŒï¼šé€šè¿‡æŒ‡å®šprotoç”ŸæˆrpcæœåŠ¡ ç”Ÿæˆprotoæ¨¡æ¿ goctl rpc template -o=user.proto syntax = \"proto3\"; package user; option go_package=\"./user\"; message Request { string ping = 1; } message Response { string pong = 1; } service User { rpc Ping(Request) returns(Response); } ç”ŸæˆrpcæœåŠ¡ä»£ç  $ goctl rpc protoc user.proto --go_out=. --go-grpc_out=. --zrpc_out=. å‡†å¤‡å·¥ä½œ å®‰è£…äº†goç¯å¢ƒ å®‰è£…äº†protoc & protoc-gen-goï¼Œå¹¶ä¸”å·²ç»è®¾ç½®ç¯å¢ƒå˜é‡ æ›´å¤šé—®é¢˜è¯·è§ æ³¨æ„äº‹é¡¹ ç”¨æ³• rpcæœåŠ¡ç”Ÿæˆç”¨æ³• goctl rpc protoc -h NAME: goctl rpc protoc - generate grpc code USAGE: example: goctl rpc protoc xx.proto --go_out=./pb --go-grpc_out=./pb --zrpc_out=. DESCRIPTION: for details, see https://go-zero.dev/cn/goctl-rpc.html OPTIONS: --zrpc_out value the zrpc output directory --style value the file naming format, see [https://github.com/zeromicro/go-zero/tree/master/tools/goctl/config/readme.md] --home value the goctl home path of the template --remote value the remote git repo of the template, --home and --remote cannot be set at the same time, if they are, --remote has higher priority The git repo directory must be consistent with the https://github.com/zeromicro/go-zero-template directory structure --branch value the branch of the remote repo, it does work with --remote å‚æ•°è¯´æ˜ --zrpc_out å¯é€‰ï¼Œé»˜è®¤ä¸ºprotoæ–‡ä»¶æ‰€åœ¨ç›®å½•ï¼Œç”Ÿæˆä»£ç çš„ç›®æ ‡ç›®å½• --style å¯é€‰ï¼Œè¾“å‡ºç›®å½•çš„æ–‡ä»¶å‘½åé£æ ¼ï¼Œè¯¦æƒ…è§https://github.com/zeromicro/go-zero/tree/master/tools/goctl/config/readme.md --home å¯é€‰ï¼ŒæŒ‡å®šæ¨¡æ¿è·¯å¾„ --remote å¯é€‰ï¼ŒæŒ‡å®šæ¨¡æ¿è¿œç¨‹ä»“åº“ --branch å¯é€‰ï¼ŒæŒ‡å®šæ¨¡æ¿è¿œç¨‹ä»“åº“åˆ†æ”¯ï¼Œä¸ --remote é…åˆä½¿ç”¨ ä½ å¯ä»¥ç†è§£ä¸º zrpc ä»£ç ç”Ÿæˆæ˜¯ç”¨ goctl rpc $protoc_command --zrpc_out=${output} æ¨¡æ¿ï¼Œå¦‚åŸæ¥ç”Ÿæˆ grpc ä»£ç æŒ‡ä»¤ä¸º $ protoc user.proto --go_out=. --go-grpc_out=. åˆ™ç”Ÿæˆ zrpc ä»£ç æŒ‡ä»¤å°±ä¸º $ goctl rpc protoc user.proto --go_out=. --go-grpc_out=. --zrpc_out=. [!TIP] --go_out ä¸ --go-grpc_out ç”Ÿæˆçš„æœ€ç»ˆç›®å½•å¿…é¡»ä¸€è‡´ --go_out & --go-grpc_out å’Œ --zrpc_out çš„ç”Ÿæˆçš„æœ€ç»ˆç›®å½•å¿…é¡»ä¸ä¸ºåŒä¸€ç›®å½•ï¼Œå¦åˆ™pb.goå’Œ_grpc.pb.goå°±ä¸mainå‡½æ•°åŒçº§äº†ï¼Œè¿™æ˜¯ä¸å…è®¸çš„ã€‚ --go_out ä¸ --go-grpc_out ç”Ÿäº§çš„ç›®å½•ä¼šå— --go_opt å’Œ --grpc-go_opt å’Œprotoæºæ–‡ä»¶ä¸­ go_packageå€¼çš„å½±å“ï¼Œè¦æƒ³ç†è§£è¿™é‡Œçš„ç”Ÿæˆé€»è¾‘ï¼Œå»ºè®®é˜…è¯» å®˜æ–¹æ–‡æ–‡æ¡£ï¼šGo Generated Code å¼€å‘äººå‘˜éœ€è¦åšä»€ä¹ˆ å…³æ³¨ä¸šåŠ¡ä»£ç ç¼–å†™ï¼Œå°†é‡å¤æ€§ã€ä¸ä¸šåŠ¡æ— å…³çš„å·¥ä½œäº¤ç»™goctlï¼Œç”Ÿæˆå¥½rpcæœåŠ¡ä»£ç åï¼Œå¼€å‘äººå‘˜ä»…éœ€è¦ä¿®æ”¹ æœåŠ¡ä¸­çš„é…ç½®æ–‡ä»¶ç¼–å†™(etc/xx.jsonã€internal/config/config.go) æœåŠ¡ä¸­ä¸šåŠ¡é€»è¾‘ç¼–å†™(internal/logic/xxlogic.go) æœåŠ¡ä¸­èµ„æºä¸Šä¸‹æ–‡çš„ç¼–å†™(internal/svc/servicecontext.go) æ³¨æ„äº‹é¡¹ protoæš‚ä¸æ”¯æŒå¤šæ–‡ä»¶åŒæ—¶ç”Ÿæˆ protoä¸æ”¯æŒå¤–éƒ¨ä¾èµ–åŒ…å¼•å…¥ï¼Œmessageä¸æ”¯æŒinline ç›®å‰mainæ–‡ä»¶ã€sharedæ–‡ä»¶ã€handleræ–‡ä»¶ä¼šè¢«å¼ºåˆ¶è¦†ç›–ï¼Œè€Œå’Œå¼€å‘äººå‘˜æ‰‹åŠ¨éœ€è¦ç¼–å†™çš„åˆ™ä¸ä¼šè¦†ç›–ç”Ÿæˆï¼Œè¿™ä¸€ç±»åœ¨ä»£ç å¤´éƒ¨å‡æœ‰ // Code generated by goctl. DO NOT EDIT! // Source: xxx.proto çš„æ ‡è¯†ï¼Œè¯·æ³¨æ„ä¸è¦åœ¨é‡Œé¢å†™ä¸šåŠ¡æ€§ä»£ç ;ä¹Ÿä¸è¦å°†å®ƒå†™åœ¨ä¸šåŠ¡æ€§ä»£ç é‡Œé¢ã€‚ proto import å¯¹äºrpcä¸­çš„requestTypeå’ŒreturnTypeå¿…é¡»åœ¨main protoæ–‡ä»¶å®šä¹‰ï¼Œå¯¹äºprotoä¸­çš„messageå¯ä»¥åƒprotocä¸€æ ·importå…¶ä»–protoæ–‡ä»¶ã€‚ protoç¤ºä¾‹: é”™è¯¯import syntax = \"proto3\"; package greet; option go_package = \"./greet\"; import \"base/common.proto\"; message Request { string ping = 1; } message Response { string pong = 1; } service Greet { rpc Ping(base.In) returns(base.Out);// requestå’Œreturn ä¸æ”¯æŒimport } æ­£ç¡®import syntax = \"proto3\"; package greet; option go_package = \"./greet\"; import \"base/common.proto\"; message Request { base.In in = 1;// æ”¯æŒimport } message Response { base.Out out = 2;// æ”¯æŒimport } service Greet { rpc Ping(Request) returns(Response); } çŒœä½ æƒ³çœ‹ rpcç›®å½• rpcé…ç½® rpcè°ƒç”¨ Copyright Â© 2019-2021 go-zero all right reservedï¼Œpowered by GitbookLast UpdateTimeï¼š 2025-05-05 05:44:52 "},"goctl-model.html":{"url":"goctl-model.html","title":"modelå‘½ä»¤","keywords":"","body":"modelå‘½ä»¤ goctl model ä¸ºgo-zeroä¸‹çš„å·¥å…·æ¨¡å—ä¸­çš„ç»„ä»¶ä¹‹ä¸€ï¼Œç›®å‰æ”¯æŒè¯†åˆ«mysql ddlè¿›è¡Œmodelå±‚ä»£ç ç”Ÿæˆï¼Œé€šè¿‡å‘½ä»¤è¡Œæˆ–è€…ideaæ’ä»¶ï¼ˆå³å°†æ”¯æŒï¼‰å¯ä»¥æœ‰é€‰æ‹©åœ°ç”Ÿæˆå¸¦redis cacheæˆ–è€…ä¸å¸¦redis cacheçš„ä»£ç é€»è¾‘ã€‚ å¿«é€Ÿå¼€å§‹ é€šè¿‡ddlç”Ÿæˆ $ goctl model mysql ddl -src=\"./*.sql\" -dir=\"./sql/model\" -c æ‰§è¡Œä¸Šè¿°å‘½ä»¤åå³å¯å¿«é€Ÿç”ŸæˆCURDä»£ç ã€‚ model â”œâ”€â”€ usermodel.go â”œâ”€â”€ usermodel_gen.go â””â”€â”€ vars.go é€šè¿‡datasourceç”Ÿæˆ $ goctl model mysql datasource -url=\"user:password@tcp(127.0.0.1:3306)/database\" -table=\"*\" -dir=\"./model\" usermodel_gen.go // Code generated by goctl. DO NOT EDIT! package model import ( \"context\" \"database/sql\" \"fmt\" \"strings\" \"time\" \"github.com/zeromicro/go-zero/core/stores/builder\" \"github.com/zeromicro/go-zero/core/stores/cache\" \"github.com/zeromicro/go-zero/core/stores/sqlc\" \"github.com/zeromicro/go-zero/core/stores/sqlx\" \"github.com/zeromicro/go-zero/core/stringx\" ) var ( userFieldNames = builder.RawFieldNames(&User{}) userRows = strings.Join(userFieldNames, \",\") userRowsExpectAutoSet = strings.Join(stringx.Remove(userFieldNames, \"`id`\", \"`create_time`\", \"`update_time`\"), \",\") userRowsWithPlaceHolder = strings.Join(stringx.Remove(userFieldNames, \"`id`\", \"`create_time`\", \"`update_time`\"), \"=?,\") + \"=?\" cacheUserIdPrefix = \"cache:user:id:\" cacheUserNumberPrefix = \"cache:user:number:\" ) type ( userModel interface { Insert(ctx context.Context, data *User) (sql.Result, error) FindOne(ctx context.Context, id int64) (*User, error) FindOneByNumber(ctx context.Context, number string) (*User, error) Update(ctx context.Context, data *User) error Delete(ctx context.Context, id int64) error } defaultUserModel struct { sqlc.CachedConn table string } User struct { Id int64 `db:\"id\"` Number string `db:\"number\"` // å­¦å· Name string `db:\"name\"` // ç”¨æˆ·åç§° Password string `db:\"password\"` // ç”¨æˆ·å¯†ç  Gender string `db:\"gender\"` // ç”·ï½œå¥³ï½œæœªå…¬å¼€ CreateTime time.Time `db:\"create_time\"` UpdateTime time.Time `db:\"update_time\"` } ) func newUserModel(conn sqlx.SqlConn, c cache.CacheConf) *defaultUserModel { return &defaultUserModel{ CachedConn: sqlc.NewConn(conn, c), table: \"`user`\", } } func (m *defaultUserModel) Insert(ctx context.Context, data *User) (sql.Result, error) { userIdKey := fmt.Sprintf(\"%s%v\", cacheUserIdPrefix, data.Id) userNumberKey := fmt.Sprintf(\"%s%v\", cacheUserNumberPrefix, data.Number) ret, err := m.ExecCtx(ctx, func(ctx context.Context, conn sqlx.SqlConn) (result sql.Result, err error) { query := fmt.Sprintf(\"insert into %s (%s) values (?, ?, ?, ?)\", m.table, userRowsExpectAutoSet) return conn.ExecCtx(ctx, query, data.Number, data.Name, data.Password, data.Gender) }, userIdKey, userNumberKey) return ret, err } func (m *defaultUserModel) FindOne(ctx context.Context, id int64) (*User, error) { userIdKey := fmt.Sprintf(\"%s%v\", cacheUserIdPrefix, id) var resp User err := m.QueryRowCtx(ctx, &resp, userIdKey, func(ctx context.Context, conn sqlx.SqlConn, v interface{}) error { query := fmt.Sprintf(\"select %s from %s where `id` = ? limit 1\", userRows, m.table) return conn.QueryRowCtx(ctx, v, query, id) }) switch err { case nil: return &resp, nil case sqlc.ErrNotFound: return nil, ErrNotFound default: return nil, err } } func (m *defaultUserModel) FindOneByNumber(ctx context.Context, number string) (*User, error) { userNumberKey := fmt.Sprintf(\"%s%v\", cacheUserNumberPrefix, number) var resp User err := m.QueryRowIndexCtx(ctx, &resp, userNumberKey, m.formatPrimary, func(ctx context.Context, conn sqlx.SqlConn, v interface{}) (i interface{}, e error) { query := fmt.Sprintf(\"select %s from %s where `number` = ? limit 1\", userRows, m.table) if err := conn.QueryRowCtx(ctx, &resp, query, number); err != nil { return nil, err } return resp.Id, nil }, m.queryPrimary) switch err { case nil: return &resp, nil case sqlc.ErrNotFound: return nil, ErrNotFound default: return nil, err } } func (m *defaultUserModel) Update(ctx context.Context, data *User) error { userIdKey := fmt.Sprintf(\"%s%v\", cacheUserIdPrefix, data.Id) userNumberKey := fmt.Sprintf(\"%s%v\", cacheUserNumberPrefix, data.Number) _, err := m.ExecCtx(ctx, func(ctx context.Context, conn sqlx.SqlConn) (result sql.Result, err error) { query := fmt.Sprintf(\"update %s set %s where `id` = ?\", m.table, userRowsWithPlaceHolder) return conn.ExecCtx(ctx, query, data.Number, data.Name, data.Password, data.Gender, data.Id) }, userIdKey, userNumberKey) return err } func (m *defaultUserModel) Delete(ctx context.Context, id int64) error { data, err := m.FindOne(ctx, id) if err != nil { return err } userIdKey := fmt.Sprintf(\"%s%v\", cacheUserIdPrefix, id) userNumberKey := fmt.Sprintf(\"%s%v\", cacheUserNumberPrefix, data.Number) _, err = m.ExecCtx(ctx, func(ctx context.Context, conn sqlx.SqlConn) (result sql.Result, err error) { query := fmt.Sprintf(\"delete from %s where `id` = ?\", m.table) return conn.ExecCtx(ctx, query, id) }, userIdKey, userNumberKey) return err } func (m *defaultUserModel) formatPrimary(primary interface{}) string { return fmt.Sprintf(\"%s%v\", cacheUserIdPrefix, primary) } func (m *defaultUserModel) queryPrimary(ctx context.Context, conn sqlx.SqlConn, v, primary interface{}) error { query := fmt.Sprintf(\"select %s from %s where `id` = ? limit 1\", userRows, m.table) return conn.QueryRowCtx(ctx, v, query, primary) } func (m *defaultUserModel) tableName() string { return m.table } usermodel.go package model import ( \"github.com/zeromicro/go-zero/core/stores/cache\" \"github.com/zeromicro/go-zero/core/stores/sqlx\" ) var _ UserModel = (*customUserModel)(nil) type ( // UserModel is an interface to be customized, add more methods here, // and implement the added methods in customUserModel. UserModel interface { userModel } customUserModel struct { *defaultUserModel } ) // NewUserModel returns a model for the database table. func NewUserModel(conn sqlx.SqlConn, c cache.CacheConf) UserModel { return &customUserModel{ defaultUserModel: newUserModel(conn, c), } } ç”¨æ³• $ goctl model mysql -h NAME: goctl model mysql - generate mysql model\" USAGE: goctl model mysql command [command options] [arguments...] COMMANDS: ddl generate mysql model from ddl\" datasource generate model from datasource\" OPTIONS: --help, -h show help ç”Ÿæˆè§„åˆ™ é»˜è®¤è§„åˆ™ æˆ‘ä»¬é»˜è®¤ç”¨æˆ·åœ¨å»ºè¡¨æ—¶ä¼šåˆ›å»ºcreateTimeã€updateTimeå­—æ®µ(å¿½ç•¥å¤§å°å†™ã€ä¸‹åˆ’çº¿å‘½åé£æ ¼)ä¸”é»˜è®¤å€¼å‡ä¸ºCURRENT_TIMESTAMPï¼Œè€ŒupdateTimeæ”¯æŒON UPDATE CURRENT_TIMESTAMPï¼Œå¯¹äºè¿™ä¸¤ä¸ªå­—æ®µç”Ÿæˆinsertã€updateæ—¶ä¼šè¢«ç§»é™¤ï¼Œä¸åœ¨èµ‹å€¼èŒƒç•´å†…ï¼Œå½“ç„¶ï¼Œå¦‚æœä½ ä¸éœ€è¦è¿™ä¸¤ä¸ªå­—æ®µé‚£ä¹Ÿæ— å¤§ç¢ã€‚ ddl NAME: goctl model mysql ddl - generate mysql model from ddl USAGE: goctl model mysql ddl [command options] [arguments...] OPTIONS: --src value, -s value the path or path globbing patterns of the ddl --dir value, -d value the target dir --style value the file naming format, see [https://github.com/zeromicro/go-zero/tree/master/tools/goctl/config/readme.md] --cache, -c generate code with cache [optional] --idea for idea plugin [optional] --database value, --db value the name of database [optional] --home value the goctl home path of the template, --home and --remote cannot be set at the same time, if they are, --remote has higher priority --remote value the remote git repo of the template, --home and --remote cannot be set at the same time, if they are, --remote has higher priority The git repo directory must be consistent with the https://github.com/zeromicro/go-zero-template directory structure --branch value the branch of the remote repo, it does work with --remote datasource $ goctl model mysql datasource -h ï™ 13:40:46 ï¨106ms NAME: goctl model mysql datasource - generate model from datasource USAGE: goctl model mysql datasource [command options] [arguments...] OPTIONS: --url value the data source of database,like \"root:password@tcp(127.0.0.1:3306)/database\" --table value, -t value the table or table globbing patterns in the database --cache, -c generate code with cache [optional] --dir value, -d value the target dir --style value the file naming format, see [https://github.com/zeromicro/go-zero/tree/master/tools/goctl/config/readme.md] --idea for idea plugin [optional] --home value the goctl home path of the template, --home and --remote cannot be set at the same time, if they are, --remote has higher priority --remote value the remote git repo of the template, --home and --remote cannot be set at the same time, if they are, --remote has higher priority The git repo directory must be consistent with the https://github.com/zeromicro/go-zero-template directory structure --branch value the branch of the remote repo, it does work with --remote ç”Ÿæˆä»£ç ä»…åŸºæœ¬çš„CURDç»“æ„ã€‚ ç¼“å­˜ å¯¹äºç¼“å­˜è¿™ä¸€å—æˆ‘é€‰æ‹©ç”¨ä¸€é—®ä¸€ç­”çš„å½¢å¼è¿›è¡Œç½—åˆ—ã€‚æˆ‘æƒ³è¿™æ ·èƒ½å¤Ÿæ›´æ¸…æ™°çš„æè¿°modelä¸­ç¼“å­˜çš„åŠŸèƒ½ã€‚ ç¼“å­˜ä¼šç¼“å­˜å“ªäº›ä¿¡æ¯ï¼Ÿ å¯¹äºä¸»é”®å­—æ®µç¼“å­˜ï¼Œä¼šç¼“å­˜æ•´ä¸ªç»“æ„ä½“ä¿¡æ¯ï¼Œè€Œå¯¹äºå•ç´¢å¼•å­—æ®µï¼ˆé™¤å…¨æ–‡ç´¢å¼•ï¼‰åˆ™ç¼“å­˜ä¸»é”®å­—æ®µå€¼ã€‚ æ•°æ®æœ‰æ›´æ–°ï¼ˆupdateï¼‰æ“ä½œä¼šæ¸…ç©ºç¼“å­˜å—ï¼Ÿ ä¼šï¼Œä½†ä»…æ¸…ç©ºä¸»é”®ç¼“å­˜çš„ä¿¡æ¯ï¼Œwhyï¼Ÿè¿™é‡Œå°±ä¸åšè¯¦ç»†èµ˜è¿°äº†ã€‚ ä¸ºä»€ä¹ˆä¸æŒ‰ç…§å•ç´¢å¼•å­—æ®µç”ŸæˆupdateByXxxå’ŒdeleteByXxxçš„ä»£ç ï¼Ÿ ç†è®ºä¸Šæ˜¯æ²¡ä»»ä½•é—®é¢˜ï¼Œä½†æ˜¯æˆ‘ä»¬è®¤ä¸ºï¼Œå¯¹äºmodelå±‚çš„æ•°æ®æ“ä½œå‡æ˜¯ä»¥æ•´ä¸ªç»“æ„ä½“ä¸ºå•ä½ï¼ŒåŒ…æ‹¬æŸ¥è¯¢ï¼Œæˆ‘ä¸å»ºè®®åªæŸ¥è¯¢æŸéƒ¨åˆ†å­—æ®µï¼ˆä¸åå¯¹ï¼‰ï¼Œå¦åˆ™æˆ‘ä»¬çš„ç¼“å­˜å°±æ²¡æœ‰æ„ä¹‰äº†ã€‚ ä¸ºä»€ä¹ˆä¸æ”¯æŒfindPageLimitã€findAllè¿™ç§æ¨¡å¼ä»£ç ç”Ÿæˆï¼Ÿ ç›®å‰ï¼Œæˆ‘è®¤ä¸ºé™¤äº†åŸºæœ¬çš„CURDå¤–ï¼Œå…¶ä»–çš„ä»£ç å‡å±äºä¸šåŠ¡å‹ä»£ç ï¼Œè¿™ä¸ªæˆ‘è§‰å¾—å¼€å‘äººå‘˜æ ¹æ®ä¸šåŠ¡éœ€è¦è¿›è¡Œç¼–å†™æ›´å¥½ã€‚ ç±»å‹è½¬æ¢è§„åˆ™ mysql dataType golang dataType golang dataType(if null&&default null) bool int64 sql.NullInt64 boolean int64 sql.NullInt64 tinyint int64 sql.NullInt64 smallint int64 sql.NullInt64 mediumint int64 sql.NullInt64 int int64 sql.NullInt64 integer int64 sql.NullInt64 bigint int64 sql.NullInt64 float float64 sql.NullFloat64 double float64 sql.NullFloat64 decimal float64 sql.NullFloat64 date time.Time sql.NullTime datetime time.Time sql.NullTime timestamp time.Time sql.NullTime time string sql.NullString year time.Time sql.NullInt64 char string sql.NullString varchar string sql.NullString binary string sql.NullString varbinary string sql.NullString tinytext string sql.NullString text string sql.NullString mediumtext string sql.NullString longtext string sql.NullString enum string sql.NullString set string sql.NullString json string sql.NullString Copyright Â© 2019-2021 go-zero all right reservedï¼Œpowered by GitbookLast UpdateTimeï¼š 2025-05-05 05:44:52 "},"goctl-plugin.html":{"url":"goctl-plugin.html","title":"pluginå‘½ä»¤","keywords":"","body":"pluginå‘½ä»¤ goctlæ”¯æŒé’ˆå¯¹apiè‡ªå®šä¹‰æ’ä»¶ï¼Œé‚£æˆ‘æ€ä¹ˆæ¥è‡ªå®šä¹‰ä¸€ä¸ªæ’ä»¶äº†ï¼Ÿæ¥çœ‹çœ‹ä¸‹é¢æœ€ç»ˆæ€ä¹ˆä½¿ç”¨çš„ä¸€ä¸ªä¾‹å­ã€‚ $ goctl api plugin -p goctl-android=\"android -package com.tal\" -api user.api -dir . ä¸Šé¢è¿™ä¸ªå‘½ä»¤å¯ä»¥åˆ†è§£æˆå¦‚ä¸‹å‡ æ­¥ï¼š goctl è§£æapiæ–‡ä»¶ goctl å°†è§£æåçš„ç»“æ„ ApiSpec å’Œå‚æ•°ä¼ é€’ç»™goctl-androidå¯æ‰§è¡Œæ–‡ä»¶ goctl-android æ ¹æ® ApiSpec ç»“æ„ä½“è‡ªå®šä¹‰ç”Ÿæˆé€»è¾‘ã€‚ æ­¤å‘½ä»¤å‰é¢éƒ¨åˆ† goctl api plugin -p æ˜¯å›ºå®šå‚æ•°ï¼Œgoctl-android=\"android -package com.tal\" æ˜¯pluginå‚æ•°ï¼Œå…¶ä¸­goctl-androidæ˜¯æ’ä»¶äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œandroid -package com.talæ˜¯æ’ä»¶çš„è‡ªå®šä¹‰å‚æ•°ï¼Œ-api user.api -dir .æ˜¯goctlé€šç”¨è‡ªå®šä¹‰å‚æ•°ã€‚ æ€ä¹ˆç¼–å†™è‡ªå®šä¹‰æ’ä»¶ï¼Ÿ go-zeroæ¡†æ¶ä¸­åŒ…å«äº†ä¸€ä¸ªå¾ˆç®€å•çš„è‡ªå®šä¹‰æ’ä»¶ demoï¼Œä»£ç å¦‚ä¸‹ï¼š package main import ( \"fmt\" \"github.com/zeromicro/go-zero/tools/goctl/plugin\" ) func main() { plugin, err := plugin.NewPlugin() if err != nil { panic(err) } if plugin.Api != nil { fmt.Printf(\"api: %+v \\n\", plugin.Api) } fmt.Printf(\"dir: %s \\n\", plugin.Dir) fmt.Println(\"Enjoy anything you want.\") } plugin, err := plugin.NewPlugin() è¿™è¡Œä»£ç ä½œç”¨æ˜¯è§£æä»goctlä¼ é€’è¿‡æ¥çš„æ•°æ®ï¼Œé‡Œé¢åŒ…å«å¦‚ä¸‹éƒ¨åˆ†å†…å®¹ï¼š type Plugin struct { Api *spec.ApiSpec Style string Dir string } [!TIP] Apiï¼šå®šä¹‰äº†apiæ–‡ä»¶çš„ç»“æ„æ•°æ® Styleï¼šå¯é€‰å‚æ•°ï¼Œå¯ä»¥ç”¨æ¥æ§åˆ¶æ–‡ä»¶å‘½åè§„èŒƒ Dirï¼šå·¥ä½œç›®å½• å®Œæ•´çš„åŸºäºpluginå®ç°çš„android pluginæ¼”ç¤ºé¡¹ç›® https://github.com/zeromicro/goctl-android çŒœä½ æƒ³çœ‹ apiç›®å½• apiè¯­æ³• apié…ç½® apiå‘½ä»¤ä»‹ç» Copyright Â© 2019-2021 go-zero all right reservedï¼Œpowered by GitbookLast UpdateTimeï¼š 2025-05-05 05:44:52 "},"goctl-other.html":{"url":"goctl-other.html","title":"å…¶ä»–å‘½ä»¤","keywords":"","body":"å…¶ä»–å‘½ä»¤ goctl docker goctl kube goctl docker goctl docker å¯ä»¥æé€Ÿç”Ÿæˆä¸€ä¸ª Dockerfileï¼Œå¸®åŠ©å¼€å‘/è¿ç»´äººå‘˜åŠ å¿«éƒ¨ç½²èŠ‚å¥ï¼Œé™ä½éƒ¨ç½²å¤æ‚åº¦ã€‚ å‡†å¤‡å·¥ä½œ dockerå®‰è£… Dockerfile é¢å¤–æ³¨æ„ç‚¹ é€‰æ‹©æœ€ç®€å•çš„é•œåƒï¼šæ¯”å¦‚alpineï¼Œæ•´ä¸ªé•œåƒ5Må·¦å³ è®¾ç½®é•œåƒæ—¶åŒºRUN apk add --no-cache tzdata ENV TZ Asia/Shanghai å¤šé˜¶æ®µæ„å»º ç¬¬ä¸€é˜¶æ®µæ„å»ºå‡ºå¯æ‰§è¡Œæ–‡ä»¶ï¼Œç¡®ä¿æ„å»ºè¿‡ç¨‹ç‹¬ç«‹äºå®¿ä¸»æœº ç¬¬äºŒé˜¶æ®µå°†ç¬¬ä¸€é˜¶æ®µçš„è¾“å‡ºä½œä¸ºè¾“å…¥ï¼Œæ„å»ºå‡ºæœ€ç»ˆçš„æç®€é•œåƒ Dockerfileç¼–å†™è¿‡ç¨‹ é¦–å…ˆå®‰è£… goctl å·¥å…· $ GO111MODULE=on GOPROXY=https://goproxy.cn/,direct go get -u github.com/zeromicro/go-zero/tools/goctl åœ¨ greet é¡¹ç›®ä¸‹åˆ›å»ºä¸€ä¸ª hello æœåŠ¡ $ goctl api new hello æ–‡ä»¶ç»“æ„å¦‚ä¸‹ï¼š greet â”œâ”€â”€ go.mod â”œâ”€â”€ go.sum â””â”€â”€ service â””â”€â”€ hello â”œâ”€â”€ Dockerfile â”œâ”€â”€ etc â”‚ â””â”€â”€ hello-api.yaml â”œâ”€â”€ hello.api â”œâ”€â”€ hello.go â””â”€â”€ internal â”œâ”€â”€ config â”‚ â””â”€â”€ config.go â”œâ”€â”€ handler â”‚ â”œâ”€â”€ hellohandler.go â”‚ â””â”€â”€ routes.go â”œâ”€â”€ logic â”‚ â””â”€â”€ hellologic.go â”œâ”€â”€ svc â”‚ â””â”€â”€ servicecontext.go â””â”€â”€ types â””â”€â”€ types.go åœ¨ hello ç›®å½•ä¸‹ä¸€é”®ç”Ÿæˆ Dockerfile$ goctl docker -go hello.go Dockerfile å†…å®¹å¦‚ä¸‹ï¼š FROM golang:alpine AS builder LABEL stage=gobuilder ENV CGO_ENABLED 0 ENV GOOS linux ENV GOPROXY https://goproxy.cn,direct WORKDIR /build/zero ADD go.mod . ADD go.sum . RUN go mod download COPY . . COPY service/hello/etc /app/etc RUN go build -ldflags=\"-s -w\" -o /app/hello service/hello/hello.go FROM alpine RUN apk update --no-cache RUN apk add --no-cache ca-certificates RUN apk add --no-cache tzdata ENV TZ Asia/Shanghai WORKDIR /app COPY --from=builder /app/hello /app/hello COPY --from=builder /app/etc /app/etc CMD [\"./hello\", \"-f\", \"etc/hello-api.yaml\"] åœ¨ hello ç›®å½•ä¸‹ build é•œåƒ $ docker build -t hello:v1 -f service/hello/Dockerfile . æŸ¥çœ‹é•œåƒ hello v1 5455f2eaea6b 7 minutes ago 18.1MB å¯ä»¥çœ‹å‡ºé•œåƒå¤§å°çº¦ä¸º18Mã€‚ å¯åŠ¨æœåŠ¡$ docker run --rm -it -p 8888:8888 hello:v1 æµ‹è¯•æœåŠ¡$ curl -i http://localhost:8888/from/you HTTP/1.1 200 OK Content-Type: application/json Date: Thu, 10 Dec 2020 06:03:02 GMT Content-Length: 14 {\"message\":\"\"} goctl dockeræ€»ç»“ goctl å·¥å…·æå¤§ç®€åŒ–äº† Dockerfile æ–‡ä»¶çš„ç¼–å†™ï¼Œæä¾›äº†å¼€ç®±å³ç”¨çš„æœ€ä½³å®è·µï¼Œå¹¶ä¸”æ”¯æŒäº†æ¨¡æ¿è‡ªå®šä¹‰ã€‚ goctl kube goctl kubeæä¾›äº†å¿«é€Ÿç”Ÿæˆä¸€ä¸ª k8s éƒ¨ç½²æ–‡ä»¶çš„åŠŸèƒ½ï¼Œå¯ä»¥åŠ å¿«å¼€å‘/è¿ç»´äººå‘˜çš„éƒ¨ç½²è¿›åº¦ï¼Œå‡å°‘éƒ¨ç½²å¤æ‚åº¦ã€‚ å¤´ç–¼ç¼–å†™ K8S éƒ¨ç½²æ–‡ä»¶ï¼Ÿ K8S yaml å‚æ•°å¾ˆå¤šï¼Œéœ€è¦è¾¹å†™è¾¹æŸ¥ï¼Ÿ ä¿ç•™å›æ»šç‰ˆæœ¬æ•°æ€ä¹ˆè®¾ï¼Ÿ å¦‚ä½•æ¢æµ‹å¯åŠ¨æˆåŠŸï¼Œå¦‚ä½•æ¢æ´»ï¼Ÿ å¦‚ä½•åˆ†é…å’Œé™åˆ¶èµ„æºï¼Ÿ å¦‚ä½•è®¾ç½®æ—¶åŒºï¼Ÿå¦åˆ™æ‰“å°æ—¥å¿—æ˜¯ GMT æ ‡å‡†æ—¶é—´ å¦‚ä½•æš´éœ²æœåŠ¡ä¾›å…¶å®ƒæœåŠ¡è°ƒç”¨ï¼Ÿ å¦‚ä½•æ ¹æ® CPU å’Œå†…å­˜ä½¿ç”¨ç‡æ¥é…ç½®æ°´å¹³ä¼¸ç¼©ï¼Ÿ é¦–å…ˆï¼Œä½ éœ€è¦çŸ¥é“æœ‰è¿™äº›çŸ¥è¯†ç‚¹ï¼Œå…¶æ¬¡è¦æŠŠè¿™äº›çŸ¥è¯†ç‚¹éƒ½ææ˜ç™½ä¹Ÿä¸å®¹æ˜“ï¼Œå†æ¬¡ï¼Œæ¯æ¬¡ç¼–å†™ä¾ç„¶å®¹æ˜“å‡ºé”™ï¼ åˆ›å»ºæœåŠ¡é•œåƒ ä¸ºäº†æ¼”ç¤ºï¼Œè¿™é‡Œæˆ‘ä»¬ä»¥ redis:6-alpine é•œåƒä¸ºä¾‹ã€‚ å®Œæ•´ K8S éƒ¨ç½²æ–‡ä»¶ç¼–å†™è¿‡ç¨‹ é¦–å…ˆå®‰è£… goctl å·¥å…· $ GO111MODULE=on GOPROXY=https://goproxy.cn/,direct go get -u github.com/zeromicro/go-zero/tools/goctl ä¸€é”®ç”Ÿæˆ K8S éƒ¨ç½²æ–‡ä»¶ $ goctl kube deploy -name redis -namespace adhoc -image redis:6-alpine -o redis.yaml -port 6379 ç”Ÿæˆçš„ yaml æ–‡ä»¶å¦‚ä¸‹ï¼š apiVersion: apps/v1 kind: Deployment metadata: name: redis namespace: adhoc labels: app: redis spec: replicas: 3 revisionHistoryLimit: 5 selector: matchLabels: app: redis template: metadata: labels: app: redis spec: containers: - name: redis image: redis:6-alpine lifecycle: preStop: exec: command: [\"sh\",\"-c\",\"sleep 5\"] ports: - containerPort: 6379 readinessProbe: tcpSocket: port: 6379 initialDelaySeconds: 5 periodSeconds: 10 livenessProbe: tcpSocket: port: 6379 initialDelaySeconds: 15 periodSeconds: 20 resources: requests: cpu: 500m memory: 512Mi limits: cpu: 1000m memory: 1024Mi volumeMounts: - name: timezone mountPath: /etc/localtime volumes: - name: timezone hostPath: path: /usr/share/zoneinfo/Asia/Shanghai --- apiVersion: v1 kind: Service metadata: name: redis-svc namespace: adhoc spec: ports: - port: 6379 selector: app: redis --- apiVersion: autoscaling/v2beta1 kind: HorizontalPodAutoscaler metadata: name: redis-hpa-c namespace: adhoc labels: app: redis-hpa-c spec: scaleTargetRef: apiVersion: apps/v1 kind: Deployment name: redis minReplicas: 3 maxReplicas: 10 metrics: - type: Resource resource: name: cpu targetAverageUtilization: 80 --- apiVersion: autoscaling/v2beta1 kind: HorizontalPodAutoscaler metadata: name: redis-hpa-m namespace: adhoc labels: app: redis-hpa-m spec: scaleTargetRef: apiVersion: apps/v1 kind: Deployment name: redis minReplicas: 3 maxReplicas: 10 metrics: - type: Resource resource: name: memory targetAverageUtilization: 80 éƒ¨ç½²æœåŠ¡ï¼Œå¦‚æœ adhoc namespace ä¸å­˜åœ¨çš„è¯ï¼Œè¯·å…ˆé€šè¿‡ kubectl create namespace adhoc åˆ›å»º $ kubectl apply -f redis.yaml deployment.apps/redis created service/redis-svc created horizontalpodautoscaler.autoscaling/redis-hpa-c created horizontalpodautoscaler.autoscaling/redis-hpa-m created æŸ¥çœ‹æœåŠ¡å…è®¸çŠ¶æ€ $ kubectl get all -n adhoc NAME READY STATUS RESTARTS AGE pod/redis-585bc66876-5ph26 1/1 Running 0 6m5s pod/redis-585bc66876-bfqxz 1/1 Running 0 6m5s pod/redis-585bc66876-vvfc9 1/1 Running 0 6m5s NAME TYPE CLUSTER-IP EXTERNAL-IP PORT(S) AGE service/redis-svc ClusterIP 172.24.15.8 6379/TCP 6m5s NAME READY UP-TO-DATE AVAILABLE AGE deployment.apps/redis 3/3 3 3 6m6s NAME DESIRED CURRENT READY AGE replicaset.apps/redis-585bc66876 3 3 3 6m6s NAME REFERENCE TARGETS MINPODS MAXPODS REPLICAS AGE horizontalpodautoscaler.autoscaling/redis-hpa-c Deployment/redis 0%/80% 3 10 3 6m6s horizontalpodautoscaler.autoscaling/redis-hpa-m Deployment/redis 0%/80% 3 10 3 6m6s æµ‹è¯•æœåŠ¡$ kubectl run -i --tty --rm cli --image=redis:6-alpine -n adhoc -- sh /data # redis-cli -h redis-svc redis-svc:6379> set go-zero great OK redis-svc:6379> get go-zero \"great\" goctl kube æ€»ç»“ goctl å·¥å…·æå¤§ç®€åŒ–äº† K8S yaml æ–‡ä»¶çš„ç¼–å†™ï¼Œæä¾›äº†å¼€ç®±å³ç”¨çš„æœ€ä½³å®è·µï¼Œå¹¶ä¸”æ”¯æŒäº†æ¨¡æ¿è‡ªå®šä¹‰ã€‚ çŒœä½ æƒ³çœ‹ å‡†å¤‡å·¥ä½œ apiç›®å½• apiè¯­æ³• apié…ç½® apiå‘½ä»¤ä»‹ç» dockerä»‹ç» k8sä»‹ç» Copyright Â© 2019-2021 go-zero all right reservedï¼Œpowered by GitbookLast UpdateTimeï¼š 2025-05-05 05:44:52 "},"template-manage.html":{"url":"template-manage.html","title":"æ¨¡æ¿ç®¡ç†","keywords":"","body":"æ¨¡æ¿ç®¡ç† æ¨¡æ¿æ“ä½œ è‡ªå®šä¹‰æ¨¡æ¿ Copyright Â© 2019-2021 go-zero all right reservedï¼Œpowered by GitbookLast UpdateTimeï¼š 2025-05-05 05:44:52 "},"template-cmd.html":{"url":"template-cmd.html","title":"æ¨¡æ¿æ“ä½œ","keywords":"","body":"æ¨¡æ¿æ“ä½œ æ¨¡æ¿ï¼ˆTemplateï¼‰æ˜¯æ•°æ®é©±åŠ¨ç”Ÿæˆçš„åŸºç¡€ï¼Œæ‰€æœ‰çš„ä»£ç ï¼ˆrest apiã€rpcã€modelã€dockerã€kubeï¼‰ç”Ÿæˆéƒ½ä¼šä¾èµ–æ¨¡æ¿ï¼Œ é»˜è®¤æƒ…å†µä¸‹ï¼Œæ¨¡æ¿ç”Ÿæˆå™¨ä¼šé€‰æ‹©å†…å­˜ä¸­çš„æ¨¡æ¿è¿›è¡Œç”Ÿæˆï¼Œè€Œå¯¹äºæœ‰æ¨¡æ¿ä¿®æ”¹éœ€æ±‚çš„å¼€å‘è€…æ¥è®²ï¼Œåˆ™éœ€è¦å°†æ¨¡æ¿è¿›è¡Œè½ç›˜ï¼Œ ä»è€Œè¿›è¡Œæ¨¡æ¿ä¿®æ”¹ï¼Œåœ¨ä¸‹æ¬¡ä»£ç ç”Ÿæˆæ—¶ä¼šåŠ è½½æŒ‡å®šè·¯å¾„ä¸‹çš„æ¨¡æ¿è¿›è¡Œç”Ÿæˆã€‚ ä½¿ç”¨å¸®åŠ© NAME: goctl template - template operation USAGE: goctl template command [command options] [arguments...] COMMANDS: init initialize the all templates(force update) clean clean the all cache templates update update template of the target category to the latest revert revert the target template to the latest OPTIONS: --help, -h show help æ¨¡æ¿åˆå§‹åŒ– NAME: goctl template init - initialize the all templates(force update) USAGE: goctl template init [command options] [arguments...] OPTIONS: --home value the goctl home path of the template æ¸…é™¤æ¨¡æ¿ NAME: goctl template clean - clean the all cache templates USAGE: goctl template clean [command options] [arguments...] OPTIONS: --home value the goctl home path of the template å›æ»šæŒ‡å®šåˆ†ç±»æ¨¡æ¿ NAME: goctl template update - update template of the target category to the latest USAGE: goctl template update [command options] [arguments...] OPTIONS: --category value, -c value the category of template, enum [api,rpc,model,docker,kube] --home value the goctl home path of the template å›æ»šæ¨¡æ¿ NAME: goctl template revert - revert the target template to the latest USAGE: goctl template revert [command options] [arguments...] OPTIONS: --category value, -c value the category of template, enum [api,rpc,model,docker,kube] --name value, -n value the target file name of template --home value the goctl home path of the template [!TIP] --home æŒ‡å®šæ¨¡æ¿å­˜å‚¨è·¯å¾„ æ¨¡æ¿åŠ è½½ åœ¨ä»£ç ç”Ÿæˆæ—¶å¯ä»¥é€šè¿‡--homeæ¥æŒ‡å®šæ¨¡æ¿æ‰€åœ¨æ–‡ä»¶å¤¹ï¼Œç›®å‰å·²æ”¯æŒæŒ‡å®šæ¨¡æ¿ç›®å½•çš„å‘½ä»¤æœ‰ï¼š goctl api go è¯¦æƒ…å¯ä»¥é€šè¿‡goctl api go --helpæŸ¥çœ‹å¸®åŠ© goctl docker è¯¦æƒ…å¯ä»¥é€šè¿‡goctl docker --helpæŸ¥çœ‹å¸®åŠ© goctl kube è¯¦æƒ…å¯ä»¥é€šè¿‡goctl kube --helpæŸ¥çœ‹å¸®åŠ© goctl rpc new è¯¦æƒ…å¯ä»¥é€šè¿‡goctl rpc new --helpæŸ¥çœ‹å¸®åŠ© goctl rpc proto è¯¦æƒ…å¯ä»¥é€šè¿‡goctl rpc proto --helpæŸ¥çœ‹å¸®åŠ© goctl model mysql ddl è¯¦æƒ…å¯ä»¥é€šè¿‡goctl model mysql ddl --helpæŸ¥çœ‹å¸®åŠ© goctl model mysql datasource è¯¦æƒ…å¯ä»¥é€šè¿‡goctl model mysql datasource --helpæŸ¥çœ‹å¸®åŠ© goctl model pg datasource è¯¦æƒ…å¯ä»¥é€šè¿‡goctl model pg datasource --helpæŸ¥çœ‹å¸®åŠ© goctl model mongo è¯¦æƒ…å¯ä»¥é€šè¿‡goctl model mongo --helpæŸ¥çœ‹å¸®åŠ© é»˜è®¤æƒ…å†µï¼ˆåœ¨ä¸æŒ‡å®š--homeï¼‰ä¼šä»$HOME/.goctlç›®å½•ä¸‹è¯»å–ã€‚ ä½¿ç”¨ç¤ºä¾‹ åˆå§‹åŒ–æ¨¡æ¿åˆ°æŒ‡å®š$HOME/templateç›®å½•ä¸‹$ goctl template init --home $HOME/template Templates are generated in /Users/anqiansong/template, edit on your risk! ä½¿ç”¨$HOME/templateæ¨¡æ¿è¿›è¡Œgreet rpcç”Ÿæˆ$ goctl rpc new greet --home $HOME/template Done Copyright Â© 2019-2021 go-zero all right reservedï¼Œpowered by GitbookLast UpdateTimeï¼š 2025-05-05 05:44:52 "},"template.html":{"url":"template.html","title":"è‡ªå®šä¹‰æ¨¡æ¿","keywords":"","body":"æ¨¡æ¿ä¿®æ”¹ åœºæ™¯ å®ç°ç»Ÿä¸€æ ¼å¼çš„bodyå“åº”ï¼Œæ ¼å¼å¦‚ä¸‹ï¼š { \"code\": 0, \"msg\": \"OK\", \"data\": {} // â‘  } â‘  å®é™…å“åº”æ•°æ® [!TIP] go-zeroç”Ÿæˆçš„ä»£ç æ²¡æœ‰å¯¹å…¶è¿›è¡Œå¤„ç† å‡†å¤‡å·¥ä½œ æˆ‘ä»¬æå‰åœ¨moduleä¸ºgreetçš„å·¥ç¨‹ä¸‹çš„responseåŒ…ä¸­å†™ä¸€ä¸ªResponseæ–¹æ³•ï¼Œç›®å½•æ ‘ç±»ä¼¼å¦‚ä¸‹ï¼š greet â”œâ”€â”€ response â”‚ â””â”€â”€ response.go â””â”€â”€ xxx... ä»£ç å¦‚ä¸‹ package response import ( \"net/http\" \"github.com/zeromicro/go-zero/rest/httpx\" ) type Body struct { Code int `json:\"code\"` Msg string `json:\"msg\"` Data interface{} `json:\"data,omitempty\"` } func Response(w http.ResponseWriter, resp interface{}, err error) { var body Body if err != nil { body.Code = -1 body.Msg = err.Error() } else { body.Msg = \"OK\" body.Data = resp } httpx.OkJson(w, body) } ä¿®æ”¹handleræ¨¡æ¿ $ vim ~/.goctl/api/handler.tpl å°†æ¨¡æ¿æ›¿æ¢ä¸ºä»¥ä¸‹å†…å®¹ package handler import ( \"net/http\" \"greet/response\"// â‘  {% raw %} {{.ImportPackages}} {% endraw %} ) {% raw %} func {{.HandlerName}}(ctx *svc.ServiceContext) http.HandlerFunc { return func(w http.ResponseWriter, r *http.Request) { {{if .HasRequest}}var req types.{{.RequestType}} if err := httpx.Parse(r, &req); err != nil { httpx.Error(w, err) return }{{end}} l := logic.New{{.LogicType}}(r.Context(), ctx) {{if .HasResp}}resp, {{end}}err := l.{{.Call}}({{if .HasRequest}}req{{end}}) {{if .HasResp}}response.Response(w, resp, err){{else}}response.Response(w, nil, err){{end}}//â‘¡ } } {% endraw %} â‘  æ›¿æ¢ä¸ºä½ çœŸå®çš„responseåŒ…åï¼Œä»…ä¾›å‚è€ƒ â‘¡ è‡ªå®šä¹‰æ¨¡æ¿å†…å®¹ [!TIP] 1.å¦‚æœæœ¬åœ°æ²¡æœ‰~/.goctl/api/handler.tplæ–‡ä»¶ï¼Œå¯ä»¥é€šè¿‡æ¨¡æ¿åˆå§‹åŒ–å‘½ä»¤goctl template initè¿›è¡Œåˆå§‹åŒ– ä¿®æ”¹æ¨¡æ¿å‰åå¯¹æ¯” ä¿®æ”¹å‰ func GreetHandler(ctx *svc.ServiceContext) http.HandlerFunc { return func(w http.ResponseWriter, r *http.Request) { var req types.Request if err := httpx.Parse(r, &req); err != nil { httpx.Error(w, err) return } l := logic.NewGreetLogic(r.Context(), ctx) resp, err := l.Greet(req) // ä»¥ä¸‹å†…å®¹å°†è¢«è‡ªå®šä¹‰æ¨¡æ¿æ›¿æ¢ if err != nil { httpx.Error(w, err) } else { httpx.OkJson(w, resp) } } } ä¿®æ”¹å func GreetHandler(ctx *svc.ServiceContext) http.HandlerFunc { return func(w http.ResponseWriter, r *http.Request) { var req types.Request if err := httpx.Parse(r, &req); err != nil { httpx.Error(w, err) return } l := logic.NewGreetLogic(r.Context(), ctx) resp, err := l.Greet(req) response.Response(w, resp, err) } } ä¿®æ”¹æ¨¡æ¿å‰åå“åº”ä½“å¯¹æ¯” ä¿®æ”¹å‰ { \"message\": \"Hello go-zero!\" } ä¿®æ”¹å { \"code\": 0, \"msg\": \"OK\", \"data\": { \"message\": \"Hello go-zero!\" } } æ€»ç»“ æœ¬æ–‡æ¡£ä»…å¯¹httpç›¸åº”ä¸ºä¾‹è®²è¿°äº†è‡ªå®šä¹‰æ¨¡æ¿çš„æµç¨‹ï¼Œé™¤æ­¤ä¹‹å¤–ï¼Œè‡ªå®šä¹‰æ¨¡æ¿çš„åœºæ™¯è¿˜æœ‰ï¼š model å±‚æ·»åŠ kmq model å±‚ç”Ÿæˆå¾…æœ‰æ•ˆæœŸoptionçš„modelå®ä¾‹ httpè‡ªå®šä¹‰ç›¸åº”æ ¼å¼ ... Copyright Â© 2019-2021 go-zero all right reservedï¼Œpowered by GitbookLast UpdateTimeï¼š 2025-05-05 05:44:52 "},"extended-reading.html":{"url":"extended-reading.html","title":"æ‰©å±•é˜…è¯»","keywords":"","body":"æ‰©å±•é˜…è¯» æ‰©å±•é˜…è¯»æ˜¯å¯¹go-zero ä¸­çš„æœ€ä½³å®ç°å’Œç»„ä»¶çš„ä»‹ç»ï¼Œ å› æ­¤ä¼šæ¯”è¾ƒåºå¤§ï¼Œè€Œæ­¤èµ„æºå°†ä¼šæŒç»­æ›´æ–°ï¼Œä¹Ÿæ¬¢è¿å¤§å®¶æ¥è¿›è¡Œæ–‡æ¡£è´¡çŒ®ï¼Œæœ¬èŠ‚å°†åŒ…å«ä»¥ä¸‹ç›®å½•ï¼ˆæŒ‰ç…§æ–‡æ¡£æ›´æ–°æ—¶é—´æ’åºï¼‰ï¼š å¿«é€Ÿæ„å»ºé«˜å¹¶å‘å¾®æœåŠ¡ æ—¥å¿—ç»„ä»¶ä»‹ç» å¸ƒéš†è¿‡æ»¤å™¨ executors æµå¤„ç†ç»„ä»¶ fx go-zero mysqlä½¿ç”¨ä»‹ç» redisé” periodlimité™æµ ä»¤ç‰Œæ¡¶é™æµ æ—¶é—´è½®ä»‹ç» ç†”æ–­åŸç†ä¸å®ç° è¿›ç¨‹å†…ç¼“å­˜ç»„ä»¶ collection.Cache é«˜æ•ˆçš„å…³é”®è¯æ›¿æ¢å’Œæ•æ„Ÿè¯è¿‡æ»¤å·¥å…· æœåŠ¡è‡ªé€‚åº”é™è½½ä¿æŠ¤è®¾è®¡ æ–‡æœ¬åºåˆ—åŒ–å’Œååºåˆ—åŒ– å¹¶å‘å¤„ç†å·¥å…· MapReduce åŸºäºprometheusçš„å¾®æœåŠ¡æŒ‡æ ‡ç›‘æ§ é˜²æ­¢ç¼“å­˜å‡»ç©¿ä¹‹è¿›ç¨‹å†…å…±äº«è°ƒç”¨ DBç¼“å­˜æœºåˆ¶ zrpc ä½¿ç”¨ä»‹ç» go-zeroç¼“å­˜è®¾è®¡ä¹‹æŒä¹…å±‚ç¼“å­˜ go-zeroç¼“å­˜è®¾è®¡ä¹‹ä¸šåŠ¡å±‚ç¼“å­˜ go-zeroåˆ†å¸ƒå¼å®šæ—¶ä»»åŠ¡ æˆ‘æ˜¯å¦‚ä½•ç”¨go-zero å®ç°ä¸€ä¸ªä¸­å°ç³»ç»Ÿ æµæ•°æ®å¤„ç†åˆ©å™¨ 10æœˆ3æ—¥çº¿ä¸Šäº¤æµé—®é¢˜æ±‡æ€» Copyright Â© 2019-2021 go-zero all right reservedï¼Œpowered by GitbookLast UpdateTimeï¼š 2025-05-05 05:44:52 "},"logx.html":{"url":"logx.html","title":"æ—¥å¿—ç»„ä»¶ä»‹ç»","keywords":"","body":"logx ä½¿ç”¨ç¤ºä¾‹ var c logx.LogConf // ä» yaml æ–‡ä»¶ä¸­ åˆå§‹åŒ–é…ç½® conf.MustLoad(\"config.yaml\", &c) // logx æ ¹æ®é…ç½®åˆå§‹åŒ– logx.MustSetup(c) logx.Info(\"This is info!\") logx.Infof(\"This is %s!\", \"info\") logx.Error(\"This is error!\") logx.Errorf(\"this is %s!\", \"error\") logx.Close() åˆå§‹åŒ– logx æœ‰å¾ˆå¤šå¯ä»¥é…ç½®é¡¹ï¼Œå¯ä»¥å‚è€ƒ logx.LogConf ä¸­çš„å®šä¹‰ã€‚ç›®å‰å¯ä»¥ä½¿ç”¨ logx.MustSetUp(c) è¿›è¡Œåˆå§‹åŒ–é…ç½®ï¼Œå¦‚æœæ²¡æœ‰è¿›è¡Œåˆå§‹åŒ–é…ç½®ï¼Œæ‰€æœ‰çš„é…ç½®å°†ä½¿ç”¨é»˜è®¤é…ç½®ã€‚ Level logx æ”¯æŒçš„æ‰“å°æ—¥å¿—çº§åˆ«æœ‰ï¼š alert info error severe fatal slow stat å¯ä»¥ä½¿ç”¨å¯¹åº”çš„æ–¹æ³•æ‰“å°å‡ºå¯¹åº”çº§åˆ«çš„æ—¥å¿—ã€‚ åŒæ—¶ä¸ºäº†æ–¹ä¾¿è°ƒè¯•ï¼Œçº¿ä¸Šä½¿ç”¨ï¼Œå¯ä»¥åŠ¨æ€è°ƒæ•´æ—¥å¿—æ‰“å°çº§åˆ«ï¼Œå…¶ä¸­å¯ä»¥é€šè¿‡ logx.SetLevel(uint32) è¿›è¡Œçº§åˆ«è®¾ç½®ï¼Œä¹Ÿå¯ä»¥é€šè¿‡é…ç½®åˆå§‹åŒ–è¿›è¡Œè®¾ç½®ã€‚ç›®å‰æ”¯æŒçš„å‚æ•°ä¸ºï¼š const ( // æ‰“å°æ‰€æœ‰çº§åˆ«çš„æ—¥å¿— InfoLevel = iota // æ‰“å° errors, slows, stacks æ—¥å¿— ErrorLevel // ä»…æ‰“å° severe çº§åˆ«æ—¥å¿— SevereLevel ) æ—¥å¿—æ¨¡å¼ ç›®å‰æ—¥å¿—æ‰“å°æ¨¡å¼ä¸»è¦åˆ†ä¸º2ç§ï¼Œä¸€ç§æ–‡ä»¶è¾“å‡ºï¼Œä¸€ç§æ§åˆ¶å°è¾“å‡ºã€‚æ¨èæ–¹å¼ï¼Œå½“é‡‡ç”¨ k8sï¼Œdocker ç­‰éƒ¨ç½²æ–¹å¼çš„æ—¶å€™ï¼Œå¯ä»¥å°†æ—¥å¿—è¾“å‡ºåˆ°æ§åˆ¶å°ï¼Œä½¿ç”¨æ—¥å¿—æ”¶é›†å™¨æ”¶é›†å¯¼å…¥è‡³ es è¿›è¡Œæ—¥å¿—åˆ†æã€‚å¦‚æœæ˜¯ç›´æ¥éƒ¨ç½²æ–¹å¼ï¼Œå¯ä»¥é‡‡ç”¨æ–‡ä»¶è¾“å‡ºæ–¹å¼ï¼Œlogx ä¼šè‡ªåŠ¨åœ¨æŒ‡å®šæ–‡ä»¶ç›®å½•åˆ›å»ºå¯¹åº” 5 ä¸ªå¯¹åº”çº§åˆ«çš„çš„æ—¥å¿—æ–‡ä»¶ä¿å­˜æ—¥å¿—ã€‚ . â”œâ”€â”€ access.log â”œâ”€â”€ error.log â”œâ”€â”€ severe.log â”œâ”€â”€ slow.log â””â”€â”€ stat.log åŒæ—¶ä¼šæŒ‰ç…§è‡ªç„¶æ—¥è¿›è¡Œæ–‡ä»¶åˆ†å‰²ï¼Œå½“è¶…è¿‡æŒ‡å®šé…ç½®å¤©æ•°ï¼Œä¼šå¯¹æ—¥å¿—æ–‡ä»¶è¿›è¡Œè‡ªåŠ¨åˆ é™¤ï¼Œæ‰“åŒ…ç­‰æ“ä½œã€‚ ç¦ç”¨æ—¥å¿— å¦‚æœä¸éœ€è¦æ—¥å¿—æ‰“å°ï¼Œå¯ä»¥ä½¿ç”¨ logx.Close() å…³é—­æ—¥å¿—è¾“å‡ºã€‚æ³¨æ„ï¼Œå½“ç¦ç”¨æ—¥å¿—è¾“å‡ºï¼Œå°†æ— æ³•åœ¨æ¬¡æ‰“å¼€ï¼Œå…·ä½“å¯ä»¥å‚è€ƒ logx.RotateLogger å’Œ logx.DailyRotateRule çš„å®ç°ã€‚ å…³é—­æ—¥å¿— å› ä¸º logx é‡‡ç”¨å¼‚æ­¥è¿›è¡Œæ—¥å¿—è¾“å‡ºï¼Œå¦‚æœæ²¡æœ‰æ­£å¸¸å…³é—­æ—¥å¿—ï¼Œå¯èƒ½ä¼šé€ æˆéƒ¨åˆ†æ—¥å¿—ä¸¢å¤±çš„æƒ…å†µã€‚å¿…é¡»åœ¨ç¨‹åºé€€å‡ºçš„åœ°æ–¹å…³é—­æ—¥å¿—è¾“å‡ºï¼š logx.Close() æ¡†æ¶ä¸­ rest å’Œ zrpc ç­‰å¤§éƒ¨åˆ†åœ°æ–¹å·²ç»åšå¥½äº†æ—¥å¿—é…ç½®å’Œå…³é—­ç›¸å…³æ“ä½œï¼Œç”¨æˆ·å¯ä»¥ä¸ç”¨å…³å¿ƒã€‚ åŒæ—¶æ³¨æ„ï¼Œå½“å…³é—­æ—¥å¿—è¾“å‡ºä¹‹åï¼Œå°†æ— æ³•åœ¨æ¬¡æ‰“å°æ—¥å¿—äº†ã€‚ æ¨èå†™æ³•ï¼š import \"github.com/zeromicro/go-zero/core/proc\" // grace close log proc.AddShutdownListener(func() { logx.Close() }) Duration æˆ‘ä»¬æ‰“å°æ—¥å¿—çš„æ—¶å€™å¯èƒ½éœ€è¦æ‰“å°è€—æ—¶æƒ…å†µï¼Œå¯ä»¥ä½¿ç”¨ logx.WithDuration(time.Duration), å‚è€ƒå¦‚ä¸‹ç¤ºä¾‹ï¼š startTime := timex.Now() // æ•°æ®åº“æŸ¥è¯¢ rows, err := conn.Query(q, args...) duration := timex.Since(startTime) if duration > slowThreshold { logx.WithDuration(duration).Slowf(\"[SQL] query: slowcall - %s\", stmt) } else { logx.WithDuration(duration).Infof(\"sql query: %s\", stmt) } ä¼šè¾“å‡ºå¦‚ä¸‹æ ¼å¼ {\"@timestamp\":\"2020-09-12T01:22:55.552+08\",\"level\":\"info\",\"duration\":\"3.0ms\",\"content\":\"sql query:...\"} {\"@timestamp\":\"2020-09-12T01:22:55.552+08\",\"level\":\"slow\",\"duration\":\"500ms\",\"content\":\"[SQL] query: slowcall - ...\"} è¿™æ ·å°±å¯ä»¥å¾ˆå®¹æ˜“ç»Ÿè®¡å‡ºæ…¢ sql ç›¸å…³ä¿¡æ¯ã€‚ TraceLog tracingEntry æ˜¯ä¸ºäº†é“¾è·¯è¿½è¸ªæ—¥å¿—è¾“å‡ºå®šåˆ¶çš„ã€‚å¯ä»¥æ‰“å° context ä¸­çš„ traceId å’Œ spanId ä¿¡æ¯ï¼Œé…åˆæˆ‘ä»¬çš„ rest å’Œ zrpc å¾ˆå®¹æ˜“å®Œæˆé“¾è·¯æ—¥å¿—çš„ç›¸å…³æ‰“å°ã€‚ç¤ºä¾‹å¦‚ä¸‹ logx.WithContext(context.Context).Info(\"This is info!\") SysLog åº”ç”¨ä¸­å¯èƒ½æœ‰éƒ¨åˆ†é‡‡ç”¨ç³»ç»Ÿ log è¿›è¡Œæ—¥å¿—æ‰“å°ï¼Œlogx åŒæ ·å°è£…æ–¹æ³•ï¼Œå¾ˆå®¹æ˜“å°† log ç›¸å…³çš„æ—¥å¿—æ”¶é›†åˆ° logx ä¸­æ¥ã€‚ logx.CollectSysLog() æ—¥å¿—é…ç½®ç›¸å…³ LogConf å®šä¹‰æ—¥å¿—ç³»ç»Ÿæ‰€éœ€çš„åŸºæœ¬é…ç½® å®Œæ•´å®šä¹‰å¦‚ä¸‹ï¼š type LogConf struct { ServiceName string `json:\",optional\"` Mode string `json:\",default=console,options=console|file|volume\"` Path string `json:\",default=logs\"` Level string `json:\",default=info,options=info|error|severe\"` Compress bool `json:\",optional\"` KeepDays int `json:\",optional\"` StackCooldownMillis int `json:\",default=100\"` } Mode Mode å®šä¹‰äº†æ—¥å¿—æ‰“å°çš„æ–¹å¼ã€‚é»˜è®¤çš„æ¨¡å¼æ˜¯ consoleï¼Œ æ‰“å°åˆ°æ§åˆ¶å°ä¸Šé¢ã€‚ ç›®å‰æ”¯æŒçš„æ¨¡å¼å¦‚ä¸‹ï¼š console æ‰“å°åˆ°æ§åˆ¶å° file æ‰“å°åˆ°æŒ‡å®šè·¯å¾„ä¸‹çš„access.log, error.log, stat.logç­‰æ–‡ä»¶é‡Œ volume ä¸ºäº†åœ¨k8så†…æ‰“å°åˆ°mountè¿›æ¥çš„å­˜å‚¨ä¸Šï¼Œå› ä¸ºå¤šä¸ªpodå¯èƒ½ä¼šè¦†ç›–ç›¸åŒçš„æ–‡ä»¶ï¼Œvolumeæ¨¡å¼è‡ªåŠ¨è¯†åˆ«podå¹¶æŒ‰ç…§podåˆ†å¼€å†™å„è‡ªçš„æ—¥å¿—æ–‡ä»¶ Path Path å®šä¹‰äº†æ–‡ä»¶æ—¥å¿—çš„è¾“å‡ºè·¯å¾„ï¼Œé»˜è®¤å€¼ä¸º logsã€‚ Level Level å®šä¹‰äº†æ—¥å¿—æ‰“å°çº§åˆ«ï¼Œé»˜è®¤å€¼ä¸º infoã€‚ ç›®å‰æ”¯æŒçš„çº§åˆ«å¦‚ä¸‹: info error severe Compress Compress å®šä¹‰äº†æ—¥å¿—æ˜¯å¦éœ€è¦å‹ç¼©ï¼Œé»˜è®¤å€¼ä¸º falseã€‚åœ¨ Mode ä¸º file æ¨¡å¼ä¸‹é¢ï¼Œæ–‡ä»¶æœ€åä¼šè¿›è¡Œæ‰“åŒ…å‹ç¼©æˆ .gz æ–‡ä»¶ã€‚ KeepDays KeepDays å®šä¹‰æ—¥å¿—æœ€å¤§ä¿ç•™å¤©æ•°ï¼Œé»˜è®¤å€¼ä¸º 0ï¼Œè¡¨ç¤ºä¸ä¼šåˆ é™¤æ—§çš„æ—¥å¿—ã€‚åœ¨ Mode ä¸º file æ¨¡å¼ä¸‹é¢ï¼Œå¦‚æœè¶…è¿‡äº†æœ€å¤§ä¿ç•™å¤©æ•°ï¼Œæ—§çš„æ—¥å¿—æ–‡ä»¶å°†ä¼šè¢«åˆ é™¤ã€‚ StackCooldownMillis StackCooldownMillis å®šä¹‰äº†æ—¥å¿—è¾“å‡ºé—´éš”ï¼Œé»˜è®¤ä¸º 100 æ¯«ç§’ã€‚ Copyright Â© 2019-2021 go-zero all right reservedï¼Œpowered by GitbookLast UpdateTimeï¼š 2025-05-05 05:44:52 "},"bloom.html":{"url":"bloom.html","title":"å¸ƒéš†è¿‡æ»¤å™¨","keywords":"","body":"bloom go-zeroå¾®æœåŠ¡æ¡†æ¶ä¸­æä¾›äº†è®¸å¤šå¼€ç®±å³ç”¨çš„å·¥å…·ï¼Œå¥½çš„å·¥å…·ä¸ä»…èƒ½æå‡æœåŠ¡çš„æ€§èƒ½è€Œä¸”è¿˜èƒ½æå‡ä»£ç çš„é²æ£’æ€§é¿å…å‡ºé”™ï¼Œå®ç°ä»£ç é£æ ¼çš„ç»Ÿä¸€æ–¹ä¾¿ä»–äººé˜…è¯»ç­‰ç­‰ï¼Œæœ¬ç³»åˆ—æ–‡ç« å°†åˆ†åˆ«ä»‹ç»go-zeroæ¡†æ¶ä¸­å·¥å…·çš„ä½¿ç”¨åŠå…¶å®ç°åŸç† å¸ƒéš†è¿‡æ»¤å™¨bloom åœ¨åšæœåŠ¡å™¨å¼€å‘çš„æ—¶å€™ï¼Œç›¸ä¿¡å¤§å®¶æœ‰å¬è¿‡å¸ƒéš†è¿‡æ»¤å™¨ï¼Œå¯ä»¥åˆ¤æ–­æŸå…ƒç´ åœ¨ä¸åœ¨é›†åˆé‡Œé¢,å› ä¸ºå­˜åœ¨ä¸€å®šçš„è¯¯åˆ¤å’Œåˆ é™¤å¤æ‚é—®é¢˜,ä¸€èˆ¬çš„ä½¿ç”¨åœºæ™¯æ˜¯:é˜²æ­¢ç¼“å­˜å‡»ç©¿(é˜²æ­¢æ¶æ„æ”»å‡»)ã€ åƒåœ¾é‚®ç®±è¿‡æ»¤ã€cache digests ã€æ¨¡å‹æ£€æµ‹å™¨ç­‰ã€åˆ¤æ–­æ˜¯å¦å­˜åœ¨æŸè¡Œæ•°æ®,ç”¨ä»¥å‡å°‘å¯¹ç£ç›˜è®¿é—®ï¼Œæé«˜æœåŠ¡çš„è®¿é—®æ€§èƒ½ã€‚ go-zero æä¾›çš„ç®€å•çš„ç¼“å­˜å°è£… bloom.bloomï¼Œç®€å•ä½¿ç”¨æ–¹å¼å¦‚ä¸‹ // åˆå§‹åŒ– redisBitSet store := redis.New(\"redis åœ°å€\", func(r *redis.Redis) { r.Type = redis.NodeType }) // å£°æ˜ä¸€ä¸ªbitSet, key=\"test_key\"åä¸”bitsæ˜¯1024ä½ bitSet := newRedisBitSet(store, \"test_key\", 1024) // åˆ¤æ–­ç¬¬0ä½bitå­˜ä¸å­˜åœ¨ isSetBefore, err := bitSet.check([]uint{0}) // å¯¹ç¬¬512ä½è®¾ç½®ä¸º1 err = bitSet.set([]uint{512}) // 3600ç§’åè¿‡æœŸ err = bitSet.expire(3600) // åˆ é™¤è¯¥bitSet err = bitSet.del() bloom ç®€å•ä»‹ç»äº†æœ€åŸºæœ¬çš„redis bitset çš„ä½¿ç”¨ã€‚ä¸‹é¢æ˜¯çœŸæ­£çš„bloomå®ç°ã€‚ å¯¹å…ƒç´ hash å®šä½ // å¯¹å…ƒç´ è¿›è¡Œhash 14æ¬¡(const maps=14),æ¯æ¬¡éƒ½åœ¨å…ƒç´ åè¿½åŠ byte(0-13),ç„¶åè¿›è¡Œhash. // å°†locations[0-13] è¿›è¡Œå–æ¨¡,æœ€ç»ˆè¿”å›locations. func (f *BloomFilter) getLocations(data []byte) []uint { locations := make([]uint, maps) for i := uint(0); i å‘bloomé‡Œé¢add å…ƒç´  // æˆ‘ä»¬å¯ä»¥å‘ç° addæ–¹æ³•ä½¿ç”¨äº†getLocationså’ŒbitSetçš„setæ–¹æ³•ã€‚ // æˆ‘ä»¬å°†å…ƒç´ è¿›è¡Œhashæˆé•¿åº¦14çš„uintåˆ‡ç‰‡,ç„¶åè¿›è¡Œsetæ“ä½œå­˜åˆ°redisçš„bitSeté‡Œé¢ã€‚ func (f *BloomFilter) Add(data []byte) error { locations := f.getLocations(data) err := f.bitSet.set(locations) if err != nil { return err } return nil } æ£€æŸ¥bloomé‡Œé¢æ˜¯å¦æœ‰æŸå…ƒç´  // æˆ‘ä»¬å¯ä»¥å‘ç° Existsæ–¹æ³•ä½¿ç”¨äº†getLocationså’ŒbitSetçš„checkæ–¹æ³• // æˆ‘ä»¬å°†å…ƒç´ è¿›è¡Œhashæˆé•¿åº¦14çš„uintåˆ‡ç‰‡,ç„¶åè¿›è¡ŒbitSetçš„checkéªŒè¯,å­˜åœ¨è¿”å›true,ä¸å­˜åœ¨æˆ–è€…checkå¤±è´¥è¿”å›false func (f *BloomFilter) Exists(data []byte) (bool, error) { locations := f.getLocations(data) isSet, err := f.bitSet.check(locations) if err != nil { return false, err } if !isSet { return false, nil } return true, nil } æœ¬èŠ‚ä¸»è¦ä»‹ç»äº†go-zeroæ¡†æ¶ä¸­çš„ core.bloom å·¥å…·ï¼Œåœ¨å®é™…çš„é¡¹ç›®ä¸­éå¸¸å®ç”¨ã€‚ç”¨å¥½å·¥å…·å¯¹äºæå‡æœåŠ¡æ€§èƒ½å’Œå¼€å‘æ•ˆç‡éƒ½æœ‰å¾ˆå¤§çš„å¸®åŠ©ï¼Œå¸Œæœ›æœ¬ç¯‡æ–‡ç« èƒ½ç»™å¤§å®¶å¸¦æ¥ä¸€äº›æ”¶è·ã€‚ Copyright Â© 2019-2021 go-zero all right reservedï¼Œpowered by GitbookLast UpdateTimeï¼š 2025-05-05 05:44:52 "},"executors.html":{"url":"executors.html","title":"executors","keywords":"","body":"executors åœ¨ go-zero ä¸­ï¼Œexecutors å……å½“ä»»åŠ¡æ± ï¼Œåšå¤šä»»åŠ¡ç¼“å†²ï¼Œé€‚ç”¨äºåšæ‰¹é‡å¤„ç†çš„ä»»åŠ¡ã€‚å¦‚ï¼šclickhouse å¤§æ‰¹é‡ insertï¼Œsql batch insertã€‚åŒæ—¶ä¹Ÿå¯ä»¥åœ¨ go-queue ä¸­çœ‹åˆ° executors ã€åœ¨ queue é‡Œé¢ä½¿ç”¨çš„æ˜¯ ChunkExecutor ï¼Œé™å®šä»»åŠ¡æäº¤å­—èŠ‚å¤§å°ã€‘ã€‚ æ‰€ä»¥å½“ä½ å­˜åœ¨ä»¥ä¸‹éœ€æ±‚ï¼Œéƒ½å¯ä»¥ä½¿ç”¨è¿™ä¸ªç»„ä»¶ï¼š æ‰¹é‡æäº¤ä»»åŠ¡ ç¼“å†²ä¸€éƒ¨åˆ†ä»»åŠ¡ï¼Œæƒ°æ€§æäº¤ å»¶è¿Ÿä»»åŠ¡æäº¤ å…·ä½“è§£é‡Šä¹‹å‰ï¼Œå…ˆç»™ä¸€ä¸ªå¤§è‡´çš„æ¦‚è§ˆå›¾ï¼š æ¥å£è®¾è®¡ åœ¨ executors åŒ…ä¸‹ï¼Œæœ‰å¦‚ä¸‹å‡ ä¸ª executor ï¼š Name Margin value bulkexecutor è¾¾åˆ° maxTasks ã€æœ€å¤§ä»»åŠ¡æ•°ã€‘ æäº¤ chunkexecutor è¾¾åˆ° maxChunkSizeã€æœ€å¤§å­—èŠ‚æ•°ã€‘æäº¤ periodicalexecutor basic executor delayexecutor å»¶è¿Ÿæ‰§è¡Œä¼ å…¥çš„ fn() lessexecutor ä½ ä¼šçœ‹åˆ°é™¤äº†æœ‰ç‰¹æ®ŠåŠŸèƒ½çš„ delayï¼Œless ï¼Œå…¶ä½™ 3 ä¸ªéƒ½æ˜¯ executor + container çš„ç»„åˆè®¾è®¡ï¼š func NewBulkExecutor(execute Execute, opts ...BulkOption) *BulkExecutor { // é€‰é¡¹æ¨¡å¼ï¼šåœ¨ go-zero ä¸­å¤šå¤„å‡ºç°ã€‚åœ¨å¤šé…ç½®ä¸‹ï¼Œæ¯”è¾ƒå¥½çš„è®¾è®¡æ€è·¯ // https://halls-of-valhalla.org/beta/articles/functional-options-pattern-in-go,54/ options := newBulkOptions() for _, opt := range opts { opt(&options) } // 1. task container: [execute çœŸæ­£åšæ‰§è¡Œçš„å‡½æ•°] [maxTasks æ‰§è¡Œä¸´ç•Œç‚¹] container := &bulkContainer{ execute: execute, maxTasks: options.cachedTasks, } // 2. å¯ä»¥çœ‹å‡º bulkexecutor åº•å±‚ä¾èµ– periodicalexecutor executor := &BulkExecutor{ executor: NewPeriodicalExecutor(options.flushInterval, container), container: container, } return executor } è€Œè¿™ä¸ª containeræ˜¯ä¸ª interfaceï¼š TaskContainer interface { // æŠŠ task åŠ å…¥ container AddTask(task interface{}) bool // å®é™…ä¸Šæ˜¯å»æ‰§è¡Œä¼ å…¥çš„ execute func() Execute(tasks interface{}) // è¾¾åˆ°ä¸´ç•Œå€¼ï¼Œç§»é™¤ container ä¸­å…¨éƒ¨çš„ taskï¼Œé€šè¿‡ channel ä¼ é€’åˆ° execute func() æ‰§è¡Œ RemoveAll() interface{} } ç”±æ­¤å¯è§ä¹‹é—´çš„ä¾èµ–å…³ç³»ï¼š bulkexecutorï¼šperiodicalexecutor + bulkContainer chunkexecutorï¼šperiodicalexecutor + chunkContainer [!TIP] æ‰€ä»¥ä½ æƒ³å®Œæˆè‡ªå·±çš„ executorï¼Œå¯ä»¥å®ç° container çš„è¿™ 3 ä¸ªæ¥å£ï¼Œå†ç»“åˆ periodicalexecutor å°±è¡Œ æ‰€ä»¥å›åˆ°ğŸ‘†é‚£å¼ å›¾ï¼Œæˆ‘ä»¬çš„é‡ç‚¹å°±æ”¾åœ¨ periodicalexecutorï¼Œçœ‹çœ‹å®ƒæ˜¯æ€ä¹ˆè®¾è®¡çš„ï¼Ÿ å¦‚ä½•ä½¿ç”¨ é¦–å…ˆçœ‹çœ‹å¦‚ä½•åœ¨ä¸šåŠ¡ä¸­ä½¿ç”¨è¿™ä¸ªç»„ä»¶ï¼š ç°æœ‰ä¸€ä¸ªå®šæ—¶æœåŠ¡ï¼Œæ¯å¤©å›ºå®šæ—¶é—´å»æ‰§è¡Œä» mysql åˆ° clickhouse çš„æ•°æ®åŒæ­¥ï¼š type DailyTask struct { ckGroup *clickhousex.Cluster insertExecutor *executors.BulkExecutor mysqlConn sqlx.SqlConn } åˆå§‹åŒ– bulkExecutorï¼š func (dts *DailyTask) Init() { // insertIntoCk() æ˜¯çœŸæ­£insertæ‰§è¡Œå‡½æ•°ã€éœ€è¦å¼€å‘è€…è‡ªå·±ç¼–å†™å…·ä½“ä¸šåŠ¡é€»è¾‘ã€‘ dts.insertExecutor = executors.NewBulkExecutor( dts.insertIntoCk, executors.WithBulkInterval(time.Second*3), // 3sä¼šè‡ªåŠ¨åˆ·ä¸€æ¬¡containerä¸­taskå»æ‰§è¡Œ executors.WithBulkTasks(10240), // containeræœ€å¤§taskæ•°ã€‚ä¸€èˆ¬è®¾ä¸º2çš„å¹‚æ¬¡ ) } [!TIP] é¢å¤–ä»‹ç»ä¸€ä¸‹ï¼šclickhouse é€‚åˆå¤§æ‰¹é‡çš„æ’å…¥ï¼Œå› ä¸º insert é€Ÿåº¦å¾ˆå¿«ï¼Œå¤§æ‰¹é‡ insert æ›´èƒ½å……åˆ†åˆ©ç”¨ clickhouse ä¸»ä½“ä¸šåŠ¡é€»è¾‘ç¼–å†™ï¼š func (dts *DailyTask) insertNewData(ch chan interface{}, sqlFromDb *model.Task) error { for item := range ch { if r, vok := item.(*model.Task); !vok { continue } err := dts.insertExecutor.Add(r) if err != nil { r.Tag = sqlFromDb.Tag r.TagId = sqlFromDb.Id r.InsertId = genInsertId() r.ToRedis = toRedis == constant.INCACHED r.UpdateWay = sqlFromDb.UpdateWay // 1. Add Task err := dts.insertExecutor.Add(r) if err != nil { logx.Error(err) } } } // 2. Flush Task container dts.insertExecutor.Flush() // 3. Wait All Task Finish dts.insertExecutor.Wait() } [!TIP] å¯èƒ½ä¼šç–‘æƒ‘ä¸ºä»€ä¹ˆè¦ Flush(), Wait() ï¼Œåé¢ä¼šé€šè¿‡æºç è§£æä¸€ä¸‹ ä½¿ç”¨ä¸Šæ€»ä½“åˆ†ä¸º 3 æ­¥ï¼š Add()ï¼šåŠ å…¥ task Flush()ï¼šåˆ·æ–° container ä¸­çš„ task Wait()ï¼šç­‰å¾…å…¨éƒ¨ task æ‰§è¡Œå®Œæˆ æºç åˆ†æ [!TIP] æ­¤å¤„ä¸»è¦åˆ†æ periodicalexecutorï¼Œå› ä¸ºå…¶ä»–ä¸¤ä¸ªå¸¸ç”¨çš„ executor éƒ½ä¾èµ–å®ƒ åˆå§‹åŒ– func New...(interval time.Duration, container TaskContainer) *PeriodicalExecutor { executor := &PeriodicalExecutor{ commander: make(chan interface{}, 1), interval: interval, container: container, confirmChan: make(chan lang.PlaceholderType), newTicker: func(d time.Duration) timex.Ticker { return timex.NewTicker(interval) }, } ... return executor } commanderï¼šä¼ é€’ tasks çš„ channel containerï¼šæš‚å­˜ Add() çš„ task confirmChanï¼šé˜»å¡ Add() ï¼Œåœ¨å¼€å§‹æœ¬æ¬¡çš„ executeTasks() ä¼šæ”¾å¼€é˜»å¡ tickerï¼šå®šæ—¶å™¨ï¼Œé˜²æ­¢ Add() é˜»å¡æ—¶ï¼Œä¼šæœ‰ä¸€ä¸ªå®šæ—¶æ‰§è¡Œçš„æœºä¼šï¼ŒåŠæ—¶é‡Šæ”¾æš‚å­˜çš„ task Add() åˆå§‹åŒ–å®Œï¼Œåœ¨ä¸šåŠ¡é€»è¾‘çš„ç¬¬ä¸€æ­¥å°±æ˜¯æŠŠ task åŠ å…¥ executorï¼š func (pe *PeriodicalExecutor) Add(task interface{}) { if vals, ok := pe.addAndCheck(task); ok { pe.commander =maxTask å°†containerä¸­tasks pop, return if pe.container.AddTask(task) { return pe.container.RemoveAll(), true } return nil, false } addAndCheck() ä¸­ AddTask() å°±æ˜¯åœ¨æ§åˆ¶æœ€å¤§ tasks æ•°ï¼Œå¦‚æœè¶…è¿‡å°±æ‰§è¡Œ RemoveAll() ï¼Œå°†æš‚å­˜ container çš„ tasks popï¼Œä¼ é€’ç»™ commander ï¼Œåé¢æœ‰ goroutine å¾ªç¯è¯»å–ï¼Œç„¶åå»æ‰§è¡Œ tasksã€‚ backgroundFlush() å¼€å¯ä¸€ä¸ªåå°åç¨‹ï¼Œå¯¹ container ä¸­çš„ taskï¼Œä¸æ–­åˆ·æ–°ï¼š func (pe *PeriodicalExecutor) backgroundFlush() { // å°è£… go func(){} threading.GoSafe(func() { ticker := pe.newTicker(pe.interval) defer ticker.Stop() var commanded bool last := timex.Now() for { select { // ä»channelæ‹¿åˆ° []tasks case vals := pe.interval*idleRound { // æ—¢æ²¡åˆ°maxTaskï¼ŒFlush() errï¼Œå¹¶ä¸” last->now æ—¶é—´è¿‡é•¿ï¼Œä¼šå†æ¬¡è§¦å‘ Flush() // åªæœ‰è¿™ç½®åï¼Œæ‰ä¼šå¼€å¯ä¸€ä¸ªæ–°çš„ backgroundFlush() åå°åç¨‹ pe.guarded = false // å†æ¬¡åˆ·æ–°ï¼Œé˜²æ­¢æ¼æ‰ pe.Flush() return } } } }) } æ€»ä½“ä¸¤ä¸ªè¿‡ç¨‹ï¼š commander æ¥æ”¶åˆ° RemoveAll() ä¼ é€’æ¥çš„ tasksï¼Œç„¶åæ‰§è¡Œï¼Œå¹¶æ”¾å¼€ Add() çš„é˜»å¡ï¼Œå¾—ä»¥ç»§ç»­ Add() ticker åˆ°æ—¶é—´äº†ï¼Œå¦‚æœç¬¬ä¸€æ­¥æ²¡æœ‰æ‰§è¡Œï¼Œåˆ™è‡ªåŠ¨ Flush() ï¼Œä¹Ÿä¼šå»åš task çš„æ‰§è¡Œ Wait() åœ¨ backgroundFlush() ï¼Œæåˆ°ä¸€ä¸ªå‡½æ•°ï¼šenterExecution()ï¼š func (pe *PeriodicalExecutor) enterExecution() { pe.wgBarrier.Guard(func() { pe.waitGroup.Add(1) }) } func (pe *PeriodicalExecutor) Wait() { pe.wgBarrier.Guard(func() { pe.waitGroup.Wait() }) } è¿™æ ·åˆ—ä¸¾å°±çŸ¥é“ä¸ºä»€ä¹ˆä¹‹å‰åœ¨æœ€åè¦å¸¦ä¸Š dts.insertExecutor.Wait()ï¼Œå½“ç„¶è¦ç­‰å¾…å…¨éƒ¨çš„ goroutine task å®Œæˆã€‚ æ€è€ƒ åœ¨çœ‹æºç ä¸­ï¼Œæ€è€ƒäº†ä¸€äº›å…¶ä»–è®¾è®¡ä¸Šçš„æ€è·¯ï¼Œå¤§å®¶æ˜¯å¦ä¹Ÿæœ‰ç±»ä¼¼çš„é—®é¢˜ï¼š åœ¨åˆ†æ executors ä¸­ï¼Œä¼šå‘ç°å¾ˆå¤šåœ°æ–¹éƒ½æœ‰ lock [!TIP] go test å­˜åœ¨ç«æ€ï¼Œä½¿ç”¨åŠ é”æ¥é¿å…è¿™ç§æƒ…å†µ åœ¨åˆ†æ confirmChan æ—¶å‘ç°ï¼ŒconfirmChan åœ¨æ­¤æ¬¡æäº¤æ‰å‡ºç°ï¼Œä¸ºä»€ä¹ˆä¼šè¿™ä¹ˆè®¾è®¡ï¼Ÿ ä¹‹å‰æ˜¯ï¼šwg.Add(1) æ˜¯å†™åœ¨ executeTasks() ï¼›ç°åœ¨æ˜¯ï¼šå…ˆwg.Add(1)ï¼Œå†æ”¾å¼€ confirmChan é˜»å¡ å¦‚æœ executor func æ‰§è¡Œé˜»å¡ï¼ŒAdd task è¿˜åœ¨è¿›è¡Œï¼Œå› ä¸ºæ²¡æœ‰é˜»å¡ï¼Œå¯èƒ½å¾ˆå¿«æ‰§è¡Œåˆ° Executor.Wait()ï¼Œè¿™æ—¶å°±ä¼šå‡ºç° wg.Wait() åœ¨ wg.Add() å‰æ‰§è¡Œï¼Œè¿™ä¼š panic å…·ä½“å¯ä»¥çœ‹æœ€æ–°ç‰ˆæœ¬çš„TestPeriodicalExecutor_WaitFast() ï¼Œä¸å¦¨è·‘åœ¨æ­¤ç‰ˆæœ¬ä¸Šï¼Œå°±å¯ä»¥é‡ç° æ€»ç»“ å‰©ä½™è¿˜æœ‰å‡ ä¸ª executors çš„åˆ†æï¼Œå°±ç•™ç»™å¤§å®¶å»çœ‹çœ‹æºç ã€‚ æ€»ä¹‹ï¼Œæ•´ä½“è®¾è®¡ä¸Šï¼š éµå¾ªé¢å‘æ¥å£è®¾è®¡ çµæ´»ä½¿ç”¨ channel ï¼Œwaitgroup ç­‰å¹¶å‘å·¥å…· æ‰§è¡Œå•å…ƒ+å­˜å‚¨å•å…ƒçš„æ­é…ä½¿ç”¨ åœ¨ go-zero ä¸­è¿˜æœ‰å¾ˆå¤šå®ç”¨çš„ç»„ä»¶å·¥å…·ï¼Œç”¨å¥½å·¥å…·å¯¹äºæå‡æœåŠ¡æ€§èƒ½å’Œå¼€å‘æ•ˆç‡éƒ½æœ‰å¾ˆå¤§çš„å¸®åŠ©ï¼Œå¸Œæœ›æœ¬ç¯‡æ–‡ç« èƒ½ç»™å¤§å®¶å¸¦æ¥ä¸€äº›æ”¶è·ã€‚ Copyright Â© 2019-2021 go-zero all right reservedï¼Œpowered by GitbookLast UpdateTimeï¼š 2025-05-05 05:44:52 "},"fx.html":{"url":"fx.html","title":"æµå¤„ç†ç»„ä»¶ fx","keywords":"","body":"æ•°æ®çš„æµå¤„ç†åˆ©å™¨ æµå¤„ç†(Stream processing)æ˜¯ä¸€ç§è®¡ç®—æœºç¼–ç¨‹èŒƒå¼ï¼Œå…¶å…è®¸ç»™å®šä¸€ä¸ªæ•°æ®åºåˆ—(æµå¤„ç†æ•°æ®æº)ï¼Œä¸€ç³»åˆ—æ•°æ®æ“ä½œ(å‡½æ•°)è¢«åº”ç”¨åˆ°æµä¸­çš„æ¯ä¸ªå…ƒç´ ã€‚åŒæ—¶æµå¤„ç†å·¥å…·å¯ä»¥æ˜¾è‘—æé«˜ç¨‹åºå‘˜çš„å¼€å‘æ•ˆç‡ï¼Œå…è®¸ä»–ä»¬ç¼–å†™æœ‰æ•ˆã€å¹²å‡€å’Œç®€æ´çš„ä»£ç ã€‚ æµæ•°æ®å¤„ç†åœ¨æˆ‘ä»¬çš„æ—¥å¸¸å·¥ä½œä¸­éå¸¸å¸¸è§ï¼Œä¸¾ä¸ªä¾‹å­ï¼Œæˆ‘ä»¬åœ¨ä¸šåŠ¡å¼€å‘ä¸­å¾€å¾€ä¼šè®°å½•è®¸å¤šä¸šåŠ¡æ—¥å¿—ï¼Œè¿™äº›æ—¥å¿—ä¸€èˆ¬æ˜¯å…ˆå‘é€åˆ°Kafkaï¼Œç„¶åå†ç”±Jobæ¶ˆè´¹Kafakaå†™åˆ°elasticsearchï¼Œåœ¨è¿›è¡Œæ—¥å¿—æµå¤„ç†çš„è¿‡ç¨‹ä¸­ï¼Œå¾€å¾€è¿˜ä¼šå¯¹æ—¥å¿—åšä¸€äº›å¤„ç†ï¼Œæ¯”å¦‚è¿‡æ»¤æ— æ•ˆçš„æ—¥å¿—ï¼Œåšä¸€äº›è®¡ç®—ä»¥åŠé‡æ–°ç»„åˆæ—¥å¿—ç­‰ç­‰ï¼Œç¤ºæ„å›¾å¦‚ä¸‹: æµå¤„ç†å·¥å…·fx gozeroæ˜¯ä¸€ä¸ªåŠŸèƒ½å®Œå¤‡çš„å¾®æœåŠ¡æ¡†æ¶ï¼Œæ¡†æ¶ä¸­å†…ç½®äº†å¾ˆå¤šéå¸¸å®ç”¨çš„å·¥å…·ï¼Œå…¶ä¸­å°±åŒ…å«æµæ•°æ®å¤„ç†å·¥å…·fxï¼Œä¸‹é¢æˆ‘ä»¬é€šè¿‡ä¸€ä¸ªç®€å•çš„ä¾‹å­æ¥è®¤è¯†ä¸‹è¯¥å·¥å…·ï¼š package main import ( \"fmt\" \"os\" \"os/signal\" \"syscall\" \"time\" \"github.com/zeromicro/go-zero/core/fx\" ) func main() { ch := make(chan int) go inputStream(ch) go outputStream(ch) c := make(chan os.Signal, 1) signal.Notify(c, syscall.SIGTERM, syscall.SIGINT) inputStreamå‡½æ•°æ¨¡æ‹Ÿäº†æµæ•°æ®çš„äº§ç”Ÿï¼ŒoutputStreamå‡½æ•°æ¨¡æ‹Ÿäº†æµæ•°æ®çš„å¤„ç†è¿‡ç¨‹ï¼Œå…¶ä¸­Fromå‡½æ•°ä¸ºæµçš„è¾“å…¥ï¼ŒWalkå‡½æ•°å¹¶å‘çš„ä½œç”¨åœ¨æ¯ä¸€ä¸ªitemä¸Šï¼ŒFilterå‡½æ•°å¯¹itemè¿›è¡Œè¿‡æ»¤ä¸ºtrueä¿ç•™ä¸ºfalseä¸ä¿ç•™ï¼ŒForEachå‡½æ•°éå†è¾“å‡ºæ¯ä¸€ä¸ªitemå…ƒç´ ã€‚ æµæ•°æ®å¤„ç†ä¸­é—´æ“ä½œ ä¸€ä¸ªæµçš„æ•°æ®å¤„ç†å¯èƒ½å­˜åœ¨è®¸å¤šçš„ä¸­é—´æ“ä½œï¼Œæ¯ä¸ªä¸­é—´æ“ä½œéƒ½å¯ä»¥ä½œç”¨åœ¨æµä¸Šã€‚å°±åƒæµæ°´çº¿ä¸Šçš„å·¥äººä¸€æ ·ï¼Œæ¯ä¸ªå·¥äººæ“ä½œå®Œé›¶ä»¶åéƒ½ä¼šè¿”å›å¤„ç†å®Œæˆçš„æ–°é›¶ä»¶ï¼ŒåŒç†æµå¤„ç†ä¸­é—´æ“ä½œå®Œæˆåä¹Ÿä¼šè¿”å›ä¸€ä¸ªæ–°çš„æµã€‚ fxçš„æµå¤„ç†ä¸­é—´æ“ä½œ: æ“ä½œå‡½æ•° åŠŸèƒ½ è¾“å…¥ Distinct å»é™¤é‡å¤çš„item KeyFuncï¼Œè¿”å›éœ€è¦å»é‡çš„key Filter è¿‡æ»¤ä¸æ»¡è¶³æ¡ä»¶çš„item FilterFuncï¼ŒOptionæ§åˆ¶å¹¶å‘é‡ Group å¯¹itemè¿›è¡Œåˆ†ç»„ KeyFuncï¼Œä»¥keyè¿›è¡Œåˆ†ç»„ Head å–å‡ºå‰nä¸ªitemï¼Œè¿”å›æ–°stream int64ä¿ç•™æ•°é‡ Map å¯¹è±¡è½¬æ¢ MapFuncï¼ŒOptionæ§åˆ¶å¹¶å‘é‡ Merge åˆå¹¶itemåˆ°sliceå¹¶ç”Ÿæˆæ–°stream Reverse åè½¬item Sort å¯¹itemè¿›è¡Œæ’åº LessFuncå®ç°æ’åºç®—æ³• Tail ä¸HeadåŠŸèƒ½ç±»ä¼¼ï¼Œå–å‡ºånä¸ªitemç»„æˆæ–°stream int64ä¿ç•™æ•°é‡ Walk ä½œç”¨åœ¨æ¯ä¸ªitemä¸Š WalkFuncï¼ŒOptionæ§åˆ¶å¹¶å‘é‡ ä¸‹å›¾å±•ç¤ºäº†æ¯ä¸ªæ­¥éª¤å’Œæ¯ä¸ªæ­¥éª¤çš„ç»“æœ: ç”¨æ³•ä¸åŸç†åˆ†æ From é€šè¿‡Fromå‡½æ•°æ„å»ºæµå¹¶è¿”å›Streamï¼Œæµæ•°æ®é€šè¿‡channelè¿›è¡Œå­˜å‚¨ï¼š // ä¾‹å­ s := []int{1, 2, 3, 4, 5, 6, 7, 8, 9, 0} fx.From(func(source chan Filter Filterå‡½æ•°æä¾›è¿‡æ»¤itemçš„åŠŸèƒ½ï¼ŒFilterFuncå®šä¹‰è¿‡æ»¤é€»è¾‘trueä¿ç•™itemï¼Œfalseåˆ™ä¸ä¿ç•™: // ä¾‹å­ ä¿ç•™å¶æ•° s := []int{1, 2, 3, 4, 5, 6, 7, 8, 9, 0} fx.From(func(source chan Group Groupå¯¹æµæ•°æ®è¿›è¡Œåˆ†ç»„ï¼Œéœ€å®šä¹‰åˆ†ç»„çš„keyï¼Œæ•°æ®åˆ†ç»„åä»¥sliceå­˜å…¥channel: // ä¾‹å­ æŒ‰ç…§é¦–å­—ç¬¦\"g\"æˆ–è€…\"p\"åˆ†ç»„ï¼Œæ²¡æœ‰åˆ™åˆ†åˆ°å¦ä¸€ç»„ ss := []string{\"golang\", \"google\", \"php\", \"python\", \"java\", \"c++\"} fx.From(func(source chan Reverse reverseå¯ä»¥å¯¹æµä¸­å…ƒç´ è¿›è¡Œåè½¬å¤„ç†: // ä¾‹å­ fx.Just(1, 2, 3, 4, 5).Reverse().ForEach(func(item interface{}) { fmt.Println(item) }) // æºç  func (p Stream) Reverse() Stream { var items []interface{} // è·å–æµä¸­æ•°æ® for item := range p.source { items = append(items, item) } // åè½¬ç®—æ³• for i := len(items)/2 - 1; i >= 0; i-- { opp := len(items) - 1 - i items[i], items[opp] = items[opp], items[i] } // å†™å…¥æµ return Just(items...) } Distinct distinctå¯¹æµä¸­å…ƒç´ è¿›è¡Œå»é‡ï¼Œå»é‡åœ¨ä¸šåŠ¡å¼€å‘ä¸­æ¯”è¾ƒå¸¸ç”¨ï¼Œç»å¸¸éœ€è¦å¯¹ç”¨æˆ·idç­‰åšå»é‡æ“ä½œ: // ä¾‹å­ fx.Just(1, 2, 2, 2, 3, 3, 4, 5, 6).Distinct(func(item interface{}) interface{} { return item }).ForEach(func(item interface{}) { fmt.Println(item) }) // ç»“æœä¸º 1ï¼Œ2ï¼Œ3ï¼Œ4ï¼Œ5ï¼Œ6 // æºç  func (p Stream) Distinct(fn KeyFunc) Stream { source := make(chan interface{}) threading.GoSafe(func() { defer close(source) // é€šè¿‡keyè¿›è¡Œå»é‡ï¼Œç›¸åŒkeyåªä¿ç•™ä¸€ä¸ª keys := make(map[interface{}]lang.PlaceholderType) for item := range p.source { key := fn(item) // keyå­˜åœ¨åˆ™ä¸ä¿ç•™ if _, ok := keys[key]; !ok { source Walk Walkå‡½æ•°å¹¶å‘çš„ä½œç”¨åœ¨æµä¸­æ¯ä¸€ä¸ªitemä¸Šï¼Œå¯ä»¥é€šè¿‡WithWorkersè®¾ç½®å¹¶å‘æ•°ï¼Œé»˜è®¤å¹¶å‘æ•°ä¸º16ï¼Œæœ€å°å¹¶å‘æ•°ä¸º1ï¼Œå¦‚è®¾ç½®unlimitedWorkersä¸ºtrueåˆ™å¹¶å‘æ•°æ— é™åˆ¶ï¼Œä½†å¹¶å‘å†™å…¥æµä¸­çš„æ•°æ®ç”±defaultWorkersé™åˆ¶ï¼ŒWalkFuncä¸­ç”¨æˆ·å¯ä»¥è‡ªå®šä¹‰åç»­å†™å…¥æµä¸­çš„å…ƒç´ ï¼Œå¯ä»¥ä¸å†™å…¥ä¹Ÿå¯ä»¥å†™å…¥å¤šä¸ªå…ƒç´ : // ä¾‹å­ fx.Just(\"aaa\", \"bbb\", \"ccc\").Walk(func(item interface{}, pipe chan å¹¶å‘å¤„ç† fxå·¥å…·é™¤äº†è¿›è¡Œæµæ•°æ®å¤„ç†ä»¥å¤–è¿˜æä¾›äº†å‡½æ•°å¹¶å‘åŠŸèƒ½ï¼Œåœ¨å¾®æœåŠ¡ä¸­å®ç°æŸä¸ªåŠŸèƒ½å¾€å¾€éœ€è¦ä¾èµ–å¤šä¸ªæœåŠ¡ï¼Œå¹¶å‘çš„å¤„ç†ä¾èµ–å¯ä»¥æœ‰æ•ˆçš„é™ä½ä¾èµ–è€—æ—¶ï¼Œæå‡æœåŠ¡çš„æ€§èƒ½ã€‚ fx.Parallel(func() { userRPC() // ä¾èµ–1 }, func() { accountRPC() // ä¾èµ–2 }, func() { orderRPC() // ä¾èµ–3 }) æ³¨æ„fx.Parallelè¿›è¡Œä¾èµ–å¹¶è¡Œå¤„ç†çš„æ—¶å€™ä¸ä¼šæœ‰errorè¿”å›ï¼Œå¦‚éœ€æœ‰errorè¿”å›æˆ–è€…æœ‰ä¸€ä¸ªä¾èµ–æŠ¥é”™éœ€è¦ç«‹é©¬ç»“æŸä¾èµ–è¯·æ±‚è¯·ä½¿ç”¨MapReduceå·¥å…·è¿›è¡Œå¤„ç†ã€‚ æ€»ç»“ æœ¬ç¯‡æ–‡ç« ä»‹ç»äº†æµå¤„ç†çš„åŸºæœ¬æ¦‚å¿µå’Œgozeroä¸­çš„æµå¤„ç†å·¥å…·fxï¼Œåœ¨å®é™…çš„ç”Ÿäº§ä¸­æµå¤„ç†åœºæ™¯åº”ç”¨ä¹Ÿéå¸¸å¤šï¼Œå¸Œæœ›æœ¬ç¯‡æ–‡ç« èƒ½ç»™å¤§å®¶å¸¦æ¥ä¸€å®šçš„å¯å‘ï¼Œæ›´å¥½çš„åº”å¯¹å·¥ä½œä¸­çš„æµå¤„ç†åœºæ™¯ã€‚ Copyright Â© 2019-2021 go-zero all right reservedï¼Œpowered by GitbookLast UpdateTimeï¼š 2025-05-05 05:44:52 "},"mysql.html":{"url":"mysql.html","title":"go-zero mysqlä½¿ç”¨ä»‹ç»","keywords":"","body":"mysql go-zero æä¾›æ›´æ˜“äºæ“ä½œçš„ mysql APIã€‚ [!TIP] ä½†æ˜¯ stores/mysql å®šä½ä¸æ˜¯ä¸€ä¸ª orm æ¡†æ¶ï¼Œå¦‚æœä½ éœ€è¦é€šè¿‡ sql/scheme -> model/struct é€†å‘ç”Ÿæˆ model å±‚ä»£ç ï¼Œå¯ä»¥ä½¿ç”¨ã€Œgoctl modelã€ï¼Œè¿™ä¸ªæ˜¯æå¥½çš„åŠŸèƒ½ã€‚ Feature ç›¸æ¯”åŸç”Ÿï¼Œæä¾›å¯¹å¼€å‘è€…æ›´å‹å¥½çš„ API å®Œæˆ queryField -> struct çš„è‡ªåŠ¨èµ‹å€¼ æ‰¹é‡æ’å…¥ã€Œbulkinserterã€ è‡ªå¸¦ç†”æ–­ API ç»è¿‡è‹¥å¹²ä¸ªæœåŠ¡çš„ä¸æ–­è€ƒéªŒ æä¾› partial assignment ç‰¹æ€§ï¼Œä¸å¼ºåˆ¶ struct çš„ä¸¥æ ¼èµ‹å€¼ Connection ä¸‹é¢ç”¨ä¸€ä¸ªä¾‹å­ç®€å•è¯´æ˜ä¸€ä¸‹å¦‚ä½•åˆ›å»ºä¸€ä¸ª mysql è¿æ¥çš„ modelï¼š // 1. å¿«é€Ÿè¿æ¥ä¸€ä¸ª mysql // datasource: mysql dsn heraMysql := sqlx.NewMysql(datasource) // 2. åœ¨ servicecontext ä¸­è°ƒç”¨ï¼Œæ‡‚modelä¸Šå±‚çš„logicå±‚è°ƒç”¨ model.NewMysqlModel(heraMysql, tablename), // 3. modelå±‚ mysql operation func NewMysqlModel(conn sqlx.SqlConn, table string) *MysqlModel { defer func() { recover() }() // 4. åˆ›å»ºä¸€ä¸ªæ‰¹é‡insertçš„ [mysql executor] // conn: mysql connection; insertsql: mysql insert sql bulkInserter , err := sqlx.NewBulkInserter(conn, insertsql) if err != nil { logx.Error(\"Init bulkInsert Faild\") panic(\"Init bulkInsert Faild\") return nil } return &MysqlModel{conn: conn, table: table, Bulk: bulkInserter} } CRUD å‡†å¤‡ä¸€ä¸ª User model var userBuilderQueryRows = strings.Join(builder.FieldNames(&User{}), \",\") type User struct { Avatar string `db:\"avatar\"` // å¤´åƒ UserName string `db:\"user_name\"` // å§“å Sex int `db:\"sex\"` // 1ç”·,2å¥³ MobilePhone string `db:\"mobile_phone\"` // æ‰‹æœºå· } å…¶ä¸­ userBuilderQueryRows ï¼š go-zero ä¸­æä¾› struct -> [field...] çš„è½¬åŒ–ï¼Œå¼€å‘è€…å¯ä»¥å°†æ­¤å½“æˆæ¨¡ç‰ˆç›´æ¥ä½¿ç”¨ã€‚ insert // ä¸€ä¸ªå®é™…çš„insert modelå±‚æ“ä½œ func (um *UserModel) Insert(user *User) (int64, error) { const insertsql = `insert into `+um.table+` (`+userBuilderQueryRows+`) values(?, ?, ?)` // insert op res, err := um.conn.Exec(insertsql, user.Avatar, user.UserName, user.Sex, user.MobilePhone) if err != nil { logx.Errorf(\"insert User Position Model Model err, err=%v\", err) return -1, err } id, err := res.LastInsertId() if err != nil { logx.Errorf(\"insert User Model to Id parse id err,err=%v\", err) return -1, err } return id, nil } æ‹¼æ¥ insertsql å°† insertsql ä»¥åŠå ä½ç¬¦å¯¹åº”çš„ struct field ä¼ å…¥ -> con.Exex(insertsql, field...) [!WARNING] conn.Exec(sql, args...) ï¼š args... éœ€å¯¹åº” sql ä¸­çš„å ä½ç¬¦ã€‚ä¸ç„¶ä¼šå‡ºç°èµ‹å€¼å¼‚å¸¸çš„é—®é¢˜ã€‚ go-zero å°†æ¶‰åŠ mysql ä¿®æ”¹çš„æ“ä½œç»Ÿä¸€æŠ½è±¡ä¸º Exec() ã€‚æ‰€ä»¥ insert/update/delete æ“ä½œæœ¬è´¨ä¸Šæ˜¯ä¸€è‡´çš„ã€‚å…¶ä½™ä¸¤ä¸ªæ“ä½œï¼Œå¼€å‘è€…æŒ‰ç…§ä¸Šè¿° insert æµç¨‹å°è¯•å³å¯ã€‚ query åªéœ€è¦ä¼ å…¥ querysql å’Œ model ç»“æ„ä½“ï¼Œå°±å¯ä»¥è·å–åˆ°è¢«èµ‹å€¼å¥½çš„ model ã€‚æ— éœ€å¼€å‘è€…æ‰‹åŠ¨èµ‹å€¼ã€‚ func (um *UserModel) FindOne(uid int64) (*User, error) { var user User const querysql = `select `+userBuilderQueryRows+` from `+um.table+` where id=? limit 1` err := um.conn.QueryRow(&user, querysql, uid) if err != nil { logx.Errorf(\"userId.findOne error, id=%d, err=%s\", uid, err.Error()) if err == sqlx.ErrNotFound { return nil, ErrNotFound } return nil, err } return &user, nil } å£°æ˜ model struct ï¼Œæ‹¼æ¥ querysql conn.QueryRow(&model, querysql, args...) ï¼š args... ä¸ querysql ä¸­çš„å ä½ç¬¦å¯¹åº”ã€‚ [!WARNING] QueryRow() ä¸­ç¬¬ä¸€ä¸ªå‚æ•°éœ€è¦ä¼ å…¥ Ptr ã€Œåº•å±‚éœ€è¦åå°„å¯¹ struct è¿›è¡Œèµ‹å€¼ã€ ä¸Šè¿°æ˜¯æŸ¥è¯¢ä¸€æ¡è®°å½•ï¼Œå¦‚æœéœ€è¦æŸ¥è¯¢å¤šæ¡è®°å½•æ—¶ï¼Œå¯ä»¥ä½¿ç”¨ conn.QueryRows() func (um *UserModel) FindOne(sex int) ([]*User, error) { users := make([]*User, 0) const querysql = `select `+userBuilderQueryRows+` from `+um.table+` where sex=?` err := um.conn.QueryRows(&users, querysql, sex) if err != nil { logx.Errorf(\"usersSex.findOne error, sex=%d, err=%s\", uid, err.Error()) if err == sqlx.ErrNotFound { return nil, ErrNotFound } return nil, err } return users, nil } ä¸ QueryRow() ä¸åŒçš„åœ°æ–¹åœ¨äºï¼š model éœ€è¦è®¾ç½®æˆ Slice ï¼Œå› ä¸ºæ˜¯æŸ¥è¯¢å¤šè¡Œï¼Œéœ€è¦å¯¹å¤šä¸ª model èµ‹å€¼ã€‚ä½†åŒæ—¶éœ€è¦æ³¨æ„ï¸ï¼šç¬¬ä¸€ä¸ªå‚æ•°éœ€è¦ä¼ å…¥ Ptr querypartial ä»ä½¿ç”¨ä¸Šï¼Œä¸ä¸Šè¿°çš„ QueryRow() æ— å¼‚ã€Œè¿™æ­£ä½“ç°äº† go-zero é«˜åº¦çš„æŠ½è±¡è®¾è®¡ã€ã€‚ åŒºåˆ«ï¼š QueryRow() ï¼š len(querysql fields) == len(struct) ï¼Œä¸”ä¸€ä¸€å¯¹åº” QueryRowPartial() ï¼šlen(querysql fields) numAï¼šæ•°æ®åº“å­—æ®µæ•°ï¼›numBï¼šå®šä¹‰çš„ struct å±æ€§æ•°ã€‚ å¦‚æœ numA ï¼Œä½†æ˜¯ä½ æ°æ°åˆéœ€è¦ç»Ÿä¸€å¤šå¤„çš„æŸ¥è¯¢æ—¶ã€Œå®šä¹‰äº†å¤šä¸ª struct è¿”å›ä¸åŒçš„ç”¨é€”ï¼Œæ°æ°éƒ½å¯ä»¥ä½¿ç”¨ç›¸åŒçš„ querysql ã€ï¼Œå°±å¯ä»¥ä½¿ç”¨ QueryRowPartial() äº‹åŠ¡ è¦åœ¨äº‹åŠ¡ä¸­æ‰§è¡Œä¸€ç³»åˆ—æ“ä½œï¼Œä¸€èˆ¬æµç¨‹å¦‚ä¸‹ï¼š var insertsql = `insert into User(uid, username, mobilephone) values (?, ?, ?)` err := usermodel.conn.Transact(func(session sqlx.Session) error { stmt, err := session.Prepare(insertsql) if err != nil { return err } defer stmt.Close() // è¿”å›ä»»ä½•é”™è¯¯éƒ½ä¼šå›æ»šäº‹åŠ¡ if _, err := stmt.Exec(uid, username, mobilephone); err != nil { logx.Errorf(\"insert userinfo stmt exec: %s\", err) return err } // è¿˜å¯ä»¥ç»§ç»­æ‰§è¡Œ insert/update/delete ç›¸å…³æ“ä½œ return nil }) å¦‚åŒä¸Šè¿°ä¾‹å­ï¼Œå¼€å‘è€…åªéœ€å°† äº‹åŠ¡ ä¸­çš„æ“ä½œéƒ½åŒ…è£…åœ¨ä¸€ä¸ªå‡½æ•° func(session sqlx.Session) error {} ä¸­å³å¯ï¼Œå¦‚æœäº‹åŠ¡ä¸­çš„æ“ä½œè¿”å›ä»»ä½•é”™è¯¯ï¼Œ Transact() éƒ½ä¼šè‡ªåŠ¨å›æ»šäº‹åŠ¡ã€‚ åˆ†å¸ƒå¼äº‹åŠ¡ go-zero ä¸ dtm æ·±åº¦åˆä½œï¼ŒåŸç”Ÿçš„æ”¯æŒäº†åˆ†å¸ƒå¼äº‹åŠ¡ï¼Œè¯¦æƒ…å‚è§ åˆ†å¸ƒå¼äº‹åŠ¡æ”¯æŒ Copyright Â© 2019-2021 go-zero all right reservedï¼Œpowered by GitbookLast UpdateTimeï¼š 2025-05-05 05:44:52 "},"redis-lock.html":{"url":"redis-lock.html","title":"redisé”","keywords":"","body":"redis-lock redis lock æ—¢ç„¶æ˜¯é”ï¼Œé¦–å…ˆæƒ³åˆ°çš„ä¸€ä¸ªä½œç”¨å°±æ˜¯ï¼šé˜²é‡å¤ç‚¹å‡»ï¼Œåœ¨ä¸€ä¸ªæ—¶é—´ç‚¹åªæœ‰ä¸€ä¸ªè¯·æ±‚äº§ç”Ÿæ•ˆæœã€‚ è€Œæ—¢ç„¶æ˜¯ redisï¼Œå°±å¾—å…·æœ‰æ’ä»–æ€§ï¼ŒåŒæ—¶ä¹Ÿå…·æœ‰é”çš„ä¸€äº›å…±æ€§ï¼š é«˜æ€§èƒ½ ä¸èƒ½å‡ºç°æ­»é” ä¸èƒ½å‡ºç°èŠ‚ç‚¹downæ‰ååŠ é”å¤±è´¥ go-zero ä¸­åˆ©ç”¨ redis set key nx å¯ä»¥ä¿è¯keyä¸å­˜åœ¨æ—¶å†™å…¥æˆåŠŸï¼Œpx å¯ä»¥è®©keyè¶…æ—¶åè‡ªåŠ¨åˆ é™¤ã€Œæœ€åæƒ…å†µä¹Ÿå°±æ˜¯è¶…æ—¶è‡ªåŠ¨åˆ é™¤keyï¼Œä»è€Œä¹Ÿä¸ä¼šå‡ºç°æ­»é”ã€ example redisLockKey := fmt.Sprintf(\"%v%v\", redisTpl, headId) // 1. New redislock redisLock := redis.NewRedisLock(redisConn, redisLockKey) // 2. å¯é€‰æ“ä½œï¼Œè®¾ç½® redislock è¿‡æœŸæ—¶é—´ redisLock.SetExpire(redisLockExpireSeconds) if ok, err := redisLock.Acquire(); !ok || err != nil { return nil, errors.New(\"å½“å‰æœ‰å…¶ä»–ç”¨æˆ·æ­£åœ¨è¿›è¡Œæ“ä½œï¼Œè¯·ç¨åé‡è¯•\") } defer func() { recover() // 3. é‡Šæ”¾é” redisLock.Release() }() å’Œä½ åœ¨ä½¿ç”¨ sync.Mutex çš„æ–¹å¼æ—¶ä¸€è‡´çš„ã€‚åŠ é”è§£é”ï¼Œæ‰§è¡Œä½ çš„ä¸šåŠ¡æ“ä½œã€‚ è·å–é” lockCommand = `if redis.call(\"GET\", KEYS[1]) == ARGV[1] then redis.call(\"SET\", KEYS[1], ARGV[1], \"PX\", ARGV[2]) return \"OK\" else return redis.call(\"SET\", KEYS[1], ARGV[1], \"NX\", \"PX\", ARGV[2]) end` func (rl *RedisLock) Acquire() (bool, error) { seconds := atomic.LoadUint32(&rl.seconds) // execute luascript resp, err := rl.store.Eval(lockCommand, []string{rl.key}, []string{ rl.id, strconv.Itoa(int(seconds)*millisPerSecond + tolerance)}) if err == red.Nil { return false, nil } else if err != nil { logx.Errorf(\"Error on acquiring lock for %s, %s\", rl.key, err.Error()) return false, err } else if resp == nil { return false, nil } reply, ok := resp.(string) if ok && reply == \"OK\" { return true, nil } else { logx.Errorf(\"Unknown reply when acquiring lock for %s: %v\", rl.key, resp) return false, nil } } å…ˆä»‹ç»å‡ ä¸ª redis çš„å‘½ä»¤é€‰é¡¹ï¼Œä»¥ä¸‹æ˜¯ä¸º set å‘½ä»¤å¢åŠ çš„é€‰é¡¹ï¼š ex seconds ï¼šè®¾ç½®keyè¿‡æœŸæ—¶é—´ï¼Œå•ä½s px milliseconds ï¼šè®¾ç½®keyè¿‡æœŸæ—¶é—´ï¼Œå•ä½æ¯«ç§’ nxï¼škeyä¸å­˜åœ¨æ—¶ï¼Œè®¾ç½®keyçš„å€¼ xxï¼škeyå­˜åœ¨æ—¶ï¼Œæ‰ä¼šå»è®¾ç½®keyçš„å€¼ å…¶ä¸­ lua script æ¶‰åŠçš„å…¥å‚ï¼š args ç¤ºä¾‹ å«ä¹‰ KEYS[1] key$20201026 redis key ARGV[1] lmnopqrstuvwxyzABCD å”¯ä¸€æ ‡è¯†ï¼šéšæœºå­—ç¬¦ä¸² ARGV[2] 30000 è®¾ç½®é”çš„è¿‡æœŸæ—¶é—´ ç„¶åæ¥è¯´è¯´ä»£ç ç‰¹æ€§ï¼š Lua è„šæœ¬ä¿è¯åŸå­æ€§ã€Œå½“ç„¶ï¼ŒæŠŠå¤šä¸ªæ“ä½œåœ¨ Redis ä¸­å®ç°æˆä¸€ä¸ªæ“ä½œï¼Œä¹Ÿå°±æ˜¯å•å‘½ä»¤æ“ä½œã€ ä½¿ç”¨äº† set key value px milliseconds nx value å…·æœ‰å”¯ä¸€æ€§ åŠ é”æ—¶é¦–å…ˆåˆ¤æ–­ key çš„ value æ˜¯å¦å’Œä¹‹å‰è®¾ç½®çš„ä¸€è‡´ï¼Œä¸€è‡´åˆ™ä¿®æ”¹è¿‡æœŸæ—¶é—´ é‡Šæ”¾é” delCommand = `if redis.call(\"GET\", KEYS[1]) == ARGV[1] then return redis.call(\"DEL\", KEYS[1]) else return 0 end` func (rl *RedisLock) Release() (bool, error) { resp, err := rl.store.Eval(delCommand, []string{rl.key}, []string{rl.id}) if err != nil { return false, err } if reply, ok := resp.(int64); !ok { return false, nil } else { return reply == 1, nil } } é‡Šæ”¾é”çš„æ—¶å€™åªéœ€è¦å…³æ³¨ä¸€ç‚¹ï¼š ä¸èƒ½é‡Šæ”¾åˆ«äººçš„é”ï¼Œä¸èƒ½é‡Šæ”¾åˆ«äººçš„é”ï¼Œä¸èƒ½é‡Šæ”¾åˆ«äººçš„é” æ‰€ä»¥éœ€è¦å…ˆ get(key) == valueã€Œkeyã€ï¼Œä¸º true æ‰ä¼šå» delete Copyright Â© 2019-2021 go-zero all right reservedï¼Œpowered by GitbookLast UpdateTimeï¼š 2025-05-05 05:44:52 "},"periodlimit.html":{"url":"periodlimit.html","title":"periodlimité™æµ","keywords":"","body":"periodlimit ä¸ç®¡æ˜¯åœ¨å•ä½“æœåŠ¡ä¸­è¿˜æ˜¯åœ¨å¾®æœåŠ¡ä¸­ï¼Œå¼€å‘è€…ä¸ºå‰ç«¯æä¾›çš„APIæ¥å£éƒ½æ˜¯æœ‰è®¿é—®ä¸Šé™çš„ï¼Œå½“è®¿é—®é¢‘ç‡æˆ–è€…å¹¶å‘é‡è¶…è¿‡å…¶æ‰¿å—èŒƒå›´æ—¶å€™ï¼Œæˆ‘ä»¬å°±å¿…é¡»è€ƒè™‘é™æµæ¥ä¿è¯æ¥å£çš„å¯ç”¨æ€§æˆ–è€…é™çº§å¯ç”¨æ€§ã€‚å³æ¥å£ä¹Ÿéœ€è¦å®‰è£…ä¸Šä¿é™©ä¸ï¼Œä»¥é˜²æ­¢éé¢„æœŸçš„è¯·æ±‚å¯¹ç³»ç»Ÿå‹åŠ›è¿‡å¤§è€Œå¼•èµ·çš„ç³»ç»Ÿç˜«ç—ªã€‚ æœ¬æ–‡å°±æ¥ä»‹ç»ä¸€ä¸‹ periodlimit ã€‚ ä½¿ç”¨ const ( seconds = 1 total = 100 quota = 5 ) // New limiter l := NewPeriodLimit(seconds, quota, redis.NewRedis(s.Addr(), redis.NodeType), \"periodlimit\") // take source code, err := l.Take(\"first\") if err != nil { logx.Error(err) return true } // switch val => process request switch code { case limit.OverQuota: logx.Errorf(\"OverQuota key: %v\", key) return false case limit.Allowed: logx.Infof(\"AllowedQuota key: %v\", key) return true case limit.HitQuota: logx.Errorf(\"HitQuota key: %v\", key) // todo: maybe we need to let users know they hit the quota return false default: logx.Errorf(\"DefaultQuota key: %v\", key) // unknown response, we just let the sms go return true } periodlimit go-zero é‡‡å– æ»‘åŠ¨çª—å£ è®¡æ•°çš„æ–¹å¼ï¼Œè®¡ç®—ä¸€æ®µæ—¶é—´å†…å¯¹åŒä¸€ä¸ªèµ„æºçš„è®¿é—®æ¬¡æ•°ï¼Œå¦‚æœè¶…è¿‡æŒ‡å®šçš„ limit ï¼Œåˆ™æ‹’ç»è®¿é—®ã€‚å½“ç„¶å¦‚æœä½ æ˜¯åœ¨ä¸€æ®µæ—¶é—´å†…è®¿é—®ä¸åŒçš„èµ„æºï¼Œæ¯ä¸€ä¸ªèµ„æºè®¿é—®é‡éƒ½ä¸è¶…è¿‡ limit ï¼Œæ­¤ç§æƒ…å†µæ˜¯å…è®¸å¤§é‡è¯·æ±‚è¿›æ¥çš„ã€‚ è€Œåœ¨ä¸€ä¸ªåˆ†å¸ƒå¼ç³»ç»Ÿä¸­ï¼Œå­˜åœ¨å¤šä¸ªå¾®æœåŠ¡æä¾›æœåŠ¡ã€‚æ‰€ä»¥å½“ç¬é—´çš„æµé‡åŒæ—¶è®¿é—®åŒä¸€ä¸ªèµ„æºï¼Œå¦‚ä½•è®©è®¡æ•°å™¨åœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­æ­£å¸¸è®¡æ•°ï¼Ÿ åŒæ—¶åœ¨è®¡ç®—èµ„æºè®¿é—®æ—¶ï¼Œå¯èƒ½ä¼šæ¶‰åŠå¤šä¸ªè®¡ç®—ï¼Œå¦‚ä½•ä¿è¯è®¡ç®—çš„åŸå­æ€§ï¼Ÿ go-zero å€ŸåŠ© redis çš„ incrby åšèµ„æºè®¿é—®è®¡æ•° é‡‡ç”¨ lua script åšæ•´ä¸ªçª—å£è®¡ç®—ï¼Œä¿è¯è®¡ç®—çš„åŸå­æ€§ ä¸‹é¢æ¥çœ‹çœ‹ lua script æ§åˆ¶çš„å‡ ä¸ªå…³é”®å±æ€§ï¼š argument mean key[1] è®¿é—®èµ„æºçš„æ ‡ç¤º ARGV[1] limit => è¯·æ±‚æ€»æ•°ï¼Œè¶…è¿‡åˆ™é™é€Ÿã€‚å¯è®¾ç½®ä¸º QPS ARGV[2] windowå¤§å° => æ»‘åŠ¨çª—å£ï¼Œç”¨ ttl æ¨¡æ‹Ÿå‡ºæ»‘åŠ¨çš„æ•ˆæœ -- to be compatible with aliyun redis, -- we cannot use `local key = KEYS[1]` to reuse thekey local limit = tonumber(ARGV[1]) local window = tonumber(ARGV[2]) -- incrbt key 1 => key visis++ local current = redis.call(\"INCRBY\", KEYS[1], 1) -- å¦‚æœæ˜¯ç¬¬ä¸€æ¬¡è®¿é—®ï¼Œè®¾ç½®è¿‡æœŸæ—¶é—´ => TTL = window size -- å› ä¸ºæ˜¯åªé™åˆ¶ä¸€æ®µæ—¶é—´çš„è®¿é—®æ¬¡æ•° if current == 1 then redis.call(\"expire\", KEYS[1], window) return 1 elseif current è‡³äºä¸Šè¿°çš„ return code ï¼Œè¿”å›ç»™è°ƒç”¨æ–¹ã€‚ç”±è°ƒç”¨æ–¹æ¥å†³å®šè¯·æ±‚åç»­çš„æ“ä½œï¼š return code tag call code mean 0 OverQuota 3 over limit 1 Allowed 1 in limit 2 HitQuota 2 hit limit ä¸‹é¢è¿™å¼ å›¾æè¿°äº†è¯·æ±‚è¿›å…¥çš„è¿‡ç¨‹ï¼Œä»¥åŠè¯·æ±‚è§¦å‘ limit æ—¶åç»­å‘ç”Ÿçš„æƒ…å†µï¼š åç»­å¤„ç† å¦‚æœåœ¨æœåŠ¡æŸä¸ªæ—¶é—´ç‚¹ï¼Œè¯·æ±‚å¤§æ‰¹é‡æ‰“è¿›æ¥ï¼Œperiodlimit çŸ­æœŸæ—¶é—´å†…è¾¾åˆ° limit é˜ˆå€¼ï¼Œè€Œä¸”è®¾ç½®çš„æ—¶é—´èŒƒå›´è¿˜è¿œè¿œæ²¡æœ‰åˆ°è¾¾ã€‚åç»­è¯·æ±‚çš„å¤„ç†å°±æˆä¸ºé—®é¢˜ã€‚ periodlimit ä¸­å¹¶æ²¡æœ‰å¤„ç†ï¼Œè€Œæ˜¯è¿”å› code ã€‚æŠŠåç»­è¯·æ±‚çš„å¤„ç†äº¤ç»™äº†å¼€å‘è€…è‡ªå·±å¤„ç†ã€‚ å¦‚æœä¸åšå¤„ç†ï¼Œé‚£å°±æ˜¯ç®€å•çš„å°†è¯·æ±‚æ‹’ç» å¦‚æœéœ€è¦å¤„ç†è¿™äº›è¯·æ±‚ï¼Œå¼€å‘è€…å¯ä»¥å€ŸåŠ© mq å°†è¯·æ±‚ç¼“å†²ï¼Œå‡ç¼“è¯·æ±‚çš„å‹åŠ› é‡‡ç”¨ tokenlimitï¼Œå…è®¸æš‚æ—¶çš„æµé‡å†²å‡» æ‰€ä»¥ä¸‹ä¸€ç¯‡æˆ‘ä»¬å°±æ¥èŠèŠ tokenlimit æ€»ç»“ go-zero ä¸­çš„ periodlimit é™æµæ–¹æ¡ˆæ˜¯åŸºäº redis è®¡æ•°å™¨ï¼Œé€šè¿‡è°ƒç”¨ redis lua script ï¼Œä¿è¯è®¡æ•°è¿‡ç¨‹çš„åŸå­æ€§ï¼ŒåŒæ—¶ä¿è¯åœ¨åˆ†å¸ƒå¼çš„æƒ…å†µä¸‹è®¡æ•°æ˜¯æ­£å¸¸çš„ã€‚ä½†æ˜¯è¿™ç§æ–¹æ¡ˆå­˜åœ¨ç¼ºç‚¹ï¼Œå› ä¸ºå®ƒè¦è®°å½•æ—¶é—´çª—å£å†…çš„æ‰€æœ‰è¡Œä¸ºè®°å½•ï¼Œå¦‚æœè¿™ä¸ªé‡ç‰¹åˆ«å¤§çš„æ—¶å€™ï¼Œå†…å­˜æ¶ˆè€—ä¼šå˜å¾—éå¸¸ä¸¥é‡ã€‚ å‚è€ƒ go-zero periodlimit åˆ†å¸ƒå¼æœåŠ¡é™æµå®æˆ˜ï¼Œå·²ç»ä¸ºä½ æ’å¥½å‘äº† tokenlimit Copyright Â© 2019-2021 go-zero all right reservedï¼Œpowered by GitbookLast UpdateTimeï¼š 2025-05-05 05:44:52 "},"tokenlimit.html":{"url":"tokenlimit.html","title":"ä»¤ç‰Œæ¡¶é™æµ","keywords":"","body":"tokenlimit æœ¬èŠ‚å°†é€šè¿‡ä»¤ç‰Œæ¡¶é™æµï¼ˆtokenlimitï¼‰æ¥ä»‹ç»å…¶åŸºæœ¬ä½¿ç”¨ã€‚ ä½¿ç”¨ const ( burst = 100 rate = 100 seconds = 5 ) store := redis.NewRedis(\"localhost:6379\", \"node\", \"\") fmt.Println(store.Ping()) // New tokenLimiter limiter := limit.NewTokenLimiter(rate, burst, store, \"rate-test\") timer := time.NewTimer(time.Second * seconds) quit := make(chan struct{}) defer timer.Stop() go func() { tokenlimit ä»æ•´ä½“ä¸Šä»¤ç‰Œæ¡¶ç”Ÿäº§tokené€»è¾‘å¦‚ä¸‹ï¼š ç”¨æˆ·é…ç½®çš„å¹³å‡å‘é€é€Ÿç‡ä¸ºrï¼Œåˆ™æ¯éš”1/rç§’ä¸€ä¸ªä»¤ç‰Œè¢«åŠ å…¥åˆ°æ¡¶ä¸­ï¼› å‡è®¾æ¡¶ä¸­æœ€å¤šå¯ä»¥å­˜æ”¾bä¸ªä»¤ç‰Œã€‚å¦‚æœä»¤ç‰Œåˆ°è¾¾æ—¶ä»¤ç‰Œæ¡¶å·²ç»æ»¡äº†ï¼Œé‚£ä¹ˆè¿™ä¸ªä»¤ç‰Œä¼šè¢«ä¸¢å¼ƒï¼› å½“æµé‡ä»¥é€Ÿç‡vè¿›å…¥ï¼Œä»æ¡¶ä¸­ä»¥é€Ÿç‡vå–ä»¤ç‰Œï¼Œæ‹¿åˆ°ä»¤ç‰Œçš„æµé‡é€šè¿‡ï¼Œæ‹¿ä¸åˆ°ä»¤ç‰Œæµé‡ä¸é€šè¿‡ï¼Œæ‰§è¡Œç†”æ–­é€»è¾‘ï¼› go-zero åœ¨ä¸¤ç±»é™æµå™¨ä¸‹éƒ½é‡‡å– lua script çš„æ–¹å¼ï¼Œä¾èµ–rediså¯ä»¥åšåˆ°åˆ†å¸ƒå¼é™æµï¼Œlua scriptåŒæ—¶å¯ä»¥åšåˆ°å¯¹ token ç”Ÿäº§è¯»å–æ“ä½œçš„åŸå­æ€§ã€‚ ä¸‹é¢æ¥çœ‹çœ‹ lua script æ§åˆ¶çš„å‡ ä¸ªå…³é”®å±æ€§ï¼š argument mean ARGV[1] rate ã€Œæ¯ç§’ç”Ÿæˆå‡ ä¸ªä»¤ç‰Œã€ ARGV[2] burst ã€Œä»¤ç‰Œæ¡¶æœ€å¤§å€¼ã€ ARGV[3] now_timeã€Œå½“å‰æ—¶é—´æˆ³ã€ ARGV[4] get token nums ã€Œå¼€å‘è€…éœ€è¦è·å–çš„tokenæ•°ã€ KEYS[1] è¡¨ç¤ºèµ„æºçš„tokenkey KEYS[2] è¡¨ç¤ºåˆ·æ–°æ—¶é—´çš„key -- è¿”å›æ˜¯å¦å¯ä»¥æ´»è·å¾—é¢„æœŸçš„token local rate = tonumber(ARGV[1]) local capacity = tonumber(ARGV[2]) local now = tonumber(ARGV[3]) local requested = tonumber(ARGV[4]) -- fill_timeï¼šéœ€è¦å¡«æ»¡ token_bucket éœ€è¦å¤šä¹… local fill_time = capacity/rate -- å°†å¡«å……æ—¶é—´å‘ä¸‹å–æ•´ local ttl = math.floor(fill_time*2) -- è·å–ç›®å‰ token_bucket ä¸­å‰©ä½™ token æ•° -- å¦‚æœæ˜¯ç¬¬ä¸€æ¬¡è¿›å…¥ï¼Œåˆ™è®¾ç½® token_bucket æ•°é‡ä¸º ä»¤ç‰Œæ¡¶æœ€å¤§å€¼ local last_tokens = tonumber(redis.call(\"get\", KEYS[1])) if last_tokens == nil then last_tokens = capacity end -- ä¸Šä¸€æ¬¡æ›´æ–° token_bucket çš„æ—¶é—´ local last_refreshed = tonumber(redis.call(\"get\", KEYS[2])) if last_refreshed == nil then last_refreshed = 0 end local delta = math.max(0, now-last_refreshed) -- é€šè¿‡å½“å‰æ—¶é—´ä¸ä¸Šä¸€æ¬¡æ›´æ–°æ—¶é—´çš„è·¨åº¦ï¼Œä»¥åŠç”Ÿäº§tokençš„é€Ÿç‡ï¼Œè®¡ç®—å‡ºæ–°çš„tokenæ•° -- å¦‚æœè¶…è¿‡ max_burstï¼Œå¤šä½™ç”Ÿäº§çš„tokenä¼šè¢«ä¸¢å¼ƒ local filled_tokens = math.min(capacity, last_tokens+(delta*rate)) local allowed = filled_tokens >= requested local new_tokens = filled_tokens if allowed then new_tokens = filled_tokens - requested end -- æ›´æ–°æ–°çš„tokenæ•°ï¼Œä»¥åŠæ›´æ–°æ—¶é—´ redis.call(\"setex\", KEYS[1], ttl, new_tokens) redis.call(\"setex\", KEYS[2], ttl, now) return allowed ä¸Šè¿°å¯ä»¥çœ‹å‡º lua script ï¼šåªæ¶‰åŠå¯¹ token æ“ä½œï¼Œä¿è¯ token ç”Ÿäº§åˆç†å’Œè¯»å–åˆç†ã€‚ å‡½æ•°åˆ†æ ä»ä¸Šè¿°æµç¨‹ä¸­çœ‹å‡ºï¼š æœ‰å¤šé‡ä¿éšœæœºåˆ¶ï¼Œä¿è¯é™æµä¸€å®šä¼šå®Œæˆã€‚ å¦‚æœredis limiterå¤±æ•ˆï¼Œè‡³å°‘åœ¨è¿›ç¨‹å†…rate limiterå…œåº•ã€‚ é‡è¯• redis limiter æœºåˆ¶ä¿è¯å°½å¯èƒ½åœ°æ­£å¸¸è¿è¡Œã€‚ æ€»ç»“ go-zero ä¸­çš„ tokenlimit é™æµæ–¹æ¡ˆé€‚ç”¨äºç¬æ—¶æµé‡å†²å‡»ï¼Œç°å®è¯·æ±‚åœºæ™¯å¹¶ä¸ä»¥æ’å®šçš„é€Ÿç‡ã€‚ä»¤ç‰Œæ¡¶ç›¸å½“é¢„è¯·æ±‚ï¼Œå½“çœŸå®çš„è¯·æ±‚åˆ°è¾¾ä¸è‡³äºç¬é—´è¢«æ‰“å®ã€‚å½“æµé‡å†²å‡»åˆ°ä¸€å®šç¨‹åº¦ï¼Œåˆ™æ‰ä¼šæŒ‰ç…§é¢„å®šé€Ÿç‡è¿›è¡Œæ¶ˆè´¹ã€‚ ä½†æ˜¯ç”Ÿäº§tokenä¸Šï¼Œä¸èƒ½æŒ‰ç…§å½“æ—¶çš„æµé‡æƒ…å†µä½œå‡ºåŠ¨æ€è°ƒæ•´ï¼Œä¸å¤Ÿçµæ´»ï¼Œè¿˜å¯ä»¥è¿›è¡Œè¿›ä¸€æ­¥ä¼˜åŒ–ã€‚æ­¤å¤–å¯ä»¥å‚è€ƒToken bucket WIKI ä¸­æåˆ°åˆ†å±‚ä»¤ç‰Œæ¡¶ï¼Œæ ¹æ®ä¸åŒçš„æµé‡å¸¦å®½ï¼Œåˆ†è‡³ä¸åŒæ’é˜Ÿä¸­ã€‚ å‚è€ƒ go-zero tokenlimit Go-Redis æä¾›çš„åˆ†å¸ƒå¼é™æµåº“ Copyright Â© 2019-2021 go-zero all right reservedï¼Œpowered by GitbookLast UpdateTimeï¼š 2025-05-05 05:44:52 "},"timing-wheel.html":{"url":"timing-wheel.html","title":"æ—¶é—´è½®ä»‹ç»","keywords":"","body":"TimingWheel æœ¬æ–‡æ¥ä»‹ç» go-zero ä¸­ å»¶è¿Ÿæ“ä½œã€‚å»¶è¿Ÿæ“ä½œï¼Œå¯ä»¥é‡‡ç”¨ä¸¤ä¸ªæ–¹æ¡ˆï¼š Timerï¼šå®šæ—¶å™¨ç»´æŠ¤ä¸€ä¸ªä¼˜å…ˆé˜Ÿåˆ—ï¼Œåˆ°æ—¶é—´ç‚¹æ‰§è¡Œï¼Œç„¶åæŠŠéœ€è¦æ‰§è¡Œçš„ task å­˜å‚¨åœ¨ map ä¸­ collection ä¸­çš„ timingWheel ï¼Œç»´æŠ¤ä¸€ä¸ªå­˜æ”¾ä»»åŠ¡ç»„çš„æ•°ç»„ï¼Œæ¯ä¸€ä¸ªæ§½éƒ½ç»´æŠ¤ä¸€ä¸ªå­˜å‚¨taskçš„åŒå‘é“¾è¡¨ã€‚å¼€å§‹æ‰§è¡Œæ—¶ï¼Œè®¡æ—¶å™¨æ¯éš”æŒ‡å®šæ—¶é—´æ‰§è¡Œä¸€ä¸ªæ§½é‡Œé¢çš„tasksã€‚ æ–¹æ¡ˆ2æŠŠç»´æŠ¤taskä» ä¼˜å…ˆé˜Ÿåˆ— O(nlog(n)) é™åˆ° åŒå‘é“¾è¡¨ O(1)ï¼Œè€Œæ‰§è¡Œtaskä¹Ÿåªè¦è½®è¯¢ä¸€ä¸ªæ—¶é—´ç‚¹çš„tasks O(N)ï¼Œä¸éœ€è¦åƒä¼˜å…ˆé˜Ÿåˆ—ï¼Œæ”¾å…¥å’Œåˆ é™¤å…ƒç´  O(nlog(n))ã€‚ cache ä¸­çš„ timingWheel é¦–å…ˆæˆ‘ä»¬å…ˆæ¥åœ¨ collection çš„ cache ä¸­å…³äº timingWheel çš„ä½¿ç”¨ï¼š timingWheel, err := NewTimingWheel(time.Second, slots, func(k, v interface{}) { key, ok := k.(string) if !ok { return } cache.Del(key) }) if err != nil { return nil, err } cache.timingWheel = timingWheel è¿™æ˜¯ cache åˆå§‹åŒ–ä¸­ä¹ŸåŒæ—¶åˆå§‹åŒ– timingWheel åškeyçš„è¿‡æœŸå¤„ç†ï¼Œå‚æ•°ä¾æ¬¡ä»£è¡¨ï¼š intervalï¼šæ—¶é—´åˆ’åˆ†åˆ»åº¦ numSlotsï¼šæ—¶é—´æ§½ executeï¼šæ—¶é—´ç‚¹æ‰§è¡Œå‡½æ•° åœ¨ cache ä¸­æ‰§è¡Œå‡½æ•°åˆ™æ˜¯ åˆ é™¤è¿‡æœŸkeyï¼Œè€Œè¿™ä¸ªè¿‡æœŸåˆ™ç”± timingWheel æ¥æ§åˆ¶æ¨è¿›æ—¶é—´ã€‚ æ¥ä¸‹æ¥ï¼Œå°±é€šè¿‡ cache å¯¹ timingWheel çš„ä½¿ç”¨æ¥è®¤è¯†ã€‚ åˆå§‹åŒ– // çœŸæ­£åšåˆå§‹åŒ– func newTimingWheelWithClock(interval time.Duration, numSlots int, execute Execute, ticker timex.Ticker) ( *TimingWheel, error) { tw := &TimingWheel{ interval: interval, // å•ä¸ªæ—¶é—´æ ¼æ—¶é—´é—´éš” ticker: ticker, // å®šæ—¶å™¨ï¼Œåšæ—¶é—´æ¨åŠ¨ï¼Œä»¥intervalä¸ºå•ä½æ¨è¿› slots: make([]*list.List, numSlots), // æ—¶é—´è½® timers: NewSafeMap(), // å­˜å‚¨task{key, value}çš„map [æ‰§è¡Œexecuteæ‰€éœ€è¦çš„å‚æ•°] tickedPos: numSlots - 1, // at previous virtual circle execute: execute, // æ‰§è¡Œå‡½æ•° numSlots: numSlots, // åˆå§‹åŒ– slots num setChannel: make(chan timingEntry), // ä»¥ä¸‹å‡ ä¸ªchannelæ˜¯åštaskä¼ é€’çš„ moveChannel: make(chan baseEntry), removeChannel: make(chan interface{}), drainChannel: make(chan func(key, value interface{})), stopChannel: make(chan lang.PlaceholderType), } // æŠŠ slot ä¸­å­˜å‚¨çš„ list å…¨éƒ¨å‡†å¤‡å¥½ tw.initSlots() // å¼€å¯å¼‚æ­¥åç¨‹ï¼Œä½¿ç”¨ channel æ¥åštaské€šä¿¡å’Œä¼ é€’ go tw.run() return tw, nil } ä»¥ä¸Šæ¯”è¾ƒç›´è§‚å±•ç¤º timingWheel çš„ â€œæ—¶é—´è½®â€ï¼Œåé¢ä¼šå›´ç»•è¿™å¼ å›¾è§£é‡Šå…¶ä¸­æ¨è¿›çš„ç»†èŠ‚ã€‚ go tw.run() å¼€ä¸€ä¸ªåç¨‹åšæ—¶é—´æ¨åŠ¨ï¼š func (tw *TimingWheel) run() { for { select { // å®šæ—¶å™¨åšæ—¶é—´æ¨åŠ¨ -> scanAndRunTasks() case å¯ä»¥çœ‹å‡ºï¼Œåœ¨åˆå§‹åŒ–çš„æ—¶å€™å°±å¼€å§‹äº† timer æ‰§è¡Œï¼Œå¹¶ä»¥intervalæ—¶é—´æ®µè½¬åŠ¨ï¼Œç„¶ååº•å±‚ä¸åœçš„è·å–æ¥è‡ª slot ä¸­çš„ list çš„taskï¼Œäº¤ç»™ execute æ‰§è¡Œã€‚ Task Operation ç´§æ¥ç€å°±æ˜¯è®¾ç½® cache key ï¼š func (c *Cache) Set(key string, value interface{}) { c.lock.Lock() _, ok := c.data[key] c.data[key] = value c.lruCache.add(key) c.lock.Unlock() expiry := c.unstableExpiry.AroundDuration(c.expire) if ok { c.timingWheel.MoveTimer(key, expiry) } else { c.timingWheel.SetTimer(key, value, expiry) } } å…ˆçœ‹åœ¨ data map ä¸­æœ‰æ²¡æœ‰å­˜åœ¨è¿™ä¸ªkey å­˜åœ¨ï¼Œåˆ™æ›´æ–° expire -> MoveTimer() ç¬¬ä¸€æ¬¡è®¾ç½®key -> SetTimer() æ‰€ä»¥å¯¹äº timingWheel çš„ä½¿ç”¨ä¸Šå°±æ¸…æ™°äº†ï¼Œå¼€å‘è€…æ ¹æ®éœ€æ±‚å¯ä»¥ add æˆ–æ˜¯ updateã€‚ åŒæ—¶æˆ‘ä»¬è·Ÿæºç è¿›å»ä¼šå‘ç°ï¼šSetTimer() MoveTimer() éƒ½æ˜¯å°†taskè¾“é€åˆ°channelï¼Œç”± run() ä¸­å¼€å¯çš„åç¨‹ä¸æ–­å–å‡º channel çš„taskæ“ä½œã€‚ SetTimer() -> setTask()ï¼š not exist taskï¼šgetPostion -> pushBack to list -> setPosition exist taskï¼šget from timers -> moveTask() MoveTimer() -> moveTask() ç”±ä¸Šé¢çš„è°ƒç”¨é“¾ï¼Œæœ‰ä¸€ä¸ªéƒ½ä¼šè°ƒç”¨çš„å‡½æ•°ï¼šmoveTask() func (tw *TimingWheel) moveTask(task baseEntry) { // timers: Map => é€šè¿‡keyè·å– [positionEntryã€Œpos, taskã€] val, ok := tw.timers.Get(task.key) if !ok { return } timer := val.(*positionEntry) // {delay å»¶è¿Ÿæ—¶é—´æ¯”ä¸€ä¸ªæ—¶é—´æ ¼é—´éš”è¿˜å°ï¼Œæ²¡æœ‰æ›´å°çš„åˆ»åº¦ï¼Œè¯´æ˜ä»»åŠ¡åº”è¯¥ç«‹å³æ‰§è¡Œ if task.delay intervalï¼Œåˆ™é€šè¿‡ å»¶è¿Ÿæ—¶é—´delay è®¡ç®—å…¶å‡ºæ—¶é—´è½®ä¸­çš„ new pos, circle pos, circle := tw.getPositionAndCircle(task.delay) if pos >= timer.pos { timer.item.circle = circle // è®°å½•å‰åçš„ç§»åŠ¨offsetã€‚ä¸ºäº†åé¢è¿‡ç¨‹é‡æ–°å…¥é˜Ÿ timer.item.diff = pos - timer.pos } else if circle > 0 { // è½¬ç§»åˆ°ä¸‹ä¸€å±‚ï¼Œå°† circle è½¬æ¢ä¸º diff ä¸€éƒ¨åˆ† circle-- timer.item.circle = circle // å› ä¸ºæ˜¯ä¸€ä¸ªæ•°ç»„ï¼Œè¦åŠ ä¸Š numSlots [ä¹Ÿå°±æ˜¯ç›¸å½“äºè¦èµ°åˆ°ä¸‹ä¸€å±‚] timer.item.diff = tw.numSlots + pos - timer.pos } else { // å¦‚æœ offset æå‰äº†ï¼Œæ­¤æ—¶ task ä¹Ÿè¿˜åœ¨ç¬¬ä¸€å±‚ // æ ‡è®°åˆ é™¤è€çš„ taskï¼Œå¹¶é‡æ–°å…¥é˜Ÿï¼Œç­‰å¾…è¢«æ‰§è¡Œ timer.item.removed = true newItem := &timingEntry{ baseEntry: task, value: timer.item.value, } tw.slots[pos].PushBack(newItem) tw.setTimerPosition(pos, newItem) } } ä»¥ä¸Šè¿‡ç¨‹æœ‰ä»¥ä¸‹å‡ ç§æƒ…å†µï¼š delay ï¼šå› ä¸º é’ˆå¯¹æ”¹å˜çš„ delayï¼š new >= oldï¼š newCircle > 0ï¼šè®¡ç®—diffï¼Œå¹¶å°† circle è½¬æ¢ä¸º ä¸‹ä¸€å±‚ï¼Œæ•…diff + numslots å¦‚æœåªæ˜¯å•çº¯å»¶è¿Ÿæ—¶é—´ç¼©çŸ­ï¼Œåˆ™å°†è€çš„taskæ ‡è®°åˆ é™¤ï¼Œé‡æ–°åŠ å…¥listï¼Œç­‰å¾…ä¸‹ä¸€è½®loopè¢«execute Execute ä¹‹å‰åœ¨åˆå§‹åŒ–ä¸­ï¼Œrun() ä¸­å®šæ—¶å™¨çš„ä¸æ–­æ¨è¿›ï¼Œæ¨è¿›çš„è¿‡ç¨‹ä¸»è¦å°±æ˜¯æŠŠ listä¸­çš„ task ä¼ ç»™æ‰§è¡Œçš„ execute funcã€‚æˆ‘ä»¬ä»å®šæ—¶å™¨çš„æ‰§è¡Œå¼€å§‹çœ‹ï¼š // å®šæ—¶å™¨ ã€Œæ¯éš” interval ä¼šæ‰§è¡Œä¸€æ¬¡ã€ func (tw *TimingWheel) onTick() { // æ¯æ¬¡æ‰§è¡Œæ›´æ–°ä¸€ä¸‹å½“å‰æ‰§è¡Œ tick ä½ç½® tw.tickedPos = (tw.tickedPos + 1) % tw.numSlots // è·å–æ­¤æ—¶ tickä½ç½® ä¸­çš„å­˜å‚¨taskçš„åŒå‘é“¾è¡¨ l := tw.slots[tw.tickedPos] tw.scanAndRunTasks(l) } ç´§æ¥ç€æ˜¯å¦‚ä½•å»æ‰§è¡Œ executeï¼š func (tw *TimingWheel) scanAndRunTasks(l *list.List) { // å­˜å‚¨ç›®å‰éœ€è¦æ‰§è¡Œçš„task{key, value} [executeæ‰€éœ€è¦çš„å‚æ•°ï¼Œä¾æ¬¡ä¼ é€’ç»™executeæ‰§è¡Œ] var tasks []timingTask for e := l.Front(); e != nil; { task := e.Value.(*timingEntry) // æ ‡è®°åˆ é™¤ï¼Œåœ¨ scan ä¸­åšçœŸæ­£çš„åˆ é™¤ ã€Œåˆ é™¤mapçš„dataã€ if task.removed { next := e.Next() l.Remove(e) tw.timers.Del(task.key) e = next continue } else if task.circle > 0 { // å½“å‰æ‰§è¡Œç‚¹å·²ç»è¿‡æœŸï¼Œä½†æ˜¯åŒæ—¶ä¸åœ¨ç¬¬ä¸€å±‚ï¼Œæ‰€ä»¥å½“å‰å±‚å³ç„¶å·²ç»å®Œæˆäº†ï¼Œå°±ä¼šé™åˆ°ä¸‹ä¸€å±‚ // ä½†æ˜¯å¹¶æ²¡æœ‰ä¿®æ”¹ pos task.circle-- e = e.Next() continue } else if task.diff > 0 { // å› ä¸ºä¹‹å‰å·²ç»æ ‡æ³¨äº†diffï¼Œéœ€è¦å†è¿›å…¥é˜Ÿåˆ— next := e.Next() l.Remove(e) pos := (tw.tickedPos + task.diff) % tw.numSlots tw.slots[pos].PushBack(task) tw.setTimerPosition(pos, task) task.diff = 0 e = next continue } // ä»¥ä¸Šçš„æƒ…å†µéƒ½æ˜¯ä¸èƒ½æ‰§è¡Œçš„æƒ…å†µï¼Œèƒ½å¤Ÿæ‰§è¡Œçš„ä¼šè¢«åŠ å…¥tasksä¸­ tasks = append(tasks, timingTask{ key: task.key, value: task.value, }) next := e.Next() l.Remove(e) tw.timers.Del(task.key) e = next } // for range tasksï¼Œç„¶åæŠŠæ¯ä¸ª task->execute æ‰§è¡Œå³å¯ tw.runTasks(tasks) } å…·ä½“çš„åˆ†æ”¯æƒ…å†µåœ¨æ³¨é‡Šä¸­è¯´æ˜äº†ï¼Œåœ¨çœ‹çš„æ—¶å€™å¯ä»¥å’Œå‰é¢çš„ moveTask() ç»“åˆèµ·æ¥ï¼Œå…¶ä¸­ circle ä¸‹é™ï¼Œdiff çš„è®¡ç®—æ˜¯å…³è”ä¸¤ä¸ªå‡½æ•°çš„é‡ç‚¹ã€‚ è‡³äº diff è®¡ç®—å°±æ¶‰åŠåˆ° pos, circle çš„è®¡ç®—ï¼š // interval: 4min, d: 60min, numSlots: 16, tickedPos = 15 // step = 15, pos = 14, circle = 0 func (tw *TimingWheel) getPositionAndCircle(d time.Duration) (pos int, circle int) { steps := int(d / tw.interval) pos = (tw.tickedPos + steps) % tw.numSlots circle = (steps - 1) / tw.numSlots return } ä¸Šé¢çš„è¿‡ç¨‹å¯ä»¥ç®€åŒ–æˆä¸‹é¢ï¼š steps = d / interval pos = step % numSlots - 1 circle = (step - 1) / numSlots æ€»ç»“ timingWheel é å®šæ—¶å™¨æ¨åŠ¨ï¼Œæ—¶é—´å‰è¿›çš„åŒæ—¶ä¼šå–å‡ºå½“å‰æ—¶é—´æ ¼ä¸­ listã€ŒåŒå‘é“¾è¡¨ã€çš„taskï¼Œä¼ é€’åˆ° execute ä¸­æ‰§è¡Œã€‚ è€Œæ—¶é—´åˆ†éš”ä¸Šï¼Œæ—¶é—´è½®æœ‰ circle åˆ†å±‚ï¼Œè¿™æ ·å°±å¯ä»¥ä¸æ–­å¤ç”¨åŸæœ‰çš„ numSlots ï¼Œå› ä¸ºå®šæ—¶å™¨åœ¨ä¸æ–­ loopï¼Œè€Œæ‰§è¡Œå¯ä»¥æŠŠä¸Šå±‚çš„ slot ä¸‹é™åˆ°ä¸‹å±‚ï¼Œåœ¨ä¸æ–­ loop ä¸­å°±å¯ä»¥æ‰§è¡Œåˆ°ä¸Šå±‚çš„taskã€‚ åœ¨ go-zero ä¸­è¿˜æœ‰å¾ˆå¤šå®ç”¨çš„ç»„ä»¶å·¥å…·ï¼Œç”¨å¥½å·¥å…·å¯¹äºæå‡æœåŠ¡æ€§èƒ½å’Œå¼€å‘æ•ˆç‡éƒ½æœ‰å¾ˆå¤§çš„å¸®åŠ©ï¼Œå¸Œæœ›æœ¬ç¯‡æ–‡ç« èƒ½ç»™å¤§å®¶å¸¦æ¥ä¸€äº›æ”¶è·ã€‚ Copyright Â© 2019-2021 go-zero all right reservedï¼Œpowered by GitbookLast UpdateTimeï¼š 2025-05-05 05:44:52 "},"eco.html":{"url":"eco.html","title":"go-zero ç”Ÿæ€","keywords":"","body":"go-zero ç”Ÿæ€ å·¥å…·ä¸­å¿ƒ intellijæ’ä»¶ vscodeæ’ä»¶ åˆ†å¸ƒå¼äº‹åŠ¡æ”¯æŒ æ’ä»¶ä¸­å¿ƒ Copyright Â© 2019-2021 go-zero all right reservedï¼Œpowered by GitbookLast UpdateTimeï¼š 2025-05-05 05:44:52 "},"tool-center.html":{"url":"tool-center.html","title":"å·¥å…·ä¸­å¿ƒ","keywords":"","body":"å·¥å…·ä¸­å¿ƒ åœ¨go-zeroä¸­ï¼Œæä¾›äº†å¾ˆå¤šæé«˜å·¥ç¨‹æ•ˆç‡çš„å·¥å…·ï¼Œå¦‚apiï¼Œrpcç”Ÿæˆï¼Œåœ¨æ­¤åŸºç¡€ä¹‹ä¸Šï¼Œapiæ–‡ä»¶çš„ç¼–å†™å°±æ˜¾å¾—é‚£ä¹ˆçš„æ— åŠ›ï¼Œ å› ä¸ºç¼ºå°‘äº†é«˜äº®ï¼Œä»£ç æç¤ºï¼Œæ¨¡æ¿ç”Ÿæˆç­‰ï¼Œæœ¬èŠ‚å°†å¸¦ä½ äº†è§£go-zeroæ˜¯æ€ä¹ˆè§£å†³è¿™äº›éš¾é¢˜çš„ï¼Œæœ¬èŠ‚åŒ…å«ä»¥ä¸‹å°èŠ‚ï¼š intellijæ’ä»¶ vscodeæ’ä»¶ Copyright Â© 2019-2021 go-zero all right reservedï¼Œpowered by GitbookLast UpdateTimeï¼š 2025-05-05 05:44:52 "},"intellij.html":{"url":"intellij.html","title":"intellijæ’ä»¶","keywords":"","body":"intellijæ’ä»¶ Go-Zero Plugin ä»‹ç» ä¸€æ¬¾æ”¯æŒgo-zero apiè¯­è¨€ç»“æ„è¯­æ³•é«˜äº®ã€æ£€æµ‹ä»¥åŠapiã€rpcã€modelå¿«æ·ç”Ÿæˆçš„æ’ä»¶å·¥å…·ã€‚ ideaç‰ˆæœ¬è¦æ±‚ IntelliJ 2019.3+ (Ultimate or Community) Goland 2019.3+ WebStorm 2019.3+ PhpStorm 2019.3+ PyCharm 2019.3+ RubyMine 2019.3+ CLion 2019.3+ ç‰ˆæœ¬ç‰¹æ€§ apiè¯­æ³•é«˜äº® apiè¯­æ³•ã€è¯­ä¹‰æ£€æµ‹ structã€routeã€handleré‡å¤å®šä¹‰æ£€æµ‹ typeè·³è½¬åˆ°ç±»å‹å£°æ˜ä½ç½® ä¸Šä¸‹æ–‡èœå•ä¸­æ”¯æŒapiã€rpcã€modeç›¸å…³menué€‰é¡¹ ä»£ç æ ¼å¼åŒ–(option+command+L) ä»£ç æç¤º å®‰è£…æ–¹å¼ æ–¹å¼ä¸€ åœ¨githubçš„releaseä¸­æ‰¾åˆ°æœ€æ–°çš„zipåŒ…ï¼Œä¸‹è½½æœ¬åœ°å®‰è£…å³å¯ã€‚ï¼ˆæ— éœ€è§£å‹ï¼‰ æ–¹å¼äºŒ åœ¨pluginå•†åº—ä¸­ï¼Œæœç´¢Goctlå®‰è£…å³å¯ é¢„è§ˆ æ–°å»º Api(Proto) file åœ¨å·¥ç¨‹åŒºåŸŸç›®æ ‡æ–‡ä»¶å¤¹å³é”®->New-> New Api(Proto) File ->Empty File/Api(Proto) Template,å¦‚å›¾ï¼š å¿«é€Ÿç”Ÿæˆapi/rpcæœåŠ¡ åœ¨ç›®æ ‡æ–‡ä»¶å¤¹å³é”®->New->Go Zero -> Api Greet Service/Rpc Greet Service Api/Rpc/Model Codeç”Ÿæˆ æ–¹æ³•ä¸€(å·¥ç¨‹åŒºåŸŸ) å¯¹åº”æ–‡ä»¶ï¼ˆapiã€protoã€sqlï¼‰å³é”®->New->Go Zero-> Api/Rpc/Model Code,å¦‚å›¾ï¼š æ–¹æ³•äºŒï¼ˆç¼–è¾‘åŒºåŸŸï¼‰ å¯¹åº”æ–‡ä»¶ï¼ˆapiã€protoã€sqlï¼‰å³é”®-> Generate-> Api/Rpc/Model Code é”™è¯¯æç¤º Live Template Live Templateå¯ä»¥åŠ å¿«æˆ‘ä»¬å¯¹apiæ–‡ä»¶çš„ç¼–å†™ï¼Œæ¯”å¦‚æˆ‘ä»¬åœ¨goæ–‡ä»¶ä¸­è¾“å…¥mainå…³é”®å­—æ ¹æ®tipå›è½¦åä¼šæ’å…¥ä¸€æ®µæ¨¡æ¿ä»£ç  func main(){ } æˆ–è€…è¯´çœ‹åˆ°ä¸‹å›¾ä½ ä¼šæ›´åŠ ç†Ÿæ‚‰ï¼Œæ›¾å‡ ä½•æ—¶ä½ è¿˜åœ¨è¿™é‡Œå®šä¹‰è¿‡template ä¸‹é¢å°±è¿›å…¥ä»Šå¤©apiè¯­æ³•ä¸­çš„æ¨¡æ¿ä½¿ç”¨è¯´æ˜å§ï¼Œæˆ‘ä»¬å…ˆæ¥çœ‹çœ‹serviceæ¨¡æ¿çš„æ•ˆæœ é¦–å…ˆä¸Šä¸€å¼ å›¾äº†è§£ä¸€ä¸‹apiæ–‡ä»¶ä¸­å‡ ä¸ªæ¨¡æ¿ç”Ÿæ•ˆåŒºåŸŸï¼ˆpsiTreeå…ƒç´ åŒºåŸŸï¼‰ é¢„è®¾æ¨¡æ¿åŠç”Ÿæ•ˆåŒºåŸŸ æ¨¡æ¿å…³é”®å­— psiTreeç”Ÿæ•ˆåŒºåŸŸ æè¿° @doc ApiService docæ³¨é‡Šæ¨¡æ¿ doc ApiService docæ³¨é‡Šæ¨¡æ¿ struct Struct structå£°æ˜æ¨¡æ¿ info ApiFile info blockæ¨¡æ¿ type ApiFile type groupæ¨¡æ¿ handler ApiService handleræ–‡ä»¶åæ¨¡æ¿ get ApiService getæ–¹æ³•è·¯ç”±æ¨¡æ¿ head ApiService headæ–¹æ³•è·¯ç”±æ¨¡æ¿ post ApiService postæ–¹æ³•è·¯ç”±æ¨¡æ¿ put ApiService putæ–¹æ³•è·¯ç”±æ¨¡æ¿ delete ApiService deleteæ–¹æ³•è·¯ç”±æ¨¡æ¿ connect ApiService connectæ–¹æ³•è·¯ç”±æ¨¡æ¿ options ApiService optionsæ–¹æ³•è·¯ç”±æ¨¡æ¿ trace ApiService traceæ–¹æ³•è·¯ç”±æ¨¡æ¿ service ApiFile serviceæœåŠ¡blockæ¨¡æ¿ json Tagã€Tag literal tagæ¨¡æ¿ xml Tagã€Tag literal tagæ¨¡æ¿ path Tagã€Tag literal tagæ¨¡æ¿ form Tagã€Tag literal tagæ¨¡æ¿ å…³äºæ¯ä¸ªæ¨¡æ¿å¯¹åº”å†…å®¹å¯åœ¨Goland(mac Os)->Preference->Editor->Live Templates-> Api|Api Tagsä¸­æŸ¥çœ‹è¯¦ç»†æ¨¡æ¿å†…å®¹ï¼Œå¦‚json tagæ¨¡æ¿å†…å®¹ä¸º json:\"$FIELD_NAME$\" Copyright Â© 2019-2021 go-zero all right reservedï¼Œpowered by GitbookLast UpdateTimeï¼š 2025-05-05 05:44:52 "},"vscode.html":{"url":"vscode.html","title":"vscodeæ’ä»¶","keywords":"","body":"vs code æ’ä»¶ è¯¥æ’ä»¶å¯ä»¥å®‰è£…åœ¨ 1.46.0+ ç‰ˆæœ¬çš„ Visual Studio Code ä¸Šï¼Œé¦–å…ˆè¯·ç¡®ä¿ä½ çš„ Visual Studio Code ç‰ˆæœ¬ç¬¦åˆè¦æ±‚ï¼Œå¹¶å·²å®‰è£… goctl å‘½ä»¤è¡Œå·¥å…·ã€‚å¦‚æœå°šæœªå®‰è£… Visual Studio Codeï¼Œè¯·å®‰è£…å¹¶æ‰“å¼€ Visual Studio Codeã€‚ å¯¼èˆªåˆ°â€œæ‰©å±•â€çª—æ ¼ï¼Œæœç´¢ goctl å¹¶å®‰è£…æ­¤æ‰©å±•ï¼ˆå‘å¸ƒè€…IDä¸º â€œxiaoxin-technology.goctlâ€ï¼‰ã€‚ Visual Studio Code æ‰©å±•ä½¿ç”¨è¯·å‚è€ƒè¿™é‡Œã€‚ åŠŸèƒ½åˆ—è¡¨ å·²å®ç°åŠŸèƒ½ è¯­æ³•é«˜äº® è·³è½¬åˆ°å®šä¹‰/å¼•ç”¨ ä»£ç æ ¼å¼åŒ– ä»£ç å—æç¤º æœªå®ç°åŠŸèƒ½: è¯­æ³•é”™è¯¯æ£€æŸ¥ è·¨æ–‡ä»¶ä»£ç è·³è½¬ goctl å‘½ä»¤è¡Œè°ƒç”¨ è¯­æ³•é«˜äº® ä»£ç è·³è½¬ ä»£ç æ ¼å¼åŒ– è°ƒç”¨ goctl å‘½ä»¤è¡Œæ ¼å¼åŒ–å·¥å…·ï¼Œä½¿ç”¨å‰è¯·ç¡®è®¤ goctl å·²åŠ å…¥ $PATH ä¸”æœ‰å¯æ‰§è¡Œæƒé™ ä»£ç å—æç¤º info ä»£ç å— type ä»£ç å— service ä»£ç å— handler ä»£ç å— Copyright Â© 2019-2021 go-zero all right reservedï¼Œpowered by GitbookLast UpdateTimeï¼š 2025-05-05 05:44:52 "},"distributed-transaction.html":{"url":"distributed-transaction.html","title":"åˆ†å¸ƒå¼äº‹åŠ¡æ”¯æŒ","keywords":"","body":"åˆ†å¸ƒå¼äº‹åŠ¡æ”¯æŒ éœ€æ±‚åœºæ™¯ åœ¨å¾®æœåŠ¡æ¶æ„ä¸­ï¼Œå½“æˆ‘ä»¬éœ€è¦è·¨æœåŠ¡ä¿è¯æ•°æ®ä¸€è‡´æ€§æ—¶ï¼ŒåŸå…ˆçš„æ•°æ®åº“äº‹åŠ¡åŠ›ä¸ä»å¿ƒï¼Œæ— æ³•å°†è·¨åº“ã€è·¨æœåŠ¡çš„å¤šä¸ªæ“ä½œæ”¾åœ¨ä¸€ä¸ªäº‹åŠ¡ä¸­ã€‚è¿™æ ·çš„åº”ç”¨åœºæ™¯éå¸¸å¤šï¼Œæˆ‘ä»¬å¯ä»¥åˆ—ä¸¾å‡ºå¾ˆå¤šï¼š è®¢å•ç³»ç»Ÿï¼šéœ€è¦ä¿è¯åˆ›å»ºè®¢å•å’Œæ‰£å‡åº“å­˜è¦ä¹ˆåŒæ—¶æˆåŠŸï¼Œè¦ä¹ˆåŒæ—¶å›æ»š è·¨è¡Œè½¬è´¦åœºæ™¯ï¼šæ•°æ®ä¸åœ¨ä¸€ä¸ªæ•°æ®åº“ï¼Œä½†éœ€è¦ä¿è¯ä½™é¢æ‰£å‡å’Œä½™é¢å¢åŠ è¦ä¹ˆåŒæ—¶æˆåŠŸï¼Œè¦ä¹ˆåŒæ—¶å¤±è´¥ ç§¯åˆ†å…‘æ¢åœºæ™¯ï¼šéœ€è¦ä¿è¯ç§¯åˆ†æ‰£å‡å’Œæƒç›Šå¢åŠ åŒæ—¶æˆåŠŸï¼Œæˆ–è€…åŒæ—¶å¤±è´¥ å‡ºè¡Œè®¢ç¥¨åœºæ™¯ï¼šéœ€è¦åœ¨ç¬¬ä¸‰æ–¹ç³»ç»ŸåŒæ—¶å®šå‡ å¼ ç¥¨ï¼Œè¦ä¹ˆåŒæ—¶æˆåŠŸï¼Œè¦ä¹ˆå…¨éƒ¨å–æ¶ˆ é¢å¯¹è¿™äº›æœ¬åœ°äº‹åŠ¡æ— æ³•è§£å†³çš„åœºæ™¯ï¼Œæˆ‘ä»¬éœ€è¦åˆ†å¸ƒå¼äº‹åŠ¡çš„è§£å†³æ–¹æ¡ˆï¼Œä¿è¯è·¨æœåŠ¡ã€è·¨æ•°æ®åº“æ›´æ–°æ•°æ®çš„ä¸€è‡´æ€§ã€‚ è§£å†³æ–¹æ¡ˆ go-zeroä¸dtmå¼ºå¼ºè”åˆï¼Œæ¨å‡ºäº†åœ¨go-zeroä¸­æ— ç¼æ¥å…¥dtmçš„æç®€æ–¹æ¡ˆï¼Œæ˜¯goç”Ÿæ€ä¸­é¦–å®¶æä¾›åˆ†å¸ƒå¼äº‹åŠ¡èƒ½åŠ›çš„å¾®æœåŠ¡æ¡†æ¶ã€‚è¯¥æ–¹æ¡ˆå…·å¤‡ä»¥ä¸‹ç‰¹å¾ï¼š dtmæœåŠ¡å¯ä»¥é€šè¿‡é…ç½®ï¼Œç›´æ¥æ³¨å†Œåˆ°go-zeroçš„æ³¨å†Œä¸­å¿ƒ go-zeroèƒ½å¤Ÿä»¥å†…å»ºçš„targetæ ¼å¼è®¿é—®dtmæœåŠ¡å™¨ dtmèƒ½å¤Ÿè¯†åˆ«go-zeroçš„targetæ ¼å¼ï¼ŒåŠ¨æ€è®¿é—®go-zeroä¸­çš„æœåŠ¡ è¯¦ç»†çš„æ¥å…¥æ–¹å¼ï¼Œå‚è§dtmæ–‡æ¡£ï¼šgo-zeroæ”¯æŒ æ›´å¤šåº”ç”¨åœºæ™¯ dtmä¸ä»…å¯ä»¥è§£å†³ä¸Šè¿°çš„åˆ†å¸ƒå¼äº‹åŠ¡åœºæ™¯ï¼Œè¿˜å¯ä»¥è§£å†³æ›´å¤šçš„ä¸æ•°æ®ä¸€è‡´æ€§ç›¸å…³çš„åœºæ™¯ï¼ŒåŒ…æ‹¬ï¼š æ•°æ®åº“ä¸ç¼“å­˜ä¸€è‡´æ€§ï¼š dtm çš„äºŒé˜¶æ®µæ¶ˆæ¯ï¼Œèƒ½å¤Ÿä¿è¯æ•°æ®åº“æ›´æ–°æ“ä½œï¼Œå’Œç¼“å­˜æ›´æ–°/åˆ é™¤æ“ä½œçš„åŸå­æ€§ ç§’æ€ç³»ç»Ÿï¼š dtm èƒ½å¤Ÿä¿è¯ç§’æ€åœºæ™¯ä¸‹ï¼Œåˆ›å»ºçš„è®¢å•é‡ä¸åº“å­˜æ‰£å‡æ•°é‡å®Œå…¨ä¸€æ ·ï¼Œæ— éœ€åç»­çš„äººå·¥æ ¡å‡† å¤šç§å­˜å‚¨ç»„åˆï¼š dtm å·²æ”¯æŒæ•°æ®åº“ã€Redisã€Mongoç­‰å¤šç§å­˜å‚¨ï¼Œå¯ä»¥å°†å®ƒä»¬ç»„åˆä¸ºä¸€ä¸ªå…¨å±€äº‹åŠ¡ï¼Œä¿è¯æ•°æ®çš„ä¸€è‡´æ€§ æ›´å¤š dtm çš„èƒ½åŠ›å’Œä»‹ç»ï¼Œå‚è§dtm Copyright Â© 2019-2021 go-zero all right reservedï¼Œpowered by GitbookLast UpdateTimeï¼š 2025-05-05 05:44:52 "},"plugin-center.html":{"url":"plugin-center.html","title":"æ’ä»¶ä¸­å¿ƒ","keywords":"","body":"æ’ä»¶ä¸­å¿ƒ goctl apiæä¾›äº†å¯¹pluginå‘½ä»¤æ¥æ”¯æŒå¯¹apiè¿›è¡ŒåŠŸèƒ½æ‰©å±•ï¼Œå½“goctl apiä¸­çš„åŠŸèƒ½ä¸æ»¡è¶³ä½ çš„ä½¿ç”¨ï¼Œ æˆ–è€…éœ€è¦å¯¹goctl apiè¿›è¡ŒåŠŸèƒ½è‡ªå®šä¹‰çš„æ‰©å±•ï¼Œé‚£ä¹ˆæ’ä»¶åŠŸèƒ½å°†éå¸¸é€‚åˆå¼€å‘äººå‘˜è¿›è¡Œè‡ªç»™è‡ªè¶³ï¼Œè¯¦æƒ…è§ goctl plugin æ’ä»¶èµ„æº goctl-go-compact goctlé»˜è®¤çš„ä¸€ä¸ªè·¯ç”±ä¸€ä¸ªæ–‡ä»¶åˆå¹¶æˆä¸€ä¸ªæ–‡ä»¶ goctl-swagger é€šè¿‡apiæ–‡ä»¶ç”Ÿæˆswaggeræ–‡æ¡£ goctl-php goctl-phpæ˜¯ä¸€æ¬¾åŸºäºgoctlçš„æ’ä»¶ï¼Œç”¨äºç”Ÿæˆ php è°ƒç”¨ç«¯ï¼ˆæœåŠ¡ç«¯ï¼‰ http serverè¯·æ±‚ä»£ç  çŒœä½ æƒ³çœ‹ goctlæ’ä»¶ apiè¯­æ³•ä»‹ç» Copyright Â© 2019-2021 go-zero all right reservedï¼Œpowered by GitbookLast UpdateTimeï¼š 2025-05-05 05:44:52 "},"learning-resource.html":{"url":"learning-resource.html","title":"å­¦ä¹ èµ„æº","keywords":"","body":"å­¦ä¹ èµ„æº è¿™é‡Œå°†ä¸å®šæœŸæ›´æ–°go-zeroçš„æœ€æ–°å­¦ä¹ èµ„æºé€šé“ï¼Œç›®å‰åŒ…å«é€šé“æœ‰ï¼š å…¬ä¼—å· Goå¤œè¯» Goå¼€æºè¯´ Copyright Â© 2019-2021 go-zero all right reservedï¼Œpowered by GitbookLast UpdateTimeï¼š 2025-05-05 05:44:52 "},"wechat.html":{"url":"wechat.html","title":"å…¬ä¼—å·","keywords":"","body":"å…¬ä¼—å· å¾®æœåŠ¡å®è·µæ˜¯go-zeroçš„å®˜æ–¹å…¬ä¼—å·ï¼Œåœ¨è¿™é‡Œä¼šå‘å¸ƒæœ€æ–°çš„go-zeroæœ€ä½³å®è·µï¼ŒåŒæ­¥goå¤œè¯»ã€goå¼€æºè¯´ã€GopherChinaã€è…¾è®¯äº‘å¼€å‘è€…å¤§ä¼šç­‰å¤šæ¸ é“å…³äºgo-zeroçš„æœ€æ–°æŠ€æœ¯å’Œèµ„è®¯ã€‚ å…¬ä¼—å·åç§° å…¬ä¼—å·ä½œè€… å…¬ä¼—å·äºŒç»´ç  å¾®æœåŠ¡å®è·µ kevwan æ¨èä¸»é¢˜ ã€Šå¸¦ä½ åå¤©è½»æ¾æå®š Go å¾®æœåŠ¡ã€‹ è¯¥ç³»åˆ—å°†å¸¦ä½ åœ¨æœ¬æœºåˆ©ç”¨ go-zero å¿«é€Ÿå¼€å‘ä¸€ä¸ªå•†åŸç³»ç»Ÿï¼Œå‘å¤§å®¶è¯¦ç»†å±•ç¤ºäº†åŸºäº go-zero æ¡†æ¶æ„å»ºå¾®æœåŠ¡çš„è¿‡ç¨‹ï¼Œæ•´ä¸ªç³»åˆ—åˆ†åç¯‡æ–‡ç« ï¼Œç›®å½•ç»“æ„å¦‚ä¸‹ï¼š ç¬¬ä¸€å¤©ï¼šç¯å¢ƒæ­å»º ç¬¬äºŒå¤©ï¼šæœåŠ¡æ‹†åˆ† ç¬¬ä¸‰å¤©ï¼šç”¨æˆ·æœåŠ¡ ç¬¬å››å¤©ï¼šäº§å“æœåŠ¡ ç¬¬äº”å¤©ï¼šè®¢å•æœåŠ¡ ç¬¬å…­å¤©ï¼šæ”¯ä»˜æœåŠ¡ ç¬¬ä¸ƒå¤©ï¼šRPCæœåŠ¡AuthéªŒè¯ ç¬¬å…«å¤©ï¼šæœåŠ¡ç›‘æ§ ç¬¬ä¹å¤©ï¼šé“¾è·¯è¿½è¸ª ç¬¬åå¤©ï¼šåˆ†å¸ƒå¼äº‹åŠ¡ å¹²è´§ è¿™é‡Œåˆ—ä¸¾ä¸€äº›å¹²è´§ï¼Œæƒ³è¦æ”¶è·æ›´å¤šgo-zeroæœ€ä½³å®è·µå¹²è´§ï¼Œå¯ä»¥å…³æ³¨å…¬ä¼—å·è·å–æœ€æ–°åŠ¨æ€ã€‚ ã€Šä¸€æ–‡è¯»æ‡‚äº‘åŸç”Ÿ go-zero å¾®æœåŠ¡æ¡†æ¶ã€‹ ã€Šä½ è¿˜åœ¨æ‰‹æ’•å¾®æœåŠ¡ï¼Ÿå¿«è¯•è¯• go-zero çš„å¾®æœåŠ¡è‡ªåŠ¨ç”Ÿæˆã€‹ ã€Šæœ€ç®€å•çš„Go Dockerfileç¼–å†™å§¿åŠ¿ï¼Œæ²¡æœ‰ä¹‹ä¸€ï¼ã€‹ ã€Šé€šè¿‡MapReduceé™ä½æœåŠ¡å“åº”æ—¶é—´ã€‹ ã€Šå¾®æœåŠ¡è¿‡è½½ä¿æŠ¤åŸç†ä¸å®æˆ˜ ã€Šæœ€ç®€å•çš„ K8S éƒ¨ç½²æ–‡ä»¶ç¼–å†™å§¿åŠ¿ï¼Œæ²¡æœ‰ä¹‹ä¸€ï¼ã€‹ ã€Šgo-zero å¦‚ä½•åº”å¯¹æµ·é‡å®šæ—¶/å»¶è¿Ÿä»»åŠ¡ï¼Ÿã€‹ ã€Šgo-zero å¦‚ä½•æ‰›ä½æµé‡å†²å‡»ï¼ˆä¸€ï¼‰ã€‹ ã€ŠæœåŠ¡è‡ªé€‚åº”é™è½½ä¿æŠ¤è®¾è®¡ã€‹ Copyright Â© 2019-2021 go-zero all right reservedï¼Œpowered by GitbookLast UpdateTimeï¼š 2025-05-05 05:44:52 "},"goreading.html":{"url":"goreading.html","title":"Goå¤œè¯»","keywords":"","body":"Goå¤œè¯» 2020-08-16 æ™“é»‘æ¿ go-zero å¾®æœåŠ¡æ¡†æ¶çš„æ¶æ„è®¾è®¡ 2020-10-03 go-zero å¾®æœåŠ¡æ¡†æ¶å’Œçº¿ä¸Šäº¤æµ é˜²æ­¢ç¼“å­˜å‡»ç©¿ä¹‹è¿›ç¨‹å†…å…±äº«è°ƒç”¨ åŸºäºgo-zeroå®ç°JWTè®¤è¯ å†è§go-microï¼ä¼ä¸šé¡¹ç›®è¿ç§»go-zeroå…¨æ”»ç•¥ï¼ˆä¸€ï¼‰ Copyright Â© 2019-2021 go-zero all right reservedï¼Œpowered by GitbookLast UpdateTimeï¼š 2025-05-05 05:44:52 "},"gotalk.html":{"url":"gotalk.html","title":"Goå¼€æºè¯´","keywords":"","body":"Goå¼€æºè¯´ Go å¼€æºè¯´ç¬¬å››æœŸ - Go-Zero Copyright Â© 2019-2021 go-zero all right reservedï¼Œpowered by GitbookLast UpdateTimeï¼š 2025-05-05 05:44:52 "},"practise.html":{"url":"practise.html","title":"User Practise","keywords":"","body":"User Practise [!TIP] This document is machine-translated by Google. If you find grammatical and semantic errors, and the document description is not clear, please PR Persistent layer cache Business layer cache Queue Middle Ground System Stream Handler Online Exchange Copyright Â© 2019-2021 go-zero all right reservedï¼Œpowered by GitbookLast UpdateTimeï¼š 2025-05-05 05:44:52 "},"redis-cache.html":{"url":"redis-cache.html","title":"go-zeroç¼“å­˜è®¾è®¡ä¹‹æŒä¹…å±‚ç¼“å­˜","keywords":"","body":"go-zeroç¼“å­˜è®¾è®¡ä¹‹æŒä¹…å±‚ç¼“å­˜ ç¼“å­˜è®¾è®¡åŸç† æˆ‘ä»¬å¯¹ç¼“å­˜æ˜¯åªåˆ é™¤ï¼Œä¸åšæ›´æ–°ï¼Œä¸€æ—¦DBé‡Œæ•°æ®å‡ºç°ä¿®æ”¹ï¼Œæˆ‘ä»¬å°±ä¼šç›´æ¥åˆ é™¤å¯¹åº”çš„ç¼“å­˜ï¼Œè€Œä¸æ˜¯å»æ›´æ–°ã€‚ æˆ‘ä»¬çœ‹çœ‹åˆ é™¤ç¼“å­˜çš„é¡ºåºæ€æ ·æ‰æ˜¯æ­£ç¡®çš„ã€‚ å…ˆåˆ é™¤ç¼“å­˜ï¼Œå†æ›´æ–°DB æˆ‘ä»¬çœ‹ä¸¤ä¸ªå¹¶å‘è¯·æ±‚çš„æƒ…å†µï¼ŒAè¯·æ±‚éœ€è¦æ›´æ–°æ•°æ®ï¼Œå…ˆåˆ é™¤äº†ç¼“å­˜ï¼Œç„¶åBè¯·æ±‚æ¥è¯»å–æ•°æ®ï¼Œæ­¤æ—¶ç¼“å­˜æ²¡æœ‰æ•°æ®ï¼Œå°±ä¼šä»DBåŠ è½½æ•°æ®å¹¶å†™å›ç¼“å­˜ï¼Œç„¶åAæ›´æ–°äº†DBï¼Œé‚£ä¹ˆæ­¤æ—¶ç¼“å­˜å†…çš„æ•°æ®å°±ä¼šä¸€ç›´æ˜¯è„æ•°æ®ï¼Œç›´åˆ°ç¼“å­˜è¿‡æœŸæˆ–è€…æœ‰æ–°çš„æ›´æ–°æ•°æ®çš„è¯·æ±‚ã€‚å¦‚å›¾ å…ˆæ›´æ–°DBï¼Œå†åˆ é™¤ç¼“å­˜ Aè¯·æ±‚å…ˆæ›´æ–°DBï¼Œç„¶åBè¯·æ±‚æ¥è¯»å–æ•°æ®ï¼Œæ­¤æ—¶è¿”å›çš„æ˜¯è€æ•°æ®ï¼Œæ­¤æ—¶å¯ä»¥è®¤ä¸ºæ˜¯Aè¯·æ±‚è¿˜æ²¡æ›´æ–°å®Œï¼Œæœ€ç»ˆä¸€è‡´æ€§ï¼Œå¯ä»¥æ¥å—ï¼Œç„¶åAåˆ é™¤äº†ç¼“å­˜ï¼Œåç»­è¯·æ±‚éƒ½ä¼šæ‹¿åˆ°æœ€æ–°æ•°æ®ï¼Œå¦‚å›¾ è®©æˆ‘ä»¬å†æ¥çœ‹ä¸€ä¸‹æ­£å¸¸çš„è¯·æ±‚æµç¨‹ï¼š ç¬¬ä¸€ä¸ªè¯·æ±‚æ›´æ–°DBï¼Œå¹¶åˆ é™¤äº†ç¼“å­˜ ç¬¬äºŒä¸ªè¯·æ±‚è¯»å–ç¼“å­˜ï¼Œæ²¡æœ‰æ•°æ®ï¼Œå°±ä»DBè¯»å–æ•°æ®ï¼Œå¹¶å›å†™åˆ°ç¼“å­˜é‡Œ åç»­è¯»è¯·æ±‚éƒ½å¯ä»¥ç›´æ¥ä»ç¼“å­˜è¯»å– æˆ‘ä»¬å†çœ‹ä¸€ä¸‹DBæŸ¥è¯¢æœ‰å“ªäº›æƒ…å†µï¼Œå‡è®¾è¡Œè®°å½•é‡Œæœ‰ABCDEFGä¸ƒåˆ—æ•°æ®ï¼š åªæŸ¥è¯¢éƒ¨åˆ†åˆ—æ•°æ®çš„è¯·æ±‚ï¼Œæ¯”å¦‚è¯·æ±‚å…¶ä¸­çš„ABCï¼ŒCDEæˆ–è€…EFGç­‰ï¼Œå¦‚å›¾ æŸ¥è¯¢å•æ¡å®Œæ•´è¡Œè®°å½•ï¼Œå¦‚å›¾ æŸ¥è¯¢å¤šæ¡è¡Œè®°å½•çš„éƒ¨åˆ†æˆ–å…¨éƒ¨åˆ—ï¼Œå¦‚å›¾ å¯¹äºä¸Šé¢ä¸‰ç§æƒ…å†µï¼Œé¦–å…ˆï¼Œæˆ‘ä»¬ä¸ç”¨éƒ¨åˆ†æŸ¥è¯¢ï¼Œå› ä¸ºéƒ¨åˆ†æŸ¥è¯¢æ²¡æ³•ç¼“å­˜ï¼Œä¸€æ—¦ç¼“å­˜äº†ï¼Œæ•°æ®æœ‰æ›´æ–°ï¼Œæ²¡æ³•å®šä½åˆ°æœ‰å“ªäº›æ•°æ®éœ€è¦åˆ é™¤ï¼›å…¶æ¬¡ï¼Œå¯¹äºå¤šè¡Œçš„æŸ¥è¯¢ï¼Œæ ¹æ®å®é™…åœºæ™¯å’Œéœ€è¦ï¼Œæˆ‘ä»¬ä¼šåœ¨ä¸šåŠ¡å±‚å»ºç«‹å¯¹åº”çš„ä»æŸ¥è¯¢æ¡ä»¶åˆ°ä¸»é”®çš„æ˜ å°„ï¼›è€Œå¯¹äºå•è¡Œå®Œæ•´è®°å½•çš„æŸ¥è¯¢ï¼Œgo-zero å†…ç½®äº†å®Œæ•´çš„ç¼“å­˜ç®¡ç†æ–¹å¼ã€‚æ‰€ä»¥æ ¸å¿ƒåŸåˆ™æ˜¯ï¼šgo-zero ç¼“å­˜çš„ä¸€å®šæ˜¯å®Œæ•´çš„è¡Œè®°å½•ã€‚ ä¸‹é¢æˆ‘ä»¬æ¥è¯¦ç»†ä»‹ç» go-zero å†…ç½®çš„ä¸‰ç§åœºæ™¯çš„ç¼“å­˜å¤„ç†æ–¹å¼ï¼š åŸºäºä¸»é”®çš„ç¼“å­˜PRIMARY KEY (`id`) è¿™ç§ç›¸å¯¹æ¥è®²æ˜¯æœ€å®¹æ˜“å¤„ç†çš„ç¼“å­˜ï¼Œåªéœ€è¦åœ¨ redis é‡Œç”¨ primary key ä½œä¸º key æ¥ç¼“å­˜è¡Œè®°å½•å³å¯ã€‚ åŸºäºå”¯ä¸€ç´¢å¼•çš„ç¼“å­˜ åœ¨åšåŸºäºç´¢å¼•çš„ç¼“å­˜è®¾è®¡çš„æ—¶å€™æˆ‘å€Ÿé‰´äº† database ç´¢å¼•çš„è®¾è®¡æ–¹æ³•ï¼Œåœ¨ database è®¾è®¡é‡Œï¼Œå¦‚æœé€šè¿‡ç´¢å¼•å»æŸ¥æ•°æ®æ—¶ï¼Œå¼•æ“ä¼šå…ˆåœ¨ ç´¢å¼•->ä¸»é”® çš„ tree é‡Œé¢æŸ¥æ‰¾åˆ°ä¸»é”®ï¼Œç„¶åå†é€šè¿‡ä¸»é”®å»æŸ¥è¯¢è¡Œè®°å½•ï¼Œå°±æ˜¯å¼•å…¥äº†ä¸€ä¸ªé—´æ¥å±‚å»è§£å†³ç´¢å¼•åˆ°è¡Œè®°å½•çš„å¯¹åº”é—®é¢˜ã€‚åœ¨ go-zero çš„ç¼“å­˜è®¾è®¡é‡Œä¹Ÿæ˜¯åŒæ ·çš„åŸç†ã€‚ åŸºäºç´¢å¼•çš„ç¼“å­˜åˆåˆ†ä¸ºå•åˆ—å”¯ä¸€ç´¢å¼•å’Œå¤šåˆ—å”¯ä¸€ç´¢å¼•ï¼š ä½†æ˜¯å¯¹äº go-zero æ¥è¯´ï¼Œå•åˆ—å’Œå¤šåˆ—åªæ˜¯ç”Ÿæˆç¼“å­˜ key çš„æ–¹å¼ä¸åŒè€Œå·²ï¼ŒèƒŒåçš„æ§åˆ¶é€»è¾‘æ˜¯ä¸€æ ·çš„ã€‚ç„¶å go-zero å†…ç½®çš„ç¼“å­˜ç®¡ç†å°±æ¯”è¾ƒå¥½çš„æ§åˆ¶äº†æ•°æ®ä¸€è‡´æ€§é—®é¢˜ï¼ŒåŒæ—¶ä¹Ÿå†…ç½®é˜²æ­¢äº†ç¼“å­˜çš„å‡»ç©¿ã€ç©¿é€ã€é›ªå´©é—®é¢˜ï¼ˆè¿™äº›åœ¨ gopherchina å¤§ä¼šä¸Šåˆ†äº«çš„æ—¶å€™ä»”ç»†è®²è¿‡ï¼Œè§åç»­ gopherchina åˆ†äº«è§†é¢‘ï¼‰ã€‚ å¦å¤–ï¼Œgo-zero å†…ç½®äº†ç¼“å­˜è®¿é—®é‡ã€è®¿é—®å‘½ä¸­ç‡ç»Ÿè®¡ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š dbcache(sqlc) - qpm: 5057, hit_ratio: 99.7%, hit: 5044, miss: 13, db_fails: 0 å¯ä»¥çœ‹åˆ°æ¯”è¾ƒè¯¦ç»†çš„ç»Ÿè®¡ä¿¡æ¯ï¼Œä¾¿äºæˆ‘ä»¬æ¥åˆ†æç¼“å­˜çš„ä½¿ç”¨æƒ…å†µï¼Œå¯¹äºç¼“å­˜å‘½ä¸­ç‡æä½æˆ–è€…è¯·æ±‚é‡æå°çš„æƒ…å†µï¼Œæˆ‘ä»¬å°±å¯ä»¥å»æ‰ç¼“å­˜äº†ï¼Œè¿™æ ·ä¹Ÿå¯ä»¥é™ä½æˆæœ¬ã€‚ å•åˆ—å”¯ä¸€ç´¢å¼•å¦‚ä¸‹ï¼š UNIQUE KEY `product_idx` (`product`) å¤šåˆ—å”¯ä¸€ç´¢å¼•å¦‚ä¸‹ï¼š UNIQUE KEY `vendor_product_idx` (`vendor`, `product`) ç¼“å­˜ä»£ç è§£è¯» 1.åŸºäºä¸»é”®çš„ç¼“å­˜é€»è¾‘ å…·ä½“å®ç°ä»£ç å¦‚ä¸‹ï¼š func (cc CachedConn) QueryRow(v interface{}, key string, query QueryFn) error { return cc.cache.Take(v, key, func(v interface{}) error { return query(cc.db, v) }) } è¿™é‡Œçš„ Take æ–¹æ³•æ˜¯å…ˆä»ç¼“å­˜é‡Œå»é€šè¿‡ key æ‹¿æ•°æ®ï¼Œå¦‚æœæ‹¿åˆ°å°±ç›´æ¥è¿”å›ï¼Œå¦‚æœæ‹¿ä¸åˆ°ï¼Œé‚£ä¹ˆå°±é€šè¿‡ query æ–¹æ³•å» DB è¯»å–å®Œæ•´è¡Œè®°å½•å¹¶å†™å›ç¼“å­˜ï¼Œç„¶åå†è¿”å›æ•°æ®ã€‚æ•´ä¸ªé€»è¾‘è¿˜æ˜¯æ¯”è¾ƒç®€å•æ˜“æ‡‚çš„ã€‚ æˆ‘ä»¬è¯¦ç»†çœ‹çœ‹ Take çš„å®ç°ï¼š func (c cacheNode) Take(v interface{}, key string, query func(v interface{}) error) error { return c.doTake(v, key, query, func(v interface{}) error { return c.SetCache(key, v) }) } Take çš„é€»è¾‘å¦‚ä¸‹ï¼š ç”¨ key ä»ç¼“å­˜é‡ŒæŸ¥æ‰¾æ•°æ® å¦‚æœæ‰¾åˆ°ï¼Œåˆ™è¿”å›æ•°æ® å¦‚æœæ‰¾ä¸åˆ°ï¼Œç”¨ query æ–¹æ³•å»è¯»å–æ•°æ® è¯»åˆ°åè°ƒç”¨ c.SetCache(key, v) è®¾ç½®ç¼“å­˜ å…¶ä¸­çš„ doTake ä»£ç å’Œè§£é‡Šå¦‚ä¸‹ï¼š // v - éœ€è¦è¯»å–çš„æ•°æ®å¯¹è±¡ // key - ç¼“å­˜key // query - ç”¨æ¥ä»DBè¯»å–å®Œæ•´æ•°æ®çš„æ–¹æ³• // cacheVal - ç”¨æ¥å†™ç¼“å­˜çš„æ–¹æ³• func (c cacheNode) doTake(v interface{}, key string, query func(v interface{}) error, cacheVal func(v interface{}) error) error { // ç”¨barrieræ¥é˜²æ­¢ç¼“å­˜å‡»ç©¿ï¼Œç¡®ä¿ä¸€ä¸ªè¿›ç¨‹å†…åªæœ‰ä¸€ä¸ªè¯·æ±‚å»åŠ è½½keyå¯¹åº”çš„æ•°æ® val, fresh, err := c.barrier.DoEx(key, func() (interface{}, error) { // ä»cacheé‡Œè¯»å–æ•°æ® if err := c.doGetCache(key, v); err != nil { // å¦‚æœæ˜¯é¢„å…ˆæ”¾è¿›æ¥çš„placeholderï¼ˆç”¨æ¥é˜²æ­¢ç¼“å­˜ç©¿é€ï¼‰çš„ï¼Œé‚£ä¹ˆå°±è¿”å›é¢„è®¾çš„errNotFound // å¦‚æœæ˜¯æœªçŸ¥é”™è¯¯ï¼Œé‚£ä¹ˆå°±ç›´æ¥è¿”å›ï¼Œå› ä¸ºæˆ‘ä»¬ä¸èƒ½æ”¾å¼ƒç¼“å­˜å‡ºé”™è€Œç›´æ¥æŠŠæ‰€æœ‰è¯·æ±‚å»è¯·æ±‚DBï¼Œ // è¿™æ ·åœ¨é«˜å¹¶å‘çš„åœºæ™¯ä¸‹ä¼šæŠŠDBæ‰“æŒ‚æ‰çš„ if err == errPlaceholder { return nil, c.errNotFound } else if err != c.errNotFound { // why we just return the error instead of query from db, // because we don't allow the disaster pass to the DBs. // fail fast, in case we bring down the dbs. return nil, err } // è¯·æ±‚DB // å¦‚æœè¿”å›çš„erroræ˜¯errNotFoundï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±éœ€è¦åœ¨ç¼“å­˜é‡Œè®¾ç½®placeholderï¼Œé˜²æ­¢ç¼“å­˜ç©¿é€ if err = query(v); err == c.errNotFound { if err = c.setCacheWithNotFound(key); err != nil { logx.Error(err) } return nil, c.errNotFound } else if err != nil { // ç»Ÿè®¡DBå¤±è´¥ c.stat.IncrementDbFails() return nil, err } // æŠŠæ•°æ®å†™å…¥ç¼“å­˜ if err = cacheVal(v); err != nil { logx.Error(err) } } // è¿”å›jsonåºåˆ—åŒ–çš„æ•°æ® return jsonx.Marshal(v) }) if err != nil { return err } if fresh { return nil } // got the result from previous ongoing query c.stat.IncrementTotal() c.stat.IncrementHit() // æŠŠæ•°æ®å†™å…¥åˆ°ä¼ å…¥çš„vå¯¹è±¡é‡Œ return jsonx.Unmarshal(val.([]byte), v) } 2. åŸºäºå”¯ä¸€ç´¢å¼•çš„ç¼“å­˜é€»è¾‘ å› ä¸ºè¿™å—æ¯”è¾ƒå¤æ‚ï¼Œæ‰€ä»¥æˆ‘ç”¨ä¸åŒé¢œè‰²æ ‡è¯†å‡ºæ¥äº†å“åº”çš„ä»£ç å—å’Œé€»è¾‘ï¼Œblock 2 å…¶å®è·ŸåŸºäºä¸»é”®çš„ç¼“å­˜æ˜¯ä¸€æ ·çš„ï¼Œè¿™é‡Œä¸»è¦è®² block 1 çš„é€»è¾‘ã€‚ ä»£ç å—çš„ block 1 éƒ¨åˆ†åˆ†ä¸ºä¸¤ç§æƒ…å†µï¼š é€šè¿‡ç´¢å¼•èƒ½å¤Ÿä»ç¼“å­˜é‡Œæ‰¾åˆ°ä¸»é”®ï¼Œæ­¤æ—¶å°±ç›´æ¥ç”¨ä¸»é”®èµ° block 2 çš„é€»è¾‘äº†ï¼Œåç»­åŒä¸Šé¢åŸºäºä¸»é”®çš„ç¼“å­˜é€»è¾‘ é€šè¿‡ç´¢å¼•æ— æ³•ä»ç¼“å­˜é‡Œæ‰¾åˆ°ä¸»é”® é€šè¿‡ç´¢å¼•ä»DBé‡ŒæŸ¥è¯¢å®Œæ•´è¡Œè®°å½•ï¼Œå¦‚æœ‰ errorï¼Œè¿”å› æŸ¥åˆ°å®Œæ•´è¡Œè®°å½•åï¼Œä¼šæŠŠä¸»é”®åˆ°å®Œæ•´è¡Œè®°å½•çš„ç¼“å­˜å’Œç´¢å¼•åˆ°ä¸»é”®çš„ç¼“å­˜åŒæ—¶å†™åˆ° redis é‡Œ è¿”å›æ‰€éœ€çš„è¡Œè®°å½•æ•°æ® // v - éœ€è¦è¯»å–çš„æ•°æ®å¯¹è±¡ // key - é€šè¿‡ç´¢å¼•ç”Ÿæˆçš„ç¼“å­˜key // keyer - ç”¨ä¸»é”®ç”ŸæˆåŸºäºä¸»é”®ç¼“å­˜çš„keyçš„æ–¹æ³• // indexQuery - ç”¨ç´¢å¼•ä»DBè¯»å–å®Œæ•´æ•°æ®çš„æ–¹æ³•ï¼Œéœ€è¦è¿”å›ä¸»é”® // primaryQuery - ç”¨ä¸»é”®ä»DBè·å–å®Œæ•´æ•°æ®çš„æ–¹æ³• func (cc CachedConn) QueryRowIndex(v interface{}, key string, keyer func(primary interface{}) string, indexQuery IndexQueryFn, primaryQuery PrimaryQueryFn) error { var primaryKey interface{} var found bool // å…ˆé€šè¿‡ç´¢å¼•æŸ¥è¯¢ç¼“å­˜ï¼Œçœ‹æ˜¯å¦æœ‰ç´¢å¼•åˆ°ä¸»é”®çš„ç¼“å­˜ if err := cc.cache.TakeWithExpire(&primaryKey, key, func(val interface{}, expire time.Duration) (err error) { // å¦‚æœæ²¡æœ‰ç´¢å¼•åˆ°ä¸»é”®çš„ç¼“å­˜ï¼Œé‚£ä¹ˆå°±é€šè¿‡ç´¢å¼•æŸ¥è¯¢å®Œæ•´æ•°æ® primaryKey, err = indexQuery(cc.db, v) if err != nil { return } // é€šè¿‡ç´¢å¼•æŸ¥è¯¢åˆ°äº†å®Œæ•´æ•°æ®ï¼Œè®¾ç½®foundï¼Œåé¢ç›´æ¥ä½¿ç”¨ï¼Œä¸éœ€è¦å†ä»ç¼“å­˜è¯»å–æ•°æ®äº† found = true // å°†ä¸»é”®åˆ°å®Œæ•´æ•°æ®çš„æ˜ å°„ä¿å­˜åˆ°ç¼“å­˜é‡Œï¼ŒTakeWithExpireæ–¹æ³•å·²ç»å°†ç´¢å¼•åˆ°ä¸»é”®çš„æ˜ å°„ä¿å­˜åˆ°ç¼“å­˜äº† return cc.cache.SetCacheWithExpire(keyer(primaryKey), v, expire+cacheSafeGapBetweenIndexAndPrimary) }); err != nil { return err } // å·²ç»é€šè¿‡ç´¢å¼•æ‰¾åˆ°äº†æ•°æ®ï¼Œç›´æ¥è¿”å›å³å¯ if found { return nil } // é€šè¿‡ä¸»é”®ä»ç¼“å­˜è¯»å–æ•°æ®ï¼Œå¦‚æœç¼“å­˜æ²¡æœ‰ï¼Œé€šè¿‡primaryQueryæ–¹æ³•ä»DBè¯»å–å¹¶å›å†™ç¼“å­˜å†è¿”å›æ•°æ® return cc.cache.Take(v, keyer(primaryKey), func(v interface{}) error { return primaryQuery(cc.db, v, primaryKey) }) } æˆ‘ä»¬æ¥çœ‹ä¸€ä¸ªå®é™…çš„ä¾‹å­ func (m *defaultUserModel) FindOneByUser(user string) (*User, error) { var resp User // ç”ŸæˆåŸºäºç´¢å¼•çš„key indexKey := fmt.Sprintf(\"%s%v\", cacheUserPrefix, user) err := m.QueryRowIndex(&resp, indexKey, // åŸºäºä¸»é”®ç”Ÿæˆå®Œæ•´æ•°æ®ç¼“å­˜çš„key func(primary interface{}) string { return fmt.Sprintf(\"user#%v\", primary) }, // åŸºäºç´¢å¼•çš„DBæŸ¥è¯¢æ–¹æ³• func(conn sqlx.SqlConn, v interface{}) (i interface{}, e error) { query := fmt.Sprintf(\"select %s from %s where user = ? limit 1\", userRows, m.table) if err := conn.QueryRow(&resp, query, user); err != nil { return nil, err } return resp.Id, nil }, // åŸºäºä¸»é”®çš„DBæŸ¥è¯¢æ–¹æ³• func(conn sqlx.SqlConn, v, primary interface{}) error { query := fmt.Sprintf(\"select %s from %s where id = ?\", userRows, m.table) return conn.QueryRow(&resp, query, primary) }) // é”™è¯¯å¤„ç†ï¼Œéœ€è¦åˆ¤æ–­æ˜¯å¦è¿”å›çš„æ˜¯sqlc.ErrNotFoundï¼Œå¦‚æœæ˜¯ï¼Œæˆ‘ä»¬ç”¨æœ¬packageå®šä¹‰çš„ErrNotFoundè¿”å› // é¿å…ä½¿ç”¨è€…æ„ŸçŸ¥åˆ°æœ‰æ²¡æœ‰ä½¿ç”¨ç¼“å­˜ï¼ŒåŒæ—¶ä¹Ÿæ˜¯å¯¹åº•å±‚ä¾èµ–çš„éš”ç¦» switch err { case nil: return &resp, nil case sqlc.ErrNotFound: return nil, ErrNotFound default: return nil, err } } æ‰€æœ‰ä¸Šé¢è¿™äº›ç¼“å­˜çš„è‡ªåŠ¨ç®¡ç†ä»£ç éƒ½æ˜¯å¯ä»¥é€šè¿‡ goctl è‡ªåŠ¨ç”Ÿæˆçš„ï¼Œæˆ‘ä»¬å›¢é˜Ÿå†…éƒ¨ CRUD å’Œç¼“å­˜åŸºæœ¬éƒ½æ˜¯é€šè¿‡ goctl è‡ªåŠ¨ç”Ÿæˆçš„ï¼Œå¯ä»¥èŠ‚çœå¤§é‡å¼€å‘æ—¶é—´ï¼Œå¹¶ä¸”ç¼“å­˜ä»£ç æœ¬èº«ä¹Ÿæ˜¯éå¸¸å®¹æ˜“å‡ºé”™çš„ï¼Œå³ä½¿æœ‰å¾ˆå¥½çš„ä»£ç ç»éªŒï¼Œä¹Ÿå¾ˆéš¾æ¯æ¬¡å®Œå…¨å†™å¯¹ï¼Œæ‰€ä»¥æˆ‘ä»¬æ¨èå°½å¯èƒ½ä½¿ç”¨è‡ªåŠ¨çš„ç¼“å­˜ä»£ç ç”Ÿæˆå·¥å…·å»é¿å…é”™è¯¯ã€‚ çŒœä½ æƒ³çœ‹ Goå¼€æºè¯´ç¬¬å››æœŸ-go-zeroç¼“å­˜å¦‚ä½•è®¾è®¡ Goctl Copyright Â© 2019-2021 go-zero all right reservedï¼Œpowered by GitbookLast UpdateTimeï¼š 2025-05-05 05:44:52 "},"buiness-cache.html":{"url":"buiness-cache.html","title":"go-zeroç¼“å­˜è®¾è®¡ä¹‹ä¸šåŠ¡å±‚ç¼“å­˜","keywords":"","body":"go-zeroç¼“å­˜è®¾è®¡ä¹‹ä¸šåŠ¡å±‚ç¼“å­˜ åœ¨ä¸Šä¸€ç¯‡go-zeroç¼“å­˜è®¾è®¡ä¹‹æŒä¹…å±‚ç¼“å­˜ä»‹ç»äº†dbå±‚ç¼“å­˜ï¼Œå›é¡¾ä¸€ä¸‹ï¼Œdbå±‚ç¼“å­˜ä¸»è¦è®¾è®¡å¯ä»¥æ€»ç»“ä¸ºï¼š ç¼“å­˜åªåˆ é™¤ä¸æ›´æ–° è¡Œè®°å½•å§‹ç»ˆåªå­˜å‚¨ä¸€ä»½ï¼Œå³ä¸»é”®å¯¹åº”è¡Œè®°å½• å”¯ä¸€ç´¢å¼•ä»…ç¼“å­˜ä¸»é”®å€¼ï¼Œä¸ç›´æ¥ç¼“å­˜è¡Œè®°å½•ï¼ˆå‚è€ƒmysqlç´¢å¼•æ€æƒ³ï¼‰ é˜²ç¼“å­˜ç©¿é€è®¾è®¡ï¼Œé»˜è®¤ä¸€åˆ†é’Ÿ ä¸ç¼“å­˜å¤šè¡Œè®°å½• å‰è¨€ åœ¨å¤§å‹ä¸šåŠ¡ç³»ç»Ÿä¸­ï¼Œé€šè¿‡å¯¹æŒä¹…å±‚æ·»åŠ ç¼“å­˜ï¼Œå¯¹äºå¤§å¤šæ•°å•è¡Œè®°å½•æŸ¥è¯¢ï¼Œç›¸ä¿¡ç¼“å­˜èƒ½å¤Ÿå¸®æŒä¹…å±‚å‡è½»å¾ˆå¤§çš„è®¿é—®å‹åŠ›ï¼Œä½†åœ¨å®é™…ä¸šåŠ¡ä¸­ï¼Œæ•°æ®è¯»å–ä¸ä»…ä»…åªæ˜¯å•è¡Œè®°å½•ï¼Œ é¢å¯¹å¤§é‡å¤šè¡Œè®°å½•çš„æŸ¥è¯¢ï¼Œè¿™å¯¹æŒä¹…å±‚ä¹Ÿä¼šé€ æˆä¸å°çš„è®¿é—®å‹åŠ›ï¼Œé™¤æ­¤ä¹‹å¤–ï¼Œåƒç§’æ€ç³»ç»Ÿã€é€‰è¯¾ç³»ç»Ÿè¿™ç§é«˜å¹¶å‘çš„åœºæ™¯ï¼Œå•çº¯é æŒä¹…å±‚çš„ç¼“å­˜æ˜¯ä¸ç°å®çš„ï¼Œæœ¬èŠ‚æˆ‘ä»¬æ¥ ä»‹ç»go-zeroå®è·µä¸­çš„ç¼“å­˜è®¾è®¡â€”â€”bizç¼“å­˜ã€‚ é€‚ç”¨åœºæ™¯ä¸¾ä¾‹ é€‰è¯¾ç³»ç»Ÿ å†…å®¹ç¤¾äº¤ç³»ç»Ÿ ç§’æ€ ... åƒè¿™äº›ç³»ç»Ÿï¼Œæˆ‘ä»¬å¯ä»¥åœ¨ä¸šåŠ¡å±‚å†å¢åŠ ä¸€å±‚ç¼“å­˜æ¥å­˜å‚¨ç³»ç»Ÿä¸­çš„å…³é”®ä¿¡æ¯ï¼Œå¦‚é€‰è¯¾ç³»ç»Ÿä¸­å­¦ç”Ÿé€‰è¯¾ä¿¡æ¯ï¼Œè¯¾ç¨‹å‰©ä½™åé¢ï¼›å†…å®¹ç¤¾äº¤ç³»ç»Ÿä¸­æŸä¸€æ®µæ—¶é—´ä¹‹é—´çš„å†…å®¹ä¿¡æ¯ç­‰ã€‚ æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬ä¸€å†…å®¹ç¤¾äº¤ç³»ç»Ÿæ¥è¿›è¡Œä¸¾ä¾‹è¯´æ˜ã€‚ åœ¨å†…å®¹ç¤¾äº¤ç³»ç»Ÿä¸­ï¼Œæˆ‘ä»¬ä¸€èˆ¬æ˜¯å…ˆæŸ¥è¯¢ä¸€æ‰¹å†…å®¹åˆ—è¡¨ï¼Œç„¶åç‚¹å‡»æŸæ¡å†…å®¹æŸ¥çœ‹è¯¦æƒ…ï¼Œ åœ¨æ²¡æœ‰æ·»åŠ bizç¼“å­˜å‰ï¼Œå†…å®¹ä¿¡æ¯çš„æŸ¥è¯¢æµç¨‹å›¾åº”è¯¥ä¸ºï¼š ä»å›¾ä»¥åŠä¸Šä¸€ç¯‡æ–‡ç« go-zeroç¼“å­˜è®¾è®¡ä¹‹æŒä¹…å±‚ç¼“å­˜ä¸­æˆ‘ä»¬å¯ä»¥çŸ¥é“ï¼Œå†…å®¹åˆ—è¡¨çš„è·å–æ˜¯æ²¡åŠæ³•ä¾èµ–ç¼“å­˜çš„ï¼Œ å¦‚æœæˆ‘ä»¬åœ¨ä¸šåŠ¡å±‚æ·»åŠ ä¸€å±‚ç¼“å­˜ç”¨æ¥å­˜å‚¨åˆ—è¡¨ä¸­çš„å…³é”®ä¿¡æ¯ï¼ˆç”šè‡³å®Œæ•´ä¿¡æ¯ï¼‰ï¼Œé‚£ä¹ˆå¤šè¡Œè®°å½•çš„è®¿é—®ä¸åœ¨æ˜¯ä¸€ä¸ªé—®é¢˜ï¼Œè¿™å°±æ˜¯biz redisè¦åšçš„äº‹æƒ…ã€‚ æ¥ä¸‹æ¥æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹è®¾è®¡æ–¹æ¡ˆï¼Œå‡è®¾å†…å®¹ç³»ç»Ÿä¸­å•è¡Œè®°å½•åŒ…å«ä»¥ä¸‹å­—æ®µ å­—æ®µåç§° å­—æ®µç±»å‹ å¤‡æ³¨ id string å†…å®¹id title string æ ‡é¢˜ content string è¯¦ç»†å†…å®¹ createTime time.Time åˆ›å»ºæ—¶é—´ æˆ‘ä»¬çš„ç›®æ ‡æ˜¯è·å–ä¸€æ‰¹å†…å®¹åˆ—è¡¨ï¼Œè€Œå°½é‡é¿å…å†…å®¹åˆ—è¡¨èµ°dbé€ æˆè®¿é—®å‹åŠ›ï¼Œé¦–å…ˆæˆ‘ä»¬é‡‡ç”¨redisçš„sort setæ•°æ®ç»“æ„æ¥å­˜å‚¨ï¼Œæ ¹éœ€è¦å­˜å‚¨çš„å­—æ®µä¿¡æ¯é‡ï¼Œæœ‰ä¸¤ç§rediså­˜å‚¨æ–¹æ¡ˆï¼š ç¼“å­˜å±€éƒ¨ä¿¡æ¯ å¯¹å…¶å…³é”®å­—æ®µä¿¡æ¯ï¼ˆå¦‚ï¼šidç­‰ï¼‰æŒ‰ç…§ä¸€å®šè§„åˆ™å‹ç¼©ï¼Œå¹¶å­˜å‚¨ï¼Œscoreæˆ‘ä»¬ç”¨createTimeæ¯«ç§’å€¼ï¼ˆæ—¶é—´å€¼ç›¸ç­‰è¿™é‡Œä¸è®¨è®ºï¼‰ï¼Œè¿™ç§å­˜å‚¨æ–¹æ¡ˆçš„å¥½å¤„æ˜¯èŠ‚çº¦rediså­˜å‚¨ç©ºé—´ï¼Œ é‚£å¦ä¸€æ–¹é¢ï¼Œç¼ºç‚¹å°±æ˜¯éœ€è¦å¯¹åˆ—è¡¨è¯¦ç»†å†…å®¹è¿›è¡ŒäºŒæ¬¡å›æŸ¥ï¼ˆä½†è¿™æ¬¡å›æŸ¥æ˜¯ä¼šåˆ©ç”¨åˆ°æŒä¹…å±‚çš„è¡Œè®°å½•ç¼“å­˜çš„ï¼‰ ç¼“å­˜å®Œæ•´ä¿¡æ¯ å¯¹å‘å¸ƒçš„æ‰€æœ‰å†…å®¹æŒ‰ç…§ä¸€å®šè§„åˆ™å‹ç¼©åå‡è¿›è¡Œå­˜å‚¨ï¼ŒåŒæ ·scoreæˆ‘ä»¬è¿˜æ˜¯ç”¨createTimeæ¯«ç§’å€¼ï¼Œè¿™ç§å­˜å‚¨æ–¹æ¡ˆçš„å¥½å¤„æ˜¯ä¸šåŠ¡çš„å¢ã€åˆ ã€æŸ¥ã€æ”¹å‡èµ°redisï¼Œè€Œdbå±‚è¿™æ—¶å€™ å°±å¯ä»¥ä¸ç”¨è€ƒè™‘è¡Œè®°å½•ç¼“å­˜äº†ï¼ŒæŒä¹…å±‚ä»…æä¾›æ•°æ®å¤‡ä»½å’Œæ¢å¤ä½¿ç”¨ï¼Œä»å¦ä¸€æ–¹é¢æ¥çœ‹ï¼Œå…¶ç¼ºç‚¹ä¹Ÿå¾ˆæ˜æ˜¾ï¼Œéœ€è¦çš„å­˜å‚¨ç©ºé—´ã€é…ç½®è¦æ±‚æ›´é«˜ï¼Œè´¹ç”¨ä¹Ÿä¼šéšä¹‹å¢å¤§ã€‚ ç¤ºä¾‹ä»£ç ï¼š type Content struct { Id string `json:\"id\"` Title string `json:\"title\"` Content string `json:\"content\"` CreateTime time.Time `json:\"create_time\"` } const bizContentCacheKey = `biz#content#cache` // AddContent æä¾›å†…å®¹å­˜å‚¨ func AddContent(r redis.Redis, c *Content) error { v := compress(c) _, err := r.Zadd(bizContentCacheKey, c.CreateTime.UnixNano()/1e6, v) return err } // DelContent æä¾›å†…å®¹åˆ é™¤ func DelContent(r redis.Redis, c *Content) error { v := compress(c) _, err := r.Zrem(bizContentCacheKey, v) return err } // å†…å®¹å‹ç¼© func compress(c *Content) string { // todo: do it yourself var ret string return ret } // å†…å®¹è§£å‹ func unCompress(v string) *Content { // todo: do it yourself var ret Content return &ret } // ListByRangeTimeæä¾›æ ¹æ®æ—¶é—´æ®µè¿›è¡Œæ•°æ®æŸ¥è¯¢ func ListByRangeTime(r redis.Redis, start, end time.Time) ([]*Content, error) { kvs, err := r.ZrangebyscoreWithScores(bizContentCacheKey, start.UnixNano()/1e6, end.UnixNano()/1e6) if err != nil { return nil, err } var list []*Content for _, kv := range kvs { data:=unCompress(kv.Key) list = append(list, data) } return list, nil } åœ¨ä»¥ä¸Šä¾‹å­ä¸­ï¼Œredisæ˜¯æ²¡æœ‰è®¾ç½®è¿‡æœŸæ—¶é—´çš„ï¼Œæˆ‘ä»¬å°†å¢ã€åˆ ã€æ”¹ã€æŸ¥æ“ä½œå‡åŒæ­¥åˆ°redisï¼Œæˆ‘ä»¬è®¤ä¸ºå†…å®¹ç¤¾äº¤ç³»ç»Ÿçš„åˆ—è¡¨è®¿é—®è¯·æ±‚æ˜¯æ¯”è¾ƒé«˜çš„æƒ…å†µä¸‹æ‰åšè¿™æ ·çš„æ–¹æ¡ˆè®¾è®¡ï¼Œ é™¤æ­¤ä¹‹å¤–ï¼Œè¿˜æœ‰ä¸€äº›æ•°æ®è®¿é—®ï¼Œæ²¡æœ‰æƒ³å†…å®¹è®¾è®¡ç³»ç»Ÿè¿™ä¹ˆé¢‘ç¹çš„è®¿é—®ï¼Œ å¯èƒ½æ˜¯æŸä¸€æ—¶é—´æ®µå†…è®¿é—®é‡çªå¦‚å…¶æ¥çš„å¢åŠ ï¼Œä¹‹åå¯èƒ½å¾ˆé•¿ä¸€æ®µæ—¶é—´æ‰ä¼šå†è®¿é—®ä¸€æ¬¡ï¼Œä»¥æ­¤é—´éš”ï¼Œ æˆ–è€…è¯´ä¸ä¼šå†è®¿é—®äº†ï¼Œé¢å¯¹è¿™ç§åœºæ™¯ï¼Œå¦‚æœæˆ‘åˆè¯¥å¦‚ä½•è€ƒè™‘ç¼“å­˜çš„è®¾è®¡å‘¢ï¼Ÿåœ¨go-zeroå†…å®¹å®è·µä¸­ï¼Œæœ‰ä¸¤ç§æ–¹æ¡ˆå¯ä»¥è§£å†³è¿™ç§é—®é¢˜ï¼š å¢åŠ å†…å­˜ç¼“å­˜ï¼šé€šè¿‡å†…å­˜ç¼“å­˜æ¥å­˜å‚¨å½“å‰å¯èƒ½çªå‘è®¿é—®é‡æ¯”è¾ƒå¤§çš„æ•°æ®ï¼Œå¸¸ç”¨çš„å­˜å‚¨æ–¹æ¡ˆé‡‡ç”¨mapæ•°æ®ç»“æ„æ¥å­˜å‚¨ï¼Œmapæ•°æ®å­˜å‚¨å®ç°æ¯”è¾ƒç®€å•ï¼Œä½†ç¼“å­˜è¿‡æœŸå¤„ç†åˆ™éœ€è¦å¢åŠ  å®šæ—¶å™¨æ¥å‡ºæ¥ï¼Œå¦ä¸€å®—æ–¹æ¡ˆæ˜¯é€šè¿‡go-zeroåº“ä¸­çš„ Cache ï¼Œå…¶æ˜¯ä¸“é—¨ ç”¨äºå†…å­˜ç®¡ç†. é‡‡ç”¨biz redis,å¹¶è®¾ç½®åˆç†çš„è¿‡æœŸæ—¶é—´ æ€»ç»“ ä»¥ä¸Šä¸¤ä¸ªåœºæ™¯å¯ä»¥åŒ…å«å¤§éƒ¨åˆ†çš„å¤šè¡Œè®°å½•ç¼“å­˜ï¼Œå¯¹äºå¤šè¡Œè®°å½•æŸ¥è¯¢é‡ä¸å¤§çš„åœºæ™¯ï¼Œæš‚æ—¶æ²¡å¿…è¦ç›´æ¥æŠŠbiz redisæ”¾è¿›å»ï¼Œå¯ä»¥å…ˆå°è¯•è®©dbæ¥æ‰¿æ‹…ï¼Œå¼€å‘äººå‘˜å¯ä»¥æ ¹æ®æŒä¹…å±‚ç›‘æ§åŠæœåŠ¡ ç›‘æ§æ¥è¡¡é‡æ—¶å€™éœ€è¦å¼•å…¥bizã€‚ Copyright Â© 2019-2021 go-zero all right reservedï¼Œpowered by GitbookLast UpdateTimeï¼š 2025-05-05 05:44:52 "},"go-queue.html":{"url":"go-queue.html","title":"go-zeroåˆ†å¸ƒå¼å®šæ—¶ä»»åŠ¡","keywords":"","body":" go-zero åˆ†å¸ƒå¼å®šæ—¶ä»»åŠ¡ æ—¥å¸¸ä»»åŠ¡å¼€å‘ä¸­ï¼Œæˆ‘ä»¬ä¼šæœ‰å¾ˆå¤šå¼‚æ­¥ã€æ‰¹é‡ã€å®šæ—¶ã€å»¶è¿Ÿä»»åŠ¡è¦å¤„ç†ï¼Œgo-zeroä¸­æœ‰go-queueï¼Œæ¨èä½¿ç”¨go-queueå»å¤„ç†ï¼Œgo-queueæœ¬èº«ä¹Ÿæ˜¯åŸºäºgo-zeroå¼€å‘çš„ï¼Œå…¶æœ¬èº«æ˜¯æœ‰ä¸¤ç§æ¨¡å¼ dq : ä¾èµ–äºbeanstalkdï¼Œåˆ†å¸ƒå¼ï¼Œå¯å­˜å‚¨ï¼Œå»¶è¿Ÿã€å®šæ—¶è®¾ç½®ï¼Œå…³æœºé‡å¯å¯ä»¥é‡æ–°æ‰§è¡Œï¼Œæ¶ˆæ¯ä¸ä¼šä¸¢å¤±ï¼Œä½¿ç”¨éå¸¸ç®€å•ï¼Œgo-queueä¸­ä½¿ç”¨äº†redis setnxä¿è¯äº†æ¯æ¡æ¶ˆæ¯åªè¢«æ¶ˆè´¹ä¸€æ¬¡ï¼Œä½¿ç”¨åœºæ™¯ä¸»è¦æ˜¯ç”¨æ¥åšæ—¥å¸¸ä»»åŠ¡ä½¿ç”¨ kqï¼šä¾èµ–äºkafkaï¼Œè¿™ä¸ªå°±ä¸å¤šä»‹ç»å•¦ï¼Œå¤§åé¼é¼çš„kafkaï¼Œä½¿ç”¨åœºæ™¯ä¸»è¦æ˜¯åšæ¶ˆæ¯é˜Ÿåˆ— æˆ‘ä»¬ä¸»è¦è¯´ä¸€ä¸‹dqï¼Œkqä½¿ç”¨ä¹Ÿä¸€æ ·çš„ï¼Œåªæ˜¯ä¾èµ–åº•å±‚ä¸åŒï¼Œå¦‚æœæ²¡ä½¿ç”¨è¿‡beanstalkdï¼Œæ²¡æ¥è§¦è¿‡beanstalkdçš„å¯ä»¥å…ˆgoogleä¸€ä¸‹ï¼Œä½¿ç”¨èµ·æ¥è¿˜æ˜¯æŒºå®¹æ˜“çš„ã€‚ etc/job.yaml : é…ç½®æ–‡ä»¶ Name: job Log: ServiceName: job Level: info #dqä¾èµ–Beanstalksã€redis ï¼ŒBeanstalksé…ç½®ã€redisé…ç½® DqConf: Beanstalks: - Endpoint: 127.0.0.1:7771 Tube: tube1 - Endpoint: 127.0.0.1:7772 Tube: tube2 Redis: Host: 127.0.0.1:6379 Type: node Internal/config/config.go ï¼šè§£ædqå¯¹åº”etc/*.yamlé…ç½® /** * @Description é…ç½®æ–‡ä»¶ * @Author Mikael * @Email 13247629622@163.com * @Date 2021/1/18 12:05 * @Version 1.0 **/ package config import ( \"github.com/zeromicro/go-queue/dq\" \"github.com/zeromicro/go-zero/core/service\" ) type Config struct { service.ServiceConf DqConf dq.DqConf } Handler/router.go : è´Ÿè´£æ³¨å†Œå¤šä»»åŠ¡ /** * @Description æ³¨å†Œjob * @Author Mikael * @Email 13247629622@163.com * @Date 2021/1/18 12:05 * @Version 1.0 **/ package handler import ( \"context\" \"github.com/zeromicro/go-zero/core/service\" \"job/internal/logic\" \"job/internal/svc\" ) func RegisterJob(serverCtx *svc.ServiceContext,group *service.ServiceGroup) { group.Add(logic.NewProducerLogic(context.Background(),serverCtx)) group.Add(logic.NewConsumerLogic(context.Background(),serverCtx)) } ProducerLogic: å…¶ä¸­ä¸€ä¸ªjobä¸šåŠ¡é€»è¾‘ /** * @Description ç”Ÿäº§è€…ä»»åŠ¡ * @Author Mikael * @Email 13247629622@163.com * @Date 2021/1/18 12:05 * @Version 1.0 **/ package logic import ( \"context\" \"github.com/zeromicro/go-queue/dq\" \"github.com/zeromicro/go-zero/core/logx\" \"github.com/zeromicro/go-zero/core/threading\" \"job/internal/svc\" \"strconv\" \"time\" ) type Producer struct { ctx context.Context svcCtx *svc.ServiceContext logx.Logger } func NewProducerLogic(ctx context.Context, svcCtx *svc.ServiceContext) *Producer { return &Producer{ ctx: ctx, svcCtx: svcCtx, Logger: logx.WithContext(ctx), } } func (l *Producer)Start() { logx.Infof(\"start Producer \\n\") threading.GoSafe(func() { producer := dq.NewProducer([]dq.Beanstalk{ { Endpoint: \"localhost:7771\", Tube: \"tube1\", }, { Endpoint: \"localhost:7772\", Tube: \"tube2\", }, }) for i := 1000; i å¦å¤–ä¸€ä¸ªJobä¸šåŠ¡é€»è¾‘ /** * @Description æ¶ˆè´¹è€…ä»»åŠ¡ * @Author Mikael * @Email 13247629622@163.com * @Date 2021/1/18 12:05 * @Version 1.0 **/ package logic import ( \"context\" \"github.com/zeromicro/go-zero/core/logx\" \"github.com/zeromicro/go-zero/core/threading\" \"job/internal/svc\" ) type Consumer struct { ctx context.Context svcCtx *svc.ServiceContext logx.Logger } func NewConsumerLogic(ctx context.Context, svcCtx *svc.ServiceContext) *Consumer { return &Consumer{ ctx: ctx, svcCtx: svcCtx, Logger: logx.WithContext(ctx), } } func (l *Consumer)Start() { logx.Infof(\"start consumer \\n\") threading.GoSafe(func() { l.svcCtx.Consumer.Consume(func(body []byte) { logx.Infof(\"consumer job %s \\n\" ,string(body)) }) }) } func (l *Consumer)Stop() { logx.Infof(\"stop consumer \\n\") } svc/servicecontext.go /** * @Description é…ç½® * @Author Mikael * @Email 13247629622@163.com * @Date 2021/1/18 12:05 * @Version 1.0 **/ package svc import ( \"job/internal/config\" \"github.com/zeromicro/go-queue/dq\" ) type ServiceContext struct { Config config.Config Consumer dq.Consumer } func NewServiceContext(c config.Config) *ServiceContext { return &ServiceContext{ Config: c, Consumer: dq.NewConsumer(c.DqConf), } } main.goå¯åŠ¨æ–‡ä»¶ /** * @Description å¯åŠ¨æ–‡ä»¶ * @Author Mikael * @Email 13247629622@163.com * @Date 2021/1/18 12:05 * @Version 1.0 **/ package main import ( \"flag\" \"fmt\" \"github.com/zeromicro/go-zero/core/conf\" \"github.com/zeromicro/go-zero/core/logx\" \"github.com/zeromicro/go-zero/core/service\" \"job/internal/config\" \"job/internal/handler\" \"job/internal/svc\" \"os\" \"os/signal\" \"syscall\" \"time\" ) var configFile = flag.String(\"f\", \"etc/job.yaml\", \"the config file\") func main() { flag.Parse() //é…ç½® var c config.Config conf.MustLoad(*configFile, &c) ctx := svc.NewServiceContext(c) //æ³¨å†Œjob group := service.NewServiceGroup() handler.RegisterJob(ctx,group) //æ•æ‰ä¿¡å· ch := make(chan os.Signal) signal.Notify(ch, syscall.SIGHUP, syscall.SIGQUIT, syscall.SIGTERM, syscall.SIGINT) go func() { for { s := å¸¸è§é—®é¢˜ï¼š ä¸ºä»€ä¹ˆä½¿ç”¨dqï¼Œéœ€è¦ä½¿ç”¨redisï¼Ÿ å› ä¸ºbeanstalkæ˜¯å•ç‚¹æœåŠ¡ï¼Œæ— æ³•ä¿è¯é«˜å¯ç”¨ã€‚dqå¯ä»¥ä½¿ç”¨å¤šä¸ªå•ç‚¹beanstalkæœåŠ¡ï¼Œäº’ç›¸å¤‡ä»½ & ä¿è¯é«˜å¯ç”¨ã€‚ä½¿ç”¨redisè§£å†³é‡å¤æ¶ˆè´¹é—®é¢˜ã€‚ Copyright Â© 2019-2021 go-zero all right reservedï¼Œpowered by GitbookLast UpdateTimeï¼š 2025-05-05 05:44:52 "},"datacenter.html":{"url":"datacenter.html","title":"æˆ‘æ˜¯å¦‚ä½•ç”¨go-zero å®ç°ä¸€ä¸ªä¸­å°ç³»ç»Ÿ","keywords":"","body":"æˆ‘æ˜¯å¦‚ä½•ç”¨ go-zero å®ç°ä¸€ä¸ªä¸­å°ç³»ç»Ÿ ä½œè€…ï¼šJack Luo åŸæ–‡è¿æ¥ï¼šhttps://www.cnblogs.com/jackluo/p/14148518.html [TOC] æœ€è¿‘å‘ç°golangç¤¾åŒºé‡Œå‡ºäº†ä¸€ä¸ªæ–°æ˜Ÿçš„å¾®æœåŠ¡æ¡†æ¶ï¼Œæ¥è‡ªå¥½æœªæ¥ï¼Œå…‰çœ‹è¿™ä¸ªåå­—ï¼Œå°±å¾ˆæœ‰å¥”å¤´ï¼Œä¹‹å‰ï¼Œä¹Ÿåªæ˜¯ç©è¿‡go-microï¼Œå…¶å®çœŸæ­£çš„è¿˜æ²¡æœ‰åœ¨é¡¹ç›®ä¸­è¿ç”¨è¿‡ï¼Œåªæ˜¯è§‰å¾— å¾®æœåŠ¡ï¼Œgrpc è¿™äº›å¾ˆé«˜å¤§å°šï¼Œè¿˜æ²¡æœ‰åœ¨é¡¹ç›®ä¸­ï¼ŒçœŸæ­£çš„ç©è¿‡ï¼Œæˆ‘çœ‹äº†ä¸€ä¸‹å®˜æ–¹æä¾›çš„å·¥å…·çœŸçš„å¾ˆå¥½ç”¨ï¼Œåªéœ€è¦å®šä¹‰å¥½ï¼Œèˆ’é€‚æ–‡ä»¶jiaç»“æ„ éƒ½ç”Ÿæˆäº†ï¼Œåªéœ€è¦å…³å¿ƒä¸šåŠ¡ï¼ŒåŠ ä¸Šæœ€è¿‘ æœ‰ä¸ªæŠ•ç¥¨çš„æ´»åŠ¨ï¼ŒåŠ ä¸Šæœ€è¿‘è¿™å‡ å¹´ä¸­å°ä¹Ÿæ¯”è¾ƒç«ï¼Œæ‰€ä»¥å†³å®šç©ä¸€ä¸‹ï¼Œ å¼€æºåœ°å€: https://github.com/jackluo2012/datacenter å…ˆèŠèŠä¸­å°æ¶æ„æ€è·¯å§ï¼š ä¸­å°çš„æ¦‚å¿µå¤§æ¦‚å°±æ˜¯æŠŠä¸€ä¸ªä¸€ä¸ªçš„app ç»Ÿä¸€èµ·æ¥ï¼Œåæ­£æˆ‘æ˜¯è¿™æ ·ç†è§£çš„ã€‚ å…ˆèŠç”¨æˆ·æœåŠ¡å§ï¼Œç°åœ¨ä¸€ä¸ªå…¬å¸æœ‰å¾ˆå¤šçš„å…¬ä¼—å·ã€å°ç¨‹åºã€å¾®ä¿¡çš„ã€æ”¯ä»˜å®çš„ï¼Œè¿˜æœ‰ xxx xxxï¼Œå¾ˆå¤šçš„å¹³å°ï¼Œæ¯æ¬¡å¼€å‘çš„æ—¶å€™ï¼Œæˆ‘ä»¬æ€»æ˜¯éœ€è¦åšç”¨æˆ·ç™»é™†çš„æœåŠ¡ï¼Œä¸åœçš„å¤åˆ¶ä»£ç ï¼Œç„¶åæˆ‘ä»¬å°±åœ¨æ€è€ƒèƒ½ä¸èƒ½æœ‰ä¸€å¥—ç‹¬ç«‹çš„ç”¨æˆ·æœåŠ¡ï¼Œåªéœ€è¦å‘Šè¯‰æˆ‘ä½ éœ€è¦ä¼ ä¸ªä½ è¦ç™»é™†çš„å¹³å°(æ¯”å¦‚å¾®ä¿¡)ï¼Œå¾®ä¿¡ç™»é™†ï¼Œéœ€è¦çš„æ˜¯å®¢æˆ·ç«¯è¿”å›ç»™æœåŠ¡ç«¯ä¸€ä¸ªcode ï¼Œç„¶åæœåŠ¡ç«¯æ‹¿ç€è¿™ä¸ªcodeå»å¾®ä¿¡è·å–ç”¨æˆ·ä¿¡æ¯ï¼Œåæ­£å¤§å®¶éƒ½æ˜ç™½ã€‚ æˆ‘ä»¬å†³å®šï¼Œå°†æ‰€æœ‰çš„ä¿¡æ¯å¼„åˆ°é…ç½®å…¬å…±æœåŠ¡ä¸­å»ï¼Œé‡Œé¢å†å­˜å¾®ä¿¡ã€æ”¯ä»˜å®ä»¥åŠå…¶å®ƒå¹³å°çš„appidã€appkeyã€è¿˜æœ‰æ”¯ä»˜çš„appidã€appkeyï¼Œè¿™æ ·å°±å†™ä¸€å¥—ã€‚ æœ€åè¯´è¯´å®ç°å§ï¼Œæ•´ä¸ªå°±ä¸€ä¸ªrepoï¼š ç½‘å…³ï¼Œæˆ‘ä»¬ç”¨çš„æ˜¯: go-zeroçš„ApiæœåŠ¡ å…¶å®ƒå®ƒçš„æ˜¯æœåŠ¡ï¼Œæˆ‘ä»¬å°±æ˜¯ç”¨çš„go-zeroçš„rpcæœåŠ¡ çœ‹ä¸‹ç›®å½•ç»“æ„ æ•´ä¸ªé¡¹ç›®å®Œæˆï¼Œæˆ‘ä¸€ä¸ªäººæ“åˆ€ï¼Œå†™äº†1ä¸ªæ¥æ˜ŸæœŸï¼Œæˆ‘å°±å®ç°äº†ä¸Šé¢çš„ä¸­å°ç³»ç»Ÿã€‚ datacenter-apiæœåŠ¡ å…ˆçœ‹å®˜æ–¹æ–‡æ¡£ https://go-zero.dev/cn/ æˆ‘ä»¬å…ˆæŠŠç½‘å…³æ­å»ºèµ·æ¥ï¼š âœ blogs mkdir datacenter && cd datacenter âœ datacenter go mod init datacenter go: creating new go.mod: module datacenter âœ datacenter æŸ¥çœ‹bookç›®å½•ï¼š âœ datacenter tree . â””â”€â”€ go.mod 0 directories, 1 file åˆ›å»ºapiæ–‡ä»¶ âœ datacenter goctl api -o datacenter.api Done. âœ datacenter tree . â”œâ”€â”€ datacenter.api â”œâ”€â”€ user.api #ç”¨æˆ· â”œâ”€â”€ votes.api #æŠ•ç¥¨ â”œâ”€â”€ search.api #æœç´¢ â”œâ”€â”€ questions.api #é—®ç­” â””â”€â”€ go.mod å®šä¹‰apiæœåŠ¡ åˆ†åˆ«åŒ…å«äº†ä¸Šé¢çš„ å…¬å…±æœåŠ¡ï¼Œç”¨æˆ·æœåŠ¡ï¼ŒæŠ•ç¥¨æ´»åŠ¨æœåŠ¡ datacenter.apiçš„å†…å®¹: info( title: \"ä¸­å°ç³»ç»Ÿ\"// TODO: add title desc: \"ä¸­å°ç³»ç»Ÿ\"// TODO: add description author: \"jackluo\" email: \"net.webjoy@gmail.com\" ) import \"user.api\" import \"votes.api\" import \"search.api\" import \"questions.api\" //è·å– åº”ç”¨ä¿¡æ¯ type Beid { Beid int64 `json:\"beid\"` } type Token { Token string `json:\"token\"` } type WxTicket { Ticket string `json:\"ticket\"` } type Application { Sname string `json:\"Sname\"` //åç§° Logo string `json:\"logo\"` // login Isclose int64 `json:\"isclose\"` //æ˜¯å¦å…³é—­ Fullwebsite string `json:\"fullwebsite\"` // å…¨ç«™åç§° } type SnsReq { Beid Ptyid int64 `json:\"ptyid\"` //å¯¹åº”å¹³å° BackUrl string `json:\"back_url\"` //ç™»é™†è¿”å›çš„åœ°å€ } type SnsResp { Beid Ptyid int64 `json:\"ptyid\"` //å¯¹åº”å¹³å° Appid string `json:\"appid\"` //sns å¹³å°çš„id Title string `json:\"title\"` //åç§° LoginUrl string `json:\"login_url\"` //å¾®ä¿¡ç™»é™†çš„åœ°å€ } type WxShareResp { Appid string `json:\"appid\"` Timestamp int64 `json:\"timestamp\"` Noncestr string `json:\"noncestr\"` Signature string `json:\"signature\"` } @server( group: common ) service datacenter-api { @doc( summary: \"è·å–ç«™ç‚¹çš„ä¿¡æ¯\" ) @handler appInfo get /common/appinfo (Beid) returns (Application) @doc( summary: \"è·å–ç«™ç‚¹çš„ç¤¾äº¤å±æ€§ä¿¡æ¯\" ) @handler snsInfo post /common/snsinfo (SnsReq) returns (SnsResp) //è·å–åˆ†äº«çš„ @handler wxTicket post /common/wx/ticket (SnsReq) returns (WxShareResp) } //ä¸Šä¼ éœ€è¦ç™»é™† @server( jwt: Auth group: common ) service datacenter-api { @doc( summary: \"ä¸ƒç‰›ä¸Šä¼ å‡­è¯\" ) @handler qiuniuToken post /common/qiuniu/token (Beid) returns (Token) } user.apiå†…å®¹ //æ³¨å†Œè¯·æ±‚ type RegisterReq struct { // TODO: add members here and delete this comment Mobile string `json:\"mobile\"` //åŸºæœ¬ä¸€ä¸ªæ‰‹æœºå·ç å°±å®Œäº‹ Password string `json:\"password\"` Smscode string `json:\"smscode\"` //çŸ­ä¿¡ç  } //ç™»é™†è¯·æ±‚ type LoginReq struct{ Mobile string `json:\"mobile\"` Type int64 `json:\"type\"` //1.å¯†ç ç™»é™†ï¼Œ2.çŸ­ä¿¡ç™»é™† Password string `json:\"password\"` } //å¾®ä¿¡ç™»é™† type WxLoginReq struct { Beid int64 `json:\"beid\"` //åº”ç”¨id Code string `json:\"code\"` //å¾®ä¿¡ç™»é™†å¯†é’¥ Ptyid int64 `json:\"ptyid\"` //å¯¹åº”å¹³å° } //è¿”å›ç”¨æˆ·ä¿¡æ¯ type UserReply struct { Auid int64 `json:\"auid\"` Uid int64 `json:\"uid\"` Beid int64 `json:\"beid\"` //åº”ç”¨id Ptyid int64 `json:\"ptyid\"` //å¯¹åº”å¹³å° Username string `json:\"username\"` Mobile string `json:\"mobile\"` Nickname string `json:\"nickname\"` Openid string `json:\"openid\"` Avator string `json:\"avator\"` JwtToken } //è¿”å›APPUser type AppUser struct{ Uid int64 `json:\"uid\"` Auid int64 `json:\"auid\"` Beid int64 `json:\"beid\"` //åº”ç”¨id Ptyid int64 `json:\"ptyid\"` //å¯¹åº”å¹³å° Nickname string `json:\"nickname\"` Openid string `json:\"openid\"` Avator string `json:\"avator\"` } type LoginAppUser struct{ Uid int64 `json:\"uid\"` Auid int64 `json:\"auid\"` Beid int64 `json:\"beid\"` //åº”ç”¨id Ptyid int64 `json:\"ptyid\"` //å¯¹åº”å¹³å° Nickname string `json:\"nickname\"` Openid string `json:\"openid\"` Avator string `json:\"avator\"` JwtToken } type JwtToken struct { AccessToken string `json:\"access_token,omitempty\"` AccessExpire int64 `json:\"access_expire,omitempty\"` RefreshAfter int64 `json:\"refresh_after,omitempty\"` } type UserReq struct{ Auid int64 `json:\"auid\"` Uid int64 `json:\"uid\"` Beid int64 `json:\"beid\"` //åº”ç”¨id Ptyid int64 `json:\"ptyid\"` //å¯¹åº”å¹³å° } type Request { Name string `path:\"name,options=you|me\"` } type Response { Message string `json:\"message\"` } @server( group: user ) service datacenter-api { @handler ping post /user/ping () @handler register post /user/register (RegisterReq) returns (UserReply) @handler login post /user/login (LoginReq) returns (UserReply) @handler wxlogin post /user/wx/login (WxLoginReq) returns (LoginAppUser) @handler code2Session get /user/wx/login () returns (LoginAppUser) } @server( jwt: Auth group: user middleware: Usercheck ) service datacenter-api { @handler userInfo get /user/dc/info (UserReq) returns (UserReply) } votes.api æŠ•ç¥¨å†…å®¹ // æŠ•ç¥¨æ´»åŠ¨api type Actid struct { Actid int64 `json:\"actid\"` //æ´»åŠ¨id } type VoteReq struct { Aeid int64 `json:\"aeid\"` // ä½œå“id Actid } type VoteResp struct { VoteReq Votecount int64 `json:\"votecount\"` //æŠ•ç¥¨ç¥¨æ•° Viewcount int64 `json:\"viewcount\"` //æµè§ˆæ•° } // æ´»åŠ¨è¿”å›çš„å‚æ•° type ActivityResp struct { Actid int64 `json:\"actid\"` Title string `json:\"title\"` //æ´»åŠ¨åç§° Descr string `json:\"descr\"` //æ´»åŠ¨æè¿° StartDate int64 `json:\"start_date\"` //æ´»åŠ¨æ—¶é—´ EnrollDate int64 `json:\"enroll_date\"` //æŠ•ç¥¨æ—¶é—´ EndDate int64 `json:\"end_date\"` //æ´»åŠ¨ç»“æŸæ—¶é—´ Votecount int64 `json:\"votecount\"` //å½“å‰æ´»åŠ¨çš„æ€»ç¥¨æ•° Viewcount int64 `json:\"viewcount\"` //å½“å‰æ´»åŠ¨çš„æ€»æµè§ˆæ•° Type int64 `json:\"type\"` //æŠ•ç¥¨æ–¹å¼ Num int64 `json:\"num\"` //æŠ•ç¥¨å‡ ç¥¨ } //æŠ¥å type EnrollReq struct { Actid Name string `json:\"name\"` // åç§° Address string `json:\"address\"` //åœ°å€ Images []string `json:\"images\"` //ä½œå“å›¾ç‰‡ Descr string `json:\"descr\"` // ä½œå“æè¿° } // ä½œå“è¿”å› type EnrollResp struct { Actid Aeid int64 `json:\"aeid\"` // ä½œå“id Name string `json:\"name\"` // åç§° Address string `json:\"address\"` //åœ°å€ Images []string `json:\"images\"` //ä½œå“å›¾ç‰‡ Descr string `json:\"descr\"` // ä½œå“æè¿° Votecount int64 `json:\"votecount\"` //å½“å‰æ´»åŠ¨çš„æ€»ç¥¨æ•° Viewcount int64 `json:\"viewcount\"` //å½“å‰æ´»åŠ¨çš„æ€»æµè§ˆæ•° } @server( group: votes ) service datacenter-api { @doc( summary: \"è·å–æ´»åŠ¨çš„ä¿¡æ¯\" ) @handler activityInfo get /votes/activity/info (Actid) returns (ActivityResp) @doc( summary: \"æ´»åŠ¨è®¿é—®+1\" ) @handler activityIcrView get /votes/activity/view (Actid) returns (ActivityResp) @doc( summary: \"è·å–æŠ¥åçš„æŠ•ç¥¨ä½œå“ä¿¡æ¯\" ) @handler enrollInfo get /votes/enroll/info (VoteReq) returns (EnrollResp) @doc( summary: \"è·å–æŠ¥åçš„æŠ•ç¥¨ä½œå“åˆ—è¡¨\" ) @handler enrollLists get /votes/enroll/lists (Actid) returns(EnrollResp) } @server( jwt: Auth group: votes middleware: Usercheck ) service datacenter-api { @doc( summary: \"æŠ•ç¥¨\" ) @handler vote post /votes/vote (VoteReq) returns (VoteResp) @handler enroll post /votes/enroll (EnrollReq) returns (EnrollResp) } questions.api é—®ç­”å†…å®¹: // é—®ç­” æŠ½å¥– å¼€å§‹ @server( group: questions ) service datacenter-api { @doc( summary: \"è·å–æ´»åŠ¨çš„ä¿¡æ¯\" ) @handler activitiesInfo get /questions/activities/info (Actid) returns (ActivityResp) @doc( summary: \"è·å–å¥–å“ä¿¡æ¯\" ) @handler awardInfo get /questions/award/info (Actid) returns (ActivityResp) @handler awardList get /questions/award/list (Actid) returns (ActivityResp) } type AnswerReq struct { ActivityId int64 `json:\"actid\"` Answers string `json:\"answers\"` Score string `json:\"score\"` } type QuestionsAwardReq struct { ActivityId int64 `json:\"actid\"` AnswerId int64 `json:\"answerid\"` } type AnswerResp struct { Answers string `json:\"answers\"` Score string `json:\"score\"` } type AwardConvertReq struct { UserName string `json:\"username\"` Phone string `json:\"phone\"` LotteryId int64 `json:\"lotteryid\"` } @server( jwt: Auth group: questions middleware: Usercheck ) service datacenter-api { @doc( summary: \"è·å–é¢˜ç›®\" ) @handler lists get /questions/lists (VoteReq) returns (AnswerResp) @doc( summary: \"æäº¤ç­”æ¡ˆ\" ) @handler change post /questions/change (AnswerReq) returns (VoteResp) @doc( summary: \"è·å–åˆ†æ•°\" ) @handler grade get /questions/grade (VoteReq) returns (VoteResp) @doc( summary: \"å¼€å§‹è½¬ç›˜\" ) @handler turntable post /questions/lottery/turntable (EnrollReq) returns (EnrollResp) @doc( summary: \"å¡«å†™ä¸­å¥–ä¿¡æ¯äºº\" ) @handler lottery post /questions/lottery/convert (AwardConvertReq) returns (EnrollResp) } // é—®ç­” æŠ½å¥– ç»“æŸ search.api æœç´¢ type SearchReq struct { Keyword string `json:\"keyword\"` Page string `json:\"page\"` Size string `json:\"size\"` } type SearchResp struct { Data []ArticleReq `json:\"data\"` } type ArticleReq struct{ NewsId string `json:\"NewsId\"` NewsTitle string `json:\"NewsTitle\"` ImageUrl string `json:\"ImageUrl\"` } @server( group: search middleware: Admincheck ) service datacenter-api { @doc( summary: \"æœç´¢\" ) @handler article get /search/article (SearchReq) returns (SearchResp) @handler articleInit get /search/articel/init (SearchReq) returns (SearchResp) @handler articleStore post /search/articel/store (ArticleReq) returns (ArticleReq) } ä¸Šé¢åŸºæœ¬ä¸Šå†™å°±å†™çš„APIåŠæ–‡æ¡£çš„æ€è·¯ ç”Ÿæˆdatacenter apiæœåŠ¡ âœ datacenter goctl api go -api datacenter.api -dir . Done. âœ datacenter treer . â”œâ”€â”€ datacenter.api â”œâ”€â”€ etc â”‚ â””â”€â”€ datacenter-api.yaml â”œâ”€â”€ go.mod â”œâ”€â”€ internal â”‚ â”œâ”€â”€ config â”‚ â”‚ â””â”€â”€ config.go â”‚ â”œâ”€â”€ handler â”‚ â”‚ â”œâ”€â”€ common â”‚ â”‚ â”‚ â”œâ”€â”€ appinfohandler.go â”‚ â”‚ â”‚ â”œâ”€â”€ qiuniutokenhandler.go â”‚ â”‚ â”‚ â”œâ”€â”€ snsinfohandler.go â”‚ â”‚ â”‚ â”œâ”€â”€ votesverificationhandler.go â”‚ â”‚ â”‚ â””â”€â”€ wxtickethandler.go â”‚ â”‚ â”œâ”€â”€ routes.go â”‚ â”‚ â”œâ”€â”€ user â”‚ â”‚ â”‚ â”œâ”€â”€ code2sessionhandler.go â”‚ â”‚ â”‚ â”œâ”€â”€ loginhandler.go â”‚ â”‚ â”‚ â”œâ”€â”€ pinghandler.go â”‚ â”‚ â”‚ â”œâ”€â”€ registerhandler.go â”‚ â”‚ â”‚ â”œâ”€â”€ userinfohandler.go â”‚ â”‚ â”‚ â””â”€â”€ wxloginhandler.go â”‚ â”‚ â””â”€â”€ votes â”‚ â”‚ â”œâ”€â”€ activityicrviewhandler.go â”‚ â”‚ â”œâ”€â”€ activityinfohandler.go â”‚ â”‚ â”œâ”€â”€ enrollhandler.go â”‚ â”‚ â”œâ”€â”€ enrollinfohandler.go â”‚ â”‚ â”œâ”€â”€ enrolllistshandler.go â”‚ â”‚ â””â”€â”€ votehandler.go â”‚ â”œâ”€â”€ logic â”‚ â”‚ â”œâ”€â”€ common â”‚ â”‚ â”‚ â”œâ”€â”€ appinfologic.go â”‚ â”‚ â”‚ â”œâ”€â”€ qiuniutokenlogic.go â”‚ â”‚ â”‚ â”œâ”€â”€ snsinfologic.go â”‚ â”‚ â”‚ â”œâ”€â”€ votesverificationlogic.go â”‚ â”‚ â”‚ â””â”€â”€ wxticketlogic.go â”‚ â”‚ â”œâ”€â”€ user â”‚ â”‚ â”‚ â”œâ”€â”€ code2sessionlogic.go â”‚ â”‚ â”‚ â”œâ”€â”€ loginlogic.go â”‚ â”‚ â”‚ â”œâ”€â”€ pinglogic.go â”‚ â”‚ â”‚ â”œâ”€â”€ registerlogic.go â”‚ â”‚ â”‚ â”œâ”€â”€ userinfologic.go â”‚ â”‚ â”‚ â””â”€â”€ wxloginlogic.go â”‚ â”‚ â””â”€â”€ votes â”‚ â”‚ â”œâ”€â”€ activityicrviewlogic.go â”‚ â”‚ â”œâ”€â”€ activityinfologic.go â”‚ â”‚ â”œâ”€â”€ enrollinfologic.go â”‚ â”‚ â”œâ”€â”€ enrolllistslogic.go â”‚ â”‚ â”œâ”€â”€ enrolllogic.go â”‚ â”‚ â””â”€â”€ votelogic.go â”‚ â”œâ”€â”€ middleware â”‚ â”‚ â””â”€â”€ usercheckmiddleware.go â”‚ â”œâ”€â”€ svc â”‚ â”‚ â””â”€â”€ servicecontext.go â”‚ â””â”€â”€ types â”‚ â””â”€â”€ types.go â””â”€â”€ datacenter.go 14 directories, 43 files æˆ‘ä»¬æ‰“å¼€ etc/datacenter-api.yaml æŠŠå¿…è¦çš„é…ç½®ä¿¡æ¯åŠ ä¸Š Name: datacenter-api Log: Mode: console Host: 0.0.0.0 Port: 8857 Auth: AccessSecret: ä½ çš„jwtwon Secret AccessExpire: 86400 CacheRedis: - Host: 127.0.0.1:6379 Pass: å¯†ç  Type: node UserRpc: Etcd: Hosts: - 127.0.0.1:2379 Key: user.rpc CommonRpc: Etcd: Hosts: - 127.0.0.1:2379 Key: common.rpc VotesRpc: Etcd: Hosts: - 127.0.0.1:2379 Key: votes.rpc ä¸Šé¢çš„ UserRpcï¼Œ CommonRpc ,è¿˜æœ‰ VotesRpc è¿™äº›æˆ‘å…ˆå†™ä¸Šï¼Œåé¢å†æ¥æ…¢æ…¢åŠ ã€‚ æˆ‘ä»¬å…ˆæ¥å†™ CommonRpc æœåŠ¡ã€‚ CommonRpcæœåŠ¡ æ–°å»ºé¡¹ç›®ç›®å½• âœ datacenter mkdir -p common/rpc && cd common/rpc ç›´æ¥å°±æ–°å»ºåœ¨äº†ï¼Œdatacenterç›®å½•ä¸­ï¼Œå› ä¸ºcommon é‡Œé¢ï¼Œå¯èƒ½ä»¥åä¼šä¸åªä¼šæä¾›rpcæœåŠ¡ï¼Œå¯èƒ½è¿˜æœ‰apiçš„æœåŠ¡,æ‰€ä»¥åˆåŠ äº†rpcç›®å½• goctlåˆ›å»ºæ¨¡æ¿ âœ rpc goctl rpc template -o=common.proto âœ rpc ls common.proto å¾€é‡Œé¢å¡«å…¥å†…å®¹ï¼š âœ rpc cat common.proto syntax = \"proto3\"; option go_package = \"common\"; package common; message BaseAppReq{ int64 beid=1; } message BaseAppResp{ int64 beid=1; string logo=2; string sname=3; int64 isclose=4; string fullwebsite=5; } // è¯·æ±‚çš„api message AppConfigReq { int64 beid=1; int64 ptyid=2; } // è¿”å›çš„å€¼ message AppConfigResp { int64 id=1; int64 beid=2; int64 ptyid=3; string appid=4; string appsecret=5; string title=6; } service Common { rpc GetAppConfig(AppConfigReq) returns(AppConfigResp); rpc GetBaseApp(BaseAppReq) returns(BaseAppResp); } gotclç”ŸæˆrpcæœåŠ¡ âœ rpc goctl rpc proto -src common.proto -dir . protoc -I=/Users/jackluo/works/blogs/datacenter/common/rpc common.proto --go_out=plugins=grpc:/Users/jackluo/works/blogs/datacenter/common/rpc/common Done. âœ rpc tree . â”œâ”€â”€ common â”‚ â””â”€â”€ common.pb.go â”œâ”€â”€ common.go â”œâ”€â”€ common.proto â”œâ”€â”€ commonclient â”‚ â””â”€â”€ common.go â”œâ”€â”€ etc â”‚ â””â”€â”€ common.yaml â””â”€â”€ internal â”œâ”€â”€ config â”‚ â””â”€â”€ config.go â”œâ”€â”€ logic â”‚ â”œâ”€â”€ getappconfiglogic.go â”‚ â””â”€â”€ getbaseapplogic.go â”œâ”€â”€ server â”‚ â””â”€â”€ commonserver.go â””â”€â”€ svc â””â”€â”€ servicecontext.go 8 directories, 10 files åŸºæœ¬ä¸Šï¼Œå°±æŠŠæ‰€æœ‰çš„ç›®å½•è§„èŒƒå’Œç»“æ„çš„ä¸œè¥¿éƒ½ç”Ÿæˆäº†ï¼Œå°±ä¸ç”¨çº ç»“é¡¹ç›®ç›®å½•äº†ï¼Œæ€ä¹ˆæ”¾äº†ï¼Œæ€ä¹ˆç»„ç»‡äº†ã€‚ çœ‹ä¸€ä¸‹ï¼Œé…ç½®ä¿¡æ¯ï¼Œé‡Œé¢å¯ä»¥å†™å…¥mysqlå’Œå…¶å®ƒredisçš„ä¿¡æ¯ï¼š Name: common.rpc ListenOn: 127.0.0.1:8081 Mysql: DataSource: root:admin@tcp(127.0.0.1:3306)/datacenter?charset=utf8&parseTime=true&loc=Asia%2FShanghai CacheRedis: - Host: 127.0.0.1:6379 Pass: Type: node Etcd: Hosts: - 127.0.0.1:2379 Key: common.rpc æˆ‘ä»¬å†æ¥åŠ ä¸Šæ•°æ®åº“æœåŠ¡ï¼š âœ rpc cd .. âœ common ls rpc âœ common pwd /Users/jackluo/works/blogs/datacenter/common âœ common goctl model mysql datasource -url=\"root:admin@tcp(127.0.0.1:3306)/datacenter\" -table=\"base_app\" -dir ./model -c Done. âœ common tree . â”œâ”€â”€ model â”‚ â”œâ”€â”€ baseappmodel.go â”‚ â””â”€â”€ vars.go â””â”€â”€ rpc â”œâ”€â”€ common â”‚ â””â”€â”€ common.pb.go â”œâ”€â”€ common.go â”œâ”€â”€ common.proto â”œâ”€â”€ commonclient â”‚ â””â”€â”€ common.go â”œâ”€â”€ etc â”‚ â””â”€â”€ common.yaml â””â”€â”€ internal â”œâ”€â”€ config â”‚ â””â”€â”€ config.go â”œâ”€â”€ logic â”‚ â”œâ”€â”€ getappconfiglogic.go â”‚ â””â”€â”€ getbaseapplogic.go â”œâ”€â”€ server â”‚ â””â”€â”€ commonserver.go â””â”€â”€ svc â””â”€â”€ servicecontext.go 10 directories, 12 files è¿™æ ·åŸºæœ¬çš„ä¸€ä¸ª rpc å°±å†™å®Œäº†ï¼Œç„¶åæˆ‘ä»¬å°†rpc å’Œmodel è¿˜æœ‰apiä¸²è¿èµ·æ¥ï¼Œè¿™ä¸ªå®˜æ–¹çš„æ–‡æ¡£å·²ç»å¾ˆè¯¦ç»†äº†ï¼Œè¿™é‡Œå°±åªæ˜¯è´´ä¸€ä¸‹ä»£ç ï¼š âœ common cat rpc/internal/config/config.go package config import ( \"github.com/zeromicro/go-zero/core/stores/cache\" \"github.com/zeromicro/go-zero/zrpc\" ) type Config struct { zrpc.RpcServerConf Mysql struct { DataSource string } CacheRedis cache.ClusterConf } å†åœ¨svcä¸­ä¿®æ”¹ï¼š âœ common cat rpc/internal/svc/servicecontext.go package svc import ( \"datacenter/common/model\" \"datacenter/common/rpc/internal/config\" \"github.com/zeromicro/go-zero/core/stores/sqlx\" ) type ServiceContext struct { c config.Config AppConfigModel model.AppConfigModel BaseAppModel model.BaseAppModel } func NewServiceContext(c config.Config) *ServiceContext { conn := sqlx.NewMysql(c.Mysql.DataSource) apm := model.NewAppConfigModel(conn, c.CacheRedis) bam := model.NewBaseAppModel(conn, c.CacheRedis) return &ServiceContext{ c: c, AppConfigModel: apm, BaseAppModel: bam, } } ä¸Šé¢çš„ä»£ç å·²ç»å°† rpc å’Œ model æ•°æ®åº“å…³è”èµ·æ¥äº†ï¼Œæˆ‘ä»¬ç°åœ¨å†å°† rpc å’Œ api å…³è”èµ·æ¥ï¼š âœ datacenter cat internal/config/config.go package config import ( \"github.com/zeromicro/go-zero/core/stores/cache\" \"github.com/zeromicro/go-zero/rest\" \"github.com/zeromicro/go-zero/zrpc\" ) type Config struct { rest.RestConf Auth struct { AccessSecret string AccessExpire int64 } UserRpc zrpc.RpcClientConf CommonRpc zrpc.RpcClientConf VotesRpc zrpc.RpcClientConf CacheRedis cache.ClusterConf } åŠ å…¥ svc æœåŠ¡ä¸­ï¼š âœ datacenter cat internal/svc/servicecontext.go package svc import ( \"context\" \"datacenter/common/rpc/commonclient\" \"datacenter/internal/config\" \"datacenter/internal/middleware\" \"datacenter/shared\" \"datacenter/user/rpc/userclient\" \"datacenter/votes/rpc/votesclient\" \"fmt\" \"net/http\" \"time\" \"github.com/zeromicro/go-zero/core/logx\" \"github.com/zeromicro/go-zero/core/stores/cache\" \"github.com/zeromicro/go-zero/core/stores/redis\" \"github.com/zeromicro/go-zero/core/syncx\" \"github.com/zeromicro/go-zero/rest\" \"github.com/zeromicro/go-zero/zrpc\" \"google.golang.org/grpc\" ) type ServiceContext struct { Config config.Config GreetMiddleware1 rest.Middleware GreetMiddleware2 rest.Middleware Usercheck rest.Middleware UserRpc userclient.User //ç”¨æˆ· CommonRpc commonclient.Common VotesRpc votesclient.Votes Cache cache.Cache RedisConn *redis.Redis } func timeInterceptor(ctx context.Context, method string, req, reply interface{}, cc *grpc.ClientConn, invoker grpc.UnaryInvoker, opts ...grpc.CallOption) error { stime := time.Now() err := invoker(ctx, method, req, reply, cc, opts...) if err != nil { return err } fmt.Printf(\"è°ƒç”¨ %s æ–¹æ³• è€—æ—¶: %v\\n\", method, time.Now().Sub(stime)) return nil } func NewServiceContext(c config.Config) *ServiceContext { ur := userclient.NewUser(zrpc.MustNewClient(c.UserRpc, zrpc.WithUnaryClientInterceptor(timeInterceptor))) cr := commonclient.NewCommon(zrpc.MustNewClient(c.CommonRpc, zrpc.WithUnaryClientInterceptor(timeInterceptor))) vr := votesclient.NewVotes(zrpc.MustNewClient(c.VotesRpc, zrpc.WithUnaryClientInterceptor(timeInterceptor))) //ç¼“å­˜ ca := cache.NewCache(c.CacheRedis, syncx.NewSharedCalls(), cache.NewCacheStat(\"dc\"), shared.ErrNotFound) rcon := redis.NewRedis(c.CacheRedis[0].Host, c.CacheRedis[0].Type, c.CacheRedis[0].Pass) return &ServiceContext{ Config: c, GreetMiddleware1: greetMiddleware1, GreetMiddleware2: greetMiddleware2, Usercheck: middleware.NewUserCheckMiddleware().Handle, UserRpc: ur, CommonRpc: cr, VotesRpc: vr, Cache: ca, RedisConn: rcon, } } è¿™æ ·åŸºæœ¬ä¸Šï¼Œæˆ‘ä»¬å°±å¯ä»¥åœ¨ logic çš„æ–‡ä»¶ç›®å½•ä¸­è°ƒç”¨äº†ï¼š cat internal/logic/common/appinfologic.go package logic import ( \"context\" \"datacenter/internal/svc\" \"datacenter/internal/types\" \"datacenter/shared\" \"datacenter/common/model\" \"datacenter/common/rpc/common\" \"github.com/zeromicro/go-zero/core/logx\" ) type AppInfoLogic struct { logx.Logger ctx context.Context svcCtx *svc.ServiceContext } func NewAppInfoLogic(ctx context.Context, svcCtx *svc.ServiceContext) AppInfoLogic { return AppInfoLogic{ Logger: logx.WithContext(ctx), ctx: ctx, svcCtx: svcCtx, } } func (l *AppInfoLogic) AppInfo(req types.Beid) (appconfig *common.BaseAppResp, err error) { //æ£€æŸ¥ ç¼“å­˜ä¸­æ˜¯å¦æœ‰å€¼ err = l.svcCtx.Cache.GetCache(model.GetcacheBaseAppIdPrefix(req.Beid), appconfig) if err != nil && err == shared.ErrNotFound { appconfig, err = l.svcCtx.CommonRpc.GetBaseApp(l.ctx, &common.BaseAppReq{ Beid: req.Beid, }) if err != nil { return } err = l.svcCtx.Cache.SetCache(model.GetcacheBaseAppIdPrefix(req.Beid), appconfig) } return } è¿™æ ·ï¼ŒåŸºæœ¬å°±è¿æ¥èµ·æ¥äº†ï¼Œå…¶å®ƒåŸºæœ¬ä¸Šå°±ä¸ç”¨æ”¹äº†ï¼ŒUserRPCï¼Œ VotesRPC ç±»ä¼¼ï¼Œè¿™é‡Œå°±ä¸åœ¨å†™äº†ã€‚ ä½¿ç”¨å¿ƒå¾— go-zero çš„ç¡®é¦™ï¼Œå› ä¸ºå®ƒæœ‰ä¸€ä¸ª goctl çš„å·¥å…·ï¼Œä»–å¯ä»¥è‡ªåŠ¨çš„æŠŠä»£ç ç»“æ„å…¨éƒ¨çš„ç”Ÿæˆå¥½ï¼Œæˆ‘ä»¬å°±ä¸å†å»çº ç»“ï¼Œç›®å½•ç»“æ„ ï¼Œæ€ä¹ˆç»„ç»‡ï¼Œæ²¡æœ‰ä¸ªå¥½å‡ å¹´çš„æ¶æ„èƒ½åŠ›æ˜¯ä¸å¥½å®ç°çš„ï¼Œæœ‰ä»€ä¹ˆè§„èŒƒé‚£äº›ï¼Œå¹¶å‘ï¼Œç†”æ–­ï¼Œå®Œå…¨ä¸ç”¨ï¼Œè€ƒè™‘å…¶å®ƒçš„ï¼Œä¸“å¿ƒçš„å®ç°ä¸šåŠ¡å°±å¥½ï¼Œåƒå¾®æœåŠ¡ï¼Œè¿˜è¦æœ‰æœåŠ¡å‘ç°ï¼Œä¸€ç³»åˆ—çš„ä¸œè¥¿ï¼Œéƒ½ä¸ç”¨å…³å¿ƒï¼Œå› ä¸º go-zero å†…éƒ¨å·²ç»å®ç°äº†ã€‚ æˆ‘å†™ä»£ç ä¹Ÿå†™äº†æœ‰10å¤šå¹´äº†ï¼Œä¹‹å‰ä¸€ç›´ç”¨çš„ phpï¼Œæ¯”è¾ƒå‡ºåçš„å°± laravelï¼Œthinkphpï¼ŒåŸºæœ¬ä¸Šå°±æ˜¯æ¨¡å—åŒ–çš„ï¼Œåƒå¾®æœåŠ¡é‚£äº›å®ç°çœŸçš„æœ‰æˆæœ¬ï¼Œä½†æ˜¯ä½ ç”¨ä¸Šgo-zeroï¼Œä½ å°±åƒè°ƒapiæ¥å£ä¸€æ ·ç®€å•çš„å¼€å‘ï¼Œå…¶å®ƒä»€ä¹ˆæœåŠ¡å‘ç°ï¼Œé‚£äº›æ ¹æœ¬å°±ä¸ç”¨å…³æ³¨äº†ï¼Œåªéœ€è¦å…³æ³¨ä¸šåŠ¡ã€‚ ä¸€ä¸ªå¥½çš„è¯­è¨€ï¼Œæ¡†æ¶ï¼Œä»–ä»¬çš„åº•å±‚æ€ç»´ï¼Œæ°¸è¿œéƒ½æ˜¯æ•ˆç‡é«˜ï¼Œä¸åŠ ç­çš„æ€æƒ³ï¼Œæˆ‘ç›¸ä¿¡go-zeroä¼šæé«˜ä½ å’Œä½ å›¢é˜Ÿæˆ–æ˜¯å…¬å¸çš„æ•ˆç‡ã€‚go-zeroçš„ä½œè€…è¯´ï¼Œä»–ä»¬æœ‰ä¸ªå›¢é˜Ÿä¸“é—¨æ•´ç†go-zeroæ¡†æ¶ï¼Œç›®çš„ä¹Ÿåº”è¯¥å¾ˆæ˜æ˜¾ï¼Œé‚£å°±æ˜¯æé«˜ï¼Œä»–ä»¬è‡ªå·±çš„å¼€å‘æ•ˆç‡ï¼Œæµç¨‹åŒ–ï¼Œæ ‡å‡†åŒ–ï¼Œæ˜¯æé«˜å·¥ä½œæ•ˆç‡çš„å‡†åˆ™ï¼Œåƒæˆ‘ä»¬å¹³æ—¶é‡åˆ°äº†é—®é¢˜ï¼Œæˆ–æ˜¯é‡åˆ°äº†bugï¼Œæˆ‘ç¬¬ä¸€ä¸ªæƒ³åˆ°çš„ä¸æ˜¯æ€ä¹ˆå»è§£å†³æˆ‘çš„bugï¼Œè€Œæ˜¯åœ¨æƒ³æˆ‘çš„æµç¨‹æ˜¯ä¸æ˜¯æœ‰é—®é¢˜ï¼Œæˆ‘çš„å“ªä¸ªæµç¨‹ä¼šå¯¼è‡´bugï¼Œæœ€åæˆ‘ç›¸ä¿¡ go-zero èƒ½æˆä¸º å¾®æœåŠ¡å¼€å‘ çš„é¦–é€‰æ¡†æ¶ã€‚ æœ€åè¯´è¯´é‡åˆ°çš„å‘å§ï¼š grpc grpc æœ¬äººç¬¬ä¸€æ¬¡ç”¨ï¼Œç„¶åå°±é‡åˆ°äº†ï¼Œæœ‰äº›å­—ç¬¦ä¸ºç©ºæ—¶ï¼Œå­—æ®µå€¼ä¸æ˜¾ç¤ºçš„é—®é¢˜ï¼š é€šè¿‡ grpc å®˜æ–¹åº“ä¸­çš„ jsonpb æ¥å®ç°ï¼Œå®˜æ–¹åœ¨å®ƒçš„è®¾å®šä¸­æœ‰ä¸€ä¸ªç»“æ„ä½“ç”¨æ¥å®ç° protoc buffer è½¬æ¢ä¸ºJSONç»“æ„ï¼Œå¹¶å¯ä»¥æ ¹æ®å­—æ®µæ¥é…ç½®è½¬æ¢çš„è¦æ±‚ã€‚ è·¨åŸŸé—®é¢˜ go-zero ä¸­è®¾ç½®äº†ï¼Œæ„Ÿè§‰æ²¡æœ‰æ•ˆæœï¼Œå¤§ä½¬è¯´é€šè¿‡nginx è®¾ç½®ï¼Œåé¢å‘ç°è¿˜æ˜¯ä¸è¡Œï¼Œæœ€è¿‘å¼ºè¡Œå¼„åˆ°äº†ä¸€ä¸ªåŸŸåä¸‹ï¼Œåé¢æœ‰æ—¶é—´å†è§£å†³ã€‚ sqlx go-zero çš„ sqlx é—®é¢˜ï¼Œè¿™ä¸ªçœŸçš„è´¹äº†å¾ˆé•¿çš„æ—¶é—´ï¼š time.Time è¿™ä¸ªæ•°æ®ç»“æ„ï¼Œæ•°æ®åº“ä¸­ç”¨çš„æ˜¯ timestamp è¿™ä¸ª æ¯”å¦‚æˆ‘çš„å­—æ®µ æ˜¯delete_at é»˜è®¤æ•°åº“è®¾ç½®çš„æ˜¯null ï¼Œç»“æœæ’å…¥çš„æ—¶å€™ï¼Œå°±æŠ¥äº† Incorrect datetime value: '0000-00-00' for column 'deleted_at' at row 1\"} è¿™ä¸ªé”™ï¼ŒæŸ¥è¯¢çš„æ—¶å€™æŠ¥ deleted_at\\\": unsupported Scan, storing driver.Value type \\u003cnil\\u003e into type *time.Time\" åé¢æœæ–­å»æ‰äº†è¿™ä¸ªå­—æ®µï¼Œå­—æ®µä¸Šé¢åŠ ä¸Š .omitempty è¿™ä¸ªæ ‡ç­¾ï¼Œå¥½åƒä¹Ÿæœ‰ç”¨ï¼Œdb:\".omitempty\" å…¶æ¬¡å°±æ˜¯è¿™ä¸ª Conversion from collation utf8_general_ci into utf8mb4_unicode_ciï¼Œè¿™ä¸ªå¯¼è‡´çš„å¤§æ¦‚åŸå› æ˜¯ï¼Œç°åœ¨éƒ½å–œæ¬¢ç”¨emjè¡¨æƒ…äº†ï¼Œmysqlæ•°æ®è¯†åˆ«ä¸äº†ã€‚ æ•°æ®è¿æ¥ mysql è¿™è¾¹ç…§æ ·æŒ‰ç…§åŸå§‹çš„æ–¹å¼,å°†é…ç½®æ–‡ä»¶ä¿®æ”¹ç¼–ç æ ¼å¼ï¼Œé‡æ–°åˆ›å»ºæ•°æ®åº“ï¼Œå¹¶ä¸”è®¾ç½®æ•°æ®åº“ç¼–ç ä¸ºutf8mb4ï¼Œæ’åºè§„åˆ™ä¸º utf8mb4_unicode_ciã€‚ è¿™æ ·çš„è¯,æ‰€æœ‰çš„è¡¨è¿˜æœ‰stringå­—æ®µéƒ½æ˜¯è¿™ä¸ªç¼–ç æ ¼å¼,å¦‚æœä¸æƒ³æ‰€æœ‰çš„éƒ½æ˜¯,å¯ä»¥å•ç‹¬è®¾ç½®,è¿™ä¸ªä¸æ˜¯é‡ç‚¹.å› ä¸ºåœ¨navicatä¸Šéƒ½å¥½è®¾ç½®,æ‰‹åŠ¨ç‚¹ä¸€ä¸‹å°±è¡Œäº†ã€‚ é‡ç‚¹æ¥äº†ï¼šgolangä¸­ä½¿ç”¨çš„æ˜¯ github.com/go-sql-driver/mysql é©±åŠ¨ï¼Œå°†è¿æ¥ mysqlçš„ dsnï¼ˆå› ä¸ºæˆ‘è¿™ä½¿ç”¨çš„æ˜¯gormï¼Œæ‰€ä»¥dsnå¯èƒ½è·ŸåŸç”Ÿçš„æ ¼å¼ä¸å¤ªä¸€æ ·ï¼Œä¸è¿‡æ²¡å…³ç³»ï¼Œ åªéœ€è¦å…³æ³¨ charset å’Œ collation å°±è¡Œäº†ï¼‰ root:password@/name?parseTime=True&loc=Local&charset=utf8 ä¿®æ”¹ä¸ºï¼š root:password@/name?parseTime=True&loc=Local&charset=utf8mb4&collation=utf8mb4_unicode_ci Copyright Â© 2019-2021 go-zero all right reservedï¼Œpowered by GitbookLast UpdateTimeï¼š 2025-05-05 05:44:52 "},"stream.html":{"url":"stream.html","title":"æµæ•°æ®å¤„ç†åˆ©å™¨","keywords":"","body":"æµæ•°æ®å¤„ç†åˆ©å™¨ æµå¤„ç† (Stream processing) æ˜¯ä¸€ç§è®¡ç®—æœºç¼–ç¨‹èŒƒå¼ï¼Œå…¶å…è®¸ç»™å®šä¸€ä¸ªæ•°æ®åºåˆ— (æµå¤„ç†æ•°æ®æº)ï¼Œä¸€ç³»åˆ—æ•°æ®æ“ä½œ (å‡½æ•°) è¢«åº”ç”¨åˆ°æµä¸­çš„æ¯ä¸ªå…ƒç´ ã€‚åŒæ—¶æµå¤„ç†å·¥å…·å¯ä»¥æ˜¾è‘—æé«˜ç¨‹åºå‘˜çš„å¼€å‘æ•ˆç‡ï¼Œå…è®¸ä»–ä»¬ç¼–å†™æœ‰æ•ˆã€å¹²å‡€å’Œç®€æ´çš„ä»£ç ã€‚ æµæ•°æ®å¤„ç†åœ¨æˆ‘ä»¬çš„æ—¥å¸¸å·¥ä½œä¸­éå¸¸å¸¸è§ï¼Œä¸¾ä¸ªä¾‹å­ï¼Œæˆ‘ä»¬åœ¨ä¸šåŠ¡å¼€å‘ä¸­å¾€å¾€ä¼šè®°å½•è®¸å¤šä¸šåŠ¡æ—¥å¿—ï¼Œè¿™äº›æ—¥å¿—ä¸€èˆ¬æ˜¯å…ˆå‘é€åˆ° Kafkaï¼Œç„¶åå†ç”± Job æ¶ˆè´¹ Kafaka å†™åˆ° elasticsearchï¼Œåœ¨è¿›è¡Œæ—¥å¿—æµå¤„ç†çš„è¿‡ç¨‹ä¸­ï¼Œå¾€å¾€è¿˜ä¼šå¯¹æ—¥å¿—åšä¸€äº›å¤„ç†ï¼Œæ¯”å¦‚è¿‡æ»¤æ— æ•ˆçš„æ—¥å¿—ï¼Œåšä¸€äº›è®¡ç®—ä»¥åŠé‡æ–°ç»„åˆæ—¥å¿—ç­‰ç­‰ï¼Œç¤ºæ„å›¾å¦‚ä¸‹: æµå¤„ç†å·¥å…·fx go-zero æ˜¯ä¸€ä¸ªåŠŸèƒ½å®Œå¤‡çš„å¾®æœåŠ¡æ¡†æ¶ï¼Œæ¡†æ¶ä¸­å†…ç½®äº†å¾ˆå¤šéå¸¸å®ç”¨çš„å·¥å…·ï¼Œå…¶ä¸­å°±åŒ…å«æµæ•°æ®å¤„ç†å·¥å…·fx ï¼Œä¸‹é¢æˆ‘ä»¬é€šè¿‡ä¸€ä¸ªç®€å•çš„ä¾‹å­æ¥è®¤è¯†ä¸‹è¯¥å·¥å…·ï¼š package main import ( \"fmt\" \"os\" \"os/signal\" \"syscall\" \"time\" \"github.com/zeromicro/go-zero/core/fx\" ) func main() { ch := make(chan int) go inputStream(ch) go outputStream(ch) c := make(chan os.Signal, 1) signal.Notify(c, syscall.SIGTERM, syscall.SIGINT) inputStreamå‡½æ•°æ¨¡æ‹Ÿäº†æµæ•°æ®çš„äº§ç”Ÿï¼ŒoutputStreamå‡½æ•°æ¨¡æ‹Ÿäº†æµæ•°æ®çš„å¤„ç†è¿‡ç¨‹ï¼Œå…¶ä¸­Fromå‡½æ•°ä¸ºæµçš„è¾“å…¥ï¼ŒWalkå‡½æ•°å¹¶å‘çš„ä½œç”¨åœ¨æ¯ä¸€ä¸ªitemä¸Šï¼ŒFilterå‡½æ•°å¯¹itemè¿›è¡Œè¿‡æ»¤ä¸ºtrueä¿ç•™ä¸ºfalseä¸ä¿ç•™ï¼ŒForEachå‡½æ•°éå†è¾“å‡ºæ¯ä¸€ä¸ªitemå…ƒç´ ã€‚ æµæ•°æ®å¤„ç†ä¸­é—´æ“ä½œ ä¸€ä¸ªæµçš„æ•°æ®å¤„ç†å¯èƒ½å­˜åœ¨è®¸å¤šçš„ä¸­é—´æ“ä½œï¼Œæ¯ä¸ªä¸­é—´æ“ä½œéƒ½å¯ä»¥ä½œç”¨åœ¨æµä¸Šã€‚å°±åƒæµæ°´çº¿ä¸Šçš„å·¥äººä¸€æ ·ï¼Œæ¯ä¸ªå·¥äººæ“ä½œå®Œé›¶ä»¶åéƒ½ä¼šè¿”å›å¤„ç†å®Œæˆçš„æ–°é›¶ä»¶ï¼ŒåŒç†æµå¤„ç†ä¸­é—´æ“ä½œå®Œæˆåä¹Ÿä¼šè¿”å›ä¸€ä¸ªæ–°çš„æµã€‚ fxçš„æµå¤„ç†ä¸­é—´æ“ä½œ: æ“ä½œå‡½æ•° åŠŸèƒ½ è¾“å…¥ Distinct å»é™¤é‡å¤çš„item KeyFuncï¼Œè¿”å›éœ€è¦å»é‡çš„key Filter è¿‡æ»¤ä¸æ»¡è¶³æ¡ä»¶çš„item FilterFuncï¼ŒOptionæ§åˆ¶å¹¶å‘é‡ Group å¯¹itemè¿›è¡Œåˆ†ç»„ KeyFuncï¼Œä»¥keyè¿›è¡Œåˆ†ç»„ Head å–å‡ºå‰nä¸ªitemï¼Œè¿”å›æ–°stream int64ä¿ç•™æ•°é‡ Map å¯¹è±¡è½¬æ¢ MapFuncï¼ŒOptionæ§åˆ¶å¹¶å‘é‡ Merge åˆå¹¶itemåˆ°sliceå¹¶ç”Ÿæˆæ–°stream Reverse åè½¬item Sort å¯¹itemè¿›è¡Œæ’åº LessFuncå®ç°æ’åºç®—æ³• Tail ä¸HeadåŠŸèƒ½ç±»ä¼¼ï¼Œå–å‡ºånä¸ªitemç»„æˆæ–°stream int64ä¿ç•™æ•°é‡ Walk ä½œç”¨åœ¨æ¯ä¸ªitemä¸Š WalkFuncï¼ŒOptionæ§åˆ¶å¹¶å‘é‡ ä¸‹å›¾å±•ç¤ºäº†æ¯ä¸ªæ­¥éª¤å’Œæ¯ä¸ªæ­¥éª¤çš„ç»“æœ: ç”¨æ³•ä¸åŸç†åˆ†æ From é€šè¿‡Fromå‡½æ•°æ„å»ºæµå¹¶è¿”å›Streamï¼Œæµæ•°æ®é€šè¿‡channelè¿›è¡Œå­˜å‚¨ï¼š // ä¾‹å­ s := []int{1, 2, 3, 4, 5, 6, 7, 8, 9, 0} fx.From(func(source chan Filter Filterå‡½æ•°æä¾›è¿‡æ»¤itemçš„åŠŸèƒ½ï¼ŒFilterFuncå®šä¹‰è¿‡æ»¤é€»è¾‘trueä¿ç•™itemï¼Œfalseåˆ™ä¸ä¿ç•™: // ä¾‹å­ ä¿ç•™å¶æ•° s := []int{1, 2, 3, 4, 5, 6, 7, 8, 9, 0} fx.From(func(source chan Group Groupå¯¹æµæ•°æ®è¿›è¡Œåˆ†ç»„ï¼Œéœ€å®šä¹‰åˆ†ç»„çš„keyï¼Œæ•°æ®åˆ†ç»„åä»¥sliceå­˜å…¥channel: // ä¾‹å­ æŒ‰ç…§é¦–å­—ç¬¦\"g\"æˆ–è€…\"p\"åˆ†ç»„ï¼Œæ²¡æœ‰åˆ™åˆ†åˆ°å¦ä¸€ç»„ ss := []string{\"golang\", \"google\", \"php\", \"python\", \"java\", \"c++\"} fx.From(func(source chan Reverse reverseå¯ä»¥å¯¹æµä¸­å…ƒç´ è¿›è¡Œåè½¬å¤„ç†: // ä¾‹å­ fx.Just(1, 2, 3, 4, 5).Reverse().ForEach(func(item interface{}) { fmt.Println(item) }) // æºç  func (p Stream) Reverse() Stream { var items []interface{} // è·å–æµä¸­æ•°æ® for item := range p.source { items = append(items, item) } // åè½¬ç®—æ³• for i := len(items)/2 - 1; i >= 0; i-- { opp := len(items) - 1 - i items[i], items[opp] = items[opp], items[i] } // å†™å…¥æµ return Just(items...) } Distinct distinctå¯¹æµä¸­å…ƒç´ è¿›è¡Œå»é‡ï¼Œå»é‡åœ¨ä¸šåŠ¡å¼€å‘ä¸­æ¯”è¾ƒå¸¸ç”¨ï¼Œç»å¸¸éœ€è¦å¯¹ç”¨æˆ·idç­‰åšå»é‡æ“ä½œ: // ä¾‹å­ fx.Just(1, 2, 2, 2, 3, 3, 4, 5, 6).Distinct(func(item interface{}) interface{} { return item }).ForEach(func(item interface{}) { fmt.Println(item) }) // ç»“æœä¸º 1ï¼Œ2ï¼Œ3ï¼Œ4ï¼Œ5ï¼Œ6 // æºç  func (p Stream) Distinct(fn KeyFunc) Stream { source := make(chan interface{}) threading.GoSafe(func() { defer close(source) // é€šè¿‡keyè¿›è¡Œå»é‡ï¼Œç›¸åŒkeyåªä¿ç•™ä¸€ä¸ª keys := make(map[interface{}]lang.PlaceholderType) for item := range p.source { key := fn(item) // keyå­˜åœ¨åˆ™ä¸ä¿ç•™ if _, ok := keys[key]; !ok { source Walk Walkå‡½æ•°å¹¶å‘çš„ä½œç”¨åœ¨æµä¸­æ¯ä¸€ä¸ªitemä¸Šï¼Œå¯ä»¥é€šè¿‡WithWorkersè®¾ç½®å¹¶å‘æ•°ï¼Œé»˜è®¤å¹¶å‘æ•°ä¸º16ï¼Œæœ€å°å¹¶å‘æ•°ä¸º1ï¼Œå¦‚è®¾ç½®unlimitedWorkersä¸ºtrueåˆ™å¹¶å‘æ•°æ— é™åˆ¶ï¼Œä½†å¹¶å‘å†™å…¥æµä¸­çš„æ•°æ®ç”±defaultWorkersé™åˆ¶ï¼ŒWalkFuncä¸­ç”¨æˆ·å¯ä»¥è‡ªå®šä¹‰åç»­å†™å…¥æµä¸­çš„å…ƒç´ ï¼Œå¯ä»¥ä¸å†™å…¥ä¹Ÿå¯ä»¥å†™å…¥å¤šä¸ªå…ƒç´ : // ä¾‹å­ fx.Just(\"aaa\", \"bbb\", \"ccc\").Walk(func(item interface{}, pipe chan å¹¶å‘å¤„ç† fxå·¥å…·é™¤äº†è¿›è¡Œæµæ•°æ®å¤„ç†ä»¥å¤–è¿˜æä¾›äº†å‡½æ•°å¹¶å‘åŠŸèƒ½ï¼Œåœ¨å¾®æœåŠ¡ä¸­å®ç°æŸä¸ªåŠŸèƒ½å¾€å¾€éœ€è¦ä¾èµ–å¤šä¸ªæœåŠ¡ï¼Œå¹¶å‘çš„å¤„ç†ä¾èµ–å¯ä»¥æœ‰æ•ˆçš„é™ä½ä¾èµ–è€—æ—¶ï¼Œæå‡æœåŠ¡çš„æ€§èƒ½ã€‚ fx.Parallel(func() { userRPC() // ä¾èµ–1 }, func() { accountRPC() // ä¾èµ–2 }, func() { orderRPC() // ä¾èµ–3 }) æ³¨æ„fx.Parallelè¿›è¡Œä¾èµ–å¹¶è¡Œå¤„ç†çš„æ—¶å€™ä¸ä¼šæœ‰errorè¿”å›ï¼Œå¦‚éœ€æœ‰errorè¿”å›æˆ–è€…æœ‰ä¸€ä¸ªä¾èµ–æŠ¥é”™éœ€è¦ç«‹é©¬ç»“æŸä¾èµ–è¯·æ±‚è¯·ä½¿ç”¨MapReduce å·¥å…·è¿›è¡Œå¤„ç†ã€‚ æ€»ç»“ æœ¬ç¯‡æ–‡ç« ä»‹ç»äº†æµå¤„ç†çš„åŸºæœ¬æ¦‚å¿µå’Œgo-zeroä¸­çš„æµå¤„ç†å·¥å…·fxï¼Œåœ¨å®é™…çš„ç”Ÿäº§ä¸­æµå¤„ç†åœºæ™¯åº”ç”¨ä¹Ÿéå¸¸å¤šï¼Œå¸Œæœ›æœ¬ç¯‡æ–‡ç« èƒ½ç»™å¤§å®¶å¸¦æ¥ä¸€å®šçš„å¯å‘ï¼Œæ›´å¥½çš„åº”å¯¹å·¥ä½œä¸­çš„æµå¤„ç†åœºæ™¯ã€‚ Copyright Â© 2019-2021 go-zero all right reservedï¼Œpowered by GitbookLast UpdateTimeï¼š 2025-05-05 05:44:52 "},"online-exchange.html":{"url":"online-exchange.html","title":"10æœˆ3æ—¥çº¿ä¸Šäº¤æµé—®é¢˜æ±‡æ€»","keywords":"","body":"10æœˆ3æ—¥çº¿ä¸Šäº¤æµé—®é¢˜æ±‡æ€» go-zeroé€‚ç”¨åœºæ™¯ å¸Œæœ›è¯´è¯´åº”ç”¨åœºæ™¯ï¼Œå„ä¸ªåœºæ™¯ä¸‹çš„ä¼˜åŠ¿ é«˜å¹¶å‘çš„å¾®æœåŠ¡ç³»ç»Ÿ æ”¯æ’‘åƒä¸‡çº§æ—¥æ´»ï¼Œç™¾ä¸‡çº§QPS å®Œæ•´çš„å¾®æœåŠ¡æ²»ç†èƒ½åŠ› æ”¯æŒè‡ªå®šä¹‰ä¸­é—´ä»¶ å¾ˆå¥½çš„ç®¡ç†äº†æ•°æ®åº“å’Œç¼“å­˜ æœ‰æ•ˆéš”ç¦»æ•…éšœ ä½å¹¶å‘çš„å•ä½“ç³»ç»Ÿ è¿™ç§ç³»ç»Ÿç›´æ¥ä½¿ç”¨apiå±‚å³å¯ï¼Œæ— éœ€rpcæœåŠ¡ å„ä¸ªåŠŸèƒ½çš„ä½¿ç”¨åœºæ™¯ä»¥åŠä½¿ç”¨æ¡ˆä¾‹ é™æµ ç†”æ–­ é™è½½ è¶…æ—¶ å¯è§‚æµ‹æ€§ go-zeroçš„å®é™…ä½“éªŒ æœåŠ¡å¾ˆç¨³ å‰åç«¯æ¥å£ä¸€è‡´æ€§ï¼Œä¸€ä¸ªapiæ–‡ä»¶å³å¯ç”Ÿæˆå‰åç«¯ä»£ç  è§„èŒƒã€ä»£ç é‡å°‘ï¼Œæ„å‘³ç€bugå°‘ å…é™¤apiæ–‡æ¡£ï¼Œæå¤§é™ä½æ²Ÿé€šæˆæœ¬ ä»£ç ç»“æ„å®Œå…¨ä¸€è‡´ï¼Œä¾¿äºç»´æŠ¤å’Œæ¥æ‰‹ å¾®æœåŠ¡çš„é¡¹ç›®ç»“æ„ï¼Œ monorepoçš„ CICD å¤„ç† bookstore â”œâ”€â”€ api â”‚ â”œâ”€â”€ etc â”‚ â””â”€â”€ internal â”‚ â”œâ”€â”€ config â”‚ â”œâ”€â”€ handler â”‚ â”œâ”€â”€ logic â”‚ â”œâ”€â”€ svc â”‚ â””â”€â”€ types â””â”€â”€ rpc â”œâ”€â”€ add â”‚ â”œâ”€â”€ adder â”‚ â”œâ”€â”€ etc â”‚ â”œâ”€â”€ internal â”‚ â”‚ â”œâ”€â”€ config â”‚ â”‚ â”œâ”€â”€ logic â”‚ â”‚ â”œâ”€â”€ server â”‚ â”‚ â””â”€â”€ svc â”‚ â””â”€â”€ pb â”œâ”€â”€ check â”‚ â”œâ”€â”€ checker â”‚ â”œâ”€â”€ etc â”‚ â”œâ”€â”€ internal â”‚ â”‚ â”œâ”€â”€ config â”‚ â”‚ â”œâ”€â”€ logic â”‚ â”‚ â”œâ”€â”€ server â”‚ â”‚ â””â”€â”€ svc â”‚ â””â”€â”€ pb â””â”€â”€ model mono repoçš„CIæˆ‘ä»¬æ˜¯é€šè¿‡gitlabåšçš„ï¼ŒCDä½¿ç”¨jenkins CIå°½å¯èƒ½æ›´ä¸¥æ ¼çš„æ¨¡å¼ï¼Œæ¯”å¦‚-raceï¼Œä½¿ç”¨sonarç­‰å·¥å…· CDæœ‰å¼€å‘ã€æµ‹è¯•ã€é¢„å‘ã€ç°åº¦å’Œæ­£å¼é›†ç¾¤ æ™š6ç‚¹ä¸Šç°åº¦ã€æ— æ•…éšœçš„è¯ç¬¬äºŒå¤©10ç‚¹è‡ªåŠ¨åŒæ­¥åˆ°æ­£å¼é›†ç¾¤ æ­£å¼é›†ç¾¤åˆ†ä¸ºå¤šä¸ªk8sé›†ç¾¤ï¼Œæœ‰æ•ˆçš„é˜²æ­¢å•é›†ç¾¤æ•…éšœï¼Œç›´æ¥æ‘˜é™¤å³å¯ï¼Œé›†ç¾¤å‡çº§æ›´æœ‰å¥½ å¦‚ä½•éƒ¨ç½²ï¼Œå¦‚ä½•ç›‘æ§ï¼Ÿ å…¨é‡K8Sï¼Œé€šè¿‡jenkinsè‡ªåŠ¨æ‰“åŒ…æˆdockeré•œåƒï¼ŒæŒ‰ç…§æ—¶é—´æ‰“åŒ…tagï¼Œè¿™æ ·å¯ä»¥ä¸€çœ¼çœ‹å‡ºå“ªä¸€å¤©çš„é•œåƒ ä¸Šé¢å·²ç»è®²äº†ï¼Œé¢„å‘->ç°åº¦->æ­£å¼ Prometheus+è‡ªå»ºdashboardæœåŠ¡ åŸºäºæ—¥å¿—æ£€æµ‹æœåŠ¡å’Œè¯·æ±‚å¼‚å¸¸ å¦‚æœæ‰“ç®—æ¢go-zeroæ¡†æ¶é‡æ„ä¸šåŠ¡ï¼Œå¦‚ä½•åšå¥½çº¿ä¸Šä¸šåŠ¡ç¨³å®šå®‰å…¨ç”¨æˆ·æ— æ„Ÿåˆ‡æ¢ï¼Ÿå¦å¤–å’¨è¯¢ä¸‹å¦‚ä½•è¿›è¡ŒæœåŠ¡åˆ’åˆ†ï¼Ÿ é€æ­¥æ›¿æ¢ï¼Œä»å¤–åˆ°å†…ï¼ŒåŠ ä¸ªproxyæ¥æ ¡å¯¹ï¼Œæ ¡å¯¹ä¸€å‘¨åå¯ä»¥åˆ‡æ¢ å¦‚æœ‰æ•°æ®åº“é‡æ„ï¼Œåˆ™éœ€è¦åšå¥½æ–°è€åŒæ­¥ æœåŠ¡åˆ’åˆ†æŒ‰ç…§ä¸šåŠ¡æ¥ï¼Œéµå¾ªä»ç²—åˆ°ç»†çš„åŸåˆ™ï¼Œé¿å…ä¸€ä¸ªapiä¸€ä¸ªå¾®æœåŠ¡ æ•°æ®æ‹†åˆ†å¯¹äºå¾®æœåŠ¡æ¥è®²å°¤ä¸ºé‡è¦ï¼Œä¸Šå±‚å¥½æ‹†ï¼Œæ•°æ®éš¾æ‹†ï¼Œå°½å¯èƒ½ä¿è¯æŒ‰ç…§ä¸šåŠ¡æ‹†åˆ†æ•°æ® æœåŠ¡å‘ç° æœåŠ¡å‘ç° etcd çš„ key çš„è®¾è®¡ æœåŠ¡key+æ—¶é—´æˆ³ï¼ŒæœåŠ¡è¿›ç¨‹æ•°å­˜åœ¨æ—¶é—´æˆ³å†²çªçš„æ¦‚ç‡æä½ï¼Œå¿½ç•¥ etcdæœåŠ¡å‘ç°ä¸æ²»ç†ï¼Œ å¼‚å¸¸æ•è·ä¸å¤„ç†å¼‚å¸¸ ä¸ºå•¥k8sè¿˜ä½¿ç”¨etcdåšæœåŠ¡å‘ç°ï¼Œå› ä¸ºdnsçš„åˆ·æ–°æœ‰å»¶è¿Ÿï¼Œå¯¼è‡´æ»šåŠ¨æ›´æ–°ä¼šæœ‰å¤§é‡å¤±è´¥ï¼Œè€Œetcdå¯ä»¥åšåˆ°å®Œå…¨æ— æŸæ›´æ–° etcdé›†ç¾¤ç›´æ¥éƒ¨ç½²åœ¨k8sé›†ç¾¤å†…ï¼Œå› ä¸ºå¤šä¸ªæ­£å¼é›†ç¾¤ï¼Œé›†ç¾¤å•ç‚¹å’Œæ³¨å†Œé¿å…æ··ä¹± é’ˆå¯¹etcdå¼‚å¸¸æˆ–è€…leaderåˆ‡æ¢ï¼Œè‡ªåŠ¨ä¾¦æµ‹å¹¶åˆ·æ–°ï¼Œå½“etcdæœ‰å¼‚å¸¸ä¸èƒ½æ¢å¤æ—¶ï¼Œä¸ä¼šåˆ·æ–°æœåŠ¡åˆ—è¡¨ï¼Œä¿éšœæœåŠ¡ä¾ç„¶å¯ç”¨ ç¼“å­˜çš„è®¾è®¡ä¸ä½¿ç”¨æ¡ˆä¾‹ åˆ†å¸ƒå¼å¤šredisé›†ç¾¤ï¼Œçº¿ä¸Šæœ€å¤§å‡ åä¸ªé›†ç¾¤ä¸ºåŒä¸€ä¸ªæœåŠ¡æä¾›ç¼“å­˜æœåŠ¡ æ— ç¼æ‰©ç¼©å®¹ ä¸å­˜åœ¨æ²¡æœ‰è¿‡æœŸæ—¶é—´çš„ç¼“å­˜ï¼Œé¿å…å¤§é‡ä¸å¸¸ä½¿ç”¨çš„æ•°æ®å ç”¨èµ„æºï¼Œé»˜è®¤ä¸€å‘¨ ç¼“å­˜ç©¿é€ï¼Œæ²¡æœ‰çš„æ•°æ®ä¼šçŸ­æš‚ç¼“å­˜ä¸€åˆ†é’Ÿï¼Œé¿å…åˆ·æ¥å£æˆ–å¤§é‡ä¸å­˜åœ¨çš„æ•°æ®è¯·æ±‚å¸¦å®ç³»ç»Ÿ ç¼“å­˜å‡»ç©¿ï¼Œä¸€ä¸ªè¿›ç¨‹åªä¼šåˆ·æ–°ä¸€æ¬¡åŒä¸€ä¸ªæ•°æ®ï¼Œé¿å…çƒ­ç‚¹æ•°æ®è¢«å¤§é‡åŒæ—¶åŠ è½½ ç¼“å­˜é›ªå´©ï¼Œå¯¹ç¼“å­˜è¿‡æœŸæ—¶é—´è‡ªåŠ¨åšäº†jitterï¼Œ5%çš„æ ‡å‡†å˜å·®ï¼Œä½¿å¾—ä¸€å‘¨çš„è¿‡æœŸæ—¶é—´åˆ†å¸ƒåœ¨16å°æ—¶å†…ï¼Œæœ‰æ•ˆé˜²æ­¢äº†é›ªå´© æˆ‘ä»¬çº¿ä¸Šæ•°æ®åº“éƒ½æœ‰ç¼“å­˜ï¼Œå¦åˆ™æ— æ³•æ”¯æ’‘æµ·é‡å¹¶å‘ è‡ªåŠ¨ç¼“å­˜ç®¡ç†å·²ç»å†…ç½®äºgo-zeroï¼Œå¹¶å¯ä»¥é€šè¿‡goctlè‡ªåŠ¨ç”Ÿæˆä»£ç  èƒ½å¦è®²è§£ä¸‹ï¼Œ ä¸­é—´ä»¶ï¼Œæ‹¦æˆªå™¨çš„è®¾è®¡æ€æƒ³ æ´‹è‘±æ¨¡å‹ æœ¬ä¸­é—´ä»¶å¤„ç†ï¼Œæ¯”å¦‚é™æµï¼Œç†”æ–­ç­‰ï¼Œç„¶åå†³å®šæ˜¯å¦è°ƒç”¨next nextè°ƒç”¨ å¯¹nextè°ƒç”¨è¿”å›ç»“æœåšå¤„ç† å¾®æœåŠ¡çš„äº‹åŠ¡å¤„ç†æ€ä¹ˆå®ç°å¥½ï¼Œgozeroåˆ†å¸ƒå¼äº‹åŠ¡è®¾è®¡å’Œå®ç°ï¼Œæœ‰ä»€ä¹ˆå¥½ä¸­é—´ä»¶æ¨è 2PCï¼Œä¸¤é˜¶æ®µæäº¤ TCCï¼ŒTry-Confirm-Cancel æ¶ˆæ¯é˜Ÿåˆ—ï¼Œæœ€å¤§å°è¯• äººå·¥è¡¥å¿ å¤šçº§ goroutine çš„å¼‚å¸¸æ•è· ï¼Œæ€ä¹ˆè®¾è®¡æ¯”è¾ƒå¥½ å¾®æœåŠ¡ç³»ç»Ÿè¯·æ±‚å¼‚å¸¸åº”è¯¥éš”ç¦»ï¼Œä¸èƒ½è®©å•ä¸ªå¼‚å¸¸è¯·æ±‚å¸¦å´©æ•´ä¸ªè¿›ç¨‹ go-zeroè‡ªå¸¦äº†RunSafe/GoSafeï¼Œç”¨æ¥é˜²æ­¢å•ä¸ªå¼‚å¸¸è¯·æ±‚å¯¼è‡´è¿›ç¨‹å´©æºƒ ç›‘æ§éœ€è¦è·Ÿä¸Šï¼Œé˜²æ­¢å¼‚å¸¸è¿‡é‡è€Œä¸è‡ªçŸ¥ fail fastå’Œæ•…éšœéš”ç¦»çš„çŸ›ç›¾ç‚¹ k8sé…ç½®çš„ç”Ÿæˆä¸ä½¿ç”¨(gateway, service, slb) å†…éƒ¨è‡ªåŠ¨ç”Ÿæˆk8sçš„yamlæ–‡ä»¶ï¼Œè¿‡äºä¾èµ–é…ç½®è€Œæœªå¼€æº æ‰“ç®—åœ¨bookstoreçš„ç¤ºä¾‹é‡ŒåŠ ä¸Šk8sé…ç½®æ ·æ¿ slb->nginx->nodeport->api gateway->rpc service gatewayé™æµã€ç†”æ–­å’Œé™è½½ é™æµåˆ†ä¸ºä¸¤ç§ï¼šå¹¶å‘æ§åˆ¶å’Œåˆ†å¸ƒå¼é™æµ å¹¶å‘æ§åˆ¶ç”¨æ¥é˜²æ­¢ç¬é—´è¿‡é‡è¯·æ±‚ï¼Œä¿æŠ¤ç³»ç»Ÿä¸è¢«æ‰“å® åˆ†å¸ƒå¼é™æµç”¨æ¥ç»™ä¸åŒæœåŠ¡é…ç½®ä¸åŒçš„quota ç†”æ–­æ˜¯ä¸ºäº†å¯¹ä¾èµ–çš„æœåŠ¡è¿›è¡Œä¿æŠ¤ï¼Œå½“ä¸€ä¸ªæœåŠ¡å‡ºç°å¤§é‡å¼‚å¸¸çš„æ—¶å€™ï¼Œè°ƒç”¨è€…åº”è¯¥ç»™äºˆä¿æŠ¤ï¼Œä½¿å…¶æœ‰æœºä¼šæ¢å¤æ­£å¸¸ï¼ŒåŒæ—¶ä¹Ÿè¾¾åˆ°fail fastçš„æ•ˆæœ é™è½½æ˜¯ä¸ºäº†ä¿æŠ¤å½“å‰è¿›ç¨‹èµ„æºè€—å°½è€Œé™·å…¥å½»åº•ä¸å¯ç”¨ï¼Œç¡®ä¿å°½å¯èƒ½æœåŠ¡å¥½èƒ½æ‰¿è½½çš„æœ€å¤§è¯·æ±‚é‡ é™è½½é…åˆk8sï¼Œå¯ä»¥æœ‰æ•ˆä¿æŠ¤k8sæ‰©å®¹ï¼Œk8sæ‰©å®¹åˆ†é’Ÿçº§ï¼Œgo-zeroé™è½½ç§’çº§ ä»‹ç»coreä¸­å¥½ç”¨çš„ç»„ä»¶ï¼Œå¦‚timingwheelç­‰ï¼Œè®²è®²è®¾è®¡æ€è·¯ å¸ƒéš†è¿‡æ»¤å™¨ è¿›ç¨‹å†…cache RollingWindow TimingWheel å„ç§executors fxåŒ…ï¼Œmap/reduce/filter/sort/group/distinct/head/tail... ä¸€è‡´æ€§hashå®ç° åˆ†å¸ƒå¼é™æµå®ç° mapreduceï¼Œå¸¦cancelèƒ½åŠ› syncxåŒ…é‡Œæœ‰å¤§é‡çš„å¹¶å‘å·¥å…· å¦‚ä½•å¿«é€Ÿå¢åŠ ä¸€ç§rpcåè®®æ”¯æŒï¼Œå°‡è·¨æœºå‘ç°æ”¹ä¸ºè°ƒæœ¬æœºèŠ‚ç‚¹ï¼Œå¹¶å…³é—­å¤æ‚filterå’Œè´Ÿè½½å‡è¡¡åŠŸèƒ½ go-zeroè·Ÿgrpcå…³ç³»è¿˜æ˜¯æ¯”è¾ƒç´§å¯†çš„ï¼Œè®¾è®¡ä¹‹åˆæ²¡æœ‰è€ƒè™‘æ”¯æŒgrpcä»¥å¤–çš„åè®® å¦‚æœè¦å¢åŠ çš„è¯ï¼Œé‚£å°±åªèƒ½forkå‡ºæ¥é­”æ”¹äº† è°ƒæœ¬æœºç›´æ¥ç”¨directçš„schemeå³å¯ ä¸ºå•¥è¦å»æ‰filterå’Œè´Ÿè½½å‡è¡¡ï¼Ÿå¦‚æœè¦å»çš„è¯ï¼Œforkäº†æ”¹ï¼Œä½†æ²¡å¿…è¦ æ—¥å¿—å’Œç›‘æ§å’Œé“¾è·¯è¿½è¸ªçš„è®¾è®¡å’Œå®ç°æ€è·¯ï¼Œæœ€å¥½æœ‰å¤§æ¦‚å›¾è§£ æ—¥å¿—å’Œç›‘æ§æˆ‘ä»¬ä½¿ç”¨prometheus, è‡ªå®šä¹‰dashboardæœåŠ¡ï¼Œæ†ç»‘æäº¤æ•°æ®ï¼ˆæ¯åˆ†é’Ÿï¼‰ é“¾è·¯è¿½è¸ªå¯ä»¥çœ‹å‡ºè°ƒç”¨å…³ç³»ï¼Œè‡ªåŠ¨è®°å½•traceæ—¥å¿— go-zeroæ¡†æ¶æœ‰ç”¨åˆ°ä»€ä¹ˆæ± åŒ–æŠ€æœ¯å—ï¼Ÿå¦‚æœæœ‰ï¼Œåœ¨å“ªäº›coreä»£ç é‡Œé¢å¯ä»¥å‚è€ƒ ä¸€èˆ¬ä¸éœ€è¦æå‰ä¼˜åŒ–ï¼Œè¿‡åº¦ä¼˜åŒ–æ˜¯å¤§å¿Œ core/syncx/pool.goé‡Œé¢å®šä¹‰äº†å¸¦è¿‡æœŸæ—¶é—´çš„é€šç”¨æ± åŒ–æŠ€æœ¯ go-zeroç”¨åˆ°äº†é‚£äº›æ€§èƒ½æµ‹è¯•æ–¹æ³•æ¡†æ¶ï¼Œæœ‰ä»£ç å‚è€ƒå—ï¼Ÿå¯ä»¥è¯´è¯´æ€è·¯å’Œç»éªŒ go benchmark å‹æµ‹å¯ä»¥é€šè¿‡ç°æœ‰ä¸šåŠ¡æ—¥å¿—æ ·æœ¬ï¼Œæ¥æŒ‰ç…§é¢„ä¼°ç­‰æ¯”æ”¾å¤§ å‹æµ‹ä¸€å®šè¦å‹åˆ°ç³»ç»Ÿæ‰›ä¸ä½ï¼Œçœ‹ç¬¬ä¸€ä¸ªç“¶é¢ˆåœ¨å“ªé‡Œï¼Œæ”¹å®Œå†å‹ï¼Œå¾ªç¯ è¯´ä¸€ä¸‹ä»£ç çš„æŠ½è±¡ç»éªŒå’Œå¿ƒå¾— Donâ€™t repeat yourself ä½ æœªå¿…éœ€è¦å®ƒï¼Œä¹‹å‰ç»å¸¸æœ‰ä¸šåŠ¡å¼€å‘äººå‘˜é—®æˆ‘å¯ä¸å¯ä»¥å¢åŠ è¿™ä¸ªåŠŸèƒ½æˆ–é‚£ä¸ªåŠŸèƒ½ï¼Œæˆ‘ä¸€èˆ¬éƒ½ä¼šä»”ç»†è¯¢é—®æ·±å±‚æ¬¡ç›®çš„ï¼Œå¾ˆå¤šæ—¶å€™ä¼šå‘ç°å…¶å®è¿™ä¸ªåŠŸèƒ½æ˜¯å¤šä½™çš„ï¼Œä¸éœ€è¦æ‰æ˜¯æœ€ä½³å®è·µ Martin Fowleræå‡ºå‡ºç°ä¸‰æ¬¡å†æŠ½è±¡çš„åŸåˆ™ï¼Œæœ‰æ—¶æœ‰äº›åŒäº‹ä¼šæ‰¾æˆ‘å¾€æ¡†æ¶é‡Œå¢åŠ ä¸€ä¸ªåŠŸèƒ½ï¼Œæˆ‘æ€è€ƒåç»å¸¸ä¼šå›ç­”è¿™ä¸ªä½ å…ˆåœ¨ä¸šåŠ¡å±‚å†™ï¼Œå…¶å®ƒåœ°æ–¹ä¹Ÿæœ‰éœ€è¦äº†ä½ å†å‘Šè¯‰æˆ‘ï¼Œä¸‰æ¬¡å‡ºç°æˆ‘ä¼šè€ƒè™‘é›†æˆåˆ°æ¡†æ¶é‡Œ ä¸€ä¸ªæ–‡ä»¶åº”è¯¥å°½é‡åªåšä¸€ä»¶äº‹ï¼Œæ¯ä¸ªæ–‡ä»¶å°½å¯èƒ½æ§åˆ¶åœ¨200è¡Œä»¥å†…ï¼Œä¸€ä¸ªå‡½æ•°å°½å¯èƒ½æ§åˆ¶åœ¨50è¡Œä»¥å†…ï¼Œè¿™æ ·ä¸éœ€è¦æ»šåŠ¨å°±å¯ä»¥çœ‹åˆ°æ•´ä¸ªå‡½æ•° éœ€è¦æŠ½è±¡å’Œæç‚¼çš„èƒ½åŠ›ï¼Œå¤šå»æ€è€ƒï¼Œç»å¸¸å›å¤´æ€è€ƒä¹‹å‰çš„æ¶æ„æˆ–å®ç° ä½ ä¼šå°±go-zero æ¡†æ¶ä»è®¾è®¡åˆ°å®è·µå‡ºä¹¦å—ï¼Ÿæ¡†æ¶ä»¥åçš„å‘å±•è§„åˆ’æ˜¯ä»€ä¹ˆï¼Ÿ æš‚æ— å‡ºä¹¦è®¡åˆ’ï¼Œåšå¥½æ¡†æ¶æ˜¯æœ€é‡è¦çš„ ç»§ç»­ç€çœ¼äºå·¥ç¨‹æ•ˆç‡ æå‡æœåŠ¡æ²»ç†èƒ½åŠ› å¸®åŠ©ä¸šåŠ¡å¼€å‘å°½å¯èƒ½å¿«é€Ÿè½åœ° Copyright Â© 2019-2021 go-zero all right reservedï¼Œpowered by GitbookLast UpdateTimeï¼š 2025-05-05 05:44:52 "},"contributor.html":{"url":"contributor.html","title":"è´¡çŒ®äººå‘˜","keywords":"","body":"ç¤¾åŒºè´¡çŒ® ä½œè€… kevwan go-zeroå‚ä¸äººå‘˜ kevwan dependabot[bot] kesonan kingxt chenquan MarkJoyMa zcong1993 testwill fynxiu xiandong-italki stevenzack zhoushuguang Suyghur bittoy dfang miaogaolin szpnygo heyanfu wubenqi fondoger shenbaise9527 taobig POABOB sjatsh Mikaelemmmm foliet soasurs reatang Code-Fight xiaowei520 wsx864321 chowyu12 chensylz phibe2017 anyoptional AlexLast LeeDF codeErrorSleep studyzy czyt zjbztianya kurimi1 pig-peppa veezhang jiang4869 xiaoyuzdy knight0zh ch3nnn fanlongteng fearlessfei guonaihong jaronnie re-dylan Howie59 masonchen2014 mlr3000 mongobaba mywaystay ronething-bot sado0823 SpectatorNan supermario1990 lizhichao voidint yangjinheng cjf8134 smithyj weicut zzzfwww HarryWang29 workman-Lu wuqinqiang appleboy pipi-lv JiChenSSG almas1992 Nanosk07 WqyJh reneleonhardt chenrui333 ShyunnY lucaq lchjczw heyehang wangzeping722 fyyang cuishuang bensonfx kscooo toby1991 sohamtembhurne SnakeHacker lovelly lowang-bh magickeha yangwenmai me-cs mlboy moyrne ningzio ahmczsy lvillis alariczq r00mz mamil safeoy sauryniu dushaoshuai shyandsy skyoct sniperwzq gq-tang RivenChan suyhuai foyon genewoo godLei6 gongluck hanxuanliang tfzxyinhao lhcGinv hexiaoen hoshi200 iyyzh Janetyu demoManito jichangyun jiz4oh jursonmo zhaikangqi331 kevin0527 byops louyuexing kunyu lascyb linden-in-China liumin-go lord63 toventang youzipi zeromake zzhaolei zzZZzzz888 r27153733 sixwaaaay liuqing6767 linganmin citizen233 u2nyakim wenj91 congim 600ML seth-shi AaronCXZ lppgo wanghaha-dev happy-v587 peasfarmer DestinyOfLove qwxingzhe SeigeC jsonMark tsinghuacoder vankillua shssen rcyw weibobo windk wojiukankan wuleiming2009 wwek wwwfeng wxc421 xiang-xx xt-inking xuerbujia TonoT xujb977644703 xybingbing doptime runtu666 yedf2 yiGmMk liyiwu yonwoo9 2822132073 richardJiang Disdjj joshq00 Julian-Chu 0xkookoo wanjunfeng Kimjin-gd tnothy lyuangg WangLeonard letian-jiang fzdwx liamhao jk2K mervin0502 JasonMing vfmh notrynosuccess ofey404 oraoto ivalue2333 R1aEnKK Rankgice 7134g lqlspace alonexy amorist 0Armaan025 tvermaashutosh AtlanCI Awadabang BYT0723 bhargavshirin changkun chrislee87 CrazyZard defp EinfachePhy qiujiafei gokure hthuz Hkesd RyanTokManMokMTM l306287405 wjiec nianiaJR qwernser aimuz ak5w Ouyangan AnlynnLee ansoda anstns wangshiben benyingY bigrocs jiangbohhh accaolei x1nchen mycatone charliecen cuisongliu dahaihu dylanNew edieruby elza2 fffreedom linyihai fishJack01 fisnone metaRobin ren544735689 Jancd SgtDaJim SleeplessBot 1067088037 suravshresth zhouyusd cgx027 wangyi12358 tim1116 tonywangcn patche-v cch123 ChengXavier wwwangxc cubxxw lxy1992 fulldog brickzzhang zlx362211854 a0v0 xiongqq345 æ–‡æ¡£è´¡çŒ®äººå‘˜ kevwan loocor koulerz citizen233 Mikaelemmmm avtion applyfly wuyang910217 wuqinqiang zcong1993 jackluo2012 zoulux karnin keehao linganmin ronething-bot topfanfan belm ice-waves hwb2017 hbinr ha-ni-cc gggwvg chensylz auula Copyright Â© 2019-2021 go-zero all right reservedï¼Œpowered by GitbookLast UpdateTimeï¼š 2025-05-05 05:44:53 "},"doc-contibute.html":{"url":"doc-contibute.html","title":"æ–‡æ¡£è´¡çŒ®","keywords":"","body":"æ–‡æ¡£è´¡çŒ® æ€ä¹ˆè´¡çŒ®æ–‡æ¡£ï¼Ÿ ç‚¹å‡»é¡¶éƒ¨\"ç¼–è¾‘æ­¤é¡µ\"æŒ‰é’®å³å¯è¿›å…¥æºç ä»“åº“å¯¹åº”çš„æ–‡ä»¶ï¼Œå¼€å‘äººå‘˜å°†ä¿®æ”¹ï¼ˆæ·»åŠ ï¼‰çš„æ–‡æ¡£é€šè¿‡prå½¢å¼æäº¤ï¼Œ æˆ‘ä»¬æ”¶åˆ°pråä¼šè¿›è¡Œæ–‡æ¡£å®¡æ ¸ï¼Œä¸€æ—¦å®¡æ ¸é€šè¿‡å³å¯æ›´æ–°æ–‡æ¡£ã€‚ å¯ä»¥è´¡çŒ®å“ªäº›æ–‡æ¡£ï¼Ÿ æ–‡æ¡£ç¼–å†™é”™è¯¯ æ–‡æ¡£ä¸è§„èŒƒã€ä¸å®Œæ•´ go-zeroåº”ç”¨å®è·µã€å¿ƒå¾— ç»„ä»¶ä¸­å¿ƒ æ–‡æ¡£pré€šè¿‡åæ–‡æ¡£å¤šä¹…ä¼šæ›´æ–°ï¼Ÿ åœ¨præ¥å—åï¼Œgithub actionä¼šè‡ªåŠ¨build gitbookå¹¶å‘å¸ƒï¼Œå› æ­¤åœ¨github actionæˆåŠŸå1-2åˆ†é’Ÿå³å¯æŸ¥çœ‹æ›´æ–°åçš„æ–‡æ¡£ã€‚ æ–‡æ¡£è´¡çŒ®æ³¨æ„äº‹é¡¹ çº é”™ã€å®Œå–„æºæ–‡æ¡£å¯ä»¥ç›´æ¥ç¼–å†™åŸæ¥çš„mdæ–‡ä»¶ æ–°å¢ç»„ä»¶æ–‡æ¡£éœ€è¦ä¿è¯æ–‡æ¡£æ’ç‰ˆã€æ˜“è¯»ï¼Œä¸”ç»„ä»¶æ–‡æ¡£éœ€è¦æ”¾åœ¨ç»„ä»¶ä¸­å¿ƒå­ç›®å½•ä¸­ go-zeroåº”ç”¨å®è·µåˆ†äº«å¯ä»¥ç›´æ¥æ”¾åœ¨å¼€å‘å®è·µå­ç›®å½•ä¸‹ ç›®å½•ç»“æ„è§„èŒƒ ç›®å½•ç»“æ„ä¸å®œè¿‡æ·±ï¼Œæœ€å¥½ä¸è¦è¶…è¿‡3å±‚ ç»„ä»¶æ–‡æ¡£éœ€è¦åœ¨å½’å±åˆ°ç»„ä»¶ä¸­å¿ƒï¼Œå¦‚* [å¼€å‘å®è·µ](practise.md) * [logx](logx.md) * [bloom](bloom.md) * [executors](executors.md) * ä½ çš„æ–‡æ¡£ç›®å½•åç§° åº”ç”¨å®è·µéœ€è¦å½’å±åˆ°å¼€å‘å®è·µï¼Œå¦‚* [å¼€å‘å®è·µ](practise.md) * [æˆ‘æ˜¯å¦‚ä½•ç”¨go-zero å®ç°ä¸€ä¸ªä¸­å°ç³»ç»Ÿ](datacenter.md) * [æµæ•°æ®å¤„ç†åˆ©å™¨](stream.md) * [10æœˆ3æ—¥çº¿ä¸Šäº¤æµé—®é¢˜æ±‡æ€»](online-exchange.md * ä½ çš„æ–‡æ¡£ç›®å½•åç§° å¼€å‘å®è·µæ–‡æ¡£æ¨¡æ¿ # æ ‡é¢˜ > ä½œè€…ï¼šå¡«å…¥ä½œè€…åç§° > > åŸæ–‡è¿æ¥ï¼š åŸæ–‡è¿æ¥ some markdown content çŒœä½ æƒ³çœ‹ æ€ä¹ˆå‚ä¸è´¡çŒ® Github Pull request Copyright Â© 2019-2021 go-zero all right reservedï¼Œpowered by GitbookLast UpdateTimeï¼š 2025-05-05 05:44:52 "},"error.html":{"url":"error.html","title":"å¸¸è§é”™è¯¯å¤„ç†","keywords":"","body":"å¸¸è§é”™è¯¯å¤„ç† Windowsä¸ŠæŠ¥é”™ A required privilege is not held by the client. è§£å†³æ–¹æ³•ï¼š\"ä»¥ç®¡ç†å‘˜èº«ä»½è¿è¡Œ\" goctl å³å¯ã€‚ grpcå¼•èµ·é”™è¯¯ é”™è¯¯ä¸€ protoc-gen-go: unable to determine Go import path for \"greet.proto\" Please specify either: â€¢ a \"go_package\" option in the .proto source file, or â€¢ a \"M\" argument on the command line. See https://developers.google.com/protocol-buffers/docs/reference/go-generated#package for more information. --go_out: protoc-gen-go: Plugin failed with status code 1. è§£å†³æ–¹æ³•ï¼š go get -u github.com/golang/protobuf/protoc-gen-go@v1.3.2 protoc-gen-goå®‰è£…å¤±è´¥ go get github.com/golang/protobuf/protoc-gen-go: module github.com/golang/protobuf/protoc-gen-go: Get \"https://proxy.golang.org/github.com/golang/protobuf/protoc-gen-go/@v/list\": dial tcp 216.58.200.49:443: i/o timeout è¯·ç¡®è®¤GOPROXYå·²ç»è®¾ç½®,GOPROXYè®¾ç½®è§go moduleé…ç½® apiæœåŠ¡å¯åŠ¨å¤±è´¥ error: config file etc/user-api.yaml, error: type mismatch for field xx è¯·ç¡®è®¤user-api.yamlé…ç½®æ–‡ä»¶ä¸­é…ç½®é¡¹æ˜¯å¦å·²ç»é…ç½®ï¼Œå¦‚æœæœ‰å€¼ï¼Œæ£€æŸ¥ä¸€ä¸‹yamlé…ç½®æ–‡ä»¶æ˜¯å¦ç¬¦åˆyamlæ ¼å¼ã€‚ goctlæ‰¾ä¸åˆ° command not found: goctl è¯·ç¡®ä¿goctlå·²ç»å®‰è£…æˆ–è€…goctlæ˜¯å¦å·²ç»æ·»åŠ åˆ°ç¯å¢ƒå˜é‡ Copyright Â© 2019-2021 go-zero all right reservedï¼Œpowered by GitbookLast UpdateTimeï¼š 2025-05-05 05:44:52 "},"source.html":{"url":"source.html","title":"ç›¸å…³æºç ","keywords":"","body":"ç›¸å…³æºç  demoæºç  Copyright Â© 2019-2021 go-zero all right reservedï¼Œpowered by GitbookLast UpdateTimeï¼š 2025-05-05 05:44:52 "},"tips.html":{"url":"tips.html","title":"é˜…è¯»é¡»çŸ¥","keywords":"","body":"é˜…è¯»é¡»çŸ¥ æœ¬æ–‡æ¡£ä»å¿«é€Ÿå…¥é—¨ï¼Œè¯¦ç»†é¡¹ç›®å¼€å‘æµç¨‹ï¼Œgo-zeroæœåŠ¡è®¾è®¡æ€æƒ³ï¼Œgoctlå·¥å…·çš„ä½¿ç”¨ç­‰ç»´åº¦è¿›è¡Œäº†ä»‹ç»ï¼Œ å¯¹äºåˆšåˆšæ¥è§¦goæˆ–go-zeroçš„åŒå­¦éœ€è¦æŠŠè¿™äº›ç¯‡å¹…éƒ½çœ‹å®Œæ‰èƒ½æœ‰æ‰€äº†è§£ï¼Œå› æ­¤æœ‰äº›è´¹åŠ›ï¼Œè¿™é‡Œå»ºè®®å¤§å®¶é˜…è¯»çš„æ–¹æ³•ã€‚ ä¿æŒè€å¿ƒè·Ÿç€æ–‡æ¡£ç›®å½•è¿›è¡Œï¼Œæ–‡æ¡£æ˜¯æŒ‰ç…§ä»ç®€å•åˆ°æ·±å…¥çš„æ¸è¿›å¼è¿‡ç¨‹ç¼–å†™çš„ã€‚ åœ¨é‡åˆ°é—®é¢˜æˆ–é”™è¯¯æ—¶ï¼Œè¯·ä¸€å®šè®°ä½å¤šæŸ¥FAQã€‚ Copyright Â© 2019-2021 go-zero all right reservedï¼Œpowered by GitbookLast UpdateTimeï¼š 2025-05-05 05:44:52 "},"shorturl.html":{"url":"shorturl.html","title":"å¿«é€Ÿæ„å»ºé«˜å¹¶å‘å¾®æœåŠ¡","keywords":"","body":"å¿«é€Ÿæ„å»ºé«˜å¹¶å‘å¾®æœåŠ¡ English | ç®€ä½“ä¸­æ–‡ 0. ä¸ºä»€ä¹ˆè¯´åšå¥½å¾®æœåŠ¡å¾ˆéš¾ è¦æƒ³åšå¥½å¾®æœåŠ¡ï¼Œæˆ‘ä»¬éœ€è¦ç†è§£å’ŒæŒæ¡çš„çŸ¥è¯†ç‚¹éå¸¸å¤šï¼Œä»å‡ ä¸ªç»´åº¦ä¸Šæ¥è¯´ï¼š åŸºæœ¬åŠŸèƒ½å±‚é¢ å¹¶å‘æ§åˆ¶ & é™æµï¼Œé¿å…æœåŠ¡è¢«çªå‘æµé‡å‡»å® æœåŠ¡æ³¨å†Œä¸æœåŠ¡å‘ç°ï¼Œç¡®ä¿èƒ½å¤ŸåŠ¨æ€ä¾¦æµ‹å¢å‡çš„èŠ‚ç‚¹ è´Ÿè½½å‡è¡¡ï¼Œéœ€è¦æ ¹æ®èŠ‚ç‚¹æ‰¿å—èƒ½åŠ›åˆ†å‘æµé‡ è¶…æ—¶æ§åˆ¶ï¼Œé¿å…å¯¹å·²è¶…æ—¶è¯·æ±‚åšæ— ç”¨åŠŸ ç†”æ–­è®¾è®¡ï¼Œå¿«é€Ÿå¤±è´¥ï¼Œä¿éšœæ•…éšœèŠ‚ç‚¹çš„æ¢å¤èƒ½åŠ› é«˜é˜¶åŠŸèƒ½å±‚é¢ è¯·æ±‚è®¤è¯ï¼Œç¡®ä¿æ¯ä¸ªç”¨æˆ·åªèƒ½è®¿é—®è‡ªå·±çš„æ•°æ® é“¾è·¯è¿½è¸ªï¼Œç”¨äºç†è§£æ•´ä¸ªç³»ç»Ÿå’Œå¿«é€Ÿå®šä½ç‰¹å®šè¯·æ±‚çš„é—®é¢˜ æ—¥å¿—ï¼Œç”¨äºæ•°æ®æ”¶é›†å’Œé—®é¢˜å®šä½ å¯è§‚æµ‹æ€§ï¼Œæ²¡æœ‰åº¦é‡å°±æ²¡æœ‰ä¼˜åŒ– å¯¹äºå…¶ä¸­æ¯ä¸€ç‚¹ï¼Œæˆ‘ä»¬éƒ½éœ€è¦ç”¨å¾ˆé•¿çš„ç¯‡å¹…æ¥è®²è¿°å…¶åŸç†å’Œå®ç°ï¼Œé‚£ä¹ˆå¯¹æˆ‘ä»¬åç«¯å¼€å‘è€…æ¥è¯´ï¼Œè¦æƒ³æŠŠè¿™äº›çŸ¥è¯†ç‚¹éƒ½æŒæ¡å¹¶è½å®åˆ°ä¸šåŠ¡ç³»ç»Ÿé‡Œï¼Œéš¾åº¦æ˜¯éå¸¸å¤§çš„ï¼Œä¸è¿‡æˆ‘ä»¬å¯ä»¥ä¾èµ–å·²ç»è¢«å¤§æµé‡éªŒè¯è¿‡çš„æ¡†æ¶ä½“ç³»ã€‚go-zero å¾®æœåŠ¡æ¡†æ¶å°±æ˜¯ä¸ºæ­¤è€Œç”Ÿã€‚ å¦å¤–ï¼Œæˆ‘ä»¬å§‹ç»ˆç§‰æ‰¿ å·¥å…·å¤§äºçº¦å®šå’Œæ–‡æ¡£ çš„ç†å¿µã€‚æˆ‘ä»¬å¸Œæœ›å°½å¯èƒ½å‡å°‘å¼€å‘äººå‘˜çš„å¿ƒæ™ºè´Ÿæ‹…ï¼ŒæŠŠç²¾åŠ›éƒ½æŠ•å…¥åˆ°äº§ç”Ÿä¸šåŠ¡ä»·å€¼çš„ä»£ç ä¸Šï¼Œå‡å°‘é‡å¤ä»£ç çš„ç¼–å†™ï¼Œæ‰€ä»¥æˆ‘ä»¬å¼€å‘äº† goctl å·¥å…·ã€‚ ä¸‹é¢æˆ‘é€šè¿‡çŸ­é“¾å¾®æœåŠ¡æ¥æ¼”ç¤ºé€šè¿‡ go-zero å¿«é€Ÿçš„åˆ›å»ºå¾®æœåŠ¡çš„æµç¨‹ï¼Œèµ°å®Œä¸€éï¼Œä½ å°±ä¼šå‘ç°ï¼šåŸæ¥ç¼–å†™å¾®æœåŠ¡å¦‚æ­¤ç®€å•ï¼ 1. ä»€ä¹ˆæ˜¯çŸ­é“¾æœåŠ¡ çŸ­é“¾æœåŠ¡å°±æ˜¯å°†é•¿çš„ URL ç½‘å€ï¼Œé€šè¿‡ç¨‹åºè®¡ç®—ç­‰æ–¹å¼ï¼Œè½¬æ¢ä¸ºç®€çŸ­çš„ç½‘å€å­—ç¬¦ä¸²ã€‚ å†™æ­¤çŸ­é“¾æœåŠ¡æ˜¯ä¸ºäº†ä»æ•´ä½“ä¸Šæ¼”ç¤º go-zero æ„å»ºå®Œæ•´å¾®æœåŠ¡çš„è¿‡ç¨‹ï¼Œç®—æ³•å’Œå®ç°ç»†èŠ‚å°½å¯èƒ½ç®€åŒ–äº†ï¼Œæ‰€ä»¥è¿™ä¸æ˜¯ä¸€ä¸ªé«˜é˜¶çš„çŸ­é“¾æœåŠ¡ã€‚ 2. çŸ­é“¾å¾®æœåŠ¡æ¶æ„å›¾ è¿™é‡Œåªç”¨äº† Transform RPC ä¸€ä¸ªå¾®æœåŠ¡ï¼Œå¹¶ä¸æ˜¯è¯´ API Gateway åªèƒ½è°ƒç”¨ä¸€ä¸ªå¾®æœåŠ¡ï¼Œåªæ˜¯ä¸ºäº†æœ€ç®€æ¼”ç¤º API Gateway å¦‚ä½•è°ƒç”¨ RPC å¾®æœåŠ¡è€Œå·² åœ¨çœŸæ­£é¡¹ç›®é‡Œè¦å°½å¯èƒ½æ¯ä¸ªå¾®æœåŠ¡ä½¿ç”¨è‡ªå·±çš„æ•°æ®åº“ï¼Œæ•°æ®è¾¹ç•Œè¦æ¸…æ™° 3. goctl å„å±‚ä»£ç ç”Ÿæˆä¸€è§ˆ æ‰€æœ‰ç»¿è‰²èƒŒæ™¯çš„åŠŸèƒ½æ¨¡å—æ˜¯è‡ªåŠ¨ç”Ÿæˆçš„ï¼ŒæŒ‰éœ€æ¿€æ´»ï¼Œçº¢è‰²æ¨¡å—æ˜¯éœ€è¦è‡ªå·±å†™çš„ï¼Œä¹Ÿå°±æ˜¯å¢åŠ ä¸‹ä¾èµ–ï¼Œç¼–å†™ä¸šåŠ¡ç‰¹æœ‰é€»è¾‘ï¼Œå„å±‚ç¤ºæ„å›¾åˆ†åˆ«å¦‚ä¸‹ï¼š API Gateway RPC model ä¸‹é¢æˆ‘ä»¬æ¥ä¸€èµ·å®Œæ•´èµ°ä¸€éå¿«é€Ÿæ„å»ºå¾®æœåŠ¡çš„æµç¨‹ï¼ŒLetâ€™s Go!ğŸƒâ€â™‚ï¸ 4. å‡†å¤‡å·¥ä½œ å®‰è£… etcd, mysql, redis å®‰è£… protoc-gen-go $ go get -u github.com/golang/protobuf/protoc-gen-go@v1.3.2 å®‰è£… protoc $ wget https://github.com/protocolbuffers/protobuf/releases/download/v3.14.0/protoc-3.14.0-linux-x86_64.zip $ unzip protoc-3.14.0-linux-x86_64.zip $ mv bin/protoc /usr/local/bin/ å®‰è£… goctl å·¥å…· $ GO111MODULE=on GOPROXY=https://goproxy.cn/,direct go get -u github.com/zeromicro/go-zero/tools/goctl åˆ›å»ºå·¥ä½œç›®å½• shorturl å’Œ shorturl/api mkdir -p shorturl/api åœ¨ shorturl ç›®å½•ä¸‹æ‰§è¡Œ go mod init shorturl åˆå§‹åŒ– go.mod module shorturl go 1.15 require ( github.com/golang/mock v1.4.3 github.com/golang/protobuf v1.4.2 github.com/zeromicro/go-zero v1.3.0 golang.org/x/net v0.0.0-20200707034311-ab3426394381 google.golang.org/grpc v1.29.1 ) æ³¨æ„ï¼šè¿™é‡Œå¯èƒ½å­˜åœ¨ grpc ç‰ˆæœ¬ä¾èµ–çš„é—®é¢˜ï¼Œå¯ä»¥ç”¨ä»¥ä¸Šé…ç½® 5. ç¼–å†™ API Gateway ä»£ç  åœ¨ shorturl/api ç›®å½•ä¸‹é€šè¿‡ goctl ç”Ÿæˆ api/shorturl.apiï¼š $ goctl api -o shorturl.api ç¼–è¾‘ api/shorturl.apiï¼Œä¸ºäº†ç®€æ´ï¼Œå»é™¤äº†æ–‡ä»¶å¼€å¤´çš„ infoï¼Œä»£ç å¦‚ä¸‹ï¼š type ( expandReq { shorten string `form:\"shorten\"` } expandResp { url string `json:\"url\"` } ) type ( shortenReq { url string `form:\"url\"` } shortenResp { shorten string `json:\"shorten\"` } ) service shorturl-api { @server( handler: ShortenHandler ) get /shorten(shortenReq) returns(shortenResp) @server( handler: ExpandHandler ) get /expand(expandReq) returns(expandResp) } type ç”¨æ³•å’Œ go ä¸€è‡´ï¼Œservice ç”¨æ¥å®šä¹‰ get/post/head/delete ç­‰ api è¯·æ±‚ï¼Œè§£é‡Šå¦‚ä¸‹ï¼š service shorturl-api { è¿™ä¸€è¡Œå®šä¹‰äº† service åå­— @server éƒ¨åˆ†ç”¨æ¥å®šä¹‰ server ç«¯ç”¨åˆ°çš„å±æ€§ handler å®šä¹‰äº†æœåŠ¡ç«¯ handler åå­— get /shorten(shortenReq) returns(shortenResp) å®šä¹‰äº† get æ–¹æ³•çš„è·¯ç”±ã€è¯·æ±‚å‚æ•°ã€è¿”å›å‚æ•°ç­‰ ä½¿ç”¨ goctl ç”Ÿæˆ API Gateway ä»£ç  $ goctl api go -api shorturl.api -dir . ç”Ÿæˆçš„æ–‡ä»¶ç»“æ„å¦‚ä¸‹ï¼š . â”œâ”€â”€ api â”‚ â”œâ”€â”€ etc â”‚ â”‚ â””â”€â”€ shorturl-api.yaml // é…ç½®æ–‡ä»¶ â”‚ â”œâ”€â”€ internal â”‚ â”‚ â”œâ”€â”€ config â”‚ â”‚ â”‚ â””â”€â”€ config.go // å®šä¹‰é…ç½® â”‚ â”‚ â”œâ”€â”€ handler â”‚ â”‚ â”‚ â”œâ”€â”€ expandhandler.go // å®ç° expandHandler â”‚ â”‚ â”‚ â”œâ”€â”€ routes.go // å®šä¹‰è·¯ç”±å¤„ç† â”‚ â”‚ â”‚ â””â”€â”€ shortenhandler.go // å®ç° shortenHandler â”‚ â”‚ â”œâ”€â”€ logic â”‚ â”‚ â”‚ â”œâ”€â”€ expandlogic.go // å®ç° ExpandLogic â”‚ â”‚ â”‚ â””â”€â”€ shortenlogic.go // å®ç° ShortenLogic â”‚ â”‚ â”œâ”€â”€ svc â”‚ â”‚ â”‚ â””â”€â”€ servicecontext.go // å®šä¹‰ ServiceContext â”‚ â”‚ â””â”€â”€ types â”‚ â”‚ â””â”€â”€ types.go // å®šä¹‰è¯·æ±‚ã€è¿”å›ç»“æ„ä½“ â”‚ â”œâ”€â”€ shorturl.api â”‚ â””â”€â”€ shorturl.go // main å…¥å£å®šä¹‰ â”œâ”€â”€ go.mod â””â”€â”€ go.sum å¯åŠ¨ API Gateway æœåŠ¡ï¼Œé»˜è®¤ä¾¦å¬åœ¨ 8888 ç«¯å£ $ go run shorturl.go -f etc/shorturl-api.yaml æµ‹è¯• API Gateway æœåŠ¡ $ curl -i \"http://localhost:8888/shorten?url=http://www.xiaoheiban.cn\" è¿”å›å¦‚ä¸‹ï¼š HTTP/1.1 200 OK Content-Type: application/json Date: Thu, 27 Aug 2020 14:31:39 GMT Content-Length: 15 {\"shorten\":\"\"} å¯ä»¥çœ‹åˆ°æˆ‘ä»¬ API Gateway å…¶å®å•¥ä¹Ÿæ²¡å¹²ï¼Œå°±è¿”å›äº†ä¸ªç©ºå€¼ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬ä¼šåœ¨ rpc æœåŠ¡é‡Œå®ç°ä¸šåŠ¡é€»è¾‘ å¯ä»¥ä¿®æ”¹ internal/svc/servicecontext.go æ¥ä¼ é€’æœåŠ¡ä¾èµ–ï¼ˆå¦‚æœéœ€è¦ï¼‰ å®ç°é€»è¾‘å¯ä»¥ä¿®æ”¹ internal/logic ä¸‹çš„å¯¹åº”æ–‡ä»¶ å¯ä»¥é€šè¿‡ goctl ç”Ÿæˆå„ç§å®¢æˆ·ç«¯è¯­è¨€çš„ api è°ƒç”¨ä»£ç  åˆ°è¿™é‡Œï¼Œä½ å·²ç»å¯ä»¥é€šè¿‡ goctl ç”Ÿæˆå®¢æˆ·ç«¯ä»£ç ç»™å®¢æˆ·ç«¯åŒå­¦å¹¶è¡Œå¼€å‘äº†ï¼Œæ”¯æŒå¤šç§è¯­è¨€ï¼Œè¯¦è§æ–‡æ¡£ 6. ç¼–å†™ transform rpc æœåŠ¡ åœ¨ shorturl ç›®å½•ä¸‹åˆ›å»º rpc ç›®å½• åœ¨ rpc/transform ç›®å½•ä¸‹ç¼–å†™ transform.proto æ–‡ä»¶ å¯ä»¥é€šè¿‡å‘½ä»¤ç”Ÿæˆ proto æ–‡ä»¶æ¨¡æ¿ $ goctl rpc template -o transform.proto ä¿®æ”¹åæ–‡ä»¶å†…å®¹å¦‚ä¸‹ï¼š syntax = \"proto3\"; package transform; message expandReq { string shorten = 1; } message expandResp { string url = 1; } message shortenReq { string url = 1; } message shortenResp { string shorten = 1; } service transformer { rpc expand(expandReq) returns(expandResp); rpc shorten(shortenReq) returns(shortenResp); } ç”¨ goctl ç”Ÿæˆ rpc ä»£ç ï¼Œåœ¨ rpc/transform ç›®å½•ä¸‹æ‰§è¡Œå‘½ä»¤ $ goctl rpc proto -src transform.proto -dir . æ³¨æ„ï¼šä¸èƒ½åœ¨ GOPATH ç›®å½•ä¸‹æ‰§è¡Œä»¥ä¸Šå‘½ä»¤ æ–‡ä»¶ç»“æ„å¦‚ä¸‹ï¼š rpc/transform â”œâ”€â”€ etc â”‚ â””â”€â”€ transform.yaml // é…ç½®æ–‡ä»¶ â”œâ”€â”€ internal â”‚ â”œâ”€â”€ config â”‚ â”‚ â””â”€â”€ config.go // é…ç½®å®šä¹‰ â”‚ â”œâ”€â”€ logic â”‚ â”‚ â”œâ”€â”€ expandlogic.go // expand ä¸šåŠ¡é€»è¾‘åœ¨è¿™é‡Œå®ç° â”‚ â”‚ â””â”€â”€ shortenlogic.go // shorten ä¸šåŠ¡é€»è¾‘åœ¨è¿™é‡Œå®ç° â”‚ â”œâ”€â”€ server â”‚ â”‚ â””â”€â”€ transformerserver.go // è°ƒç”¨å…¥å£, ä¸éœ€è¦ä¿®æ”¹ â”‚ â””â”€â”€ svc â”‚ â””â”€â”€ servicecontext.go // å®šä¹‰ ServiceContextï¼Œä¼ é€’ä¾èµ– â”œâ”€â”€ pb â”‚ â””â”€â”€ transform.pb.go â”œâ”€â”€ transform.go // rpc æœåŠ¡ main å‡½æ•° â”œâ”€â”€ transform.proto â””â”€â”€ transformer â”œâ”€â”€ transformer.go // æä¾›äº†å¤–éƒ¨è°ƒç”¨æ–¹æ³•ï¼Œæ— éœ€ä¿®æ”¹ â”œâ”€â”€ transformer_mock.go // mock æ–¹æ³•ï¼Œæµ‹è¯•ç”¨ â””â”€â”€ types.go // request/response ç»“æ„ä½“å®šä¹‰ ç›´æ¥å¯ä»¥è¿è¡Œï¼Œå¦‚ä¸‹ï¼š $ go run transform.go -f etc/transform.yaml Starting rpc server at 127.0.0.1:8080... æŸ¥çœ‹æœåŠ¡æ˜¯å¦æ³¨å†Œ $ ETCDCTL_API=3 etcdctl get transform.rpc --prefix transform.rpc/7587851893787585061 127.0.0.1:8080 etc/transform.yaml æ–‡ä»¶é‡Œå¯ä»¥ä¿®æ”¹ä¾¦å¬ç«¯å£ç­‰é…ç½® 7. ä¿®æ”¹ API Gateway ä»£ç è°ƒç”¨ transform rpc æœåŠ¡ ä¿®æ”¹é…ç½®æ–‡ä»¶ shorturl-api.yamlï¼Œå¢åŠ å¦‚ä¸‹å†…å®¹ Transform: Etcd: Hosts: - localhost:2379 Key: transform.rpc é€šè¿‡ etcd è‡ªåŠ¨å»å‘ç°å¯ç”¨çš„ transform æœåŠ¡ ä¿®æ”¹ internal/config/config.go å¦‚ä¸‹ï¼Œå¢åŠ  transform æœåŠ¡ä¾èµ– type Config struct { rest.RestConf Transform zrpc.RpcClientConf // æ‰‹åŠ¨ä»£ç  } ä¿®æ”¹ internal/svc/servicecontext.goï¼Œå¦‚ä¸‹ï¼š type ServiceContext struct { Config config.Config Transformer transformer.Transformer // æ‰‹åŠ¨ä»£ç  } func NewServiceContext(c config.Config) *ServiceContext { return &ServiceContext{ Config: c, Transformer: transformer.NewTransformer(zrpc.MustNewClient(c.Transform)), // æ‰‹åŠ¨ä»£ç  } } é€šè¿‡ ServiceContext åœ¨ä¸åŒä¸šåŠ¡é€»è¾‘ä¹‹é—´ä¼ é€’ä¾èµ– ä¿®æ”¹ internal/logic/expandlogic.go é‡Œçš„ Expand æ–¹æ³•ï¼Œå¦‚ä¸‹ï¼š func (l *ExpandLogic) Expand(req types.ExpandReq) (types.ExpandResp, error) { // æ‰‹åŠ¨ä»£ç å¼€å§‹ resp, err := l.svcCtx.Transformer.Expand(l.ctx, &transformer.ExpandReq{ Shorten: req.Shorten, }) if err != nil { return types.ExpandResp{}, err } return types.ExpandResp{ Url: resp.Url, }, nil // æ‰‹åŠ¨ä»£ç ç»“æŸ } é€šè¿‡è°ƒç”¨ transformer çš„ Expand æ–¹æ³•å®ç°çŸ­é“¾æ¢å¤åˆ° url ä¿®æ”¹ internal/logic/shortenlogic.goï¼Œå¦‚ä¸‹ï¼š func (l *ShortenLogic) Shorten(req types.ShortenReq) (types.ShortenResp, error) { // æ‰‹åŠ¨ä»£ç å¼€å§‹ resp, err := l.svcCtx.Transformer.Shorten(l.ctx, &transformer.ShortenReq{ Url: req.Url, }) if err != nil { return types.ShortenResp{}, err } return types.ShortenResp{ Shorten: resp.Shorten, }, nil // æ‰‹åŠ¨ä»£ç ç»“æŸ } æœ‰çš„ç‰ˆæœ¬ç”Ÿæˆè¿”å›å€¼å¯èƒ½æ˜¯æŒ‡é’ˆç±»å‹ï¼Œéœ€è¦è‡ªå·±è°ƒæ•´ä¸‹ é€šè¿‡è°ƒç”¨ transformer çš„ Shorten æ–¹æ³•å®ç° url åˆ°çŸ­é“¾çš„å˜æ¢ è‡³æ­¤ï¼ŒAPI Gateway ä¿®æ”¹å®Œæˆï¼Œè™½ç„¶è´´çš„ä»£ç å¤šï¼Œä½†æ˜¯å…¶ä¸­ä¿®æ”¹çš„æ˜¯å¾ˆå°‘çš„ä¸€éƒ¨åˆ†ï¼Œä¸ºäº†æ–¹ä¾¿ç†è§£ä¸Šä¸‹æ–‡ï¼Œæˆ‘è´´äº†å®Œæ•´ä»£ç ï¼Œæ¥ä¸‹æ¥å¤„ç† CRUD+cache 8. å®šä¹‰æ•°æ®åº“è¡¨ç»“æ„ï¼Œå¹¶ç”Ÿæˆ CRUD+cache ä»£ç  shorturl ä¸‹åˆ›å»º rpc/transform/model ç›®å½•ï¼šmkdir -p rpc/transform/model åœ¨ rpc/transform/model ç›®å½•ä¸‹ç¼–å†™åˆ›å»º shorturl è¡¨çš„ sql æ–‡ä»¶ shorturl.sqlï¼Œå¦‚ä¸‹ï¼š CREATE TABLE `shorturl` ( `shorten` varchar(255) NOT NULL COMMENT 'shorten key', `url` varchar(255) NOT NULL COMMENT 'original url', PRIMARY KEY(`shorten`) ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4; åˆ›å»º DB å’Œ table create database gozero; source shorturl.sql; åœ¨ rpc/transform/model ç›®å½•ä¸‹æ‰§è¡Œå¦‚ä¸‹å‘½ä»¤ç”Ÿæˆ CRUD+cache ä»£ç ï¼Œ-c è¡¨ç¤ºä½¿ç”¨ redis cache $ goctl model mysql ddl -c -src shorturl.sql -dir . ä¹Ÿå¯ä»¥ç”¨ datasource å‘½ä»¤ä»£æ›¿ ddl æ¥æŒ‡å®šæ•°æ®åº“é“¾æ¥ç›´æ¥ä» schema ç”Ÿæˆ ç”Ÿæˆåçš„æ–‡ä»¶ç»“æ„å¦‚ä¸‹ï¼š Plain Text rpc/transform/model â”œâ”€â”€ shorturl.sql â”œâ”€â”€ shorturlmodel.go // CRUD+cache ä»£ç  â””â”€â”€ vars.go // å®šä¹‰å¸¸é‡å’Œå˜é‡ 9. ä¿®æ”¹ shorten/expand rpc ä»£ç è°ƒç”¨ crud+cache ä»£ç  ä¿®æ”¹ rpc/transform/etc/transform.yamlï¼Œå¢åŠ å¦‚ä¸‹å†…å®¹ï¼š DataSource: root:password@tcp(localhost:3306)/gozero Table: shorturl Cache: - Host: localhost:6379 å¯ä»¥ä½¿ç”¨å¤šä¸ª redis ä½œä¸º cacheï¼Œæ”¯æŒ redis å•ç‚¹æˆ–è€… redis é›†ç¾¤ ä¿®æ”¹ rpc/transform/internal/config/config.goï¼Œå¦‚ä¸‹ï¼š type Config struct { zrpc.RpcServerConf DataSource string // æ‰‹åŠ¨ä»£ç  Table string // æ‰‹åŠ¨ä»£ç  Cache cache.CacheConf // æ‰‹åŠ¨ä»£ç  } å¢åŠ äº† mysql å’Œ redis cache é…ç½® ä¿®æ”¹ rpc/transform/internal/svc/servicecontext.goï¼Œå¦‚ä¸‹ï¼š type ServiceContext struct { c config.Config Model model.ShorturlModel // æ‰‹åŠ¨ä»£ç  } func NewServiceContext(c config.Config) *ServiceContext { return &ServiceContext{ c: c, Model: model.NewShorturlModel(sqlx.NewMysql(c.DataSource), c.Cache), // æ‰‹åŠ¨ä»£ç  } } ä¿®æ”¹ rpc/transform/internal/logic/expandlogic.goï¼Œå¦‚ä¸‹ï¼š func (l *ExpandLogic) Expand(in *transform.ExpandReq) (*transform.ExpandResp, error) { // æ‰‹åŠ¨ä»£ç å¼€å§‹ res, err := l.svcCtx.Model.FindOne(l.ctx, in.Shorten) if err != nil { return nil, err } return &transform.ExpandResp{ Url: res.Url, }, nil // æ‰‹åŠ¨ä»£ç ç»“æŸ } ä¿®æ”¹ rpc/transform/internal/logic/shortenlogic.goï¼Œå¦‚ä¸‹ï¼š func (l *ShortenLogic) Shorten(in *transform.ShortenReq) (*transform.ShortenResp, error) { // æ‰‹åŠ¨ä»£ç å¼€å§‹ï¼Œç”ŸæˆçŸ­é“¾æ¥ key := hash.Md5Hex([]byte(in.Url))[:6] object, _ := l.svcCtx.Model.FindOne(l.ctx, key) if object != nil { return &transform.ShortenResp{ Shorten: key, }, nil } _, err := l.svcCtx.Model.Insert(l.ctx, &model.Shorturl{ Shorten: key, Url: in.Url, }) if err != nil { return nil, err } return &transform.ShortenResp{ Shorten: key, }, nil // æ‰‹åŠ¨ä»£ç ç»“æŸ } è‡³æ­¤ä»£ç ä¿®æ”¹å®Œæˆï¼Œå‡¡æ˜¯æ‰‹åŠ¨ä¿®æ”¹çš„ä»£ç æˆ‘åŠ äº†æ ‡æ³¨ æ³¨æ„ï¼š undefined cacheï¼Œä½ éœ€è¦ import \"github.com/zeromicro/go-zero/core/stores/cache\" undefined model, sqlx, hash ç­‰ï¼Œä½ éœ€è¦åœ¨æ–‡ä»¶ä¸­ import \"shorturl/rpc/transform/model\" import \"github.com/zeromicro/go-zero/core/stores/sqlx\" 10. å®Œæ•´è°ƒç”¨æ¼”ç¤º shorten api è°ƒç”¨ curl -i \"http://localhost:8888/shorten?url=http://www.xiaoheiban.cn\" è¿”å›å¦‚ä¸‹ï¼š HTTP/1.1 200 OK Content-Type: application/json Date: Sat, 29 Aug 2020 10:49:49 GMT Content-Length: 21 {\"shorten\":\"f35b2a\"} expand api è°ƒç”¨ $ curl -i \"http://localhost:8888/expand?shorten=f35b2a\" è¿”å›å¦‚ä¸‹ï¼š HTTP/1.1 200 OK Content-Type: application/json Date: Sat, 29 Aug 2020 10:51:53 GMT Content-Length: 34 {\"url\":\"http://www.xiaoheiban.cn\"} 11. Benchmark å› ä¸ºå†™å…¥ä¾èµ–äº mysql çš„å†™å…¥é€Ÿåº¦ï¼Œå°±ç›¸å½“äºå‹ mysql äº†ï¼Œæ‰€ä»¥å‹æµ‹åªæµ‹è¯•äº† expand æ¥å£ï¼Œç›¸å½“äºä» mysql é‡Œè¯»å–å¹¶åˆ©ç”¨ç¼“å­˜ï¼Œshorten.lua é‡Œéšæœºä» db é‡Œè·å–äº† 100 ä¸ªçƒ­ key æ¥ç”Ÿæˆå‹æµ‹è¯·æ±‚ å¯ä»¥çœ‹å‡ºåœ¨æˆ‘çš„ MacBook Pro ä¸Šèƒ½è¾¾åˆ° 3 ä¸‡ + çš„ qpsã€‚ 12. å®Œæ•´ä»£ç  https://github.com/zeromicro/zero-examples/tree/main/shorturl 12. æ€»ç»“ æˆ‘ä»¬ä¸€ç›´å¼ºè°ƒ å·¥å…·å¤§äºçº¦å®šå’Œæ–‡æ¡£ã€‚ go-zero ä¸åªæ˜¯ä¸€ä¸ªæ¡†æ¶ï¼Œæ›´æ˜¯ä¸€ä¸ªå»ºç«‹åœ¨æ¡†æ¶ + å·¥å…·åŸºç¡€ä¸Šçš„ï¼Œç®€åŒ–å’Œè§„èŒƒäº†æ•´ä¸ªå¾®æœåŠ¡æ„å»ºçš„æŠ€æœ¯ä½“ç³»ã€‚ æˆ‘ä»¬åœ¨ä¿æŒç®€å•çš„åŒæ—¶ä¹Ÿå°½å¯èƒ½æŠŠå¾®æœåŠ¡æ²»ç†çš„å¤æ‚åº¦å°è£…åˆ°äº†æ¡†æ¶å†…éƒ¨ï¼Œæå¤§çš„é™ä½äº†å¼€å‘äººå‘˜çš„å¿ƒæ™ºè´Ÿæ‹…ï¼Œä½¿å¾—ä¸šåŠ¡å¼€å‘å¾—ä»¥å¿«é€Ÿæ¨è¿›ã€‚ é€šè¿‡ go-zero+goctl ç”Ÿæˆçš„ä»£ç ï¼ŒåŒ…å«äº†å¾®æœåŠ¡æ²»ç†çš„å„ç§ç»„ä»¶ï¼ŒåŒ…æ‹¬ï¼šå¹¶å‘æ§åˆ¶ã€è‡ªé€‚åº”ç†”æ–­ã€è‡ªé€‚åº”é™è½½ã€è‡ªåŠ¨ç¼“å­˜æ§åˆ¶ç­‰ï¼Œå¯ä»¥è½»æ¾éƒ¨ç½²ä»¥æ‰¿è½½å·¨å¤§è®¿é—®é‡ã€‚ æœ‰ä»»ä½•å¥½çš„æå‡å·¥ç¨‹æ•ˆç‡çš„æƒ³æ³•ï¼Œéšæ—¶æ¬¢è¿äº¤æµï¼ğŸ‘ Copyright Â© 2019-2021 go-zero all right reservedï¼Œpowered by GitbookLast UpdateTimeï¼š 2025-05-05 05:44:52 "},"breaker-algorithms.html":{"url":"breaker-algorithms.html","title":"ç†”æ–­åŸç†ä¸å®ç°","keywords":"","body":"ç†”æ–­åŸç†ä¸å®ç° åœ¨å¾®æœåŠ¡ä¸­æœåŠ¡é—´ä¾èµ–éå¸¸å¸¸è§ï¼Œæ¯”å¦‚è¯„è®ºæœåŠ¡ä¾èµ–å®¡æ ¸æœåŠ¡è€Œå®¡æ ¸æœåŠ¡åˆä¾èµ–ååƒåœ¾æœåŠ¡ï¼Œå½“è¯„è®ºæœåŠ¡è°ƒç”¨å®¡æ ¸æœåŠ¡æ—¶ï¼Œå®¡æ ¸æœåŠ¡åˆè°ƒç”¨ååƒåœ¾æœåŠ¡ï¼Œè€Œè¿™æ—¶ååƒåœ¾æœåŠ¡è¶…æ—¶äº†ï¼Œç”±äºå®¡æ ¸æœåŠ¡ä¾èµ–ååƒåœ¾æœåŠ¡ï¼Œååƒåœ¾æœåŠ¡è¶…æ—¶å¯¼è‡´å®¡æ ¸æœåŠ¡é€»è¾‘ä¸€ç›´ç­‰å¾…ï¼Œè€Œè¿™ä¸ªæ—¶å€™è¯„è®ºæœåŠ¡åˆåœ¨ä¸€ç›´è°ƒç”¨å®¡æ ¸æœåŠ¡ï¼Œå®¡æ ¸æœåŠ¡å°±æœ‰å¯èƒ½å› ä¸ºå †ç§¯äº†å¤§é‡è¯·æ±‚è€Œå¯¼è‡´æœåŠ¡å®•æœº ç”±æ­¤å¯è§ï¼Œåœ¨æ•´ä¸ªè°ƒç”¨é“¾ä¸­ï¼Œä¸­é—´çš„æŸä¸€ä¸ªç¯èŠ‚å‡ºç°å¼‚å¸¸å°±ä¼šå¼•èµ·ä¸Šæ¸¸è°ƒç”¨æœåŠ¡å‡ºç°ä¸€äº›åˆ—çš„é—®é¢˜ï¼Œç”šè‡³å¯¼è‡´æ•´ä¸ªè°ƒç”¨é“¾çš„æœåŠ¡éƒ½å®•æœºï¼Œè¿™æ˜¯éå¸¸å¯æ€•çš„ã€‚å› æ­¤ä¸€ä¸ªæœåŠ¡ä½œä¸ºè°ƒç”¨æ–¹è°ƒç”¨å¦ä¸€ä¸ªæœåŠ¡æ—¶ï¼Œä¸ºäº†é˜²æ­¢è¢«è°ƒç”¨æœåŠ¡å‡ºç°é—®é¢˜è¿›è€Œå¯¼è‡´è°ƒç”¨æœåŠ¡å‡ºç°é—®é¢˜ï¼Œæ‰€ä»¥è°ƒç”¨æœåŠ¡éœ€è¦è¿›è¡Œè‡ªæˆ‘ä¿æŠ¤ï¼Œè€Œä¿æŠ¤çš„å¸¸ç”¨æ‰‹æ®µå°±æ˜¯ç†”æ–­ ç†”æ–­å™¨åŸç† ç†”æ–­æœºåˆ¶å…¶å®æ˜¯å‚è€ƒäº†æˆ‘ä»¬æ—¥å¸¸ç”Ÿæ´»ä¸­çš„ä¿é™©ä¸çš„ä¿æŠ¤æœºåˆ¶ï¼Œå½“ç”µè·¯è¶…è´Ÿè·è¿è¡Œæ—¶ï¼Œä¿é™©ä¸ä¼šè‡ªåŠ¨çš„æ–­å¼€ï¼Œä»è€Œä¿è¯ç”µè·¯ä¸­çš„ç”µå™¨ä¸å—æŸå®³ã€‚è€ŒæœåŠ¡æ²»ç†ä¸­çš„ç†”æ–­æœºåˆ¶ï¼ŒæŒ‡çš„æ˜¯åœ¨å‘èµ·æœåŠ¡è°ƒç”¨çš„æ—¶å€™ï¼Œå¦‚æœè¢«è°ƒç”¨æ–¹è¿”å›çš„é”™è¯¯ç‡è¶…è¿‡ä¸€å®šçš„é˜ˆå€¼ï¼Œé‚£ä¹ˆåç»­çš„è¯·æ±‚å°†ä¸ä¼šçœŸæ­£å‘èµ·è¯·æ±‚ï¼Œè€Œæ˜¯åœ¨è°ƒç”¨æ–¹ç›´æ¥è¿”å›é”™è¯¯ åœ¨è¿™ç§æ¨¡å¼ä¸‹ï¼ŒæœåŠ¡è°ƒç”¨æ–¹ä¸ºæ¯ä¸€ä¸ªè°ƒç”¨æœåŠ¡(è°ƒç”¨è·¯å¾„)ç»´æŠ¤ä¸€ä¸ªçŠ¶æ€æœºï¼Œåœ¨è¿™ä¸ªçŠ¶æ€æœºä¸­æœ‰ä¸‰ä¸ªçŠ¶æ€ï¼š å…³é—­(Closed)ï¼šåœ¨è¿™ç§çŠ¶æ€ä¸‹ï¼Œæˆ‘ä»¬éœ€è¦ä¸€ä¸ªè®¡æ•°å™¨æ¥è®°å½•è°ƒç”¨å¤±è´¥çš„æ¬¡æ•°å’Œæ€»çš„è¯·æ±‚æ¬¡æ•°ï¼Œå¦‚æœåœ¨æŸä¸ªæ—¶é—´çª—å£å†…ï¼Œå¤±è´¥çš„å¤±è´¥ç‡è¾¾åˆ°é¢„è®¾çš„é˜ˆå€¼ï¼Œåˆ™åˆ‡æ¢åˆ°æ–­å¼€çŠ¶æ€ï¼Œæ­¤æ—¶å¼€å¯ä¸€ä¸ªè¶…æ—¶æ—¶é—´ï¼Œå½“åˆ°è¾¾è¯¥æ—¶é—´åˆ™åˆ‡æ¢åˆ°åŠå…³é—­çŠ¶æ€ï¼Œè¯¥è¶…æ—¶æ—¶é—´æ˜¯ç»™äº†ç³»ç»Ÿä¸€æ¬¡æœºä¼šæ¥ä¿®æ­£å¯¼è‡´è°ƒç”¨å¤±è´¥çš„é”™è¯¯ï¼Œä»¥å›åˆ°æ­£å¸¸çš„å·¥ä½œçŠ¶æ€ã€‚åœ¨å…³é—­çŠ¶æ€ä¸‹ï¼Œè°ƒç”¨é”™è¯¯æ˜¯åŸºäºæ—¶é—´çš„ï¼Œåœ¨ç‰¹å®šçš„æ—¶é—´é—´éš”å†…ä¼šé‡ç½®ï¼Œè¿™èƒ½å¤Ÿé˜²æ­¢å¶ç„¶é”™è¯¯å¯¼è‡´ç†”æ–­å™¨è¿›å»æ–­å¼€çŠ¶æ€ æ‰“å¼€(Open)ï¼šåœ¨è¯¥çŠ¶æ€ä¸‹ï¼Œå‘èµ·è¯·æ±‚æ—¶ä¼šç«‹å³è¿”å›é”™è¯¯ï¼Œä¸€èˆ¬ä¼šå¯åŠ¨ä¸€ä¸ªè¶…æ—¶è®¡æ—¶å™¨ï¼Œå½“è®¡æ—¶å™¨è¶…æ—¶åï¼ŒçŠ¶æ€åˆ‡æ¢åˆ°åŠæ‰“å¼€çŠ¶æ€ï¼Œä¹Ÿå¯ä»¥è®¾ç½®ä¸€ä¸ªå®šæ—¶å™¨ï¼Œå®šæœŸçš„æ¢æµ‹æœåŠ¡æ˜¯å¦æ¢å¤ åŠæ‰“å¼€(Half-Open)ï¼šåœ¨è¯¥çŠ¶æ€ä¸‹ï¼Œå…è®¸åº”ç”¨ç¨‹åºä¸€å®šæ•°é‡çš„è¯·æ±‚å‘å¾€è¢«è°ƒç”¨æœåŠ¡ï¼Œå¦‚æœè¿™äº›è°ƒç”¨æ­£å¸¸ï¼Œé‚£ä¹ˆå¯ä»¥è®¤ä¸ºè¢«è°ƒç”¨æœåŠ¡å·²ç»æ¢å¤æ­£å¸¸ï¼Œæ­¤æ—¶ç†”æ–­å™¨åˆ‡æ¢åˆ°å…³é—­çŠ¶æ€ï¼ŒåŒæ—¶éœ€è¦é‡ç½®è®¡æ•°ã€‚å¦‚æœè¿™éƒ¨åˆ†ä»æœ‰è°ƒç”¨å¤±è´¥çš„æƒ…å†µï¼Œåˆ™è®¤ä¸ºè¢«è°ƒç”¨æ–¹ä»ç„¶æ²¡æœ‰æ¢å¤ï¼Œç†”æ–­å™¨ä¼šåˆ‡æ¢åˆ°æ‰“å¼€çŠ¶æ€ï¼Œç„¶åé‡ç½®è®¡æ•°å™¨ï¼ŒåŠæ‰“å¼€çŠ¶æ€èƒ½å¤Ÿæœ‰æ•ˆé˜²æ­¢æ­£åœ¨æ¢å¤ä¸­çš„æœåŠ¡è¢«çªç„¶å¤§é‡è¯·æ±‚å†æ¬¡æ‰“å® æœåŠ¡æ²»ç†ä¸­å¼•å…¥ç†”æ–­æœºåˆ¶ï¼Œä½¿å¾—ç³»ç»Ÿæ›´åŠ ç¨³å®šå’Œæœ‰å¼¹æ€§ï¼Œåœ¨ç³»ç»Ÿä»é”™è¯¯ä¸­æ¢å¤çš„æ—¶å€™æä¾›ç¨³å®šæ€§ï¼Œå¹¶ä¸”å‡å°‘äº†é”™è¯¯å¯¹ç³»ç»Ÿæ€§èƒ½çš„å½±å“ï¼Œå¯ä»¥å¿«é€Ÿæ‹’ç»å¯èƒ½å¯¼è‡´é”™è¯¯çš„æœåŠ¡è°ƒç”¨ï¼Œè€Œä¸éœ€è¦ç­‰å¾…çœŸæ­£çš„é”™è¯¯è¿”å› ç†”æ–­å™¨å¼•å…¥ ä¸Šé¢ä»‹ç»äº†ç†”æ–­å™¨çš„åŸç†ï¼Œåœ¨äº†è§£å®ŒåŸç†åï¼Œä½ æ˜¯å¦æœ‰æ€è€ƒæˆ‘ä»¬å¦‚ä½•å¼•å…¥ç†”æ–­å™¨å‘¢ï¼Ÿä¸€ç§æ–¹æ¡ˆæ˜¯åœ¨ä¸šåŠ¡é€»è¾‘ä¸­å¯ä»¥åŠ å…¥ç†”æ–­å™¨ï¼Œä½†æ˜¾ç„¶æ˜¯ä¸å¤Ÿä¼˜é›…ä¹Ÿä¸å¤Ÿé€šç”¨çš„ï¼Œå› æ­¤æˆ‘ä»¬éœ€è¦æŠŠç†”æ–­å™¨é›†æˆåœ¨æ¡†æ¶å†…ï¼Œåœ¨zRPCæ¡†æ¶å†…å°±å†…ç½®äº†ç†”æ–­å™¨ æˆ‘ä»¬çŸ¥é“ï¼Œç†”æ–­å™¨ä¸»è¦æ˜¯ç”¨æ¥ä¿æŠ¤è°ƒç”¨ç«¯ï¼Œè°ƒç”¨ç«¯åœ¨å‘èµ·è¯·æ±‚çš„æ—¶å€™éœ€è¦å…ˆç»è¿‡ç†”æ–­å™¨ï¼Œè€Œå®¢æˆ·ç«¯æ‹¦æˆªå™¨æ­£å¥½å…¼å…·äº†è¿™ä¸ªè¿™ä¸ªåŠŸèƒ½ï¼Œæ‰€ä»¥åœ¨zRPCæ¡†æ¶å†…ç†”æ–­å™¨æ˜¯å®ç°åœ¨å®¢æˆ·ç«¯æ‹¦æˆªå™¨å†…ï¼Œæ‹¦æˆªå™¨çš„åŸç†å¦‚ä¸‹å›¾ï¼š å¯¹åº”çš„ä»£ç ä¸ºï¼š func BreakerInterceptor(ctx context.Context, method string, req, reply interface{}, cc *grpc.ClientConn, invoker grpc.UnaryInvoker, opts ...grpc.CallOption) error { // åŸºäºè¯·æ±‚æ–¹æ³•è¿›è¡Œç†”æ–­ breakerName := path.Join(cc.Target(), method) return breaker.DoWithAcceptable(breakerName, func() error { // çœŸæ­£å‘èµ·è°ƒç”¨ return invoker(ctx, method, req, reply, cc, opts...) // codes.Acceptableåˆ¤æ–­å“ªç§é”™è¯¯éœ€è¦åŠ å…¥ç†”æ–­é”™è¯¯è®¡æ•° }, codes.Acceptable) } ç†”æ–­å™¨å®ç° zRPCä¸­ç†”æ–­å™¨çš„å®ç°å‚è€ƒäº†Google Sreè¿‡è½½ä¿æŠ¤ç®—æ³•ï¼Œè¯¥ç®—æ³•çš„åŸç†å¦‚ä¸‹ï¼š è¯·æ±‚æ•°é‡(requests)ï¼šè°ƒç”¨æ–¹å‘èµ·è¯·æ±‚çš„æ•°é‡æ€»å’Œ è¯·æ±‚æ¥å—æ•°é‡(accepts)ï¼šè¢«è°ƒç”¨æ–¹æ­£å¸¸å¤„ç†çš„è¯·æ±‚æ•°é‡ åœ¨æ­£å¸¸æƒ…å†µä¸‹ï¼Œè¿™ä¸¤ä¸ªå€¼æ˜¯ç›¸ç­‰çš„ï¼Œéšç€è¢«è°ƒç”¨æ–¹æœåŠ¡å‡ºç°å¼‚å¸¸å¼€å§‹æ‹’ç»è¯·æ±‚ï¼Œè¯·æ±‚æ¥å—æ•°é‡(accepts)çš„å€¼å¼€å§‹é€æ¸å°äºè¯·æ±‚æ•°é‡(requests)ï¼Œè¿™ä¸ªæ—¶å€™è°ƒç”¨æ–¹å¯ä»¥ç»§ç»­å‘é€è¯·æ±‚ï¼Œç›´åˆ°requests = K * acceptsï¼Œä¸€æ—¦è¶…è¿‡è¿™ä¸ªé™åˆ¶ï¼Œç†”æ–­å™¨å°±å›æ‰“å¼€ï¼Œæ–°çš„è¯·æ±‚ä¼šåœ¨æœ¬åœ°ä»¥ä¸€å®šçš„æ¦‚ç‡è¢«æŠ›å¼ƒç›´æ¥è¿”å›é”™è¯¯ï¼Œæ¦‚ç‡çš„è®¡ç®—å…¬å¼å¦‚ä¸‹ï¼š é€šè¿‡ä¿®æ”¹ç®—æ³•ä¸­çš„K(å€å€¼)ï¼Œå¯ä»¥è°ƒèŠ‚ç†”æ–­å™¨çš„æ•æ„Ÿåº¦ï¼Œå½“é™ä½è¯¥å€å€¼ä¼šä½¿è‡ªé€‚åº”ç†”æ–­ç®—æ³•æ›´æ•æ„Ÿï¼Œå½“å¢åŠ è¯¥å€å€¼ä¼šä½¿å¾—è‡ªé€‚åº”ç†”æ–­ç®—æ³•é™ä½æ•æ„Ÿåº¦ï¼Œä¸¾ä¾‹æ¥è¯´ï¼Œå‡è®¾å°†è°ƒç”¨æ–¹çš„è¯·æ±‚ä¸Šé™ä» requests = 2 acceptst è°ƒæ•´ä¸º requests = 1.1 accepts é‚£ä¹ˆå°±æ„å‘³ç€è°ƒç”¨æ–¹æ¯åä¸ªè¯·æ±‚ä¹‹ä¸­å°±æœ‰ä¸€ä¸ªè¯·æ±‚ä¼šè§¦å‘ç†”æ–­ ä»£ç è·¯å¾„ä¸ºgo-zero/core/breaker type googleBreaker struct { k float64 // å€å€¼ é»˜è®¤1.5 stat *collection.RollingWindow // æ»‘åŠ¨æ—¶é—´çª—å£ï¼Œç”¨æ¥å¯¹è¯·æ±‚å¤±è´¥å’ŒæˆåŠŸè®¡æ•° proba *mathx.Proba // åŠ¨æ€æ¦‚ç‡ } è‡ªé€‚åº”ç†”æ–­ç®—æ³•å®ç° func (b *googleBreaker) accept() error { accepts, total := b.history() // è¯·æ±‚æ¥å—æ•°é‡å’Œè¯·æ±‚æ€»é‡ weightedAccepts := b.k * float64(accepts) // è®¡ç®—ä¸¢å¼ƒè¯·æ±‚æ¦‚ç‡ dropRatio := math.Max(0, (float64(total-protection)-weightedAccepts)/float64(total+1)) if dropRatio æ¯æ¬¡å‘èµ·è¯·æ±‚ä¼šè°ƒç”¨doReqæ–¹æ³•ï¼Œåœ¨è¿™ä¸ªæ–¹æ³•ä¸­é¦–å…ˆé€šè¿‡acceptæ•ˆéªŒæ˜¯å¦è§¦å‘ç†”æ–­ï¼Œacceptableç”¨æ¥åˆ¤æ–­å“ªäº›errorä¼šè®¡å…¥å¤±è´¥è®¡æ•°ï¼Œå®šä¹‰å¦‚ä¸‹ï¼š func Acceptable(err error) bool { switch status.Code(err) { case codes.DeadlineExceeded, codes.Internal, codes.Unavailable, codes.DataLoss: // å¼‚å¸¸è¯·æ±‚é”™è¯¯ return false default: return true } } å¦‚æœè¯·æ±‚æ­£å¸¸åˆ™é€šè¿‡markSuccessæŠŠè¯·æ±‚æ•°é‡å’Œè¯·æ±‚æ¥å—æ•°é‡éƒ½åŠ ä¸€ï¼Œå¦‚æœè¯·æ±‚ä¸æ­£å¸¸åˆ™åªæœ‰è¯·æ±‚æ•°é‡ä¼šåŠ ä¸€ func (b *googleBreaker) doReq(req func() error, fallback func(err error) error, acceptable Acceptable) error { // åˆ¤æ–­æ˜¯å¦è§¦å‘ç†”æ–­ if err := b.accept(); err != nil { if fallback != nil { return fallback(err) } else { return err } } defer func() { if e := recover(); e != nil { b.markFailure() panic(e) } }() // æ‰§è¡ŒçœŸæ­£çš„è°ƒç”¨ err := req() // æ­£å¸¸è¯·æ±‚è®¡æ•° if acceptable(err) { b.markSuccess() } else { // å¼‚å¸¸è¯·æ±‚è®¡æ•° b.markFailure() } return err } æ€»ç»“ è°ƒç”¨ç«¯å¯ä»¥é€šè¿‡ç†”æ–­æœºåˆ¶è¿›è¡Œè‡ªæˆ‘ä¿æŠ¤ï¼Œé˜²æ­¢è°ƒç”¨ä¸‹æ¸¸æœåŠ¡å‡ºç°å¼‚å¸¸ï¼Œæˆ–è€…è€—æ—¶è¿‡é•¿å½±å“è°ƒç”¨ç«¯çš„ä¸šåŠ¡é€»è¾‘ï¼Œå¾ˆå¤šåŠŸèƒ½å®Œæ•´çš„å¾®æœåŠ¡æ¡†æ¶éƒ½ä¼šå†…ç½®ç†”æ–­å™¨ã€‚å…¶å®ï¼Œä¸ä»…å¾®æœåŠ¡è°ƒç”¨ä¹‹é—´éœ€è¦ç†”æ–­å™¨ï¼Œåœ¨è°ƒç”¨ä¾èµ–èµ„æºçš„æ—¶å€™ï¼Œæ¯”å¦‚mysqlã€redisç­‰ä¹Ÿå¯ä»¥å¼•å…¥ç†”æ–­å™¨çš„æœºåˆ¶ã€‚ Copyright Â© 2019-2021 go-zero all right reservedï¼Œpowered by GitbookLast UpdateTimeï¼š 2025-05-05 05:44:52 "},"collection.html":{"url":"collection.html","title":"è¿›ç¨‹å†…ç¼“å­˜ç»„ä»¶ collection.Cache","keywords":"","body":"é€šè¿‡ collection.Cache è¿›è¡Œç¼“å­˜ go-zeroå¾®æœåŠ¡æ¡†æ¶ä¸­æä¾›äº†è®¸å¤šå¼€ç®±å³ç”¨çš„å·¥å…·ï¼Œå¥½çš„å·¥å…·ä¸ä»…èƒ½æå‡æœåŠ¡çš„æ€§èƒ½è€Œä¸”è¿˜èƒ½æå‡ä»£ç çš„é²æ£’æ€§é¿å…å‡ºé”™ï¼Œå®ç°ä»£ç é£æ ¼çš„ç»Ÿä¸€æ–¹ä¾¿ä»–äººé˜…è¯»ç­‰ç­‰ï¼Œæœ¬ç³»åˆ—æ–‡ç« å°†åˆ†åˆ«ä»‹ç»go-zeroæ¡†æ¶ä¸­å·¥å…·çš„ä½¿ç”¨åŠå…¶å®ç°åŸç† è¿›ç¨‹å†…ç¼“å­˜å·¥å…·collection.Cache åœ¨åšæœåŠ¡å™¨å¼€å‘çš„æ—¶å€™ï¼Œç›¸ä¿¡éƒ½ä¼šé‡åˆ°ä½¿ç”¨ç¼“å­˜çš„æƒ…å†µï¼Œgo-zero æä¾›çš„ç®€å•çš„ç¼“å­˜å°è£… collection.Cacheï¼Œç®€å•ä½¿ç”¨æ–¹å¼å¦‚ä¸‹ // åˆå§‹åŒ– cacheï¼Œå…¶ä¸­ WithLimit å¯ä»¥æŒ‡å®šæœ€å¤§ç¼“å­˜çš„æ•°é‡ c, err := collection.NewCache(time.Minute, collection.WithLimit(10000)) if err != nil { panic(err) } // è®¾ç½®ç¼“å­˜ c.Set(\"key\", user) // è·å–ç¼“å­˜ï¼Œokï¼šæ˜¯å¦å­˜åœ¨ v, ok := c.Get(\"key\") // åˆ é™¤ç¼“å­˜ c.Del(\"key\") // è·å–ç¼“å­˜ï¼Œå¦‚æœ key ä¸å­˜åœ¨çš„ï¼Œåˆ™ä¼šè°ƒç”¨ func å»ç”Ÿæˆç¼“å­˜ v, err := c.Take(\"key\", func() (interface{}, error) { return user, nil }) cache å®ç°çš„å»ºçš„åŠŸèƒ½åŒ…æ‹¬ ç¼“å­˜è‡ªåŠ¨å¤±æ•ˆï¼Œå¯ä»¥æŒ‡å®šè¿‡æœŸæ—¶é—´ ç¼“å­˜å¤§å°é™åˆ¶ï¼Œå¯ä»¥æŒ‡å®šç¼“å­˜ä¸ªæ•° ç¼“å­˜å¢åˆ æ”¹ ç¼“å­˜å‘½ä¸­ç‡ç»Ÿè®¡ å¹¶å‘å®‰å…¨ ç¼“å­˜å‡»ç©¿ å®ç°åŸç†ï¼š Cache è‡ªåŠ¨å¤±æ•ˆï¼Œæ˜¯é‡‡ç”¨ TimingWheel(https://github.com/zeromicro/zeromicro/blob/master/core/collection/timingwheel.go) è¿›è¡Œç®¡ç†çš„ timingWheel, err := NewTimingWheel(time.Second, slots, func(k, v interface{}) { key, ok := k.(string) if !ok { return } cache.Del(key) }) Cache å¤§å°é™åˆ¶ï¼Œæ˜¯é‡‡ç”¨ LRU æ·˜æ±°ç­–ç•¥ï¼Œåœ¨æ–°å¢ç¼“å­˜çš„æ—¶å€™ä¼šå»æ£€æŸ¥æ˜¯å¦å·²ç»è¶…å‡ºè¿‡é™åˆ¶ï¼Œå…·ä½“ä»£ç åœ¨ keyLru ä¸­å®ç° func (klru *keyLru) add(key string) { if elem, ok := klru.elements[key]; ok { klru.evicts.MoveToFront(elem) return } // Add new item elem := klru.evicts.PushFront(key) klru.elements[key] = elem // Verify size not exceeded if klru.evicts.Len() > klru.limit { klru.removeOldest() } } Cache çš„å‘½ä¸­ç‡ç»Ÿè®¡ï¼Œæ˜¯åœ¨ä»£ç ä¸­å®ç° cacheStat,åœ¨ç¼“å­˜å‘½ä¸­ä¸¢å¤±çš„æ—¶å€™è‡ªåŠ¨ç»Ÿè®¡ï¼Œå¹¶ä¸”ä¼šå®šæ—¶æ‰“å°ä½¿ç”¨çš„å‘½ä¸­ç‡, qps ç­‰çŠ¶æ€. æ‰“å°çš„å…·ä½“æ•ˆæœå¦‚ä¸‹ cache(proc) - qpm: 2, hit_ratio: 50.0%, elements: 0, hit: 1, miss: 1 ç¼“å­˜å‡»ç©¿åŒ…å«æ˜¯ä½¿ç”¨ syncx.SingleFlight(https://github.com/zeromicro/zeromicro/blob/master/core/syncx/singleflight.go) è¿›è¡Œå®ç°çš„ï¼Œå°±æ˜¯å°†åŒæ—¶è¯·æ±‚åŒä¸€ä¸ª key çš„è¯·æ±‚, å…³äº SingleFlight åç»­ä¼šç»§ç»­è¡¥å……ã€‚ ç›¸å…³å…·ä½“å®ç°æ˜¯åœ¨: func (c *Cache) Take(key string, fetch func() (interface{}, error)) (interface{}, error) { val, fresh, err := c.barrier.DoEx(key, func() (interface{}, error) { v, e := fetch() if e != nil { return nil, e } c.Set(key, v) return v, nil }) if err != nil { return nil, err } if fresh { c.stats.IncrementMiss() return val, nil } else { // got the result from previous ongoing query c.stats.IncrementHit() } return val, nil } æœ¬æ–‡ä¸»è¦ä»‹ç»äº†go-zeroæ¡†æ¶ä¸­çš„ Cache å·¥å…·ï¼Œåœ¨å®é™…çš„é¡¹ç›®ä¸­éå¸¸å®ç”¨ã€‚ç”¨å¥½å·¥å…·å¯¹äºæå‡æœåŠ¡æ€§èƒ½å’Œå¼€å‘æ•ˆç‡éƒ½æœ‰å¾ˆå¤§çš„å¸®åŠ©ï¼Œå¸Œæœ›æœ¬ç¯‡æ–‡ç« èƒ½ç»™å¤§å®¶å¸¦æ¥ä¸€äº›æ”¶è·ã€‚ Copyright Â© 2019-2021 go-zero all right reservedï¼Œpowered by GitbookLast UpdateTimeï¼š 2025-05-05 05:44:52 "},"keywords.html":{"url":"keywords.html","title":"é«˜æ•ˆçš„å…³é”®è¯æ›¿æ¢å’Œæ•æ„Ÿè¯è¿‡æ»¤å·¥å…·","keywords":"","body":"é«˜æ•ˆçš„å…³é”®è¯æ›¿æ¢å’Œæ•æ„Ÿè¯è¿‡æ»¤å·¥å…· 1. ç®—æ³•ä»‹ç» åˆ©ç”¨é«˜æ•ˆçš„Trieæ ‘å»ºç«‹å…³é”®è¯æ ‘ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œç„¶åä¾æ¬¡æŸ¥æ‰¾å­—ç¬¦ä¸²ä¸­çš„ç›¸è¿å­—ç¬¦æ˜¯å¦å½¢æˆæ ‘çš„ä¸€æ¡è·¯å¾„ å‘ç°æ˜é‡‘ä¸Šè¿™ç¯‡æ–‡ç« å†™çš„æ¯”è¾ƒè¯¦ç»†ï¼Œå¯ä»¥ä¸€è¯»ï¼Œå…·ä½“åŸç†åœ¨æ­¤ä¸è¯¦è¿°ã€‚ 2. å…³é”®è¯æ›¿æ¢ æ”¯æŒå…³é”®è¯é‡å ï¼Œè‡ªåŠ¨é€‰ç”¨æœ€çŸ­çš„å…³é”®è¯ï¼Œå¹¶ä¸”åªä¼šå¯¹åŸå§‹å­—ç¬¦ä¸²åªä¼šéå†ä¸€æ¬¡è¿›è¡ŒåŒ¹é…æ›¿æ¢ï¼Œå¦‚æœæ›¿æ¢ç»“æœä¸­åˆå‡ºç°çš„å…³é”®è¯ä¸ä¼šè¢«äºŒæ¬¡æ›¿æ¢ï¼ˆå¦‚æœä¸šåŠ¡ä¸Šæœ‰è¿™ç§å¯èƒ½æ€§ï¼Œè¯·è‡ªè¡Œå¯¹ä¸Šä¸€æ¬¡çš„æ›¿æ¢ç»“æœå†æ¬¡æ‰§è¡Œæ›¿æ¢æ“ä½œï¼‰ï¼Œä»£ç ç¤ºä¾‹å¦‚ä¸‹ï¼š replacer := stringx.NewReplacer(map[string]string{ \"æ—¥æœ¬\": \"æ³•å›½\", \"æ—¥æœ¬çš„é¦–éƒ½\": \"ä¸œäº¬\", \"ä¸œäº¬\": \"æ—¥æœ¬çš„é¦–éƒ½\", }) fmt.Println(replacer.Replace(\"æ—¥æœ¬çš„é¦–éƒ½æ˜¯ä¸œäº¬\")) å¯ä»¥å¾—åˆ°ï¼š ```Plain Text æ³•å›½çš„é¦–éƒ½æ˜¯æ—¥æœ¬çš„é¦–éƒ½ ç¤ºä¾‹ä»£ç è§`stringx/replace/replace.go` ## 3. æŸ¥æ‰¾æ•æ„Ÿè¯ ä»£ç ç¤ºä¾‹å¦‚ä¸‹ï¼š ```go filter := stringx.NewTrie([]string{ \"AVæ¼”å‘˜\", \"è‹äº•ç©º\", \"AV\", \"æ—¥æœ¬AVå¥³ä¼˜\", \"AVæ¼”å‘˜è‰²æƒ…\", }) keywords := filter.FindKeywords(\"æ—¥æœ¬AVæ¼”å‘˜å…¼ç”µè§†ã€ç”µå½±æ¼”å‘˜ã€‚è‹äº•ç©ºAVå¥³ä¼˜æ˜¯xxå‡ºé“, æ—¥æœ¬AVå¥³ä¼˜ä»¬æœ€ç²¾å½©çš„è¡¨æ¼”æ˜¯AVæ¼”å‘˜è‰²æƒ…è¡¨æ¼”\") fmt.Println(keywords) å¯ä»¥å¾—åˆ°ï¼š ```Plain Text [è‹äº•ç©º æ—¥æœ¬AVå¥³ä¼˜ AVæ¼”å‘˜è‰²æƒ… AV AVæ¼”å‘˜] ## 4. æ•æ„Ÿè¯è¿‡æ»¤ ä»£ç ç¤ºä¾‹å¦‚ä¸‹ï¼š ```go filter := stringx.NewTrie([]string{ \"AVæ¼”å‘˜\", \"è‹äº•ç©º\", \"AV\", \"æ—¥æœ¬AVå¥³ä¼˜\", \"AVæ¼”å‘˜è‰²æƒ…\", }, stringx.WithMask('?')) // é»˜è®¤æ›¿æ¢ä¸º* safe, keywords, found := filter.Filter(\"æ—¥æœ¬AVæ¼”å‘˜å…¼ç”µè§†ã€ç”µå½±æ¼”å‘˜ã€‚è‹äº•ç©ºAVå¥³ä¼˜æ˜¯xxå‡ºé“, æ—¥æœ¬AVå¥³ä¼˜ä»¬æœ€ç²¾å½©çš„è¡¨æ¼”æ˜¯AVæ¼”å‘˜è‰²æƒ…è¡¨æ¼”\") fmt.Println(safe) fmt.Println(keywords) fmt.Println(found) å¯ä»¥å¾—åˆ°ï¼š Plain Text æ—¥æœ¬????å…¼ç”µè§†ã€ç”µå½±æ¼”å‘˜ã€‚?????å¥³ä¼˜æ˜¯xxå‡ºé“, ??????ä»¬æœ€ç²¾å½©çš„è¡¨æ¼”æ˜¯??????è¡¨æ¼” [è‹äº•ç©º æ—¥æœ¬AVå¥³ä¼˜ AVæ¼”å‘˜è‰²æƒ… AV AVæ¼”å‘˜] true ç¤ºä¾‹ä»£ç è§stringx/filter/filter.go 5. Benchmark Sentences Keywords Regex go-zero 10000 10000 16min10s 27.2ms Copyright Â© 2019-2021 go-zero all right reservedï¼Œpowered by GitbookLast UpdateTimeï¼š 2025-05-05 05:44:52 "},"loadshedding.html":{"url":"loadshedding.html","title":"æœåŠ¡è‡ªé€‚åº”é™è½½ä¿æŠ¤è®¾è®¡","keywords":"","body":"æœåŠ¡è‡ªé€‚åº”é™è½½ä¿æŠ¤è®¾è®¡ è®¾è®¡ç›®çš„ ä¿è¯ç³»ç»Ÿä¸è¢«è¿‡é‡è¯·æ±‚æ‹–å® åœ¨ä¿è¯ç³»ç»Ÿç¨³å®šçš„å‰æä¸‹ï¼Œå°½å¯èƒ½æä¾›æ›´é«˜çš„ååé‡ è®¾è®¡è€ƒè™‘å› ç´  å¦‚ä½•è¡¡é‡ç³»ç»Ÿè´Ÿè½½ æ˜¯å¦å¤„äºè™šæœºæˆ–å®¹å™¨å†…ï¼Œéœ€è¦è¯»å–cgroupç›¸å…³è´Ÿè½½ ç”¨1000mè¡¨ç¤º100%CPUï¼Œæ¨èä½¿ç”¨800mè¡¨ç¤ºç³»ç»Ÿé«˜è´Ÿè½½ å°½å¯èƒ½å°çš„Overheadï¼Œä¸æ˜¾è‘—å¢åŠ RT ä¸è€ƒè™‘æœåŠ¡æœ¬èº«æ‰€ä¾èµ–çš„DBæˆ–è€…ç¼“å­˜ç³»ç»Ÿé—®é¢˜ï¼Œè¿™ç±»é—®é¢˜é€šè¿‡ç†”æ–­æœºåˆ¶æ¥è§£å†³ æœºåˆ¶è®¾è®¡ è®¡ç®—CPUè´Ÿè½½æ—¶ä½¿ç”¨æ»‘åŠ¨å¹³å‡æ¥é™ä½CPUè´Ÿè½½æŠ–åŠ¨å¸¦æ¥çš„ä¸ç¨³å®šï¼Œå…³äºæ»‘åŠ¨å¹³å‡è§å‚è€ƒèµ„æ–™ æ»‘åŠ¨å¹³å‡å°±æ˜¯å–ä¹‹å‰è¿ç»­Næ¬¡å€¼çš„è¿‘ä¼¼å¹³å‡ï¼ŒNå–å€¼å¯ä»¥é€šè¿‡è¶…å‚betaæ¥å†³å®š å½“CPUè´Ÿè½½å¤§äºæŒ‡å®šå€¼æ—¶è§¦å‘é™è½½ä¿æŠ¤æœºåˆ¶ æ—¶é—´çª—å£æœºåˆ¶ï¼Œç”¨æ»‘åŠ¨çª—å£æœºåˆ¶æ¥è®°å½•ä¹‹å‰æ—¶é—´çª—å£å†…çš„QPSå’ŒRT(response time) æ»‘åŠ¨çª—å£ä½¿ç”¨5ç§’é’Ÿ50ä¸ªæ¡¶çš„æ–¹å¼ï¼Œæ¯ä¸ªæ¡¶ä¿å­˜100msæ—¶é—´å†…çš„è¯·æ±‚ï¼Œå¾ªç¯åˆ©ç”¨ï¼Œæœ€æ–°çš„è¦†ç›–æœ€è€çš„ è®¡ç®—maxQPSå’ŒminRTæ—¶éœ€è¦è¿‡æ»¤æ‰æœ€æ–°çš„æ—¶é—´æ²¡æœ‰ç”¨å®Œçš„æ¡¶ï¼Œé˜²æ­¢æ­¤æ¡¶å†…åªæœ‰æå°‘æ•°è¯·æ±‚ï¼Œå¹¶ä¸”RTå¤„äºä½æ¦‚ç‡çš„æå°å€¼ï¼Œæ‰€ä»¥è®¡ç®—maxQPSå’ŒminRTæ—¶æŒ‰ç…§ä¸Šé¢çš„50ä¸ªæ¡¶çš„å‚æ•°åªä¼šç®—49ä¸ª æ»¡è¶³ä»¥ä¸‹æ‰€æœ‰æ¡ä»¶åˆ™æ‹’ç»è¯¥è¯·æ±‚ å½“å‰CPUè´Ÿè½½è¶…è¿‡é¢„è®¾é˜ˆå€¼ï¼Œæˆ–è€…ä¸Šæ¬¡æ‹’ç»æ—¶é—´åˆ°ç°åœ¨ä¸è¶…è¿‡1ç§’(å†·å´æœŸ)ã€‚å†·å´æœŸæ˜¯ä¸ºäº†ä¸èƒ½è®©è´Ÿè½½åˆšä¸‹æ¥å°±é©¬ä¸Šå¢åŠ å‹åŠ›å¯¼è‡´ç«‹é©¬åˆä¸Šå»çš„æ¥å›æŠ–åŠ¨ averageFlying > max(1, QPS*minRT/1e3) averageFlying = MovingAverage(flying) åœ¨ç®—MovingAverage(flying)çš„æ—¶å€™ï¼Œè¶…å‚betaé»˜è®¤å–å€¼ä¸º0.9ï¼Œè¡¨ç¤ºè®¡ç®—å‰åæ¬¡çš„å¹³å‡flyingå€¼ å–flyingå€¼çš„æ—¶å€™ï¼Œæœ‰ä¸‰ç§åšæ³•ï¼š è¯·æ±‚å¢åŠ åæ›´æ–°ä¸€æ¬¡averageFlyingï¼Œè§å›¾ä¸­æ©™è‰²æ›²çº¿ è¯·æ±‚ç»“æŸåæ›´æ–°ä¸€æ¬¡averageFlyingï¼Œè§å›¾ä¸­ç»¿è‰²æ›²çº¿ è¯·æ±‚å¢åŠ åæ›´æ–°ä¸€æ¬¡averageFlyingï¼Œè¯·æ±‚ç»“æŸåæ›´æ–°ä¸€æ¬¡averageFlying æˆ‘ä»¬ä½¿ç”¨çš„æ˜¯ç¬¬äºŒç§ï¼Œè¿™æ ·å¯ä»¥æ›´å¥½çš„é˜²æ­¢æŠ–åŠ¨ï¼Œå¦‚å›¾ï¼š QPS = maxPass * bucketsPerSecond maxPassè¡¨ç¤ºæ¯ä¸ªæœ‰æ•ˆæ¡¶é‡Œçš„æˆåŠŸçš„requests bucketsPerSecondè¡¨ç¤ºæ¯ç§’æœ‰å¤šå°‘ä¸ªæ¡¶ 1e3è¡¨ç¤º1000æ¯«ç§’ï¼ŒminRTå•ä½ä¹Ÿæ˜¯æ¯«ç§’ï¼ŒQPS*minRT/1e3å¾—åˆ°çš„å°±æ˜¯å¹³å‡æ¯ä¸ªæ—¶é—´ç‚¹æœ‰å¤šå°‘å¹¶å‘è¯·æ±‚ é™è½½çš„ä½¿ç”¨ å·²ç»åœ¨restå’Œzrpcæ¡†æ¶é‡Œå¢åŠ äº†å¯é€‰æ¿€æ´»é…ç½® CpuThresholdï¼Œå¦‚æœæŠŠå€¼è®¾ç½®ä¸ºå¤§äº0çš„å€¼ï¼Œåˆ™æ¿€æ´»è¯¥æœåŠ¡çš„è‡ªåŠ¨é™è½½æœºåˆ¶ å¦‚æœè¯·æ±‚è¢«dropï¼Œé‚£ä¹ˆé”™è¯¯æ—¥å¿—é‡Œä¼šæœ‰dropreqå…³é”®å­— å‚è€ƒèµ„æ–™ æ»‘åŠ¨å¹³å‡ Sentinelè‡ªé€‚åº”é™æµ Kratosè‡ªé€‚åº”é™æµä¿æŠ¤ Copyright Â© 2019-2021 go-zero all right reservedï¼Œpowered by GitbookLast UpdateTimeï¼š 2025-05-05 05:44:52 "},"mapping.html":{"url":"mapping.html","title":"æ–‡æœ¬åºåˆ—åŒ–å’Œååºåˆ—åŒ–","keywords":"","body":"æ–‡æœ¬åºåˆ—åŒ–å’Œååºåˆ—åŒ– go-zeroé’ˆå¯¹æ–‡æœ¬çš„åºåˆ—åŒ–å’Œååºåˆ—åŒ–ä¸»è¦åœ¨ä¸‰ä¸ªåœ°æ–¹ä½¿ç”¨ http apiè¯·æ±‚ä½“çš„ååºåˆ—åŒ– http apiè¿”å›ä½“çš„åºåˆ—åŒ– é…ç½®æ–‡ä»¶çš„ååºåˆ—åŒ– æœ¬æ–‡å‡å®šè¯»è€…å·²ç»å®šä¹‰è¿‡apiæ–‡ä»¶ä»¥åŠä¿®æ”¹è¿‡é…ç½®æ–‡ä»¶ï¼Œå¦‚ä¸ç†Ÿæ‚‰ï¼Œå¯å‚ç…§ å¿«é€Ÿæ„å»ºé«˜å¹¶å‘å¾®æœåŠ¡ å¿«é€Ÿæ„å»ºé«˜å¹¶å‘å¾®æœåŠ¡ 1. http apiè¯·æ±‚ä½“çš„ååºåˆ—åŒ– åœ¨ååºåˆ—åŒ–çš„è¿‡ç¨‹ä¸­çš„é’ˆå¯¹è¯·æ±‚æ•°æ®çš„æ•°æ®æ ¼å¼ä»¥åŠæ•°æ®æ ¡éªŒéœ€æ±‚ï¼Œgo-zeroå®ç°äº†è‡ªå·±çš„ä¸€å¥—ååºåˆ—åŒ–æœºåˆ¶ 1.1 æ•°æ®æ ¼å¼ä»¥è®¢å•order.apiæ–‡ä»¶ä¸ºä¾‹ type ( createOrderReq struct { token string `path:\"token\"` // ç”¨æˆ·token productId string `json:\"productId\"` // å•†å“ID num int `json:\"num\"` // å•†å“æ•°é‡ } createOrderRes struct { success bool `json:\"success\"` // æ˜¯å¦æˆåŠŸ } findOrderReq struct { token string `path:\"token\"` // ç”¨æˆ·token page int `form:\"page\"` // é¡µæ•° pageSize int8 `form:\"pageSize\"` // é¡µå¤§å° } findOrderRes struct { orderInfo []orderInfo `json:\"orderInfo\"` // å•†å“ID } orderInfo struct { productId string `json:\"productId\"` // å•†å“ID productName string `json:\"productName\"` // å•†å“åç§° num int `json:\"num\"` // å•†å“æ•°é‡ } deleteOrderReq struct { id string `path:\"id\"` } deleteOrderRes struct { success bool `json:\"success\"` // æ˜¯å¦æˆåŠŸ } ) service order { @doc( summary: åˆ›å»ºè®¢å• ) @handler CreateOrderHandler post /order/add/:token(createOrderReq) returns(createOrderRes) @doc( summary: è·å–è®¢å• ) @handler FindOrderHandler get /order/find/:token(findOrderReq) returns(findOrderRes) @doc( summary: åˆ é™¤è®¢å• ) @handler: DeleteOrderHandler delete /order/:id(deleteOrderReq) returns(deleteOrderRes) } http apiè¯·æ±‚ä½“çš„ååºåˆ—åŒ–çš„tagæœ‰ä¸‰ç§ï¼š pathï¼šhttp url è·¯å¾„ä¸­å‚æ•°ååºåˆ—åŒ– /order/add/1234567ä¼šè§£æå‡ºæ¥tokenä¸º1234567 formï¼šhttp formè¡¨å•ååºåˆ—åŒ–ï¼Œéœ€è¦ headerå¤´æ·»åŠ  Content-Type: multipart/form-data /order/find/1234567?page=1&pageSize=20ä¼šè§£æå‡ºæ¥tokenä¸º1234567ï¼Œpageä¸º1ï¼ŒpageSizeä¸º20 jsonï¼šhttp request json bodyååºåˆ—åŒ–ï¼Œéœ€è¦ headerå¤´æ·»åŠ  Content-Type: application/json {\"productId\":\"321\",\"num\":1}ä¼šè§£æå‡ºæ¥productIdä¸º321ï¼Œnumä¸º1 1.2 æ•°æ®æ ¡éªŒä»¥ç”¨æˆ·user.apiæ–‡ä»¶ä¸ºä¾‹ type ( createUserReq struct { age int8 `json:\"age,default=20,range=(12:100]\"` // å¹´é¾„ name string `json:\"name\"` // åå­— alias string `json:\"alias,optional\"` // åˆ«å sex string `json:\"sex,options=male|female\"` // æ€§åˆ« avatar string `json:\"avatar,default=default.png\"` // å¤´åƒ } createUserRes struct { success bool `json:\"success\"` // æ˜¯å¦æˆåŠŸ } ) service user { @doc( summary: åˆ›å»ºè®¢å• ) @handler CreateUserHandler post /user/add(createUserReq) returns(createUserRes) } æ•°æ®æ ¡éªŒæœ‰å¾ˆå¤šç§æ–¹å¼ï¼ŒåŒ…æ‹¬ä»¥ä¸‹ä½†ä¸é™ï¼š ageï¼šé»˜è®¤ä¸è¾“å…¥ä¸º20ï¼Œè¾“å…¥åˆ™å–å€¼èŒƒå›´ä¸º(12:100]ï¼Œå‰å¼€åé—­ nameï¼šå¿…å¡«ï¼Œä¸å¯ä¸ºç©º aliasï¼šé€‰å¡«ï¼Œå¯ä¸ºç©º sexï¼šå¿…å¡«ï¼Œå–å€¼ä¸ºmaleæˆ–female avatarï¼šé€‰å¡«ï¼Œé»˜è®¤ä¸ºdefault.png æ›´å¤šè¯¦æƒ…å‚è§unmarshaler_test.go 2. http apiè¿”å›ä½“çš„åºåˆ—åŒ– ä½¿ç”¨å®˜æ–¹é»˜è®¤çš„encoding/jsonåŒ…åºåˆ—åŒ–ï¼Œåœ¨æ­¤ä¸å†ç´¯èµ˜ 3. é…ç½®æ–‡ä»¶çš„ååºåˆ—åŒ– é…ç½®æ–‡ä»¶çš„ååºåˆ—åŒ–å’Œhttp apiè¯·æ±‚ä½“çš„ååºåˆ—åŒ–ä½¿ç”¨åŒä¸€å¥—è§£æè§„åˆ™ï¼Œå¯å‚ç…§http apiè¯·æ±‚ä½“çš„ååºåˆ—åŒ– Copyright Â© 2019-2021 go-zero all right reservedï¼Œpowered by GitbookLast UpdateTimeï¼š 2025-05-05 05:44:52 "},"mapreduce.html":{"url":"mapreduce.html","title":"å¹¶å‘å¤„ç†å·¥å…· MapReduce","keywords":"","body":"é€šè¿‡MapReduceé™ä½æœåŠ¡å“åº”æ—¶é—´ åœ¨å¾®æœåŠ¡ä¸­å¼€å‘ä¸­ï¼Œapiç½‘å…³æ‰®æ¼”å¯¹å¤–æä¾›restful apiçš„è§’è‰²ï¼Œè€Œapiçš„æ•°æ®å¾€å¾€ä¼šä¾èµ–å…¶ä»–æœåŠ¡ï¼Œå¤æ‚çš„apiæ›´æ˜¯ä¼šä¾èµ–å¤šä¸ªç”šè‡³æ•°åä¸ªæœåŠ¡ã€‚è™½ç„¶å•ä¸ªè¢«ä¾èµ–æœåŠ¡çš„è€—æ—¶ä¸€èˆ¬éƒ½æ¯”è¾ƒä½ï¼Œä½†å¦‚æœå¤šä¸ªæœåŠ¡ä¸²è¡Œä¾èµ–çš„è¯é‚£ä¹ˆæ•´ä¸ªapiçš„è€—æ—¶å°†ä¼šå¤§å¤§å¢åŠ ã€‚ é‚£ä¹ˆé€šè¿‡ä»€ä¹ˆæ‰‹æ®µæ¥ä¼˜åŒ–å‘¢ï¼Ÿæˆ‘ä»¬é¦–å…ˆæƒ³åˆ°çš„æ˜¯é€šè¿‡å¹¶å‘æ¥çš„æ–¹å¼æ¥å¤„ç†ä¾èµ–ï¼Œè¿™æ ·å°±èƒ½é™ä½æ•´ä¸ªä¾èµ–çš„è€—æ—¶ï¼ŒGoåŸºç¡€åº“ä¸­ä¸ºæˆ‘ä»¬æä¾›äº† WaitGroup å·¥å…·ç”¨æ¥è¿›è¡Œå¹¶å‘æ§åˆ¶ï¼Œä½†å®é™…ä¸šåŠ¡åœºæ™¯ä¸­å¤šä¸ªä¾èµ–å¦‚æœæœ‰ä¸€ä¸ªå‡ºé”™æˆ‘ä»¬æœŸæœ›èƒ½ç«‹å³è¿”å›è€Œä¸æ˜¯ç­‰æ‰€æœ‰ä¾èµ–éƒ½æ‰§è¡Œå®Œå†è¿”å›ç»“æœï¼Œè€Œä¸”WaitGroupä¸­å¯¹å˜é‡çš„èµ‹å€¼å¾€å¾€éœ€è¦åŠ é”ï¼Œæ¯ä¸ªä¾èµ–å‡½æ•°éƒ½éœ€è¦æ·»åŠ Addå’ŒDoneå¯¹äºæ–°æ‰‹æ¥è¯´æ¯”è¾ƒå®¹æ˜“å‡ºé”™ åŸºäºä»¥ä¸Šçš„èƒŒæ™¯ï¼Œgo-zeroæ¡†æ¶ä¸­ä¸ºæˆ‘ä»¬æä¾›äº†å¹¶å‘å¤„ç†å·¥å…·MapReduceï¼Œè¯¥å·¥å…·å¼€ç®±å³ç”¨ï¼Œä¸éœ€è¦åšä»€ä¹ˆåˆå§‹åŒ–ï¼Œæˆ‘ä»¬é€šè¿‡ä¸‹å›¾çœ‹ä¸‹ä½¿ç”¨MapReduceå’Œæ²¡ä½¿ç”¨çš„è€—æ—¶å¯¹æ¯”: ç›¸åŒçš„ä¾èµ–ï¼Œä¸²è¡Œå¤„ç†çš„è¯éœ€è¦200msï¼Œä½¿ç”¨MapReduceåçš„è€—æ—¶ç­‰äºæ‰€æœ‰ä¾èµ–ä¸­æœ€å¤§çš„è€—æ—¶ä¸º100msï¼Œå¯è§MapReduceå¯ä»¥å¤§å¤§é™ä½æœåŠ¡è€—æ—¶ï¼Œè€Œä¸”éšç€ä¾èµ–çš„å¢åŠ æ•ˆæœå°±ä¼šè¶Šæ˜æ˜¾ï¼Œå‡å°‘å¤„ç†è€—æ—¶çš„åŒæ—¶å¹¶ä¸ä¼šå¢åŠ æœåŠ¡å™¨å‹åŠ› å¹¶å‘å¤„ç†å·¥å…·MapReduce MapReduceæ˜¯Googleæå‡ºçš„ä¸€ä¸ªè½¯ä»¶æ¶æ„ï¼Œç”¨äºå¤§è§„æ¨¡æ•°æ®é›†çš„å¹¶è¡Œè¿ç®—ï¼Œgo-zeroä¸­çš„MapReduceå·¥å…·æ­£æ˜¯å€Ÿé‰´äº†è¿™ç§æ¶æ„æ€æƒ³ go-zeroæ¡†æ¶ä¸­çš„MapReduceå·¥å…·ä¸»è¦ç”¨æ¥å¯¹æ‰¹é‡æ•°æ®è¿›è¡Œå¹¶å‘çš„å¤„ç†ï¼Œä»¥æ­¤æ¥æå‡æœåŠ¡çš„æ€§èƒ½ æˆ‘ä»¬é€šè¿‡å‡ ä¸ªç¤ºä¾‹æ¥æ¼”ç¤ºMapReduceçš„ç”¨æ³• MapReduceä¸»è¦æœ‰ä¸‰ä¸ªå‚æ•°ï¼Œç¬¬ä¸€ä¸ªå‚æ•°ä¸ºgenerateç”¨ä»¥ç”Ÿäº§æ•°æ®ï¼Œç¬¬äºŒä¸ªå‚æ•°ä¸ºmapperç”¨ä»¥å¯¹æ•°æ®è¿›è¡Œå¤„ç†ï¼Œç¬¬ä¸‰ä¸ªå‚æ•°ä¸ºreducerç”¨ä»¥å¯¹mapperåçš„æ•°æ®åšèšåˆè¿”å›ï¼Œè¿˜å¯ä»¥é€šè¿‡optsé€‰é¡¹è®¾ç½®å¹¶å‘å¤„ç†çš„çº¿ç¨‹æ•°é‡ åœºæ™¯ä¸€: æŸäº›åŠŸèƒ½çš„ç»“æœå¾€å¾€éœ€è¦ä¾èµ–å¤šä¸ªæœåŠ¡ï¼Œæ¯”å¦‚å•†å“è¯¦æƒ…çš„ç»“æœå¾€å¾€ä¼šä¾èµ–ç”¨æˆ·æœåŠ¡ã€åº“å­˜æœåŠ¡ã€è®¢å•æœåŠ¡ç­‰ç­‰ï¼Œä¸€èˆ¬è¢«ä¾èµ–çš„æœåŠ¡éƒ½æ˜¯ä»¥rpcçš„å½¢å¼å¯¹å¤–æä¾›ï¼Œä¸ºäº†é™ä½ä¾èµ–çš„è€—æ—¶æˆ‘ä»¬å¾€å¾€éœ€è¦å¯¹ä¾èµ–åšå¹¶è¡Œå¤„ç† func productDetail(uid, pid int64) (*ProductDetail, error) { var pd ProductDetail err := mr.Finish(func() (err error) { pd.User, err = userRpc.User(uid) return }, func() (err error) { pd.Store, err = storeRpc.Store(pid) return }, func() (err error) { pd.Order, err = orderRpc.Order(pid) return }) if err != nil { log.Printf(\"product detail error: %v\", err) return nil, err } return &pd, nil } è¯¥ç¤ºä¾‹ä¸­è¿”å›å•†å“è¯¦æƒ…ä¾èµ–äº†å¤šä¸ªæœåŠ¡è·å–æ•°æ®ï¼Œå› æ­¤åšå¹¶å‘çš„ä¾èµ–å¤„ç†ï¼Œå¯¹æ¥å£çš„æ€§èƒ½æœ‰å¾ˆå¤§çš„æå‡ åœºæ™¯äºŒ: å¾ˆå¤šæ—¶å€™æˆ‘ä»¬éœ€è¦å¯¹ä¸€æ‰¹æ•°æ®è¿›è¡Œå¤„ç†ï¼Œæ¯”å¦‚å¯¹ä¸€æ‰¹ç”¨æˆ·idï¼Œæ•ˆéªŒæ¯ä¸ªç”¨æˆ·çš„åˆæ³•æ€§å¹¶ä¸”æ•ˆéªŒè¿‡ç¨‹ä¸­æœ‰ä¸€ä¸ªå‡ºé”™å°±è®¤ä¸ºæ•ˆéªŒå¤±è´¥ï¼Œè¿”å›çš„ç»“æœä¸ºæ•ˆéªŒåˆæ³•çš„ç”¨æˆ·id func checkLegal(uids []int64) ([]int64, error) { r, err := mr.MapReduce(func(source chan è¯¥ç¤ºä¾‹ä¸­ï¼Œå¦‚æœcheckè¿‡ç¨‹å‡ºç°é”™è¯¯åˆ™é€šè¿‡cancelæ–¹æ³•ç»“æŸæ•ˆéªŒè¿‡ç¨‹ï¼Œå¹¶è¿”å›erroræ•´ä¸ªæ•ˆéªŒè¿‡ç¨‹ç»“æŸï¼Œå¦‚æœæŸä¸ªuidæ•ˆéªŒç»“æœä¸ºfalseåˆ™æœ€ç»ˆç»“æœä¸è¿”å›è¯¥uid MapReduceä½¿ç”¨æ³¨æ„äº‹é¡¹ mapperå’Œreducerä¸­éƒ½å¯ä»¥è°ƒç”¨cancelï¼Œå‚æ•°ä¸ºerrorï¼Œè°ƒç”¨åç«‹å³è¿”å›ï¼Œè¿”å›ç»“æœä¸ºnil, error mapperä¸­å¦‚æœä¸è°ƒç”¨writer.Writeåˆ™itemæœ€ç»ˆä¸ä¼šè¢«reducerèšåˆ reducerä¸­å¦‚æœä¸è°ƒç”¨writer.Wirteåˆ™è¿”å›ç»“æœä¸ºnil, ErrReduceNoOutput reducerä¸ºå•çº¿ç¨‹ï¼Œæ‰€æœ‰mapperå‡ºæ¥çš„ç»“æœåœ¨è¿™é‡Œä¸²è¡Œèšåˆ å®ç°åŸç†åˆ†æ: MapReduceä¸­é¦–å…ˆé€šè¿‡buildSourceæ–¹æ³•é€šè¿‡æ‰§è¡Œgenerate(å‚æ•°ä¸ºæ— ç¼“å†²channel)äº§ç”Ÿæ•°æ®ï¼Œå¹¶è¿”å›æ— ç¼“å†²çš„channelï¼Œmapperä¼šä»è¯¥channelä¸­è¯»å–æ•°æ® func buildSource(generate GenerateFunc) chan interface{} { source := make(chan interface{}) go func() { defer close(source) generate(source) }() return source } åœ¨MapReduceWithSourceæ–¹æ³•ä¸­å®šä¹‰äº†cancelæ–¹æ³•ï¼Œmapperå’Œreducerä¸­éƒ½å¯ä»¥è°ƒç”¨è¯¥æ–¹æ³•ï¼Œè°ƒç”¨åä¸»çº¿ç¨‹æ”¶åˆ°closeä¿¡å·ä¼šç«‹é©¬è¿”å› cancel := once(func(err error) { if err != nil { retErr.Set(err) } else { // é»˜è®¤çš„error retErr.Set(ErrCancelWithNil) } drain(source) // è°ƒç”¨close(ouput)ä¸»çº¿ç¨‹æ”¶åˆ°Doneä¿¡å·ï¼Œç«‹é©¬è¿”å› finish() }) åœ¨mapperDispatcheræ–¹æ³•ä¸­è°ƒç”¨äº†executeMappersï¼ŒexecuteMappersæ¶ˆè´¹buildSourceäº§ç”Ÿçš„æ•°æ®ï¼Œæ¯ä¸€ä¸ªiteméƒ½ä¼šèµ·ä¸€ä¸ªgoroutineå•ç‹¬å¤„ç†ï¼Œé»˜è®¤æœ€å¤§å¹¶å‘æ•°ä¸º16ï¼Œå¯ä»¥é€šè¿‡WithWorkersè¿›è¡Œè®¾ç½® var wg sync.WaitGroup defer func() { wg.Wait() // ä¿è¯æ‰€æœ‰çš„iteméƒ½å¤„ç†å®Œæˆ close(collector) }() pool := make(chan lang.PlaceholderType, workers) writer := newGuardedWriter(collector, done) // å°†mapperå¤„ç†å®Œçš„æ•°æ®å†™å…¥collector for { select { case reducerå•goroutineå¯¹æ•°mapperå†™å…¥collectorçš„æ•°æ®è¿›è¡Œå¤„ç†ï¼Œå¦‚æœreducerä¸­æ²¡æœ‰æ‰‹åŠ¨è°ƒç”¨writer.Writeåˆ™æœ€ç»ˆä¼šæ‰§è¡Œfinishæ–¹æ³•å¯¹outputè¿›è¡Œcloseé¿å…æ­»é” go func() { defer func() { if r := recover(); r != nil { cancel(fmt.Errorf(\"%v\", r)) } else { finish() } }() reducer(collector, writer, cancel) }() åœ¨è¯¥å·¥å…·åŒ…ä¸­è¿˜æä¾›äº†è®¸å¤šé’ˆå¯¹ä¸åŒä¸šåŠ¡åœºæ™¯çš„æ–¹æ³•ï¼Œå®ç°åŸç†ä¸MapReduceå¤§åŒå°å¼‚ï¼Œæ„Ÿå…´è¶£çš„åŒå­¦å¯ä»¥æŸ¥çœ‹æºç å­¦ä¹  MapReduceVoid åŠŸèƒ½å’ŒMapReduceç±»ä¼¼ä½†æ²¡æœ‰ç»“æœè¿”å›åªè¿”å›error Finish å¤„ç†å›ºå®šæ•°é‡çš„ä¾èµ–ï¼Œè¿”å›errorï¼Œæœ‰ä¸€ä¸ªerrorç«‹å³è¿”å› FinishVoid å’ŒFinishæ–¹æ³•åŠŸèƒ½ç±»ä¼¼ï¼Œæ²¡æœ‰è¿”å›å€¼ Map åªåšgenerateå’Œmapperå¤„ç†ï¼Œè¿”å›channel MapVoid å’ŒMapåŠŸèƒ½ç±»ä¼¼ï¼Œæ— è¿”å› æœ¬æ–‡ä¸»è¦ä»‹ç»äº†go-zeroæ¡†æ¶ä¸­çš„MapReduceå·¥å…·ï¼Œåœ¨å®é™…çš„é¡¹ç›®ä¸­éå¸¸å®ç”¨ã€‚ç”¨å¥½å·¥å…·å¯¹äºæå‡æœåŠ¡æ€§èƒ½å’Œå¼€å‘æ•ˆç‡éƒ½æœ‰å¾ˆå¤§çš„å¸®åŠ©ï¼Œå¸Œæœ›æœ¬ç¯‡æ–‡ç« èƒ½ç»™å¤§å®¶å¸¦æ¥ä¸€äº›æ”¶è·ã€‚ Copyright Â© 2019-2021 go-zero all right reservedï¼Œpowered by GitbookLast UpdateTimeï¼š 2025-05-05 05:44:52 "},"metric.html":{"url":"metric.html","title":"åŸºäºprometheusçš„å¾®æœåŠ¡æŒ‡æ ‡ç›‘æ§","keywords":"","body":"åŸºäºprometheusçš„å¾®æœåŠ¡æŒ‡æ ‡ç›‘æ§ æœåŠ¡ä¸Šçº¿åæˆ‘ä»¬å¾€å¾€éœ€è¦å¯¹æœåŠ¡è¿›è¡Œç›‘æ§ï¼Œä»¥ä¾¿èƒ½åŠæ—©å‘ç°é—®é¢˜å¹¶åšé’ˆå¯¹æ€§çš„ä¼˜åŒ–ï¼Œç›‘æ§åˆå¯åˆ†ä¸ºå¤šç§å½¢å¼ï¼Œæ¯”å¦‚æ—¥å¿—ç›‘æ§ï¼Œè°ƒç”¨é“¾ç›‘æ§ï¼ŒæŒ‡æ ‡ç›‘æ§ç­‰ç­‰ã€‚è€Œé€šè¿‡æŒ‡æ ‡ç›‘æ§èƒ½æ¸…æ™°çš„è§‚å¯Ÿå‡ºæœåŠ¡æŒ‡æ ‡çš„å˜åŒ–è¶‹åŠ¿ï¼Œäº†è§£æœåŠ¡çš„è¿è¡ŒçŠ¶æ€ï¼Œå¯¹äºä¿è¯æœåŠ¡ç¨³å®šèµ·ç€éå¸¸é‡è¦çš„ä½œç”¨ prometheusæ˜¯ä¸€ä¸ªå¼€æºçš„ç³»ç»Ÿç›‘æ§å’Œå‘Šè­¦å·¥å…·ï¼Œæ”¯æŒå¼ºå¤§çš„æŸ¥è¯¢è¯­è¨€PromQLå…è®¸ç”¨æˆ·å®æ—¶é€‰æ‹©å’Œæ±‡èšæ—¶é—´åºåˆ—æ•°æ®ï¼Œæ—¶é—´åºåˆ—æ•°æ®æ˜¯æœåŠ¡ç«¯é€šè¿‡HTTPåè®®ä¸»åŠ¨æ‹‰å–è·å¾—ï¼Œä¹Ÿå¯ä»¥é€šè¿‡ä¸­é—´ç½‘å…³æ¥æ¨é€æ—¶é—´åºåˆ—æ•°æ®ï¼Œå¯ä»¥é€šè¿‡é™æ€é…ç½®æ–‡ä»¶æˆ–æœåŠ¡å‘ç°æ¥è·å–ç›‘æ§ç›®æ ‡ Prometheus çš„æ¶æ„ Prometheus çš„æ•´ä½“æ¶æ„ä»¥åŠç”Ÿæ€ç³»ç»Ÿç»„ä»¶å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š Prometheus Serverç›´æ¥ä»ç›‘æ§ç›®æ ‡ä¸­æˆ–è€…é—´æ¥é€šè¿‡æ¨é€ç½‘å…³æ¥æ‹‰å–ç›‘æ§æŒ‡æ ‡ï¼Œå®ƒåœ¨æœ¬åœ°å­˜å‚¨æ‰€æœ‰æŠ“å–åˆ°æ ·æœ¬æ•°æ®ï¼Œå¹¶å¯¹æ­¤æ•°æ®æ‰§è¡Œä¸€ç³»åˆ—è§„åˆ™ï¼Œä»¥æ±‡æ€»å’Œè®°å½•ç°æœ‰æ•°æ®çš„æ–°æ—¶é—´åºåˆ—æˆ–ç”Ÿæˆå‘Šè­¦ã€‚å¯ä»¥é€šè¿‡ Grafana æˆ–è€…å…¶ä»–å·¥å…·æ¥å®ç°ç›‘æ§æ•°æ®çš„å¯è§†åŒ– go-zeroåŸºäºprometheusçš„æœåŠ¡æŒ‡æ ‡ç›‘æ§ go-zero æ¡†æ¶ä¸­é›†æˆäº†åŸºäºprometheusçš„æœåŠ¡æŒ‡æ ‡ç›‘æ§ï¼Œä¸‹é¢æˆ‘ä»¬é€šè¿‡go-zeroå®˜æ–¹çš„ç¤ºä¾‹shorturlæ¥æ¼”ç¤ºæ˜¯å¦‚ä½•å¯¹æœåŠ¡æŒ‡æ ‡è¿›è¡Œæ”¶é›†ç›‘æ§çš„ï¼š ç¬¬ä¸€æ­¥éœ€è¦å…ˆå®‰è£…Prometheusï¼Œå®‰è£…æ­¥éª¤è¯·å‚è€ƒå®˜æ–¹æ–‡æ¡£ go-zeroé»˜è®¤ä¸å¼€å¯prometheusç›‘æ§ï¼Œå¼€å¯æ–¹å¼å¾ˆç®€å•ï¼Œåªéœ€è¦åœ¨shorturl-api.yamlæ–‡ä»¶ä¸­å¢åŠ é…ç½®å¦‚ä¸‹ï¼Œå…¶ä¸­Hostä¸ºPrometheus Serveråœ°å€ä¸ºå¿…å¡«é…ç½®ï¼ŒPortç«¯å£ä¸å¡«é»˜è®¤9091ï¼ŒPathä¸ºç”¨æ¥æ‹‰å–æŒ‡æ ‡çš„è·¯å¾„é»˜è®¤ä¸º/metrics Prometheus: Host: 127.0.0.1 Port: 9091 Path: /metrics ç¼–è¾‘prometheusçš„é…ç½®æ–‡ä»¶prometheus.ymlï¼Œæ·»åŠ å¦‚ä¸‹é…ç½®ï¼Œå¹¶åˆ›å»ºtargets.json - job_name: 'file_ds' file_sd_configs: - files: - targets.json ç¼–è¾‘targets.jsonæ–‡ä»¶ï¼Œå…¶ä¸­targetsä¸ºshorturlé…ç½®çš„ç›®æ ‡åœ°å€ï¼Œå¹¶æ·»åŠ äº†å‡ ä¸ªé»˜è®¤çš„æ ‡ç­¾ [ { \"targets\": [\"127.0.0.1:9091\"], \"labels\": { \"job\": \"shorturl-api\", \"app\": \"shorturl-api\", \"env\": \"test\", \"instance\": \"127.0.0.1:8888\" } } ] å¯åŠ¨prometheusæœåŠ¡ï¼Œé»˜è®¤ä¾¦å¬åœ¨9090ç«¯å£ prometheus --config.file=prometheus.yml åœ¨æµè§ˆå™¨è¾“å…¥http://127.0.0.1:9090/ï¼Œç„¶åç‚¹å‡»Status -> Targetså³å¯çœ‹åˆ°çŠ¶æ€ä¸ºUpçš„Jobï¼Œå¹¶ä¸”Lablesæ å¯ä»¥çœ‹åˆ°æˆ‘ä»¬é…ç½®çš„é»˜è®¤çš„æ ‡ç­¾ é€šè¿‡ä»¥ä¸Šå‡ ä¸ªæ­¥éª¤æˆ‘ä»¬å®Œæˆäº†prometheuså¯¹shorturlæœåŠ¡çš„æŒ‡æ ‡ç›‘æ§æ”¶é›†çš„é…ç½®å·¥ä½œï¼Œä¸ºäº†æ¼”ç¤ºç®€å•æˆ‘ä»¬è¿›è¡Œäº†æ‰‹åŠ¨çš„é…ç½®ï¼Œåœ¨å®é™…çš„ç”Ÿäº§ç¯å¢ƒä¸­ä¸€èˆ¬é‡‡ç”¨å®šæ—¶æ›´æ–°é…ç½®æ–‡ä»¶æˆ–è€…æœåŠ¡å‘ç°çš„æ–¹å¼æ¥é…ç½®ç›‘æ§ç›®æ ‡ï¼Œç¯‡å¹…æœ‰é™è¿™é‡Œä¸å±•å¼€è®²è§£ï¼Œæ„Ÿå…´è¶£çš„åŒå­¦è¯·è‡ªè¡ŒæŸ¥çœ‹ç›¸å…³æ–‡æ¡£ go-zeroç›‘æ§çš„æŒ‡æ ‡ç±»å‹ go-zeroä¸­ç›®å‰åœ¨httpçš„ä¸­é—´ä»¶å’Œrpcçš„æ‹¦æˆªå™¨ä¸­æ·»åŠ äº†å¯¹è¯·æ±‚æŒ‡æ ‡çš„ç›‘æ§ã€‚ ä¸»è¦ä»è¯·æ±‚è€—æ—¶å’Œè¯·æ±‚é”™è¯¯ä¸¤ä¸ªç»´åº¦ï¼Œè¯·æ±‚è€—æ—¶é‡‡ç”¨äº†HistogramæŒ‡æ ‡ç±»å‹å®šä¹‰äº†å¤šä¸ªBucketsæ–¹ä¾¿è¿›è¡Œåˆ†ä½ç»Ÿè®¡ï¼Œè¯·æ±‚é”™è¯¯é‡‡ç”¨äº†Counterç±»å‹ï¼Œå¹¶åœ¨http metricä¸­æ·»åŠ äº†pathæ ‡ç­¾rpc metricä¸­æ·»åŠ äº†methodæ ‡ç­¾ä»¥ä¾¿è¿›è¡Œç»†åˆ†ç›‘æ§ã€‚ æ¥ä¸‹æ¥æ¼”ç¤ºå¦‚ä½•æŸ¥çœ‹ç›‘æ§æŒ‡æ ‡ï¼š é¦–å…ˆåœ¨å‘½ä»¤è¡Œå¤šæ¬¡æ‰§è¡Œå¦‚ä¸‹å‘½ä»¤ curl -i \"http://localhost:8888/shorten?url=http://www.xiaoheiban.cn\" æ‰“å¼€Prometheusåˆ‡æ¢åˆ°Graphç•Œé¢ï¼Œåœ¨è¾“å…¥æ¡†ä¸­è¾“å…¥{path=\"/shorten\"}æŒ‡ä»¤ï¼Œå³å¯æŸ¥çœ‹ç›‘æ§æŒ‡æ ‡ï¼Œå¦‚ä¸‹å›¾ æˆ‘ä»¬é€šè¿‡PromQLè¯­æ³•æŸ¥è¯¢è¿‡æ»¤pathä¸º/shortençš„æŒ‡æ ‡ï¼Œç»“æœä¸­æ˜¾ç¤ºäº†æŒ‡æ ‡åä»¥åŠæŒ‡æ ‡æ•°å€¼ï¼Œå…¶ä¸­http_server_requests_code_totalæŒ‡æ ‡ä¸­codeå€¼ä¸ºhttpçš„çŠ¶æ€ç ï¼Œ200è¡¨æ˜è¯·æ±‚æˆåŠŸï¼Œhttp_server_requests_duration_ms_bucketä¸­å¯¹ä¸åŒbucketç»“æœåˆ†åˆ«è¿›è¡Œäº†ç»Ÿè®¡ï¼Œè¿˜å¯ä»¥çœ‹åˆ°æ‰€æœ‰çš„æŒ‡æ ‡ä¸­éƒ½æ·»åŠ äº†æˆ‘ä»¬é…ç½®çš„é»˜è®¤æŒ‡æ ‡ Consoleç•Œé¢ä¸»è¦å±•ç¤ºäº†æŸ¥è¯¢çš„æŒ‡æ ‡ç»“æœï¼ŒGraphç•Œé¢ä¸ºæˆ‘ä»¬æä¾›äº†ç®€å•çš„å›¾å½¢åŒ–çš„å±•ç¤ºç•Œé¢ï¼Œåœ¨å®é™…çš„ç”Ÿäº§ç¯å¢ƒä¸­æˆ‘ä»¬ä¸€èˆ¬ä½¿ç”¨Grafanaåšå›¾å½¢åŒ–çš„å±•ç¤º grafanaå¯è§†åŒ–ç•Œé¢ grafanaæ˜¯ä¸€æ¬¾å¯è§†åŒ–å·¥å…·ï¼ŒåŠŸèƒ½å¼ºå¤§ï¼Œæ”¯æŒå¤šç§æ•°æ®æ¥æºPrometheusã€Elasticsearchã€Graphiteç­‰ï¼Œå®‰è£…æ¯”è¾ƒç®€å•è¯·å‚è€ƒå®˜æ–¹æ–‡æ¡£ï¼Œgrafanaé»˜è®¤ç«¯å£3000ï¼Œå®‰è£…å¥½åå†æµè§ˆå™¨è¾“å…¥http://localhost:3000/ï¼Œé»˜è®¤è´¦å·å’Œå¯†ç éƒ½ä¸ºadmin ä¸‹é¢æ¼”ç¤ºå¦‚ä½•åŸºäºä»¥ä¸ŠæŒ‡æ ‡è¿›è¡Œå¯è§†åŒ–ç•Œé¢çš„ç»˜åˆ¶ï¼š ç‚¹å‡»å·¦ä¾§è¾¹æ Configuration->Data Source->Add data sourceè¿›è¡Œæ•°æ®æºæ·»åŠ ï¼Œå…¶ä¸­HTTPçš„URLä¸ºæ•°æ®æºçš„åœ°å€ ç‚¹å‡»å·¦ä¾§è¾¹æ æ·»åŠ dashboardï¼Œç„¶åæ·»åŠ Variablesæ–¹ä¾¿é’ˆå¯¹ä¸åŒçš„æ ‡ç­¾è¿›è¡Œè¿‡æ»¤ç­›é€‰æ¯”å¦‚æ·»åŠ appå˜é‡ç”¨æ¥è¿‡æ»¤ä¸åŒçš„æœåŠ¡ è¿›å…¥dashboardç‚¹å‡»å³ä¸Šè§’Add panelæ·»åŠ é¢æ¿ï¼Œä»¥pathç»´åº¦ç»Ÿè®¡æ¥å£çš„qps æœ€ç»ˆçš„æ•ˆæœå¦‚ä¸‹æ‰€ç¤ºï¼Œå¯ä»¥é€šè¿‡æœåŠ¡åç§°è¿‡æ»¤ä¸åŒçš„æœåŠ¡ï¼Œé¢æ¿å±•ç¤ºäº†pathä¸º/shortençš„qpså˜åŒ–è¶‹åŠ¿ æ€»ç»“ ä»¥ä¸Šæ¼”ç¤ºäº†go-zeroä¸­åŸºäºprometheus+grafanaæœåŠ¡æŒ‡æ ‡ç›‘æ§çš„ç®€å•æµç¨‹ï¼Œç”Ÿäº§ç¯å¢ƒä¸­å¯ä»¥æ ¹æ®å®é™…çš„åœºæ™¯åšä¸åŒç»´åº¦çš„ç›‘æ§åˆ†æã€‚ç°åœ¨go-zeroçš„ç›‘æ§æŒ‡æ ‡ä¸»è¦è¿˜æ˜¯é’ˆå¯¹httpå’Œrpcï¼Œè¿™å¯¹äºæœåŠ¡çš„æ•´ä½“ç›‘æ§æ˜¾ç„¶è¿˜æ˜¯ä¸è¶³çš„ï¼Œæ¯”å¦‚å®¹å™¨èµ„æºçš„ç›‘æ§ï¼Œä¾èµ–çš„mysqlã€redisç­‰èµ„æºçš„ç›‘æ§ï¼Œä»¥åŠè‡ªå®šä¹‰çš„æŒ‡æ ‡ç›‘æ§ç­‰ç­‰ï¼Œgo-zeroåœ¨è¿™æ–¹é¢åç»­è¿˜ä¼šæŒç»­ä¼˜åŒ–ã€‚å¸Œæœ›è¿™ç¯‡æ–‡ç« èƒ½å¤Ÿç»™æ‚¨å¸¦æ¥å¸®åŠ© Copyright Â© 2019-2021 go-zero all right reservedï¼Œpowered by GitbookLast UpdateTimeï¼š 2025-05-05 05:44:52 "},"sharedcalls.html":{"url":"sharedcalls.html","title":"é˜²æ­¢ç¼“å­˜å‡»ç©¿ä¹‹è¿›ç¨‹å†…å…±äº«è°ƒç”¨","keywords":"","body":"é˜²æ­¢ç¼“å­˜å‡»ç©¿ä¹‹è¿›ç¨‹å†…å…±äº«è°ƒç”¨ go-zeroå¾®æœåŠ¡æ¡†æ¶ä¸­æä¾›äº†è®¸å¤šå¼€ç®±å³ç”¨çš„å·¥å…·ï¼Œå¥½çš„å·¥å…·ä¸ä»…èƒ½æå‡æœåŠ¡çš„æ€§èƒ½è€Œä¸”è¿˜èƒ½æå‡ä»£ç çš„é²æ£’æ€§é¿å…å‡ºé”™ï¼Œå®ç°ä»£ç é£æ ¼çš„ç»Ÿä¸€æ–¹ä¾¿ä»–äººé˜…è¯»ç­‰ç­‰ã€‚ æœ¬æ–‡ä¸»è¦è®²è¿°è¿›ç¨‹å†…å…±äº«è°ƒç”¨ç¥å™¨SharedCallsï¼ˆv1.2.0æ”¹åä¸ºSingleFlight ï¼‰ ä½¿ç”¨åœºæ™¯ å¹¶å‘åœºæ™¯ä¸‹ï¼Œå¯èƒ½ä¼šæœ‰å¤šä¸ªçº¿ç¨‹ï¼ˆåç¨‹ï¼‰åŒæ—¶è¯·æ±‚åŒä¸€ä»½èµ„æºï¼Œå¦‚æœæ¯ä¸ªè¯·æ±‚éƒ½è¦èµ°ä¸€éèµ„æºçš„è¯·æ±‚è¿‡ç¨‹ï¼Œé™¤äº†æ¯”è¾ƒä½æ•ˆä¹‹å¤–ï¼Œè¿˜ä¼šå¯¹èµ„æºæœåŠ¡é€ æˆå¹¶å‘çš„å‹åŠ›ã€‚ä¸¾ä¸€ä¸ªå…·ä½“ä¾‹å­ï¼Œæ¯”å¦‚ç¼“å­˜å¤±æ•ˆï¼Œå¤šä¸ªè¯·æ±‚åŒæ—¶åˆ°è¾¾æŸæœåŠ¡è¯·æ±‚æŸèµ„æºï¼Œè¯¥èµ„æºåœ¨ç¼“å­˜ä¸­å·²ç»å¤±æ•ˆï¼Œæ­¤æ—¶è¿™äº›è¯·æ±‚ä¼šç»§ç»­è®¿é—®DBåšæŸ¥è¯¢ï¼Œä¼šå¼•èµ·æ•°æ®åº“å‹åŠ›ç¬é—´å¢å¤§ã€‚è€Œä½¿ç”¨SharedCallså¯ä»¥ä½¿å¾—åŒæ—¶å¤šä¸ªè¯·æ±‚åªéœ€è¦å‘èµ·ä¸€æ¬¡æ‹¿ç»“æœçš„è°ƒç”¨ï¼Œå…¶ä»–è¯·æ±‚\"åäº«å…¶æˆ\"ï¼Œè¿™ç§è®¾è®¡æœ‰æ•ˆå‡å°‘äº†èµ„æºæœåŠ¡çš„å¹¶å‘å‹åŠ›ï¼Œå¯ä»¥æœ‰æ•ˆé˜²æ­¢ç¼“å­˜å‡»ç©¿ã€‚ é«˜å¹¶å‘åœºæ™¯ä¸‹ï¼Œå½“æŸä¸ªçƒ­ç‚¹keyç¼“å­˜å¤±æ•ˆåï¼Œå¤šä¸ªè¯·æ±‚ä¼šåŒæ—¶ä»æ•°æ®åº“åŠ è½½è¯¥èµ„æºï¼Œå¹¶ä¿å­˜åˆ°ç¼“å­˜ï¼Œå¦‚æœä¸åšé˜²èŒƒï¼Œå¯èƒ½ä¼šå¯¼è‡´æ•°æ®åº“è¢«ç›´æ¥æ‰“æ­»ã€‚é’ˆå¯¹è¿™ç§åœºæ™¯ï¼Œgo-zeroæ¡†æ¶ä¸­å·²ç»æä¾›äº†å®ç°ï¼Œå…·ä½“å¯å‚çœ‹sqlcå’Œmongocç­‰å®ç°ä»£ç ã€‚ ä¸ºäº†ç®€åŒ–æ¼”ç¤ºä»£ç ï¼Œæˆ‘ä»¬é€šè¿‡å¤šä¸ªçº¿ç¨‹åŒæ—¶å»è·å–ä¸€ä¸ªidæ¥æ¨¡æ‹Ÿç¼“å­˜çš„åœºæ™¯ã€‚å¦‚ä¸‹ï¼š func main() { const round = 5 var wg sync.WaitGroup barrier := syncx.NewSharedCalls() wg.Add(round) for i := 0; i è¿è¡Œï¼Œæ‰“å°ç»“æœä¸ºï¼š 837c577b1008a0db 837c577b1008a0db 837c577b1008a0db 837c577b1008a0db 837c577b1008a0db å¯ä»¥çœ‹å‡ºï¼Œåªè¦æ˜¯åŒä¸€ä¸ªkeyä¸Šçš„åŒæ—¶å‘èµ·çš„è¯·æ±‚ï¼Œéƒ½ä¼šå…±äº«åŒä¸€ä¸ªç»“æœï¼Œå¯¹è·å–DBæ•°æ®è¿›ç¼“å­˜ç­‰åœºæ™¯ç‰¹åˆ«æœ‰ç”¨ï¼Œå¯ä»¥æœ‰æ•ˆé˜²æ­¢ç¼“å­˜å‡»ç©¿ã€‚ å…³é”®æºç åˆ†æ SharedCalls interfaceæä¾›äº†Doå’ŒDoExä¸¤ç§æ–¹æ³•çš„æŠ½è±¡ // SharedCallsæ¥å£æä¾›äº†Doå’ŒDoExä¸¤ç§æ–¹æ³• type SharedCalls interface { Do(key string, fn func() (interface{}, error)) (interface{}, error) DoEx(key string, fn func() (interface{}, error)) (interface{}, bool, error) } SharedCalls interfaceçš„å…·ä½“å®ç°sharedGroup // callä»£è¡¨å¯¹æŒ‡å®šèµ„æºçš„ä¸€æ¬¡è¯·æ±‚ type call struct { wg sync.WaitGroup // ç”¨äºåè°ƒå„ä¸ªè¯·æ±‚goroutineä¹‹é—´çš„èµ„æºå…±äº« val interface{} // ç”¨äºä¿å­˜è¯·æ±‚çš„è¿”å›å€¼ err error // ç”¨äºä¿å­˜è¯·æ±‚è¿‡ç¨‹ä¸­å‘ç”Ÿçš„é”™è¯¯ } type sharedGroup struct { calls map[string]*call lock sync.Mutex } sharedGroupçš„Doæ–¹æ³• keyå‚æ•°ï¼šå¯ä»¥ç†è§£ä¸ºèµ„æºçš„å”¯ä¸€æ ‡è¯†ã€‚ fnå‚æ•°ï¼šçœŸæ­£è·å–èµ„æºçš„æ–¹æ³•ã€‚ å¤„ç†è¿‡ç¨‹åˆ†æï¼š // å½“å¤šä¸ªè¯·æ±‚åŒæ—¶ä½¿ç”¨Doæ–¹æ³•è¯·æ±‚èµ„æºæ—¶ func (g *sharedGroup) Do(key string, fn func() (interface{}, error)) (interface{}, error) { // å…ˆç”³è¯·åŠ é” g.lock.Lock() // æ ¹æ®keyï¼Œè·å–å¯¹åº”çš„callç»“æœ,å¹¶ç”¨å˜é‡cä¿å­˜ if c, ok := g.calls[key]; ok { // æ‹¿åˆ°callä»¥åï¼Œé‡Šæ”¾é”ï¼Œæ­¤å¤„callå¯èƒ½è¿˜æ²¡æœ‰å®é™…æ•°æ®ï¼Œåªæ˜¯ä¸€ä¸ªç©ºçš„å†…å­˜å ä½ g.lock.Unlock() // è°ƒç”¨wg.Waitï¼Œåˆ¤æ–­æ˜¯å¦æœ‰å…¶ä»–goroutineæ­£åœ¨ç”³è¯·èµ„æºï¼Œå¦‚æœé˜»å¡ï¼Œè¯´æ˜æœ‰å…¶ä»–goroutineæ­£åœ¨è·å–èµ„æº c.wg.Wait() // å½“wg.Waitä¸å†é˜»å¡ï¼Œè¡¨ç¤ºèµ„æºè·å–å·²ç»ç»“æŸï¼Œå¯ä»¥ç›´æ¥è¿”å›ç»“æœ return c.val, c.err } // æ²¡æœ‰æ‹¿åˆ°ç»“æœï¼Œåˆ™è°ƒç”¨makeCallæ–¹æ³•å»è·å–èµ„æºï¼Œæ³¨æ„æ­¤å¤„ä»ç„¶æ˜¯é”ä½çš„ï¼Œå¯ä»¥ä¿è¯åªæœ‰ä¸€ä¸ªgoroutineå¯ä»¥è°ƒç”¨makecall c := g.makeCall(key, fn) // è¿”å›è°ƒç”¨ç»“æœ return c.val, c.err } sharedGroupçš„DoExæ–¹æ³• å’ŒDoæ–¹æ³•ç±»ä¼¼ï¼Œåªæ˜¯è¿”å›å€¼ä¸­å¢åŠ äº†å¸ƒå°”å€¼è¡¨ç¤ºå€¼æ˜¯è°ƒç”¨makeCallæ–¹æ³•ç›´æ¥è·å–çš„ï¼Œè¿˜æ˜¯å–çš„å…±äº«æˆæœ func (g *sharedGroup) DoEx(key string, fn func() (interface{}, error)) (val interface{}, fresh bool, err error) { g.lock.Lock() if c, ok := g.calls[key]; ok { g.lock.Unlock() c.wg.Wait() return c.val, false, c.err } c := g.makeCall(key, fn) return c.val, true, c.err } sharedGroupçš„makeCallæ–¹æ³• è¯¥æ–¹æ³•ç”±Doå’ŒDoExæ–¹æ³•è°ƒç”¨ï¼Œæ˜¯çœŸæ­£å‘èµ·èµ„æºè¯·æ±‚çš„æ–¹æ³•ã€‚ // è¿›å…¥makeCallçš„ä¸€å®šåªæœ‰ä¸€ä¸ªgoroutineï¼Œå› ä¸ºè¦æ‹¿é”é”ä½çš„ func (g *sharedGroup) makeCall(key string, fn func() (interface{}, error)) *call { // åˆ›å»ºcallç»“æ„ï¼Œç”¨äºä¿å­˜æœ¬æ¬¡è¯·æ±‚çš„ç»“æœ c := new(call) // wgåŠ 1ï¼Œç”¨äºé€šçŸ¥å…¶ä»–è¯·æ±‚èµ„æºçš„goroutineç­‰å¾…æœ¬æ¬¡èµ„æºè·å–çš„ç»“æŸ c.wg.Add(1) // å°†ç”¨äºä¿å­˜ç»“æœçš„callæ”¾å…¥mapä¸­ï¼Œä»¥ä¾›å…¶ä»–goroutineè·å– g.calls[key] = c // é‡Šæ”¾é”ï¼Œè¿™æ ·å…¶ä»–è¯·æ±‚çš„goroutineæ‰èƒ½è·å–callçš„å†…å­˜å ä½ g.lock.Unlock() defer func() { // delete key first, done later. can't reverse the order, because if reverse, // another Do call might wg.Wait() without get notified with wg.Done() g.lock.Lock() delete(g.calls, key) g.lock.Unlock() // è°ƒç”¨wg.Doneï¼Œé€šçŸ¥å…¶ä»–goroutineå¯ä»¥è¿”å›ç»“æœï¼Œè¿™æ ·æœ¬æ‰¹æ¬¡æ‰€æœ‰è¯·æ±‚å®Œæˆç»“æœçš„å…±äº« c.wg.Done() }() // è°ƒç”¨fnæ–¹æ³•ï¼Œå°†ç»“æœå¡«å…¥å˜é‡cä¸­ c.val, c.err = fn() return c } æœ€å æœ¬æ–‡ä¸»è¦ä»‹ç»äº†go-zeroæ¡†æ¶ä¸­çš„ SharedCallså·¥å…·ï¼Œå¯¹å…¶åº”ç”¨åœºæ™¯å’Œå…³é”®ä»£ç åšäº†ç®€å•çš„æ¢³ç†ï¼Œå¸Œæœ›æœ¬ç¯‡æ–‡ç« èƒ½ç»™å¤§å®¶å¸¦æ¥ä¸€äº›æ”¶è·ã€‚ Copyright Â© 2019-2021 go-zero all right reservedï¼Œpowered by GitbookLast UpdateTimeï¼š 2025-05-05 05:44:52 "},"sql-cache.html":{"url":"sql-cache.html","title":"DBç¼“å­˜æœºåˆ¶","keywords":"","body":"DBç¼“å­˜æœºåˆ¶ QueryRowIndex æ²¡æœ‰æŸ¥è¯¢æ¡ä»¶åˆ°Primaryæ˜ å°„çš„ç¼“å­˜ é€šè¿‡æŸ¥è¯¢æ¡ä»¶åˆ°DBå»æŸ¥è¯¢è¡Œè®°å½•ï¼Œç„¶å æŠŠPrimaryåˆ°è¡Œè®°å½•çš„ç¼“å­˜å†™åˆ°redisé‡Œ æŠŠæŸ¥è¯¢æ¡ä»¶åˆ°Primaryçš„æ˜ å°„ä¿å­˜åˆ°redisé‡Œï¼Œæ¡†æ¶çš„Takeæ–¹æ³•è‡ªåŠ¨åšäº† å¯èƒ½çš„è¿‡æœŸé¡ºåº æŸ¥è¯¢æ¡ä»¶åˆ°Primaryçš„æ˜ å°„ç¼“å­˜æœªè¿‡æœŸ Primaryåˆ°è¡Œè®°å½•çš„ç¼“å­˜æœªè¿‡æœŸ ç›´æ¥è¿”å›ç¼“å­˜è¡Œè®°å½• Primaryåˆ°è¡Œè®°å½•çš„ç¼“å­˜å·²è¿‡æœŸ é€šè¿‡Primaryåˆ°DBè·å–è¡Œè®°å½•ï¼Œå¹¶å†™å…¥ç¼“å­˜ æ­¤æ—¶å­˜åœ¨çš„é—®é¢˜æ˜¯ï¼ŒæŸ¥è¯¢æ¡ä»¶åˆ°Primaryçš„ç¼“å­˜å¯èƒ½å·²ç»å¿«è¦è¿‡æœŸäº†ï¼ŒçŸ­æ—¶é—´å†…çš„æŸ¥è¯¢åˆä¼šè§¦å‘ä¸€æ¬¡æ•°æ®åº“æŸ¥è¯¢ è¦é¿å…è¿™ä¸ªé—®é¢˜ï¼Œå¯ä»¥è®©ä¸Šé¢ç²—ä½“éƒ¨åˆ†ç¬¬ä¸€ä¸ªè¿‡æœŸæ—¶é—´ç•¥é•¿äºç¬¬äºŒä¸ªï¼Œæ¯”å¦‚5ç§’ æŸ¥è¯¢æ¡ä»¶åˆ°Primaryçš„æ˜ å°„ç¼“å­˜å·²è¿‡æœŸï¼Œä¸ç®¡Primaryåˆ°è¡Œè®°å½•çš„ç¼“å­˜æ˜¯å¦è¿‡æœŸ æŸ¥è¯¢æ¡ä»¶åˆ°Primaryçš„æ˜ å°„ä¼šè¢«é‡æ–°è·å–ï¼Œè·å–è¿‡ç¨‹ä¸­ä¼šè‡ªåŠ¨å†™å…¥æ–°çš„Primaryåˆ°è¡Œè®°å½•çš„ç¼“å­˜ï¼Œè¿™æ ·ä¸¤ç§ç¼“å­˜çš„è¿‡æœŸæ—¶é—´éƒ½æ˜¯åˆšåˆšè®¾ç½® æœ‰æŸ¥è¯¢æ¡ä»¶åˆ°Primaryæ˜ å°„çš„ç¼“å­˜ æ²¡æœ‰Primaryåˆ°è¡Œè®°å½•çš„ç¼“å­˜ é€šè¿‡Primaryåˆ°DBæŸ¥è¯¢è¡Œè®°å½•ï¼Œå¹¶å†™å…¥ç¼“å­˜ æœ‰Primaryåˆ°è¡Œè®°å½•çš„ç¼“å­˜ ç›´æ¥è¿”å›ç¼“å­˜ç»“æœ Copyright Â© 2019-2021 go-zero all right reservedï¼Œpowered by GitbookLast UpdateTimeï¼š 2025-05-05 05:44:52 "},"zrpc.html":{"url":"zrpc.html","title":"zrpc ä½¿ç”¨ä»‹ç»","keywords":"","body":"ä¼ä¸šçº§RPCæ¡†æ¶zRPC è¿‘æœŸæ¯”è¾ƒç«çš„å¼€æºé¡¹ç›®go-zeroæ˜¯ä¸€ä¸ªé›†æˆäº†å„ç§å·¥ç¨‹å®è·µçš„åŒ…å«äº†Webå’ŒRPCåè®®çš„åŠŸèƒ½å®Œå–„çš„å¾®æœåŠ¡æ¡†æ¶ï¼Œä»Šå¤©æˆ‘ä»¬å°±ä¸€èµ·æ¥åˆ†æä¸€ä¸‹å…¶ä¸­çš„RPCéƒ¨åˆ†zRPCã€‚ zRPCåº•å±‚ä¾èµ–gRPCï¼Œå†…ç½®äº†æœåŠ¡æ³¨å†Œã€è´Ÿè½½å‡è¡¡ã€æ‹¦æˆªå™¨ç­‰æ¨¡å—ï¼Œå…¶ä¸­è¿˜åŒ…æ‹¬è‡ªé€‚åº”é™è½½ï¼Œè‡ªé€‚åº”ç†”æ–­ï¼Œé™æµç­‰å¾®æœåŠ¡æ²»ç†æ–¹æ¡ˆï¼Œæ˜¯ä¸€ä¸ªç®€å•æ˜“ç”¨çš„å¯ç›´æ¥ç”¨äºç”Ÿäº§çš„ä¼ä¸šçº§RPCæ¡†æ¶ã€‚ zRPCåˆæ¢ zRPCæ”¯æŒç›´è¿å’ŒåŸºäºetcdæœåŠ¡å‘ç°ä¸¤ç§æ–¹å¼ï¼Œæˆ‘ä»¬ä»¥åŸºäºetcdåšæœåŠ¡å‘ç°ä¸ºä¾‹æ¼”ç¤ºzRPCçš„åŸºæœ¬ä½¿ç”¨ï¼š é…ç½® åˆ›å»ºhello.yamlé…ç½®æ–‡ä»¶ï¼Œé…ç½®å¦‚ä¸‹ï¼š Name: hello.rpc // æœåŠ¡å ListenOn: 127.0.0.1:9090 // æœåŠ¡ç›‘å¬åœ°å€ Etcd: Hosts: - 127.0.0.1:2379 // etcdæœåŠ¡åœ°å€ Key: hello.rpc // æœåŠ¡æ³¨å†Œkey åˆ›å»ºprotoæ–‡ä»¶ åˆ›å»ºhello.protoæ–‡ä»¶ï¼Œå¹¶ç”Ÿæˆå¯¹åº”çš„goä»£ç  syntax = \"proto3\"; package pb; service Greeter { rpc SayHello (HelloRequest) returns (HelloReply) {} } message HelloRequest { string name = 1; } message HelloReply { string message = 1; } ç”Ÿæˆgoä»£ç  protoc --go_out=plugins=grpc:. hello.proto Serverç«¯ package main import ( \"context\" \"flag\" \"log\" \"example/zrpc/pb\" \"github.com/zeromicro/go-zero/core/conf\" \"github.com/zeromicro/go-zero/zrpc\" \"google.golang.org/grpc\" ) type Config struct { zrpc.RpcServerConf } var cfgFile = flag.String(\"f\", \"./hello.yaml\", \"cfg file\") func main() { flag.Parse() var cfg Config conf.MustLoad(*cfgFile, &cfg) srv, err := zrpc.NewServer(cfg.RpcServerConf, func(s *grpc.Server) { pb.RegisterGreeterServer(s, &Hello{}) }) if err != nil { log.Fatal(err) } srv.Start() } type Hello struct{} func (h *Hello) SayHello(ctx context.Context, in *pb.HelloRequest) (*pb.HelloReply, error) { return &pb.HelloReply{Message: \"hello \" + in.Name}, nil } Clientç«¯ package main import ( \"context\" \"log\" \"example/zrpc/pb\" \"github.com/zeromicro/go-zero/core/discov\" \"github.com/zeromicro/go-zero/zrpc\" ) func main() { client := zrpc.MustNewClient(zrpc.RpcClientConf{ Etcd: discov.EtcdConf{ Hosts: []string{\"127.0.0.1:2379\"}, Key: \"hello.rpc\", }, }) conn := client.Conn() hello := pb.NewGreeterClient(conn) reply, err := hello.SayHello(context.Background(), &pb.HelloRequest{Name: \"go-zero\"}) if err != nil { log.Fatal(err) } log.Println(reply.Message) } å¯åŠ¨æœåŠ¡ï¼ŒæŸ¥çœ‹æœåŠ¡æ˜¯å¦æ³¨å†Œï¼š ETCDCTL_API=3 etcdctl get hello.rpc --prefix æ˜¾ç¤ºæœåŠ¡å·²ç»æ³¨å†Œï¼š hello.rpc/7587849401504590084 127.0.0.1:9090 è¿è¡Œå®¢æˆ·ç«¯å³å¯çœ‹åˆ°è¾“å‡ºï¼š hello go-zero è¿™ä¸ªä¾‹å­æ¼”ç¤ºäº†zRPCçš„åŸºæœ¬ä½¿ç”¨ï¼Œå¯ä»¥çœ‹åˆ°é€šè¿‡zRPCæ„å»ºRPCæœåŠ¡éå¸¸ç®€å•ï¼Œåªéœ€è¦å¾ˆå°‘çš„å‡ è¡Œä»£ç ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬ç»§ç»­è¿›è¡Œæ¢ç´¢ zRPCåŸç†åˆ†æ ä¸‹å›¾å±•ç¤ºzRPCçš„æ¶æ„å›¾å’Œä¸»è¦ç»„æˆéƒ¨åˆ† zRPCä¸»è¦æœ‰ä»¥ä¸‹å‡ ä¸ªæ¨¡å—ç»„æˆï¼š discov: æœåŠ¡å‘ç°æ¨¡å—ï¼ŒåŸºäºetcdå®ç°æœåŠ¡å‘ç°åŠŸèƒ½ resolver: æœåŠ¡æ³¨å†Œæ¨¡å—ï¼Œå®ç°äº†gRPCçš„resolver.Builderæ¥å£å¹¶æ³¨å†Œåˆ°gRPC interceptor: æ‹¦æˆªå™¨ï¼Œå¯¹è¯·æ±‚å’Œå“åº”è¿›è¡Œæ‹¦æˆªå¤„ç† balancer: è´Ÿè½½å‡è¡¡æ¨¡å—ï¼Œå®ç°äº†p2cè´Ÿè½½å‡è¡¡ç®—æ³•ï¼Œå¹¶æ³¨å†Œåˆ°gRPC client: zRPCå®¢æˆ·ç«¯ï¼Œè´Ÿè´£å‘èµ·è¯·æ±‚ server: zRPCæœåŠ¡ç«¯ï¼Œè´Ÿè´£å¤„ç†è¯·æ±‚ è¿™é‡Œä»‹ç»äº†zRPCçš„ä¸»è¦ç»„æˆæ¨¡å—å’Œæ¯ä¸ªæ¨¡å—çš„ä¸»è¦åŠŸèƒ½ï¼Œå…¶ä¸­resolverå’Œbalanceræ¨¡å—å®ç°äº†gRPCå¼€æ”¾çš„æ¥å£ï¼Œå®ç°äº†è‡ªå®šä¹‰çš„resolverå’Œbalancerï¼Œæ‹¦æˆªå™¨æ¨¡å—æ˜¯æ•´ä¸ªzRPCçš„åŠŸèƒ½é‡ç‚¹ï¼Œè‡ªé€‚åº”é™è½½ã€è‡ªé€‚åº”ç†”æ–­ã€prometheusæœåŠ¡æŒ‡æ ‡æ”¶é›†ç­‰åŠŸèƒ½éƒ½åœ¨è¿™é‡Œå®ç° Interceptoræ¨¡å— gRPCæä¾›äº†æ‹¦æˆªå™¨åŠŸèƒ½ï¼Œä¸»è¦æ˜¯å¯¹è¯·æ±‚å‰åè¿›è¡Œé¢å¤–å¤„ç†çš„æ‹¦æˆªæ“ä½œï¼Œå…¶ä¸­æ‹¦æˆªå™¨åŒ…å«å®¢æˆ·ç«¯æ‹¦æˆªå™¨å’ŒæœåŠ¡ç«¯æ‹¦æˆªå™¨ï¼Œåˆåˆ†ä¸ºä¸€å…ƒ(Unary)æ‹¦æˆªå™¨å’Œæµ(Stream)æ‹¦æˆªå™¨ï¼Œè¿™é‡Œæˆ‘ä»¬ä¸»è¦è®²è§£ä¸€å…ƒæ‹¦æˆªå™¨ï¼Œæµæ‹¦æˆªå™¨åŒç†ã€‚ å®¢æˆ·ç«¯æ‹¦æˆªå™¨å®šä¹‰å¦‚ä¸‹: type UnaryClientInterceptor func(ctx context.Context, method string, req, reply interface{}, cc *ClientConn, invoker UnaryInvoker, opts ...CallOption) error å…¶ä¸­methodä¸ºæ–¹æ³•åï¼Œreqï¼Œreplyåˆ†åˆ«ä¸ºè¯·æ±‚å’Œå“åº”å‚æ•°ï¼Œccä¸ºå®¢æˆ·ç«¯è¿æ¥å¯¹è±¡ï¼Œinvokerå‚æ•°æ˜¯çœŸæ­£æ‰§è¡Œrpcæ–¹æ³•çš„handlerå…¶å®åœ¨æ‹¦æˆªå™¨ä¸­è¢«è°ƒç”¨æ‰§è¡Œ æœåŠ¡ç«¯æ‹¦æˆªå™¨å®šä¹‰å¦‚ä¸‹: type UnaryServerInterceptor func(ctx context.Context, req interface{}, info *UnaryServerInfo, handler UnaryHandler) (resp interface{}, err error) å…¶ä¸­reqä¸ºè¯·æ±‚å‚æ•°ï¼Œinfoä¸­åŒ…å«äº†è¯·æ±‚æ–¹æ³•å±æ€§ï¼Œhandlerä¸ºå¯¹serverç«¯æ–¹æ³•çš„åŒ…è£…ï¼Œä¹Ÿæ˜¯åœ¨æ‹¦æˆªå™¨ä¸­è¢«è°ƒç”¨æ‰§è¡Œ zRPCä¸­å†…ç½®äº†ä¸°å¯Œçš„æ‹¦æˆªå™¨ï¼Œå…¶ä¸­åŒ…æ‹¬è‡ªé€‚åº”é™è½½ã€è‡ªé€‚åº”ç†”æ–­ã€æƒé™éªŒè¯ã€prometheusæŒ‡æ ‡æ”¶é›†ç­‰ç­‰ï¼Œç”±äºæ‹¦æˆªå™¨è¾ƒå¤šï¼Œç¯‡å¹…æœ‰é™æ²¡æ³•æ‰€æœ‰çš„æ‹¦æˆªå™¨ç»™å¤§å®¶ä¸€ä¸€è§£æï¼Œè¿™é‡Œæˆ‘ä»¬ä¸»è¦åˆ†æä¸¤ä¸ªï¼Œè‡ªé€‚åº”ç†”æ–­å’ŒprometheusæœåŠ¡ç›‘æ§æŒ‡æ ‡æ”¶é›†ï¼š å†…ç½®æ‹¦æˆªå™¨åˆ†æ è‡ªé€‚åº”ç†”æ–­(breaker) å½“å®¢æˆ·ç«¯å‘æœåŠ¡ç«¯å‘èµ·è¯·æ±‚ï¼Œå®¢æˆ·ç«¯ä¼šè®°å½•æœåŠ¡ç«¯è¿”å›çš„é”™è¯¯ï¼Œå½“é”™è¯¯è¾¾åˆ°ä¸€å®šçš„æ¯”ä¾‹ï¼Œå®¢æˆ·ç«¯ä¼šè‡ªè¡Œçš„è¿›è¡Œç†”æ–­å¤„ç†ï¼Œä¸¢å¼ƒæ‰ä¸€å®šæ¯”ä¾‹çš„è¯·æ±‚ä»¥ä¿æŠ¤ä¸‹æ¸¸ä¾èµ–ï¼Œä¸”å¯ä»¥è‡ªåŠ¨æ¢å¤ã€‚zRPCä¸­è‡ªé€‚åº”ç†”æ–­éµå¾ªã€ŠGoogle SREã€‹ä¸­è¿‡è½½ä¿æŠ¤ç­–ç•¥ï¼Œç®—æ³•å¦‚ä¸‹ï¼š requests: æ€»è¯·æ±‚æ•°é‡ accepts: æ­£å¸¸è¯·æ±‚æ•°é‡ K: å€å€¼ (Google SREæ¨èå€¼ä¸º2) å¯ä»¥é€šè¿‡ä¿®æ”¹Kçš„å€¼æ¥ä¿®æ”¹ç†”æ–­å‘ç”Ÿçš„æ¿€è¿›ç¨‹åº¦ï¼Œé™ä½Kçš„å€¼ä¼šä½¿å¾—è‡ªé€‚åº”ç†”æ–­ç®—æ³•æ›´åŠ æ¿€è¿›ï¼Œå¢åŠ Kçš„å€¼åˆ™è‡ªé€‚åº”ç†”æ–­ç®—æ³•å˜å¾—ä¸å†é‚£ä¹ˆæ¿€è¿› ç†”æ–­æ‹¦æˆªå™¨å®šä¹‰å¦‚ä¸‹ï¼š func BreakerInterceptor(ctx context.Context, method string, req, reply interface{}, cc *grpc.ClientConn, invoker grpc.UnaryInvoker, opts ...grpc.CallOption) error { // target + æ–¹æ³•å breakerName := path.Join(cc.Target(), method) return breaker.DoWithAcceptable(breakerName, func() error { // çœŸæ­£æ‰§è¡Œè°ƒç”¨ return invoker(ctx, method, req, reply, cc, opts...) }, codes.Acceptable) } acceptæ–¹æ³•å®ç°äº†Google SREè¿‡è½½ä¿æŠ¤ç®—æ³•ï¼Œåˆ¤æ–­å¦è¿›è¡Œç†”æ–­ func (b *googleBreaker) accept() error { // acceptsä¸ºæ­£å¸¸è¯·æ±‚æ•°ï¼Œtotalä¸ºæ€»è¯·æ±‚æ•° accepts, total := b.history() weightedAccepts := b.k * float64(accepts) // ç®—æ³•å®ç° dropRatio := math.Max(0, (float64(total-protection)-weightedAccepts)/float64(total+1)) if dropRatio doReqæ–¹æ³•é¦–å…ˆåˆ¤æ–­æ˜¯å¦ç†”æ–­ï¼Œæ»¡è¶³æ¡ä»¶ç›´æ¥è¿”å›error(circuit breaker is open)ï¼Œä¸æ»¡è¶³æ¡ä»¶åˆ™å¯¹è¯·æ±‚æ•°è¿›è¡Œç´¯åŠ  func (b *googleBreaker) doReq(req func() error, fallback func(err error) error, acceptable Acceptable) error { if err := b.accept(); err != nil { if fallback != nil { return fallback(err) } else { return err } } defer func() { if e := recover(); e != nil { b.markFailure() panic(e) } }() // æ­¤å¤„æ‰§è¡ŒRPCè¯·æ±‚ err := req() // æ­£å¸¸è¯·æ±‚totalå’Œacceptséƒ½ä¼šåŠ 1 if acceptable(err) { b.markSuccess() } else { // è¯·æ±‚å¤±è´¥åªæœ‰totalä¼šåŠ 1 b.markFailure() } return err } prometheusæŒ‡æ ‡æ”¶é›† æœåŠ¡ç›‘æ§æ˜¯äº†è§£æœåŠ¡å½“å‰è¿è¡ŒçŠ¶æ€ä»¥åŠå˜åŒ–è¶‹åŠ¿çš„é‡è¦æ‰‹æ®µï¼Œç›‘æ§ä¾èµ–äºæœåŠ¡æŒ‡æ ‡çš„æ”¶é›†ï¼Œé€šè¿‡prometheusè¿›è¡Œç›‘æ§æŒ‡æ ‡çš„æ”¶é›†æ˜¯ä¸šç•Œä¸»æµæ–¹æ¡ˆï¼ŒzRPCä¸­ä¹Ÿé‡‡ç”¨äº†prometheusæ¥è¿›è¡ŒæŒ‡æ ‡çš„æ”¶é›† prometheusæ‹¦æˆªå™¨å®šä¹‰å¦‚ä¸‹ï¼š è¿™ä¸ªæ‹¦æˆªå™¨ä¸»è¦æ˜¯å¯¹æœåŠ¡çš„ç›‘æ§æŒ‡æ ‡è¿›è¡Œæ”¶é›†ï¼Œè¿™é‡Œä¸»è¦æ˜¯å¯¹RPCæ–¹æ³•çš„è€—æ—¶å’Œè°ƒç”¨é”™è¯¯è¿›è¡Œæ”¶é›†ï¼Œè¿™é‡Œä¸»è¦ä½¿ç”¨äº†Prometheusçš„Histogramå’ŒCounteræ•°æ®ç±»å‹ func UnaryPrometheusInterceptor() grpc.UnaryServerInterceptor { return func(ctx context.Context, req interface{}, info *grpc.UnaryServerInfo, handler grpc.UnaryHandler) ( interface{}, error) { // æ‰§è¡Œå‰è®°å½•ä¸€ä¸ªæ—¶é—´ startTime := timex.Now() resp, err := handler(ctx, req) // æ‰§è¡Œåé€šè¿‡Sinceç®—å‡ºæ‰§è¡Œè¯¥è°ƒç”¨çš„è€—æ—¶ metricServerReqDur.Observe(int64(timex.Since(startTime)/time.Millisecond), info.FullMethod) // æ–¹æ³•å¯¹åº”çš„é”™è¯¯ç  metricServerReqCodeTotal.Inc(info.FullMethod, strconv.Itoa(int(status.Code(err)))) return resp, err } } æ·»åŠ è‡ªå®šä¹‰æ‹¦æˆªå™¨ é™¤äº†å†…ç½®äº†ä¸°å¯Œçš„æ‹¦æˆªå™¨ä¹‹å¤–ï¼ŒzRPCåŒæ—¶æ”¯æŒæ·»åŠ è‡ªå®šä¹‰æ‹¦æˆªå™¨ Clientç«¯é€šè¿‡AddInterceptoræ–¹æ³•æ·»åŠ ä¸€å…ƒæ‹¦æˆªå™¨ï¼š func (rc *RpcClient) AddInterceptor(interceptor grpc.UnaryClientInterceptor) { rc.client.AddInterceptor(interceptor) } Serverç«¯é€šè¿‡AddUnaryInterceptorsæ–¹æ³•æ·»åŠ ä¸€å…ƒæ‹¦æˆªå™¨ï¼š func (rs *RpcServer) AddUnaryInterceptors(interceptors ...grpc.UnaryServerInterceptor) { rs.server.AddUnaryInterceptors(interceptors...) } resolveræ¨¡å— zRPCæœåŠ¡æ³¨å†Œæ¶æ„å›¾ï¼š zRPCä¸­è‡ªå®šä¹‰äº†resolveræ¨¡å—ï¼Œç”¨æ¥å®ç°æœåŠ¡çš„æ³¨å†ŒåŠŸèƒ½ã€‚zRPCåº•å±‚ä¾èµ–gRPCï¼Œåœ¨gRPCä¸­è¦æƒ³è‡ªå®šä¹‰resolveréœ€è¦å®ç°resolver.Builderæ¥å£ï¼š type Builder interface { Build(target Target, cc ClientConn, opts BuildOptions) (Resolver, error) Scheme() string } å…¶ä¸­Buildæ–¹æ³•è¿”å›Resolverï¼ŒResolverå®šä¹‰å¦‚ä¸‹ï¼š type Resolver interface { ResolveNow(ResolveNowOptions) Close() } åœ¨zRPCä¸­å®šä¹‰äº†ä¸¤ç§resolverï¼Œdirectå’Œdiscovï¼Œè¿™é‡Œæˆ‘ä»¬ä¸»è¦åˆ†æåŸºäºetcdåšæœåŠ¡å‘ç°çš„discovï¼Œè‡ªå®šä¹‰çš„resolveréœ€è¦é€šè¿‡gRPCæä¾›äº†Registeræ–¹æ³•è¿›è¡Œæ³¨å†Œä»£ç å¦‚ä¸‹ï¼š func RegisterResolver() { resolver.Register(&dirBuilder) resolver.Register(&disBuilder) } å½“æˆ‘ä»¬å¯åŠ¨æˆ‘ä»¬çš„zRPC Serverçš„æ—¶å€™ï¼Œè°ƒç”¨Startæ–¹æ³•ï¼Œä¼šåƒetcdä¸­æ³¨å†Œå¯¹åº”çš„æœåŠ¡åœ°å€ï¼š func (ags keepAliveServer) Start(fn RegisterFn) error { // æ³¨å†ŒæœåŠ¡åœ°å€ if err := ags.registerEtcd(); err != nil { return err } // å¯åŠ¨æœåŠ¡ return ags.Server.Start(fn) } å½“æˆ‘ä»¬å¯åŠ¨zRPCå®¢æˆ·ç«¯çš„æ—¶å€™ï¼Œåœ¨gRPCå†…éƒ¨ä¼šè°ƒç”¨æˆ‘ä»¬è‡ªå®šä¹‰resolverçš„Buildæ–¹æ³•ï¼ŒzRPCé€šè¿‡åœ¨Buildæ–¹æ³•å†…è°ƒç”¨æ‰§è¡Œäº†resolver.ClientConnçš„UpdateStateæ–¹æ³•ï¼Œè¯¥æ–¹æ³•ä¼šæŠŠæœåŠ¡åœ°å€æ³¨å†Œåˆ°gRPCå®¢æˆ·ç«¯å†…éƒ¨ï¼š func (d *discovBuilder) Build(target resolver.Target, cc resolver.ClientConn, opts resolver.BuildOptions) ( resolver.Resolver, error) { hosts := strings.FieldsFunc(target.Authority, func(r rune) bool { return r == EndpointSepChar }) // æœåŠ¡å‘ç° sub, err := discov.NewSubscriber(hosts, target.Endpoint) if err != nil { return nil, err } update := func() { var addrs []resolver.Address for _, val := range subset(sub.Values(), subsetSize) { addrs = append(addrs, resolver.Address{ Addr: val, }) } // å‘gRPCæ³¨å†ŒæœåŠ¡åœ°å€ cc.UpdateState(resolver.State{ Addresses: addrs, }) } // ç›‘å¬ sub.AddListener(update) update() // è¿”å›è‡ªå®šä¹‰çš„resolver.Resolver return &nopResolver{cc: cc}, nil } åœ¨discovä¸­ï¼Œé€šè¿‡è°ƒç”¨loadæ–¹æ³•ä»etcdä¸­è·å–æŒ‡å®šæœåŠ¡çš„æ‰€æœ‰åœ°å€ï¼š func (c *cluster) load(cli EtcdClient, key string) { var resp *clientv3.GetResponse for { var err error ctx, cancel := context.WithTimeout(c.context(cli), RequestTimeout) // ä»etcdä¸­è·å–æŒ‡å®šæœåŠ¡çš„æ‰€æœ‰åœ°å€ resp, err = cli.Get(ctx, makeKeyPrefix(key), clientv3.WithPrefix()) cancel() if err == nil { break } logx.Error(err) time.Sleep(coolDownInterval) } var kvs []KV c.lock.Lock() for _, ev := range resp.Kvs { kvs = append(kvs, KV{ Key: string(ev.Key), Val: string(ev.Value), }) } c.lock.Unlock() c.handleChanges(key, kvs) } å¹¶é€šè¿‡watchç›‘å¬æœåŠ¡åœ°å€çš„å˜åŒ–ï¼š func (c *cluster) watch(cli EtcdClient, key string) { rch := cli.Watch(clientv3.WithRequireLeader(c.context(cli)), makeKeyPrefix(key), clientv3.WithPrefix()) for { select { case wresp, ok := è¿™éƒ¨åˆ†ä¸»è¦ä»‹ç»äº†zRPCä¸­æ˜¯å¦‚ä½•è‡ªå®šä¹‰çš„resolverï¼Œä»¥åŠåŸºäºetcdçš„æœåŠ¡å‘ç°åŸç†ï¼Œé€šè¿‡è¿™éƒ¨åˆ†çš„ä»‹ç»å¤§å®¶å¯ä»¥äº†è§£åˆ°zRPCå†…éƒ¨æœåŠ¡æ³¨å†Œå‘ç°çš„åŸç†ï¼Œæºä»£ç æ¯”è¾ƒå¤šåªæ˜¯ç²—ç•¥çš„ä»æ•´ä¸ªæµç¨‹ä¸Šè¿›è¡Œäº†åˆ†æï¼Œå¦‚æœå¤§å®¶å¯¹zRPCçš„æºç æ¯”è¾ƒæ„Ÿå…´è¶£å¯ä»¥è‡ªè¡Œè¿›è¡Œå­¦ä¹  balanceræ¨¡å— è´Ÿè½½å‡è¡¡åŸç†å›¾ï¼š é¿å…è¿‡è½½æ˜¯è´Ÿè½½å‡è¡¡ç­–ç•¥çš„ä¸€ä¸ªé‡è¦æŒ‡æ ‡ï¼Œå¥½çš„è´Ÿè½½å‡è¡¡ç®—æ³•èƒ½å¾ˆå¥½çš„å¹³è¡¡æœåŠ¡ç«¯èµ„æºã€‚å¸¸ç”¨çš„è´Ÿè½½å‡è¡¡ç®—æ³•æœ‰è½®è®­ã€éšæœºã€Hashã€åŠ æƒè½®è®­ç­‰ã€‚ä½†ä¸ºäº†åº”å¯¹å„ç§å¤æ‚çš„åœºæ™¯ï¼Œç®€å•çš„è´Ÿè½½å‡è¡¡ç®—æ³•å¾€å¾€è¡¨ç°çš„ä¸å¤Ÿå¥½ï¼Œæ¯”å¦‚è½®è®­ç®—æ³•å½“æœåŠ¡å“åº”æ—¶é—´å˜é•¿å°±å¾ˆå®¹æ˜“å¯¼è‡´è´Ÿè½½ä¸å†å¹³è¡¡ï¼Œ å› æ­¤zRPCä¸­è‡ªå®šä¹‰äº†é»˜è®¤è´Ÿè½½å‡è¡¡ç®—æ³•P2C(Power of Two Choices)ï¼Œå’Œresolverç±»ä¼¼ï¼Œè¦æƒ³è‡ªå®šä¹‰balancerä¹Ÿéœ€è¦å®ç°gRPCå®šä¹‰çš„balancer.Builderæ¥å£ï¼Œç”±äºå’Œresolverç±»ä¼¼è¿™é‡Œä¸å†å¸¦å¤§å®¶ä¸€èµ·åˆ†æå¦‚ä½•è‡ªå®šä¹‰balancerï¼Œæ„Ÿå…´è¶£çš„æœ‹å‹å¯ä»¥æŸ¥çœ‹gRPCç›¸å…³çš„æ–‡æ¡£æ¥è¿›è¡Œå­¦ä¹  æ³¨æ„ï¼ŒzRPCæ˜¯åœ¨å®¢æˆ·ç«¯è¿›è¡Œè´Ÿè½½å‡è¡¡ï¼Œå¸¸è§çš„è¿˜æœ‰é€šè¿‡nginxä¸­é—´ä»£ç†çš„æ–¹å¼ zRPCæ¡†æ¶ä¸­é»˜è®¤çš„è´Ÿè½½å‡è¡¡ç®—æ³•ä¸ºP2Cï¼Œè¯¥ç®—æ³•çš„ä¸»è¦æ€æƒ³æ˜¯ï¼š ä»å¯ç”¨èŠ‚ç‚¹åˆ—è¡¨ä¸­åšä¸¤æ¬¡éšæœºé€‰æ‹©æ“ä½œï¼Œå¾—åˆ°èŠ‚ç‚¹Aã€B æ¯”è¾ƒAã€Bä¸¤ä¸ªèŠ‚ç‚¹ï¼Œé€‰å‡ºè´Ÿè½½æœ€ä½çš„èŠ‚ç‚¹ä½œä¸ºè¢«é€‰ä¸­çš„èŠ‚ç‚¹ ä¼ªä»£ç å¦‚ä¸‹ï¼š ä¸»è¦ç®—æ³•é€»è¾‘åœ¨Pickæ–¹æ³•ä¸­å®ç°ï¼š func (p *p2cPicker) Pick(ctx context.Context, info balancer.PickInfo) ( conn balancer.SubConn, done func(balancer.DoneInfo), err error) { p.lock.Lock() defer p.lock.Unlock() var chosen *subConn switch len(p.conns) { case 0: return nil, nil, balancer.ErrNoSubConnAvailable case 1: chosen = p.choose(p.conns[0], nil) case 2: chosen = p.choose(p.conns[0], p.conns[1]) default: var node1, node2 *subConn for i := 0; i = a { b++ } // éšæœºè·å–æ‰€æœ‰èŠ‚ç‚¹ä¸­çš„ä¸¤ä¸ªèŠ‚ç‚¹ node1 = p.conns[a] node2 = p.conns[b] // æ•ˆéªŒèŠ‚ç‚¹æ˜¯å¦å¥åº· if node1.healthy() && node2.healthy() { break } } // é€‰æ‹©å…¶ä¸­ä¸€ä¸ªèŠ‚ç‚¹ chosen = p.choose(node1, node2) } atomic.AddInt64(&chosen.inflight, 1) atomic.AddInt64(&chosen.requests, 1) return chosen.conn, p.buildDoneFunc(chosen), nil } chooseæ–¹æ³•å¯¹éšæœºé€‰æ‹©å‡ºæ¥çš„èŠ‚ç‚¹è¿›è¡Œè´Ÿè½½æ¯”è¾ƒä»è€Œæœ€ç»ˆç¡®å®šé€‰æ‹©å“ªä¸ªèŠ‚ç‚¹ func (p *p2cPicker) choose(c1, c2 *subConn) *subConn { start := int64(timex.Now()) if c2 == nil { atomic.StoreInt64(&c1.pick, start) return c1 } if c1.load() > c2.load() { c1, c2 = c2, c1 } pick := atomic.LoadInt64(&c2.pick) if start-pick > forcePick && atomic.CompareAndSwapInt64(&c2.pick, pick, start) { return c2 } else { atomic.StoreInt64(&c1.pick, start) return c1 } } ä¸Šé¢ä¸»è¦ä»‹ç»äº†zRPCé»˜è®¤è´Ÿè½½å‡è¡¡ç®—æ³•çš„è®¾è®¡æ€æƒ³å’Œä»£ç å®ç°ï¼Œé‚£è‡ªå®šä¹‰çš„balanceræ˜¯å¦‚ä½•æ³¨å†Œåˆ°gRPCçš„å‘¢ï¼Œresolveræä¾›äº†Registeræ–¹æ³•æ¥è¿›è¡Œæ³¨å†Œï¼ŒåŒæ ·balancerä¹Ÿæä¾›äº†Registeræ–¹æ³•æ¥è¿›è¡Œæ³¨å†Œï¼š func init() { balancer.Register(newBuilder()) } func newBuilder() balancer.Builder { return base.NewBalancerBuilder(Name, new(p2cPickerBuilder)) } æ³¨å†Œbalancerä¹‹ågRPCæ€ä¹ˆçŸ¥é“ä½¿ç”¨å“ªä¸ªbalancerå‘¢ï¼Ÿè¿™é‡Œæˆ‘ä»¬éœ€è¦ä½¿ç”¨é…ç½®é¡¹è¿›è¡Œé…ç½®ï¼Œåœ¨NewClientçš„æ—¶å€™é€šè¿‡grpc.WithBalancerNameæ–¹æ³•è¿›è¡Œé…ç½®ï¼š func NewClient(target string, opts ...ClientOption) (*client, error) { var cli client opts = append(opts, WithDialOption(grpc.WithBalancerName(p2c.Name))) if err := cli.dial(target, opts...); err != nil { return nil, err } return &cli, nil } è¿™éƒ¨åˆ†ä¸»è¦ä»‹ç»äº†zRPCä¸­å†…ä¸­çš„è´Ÿè½½å‡è¡¡ç®—æ³•çš„å®ç°åŸç†ä»¥åŠå…·ä½“çš„å®ç°æ–¹å¼ï¼Œä¹‹åä»‹ç»äº†zRPCæ˜¯å¦‚ä½•æ³¨å†Œè‡ªå®šä¹‰çš„balancerä»¥åŠå¦‚ä½•é€‰æ‹©è‡ªå®šä¹‰çš„balancerï¼Œé€šè¿‡è¿™éƒ¨åˆ†å¤§å®¶åº”è¯¥å¯¹è´Ÿè½½å‡è¡¡æœ‰äº†æ›´è¿›ä¸€æ­¥çš„è®¤è¯† æ€»ç»“ é¦–å…ˆï¼Œä»‹ç»äº†zRPCçš„åŸºæœ¬ä½¿ç”¨æ–¹æ³•ï¼Œå¯ä»¥çœ‹åˆ°zRPCä½¿ç”¨éå¸¸ç®€å•ï¼Œåªéœ€è¦å°‘æ•°å‡ è¡Œä»£ç å°±å¯ä»¥æ„å»ºé«˜æ€§èƒ½å’Œè‡ªå¸¦æœåŠ¡æ²»ç†èƒ½åŠ›çš„RPCæœåŠ¡ï¼Œå½“ç„¶è¿™é‡Œæ²¡æœ‰é¢é¢ä¿±åˆ°çš„ä»‹ç»zRPCçš„åŸºæœ¬ä½¿ç”¨ï¼Œå¤§å®¶å¯ä»¥æŸ¥çœ‹ç›¸å…³æ–‡æ¡£è¿›è¡Œå­¦ä¹  æ¥ç€ï¼Œä»‹ç»äº†zRPCçš„å‡ ä¸ªé‡è¦ç»„æˆæ¨¡å—ä»¥åŠå…¶å®ç°åŸç†ï¼Œå¹¶åˆ†æäº†éƒ¨åˆ†æºç ã€‚æ‹¦æˆªå™¨æ¨¡å—æ˜¯æ•´ä¸ªzRPCçš„é‡ç‚¹ï¼Œå…¶ä¸­å†…ç½®äº†ä¸°å¯Œçš„åŠŸèƒ½ï¼Œåƒç†”æ–­ã€ç›‘æ§ã€é™è½½ç­‰ç­‰ä¹Ÿæ˜¯æ„å»ºé«˜å¯ç”¨å¾®æœåŠ¡å¿…ä¸å¯å°‘çš„ã€‚resolverå’Œbalanceræ¨¡å—è‡ªå®šä¹‰äº†gRPCçš„resolverå’Œbalancerï¼Œé€šè¿‡è¯¥éƒ¨åˆ†å¯ä»¥äº†è§£åˆ°æ•´ä¸ªæœåŠ¡æ³¨å†Œä¸å‘ç°çš„åŸç†ä»¥åŠå¦‚ä½•æ„å»ºè‡ªå·±çš„æœåŠ¡å‘ç°ç³»ç»Ÿï¼ŒåŒæ—¶è‡ªå®šä¹‰è´Ÿè½½å‡è¡¡ç®—æ³•ä¹Ÿå˜å¾—ä¸å†ç¥ç§˜ æœ€åï¼ŒzRPCæ˜¯ä¸€ä¸ªç»å†è¿‡å„ç§å·¥ç¨‹å®è·µçš„RPCæ¡†æ¶ï¼Œä¸è®ºæ˜¯æƒ³è¦ç”¨äºç”Ÿäº§è¿˜æ˜¯å­¦ä¹ å…¶ä¸­çš„è®¾è®¡æ¨¡å¼éƒ½æ˜¯ä¸€ä¸ªä¸å¯å¤šå¾—çš„å¼€æºé¡¹ç›®ã€‚å¸Œæœ›é€šè¿‡è¿™ç¯‡æ–‡ç« çš„ä»‹ç»å¤§å®¶èƒ½å¤Ÿè¿›ä¸€æ­¥äº†è§£zRPC Copyright Â© 2019-2021 go-zero all right reservedï¼Œpowered by GitbookLast UpdateTimeï¼š 2025-05-05 05:44:52 "},"go-zero-looklook.html":{"url":"go-zero-looklook.html","title":"ä½¿ç”¨go-zeroå¼€å‘ä¸€ä¸ªæ—…æ¸¸ç³»ç»Ÿgo-zero-looklook","keywords":"","body":"ä½¿ç”¨go-zeroå¼€å‘ä¸€ä¸ªæ—…æ¸¸ç³»ç»Ÿgo-zero-looklook å› ä¸ºå¤§å®¶éƒ½åœ¨è¯´ç›®å‰go-zeroæ²¡æœ‰ä¸€ä¸ªå®Œæ•´çš„é¡¹ç›®ä¾‹å­ï¼Œæœ¬äººæ¥è§¦go-zeroå¯èƒ½æ¯”è¾ƒæ—©ï¼Œgo-zeroåœ¨å¤§çº¦1000startå·¦å³æˆ‘å°±åœ¨ç”¨äº†ï¼Œåæ¥è·Ÿgo-zeroä½œè€…åŠ äº†å¾®ä¿¡ä¹Ÿç†Ÿæ‚‰äº†ï¼Œgo-zeroä½œè€…éå¸¸çƒ­å¿ƒä»¥åŠè€å¿ƒçš„å¸®æˆ‘è§£ç­”äº†å¾ˆå¤šé—®é¢˜ï¼Œæˆ‘ä¹Ÿæƒ³ç§¯æå¸®åŠ©go-zeroæ¨å¹¿ç¤¾åŒºï¼ŒåŸºæœ¬æ˜¯åœ¨ç¤¾åŒºç¾¤å†…å›ç­”å¤§å®¶ç›¸å…³çš„é—®é¢˜ï¼Œå› ä¸ºåœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­å‘ç°å¾ˆå¤šäººè§‰å¾—go-zeroæ²¡æœ‰ä¸€ä¸ªå®Œæ•´çš„é¡¹ç›®ä¾‹å­ï¼Œä½œä¸ºæƒ³æ¨åŠ¨ç¤¾åŒºçš„ä¸€å‘˜ï¼Œç´¢æ€§æˆ‘å°±æŠŠå†…éƒ¨é¡¹ç›®åˆ å‡äº†ä¸€äº›å…³é”®ä¸œè¥¿ï¼Œå°±æäº†ä¸ªå¯ç”¨ç‰ˆæœ¬å¼€æºå‡ºæ¥ï¼Œä¸»è¦æŠ€æœ¯æ ˆåŒ…å«å¦‚ä¸‹ï¼š go-zero nginxç½‘å…³ filebeat kafka go-stash elasticsearch kibana prometheus grafana jaeger go-queue asynq asynqmon dtm docker docker-compose mysql redis é¡¹ç›®åœ°å€ https://github.com/Mikaelemmmm/go-zero-looklook é¡¹ç›®æ–‡æ¡£ https://github.com/Mikaelemmmm/go-zero-looklook/tree/main/doc é¡¹ç›®ç®€ä»‹ æ•´ä¸ªé¡¹ç›®ä½¿ç”¨äº†go-zeroå¼€å‘çš„å¾®æœåŠ¡ï¼ŒåŸºæœ¬åŒ…å«äº†go-zeroä»¥åŠç›¸å…³go-zeroä½œè€…å¼€å‘çš„ä¸€äº›ä¸­é—´ä»¶ï¼Œæ‰€ç”¨åˆ°çš„æŠ€æœ¯æ ˆåŸºæœ¬æ˜¯go-zeroé¡¹ç›®ç»„çš„è‡ªç ”ç»„ä»¶ï¼ŒåŸºæœ¬æ˜¯go-zeroå…¨å®¶æ¡¶äº† å¦å¤–ï¼Œå‰ç«¯æ˜¯å°ç¨‹åºï¼Œæœ¬é¡¹ç›®å·²ç»å¯¹æ¥å¥½äº†å°ç¨‹åºæˆæƒç™»å½• ä»¥åŠ å¾®ä¿¡æ”¯ä»˜äº† ï¼Œå‰ç«¯çœ‹çœ‹åé¢æ˜¯å¦èƒ½å¼€æºå§ é¡¹ç›®ç›®å½•ç»“æ„å¦‚ä¸‹ï¼š appï¼šæ‰€æœ‰ä¸šåŠ¡ä»£ç åŒ…å«apiã€rpcä»¥åŠmqï¼ˆæ¶ˆæ¯é˜Ÿåˆ—ã€å»¶è¿Ÿé˜Ÿåˆ—ã€å®šæ—¶ä»»åŠ¡ï¼‰ commonï¼šé€šç”¨ç»„ä»¶ errorã€middlewareã€interceptorã€toolã€ctxdataç­‰ dataï¼šè¯¥é¡¹ç›®åŒ…å«è¯¥ç›®å½•ä¾èµ–æ‰€æœ‰ä¸­é—´ä»¶(mysqlã€esã€redisã€grafanaç­‰)äº§ç”Ÿçš„æ•°æ®ï¼Œæ­¤ç›®å½•ä¸‹çš„æ‰€æœ‰å†…å®¹åº”è¯¥åœ¨gitå¿½ç•¥æ–‡ä»¶ä¸­ï¼Œä¸éœ€è¦æäº¤ã€‚ deployï¼š filebeat: dockeréƒ¨ç½²filebeaté…ç½® go-stashï¼šgo-stashé…ç½® nginx: nginxç½‘å…³é…ç½® prometheus ï¼š prometheusé…ç½® scriptï¼š gencodeï¼šç”Ÿæˆapiã€rpcï¼Œä»¥åŠåˆ›å»ºkafkaè¯­å¥ï¼Œå¤åˆ¶ç²˜è´´ä½¿ç”¨ mysqlï¼šç”Ÿæˆmodelçš„shå·¥å…· goctl: è¯¥é¡¹ç›®goctlçš„templateï¼Œgoctlç”Ÿæˆè‡ªå®šä¹‰ä»£ç æ¨¡ç‰ˆï¼Œtempalteç”¨æ³•å¯å‚è€ƒgo-zeroæ–‡æ¡£ï¼Œå¤åˆ¶åˆ°å®¶ç›®å½•ä¸‹.goctlå³å¯ï¼Œ è¯¥é¡¹ç›®ç”¨åˆ°goctlç‰ˆæœ¬æ˜¯v1.2.3 doc : è¯¥é¡¹ç›®ç³»åˆ—æ–‡æ¡£ ç³»ç»Ÿæ¶æ„å›¾ ä¸šåŠ¡æ¶æ„å›¾ ç½‘å…³ nginxåšç½‘å…³ï¼Œä½¿ç”¨nginxçš„authæ¨¡å—ï¼Œè°ƒç”¨åç«¯çš„identityæœåŠ¡ç»Ÿä¸€é‰´æƒï¼Œä¸šåŠ¡å†…éƒ¨ä¸é‰´æƒï¼Œå¦‚æœæ¶‰åŠåˆ°ä¸šåŠ¡èµ„é‡‘æ¯”è¾ƒå¤šä¹Ÿå¯ä»¥åœ¨ä¸šåŠ¡ä¸­è¿›è¡ŒäºŒæ¬¡é‰´æƒï¼Œä¸ºäº†å®‰å…¨å˜›ã€‚ å¦å¤–ï¼Œå¾ˆå¤šåŒå­¦è§‰å¾—nginxåšç½‘å…³ä¸å¤ªå¥½ï¼Œè¿™å—åŸç†åŸºæœ¬ä¸€æ ·ï¼Œå¯ä»¥è‡ªè¡Œæ›¿æ¢æˆapisixã€kongç­‰ å¼€å‘æ¨¡å¼ æœ¬é¡¹ç›®ä½¿ç”¨çš„æ˜¯å¾®æœåŠ¡å¼€å‘ï¼Œapi ï¼ˆhttpï¼‰ + rpcï¼ˆgrpcï¼‰ ï¼Œ apiå……å½“èšåˆæœåŠ¡ï¼Œå¤æ‚ã€æ¶‰åŠåˆ°å…¶ä»–ä¸šåŠ¡è°ƒç”¨çš„ç»Ÿä¸€å†™åœ¨rpcä¸­ï¼Œå¦‚æœä¸€äº›ä¸ä¼šè¢«å…¶ä»–æœåŠ¡ä¾èµ–ä½¿ç”¨çš„ç®€å•ä¸šåŠ¡ï¼Œå¯ä»¥ç›´æ¥å†™åœ¨apiçš„logicä¸­ æ—¥å¿— å…³äºæ—¥å¿—ï¼Œç»Ÿä¸€ä½¿ç”¨filebeatæ”¶é›†ï¼Œä¸ŠæŠ¥åˆ°kafkaä¸­ï¼Œç”±äºlogstashæ‡‚å¾—éƒ½æ‡‚ï¼Œèµ„æºå ç”¨å¤ªå¤¸å¼ äº†ï¼Œè¿™é‡Œä½¿ç”¨äº†go-stashæ›¿æ¢äº†logstash é“¾æ¥ï¼šhttps://github.com/kevwan/go-stash ï¼Œ go-stashæ˜¯ç”±go-zeroå¼€å‘å›¢é˜Ÿå¼€å‘çš„ï¼Œæ€§èƒ½å¾ˆé«˜ä¸å èµ„æºï¼Œä¸»è¦ä»£ç é‡æ²¡å¤šå°‘ï¼Œåªéœ€è¦é…ç½®å°±å¯ä»¥ä½¿ç”¨ï¼Œå¾ˆç®€å•ã€‚å®ƒæ˜¯å§kafkaæ•°æ®æºåŒæ­¥åˆ°elasticsearchä¸­ï¼Œé»˜è®¤ä¸æ”¯æŒelasticsearchè´¦å·å¯†ç ï¼Œæˆ‘forkäº†ä¸€ä»½ä¿®æ”¹äº†ä¸€ä¸‹ï¼Œå¾ˆç®€å•æ”¯æŒäº†è´¦å·ã€å¯†ç  ç›‘æ§ ç›‘æ§é‡‡ç”¨prometheusï¼Œè¿™ä¸ªgo-zeroåŸç”Ÿæ”¯æŒï¼Œåªéœ€è¦é…ç½®å°±å¯ä»¥äº†ï¼Œè¿™é‡Œå¯ä»¥çœ‹é¡¹ç›®ä¸­çš„é…ç½® é“¾è·¯è¿½è¸ª go-zeroé»˜è®¤jaegerã€zipkinæ”¯æŒï¼Œåªéœ€è¦é…ç½®å°±å¯ä»¥äº†ï¼Œå¯ä»¥çœ‹é…ç½® æ¶ˆæ¯é˜Ÿåˆ— æ¶ˆæ¯é˜Ÿåˆ—ä½¿ç”¨çš„æ˜¯go-zeroå¼€å‘å›¢é˜Ÿå¼€å‘çš„go-queueï¼Œé“¾æ¥ï¼šhttps://github.com/zeromicro/go-queue è¿™é‡Œä½¿ç”¨å¯kqï¼Œkqæ˜¯åŸºäºkafkaåšçš„é«˜æ€§èƒ½æ¶ˆæ¯é˜Ÿåˆ— é€šç”¨go-queueä¸­ä¹Ÿæœ‰dqï¼Œæ˜¯å»¶è¿Ÿé˜Ÿåˆ—ï¼Œä¸è¿‡å½“å‰é¡¹ç›®æ²¡æœ‰ä½¿ç”¨dq å»¶è¿Ÿé˜Ÿåˆ—ã€å®šæ—¶ä»»åŠ¡ å»¶è¿Ÿé˜Ÿåˆ—ã€å®šæ—¶ä»»åŠ¡æœ¬é¡¹ç›®ä½¿ç”¨çš„æ˜¯asynq ï¼Œ googleå›¢é˜Ÿç»™äºˆrediså¼€å‘çš„ç®€å•ä¸­é—´ä»¶ï¼Œ å½“ç„¶äº†asynqä¹Ÿæ”¯æŒæ¶ˆæ¯é˜Ÿåˆ—ï¼Œä½ ä¹Ÿå¯ä¹ŸæŠŠkqæ¶ˆæ¯é˜Ÿåˆ—æ›¿æ¢æˆè¿™ä¸ªï¼Œæ¯•ç«Ÿåªéœ€è¦redisä¸éœ€è¦åœ¨å»ç»´æŠ¤ä¸€ä¸ªkafkaä¹Ÿæ˜¯ä¸é”™çš„ é“¾æ¥ï¼šhttps://github.com/hibiken/asynq åˆ†å¸ƒå¼äº‹åŠ¡ åˆ†å¸ƒå¼äº‹åŠ¡å‡†å¤‡ä½¿ç”¨çš„æ˜¯dtmï¼Œ å—¯ ï¼Œå¾ˆèˆ’æœï¼Œä¹‹å‰æˆ‘å†™è¿‡ä¸€ç¯‡ \"go-zeroå¯¹æ¥åˆ†å¸ƒå¼äº‹åŠ¡dtmä¿å§†å¼æ•™ç¨‹\" é“¾æ¥åœ°å€ï¼šhttps://github.com/Mikaelemmmm/gozerodtm ï¼Œ æœ¬é¡¹ç›®ç›®å‰è¿˜æœªä½¿ç”¨åˆ°ï¼Œåç»­å‡†å¤‡ç›´æ¥é›†æˆå°±å¥½äº†ï¼Œå¦‚æœè¯»è€…ä½¿ç”¨ç›´æ¥å»çœ‹é‚£ä¸ªæºç å°±è¡Œäº† éƒ¨ç½² éƒ¨ç½²çš„è¯ï¼Œç›®å‰è¿™ä¸ªç›´æ¥ä½¿ç”¨dockerå¯ä»¥éƒ¨ç½²æ•´å¥—æŠ€æœ¯æ ˆï¼Œå¦‚æœä¸Šk8sçš„è¯ ï¼Œæœ€ç®€å•ç›´æ¥ç”¨é˜¿é‡Œäº‘çš„å§ æˆ‘è¯´ä¸‹æ€è·¯ï¼Œè¿™ä¸ªåç»­ä¼šå‡ºä¸€ä¸ªåŸºäºé˜¿é‡Œäº‘æ•ˆçš„éƒ¨ç½²åˆ°k8sæ–‡æ¡£æ•™ç¨‹ï¼Œè‡ªå·±æ­å»ºä¸€ä¸ªgitlabã€jenkinsã€harborå»åšçš„è¯å¤ªè´¹æ—¶é—´äº† 1ã€å°†ä»£ç æ”¾åœ¨é˜¿é‡Œäº‘æ•ˆï¼ˆå½“ç„¶ä½ æ•´åˆ°gitlabä¹Ÿè¡Œï¼‰ 2ã€åœ¨é˜¿é‡Œäº‘æ•ˆåˆ›å»ºæµæ°´çº¿ï¼ŒåŸºæœ¬æ˜¯ä¸€ä¸ªæœåŠ¡ä¸€ä¸ªæµæ°´çº¿äº† 3ã€æµæ°´çº¿æ­¥éª¤ ï¼š â€‹ æ‹‰å–ä»£ç --->ciæ£€æµ‹ï¼ˆè¿™é‡Œå¯ä»¥çœç•¥å“ˆï¼Œè‡ªå·±çœ‹ç€åŠï¼‰--->æ„å»ºé•œåƒï¼ˆgo-zeroå®˜æ–¹æœ‰Dockerfileè¿˜æœ‰æ•™ç¨‹ï¼Œåˆ«å‘Šè¯‰æˆ‘ä¸ä¼šï¼‰-->æ¨é€åˆ°é˜¿é‡Œäº‘é•œåƒæœåŠ¡--->ä½¿ç”¨kubectlå»é˜¿é‡Œäº‘k8sæ‹‰å–é•œåƒï¼ˆackã€askéƒ½è¡Œï¼Œaskæ— æ³•ä½¿ç”¨daemonset ä¸èƒ½ç”¨filebeatï¼‰---->okäº† å¦å¤–ï¼Œ å¦‚æœä½ æƒ³è‡ªå·±åŸºäºgitlabã€jenkinsã€harborå»åšçš„è¯ï¼Œå—¯ è‡ªå·±å»æ‰¾è¿ç»´å¼„å§ï¼Œæˆ‘ä¹‹å‰ä¹Ÿå†™è¿‡ä¸€ä¸ªæ•™ç¨‹ï¼Œæœ‰ç©ºåœ¨æ•´å§è€å“¥ä»¬ï¼ï¼ Copyright Â© 2019-2021 go-zero all right reservedï¼Œpowered by GitbookLast UpdateTimeï¼š 2025-05-05 05:44:52 "},"faq.html":{"url":"faq.html","title":"FAQ","keywords":"","body":"å¸¸è§é—®é¢˜é›†åˆ goctlå®‰è£…äº†æ‰§è¡Œå‘½ä»¤å´æç¤º command not found: goctl å­—æ ·ã€‚ å¦‚æœä½ é€šè¿‡ go get æ–¹å¼å®‰è£…ï¼Œé‚£ä¹ˆ goctl åº”è¯¥ä½äº $GOPATH ä¸­ï¼Œ ä½ å¯ä»¥é€šè¿‡ go env GOPATH æŸ¥çœ‹å®Œæ•´è·¯å¾„ï¼Œä¸ç®¡ä½ çš„ goctl æ˜¯åœ¨ $GOPATHä¸­ï¼Œ è¿˜æ˜¯åœ¨å…¶ä»–ç›®å½•ï¼Œå‡ºç°ä¸Šè¿°é—®é¢˜çš„åŸå› å°±æ˜¯ goctl æ‰€åœ¨ç›®å½•ä¸åœ¨ PATH (ç¯å¢ƒå˜é‡)ä¸­æ‰€è‡´ã€‚ rpcæ€ä¹ˆè°ƒç”¨ è¯¥é—®é¢˜å¯ä»¥å‚è€ƒå¿«é€Ÿå¼€å§‹ä¸­çš„rpcç¼–å†™ä¸è°ƒç”¨ä»‹ç»ï¼Œå…¶ä¸­æœ‰rpcè°ƒç”¨çš„ä½¿ç”¨é€»è¾‘ã€‚ protoä½¿ç”¨äº†importï¼Œgoctlå‘½ä»¤éœ€è¦æ€ä¹ˆå†™ã€‚ goctl å¯¹äºimportçš„protoæŒ‡å®š BasePath æä¾›äº† protoc çš„flagæ˜ å°„ï¼Œå³ --proto_path, -Iï¼Œ goctl ä¼šå°†æ­¤flagå€¼ä¼ é€’ç»™ protoc. å‡è®¾ base.proto çš„è¢«main proto å¼•å…¥äº†ï¼Œä¸ºä»€ä¹ˆä¸ç”Ÿèƒ½ç”Ÿæˆbase.pb.goã€‚ å¯¹äº base.proto è¿™ç§ç±»å‹çš„æ–‡ä»¶ï¼Œä¸€èˆ¬éƒ½æ˜¯å¼€å‘è€…æœ‰messageå¤ç”¨çš„éœ€æ±‚ï¼Œä»–çš„æ¥æºä¸æ­¢æœ‰å¼€å‘è€…è‡ªå·±ç¼–å†™çš„protoæ–‡ä»¶ï¼Œ è¿˜æœ‰å¯èƒ½æ¥æºäº google.golang.org/grpc ä¸­æä¾›çš„ä¸€äº›åŸºæœ¬çš„proto,æ¯”å¦‚ google/protobuf/any.proto, å¦‚æœç”± goctl æ¥ç”Ÿæˆï¼Œé‚£ä¹ˆå°±å¤±å»äº†é›†ä¸­ç®¡ç†è¿™äº›protoçš„æ„ä¹‰ã€‚ modelæ€ä¹ˆæ§åˆ¶ç¼“å­˜æ—¶é—´ åœ¨ sqlc.NewNodeConn çš„æ—¶å€™å¯ä»¥é€šè¿‡å¯é€‰å‚æ•° cache.WithExpiry ä¼ é€’ï¼Œå¦‚ç¼“å­˜æ—¶é—´æ§åˆ¶ä¸º1å¤©ï¼Œä»£ç å¦‚ä¸‹: sqlc.NewNodeConn(conn,redis,cache.WithExpiry(24*time.Hour)) jwté‰´æƒæ€ä¹ˆå®ç° è¯·å‚è€ƒjwté‰´æƒ apiä¸­é—´ä»¶æ€ä¹ˆä½¿ç”¨ è¯·å‚è€ƒä¸­é—´ä»¶ æ€ä¹ˆå…³é—­è¾“å‡ºçš„ç»Ÿè®¡æ—¥å¿—(stat)ï¼Ÿ logx.DisableStat() rpcç›´è¿ä¸æœåŠ¡å‘ç°è¿æ¥æ¨¡å¼å†™æ³• // mode1: é›†ç¾¤ç›´è¿ // conf:=zrpc.NewDirectClientConf([]string{\"ip:port\"},\"app\",\"token\") // mode2: etcd æœåŠ¡å‘ç° // conf:=zrpc.NewEtcdClientConf([]string{\"ip:port\"},\"key\",\"app\",\"token\") // client, _ := zrpc.NewClient(conf) // mode3: ipç›´è¿mode // client, _ := zrpc.NewClientWithTarget(\"127.0.0.1:8888\") grpc å®¢æˆ·ç«¯è®¾ç½®æ¶ˆæ¯å¤§å°é™åˆ¶ ä¿®æ”¹grpcæ¶ˆæ¯å¤§å°é™åˆ¶ï¼Œéœ€è¦ æœåŠ¡ç«¯ å’Œ å®¢æˆ·ç«¯ éƒ½è®¾ç½® // éœ€è¦ grpc æ–¹æ³•é‡Œé¢æ·»åŠ é…ç½®é¡¹ï¼šgrpc.MaxCallRecvMsgSize(bytes int)ã€grpc.MaxCallSendMsgSize(bytes int) // ç¤ºä¾‹å¦‚ä¸‹ï¼šè®¾ç½® UserRpc.List åˆ—è¡¨æ¶ˆæ¯å¤§å°é™åˆ¶ä¸º 8MB // l.svcCtx.UserRpc.List(l.ctx, &listReq, grpc.MaxCallRecvMsgSize(1024*1024*8), grpc.MaxCallSendMsgSize(1024*1024*8)) faqä¼šä¸å®šæœŸæ›´æ–°å¤§å®¶é‡åˆ°çš„é—®é¢˜ï¼Œä¹Ÿæ¬¢è¿å¤§å®¶æŠŠå¸¸è§é—®é¢˜é€šè¿‡prå†™åœ¨è¿™é‡Œã€‚ Copyright Â© 2019-2021 go-zero all right reservedï¼Œpowered by GitbookLast UpdateTimeï¼š 2025-05-05 05:44:52 "}}